# å·¥ç¨‹ç´ å…»ç¯‡ï¼ˆä¸­çº§ï¼‰

# ç¼–ç èƒ½åŠ›

### **ä»£ç ç®¡ç†**

> Monorepo/Multirepoï¼Œç†è§£å¤§ä»“ä¼˜ç¼ºç‚¹ï¼Œä»£ç å¤ç”¨/ä¾èµ–ç®¡ç†/ä»£ç è§„èŒƒå®¡æŸ¥/æ„å»ºå·¥å…·é“¾å»ºè®¾

#### 1. Monorepo vs Multirepo 

##### å®šä¹‰

| ç‰¹æ€§         | Monorepoï¼ˆå•ä½“ä»“åº“ï¼‰                | Multirepoï¼ˆå¤šä½“ä»“åº“ï¼‰         |
| :----------- | :---------------------------------- | :---------------------------- |
| **å®šä¹‰**     | å¤šä¸ªé¡¹ç›®/æ¨¡å—å­˜æ”¾åœ¨åŒä¸€ä¸ªä»£ç ä»“åº“ä¸­ | æ¯ä¸ªé¡¹ç›®/æ¨¡å—æœ‰ç‹¬ç«‹çš„ä»£ç ä»“åº“ |
| **ç®¡ç†å•å…ƒ** | æ•´ä¸ªä»£ç åº“ä½œä¸ºä¸€ä¸ªå•å…ƒç®¡ç†          | æ¯ä¸ªä»“åº“ç‹¬ç«‹ç®¡ç†              |
| **å…¸å‹ä»£è¡¨** | Google, Facebook, Microsoft         | å¤§å¤šæ•°å¼€æºé¡¹ç›®ï¼Œä¼ ç»Ÿä¼ä¸š      |

##### **Monorepo ä¼˜åŠ¿**ä¸åŠ£åŠ¿

```
ä¼˜åŠ¿ï¼š
1. ä»£ç å…±äº«å’Œå¤ç”¨
2. åŸå­æäº¤å’Œç»Ÿä¸€ç‰ˆæœ¬
# ä¸€æ¬¡æäº¤ï¼Œå¤šä¸ªç›¸å…³æ›´æ”¹
git commit -m "feat: ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
- æ·»åŠ å…±äº«è®¤è¯ç»„ä»¶
- æ›´æ–°Webåº”ç”¨è®¤è¯é€»è¾‘  
- ç§»åŠ¨ç«¯é›†æˆæ–°è®¤è¯
- APIå®¢æˆ·ç«¯æ·»åŠ è®¤è¯å¤´"
3. ç®€åŒ–ä¾èµ–ç®¡ç†
4. å·¥å…·é“¾ç»Ÿä¸€

åŠ£åŠ¿ï¼š
1. å·¥å…·é“¾å¤æ‚æ€§
2. æ€§èƒ½é—®é¢˜  ==ã€‹ ä»“åº“ä½“ç§¯å·¨å¤§ï¼Œå½±å“æ“ä½œé€Ÿåº¦
3. æƒé™ç®¡ç†å¤æ‚
```



**Multirepo ä¼˜åŠ¿**ä¸åŠ£åŠ¿

```
ä¼˜åŠ¿ï¼š
1. æ˜ç¡®çš„ä»£ç æ‰€æœ‰æƒ
# æ¯ä¸ªå›¢é˜Ÿè´Ÿè´£ç‹¬ç«‹ä»“åº“
frontend-team/    # å‰ç«¯å›¢é˜Ÿæƒé™
backend-team/     # åç«¯å›¢é˜Ÿæƒé™ 

2. ç‹¬ç«‹çš„å‘å¸ƒå‘¨æœŸ
# å„é¡¹ç›®å¯ä»¥ç‹¬ç«‹å‘å¸ƒ
web-app/     # æ¯å‘¨å‘å¸ƒ
mobile-app/  # åº”ç”¨å•†åº—å®¡æ ¸å‘¨æœŸ

3. å·¥å…·ç®€å•åŒ–
# æ ‡å‡†Gitå·¥ä½œæµ
git clone repo-frontend
git clone repo-backend

4. å®‰å…¨éš”ç¦»
// æ•æ„Ÿé…ç½®éš”ç¦»
// backend-repo/config/secrets.js
module.exports = {
    databasePassword: 'secret123',  // åç«¯å›¢é˜Ÿå¯è®¿é—®
    apiKeys: { /* æ•æ„Ÿä¿¡æ¯ */ }
};



åŠ£åŠ¿ï¼š
1. ä¾èµ–ç®¡ç†å›°éš¾
2. è·¨é¡¹ç›®æ›´æ”¹å¤æ‚
3. ä»£ç é‡å¤

```



##### æ¶æ„ç¤ºæ„å›¾

**Multirepo æ¶æ„**ï¼š

```
project-frontend/          project-backend/          project-mobile/
â”œâ”€â”€ package.json           â”œâ”€â”€ package.json         â”œâ”€â”€ package.json
â”œâ”€â”€ src/                   â”œâ”€â”€ src/                 â”œâ”€â”€ src/
â””â”€â”€ README.md              â””â”€â”€ README.md            â””â”€â”€ README.md
```

**Monorepo æ¶æ„**ï¼š

```
monorepo/
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ frontend/          # å‰ç«¯åº”ç”¨
â”‚   â”œâ”€â”€ backend/           # åç«¯æœåŠ¡  
â”‚   â”œâ”€â”€ mobile/           # ç§»åŠ¨ç«¯
â”‚   â”œâ”€â”€ ui-components/    # å…±äº«UIç»„ä»¶
â”‚   â””â”€â”€ utils/           # å·¥å…·åº“
â”œâ”€â”€ package.json          # æ ¹ç›®å½•é…ç½®
â”œâ”€â”€ turbo.json           # æ„å»ºå·¥å…·é…ç½®
â””â”€â”€ README.md
```



##### å…³é”®å¯¹æ¯”

**æ ¸å¿ƒå·®å¼‚é€Ÿè§ˆè¡¨**

| ç»´åº¦         | Monorepoï¼ˆå¤§ä»“ï¼Œå•ä½“ä»“åº“ï¼‰ | Multirepoï¼ˆå¤šä»“ï¼Œå¤šä½“ä»“åº“ï¼‰ |
| :----------- | :------------------------- | :-------------------------- |
| **ä»£ç å¤ç”¨** | â­â­â­â­â­ ç›´æ¥å¼•ç”¨             | â­â­ éœ€è¦å‘å¸ƒåŒ…               |
| **ä¾èµ–ç®¡ç†** | â­â­â­â­â­ ç»Ÿä¸€ç‰ˆæœ¬             | â­â­ å®¹æ˜“å†²çª                 |
| **é‡æ„å®‰å…¨** | â­â­â­â­â­ åŸå­æäº¤             | â­â­ è·¨ä»“åº“åè°ƒ               |
| **æ„å»ºæ€§èƒ½** | â­â­ éœ€è¦å·¥å…·ä¼˜åŒ–            | â­â­â­â­â­ ç‹¬ç«‹æ„å»º              |
| **æƒé™æ§åˆ¶** | â­â­ ç›®å½•çº§æ§åˆ¶å¤æ‚          | â­â­â­â­â­ ä»“åº“çº§æ§åˆ¶            |
| **å›¢é˜Ÿè‡ªæ²»** | â­â­ éœ€è¦åè°ƒ                | â­â­â­â­â­ å®Œå…¨ç‹¬ç«‹              |
| **å…¥é—¨é—¨æ§›** | â­â­ å·¥å…·é“¾å¤æ‚              | â­â­â­â­â­ ç®€å•ç›´æ¥              |

**é€‰æ‹©å†³ç­–æŒ‡å—**

```
é€‰æ‹© Monorepo å½“ï¼š
âœ… é¡¹ç›®é«˜åº¦å…³è”ï¼Œéœ€è¦é¢‘ç¹å…±äº«ä»£ç 
âœ… å›¢é˜Ÿè§„æ¨¡å¤§ï¼Œéœ€è¦ç»Ÿä¸€è§„èŒƒ
âœ… æœ‰èµ„æºå»ºè®¾å’Œç»´æŠ¤å·¥å…·é“¾
âœ… è¿½æ±‚å¼€å‘ä½“éªŒå’Œé‡æ„æ•ˆç‡

é€‰æ‹© Multirepo å½“ï¼š
âœ… é¡¹ç›®ç›¸å¯¹ç‹¬ç«‹ï¼Œå›¢é˜Ÿè‡ªæ²»æ€§å¼º
âœ… æŠ€æœ¯æ ˆå·®å¼‚å¤§ï¼Œæ„å»ºéœ€æ±‚ä¸åŒ
âœ… å›¢é˜Ÿè§„æ¨¡å°ï¼Œå·¥å…·é“¾èµ„æºæœ‰é™
âœ… éœ€è¦ä¸¥æ ¼çš„æƒé™éš”ç¦»
```



#### 2. ä»£ç å¤ç”¨ä¸ä¾èµ–ç®¡ç†

##### Monorepo ä»£ç å¤ç”¨æ¨¡å¼

```
# é¡¹ç›®ç»“æ„
packages/
  â”œâ”€â”€ shared/           # é€šç”¨å·¥å…·åº“
  â”œâ”€â”€ ui-components/    # å…±äº«UIç»„ä»¶
  â”œâ”€â”€ configs/         # é…ç½®æ–‡ä»¶
  â”œâ”€â”€ web-app/         # å‰ç«¯åº”ç”¨
  â””â”€â”€ mobile-app/      # ç§»åŠ¨ç«¯åº”ç”¨

# ä¾èµ–å¼•ç”¨
"dependencies": {
  "@project/shared": "workspace:*",
  "@project/ui-components": "workspace:*"
}
```

##### ä¾èµ–ç®¡ç†æœ€ä½³å®è·µ

1. **ç‰ˆæœ¬é”å®š**ï¼šä½¿ç”¨ package-lock.json æˆ– yarn.lock
2. **ä¾èµ–æå‡**ï¼šMonorepoä¸­å…±äº«node_modules
3. **å¾ªç¯ä¾èµ–æ£€æµ‹**ï¼šå·¥å…·è‡ªåŠ¨æ£€æŸ¥å¹¶å‘Šè­¦
4. **å®‰å…¨æ‰«æ**ï¼šé›†æˆæ¼æ´æ£€æµ‹å·¥å…·

#### 3. ä»£ç è§„èŒƒä¸å®¡æŸ¥ä½“ç³»

##### ä»£ç è§„èŒƒé…ç½®

```
// .eslintrc.js
module.exports = {
  extends: ['@company/eslint-config'],
  rules: {
    'complexity': ['error', 10],        // åœˆå¤æ‚åº¦é™åˆ¶
    'max-lines': ['error', 300],        // æ–‡ä»¶è¡Œæ•°é™åˆ¶
    'no-console': 'warn'                // æ§åˆ¶å°ä½¿ç”¨è­¦å‘Š
  }
};

// .prettierrc.js
module.exports = {
  semi: true,
  trailingComma: 'es5',
  singleQuote: true,
  printWidth: 100
};
```

##### ä»£ç å®¡æŸ¥æ¸…å•

- [ ] åŠŸèƒ½å®ç°æ˜¯å¦ç¬¦åˆéœ€æ±‚
- [ ] ä»£ç é£æ ¼æ˜¯å¦ä¸€è‡´
- [ ] æµ‹è¯•è¦†ç›–æ˜¯å¦å……åˆ†
- [ ] æ–‡æ¡£æ›´æ–°æ˜¯å¦å®Œæ•´
- [ ] æ€§èƒ½å½±å“æ˜¯å¦è¯„ä¼°
- [ ] å®‰å…¨é£é™©æ˜¯å¦æ’æŸ¥



#### 4.æ„å»ºå·¥å…·é“¾å»ºè®¾(CI/CD)

##### CI/CD æ ¸å¿ƒæ¦‚å¿µ

###### CI - **æŒç»­é›†æˆ** (Continuous Integration)

**å®šä¹‰**ï¼šå¼€å‘äººå‘˜é¢‘ç¹åœ°å°†ä»£ç å˜æ›´åˆå¹¶åˆ°å…±äº«ä¸»å¹²ï¼ˆé€šå¸¸æ¯å¤©å¤šæ¬¡ï¼‰çš„è½¯ä»¶å¼€å‘å®è·µã€‚

**æ ¸å¿ƒæµç¨‹**ï¼š

```
ä»£ç æäº¤ â†’ è‡ªåŠ¨æ„å»º â†’ è‡ªåŠ¨åŒ–æµ‹è¯• â†’ å¿«é€Ÿåé¦ˆ
```

**å…³é”®ç‰¹å¾**ï¼š

- âœ… **é¢‘ç¹é›†æˆ**ï¼šæ¯æ—¥å¤šæ¬¡ä»£ç åˆå¹¶
- âœ… **è‡ªåŠ¨åŒ–æ„å»º**ï¼šæ¯æ¬¡æäº¤è§¦å‘è‡ªåŠ¨æ„å»º
- âœ… **å¿«é€Ÿæµ‹è¯•**ï¼šè¿è¡Œå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•
- âœ… **å³æ—¶åé¦ˆ**ï¼šå¿«é€Ÿå‘ç°é›†æˆé—®é¢˜





###### CD-**æŒç»­äº¤ä»˜** (Continuous Delivery)

**å®šä¹‰**ï¼šç¡®ä¿ä»£ç å˜æ›´å¯ä»¥å®‰å…¨ã€å¿«é€Ÿåœ°éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œä½†éƒ¨ç½²å†³ç­–ç”±äººå·¥æ§åˆ¶ã€‚

**æ ¸å¿ƒæµç¨‹**ï¼š

```
CIé€šè¿‡å â†’ è‡ªåŠ¨åŒ–éƒ¨ç½²åˆ°ç±»ç”Ÿäº§ç¯å¢ƒ â†’ äººå·¥è§¦å‘ç”Ÿäº§éƒ¨ç½²
```

**å…³é”®ç‰¹å¾**ï¼š

- âœ… **éšæ—¶å¯éƒ¨ç½²**ï¼šä»£ç å§‹ç»ˆå¤„äºå¯éƒ¨ç½²çŠ¶æ€
- âœ… **äººå·¥å†³ç­–**ï¼šç”±äººå·¥å†³å®šä½•æ—¶éƒ¨ç½²åˆ°ç”Ÿäº§
- âœ… **é™ä½é£é™©**ï¼šéƒ¨ç½²å‰è¿›è¡Œäººå·¥éªŒè¯



###### **CD-æŒç»­éƒ¨ç½²** (Continuous Deployment)

**å®šä¹‰**ï¼šä»£ç å˜æ›´é€šè¿‡CIæµæ°´çº¿åï¼Œè‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œæ— éœ€äººå·¥å¹²é¢„ã€‚

**æ ¸å¿ƒæµç¨‹**ï¼š

```
CIé€šè¿‡å â†’ è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
```

**å…³é”®ç‰¹å¾**ï¼š

- âœ… **å®Œå…¨è‡ªåŠ¨åŒ–**ï¼šæ— éœ€äººå·¥å¹²é¢„çš„éƒ¨ç½²
- âœ… **å¿«é€Ÿäº¤ä»˜**ï¼šå˜æ›´å¿«é€Ÿåˆ°è¾¾ç”¨æˆ·
- âœ… **é«˜é£é™©**ï¼šéœ€è¦æé«˜çš„æµ‹è¯•è¦†ç›–ç‡å’Œè´¨é‡æ ‡å‡†



| æ–¹é¢           | æŒç»­é›†æˆ (CI)    | æŒç»­äº¤ä»˜ (CD)  | æŒç»­éƒ¨ç½² (CD) |
| :------------- | :--------------- | :------------- | :------------ |
| **ç¼©å†™**       | CI               | CD             | CD            |
| **æ ¸å¿ƒç›®æ ‡**   | ä»£ç è´¨é‡ä¿è¯     | äº¤ä»˜å°±ç»ªçŠ¶æ€   | è‡ªåŠ¨å‘å¸ƒä»·å€¼  |
| **è‡ªåŠ¨åŒ–ç¨‹åº¦** | æ„å»ºå’Œæµ‹è¯•è‡ªåŠ¨åŒ– | éƒ¨ç½²æµç¨‹è‡ªåŠ¨åŒ– | å…¨æµç¨‹è‡ªåŠ¨åŒ–  |
| **äººå·¥å¹²é¢„**   | æ—                | éƒ¨ç½²å†³ç­–äººå·¥   | æ—             |
| **é£é™©ç­‰çº§**   | ä½               | ä¸­             | é«˜            |
| **å‘å¸ƒé¢‘ç‡**   | å¤©/å°æ—¶çº§        | å¤©/å‘¨çº§        | å°æ—¶/åˆ†é’Ÿçº§   |



##### **ä¸»æµ CI/CD å·¥å…·é“¾**

###### **1. ä»£ç æ‰˜ç®¡ä¸åä½œ**(github)

| å·¥å…·          | ç±»å‹        | ç‰¹ç‚¹                  |
| :------------ | :---------- | :-------------------- |
| **GitHub**    | SaaS        | ç”Ÿæ€ä¸°å¯Œï¼ŒActionsé›†æˆ |
| **GitLab**    | è‡ªæ‰˜ç®¡/SaaS | å†…ç½®å®Œæ•´CI/CD         |
| **Bitbucket** | SaaS        | ä¸Jiraæ·±åº¦é›†æˆ        |
| **Gitea**     | è‡ªæ‰˜ç®¡      | è½»é‡å¼€æº              |

###### **2. CI/CD æµæ°´çº¿å¹³å°**

```
# GitHub Actions ç¤ºä¾‹
name: CI Pipeline
on: [push]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm install && npm test
  
  build:
    needs: test
    runs-on: ubuntu-latest  
    steps:
      - run: npm run build
```

| å¹³å°               | ç‰¹ç‚¹           | é€‚ç”¨åœºæ™¯       |
| :----------------- | :------------- | :------------- |
| **Jenkins**        | è€ç‰Œï¼Œæ’ä»¶ä¸°å¯Œ | å¤æ‚å®šåˆ¶åŒ–éœ€æ±‚ |
| **GitLab CI**      | ä»£ç ä»“åº“é›†æˆ   | ä¸€ä½“åŒ–å¼€å‘ä½“éªŒ |
| **GitHub Actions** | ç”Ÿæ€å¼ºå¤§       | GitHubé¡¹ç›®é¦–é€‰ |
| **CircleCI**       | äº‘åŸç”Ÿå‹å¥½     | å®¹å™¨åŒ–åº”ç”¨     |

###### **3. æ„å»ºå·¥å…·(docker)**

```
# å¤šé˜¶æ®µæ„å»ºç¤ºä¾‹
FROM node:16 AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
```

| è¯­è¨€           | æ„å»ºå·¥å…·           | ç‰¹ç‚¹         |
| :------------- | :----------------- | :----------- |
| **Java**       | Maven, Gradle      | ä¾èµ–ç®¡ç†å¼ºå¤§ |
| **JavaScript** | npm, yarn, pnpm    | ç”Ÿæ€ä¸°å¯Œ     |
| **Go**         | go build           | ç®€å•é«˜æ•ˆ     |
| **Python**     | setuptools, poetry | è™šæ‹Ÿç¯å¢ƒç®¡ç† |

###### **4. åˆ¶å“ä»“åº“**

```
# å‘å¸ƒåˆ°åˆ¶å“åº“
npm publish                          # npm registry
docker push myapp:1.0.0              # Docker registry
mvn deploy                           # Maven repository
```

| ç±»å‹       | å·¥å…·               | ç®¡ç†å†…å®¹       |
| :--------- | :----------------- | :------------- |
| **åŒ…ç®¡ç†** | npm, Maven, PyPI   | è¯­è¨€ç‰¹å®šåŒ…     |
| **å®¹å™¨**   | Docker Hub, Harbor | é•œåƒæ–‡ä»¶       |
| **é€šç”¨**   | JFrog Artifactory  | ä»»æ„äºŒè¿›åˆ¶æ–‡ä»¶ |

###### **5. éƒ¨ç½²å·¥å…·(k8s)**

```
# Kubernetes éƒ¨ç½²ç¤ºä¾‹
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
spec:
  replicas: 3
  template:
    spec:
      containers:
      - name: app
        image: myapp:1.0.0
        ports:
        - containerPort: 3000
```

| å·¥å…·           | éƒ¨ç½²ç›®æ ‡ | ç‰¹ç‚¹           |
| :------------- | :------- | :------------- |
| **Kubernetes** | å®¹å™¨ç¼–æ’ | äº‘åŸç”Ÿæ ‡å‡†     |
| **Ansible**    | æœåŠ¡å™¨   | å£°æ˜å¼é…ç½®     |
| **Terraform**  | åŸºç¡€è®¾æ–½ | åŸºç¡€è®¾æ–½å³ä»£ç  |
| **Serverless** | æ— æœåŠ¡å™¨ | äº‹ä»¶é©±åŠ¨       |



### Git ä»£ç ç‰ˆæœ¬æ§åˆ¶æ ¸å¿ƒè¦ç‚¹

#### 1. Git åŸºç¡€æ¦‚å¿µ

**æ ¸å¿ƒä¸‰åŒº**

```
å·¥ä½œåŒº (Working Directory)     â†’ æš‚å­˜åŒº (Staging Area)     â†’ ä»“åº“ (Repository)
     (å·²ä¿®æ”¹æ–‡ä»¶)                   (git add æ·»åŠ )             (git commit æäº¤)
```

**æ–‡ä»¶çŠ¶æ€ç”Ÿå‘½å‘¨æœŸ**

```
æœªè·Ÿè¸ª (Untracked) â†’ å·²ä¿®æ”¹ (Modified) â†’ å·²æš‚å­˜ (Staged) â†’ å·²æäº¤ (Committed)
```



#### 2. æ—¥å¸¸å¼€å‘å¸¸ç”¨å‘½ä»¤

##### åŸºç¡€å·¥ä½œæµ

```
# å…‹éš†ä»“åº“
git clone <ä»“åº“åœ°å€>

# æŸ¥çœ‹çŠ¶æ€
git status

# æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åŒº
git add <æ–‡ä»¶å>           # æ·»åŠ ç‰¹å®šæ–‡ä»¶
git add .                 # æ·»åŠ æ‰€æœ‰ä¿®æ”¹

# æäº¤æ›´æ”¹
git commit -m "æäº¤æè¿°"

# æ¨é€åˆ°è¿œç¨‹
git push origin <åˆ†æ”¯å>
```

##### åˆ†æ”¯ç®¡ç†ï¼ˆbranchï¼‰

```
# æŸ¥çœ‹åˆ†æ”¯
git branch                 # æœ¬åœ°åˆ†æ”¯
git branch -a              # æ‰€æœ‰åˆ†æ”¯ï¼ˆå«è¿œç¨‹ï¼‰

# åˆ›å»ºåˆ†æ”¯
git branch <æ–°åˆ†æ”¯å>
git checkout -b <æ–°åˆ†æ”¯å>  # åˆ›å»ºå¹¶åˆ‡æ¢

# åˆ‡æ¢åˆ†æ”¯
git checkout <åˆ†æ”¯å>
git switch <åˆ†æ”¯å>         # æ–°ç‰ˆæœ¬æ¨è

# åˆå¹¶åˆ†æ”¯
git merge <è¦åˆå¹¶çš„åˆ†æ”¯>

# åˆ é™¤åˆ†æ”¯
git branch -d <åˆ†æ”¯å>     # å®‰å…¨åˆ é™¤
git branch -D <åˆ†æ”¯å>     # å¼ºåˆ¶åˆ é™¤
```



#### 3. å›¢é˜Ÿåä½œè§„èŒƒ

##### åˆ†æ”¯ç­–ç•¥æ¨¡å‹

**Git Flowï¼ˆç»å…¸æ¨¡å‹ï¼‰**

```
main (master)     â†’ ç”Ÿäº§ä»£ç 
  â†‘
release/*         â†’ å‘å¸ƒåˆ†æ”¯
  â†‘  
develop          â†’ å¼€å‘ä¸»å¹²
  â†‘
feature/*        â†’ åŠŸèƒ½åˆ†æ”¯
```

**GitHub Flowï¼ˆç®€åŒ–æ¨¡å‹ï¼‰**

```
main (master)     â†’ å¯éƒ¨ç½²ä»£ç 
  â†‘
feature/*        â†’ åŠŸèƒ½åˆ†æ”¯ï¼ˆPRåˆå¹¶ï¼‰
```

##### æäº¤ä¿¡æ¯è§„èŒƒ

```
# æ ¼å¼ï¼šç±»å‹(èŒƒå›´): æè¿°
feat(auth): æ·»åŠ ç”¨æˆ·ç™»å½•åŠŸèƒ½
fix(api): ä¿®å¤ç”¨æˆ·æŸ¥è¯¢æ¥å£500é”™è¯¯
docs: æ›´æ–°APIæ–‡æ¡£
style: è°ƒæ•´ä»£ç æ ¼å¼
refactor: é‡æ„æ”¯ä»˜æ¨¡å—
test: æ·»åŠ ç”¨æˆ·æœåŠ¡æµ‹è¯•
chore: æ›´æ–°ä¾èµ–ç‰ˆæœ¬
```



#### 4. ä»£ç å›é€€ä¸æ’¤é”€ï¼ˆresetï¼‰

##### æ’¤é”€å·¥ä½œåŒºä¿®æ”¹

```
# æ’¤é”€å•ä¸ªæ–‡ä»¶ä¿®æ”¹
git checkout -- <æ–‡ä»¶å>

# æ’¤é”€æ‰€æœ‰ä¿®æ”¹
git checkout -- .

# æ’¤é”€æ·»åŠ åˆ°æš‚å­˜åŒºçš„æ–‡ä»¶
git reset HEAD <æ–‡ä»¶å>
```

##### ç‰ˆæœ¬å›é€€

```
# æŸ¥çœ‹æäº¤å†å²
git log --oneline

# å›é€€åˆ°æŒ‡å®šç‰ˆæœ¬
git reset --hard <commit_id>

# å›é€€åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
git reset --hard HEAD^

# æ’¤é”€æäº¤ä½†ä¿ç•™æ›´æ”¹
git reset --soft HEAD^
```



#### 5. è¿œç¨‹ä»“åº“æ“ä½œ

##### è¿œç¨‹ä»“åº“ç®¡ç†

```
# æŸ¥çœ‹è¿œç¨‹ä»“åº“
git remote -v

# æ·»åŠ è¿œç¨‹ä»“åº“
git remote add origin <ä»“åº“åœ°å€>

# æ‹‰å–è¿œç¨‹æ›´æ–°
git pull origin <åˆ†æ”¯å>

# æ¨é€åˆ°è¿œç¨‹
git push -u origin <åˆ†æ”¯å>  # é¦–æ¬¡æ¨é€
git push                     # åç»­æ¨é€

# è·å–è¿œç¨‹åˆ†æ”¯
git fetch origin
git checkout -b <æœ¬åœ°åˆ†æ”¯> origin/<è¿œç¨‹åˆ†æ”¯>
```



#### 6. é«˜çº§æŠ€å·§

##### å‚¨è—æ›´æ”¹ ï¼ˆstashï¼‰

```
# ä¸´æ—¶å‚¨è—å·¥ä½œåŒº
git stash

# æŸ¥çœ‹å‚¨è—åˆ—è¡¨
git stash list

# æ¢å¤å‚¨è—
git stash pop              # æ¢å¤å¹¶åˆ é™¤
git stash apply           # æ¢å¤ä½†ä¸åˆ é™¤

# åˆ é™¤å‚¨è—
git stash drop
```



##### æ ‡ç­¾ç®¡ç†(tag)

```
# åˆ›å»ºæ ‡ç­¾
git tag v1.0.0

# æ¨é€æ ‡ç­¾
git push origin --tags

# æŸ¥çœ‹æ ‡ç­¾
git tag
```



##### æ¯”è¾ƒå·®å¼‚(diff)

```
# æ¯”è¾ƒå·¥ä½œåŒºå’Œæš‚å­˜åŒº
git diff

# æ¯”è¾ƒæš‚å­˜åŒºå’Œæœ€æ–°æäº¤
git diff --staged

# æ¯”è¾ƒä¸¤ä¸ªåˆ†æ”¯
git diff branch1..branch2

# æ¯”è¾ƒç‰¹å®šæ–‡ä»¶
git diff <æ–‡ä»¶è·¯å¾„>
```



#### 7. é…ç½®ä¼˜åŒ–

##### å…¨å±€é…ç½®(config)

```
# ç”¨æˆ·ä¿¡æ¯
git config --global user.name "ä½ çš„å§“å"
git config --global user.email "ä½ çš„é‚®ç®±"

# é»˜è®¤ç¼–è¾‘å™¨
git config --global core.editor "code --wait"

# åˆ«åé…ç½®
git config --global alias.co checkout
git config --global alias.br branch
git config --global alias.ci commit
git config --global alias.st status
```

##### .gitignore æ–‡ä»¶

```
# ä¾èµ–æ–‡ä»¶
node_modules/
vendor/

# æ—¥å¿—æ–‡ä»¶
*.log
logs/

# ç¯å¢ƒé…ç½®
.env
.env.local

# ç³»ç»Ÿæ–‡ä»¶
.DS_Store
Thumbs.db

# æ„å»ºè¾“å‡º
dist/
build/
```



#### 8. é—®é¢˜æ’æŸ¥ä¸è°ƒè¯•

##### æŸ¥çœ‹å†å²è®°å½•

```
# å›¾å½¢åŒ–æŸ¥çœ‹
git log --oneline --graph --all

# æŸ¥çœ‹ç‰¹å®šæ–‡ä»¶çš„ä¿®æ”¹å†å²
git log -p <æ–‡ä»¶è·¯å¾„>

# æŸ¥çœ‹è°ä¿®æ”¹äº†æŸè¡Œä»£ç 
git blame <æ–‡ä»¶å>
# è¾“å‡ºç¤ºä¾‹ï¼š
# ^b7d3a8d (å¼ ä¸‰ 2024-01-15 10:30:25 +0800 1) # é¡¹ç›®æ ‡é¢˜
[æäº¤å“ˆå¸Œ     (ä½œè€…   æ—¥æœŸæ—¶é—´          è¡Œå·) ä»£ç å†…å®¹]


```

##### æ‰¾å›ä¸¢å¤±çš„æäº¤

```
# æŸ¥çœ‹æ‰€æœ‰æ“ä½œè®°å½•
git reflog

# é‡ç½®åˆ°ç‰¹å®šæ“ä½œ
git reset --hard <æ“ä½œID>
```



#### 9. å›¢é˜Ÿåä½œæœ€ä½³å®è·µ

##### ä»£ç å®¡æŸ¥æµç¨‹

```
# 1. ä»mainæ‹‰å–åŠŸèƒ½åˆ†æ”¯
git checkout -b feature/user-auth

# 2. å¼€å‘å¹¶æäº¤
git add .
git commit -m "feat(auth): å®ç°ç”¨æˆ·è®¤è¯"

# 3. æ¨é€åˆ°è¿œç¨‹
git push -u origin feature/user-auth

# 4. åˆ›å»ºPull Requestï¼ˆåœ¨GitHub/GitLabç•Œé¢ï¼‰

# 5. ä»£ç å®¡æŸ¥ååˆå¹¶
```

##### è§£å†³åˆå¹¶å†²çª

```
# æ‹‰å–æœ€æ–°ä»£ç ï¼ˆå¯èƒ½äº§ç”Ÿå†²çªï¼‰
git pull origin main

# æ‰‹åŠ¨è§£å†³å†²çªå
git add .
git commit -m "è§£å†³åˆå¹¶å†²çª"
git push
```



### **ä»£ç æ¶æ„**

> MVC/DDDï¼Œç†è§£DDDåˆ†å±‚æ¶æ„è®¾è®¡æ€æƒ³ï¼Œç”¨æˆ·æ¥å£å±‚/åº”ç”¨å±‚/é¢†åŸŸå±‚/åŸºç¡€è®¾æ–½å±‚

#### 1. MVC æ¶æ„æ¨¡å¼

##### 1.1 åŸºç¡€æ¦‚å¿µ

**MVCï¼ˆModel-View-Controllerï¼‰** - å…³æ³¨è¡¨ç°å±‚çš„åˆ†ç¦»

**ä¸‰å±‚èŒè´£**

| ç»„ä»¶                     | èŒè´£                          | ç¤ºä¾‹                            |
| :----------------------- | :---------------------------- | :------------------------------ |
| **Modelï¼ˆæ¨¡å‹ï¼‰**        | æ•°æ®å’Œä¸šåŠ¡é€»è¾‘                | User, Order, Product            |
| **Viewï¼ˆè§†å›¾ï¼‰**         | ç”¨æˆ·ç•Œé¢å±•ç¤º                  | HTMLé¡µé¢, UIç»„ä»¶                |
| **Controllerï¼ˆæ§åˆ¶å™¨ï¼‰** | å¤„ç†ç”¨æˆ·è¾“å…¥ï¼Œåè°ƒModelå’ŒView | UserController, OrderController |

==> java é¡¹ç›®çš„å¸¸ç”¨æ¶æ„

##### 1.2 å…¸å‹å·¥ä½œæµ

```
ç”¨æˆ·æ“ä½œ â†’ Controlleræ¥æ”¶ â†’ è°ƒç”¨Modelå¤„ç† â†’ è¿”å›Viewå±•ç¤º
    â†‘                                   â†“
    â””â”€â”€â”€â”€â”€â”€â”€ æ›´æ–°View â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### 1.3 ä»£ç ç¤ºä¾‹

```java
// Model
public class User {
    private String id;
    private String name;
    private String email;
    
    // ä¸šåŠ¡é€»è¾‘
    public boolean isValid() {
        return email != null && email.contains("@");
    }
}

// View (JSPç¤ºä¾‹)
<html>
<body>
    <h1>ç”¨æˆ·: ${user.name}</h1>
    <p>é‚®ç®±: ${user.email}</p>
</body>
</html>

// Controller
@Controller
public class UserController {
    @Autowired
    private UserService userService;
    
    @GetMapping("/users/{id}")
    public String getUser(@PathVariable String id, Model model) {
        User user = userService.findById(id);
        model.addAttribute("user", user);
        return "user-detail"; // è§†å›¾åç§°
    }
}
```

##### 1.4 MVC çš„å±€é™æ€§

- âŒ **ä¸šåŠ¡é€»è¾‘åˆ†æ•£**ï¼šä¸šåŠ¡ä»£ç å¯èƒ½æ³„æ¼åˆ°Controller
- âŒ **æ•°æ®åº“è€¦åˆ**ï¼šModelé€šå¸¸ç›´æ¥æ˜ å°„æ•°æ®è¡¨
- âŒ **æµ‹è¯•å›°éš¾**ï¼šä¾èµ–æ¡†æ¶ï¼Œéš¾ä»¥å•å…ƒæµ‹è¯•
- âŒ **è§„æ¨¡æ‰©å±•éš¾**ï¼šå¤æ‚ä¸šåŠ¡æ—¶ä»£ç æ··ä¹±



#### 2. DDD åˆ†å±‚æ¶æ„

##### 2.1 DDD æ ¸å¿ƒæ¦‚å¿µ

**é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDomain-Driven Designï¼‰** - ä»¥ä¸šåŠ¡é¢†åŸŸä¸ºæ ¸å¿ƒçš„æ¶æ„æ–¹æ³•

##### 2.2 å››å±‚æ¶æ„è¯¦è§£

```
ç”¨æˆ·æ¥å£å±‚ (Interface Layer)
    â†“
åº”ç”¨å±‚ (Application Layer)  
    â†“
é¢†åŸŸå±‚ (Domain Layer)       â†â†’ åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)
```



#### 3. DDD å››å±‚æ¶æ„æ·±åº¦è§£æ

##### 3.1 ç”¨æˆ·æ¥å£å±‚ï¼ˆInterface Layerï¼‰

**èŒè´£**ï¼šå¤„ç†ç”¨æˆ·äº¤äº’å’Œå¤–éƒ¨ç³»ç»Ÿé€šä¿¡  ==ã€‹ç±»ä¼¼gatewayç½‘å…³å±‚

**ç»„ä»¶æ„æˆï¼š**

```java
// 1. Controllerï¼ˆREST APIï¼‰
@RestController
@RequestMapping("/api/orders")
public class OrderController {
    private final CreateOrderApplicationService appService;
    
    @PostMapping
    public ResponseEntity<OrderResponse> createOrder(@RequestBody CreateOrderRequest request) {
        OrderResponse response = appService.createOrder(request);
        return ResponseEntity.ok(response);
    }
}

// 2. DTOï¼ˆæ•°æ®ä¼ è¾“å¯¹è±¡ï¼‰
public class CreateOrderRequest {
    private List<OrderItemDTO> items;
    private String customerId;
    private String shippingAddress;
    
    // åªæœ‰getter/setterï¼Œæ— ä¸šåŠ¡é€»è¾‘
}

// 3. èº«ä»½éªŒè¯ã€æƒé™æ£€æŸ¥ç­‰
@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    protected void doFilterInternal(...) {
        // JWTä»¤ç‰ŒéªŒè¯
    }
}
```



##### 3.2 åº”ç”¨å±‚ï¼ˆApplication Layerï¼‰

**èŒè´£**ï¼šåè°ƒé¢†åŸŸå¯¹è±¡å®Œæˆç”¨ä¾‹ï¼Œäº‹åŠ¡è¾¹ç•Œ

**æ ¸å¿ƒç‰¹å¾**

- âœ… **ç”¨ä¾‹å¯¼å‘**ï¼šæ¯ä¸ªæ–¹æ³•å¯¹åº”ä¸€ä¸ªç”¨æˆ·ç”¨ä¾‹
- âœ… **è–„å±‚**ï¼šä¸åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼Œåªæ˜¯åè°ƒ
- âœ… **äº‹åŠ¡è¾¹ç•Œ**ï¼šé€šå¸¸ä¸€ä¸ªæ–¹æ³•ä¸€ä¸ªäº‹åŠ¡

```go
// åº”ç”¨æœåŠ¡
@Service
@Transactional
public class OrderApplicationService {
    private final OrderRepository orderRepository;
    private final ProductRepository productRepository;
    private final DomainEventPublisher eventPublisher;
    
    public OrderResponse createOrder(CreateOrderCommand command) {
        // 1. è·å–é¢†åŸŸå¯¹è±¡
        Customer customer = customerRepository.findById(command.getCustomerId());
        List<Product> products = productRepository.findByIds(command.getProductIds());
        
        // 2. è°ƒç”¨é¢†åŸŸæœåŠ¡
        Order order = Order.create(customer, products, command.getShippingAddress());
        
        // 3. æŒä¹…åŒ–
        orderRepository.save(order);
        
        // 4. å‘å¸ƒé¢†åŸŸäº‹ä»¶
        eventPublisher.publish(new OrderCreatedEvent(order.getId()));
        
        // 5. è¿”å›DTO
        return OrderResponse.from(order);
    }
    
    public void cancelOrder(String orderId) {
        Order order = orderRepository.findById(orderId);
        order.cancel(); // é¢†åŸŸé€»è¾‘åœ¨Orderå®ä½“ä¸­
        orderRepository.save(order);
    }
}
```

##### 3.3 é¢†åŸŸå±‚ï¼ˆDomain Layerï¼‰ - DDDæ ¸å¿ƒ

**èŒè´£**ï¼šåŒ…å«ä¸šåŠ¡é€»è¾‘å’Œè§„åˆ™ï¼Œæœ€æ ¸å¿ƒçš„ä¸€å±‚

###### é¢†åŸŸå±‚ç»„ä»¶

**å®ä½“ï¼ˆEntityï¼‰**

```java
// æœ‰å”¯ä¸€æ ‡è¯†çš„å¯¹è±¡
public class Order extends AggregateRoot<OrderId> {
    private OrderId id;
    private CustomerId customerId;
    private OrderStatus status;
    private Money totalAmount;
    private List<OrderItem> items;
    private Address shippingAddress;
    
    // ä¸šåŠ¡æ–¹æ³•
    public void cancel() {
        if (status == OrderStatus.SHIPPED) {
            throw new IllegalStateException("å·²å‘è´§è®¢å•ä¸èƒ½å–æ¶ˆ");
        }
        this.status = OrderStatus.CANCELLED;
        addDomainEvent(new OrderCancelledEvent(this.id));
    }
    
    public void addItem(Product product, int quantity) {
        // ä¸šåŠ¡è§„åˆ™éªŒè¯
        if (quantity <= 0) {
            throw new IllegalArgumentException("æ•°é‡å¿…é¡»å¤§äº0");
        }
        this.items.add(new OrderItem(product, quantity));
        calculateTotalAmount();
    }
    
    private void calculateTotalAmount() {
        this.totalAmount = items.stream()
            .map(OrderItem::getSubtotal)
            .reduce(Money.ZERO, Money::add);
    }
}
```

**å€¼å¯¹è±¡ï¼ˆValue Objectï¼‰**

```go
// æ— æ ‡è¯†ï¼Œé€šè¿‡å±æ€§å®šä¹‰çš„å¯¹è±¡
public class Money {
    private final BigDecimal amount;
    private final Currency currency;
    
    public Money(BigDecimal amount, Currency currency) {
        this.amount = amount;
        this.currency = currency;
    }
    
    public Money add(Money other) {
        if (!this.currency.equals(other.currency)) {
            throw new IllegalArgumentException("è´§å¸å•ä½ä¸ä¸€è‡´");
        }
        return new Money(this.amount.add(other.amount), this.currency);
    }
    
    // å€¼å¯¹è±¡åŸºäºå±æ€§ç›¸ç­‰
    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (!(o instanceof Money)) return false;
        Money money = (Money) o;
        return amount.compareTo(money.amount) == 0 && 
               currency.equals(money.currency);
    }
}
```

**é¢†åŸŸæœåŠ¡ï¼ˆDomain Serviceï¼‰**

```
// å¤„ç†ä¸é€‚åˆæ”¾åœ¨å®ä½“ä¸­çš„ä¸šåŠ¡é€»è¾‘
@Service
public class OrderPricingService {
    public PricingResult calculatePrice(Order order, PricingContext context) {
        // å¤æ‚çš„å®šä»·é€»è¾‘
        Money basePrice = calculateBasePrice(order);
        Money discount = calculateDiscount(order, context);
        Money tax = calculateTax(order, context);
        
        return new PricingResult(basePrice, discount, tax);
    }
}
```

**é¢†åŸŸäº‹ä»¶ï¼ˆDomain Eventï¼‰** ï¼Ÿï¼Ÿ

```
// è¡¨ç¤ºé¢†åŸŸä¸­å‘ç”Ÿçš„äº‹ä»¶
public class OrderCreatedEvent implements DomainEvent {
    private final OrderId orderId;
    private final Instant occurredOn;
    
    public OrderCreatedEvent(OrderId orderId) {
        this.orderId = orderId;
        this.occurredOn = Instant.now();
    }
}
```

**é¢†åŸŸäº‹ä»¶**æ˜¯**é¢†åŸŸæ¨¡å‹ä¸­å‘ç”Ÿçš„ã€å¯¹ä¸šåŠ¡æœ‰é‡è¦æ„ä¹‰çš„äº‹æƒ…**çš„è¡¨ç¤ºã€‚

![image-20251124164531578](å·¥ç¨‹ç´ å…»ç¯‡ï¼ˆä¸­çº§ï¼‰.assets/image-20251124164531578.png)

ğŸ’¡ **æ ¸å¿ƒç‰¹å¾**

| ç‰¹å¾         | è¯´æ˜               | ç¤ºä¾‹                             |
| :----------- | :----------------- | :------------------------------- |
| **è¿‡å»æ—¶**   | æè¿°å·²å‘ç”Ÿçš„äº‹     | `OrderCreated`è€Œé `CreateOrder` |
| **ä¸å¯å˜**   | äº‹ä»¶å‘ç”Ÿåä¸å¯æ›´æ”¹ | å°±åƒå†å²äº‹å®                     |
| **ä¸šåŠ¡å«ä¹‰** | åæ˜ ä¸šåŠ¡ä»·å€¼å˜åŒ–   | è€Œä¸ä»…æ˜¯æŠ€æœ¯æ“ä½œ                 |



##### 3.4 åŸºç¡€è®¾æ–½å±‚ï¼ˆInfrastructure Layerï¼‰

**èŒè´£**ï¼šæŠ€æœ¯å®ç°ç»†èŠ‚ï¼Œä¸ºå…¶ä»–å±‚æä¾›æŠ€æœ¯æ”¯æŒ

**ç»„ä»¶ç¤ºä¾‹**

```java
// 1. ä»“å‚¨å®ç°ï¼ˆRepository Implementationï¼‰
@Repository
public class JpaOrderRepository implements OrderRepository {
    private final OrderJpaRepository jpaRepository;
    private final OrderMapper mapper;
    
    @Override
    public Order findById(OrderId id) {
        OrderEntity entity = jpaRepository.findById(id.getValue())
            .orElseThrow(() -> new OrderNotFoundException(id));
        return mapper.toDomain(entity);
    }
    
    @Override
    public void save(Order order) {
        OrderEntity entity = mapper.toEntity(order);
        jpaRepository.save(entity);
        
        // å‘å¸ƒé¢†åŸŸäº‹ä»¶
        order.getDomainEvents().forEach(event -> eventPublisher.publish(event));
        order.clearDomainEvents();
    }
}

// 2. å¤–éƒ¨æœåŠ¡è°ƒç”¨
@Component  
public class EmailServiceClient implements NotificationService {
    private final RestTemplate restTemplate;
    
    public void sendOrderConfirmation(Order order) {
        EmailRequest request = createEmailRequest(order);
        restTemplate.postForObject("/emails", request, Void.class);
    }
}

// 3. æ•°æ®åº“é…ç½®ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰
@Configuration
public class JpaConfig {
    @Bean
    public LocalContainerEntityManagerFactoryBean entityManagerFactory() {
        // JPAé…ç½®
    }
}
```



#### 4. ä¾èµ–æ–¹å‘ä¸æ¶æ„åŸåˆ™

##### 4.1 ä¾èµ–å…³ç³»

```
ç”¨æˆ·æ¥å£å±‚ â†’ åº”ç”¨å±‚ â†’ é¢†åŸŸå±‚ â† åŸºç¡€è®¾æ–½å±‚
    â†“          â†“                    â†‘
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â†’ DTO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**DTO** æ˜¯ **æ•°æ®ä¼ è¾“å¯¹è±¡ï¼ˆData Transfer Objectï¼‰** çš„ç¼©å†™ï¼Œæ˜¯åœ¨åˆ†å±‚æ¶æ„ä¸­ç”¨äº**å±‚é—´æ•°æ®ä¼ è¾“çš„ç®€å•å®¹å™¨å¯¹è±¡**ã€‚

##### 4.2 ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDIPï¼‰

```java
// é¢†åŸŸå±‚å®šä¹‰æ¥å£
public interface OrderRepository {
    Order findById(OrderId id);
    void save(Order order);
    List<Order> findByCustomerId(CustomerId customerId);
}

// âœ… æ­£ç¡®ï¼šåŸºç¡€è®¾æ–½å±‚ï¼ˆä½å±‚ï¼‰å®ç°æŠ½è±¡
public class JpaOrderRepository implements OrderRepository { // å®ç°æŠ½è±¡
    // å…·ä½“å®ç°ç»†èŠ‚...
}

// âœ… æ­£ç¡®ï¼šé¢†åŸŸå±‚ï¼ˆé«˜å±‚ï¼‰ä¾èµ–æŠ½è±¡
public class OrderService { // é¢†åŸŸæœåŠ¡ï¼Œé«˜å±‚æ¨¡å—
    private final OrderRepository repository; // ä¾èµ–æŠ½è±¡æ¥å£
    
    public OrderService(OrderRepository repository) {
        this.repository = repository; // ä¾èµ–æ³¨å…¥
    }
    
    public void processOrder(OrderId id) {
        Order order = repository.findById(id); // ä½¿ç”¨æŠ½è±¡
        // ä¸šåŠ¡é€»è¾‘...
    }
}
```

**DIPå®šä¹‰ï¼š**

- **é«˜å±‚æ¨¡å—**ä¸åº”è¯¥ä¾èµ–**ä½å±‚æ¨¡å—**ï¼Œä¸¤è€…éƒ½åº”è¯¥ä¾èµ–**æŠ½è±¡**
- **æŠ½è±¡**ä¸åº”è¯¥ä¾èµ–**ç»†èŠ‚**ï¼Œ**ç»†èŠ‚**åº”è¯¥ä¾èµ–**æŠ½è±¡**

<img src="å·¥ç¨‹ç´ å…»ç¯‡ï¼ˆä¸­çº§ï¼‰.assets/image-20251124165604463.png" alt="image-20251124165604463" style="zoom:33%;" />



#### 5. å®Œæ•´æ¡ˆä¾‹ï¼šè®¢å•ç³»ç»Ÿ

##### 5.1 é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ main/
â”‚   â”œâ”€â”€ java/
â”‚   â”‚   â”œâ”€â”€ com/example/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/          # åº”ç”¨å±‚
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ OrderApplicationService.java
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ dto/              # DTO
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/               # é¢†åŸŸå±‚
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ model/            # é¢†åŸŸæ¨¡å‹
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Order.java
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ OrderItem.java
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ value/        # å€¼å¯¹è±¡
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ service/          # é¢†åŸŸæœåŠ¡  
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ event/            # é¢†åŸŸäº‹ä»¶
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ repository/       # ä»“å‚¨æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/       # åŸºç¡€è®¾æ–½å±‚
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ persistence/      # æŒä¹…åŒ–å®ç°
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ external/         # å¤–éƒ¨æœåŠ¡
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ config/           # é…ç½®
â”‚   â”‚   â”‚   â””â”€â”€ interfaces/           # ç”¨æˆ·æ¥å£å±‚
â”‚   â”‚   â”‚       â”œâ”€â”€ web/              # Webæ§åˆ¶å™¨
â”‚   â”‚   â”‚       â””â”€â”€ dto/              # è¯·æ±‚/å“åº”DTO
```

##### 5.2 å®Œæ•´å·¥ä½œæµ

```go
// 1. æ§åˆ¶å™¨æ¥æ”¶è¯·æ±‚
@PostMapping("/orders")
public OrderResponse createOrder(@RequestBody CreateOrderRequest request) {
    CreateOrderCommand command = mapper.toCommand(request);
    return orderAppService.createOrder(command);
}

// 2. åº”ç”¨æœåŠ¡åè°ƒ
public OrderResponse createOrder(CreateOrderCommand command) {
    // éªŒè¯ã€åè°ƒé¢†åŸŸå¯¹è±¡ã€æŒä¹…åŒ–ã€å‘å¸ƒäº‹ä»¶
    Customer customer = customerRepo.findById(command.getCustomerId());
    Order order = Order.create(customer, command.getItems());
    orderRepo.save(order);
    eventPublisher.publish(new OrderCreatedEvent(order.getId()));
    return OrderResponse.from(order);
}

// 3. é¢†åŸŸå¯¹è±¡å¤„ç†ä¸šåŠ¡é€»è¾‘
public class Order {
    public static Order create(Customer customer, List<OrderItem> items) {
        // ä¸šåŠ¡è§„åˆ™éªŒè¯
        if (items.isEmpty()) {
            throw new EmptyOrderException();
        }
        
        Order order = new Order(generateOrderId(), customer.getId(), items);
        order.calculateTotalAmount();
        return order;
    }
}
```

#### 6. DDD åˆ†å±‚ä¼˜åŠ¿æ€»ç»“

**æ¶æ„ä¼˜åŠ¿å¯¹æ¯”**

| æ–¹é¢             | MVC              | DDDåˆ†å±‚            |
| :--------------- | :--------------- | :----------------- |
| **ä¸šåŠ¡é€»è¾‘é›†ä¸­** | åˆ†æ•£åœ¨å„å¤„       | é›†ä¸­åœ¨é¢†åŸŸå±‚       |
| **å¯æµ‹è¯•æ€§**     | ä¾èµ–æ¡†æ¶ï¼Œéš¾æµ‹è¯• | é¢†åŸŸå±‚å¯ç‹¬ç«‹æµ‹è¯•   |
| **æŠ€æœ¯æ— å…³æ€§**   | ä¸æŠ€æœ¯æ¡†æ¶è€¦åˆ   | é¢†åŸŸé€»è¾‘çº¯Java     |
| **æ¼”è¿›èƒ½åŠ›**     | ä¿®æ”¹å½±å“é¢å¤§     | å„å±‚ç‹¬ç«‹æ¼”è¿›       |
| **å¤æ‚åº¦ç®¡ç†**   | éšç€ä¸šåŠ¡å˜å¤æ‚   | é€šè¿‡é™ç•Œä¸Šä¸‹æ–‡åˆ†è§£ |

**é€‚ç”¨åœºæ™¯**

**é€‰æ‹© MVC å½“**ï¼š

- ç®€å•CRUDåº”ç”¨
- å¿«é€ŸåŸå‹å¼€å‘
- å›¢é˜Ÿè§„æ¨¡å°ï¼Œä¸šåŠ¡ç®€å•

**é€‰æ‹© DDD å½“**ï¼š

- å¤æ‚ä¸šåŠ¡é¢†åŸŸ
- é•¿æœŸæ¼”è¿›çš„å¤§å‹ç³»ç»Ÿ
- éœ€è¦é«˜åº¦å¯ç»´æŠ¤æ€§
- å¤šå›¢é˜Ÿåä½œå¼€å‘



### **ç›®å½•ç»“æ„**

> goè§„èŒƒæ¸…æ™°layoutï¼Œå‚è€ƒ [golang-standards](https://github.com/golang-standards/project-layout)

#### 1. æ ‡å‡†ç›®å½•ç»“æ„ï¼ˆå‚è€ƒ Go æ ‡å‡†ï¼‰

##### 1.1 åŸºç¡€é¡¹ç›®å¸ƒå±€

```
my-project/
â”œâ”€â”€ cmd/                 # åº”ç”¨ç¨‹åºå…¥å£
â”œâ”€â”€ internal/            # ç§æœ‰åº”ç”¨å’Œåº“ä»£ç 
â”œâ”€â”€ pkg/                # å…¬å…±åº“ä»£ç 
â”œâ”€â”€ api/                # API å®šä¹‰æ–‡ä»¶
â”œâ”€â”€ web/                # Web ç›¸å…³èµ„æº
â”œâ”€â”€ configs/            # é…ç½®æ–‡ä»¶
â”œâ”€â”€ deployments/        # éƒ¨ç½²é…ç½®
â”œâ”€â”€ test/              # æµ‹è¯•ç›¸å…³
â”œâ”€â”€ docs/              # æ–‡æ¡£ docs
â”œâ”€â”€ examples/           # ç¤ºä¾‹ä»£ç 
â”œâ”€â”€ vendor/            # ä¾èµ–åŒ…ï¼ˆGo modules å‰ï¼‰
â”œâ”€â”€ third_party/       # å¤–éƒ¨å·¥å…·å’Œç¬¬ä¸‰æ–¹ä»£ç 
â”œâ”€â”€ scripts/          # è„šæœ¬æ–‡ä»¶
â”œâ”€â”€ build/            # æ„å»ºç›¸å…³
â”œâ”€â”€ init/             # ç³»ç»Ÿåˆå§‹åŒ–æ–‡ä»¶
â”œâ”€â”€ Makefile          # æ„å»ºè„šæœ¬
â”œâ”€â”€ go.mod           # Go æ¨¡å—å®šä¹‰
â””â”€â”€ README.md        # é¡¹ç›®è¯´æ˜
```

#### 2. è¯¦ç»†ç›®å½•è¯´æ˜

##### 2.1 æ ¸å¿ƒç›®å½•è¯¦è§£

###### cmd/ - åº”ç”¨ç¨‹åºå…¥å£

```
cmd/
â”œâ”€â”€ app1/            # åº”ç”¨1å…¥å£
â”‚   â”œâ”€â”€ main.go
â”‚   â””â”€â”€ config.yaml
â”œâ”€â”€ app2/            # åº”ç”¨2å…¥å£  
â”‚   â””â”€â”€ main.go
â””â”€â”€ migration/       # æ•°æ®åº“è¿ç§»å·¥å…·
    â””â”€â”€ main.go
```

**ç¤ºä¾‹ä»£ç **ï¼š

```
// cmd/api/main.go
package main

import (
    "my-project/internal/api"
    "my-project/internal/config"
)

func main() {
    cfg := config.Load()
    server := api.NewServer(cfg)
    server.Run()
}
```

###### internal/ - ç§æœ‰ä»£ç ï¼ˆå¤–éƒ¨æ— æ³•å¯¼å…¥ï¼‰

```
internal/
â”œâ”€â”€ api/             # HTTP API å±‚
â”‚   â”œâ”€â”€ handler/     # HTTP å¤„ç†å™¨
â”‚   â”œâ”€â”€ middleware/  # ä¸­é—´ä»¶
â”‚   â””â”€â”€ router.go    # è·¯ç”±å®šä¹‰
â”œâ”€â”€ service/         # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ user.go
â”‚   â”œâ”€â”€ order.go
â”‚   â””â”€â”€ interface.go # æœåŠ¡æ¥å£
â”œâ”€â”€ repository/      # æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ user.go
â”‚   â”œâ”€â”€ order.go
â”‚   â””â”€â”€ interface.go # ä»“å‚¨æ¥å£
â”œâ”€â”€ domain/          # é¢†åŸŸæ¨¡å‹
â”‚   â”œâ”€â”€ user.go
â”‚   â”œâ”€â”€ order.go
â”‚   â””â”€â”€ value.go     # å€¼å¯¹è±¡
â”œâ”€â”€ config/          # é…ç½®ç®¡ç†
â”‚   â””â”€â”€ config.go
â””â”€â”€ pkg/             # å†…éƒ¨å…¬å…±åº“ï¼ˆå¯è¢«internalå†…å…¶ä»–åŒ…å¯¼å…¥ï¼‰
    â”œâ”€â”€ database/
    â”œâ”€â”€ cache/
    â””â”€â”€ validator/
```

###### pkg/ - å…¬å…±åº“ä»£ç ï¼ˆå¯è¢«å¤–éƒ¨é¡¹ç›®å¯¼å…¥ï¼‰

```
pkg/
â”œâ”€â”€ utils/           # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ stringutil.go
â”‚   â””â”€â”€ timeutil.go
â”œâ”€â”€ logger/          # æ—¥å¿—åº“
â”‚   â””â”€â”€ logger.go
â”œâ”€â”€ database/        # æ•°æ®åº“å…¬å…±ç»„ä»¶
â”‚   â””â”€â”€ postgres.go
â”œâ”€â”€ auth/           # è®¤è¯æˆæƒ
â”‚   â””â”€â”€ jwt.go
â””â”€â”€ queue/          # æ¶ˆæ¯é˜Ÿåˆ—
    â””â”€â”€ redisq.go
```

##### 2.2 é…ç½®æ–‡ä»¶ç›®å½•

```
configs/
â”œâ”€â”€ dev.yaml         # å¼€å‘ç¯å¢ƒé…ç½®
â”œâ”€â”€ staging.yaml     # æµ‹è¯•ç¯å¢ƒé…ç½®  
â”œâ”€â”€ production.yaml  # ç”Ÿäº§ç¯å¢ƒé…ç½®
â””â”€â”€ config.go        # é…ç½®ç»“æ„ä½“å®šä¹‰
```

**é…ç½®ç¤ºä¾‹**ï¼š

```
// configs/config.go
package config

type Config struct {
    Server   ServerConfig   `yaml:"server"`
    Database DatabaseConfig `yaml:"database"`
    Redis    RedisConfig    `yaml:"redis"`
}

type ServerConfig struct {
    Port int    `yaml:"port"`
    Env  string `yaml:"env"`
}
```

##### 2.3 API å®šä¹‰ç›®å½•

```
api/
â”œâ”€â”€ openapi/         # OpenAPI è§„èŒƒ
â”‚   â””â”€â”€ swagger.yaml
â”œâ”€â”€ protobuf/        # gRPC åè®®å®šä¹‰
â”‚   â”œâ”€â”€ user.proto
â”‚   â””â”€â”€ order.proto
â””â”€â”€ graphql/         # GraphQL Schema
    â””â”€â”€ schema.graphql
```



### è½¯ä»¶**è®¾è®¡åŸåˆ™**

> SOLIDåŸåˆ™ å•ä¸€æŒ‡è´£/å¼€é—­åŸåˆ™/æ¥å£éš”ç¦»...ï¼ŒKISS/DRY/YAGNI/LODåŸåˆ™ é˜²æ­¢è¿‡åº¦è®¾è®¡/ä¸å†™é‡å¤ä»£ç ...

#### 1. SOLID åŸåˆ™è¯¦è§£

##### 1.1 SRP - å•ä¸€èŒè´£åŸåˆ™ (Single Responsibility Principle)

**æ ¸å¿ƒæ€æƒ³**ï¼šä¸€ä¸ªç±»åº”è¯¥åªæœ‰ä¸€ä¸ªå¼•èµ·å˜åŒ–çš„åŸå› 

**è¿åç¤ºä¾‹**

```java
// è¿åSRP - æ‰¿æ‹…äº†å¤ªå¤šèŒè´£
class UserManager {
    public void createUser(String username, String password) { /* ç”¨æˆ·åˆ›å»º */ }
    public void sendEmail(String to, String subject, String body) { /* é‚®ä»¶å‘é€ */ }
    public void logActivity(String activity) { /* æ—¥å¿—è®°å½• */ }
    public void validatePassword(String password) { /* å¯†ç éªŒè¯ */ }
}
```

**éµå¾ªç¤ºä¾‹**

```java
// æ‹†åˆ†èŒè´£
class UserService {
    private EmailService emailService;
    private Logger logger;
    private PasswordValidator validator;
    
    public void createUser(String username, String password) {
        validator.validate(password);
        // åˆ›å»ºç”¨æˆ·é€»è¾‘
        emailService.sendWelcomeEmail(username);
        logger.log("User created: " + username);
    }
}

class EmailService { /* åªå¤„ç†é‚®ä»¶ç›¸å…³ */ }
class Logger { /* åªå¤„ç†æ—¥å¿—ç›¸å…³ */ }
class PasswordValidator { /* åªå¤„ç†å¯†ç éªŒè¯ */ }
```

**åº”ç”¨åœºæ™¯**ï¼š

- å¾®æœåŠ¡è®¾è®¡ï¼šæ¯ä¸ªæœåŠ¡å•ä¸€èŒè´£
- å‡½æ•°è®¾è®¡ï¼šå‡½æ•°åªåšä¸€ä»¶äº‹
- æ¨¡å—åˆ’åˆ†ï¼šæ¨¡å—åŠŸèƒ½å†…èš

##### 1.2 OCP - å¼€é—­åŸåˆ™ (Open/Closed Principle)

**æ ¸å¿ƒæ€æƒ³**ï¼šå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­

**è¿åç¤ºä¾‹**

```java
class ShapeCalculator {
    public double calculateArea(String shapeType, double... params) {
        if ("circle".equals(shapeType)) {
            return Math.PI * params[0] * params[0];
        } else if ("rectangle".equals(shapeType)) {
            return params[0] * params[1];
        }
        // æ·»åŠ æ–°å½¢çŠ¶éœ€è¦ä¿®æ”¹æ­¤ç±»
        throw new IllegalArgumentException("Unsupported shape");
    }
}
```

**éµå¾ªç¤ºä¾‹**

```java
// æŠ½è±¡åŸºç±»
abstract class Shape {
    public abstract double calculateArea();
}

// å…·ä½“å®ç°
class Circle extends Shape {
    private double radius;
    public double calculateArea() { return Math.PI * radius * radius; }
}

class Rectangle extends Shape {
    private double width, height;
    public double calculateArea() { return width * height; }
}

// æ‰©å±•æ—¶æ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 
class Triangle extends Shape {
    private double base, height;
    public double calculateArea() { return 0.5 * base * height; }
}

class AreaCalculator {
    public double calculateTotalArea(List<Shape> shapes) {
        return shapes.stream().mapToDouble(Shape::calculateArea).sum();
    }
}
```

**è®¾è®¡æ¨¡å¼åº”ç”¨**ï¼š

- ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰==ã€‹å¯ä»¥å¾ˆå¥½æ‰©å±•ï¼Œä¸åŒé…ç½®ä½¿ç”¨ä¸åŒçš„handleå‡½æ•°
- æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼ˆTemplate Methodï¼‰
- è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆObserver Patternï¼‰



##### 1.3 LSP - é‡Œæ°æ›¿æ¢åŸåˆ™ (Liskov Substitution Principle)

**æ ¸å¿ƒæ€æƒ³**ï¼šå­ç±»å¿…é¡»èƒ½å¤Ÿæ›¿æ¢çˆ¶ç±»ï¼Œä¸”è¡Œä¸ºä¸€è‡´

**è¿åç¤ºä¾‹**

```java
class Rectangle {
    protected int width, height;
    
    public void setWidth(int width) { this.width = width; }
    public void setHeight(int height) { this.height = height; }
    public int getArea() { return width * height; }
}

class Square extends Rectangle {
    // è¿åLSPï¼šæ”¹å˜äº†çˆ¶ç±»è¡Œä¸º
    @Override
    public void setWidth(int width) { 
        super.setWidth(width);
        super.setHeight(width); // æ­£æ–¹å½¢å®½é«˜ç›¸ç­‰
    }
    
    @Override
    public void setHeight(int height) {
        super.setHeight(height);
        super.setWidth(height);
    }
}

// ä½¿ç”¨æ—¶ä¼šå‡ºé—®é¢˜
void testRectangle(Rectangle rect) {
    rect.setWidth(5);
    rect.setHeight(4);
    assert rect.getArea() == 20; // å¦‚æœä¼ å…¥Squareï¼Œç»“æœä¸º16ï¼Œè¿åé¢„æœŸ
}
```

**éµå¾ªç¤ºä¾‹**

```java
abstract class Shape {
    public abstract int getArea();
}

class Rectangle extends Shape {
    private int width, height;
    // æ„é€ å‡½æ•°ç¡®ä¿ä¸å˜æ€§
    public Rectangle(int width, int height) {
        this.width = width;
        this.height = height;
    }
    public int getArea() { return width * height; }
}

class Square extends Shape {
    private int side;
    public Square(int side) { this.side = side; }
    public int getArea() { return side * side; }
}
```



##### 1.4 ISP - æ¥å£éš”ç¦»åŸåˆ™ (Interface Segregation Principle)

**æ ¸å¿ƒæ€æƒ³**ï¼šå®¢æˆ·ç«¯ä¸åº”ä¾èµ–å®ƒä¸éœ€è¦çš„æ¥å£

**è¿åç¤ºä¾‹**

```
// è‡ƒè‚¿çš„æ¥å£
interface Worker {
    void work();
    void eat();
    void sleep();
    void code();
    void design();
    void test();
}

class Programmer implements Worker {
    public void work() { /* ç¼–ç¨‹å·¥ä½œ */ }
    public void eat() { /* åƒé¥­ */ }
    public void sleep() { /* ç¡è§‰ */ }
    public void code() { /* å†™ä»£ç  */ }
    public void design() { /* ä¸éœ€è¦ï¼Œä½†å¿…é¡»å®ç° */ }
    public void test() { /* ä¸éœ€è¦ï¼Œä½†å¿…é¡»å®ç° */ }
}
```

**éµå¾ªç¤ºä¾‹**

```
// ç»†ç²’åº¦æ¥å£
interface Workable { void work(); }
interface Eatable { void eat(); }
interface Sleepable { void sleep(); }

interface ProgrammerWork extends Workable {
    void code();
    void debug();
}

interface DesignerWork extends Workable {
    void design();
    void prototype();
}

class Programmer implements ProgrammerWork, Eatable, Sleepable {
    public void work() { /* å·¥ä½œ */ }
    public void code() { /* ç¼–ç  */ }
    public void debug() { /* è°ƒè¯• */ }
    public void eat() { /* åƒé¥­ */ }
    public void sleep() { /* ç¡è§‰ */ }
}
```



##### 1.5 DIP - ä¾èµ–å€’ç½®åŸåˆ™ (Dependency Inversion Principle)

**æ ¸å¿ƒæ€æƒ³**ï¼šä¾èµ–æŠ½è±¡ï¼Œè€Œä¸æ˜¯å…·ä½“å®ç°

**è¿åç¤ºä¾‹**

```java
// é«˜å±‚æ¨¡å—ä¾èµ–ä½å±‚æ¨¡å—
class MySQLDatabase {
    public void save(String data) { /* MySQL å®ç° */ }
}

class ReportService {
    private MySQLDatabase database; // ç›´æ¥ä¾èµ–å…·ä½“å®ç°
    
    public void generateReport() {
        // ä¸šåŠ¡é€»è¾‘
        database.save(reportData);
    }
}
```

**éµå¾ªç¤ºä¾‹**

```java
// æŠ½è±¡æ¥å£
interface Database {
    void save(String data);
    String load(String id);
}

// å…·ä½“å®ç°
class MySQLDatabase implements Database {
    public void save(String data) { /* MySQL å®ç° */ }
    public String load(String id) { /* MySQL å®ç° */ }
}

class MongoDB implements Database {
    public void save(String data) { /* MongoDB å®ç° */ }
    public String load(String id) { /* MongoDB å®ç° */ }
}

// é«˜å±‚æ¨¡å—ä¾èµ–æŠ½è±¡
class ReportService {
    private Database database; // ä¾èµ–æŠ½è±¡
    
    public ReportService(Database database) {
        this.database = database; // ä¾èµ–æ³¨å…¥
    }
    
    public void generateReport() {
        database.save(reportData);
    }
}
```



#### 2. KISS / DRY / YAGNI /LODåŸåˆ™

##### 2.1 KISS - ä¿æŒç®€å•åŸåˆ™ (Keep It Simple, Stupid)

**æ ¸å¿ƒæ€æƒ³**ï¼šç®€å•ä¼˜äºå¤æ‚

**è¿åç¤ºä¾‹**

```java
// è¿‡åº¦è®¾è®¡
public class ComplexUserValidator {
    public ValidationResult validateUserRegistration(
        UserRegistrationDTO registration, 
        ValidationContext context, 
        ValidationConfig config) {
        
        // å¤æ‚çš„éªŒè¯é€»è¾‘é“¾
        if (context.isStrictMode() && config.enableAdvancedValidation()) {
            return performAdvancedValidation(registration, context, config);
        }
        // ... æ›´å¤šå¤æ‚é€»è¾‘
    }
}
```

**éµå¾ªç¤ºä¾‹**

```java
// ç®€å•ç›´æ¥
public class UserService {
    public void registerUser(String email, String password) {
        if (!isValidEmail(email)) {
            throw new IllegalArgumentException("Invalid email");
        }
        if (!isValidPassword(password)) {
            throw new IllegalArgumentException("Invalid password");
        }
        createUser(email, password);
    }
    
    private boolean isValidEmail(String email) {
        return email != null && email.contains("@");
    }
    
    private boolean isValidPassword(String password) {
        return password != null && password.length() >= 8;
    }
}
```

##### 2.2 DRY - ä¸è¦é‡å¤è‡ªå·± (Don't Repeat Yourself)

**æ ¸å¿ƒæ€æƒ³**ï¼šæ¶ˆé™¤é‡å¤ä»£ç 

**è¿åç¤ºä¾‹**

```
class UserService {
    public void createUser(String name, String email) {
        // é‡å¤çš„éªŒè¯é€»è¾‘
        if (name == null || name.trim().isEmpty()) {
            throw new IllegalArgumentException("Name cannot be empty");
        }
        if (email == null || !email.contains("@")) {
            throw new IllegalArgumentException("Invalid email");
        }
        // åˆ›å»ºç”¨æˆ·
    }
    
    public void updateUser(String name, String email) {
        // é‡å¤çš„éªŒè¯é€»è¾‘
        if (name == null || name.trim().isEmpty()) {
            throw new IllegalArgumentException("Name cannot be empty");
        }
        if (email == null || !email.contains("@")) {
            throw new IllegalArgumentException("Invalid email");
        }
        // æ›´æ–°ç”¨æˆ·
    }
}
```

**éµå¾ªç¤ºä¾‹**

```
class Validator {
    public static void validateName(String name) {
        if (name == null || name.trim().isEmpty()) {
            throw new IllegalArgumentException("Name cannot be empty");
        }
    }
    
    public static void validateEmail(String email) {
        if (email == null || !email.contains("@")) {
            throw new IllegalArgumentException("Invalid email");
        }
    }
}

class UserService {
    public void createUser(String name, String email) {
        Validator.validateName(name);
        Validator.validateEmail(email);
        // åˆ›å»ºç”¨æˆ·
    }
    
    public void updateUser(String name, String email) {
        Validator.validateName(name);
        Validator.validateEmail(email);
        // æ›´æ–°ç”¨æˆ·
    }
}
```



##### 2.3 YAGNI - ä½ ä¸ä¼šéœ€è¦å®ƒ (You Ain't Gonna Need It)

**æ ¸å¿ƒæ€æƒ³**ï¼šä¸è¦è¿‡åº¦è®¾è®¡ï¼Œåªå®ç°å½“å‰éœ€è¦çš„åŠŸèƒ½

**è¿åç¤ºä¾‹**

```java
// è¿‡åº¦è®¾è®¡ï¼Œä¸ºæœªæ¥å¯èƒ½çš„éœ€æ±‚åšå‡†å¤‡
interface NotificationService {
    void sendEmail(String to, String subject, String body);
    void sendSMS(String phone, String message);
    void sendPush(String deviceId, String message);
    void sendWeChat(String openId, String message); // å¯èƒ½æ°¸è¿œç”¨ä¸åˆ°
    void sendTelegram(String chatId, String message); // å¯èƒ½æ°¸è¿œç”¨ä¸åˆ°
}

class UserNotifier {
    private NotificationService notifier;
    
    // å®ç°äº†æ‰€æœ‰å¯èƒ½çš„æ¶ˆæ¯ç±»å‹
    public void notifyUser(User user, String message, NotificationType type) {
        switch (type) {
            case EMAIL: notifier.sendEmail(user.getEmail(), "Notification", message); break;
            case SMS: notifier.sendSMS(user.getPhone(), message); break;
            case PUSH: notifier.sendPush(user.getDeviceId(), message); break;
            // å®ç°äº†å¯èƒ½ä¸éœ€è¦çš„åŠŸèƒ½
        }
    }
}
```

**éµå¾ªç¤ºä¾‹**

```java
// åªå®ç°å½“å‰éœ€è¦çš„åŠŸèƒ½
interface NotificationService {
    void sendEmail(String to, String subject, String body);
    // éœ€è¦æ—¶å†æ·»åŠ å…¶ä»–æ–¹æ³•
}

class UserNotifier {
    private NotificationService emailNotifier;
    
    // å½“å‰åªéœ€è¦é‚®ä»¶é€šçŸ¥
    public void notifyUserByEmail(User user, String message) {
        emailNotifier.sendEmail(user.getEmail(), "Notification", message);
    }
    
    // éœ€è¦çŸ­ä¿¡é€šçŸ¥æ—¶å†æ·»åŠ 
    // public void notifyUserBySMS(User user, String message) { ... }
}
```



##### 2.4. LOD - è¿ªç±³ç‰¹æ³•åˆ™ (Law of Demeter)

**æ ¸å¿ƒæ€æƒ³**ï¼šåªä¸ç›´æ¥çš„æœ‹å‹é€šä¿¡

**è¿åç¤ºä¾‹**

```java
class CustomerService {
    public void processOrder(Customer customer) {
        // è¿åLODï¼šä¸é—´æ¥å¯¹è±¡é€šä¿¡
        String city = customer.getAddress().getCity().toUpperCase();
        // é“¾å¼è°ƒç”¨ï¼Œè€¦åˆåº¦è¿‡é«˜  ==>è·¨classæ—¶é¿å…é“¾å¼è°ƒç”¨
    }
}

class Customer {
    private Address address;
    public Address getAddress() { return address; }
}

class Address {
    private City city;
    public City getCity() { return city; }
}

class City {
    private String name;
    public String getName() { return name; }
}
```

**éµå¾ªç¤ºä¾‹**

```java
class CustomerService {
    public void processOrder(Customer customer) {
        // åªä¸ç›´æ¥æœ‹å‹é€šä¿¡
        String city = customer.getCityName();
    }
}

class Customer {
    private Address address;
    
    // å°è£…å†…éƒ¨ç»†èŠ‚
    public String getCityName() {
        return address != null ? address.getCityName() : "";
    }
}

class Address {
    private City city;
    
    public String getCityName() {
        return city != null ? city.getName() : "";
    }
}
```



#### 3. åŸåˆ™å†²çªä¸æƒè¡¡

##### 3.1 åŸåˆ™ä¹‹é—´çš„æƒè¡¡

| å†²çªåœºæ™¯               | åŸåˆ™A | åŸåˆ™B | è§£å†³æ–¹æ¡ˆ                          |
| :--------------------- | :---- | :---- | :-------------------------------- |
| **ç®€å•æ€§ vs æ‰©å±•æ€§**   | KISS  | OCP   | æ ¹æ®å˜åŒ–é¢‘ç‡å†³å®šï¼Œé«˜é¢‘å˜åŒ–éµå¾ªOCP |
| **ä¸é‡å¤ vs ç®€å•æ€§**   | DRY   | KISS  | é€‚åº¦æŠ½è±¡ï¼Œé¿å…è¿‡åº¦å·¥ç¨‹            |
| **å•ä¸€èŒè´£ vs ç±»çˆ†ç‚¸** | SRP   | KISS  | æŒ‰å˜åŒ–åŸå› åˆ†ç»„ï¼Œåˆç†ç²’åº¦          |

##### 3.2 å®ç”¨å»ºè®®

1. **åˆåˆ›é¡¹ç›®**ï¼šä¼˜å…ˆKISSã€YAGNIï¼Œå¿«é€Ÿè¿­ä»£
2. **æˆç†Ÿç³»ç»Ÿ**ï¼šæ³¨é‡OCPã€SRPï¼Œä¿è¯å¯ç»´æŠ¤æ€§
3. **å›¢é˜Ÿåä½œ**ï¼šå¼ºè°ƒDRYã€ISPï¼Œæé«˜ä»£ç å¤ç”¨
4. **å¤æ‚ä¸šåŠ¡**ï¼šåº”ç”¨DIPã€LSPï¼Œé™ä½è€¦åˆåº¦

#### 4. è®¾è®¡åŸåˆ™æ£€æŸ¥æ¸…å•

- âœ… è¿™ä¸ªç±»/æ–¹æ³•æ˜¯å¦åªæœ‰ä¸€ä¸ªæ”¹å˜çš„åŸå› ï¼Ÿï¼ˆSRPï¼‰
- âœ… æ–°åŠŸèƒ½æ˜¯å¦é€šè¿‡æ‰©å±•è€Œéä¿®æ”¹å®ç°ï¼Ÿï¼ˆOCPï¼‰
- âœ… å­ç±»æ˜¯å¦èƒ½å®Œå…¨æ›¿æ¢çˆ¶ç±»ï¼Ÿï¼ˆLSPï¼‰
- âœ… æ¥å£æ˜¯å¦è¶³å¤Ÿä¸“æ³¨å’Œæœ€å°åŒ–ï¼Ÿï¼ˆISPï¼‰
- âœ… é«˜å±‚æ¨¡å—æ˜¯å¦ä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°ï¼Ÿï¼ˆDIPï¼‰
- âœ… ä»£ç æ˜¯å¦è¶³å¤Ÿç®€å•ç›´æ¥ï¼Ÿï¼ˆKISSï¼‰
- âœ… æ˜¯å¦æœ‰é‡å¤ä»£ç å¯ä»¥æŠ½å–ï¼Ÿï¼ˆDRYï¼‰
- âœ… æ˜¯å¦å®ç°äº†å½“å‰ä¸éœ€è¦çš„åŠŸèƒ½ï¼Ÿï¼ˆYAGNIï¼‰
- âœ… æ˜¯å¦**é¿å…äº†è¿‡é•¿çš„è°ƒç”¨é“¾**ï¼Ÿï¼ˆLODï¼‰





### **è®¾è®¡æ¨¡å¼**

> æŒæ¡å‡ ç§å¸¸ç”¨æ¨¡å¼ å•ä¾‹/å·¥å‚/ä»£ç†/é€‚é…å™¨æ¨¡å¼....



<img src="å·¥ç¨‹ç´ å…»ç¯‡ï¼ˆä¸­çº§ï¼‰.assets/image-20251126194954367.png" alt="image-20251126194954367" style="zoom:50%;" />

#### 1. è®¾è®¡æ¨¡å¼å¯¹æ¯”ä¸é€‰æ‹©æŒ‡å—

##### 1.1 åˆ›å»ºå‹æ¨¡å¼å¯¹æ¯”

| æ¨¡å¼         | é€‚ç”¨åœºæ™¯         | ç‰¹ç‚¹               |
| :----------- | :--------------- | :----------------- |
| **å•ä¾‹**     | å…¨å±€å”¯ä¸€å®ä¾‹     | æ§åˆ¶å®ä¾‹æ•°é‡       |
| **å·¥å‚æ–¹æ³•** | ç±»åˆ›å»ºé€»è¾‘å¤æ‚   | å­ç±»å†³å®šåˆ›å»ºå¯¹è±¡   |
| **æŠ½è±¡å·¥å‚** | äº§å“æ—åˆ›å»º       | åˆ›å»ºç›¸å…³å¯¹è±¡å®¶æ—   |
| **å»ºé€ è€…**   | **å¤æ‚å¯¹è±¡åˆ›å»º** | åˆ†æ­¥æ„å»ºï¼Œçµæ´»é…ç½® |

##### 1.2 ç»“æ„å‹æ¨¡å¼å¯¹æ¯”

| æ¨¡å¼       | é€‚ç”¨åœºæ™¯     | ç‰¹ç‚¹               |
| :--------- | :----------- | :----------------- |
| **é€‚é…å™¨** | æ¥å£ä¸å…¼å®¹   | æ¥å£è½¬æ¢           |
| **ä»£ç†**   | è®¿é—®æ§åˆ¶     | é—´æ¥è®¿é—®ï¼Œå¢å¼ºåŠŸèƒ½ |
| **è£…é¥°å™¨** | åŠ¨æ€æ·»åŠ åŠŸèƒ½ | è¿è¡Œæ—¶æ‰©å±•         |
| **å¤–è§‚**   | ç®€åŒ–å¤æ‚ç³»ç»Ÿ | ç»Ÿä¸€æ¥å£           |

##### 1.3 è¡Œä¸ºå‹æ¨¡å¼å¯¹æ¯”

| æ¨¡å¼         | é€‚ç”¨åœºæ™¯     | ç‰¹ç‚¹               |
| :----------- | :----------- | :----------------- |
| **è§‚å¯Ÿè€…**   | ä¸€å¯¹å¤šä¾èµ–   | è‡ªåŠ¨é€šçŸ¥           |
| **ç­–ç•¥**     | ç®—æ³•æ›¿æ¢     | å°è£…ç®—æ³•ï¼Œçµæ´»åˆ‡æ¢ |
| **æ¨¡æ¿æ–¹æ³•** | ç®—æ³•æ¡†æ¶å›ºå®š | å®šä¹‰ç®—æ³•éª¨æ¶       |
| **è´£ä»»é“¾**   | è¯·æ±‚å¤„ç†é“¾   | å¤šä¸ªå¯¹è±¡å¤„ç†è¯·æ±‚   |



#### 2. å®é™…åº”ç”¨åœºæ™¯æ€»ç»“

##### 2.1 Springæ¡†æ¶ä¸­çš„è®¾è®¡æ¨¡å¼

- **å•ä¾‹æ¨¡å¼**ï¼šBeançš„é»˜è®¤ä½œç”¨åŸŸ
- **å·¥å‚æ¨¡å¼**ï¼šBeanFactory, ApplicationContext
- **ä»£ç†æ¨¡å¼**ï¼šAOPå®ç°ï¼Œäº‹åŠ¡ç®¡ç†
- **æ¨¡æ¿æ–¹æ³•**ï¼šJdbcTemplate, RestTemplate
- **è§‚å¯Ÿè€…æ¨¡å¼**ï¼šApplicationEventäº‹ä»¶æœºåˆ¶

##### 2.2 é€‰æ‹©åŸåˆ™

1. **è¯†åˆ«å˜åŒ–ç‚¹**ï¼šæ‰¾åˆ°ç³»ç»Ÿä¸­å˜åŒ–çš„éƒ¨åˆ†
2. **é¢å‘æ¥å£**ï¼šé’ˆå¯¹æ¥å£ç¼–ç¨‹ï¼Œè€Œä¸æ˜¯å®ç°
3. **ç»„åˆä¼˜äºç»§æ‰¿**ï¼šä¼˜å…ˆä½¿ç”¨å¯¹è±¡ç»„åˆ
4. **å¼€é—­åŸåˆ™**ï¼šå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­

### è®¾è®¡æ¨¡å¼--åˆ›å»ºå‹æ¨¡å¼

#### 1. å•ä¾‹æ¨¡å¼ (Singleton Pattern)

##### 1.1 æ ¸å¿ƒæ€æƒ³

ç¡®ä¿ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›å…¨å±€è®¿é—®ç‚¹

##### 1.2 å®ç°æ–¹å¼å¯¹æ¯”

###### é¥¿æ±‰å¼ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰

```java
public class EagerSingleton {
    // ç±»åŠ è½½æ—¶å³åˆ›å»ºå®ä¾‹
    private static final EagerSingleton instance = new EagerSingleton();
    
    // ç§æœ‰æ„é€ å™¨é˜²æ­¢å¤–éƒ¨å®ä¾‹åŒ–
    private EagerSingleton() {}
    
    public static EagerSingleton getInstance() {
        return instance;
    }
}
```

**ä¼˜ç‚¹**ï¼šç®€å•ã€çº¿ç¨‹å®‰å…¨

**ç¼ºç‚¹**ï¼šå¯èƒ½é€ æˆèµ„æºæµªè´¹ï¼ˆå¦‚æœå®ä¾‹æœªè¢«ä½¿ç”¨ï¼‰

###### æ‡’æ±‰å¼ï¼ˆåŒé‡æ£€æŸ¥é”ï¼‰

```java
public class LazySingleton {
    private static volatile LazySingleton instance;
    
    private LazySingleton() {}
    
    public static LazySingleton getInstance() {
        if (instance == null) { // ç¬¬ä¸€æ¬¡æ£€æŸ¥
            synchronized (LazySingleton.class) {
                if (instance == null) { // ç¬¬äºŒæ¬¡æ£€æŸ¥
                    instance = new LazySingleton();
                }
            }
        }
        return instance;
    }
}
```

**ä¼˜ç‚¹**ï¼šå»¶è¿ŸåŠ è½½ã€çº¿ç¨‹å®‰å…¨

**ç¼ºç‚¹**ï¼šå®ç°ç¨å¤æ‚

###### é™æ€å†…éƒ¨ç±»ï¼ˆæ¨èï¼‰

```java
public class StaticSingleton {
    private StaticSingleton() {}
    
    private static class SingletonHolder {
        private static final StaticSingleton instance = new StaticSingleton();
    }
    
    public static StaticSingleton getInstance() {
        return SingletonHolder.instance;
    }
}
```

**ä¼˜ç‚¹**ï¼šå»¶è¿ŸåŠ è½½ã€çº¿ç¨‹å®‰å…¨ã€å®ç°ç®€å•

###### æšä¸¾å•ä¾‹ï¼ˆæœ€ä½³å®è·µï¼‰

```java
public enum EnumSingleton {
    INSTANCE;
    
    public void doSomething() {
        System.out.println("Singleton operation");
    }
}

// ä½¿ç”¨
EnumSingleton.INSTANCE.doSomething();
```

**ä¼˜ç‚¹**ï¼šç»å¯¹é˜²æ­¢å¤šæ¬¡å®ä¾‹åŒ–ï¼Œè‡ªåŠ¨æ”¯æŒåºåˆ—åŒ–

##### 1.3 åº”ç”¨åœºæ™¯

- é…ç½®ç®¡ç†å™¨
- æ•°æ®åº“è¿æ¥æ± 
- æ—¥å¿—è®°å½•å™¨
- ç¼“å­˜ç®¡ç†å™¨

#### 2. å·¥å‚æ¨¡å¼ (Factory Pattern)

> å·¥å‚æ¨¡å¼æœ€å¤§çš„ä¼˜ç‚¹å°±æ˜¯ï¼š**è§£è€¦**ã€‚

##### 2.1 ç®€å•å·¥å‚æ¨¡å¼

ç®€å•å·¥å‚åŒ…å«å¦‚ä¸‹è§’è‰²ï¼š

* æŠ½è±¡äº§å“ ï¼šå®šä¹‰äº†äº§å“çš„è§„èŒƒï¼Œæè¿°äº†äº§å“çš„ä¸»è¦ç‰¹æ€§å’ŒåŠŸèƒ½ã€‚
* å…·ä½“äº§å“ ï¼šå®ç°æˆ–è€…ç»§æ‰¿æŠ½è±¡äº§å“çš„å­ç±»
* å…·ä½“å·¥å‚ ï¼šæä¾›äº†åˆ›å»ºäº§å“çš„æ–¹æ³•ï¼Œè°ƒç”¨è€…é€šè¿‡è¯¥æ–¹æ³•æ¥è·å–äº§å“ã€‚

```java
// äº§å“æ¥å£
interface Shape {
    void draw();
}

// å…·ä½“äº§å“
class Circle implements Shape {
    public void draw() { System.out.println("ç»˜åˆ¶åœ†å½¢"); }
}

class Rectangle implements Shape {
    public void draw() { System.out.println("ç»˜åˆ¶çŸ©å½¢"); }
}

// ç®€å•å·¥å‚
class ShapeFactory {
    public static Shape createShape(String type) {
        switch (type.toLowerCase()) {
            case "circle": return new Circle();
            case "rectangle": return new Rectangle();
            default: throw new IllegalArgumentException("æœªçŸ¥å½¢çŠ¶ç±»å‹");
        }
    }
}

// ä½¿ç”¨
Shape circle = ShapeFactory.createShape("circle");
circle.draw();
```

ä¸€ä¸ªå·¥å‚ç±»æ ¹æ®å‚æ•°åˆ›å»ºä¸åŒäº§å“ï¼›

==ã€‹å·¥å‚ä½œä¸º**ç»Ÿä¸€å…¥å£**ï¼Œcreateä¸åŒtypeçš„äº§å“



**ä¼˜ç‚¹ï¼š**

å°è£…äº†åˆ›å»ºå¯¹è±¡çš„è¿‡ç¨‹ï¼Œå¯ä»¥é€šè¿‡å‚æ•°ç›´æ¥è·å–å¯¹è±¡ã€‚æŠŠå¯¹è±¡çš„åˆ›å»ºå’Œä¸šåŠ¡é€»è¾‘å±‚åˆ†å¼€ï¼Œè¿™æ ·ä»¥åå°±é¿å…äº†ä¿®æ”¹å®¢æˆ·ä»£ç ï¼Œå¦‚æœè¦å®ç°æ–°äº§å“ç›´æ¥ä¿®æ”¹å·¥å‚ç±»ï¼Œè€Œä¸éœ€è¦åœ¨åŸä»£ç ä¸­ä¿®æ”¹ï¼Œè¿™æ ·å°±é™ä½äº†å®¢æˆ·ä»£ç ä¿®æ”¹çš„å¯èƒ½æ€§ï¼Œæ›´åŠ å®¹æ˜“æ‰©å±•ã€‚

**ç¼ºç‚¹ï¼š**

å¢åŠ æ–°äº§å“æ—¶è¿˜æ˜¯éœ€è¦ä¿®æ”¹å·¥å‚ç±»çš„ä»£ç ï¼Œè¿èƒŒäº†â€œå¼€é—­åŸåˆ™â€ã€‚



##### 2.2 å·¥å‚æ–¹æ³•æ¨¡å¼

> å®šä¹‰ä¸€ä¸ªç”¨äºåˆ›å»ºå¯¹è±¡çš„æ¥å£ï¼Œè®©å­ç±»å†³å®šå®ä¾‹åŒ–å“ªä¸ªäº§å“ç±»å¯¹è±¡ã€‚
>
> å·¥å‚æ–¹æ³•ä½¿ä¸€ä¸ªäº§å“ç±»çš„å®ä¾‹åŒ–å»¶è¿Ÿåˆ°å…¶å·¥å‚çš„å­ç±»ã€‚
>
> æ¯ä¸ªäº§å“å¯¹åº”ä¸€ä¸ªå·¥å‚å­ç±»ï¼Œç”±å­ç±»å†³å®šåˆ›å»ºå…·ä½“äº§å“ã€‚



å·¥å‚æ–¹æ³•æ¨¡å¼çš„ä¸»è¦è§’è‰²ï¼š

* æŠ½è±¡å·¥å‚ï¼ˆAbstract Factoryï¼‰ï¼šæä¾›äº†åˆ›å»ºäº§å“çš„æ¥å£ï¼Œè°ƒç”¨è€…é€šè¿‡å®ƒè®¿é—®å…·ä½“å·¥å‚çš„å·¥å‚æ–¹æ³•æ¥åˆ›å»ºäº§å“ã€‚
* å…·ä½“å·¥å‚ï¼ˆConcreteFactoryï¼‰ï¼šä¸»è¦æ˜¯å®ç°æŠ½è±¡å·¥å‚ä¸­çš„æŠ½è±¡æ–¹æ³•ï¼Œå®Œæˆå…·ä½“äº§å“çš„åˆ›å»ºã€‚
* æŠ½è±¡äº§å“ï¼ˆProductï¼‰ï¼šå®šä¹‰äº†äº§å“çš„è§„èŒƒï¼Œæè¿°äº†äº§å“çš„ä¸»è¦ç‰¹æ€§å’ŒåŠŸèƒ½ã€‚
* å…·ä½“äº§å“ï¼ˆConcreteProductï¼‰ï¼šå®ç°äº†æŠ½è±¡äº§å“è§’è‰²æ‰€å®šä¹‰çš„æ¥å£ï¼Œç”±å…·ä½“å·¥å‚æ¥åˆ›å»ºï¼Œå®ƒåŒå…·ä½“å·¥å‚ä¹‹é—´ä¸€ä¸€å¯¹åº”ã€‚

```java
// 1. æŠ½è±¡åˆ›å»ºè€… - å®šä¹‰å·¥å‚æ–¹æ³•
abstract class ButtonFactory {
    // è¿™å°±æ˜¯"å·¥å‚æ–¹æ³•" - æŠ½è±¡æ–¹æ³•ï¼Œç”±å­ç±»å®ç°
    public abstract Button createButton();
    
    // å¯ä»¥æœ‰é»˜è®¤å®ç°ï¼ˆæ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼‰
    public void renderButton() {
        Button button = createButton();
        button.render();
    }
}

// 2. å…·ä½“åˆ›å»ºè€… - å®ç°å·¥å‚æ–¹æ³•
class WindowsButtonFactory extends ButtonFactory {
    public Button createButton() {
        return new WindowsButton();  // åˆ›å»ºWindowsé£æ ¼æŒ‰é’®
    }
}

class MacButtonFactory extends ButtonFactory {
    public Button createButton() {
        return new MacButton();  // åˆ›å»ºMacé£æ ¼æŒ‰é’®
    }
}

// åº”ç”¨ç±» - é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥å·¥å‚
class Application {
    private Button button;
    
    public Application(ButtonFactory factory) {
        button = factory.createButton();  // é€šè¿‡å·¥å‚åˆ›å»ºäº§å“
    }
    
    public void render() {
        button.render();
    }
}

// ä½¿ç”¨ç¤ºä¾‹
public class SimpleFactoryMethodExample {
    public static void main(String[] args) {
        // æ ¹æ®é…ç½®é€‰æ‹©å·¥å‚
        ButtonFactory factory;
        if (System.getProperty("os.name").toLowerCase().contains("win")) {
            factory = new WindowsButtonFactory();
        } else {
            factory = new MacButtonFactory();
        }
        
        // é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥å·¥å‚
        Application app = new Application(factory);
        app.render();  // è¾“å‡º: "Windowsé£æ ¼æŒ‰é’®" æˆ– "Macé£æ ¼æŒ‰é’®"
    }
}
```

==ã€‹å°†åˆ›å»ºè€…ä¹ŸæŠ½è±¡å‡ºæ¥ï¼Œå…·ä½“åˆ›å»ºè€…ä¸­å®ç°ä¸åŒçš„å·¥å‚æ–¹æ³•è·å–ä¸åŒçš„å…·ä½“äº§å“ã€‚

**å·¥å‚æ–¹æ³•æ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³**æ˜¯ï¼š**å°†å¯¹è±¡çš„åˆ›å»ºå»¶è¿Ÿåˆ°å­ç±»ï¼Œè®©å­ç±»å†³å®šå®ä¾‹åŒ–å“ªä¸ªå…·ä½“ç±»**ã€‚

**"ä¸è¦ç›´æ¥newå¯¹è±¡ï¼Œè®©å­ç±»å‘Šè¯‰æˆ‘è¦åˆ›å»ºä»€ä¹ˆ"**



**ä¼˜ç‚¹ï¼š**

- ç”¨æˆ·åªéœ€è¦çŸ¥é“å…·ä½“å·¥å‚çš„åç§°å°±å¯å¾—åˆ°æ‰€è¦çš„äº§å“ï¼Œæ— é¡»çŸ¥é“äº§å“çš„å…·ä½“åˆ›å»ºè¿‡ç¨‹ï¼›
- åœ¨ç³»ç»Ÿå¢åŠ æ–°çš„äº§å“æ—¶åªéœ€è¦æ·»åŠ å…·ä½“äº§å“ç±»å’Œå¯¹åº”çš„å…·ä½“å·¥å‚ç±»ï¼Œæ— é¡»å¯¹åŸå·¥å‚è¿›è¡Œä»»ä½•ä¿®æ”¹ï¼Œæ»¡è¶³å¼€é—­åŸåˆ™ï¼›

**ç¼ºç‚¹ï¼š**

* æ¯å¢åŠ ä¸€ä¸ªäº§å“å°±è¦å¢åŠ ä¸€ä¸ªå…·ä½“äº§å“ç±»å’Œä¸€ä¸ªå¯¹åº”çš„å…·ä½“å·¥å‚ç±»ï¼Œè¿™å¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚åº¦ã€‚



##### 2.3 æŠ½è±¡å·¥å‚æ¨¡å¼

> æ˜¯ä¸€ç§ä¸ºè®¿é—®ç±»æä¾›ä¸€ä¸ªåˆ›å»ºä¸€ç»„ç›¸å…³æˆ–ç›¸äº’ä¾èµ–å¯¹è±¡çš„æ¥å£ï¼Œä¸”è®¿é—®ç±»æ— é¡»æŒ‡å®šæ‰€è¦äº§å“çš„å…·ä½“ç±»å°±èƒ½å¾—åˆ°åŒæ—çš„ä¸åŒç­‰çº§çš„äº§å“çš„æ¨¡å¼ç»“æ„ã€‚
>
> **æŠ½è±¡å·¥å‚æ¨¡å¼æ˜¯å·¥å‚æ–¹æ³•æ¨¡å¼çš„å‡çº§ç‰ˆæœ¬ï¼Œå·¥å‚æ–¹æ³•æ¨¡å¼åªç”Ÿäº§ä¸€ä¸ªç­‰çº§çš„äº§å“ï¼Œè€ŒæŠ½è±¡å·¥å‚æ¨¡å¼å¯ç”Ÿäº§å¤šä¸ªç­‰çº§çš„äº§å“**ã€‚



```java
// æŠ½è±¡å·¥å‚(åŒ…å«å¤šç§äº§å“)
interface GUIFactory {
    Button createButton();
    Checkbox createCheckbox();
}

// å…·ä½“å·¥å‚
class WindowsFactory implements GUIFactory {
    public Button createButton() { return new WindowsButton(); }
    public Checkbox createCheckbox() { return new WindowsCheckbox(); }
}

class MacFactory implements GUIFactory {
    public Button createButton() { return new MacButton(); }
    public Checkbox createCheckbox() { return new MacCheckbox(); }
}

// å®¢æˆ·ç«¯ä»£ç 
class Application {
    private Button button;
    private Checkbox checkbox;
    
    public Application(GUIFactory factory) {
        button = factory.createButton();
        checkbox = factory.createCheckbox();
    }
    
    public void paint() {
        button.render();
        checkbox.render();
    }
}
```

==ã€‹æŠ½è±¡å·¥å‚ï¼šåŒ…å«å¤šç§äº§å“ï¼Œ**æ˜¯å¯¹äº§å“æ—åˆ›å»ºå…³ç³»çš„æŠ½è±¡çº¦æŸ**



###### **æ ¸å¿ƒå·®å¼‚ï¼šçº¦æŸçš„ç»´åº¦**

**å·¥å‚æ–¹æ³•çš„çº¦æŸæ˜¯"çºµå‘"çš„**

```
ChineseChef   â†’ StirFriedDish (ä¸­å¼ç‚’èœ)
ItalianChef   â†’ BakedDish (æ„å¼çƒ¤èœ)
FrenchChef    â†’ StewedDish (æ³•å¼ç‚–èœ)

çº¦æŸï¼šæ¯ä¸ªå¨å¸ˆä¸ç‰¹å®šåšæ³•ç»‘å®š
```

**æŠ½è±¡å·¥å‚çš„çº¦æŸæ˜¯"æ¨ªå‘"çš„**

```
ChineseRestaurant â†’ [KungPaoChicken + HotSourSoup + MoonCake]
ItalianRestaurant â†’ [Pizza + Minestrone + Tiramisu]  
FrenchRestaurant  â†’ [Steak + OnionSoup + CremeBrulee]

çº¦æŸï¼šé¤å…å†…æ‰€æœ‰èœå“é£æ ¼å¿…é¡»ä¸€è‡´ï¼
```



**ä¼˜ç‚¹ï¼š**

å½“ä¸€ä¸ªäº§å“æ—ä¸­çš„å¤šä¸ªå¯¹è±¡è¢«è®¾è®¡æˆä¸€èµ·å·¥ä½œæ—¶ï¼Œå®ƒèƒ½ä¿è¯å®¢æˆ·ç«¯å§‹ç»ˆåªä½¿ç”¨åŒä¸€ä¸ªäº§å“æ—ä¸­çš„å¯¹è±¡ã€‚

**ç¼ºç‚¹ï¼š**

å½“äº§å“æ—ä¸­éœ€è¦å¢åŠ ä¸€ä¸ªæ–°çš„äº§å“æ—¶ï¼Œæ‰€æœ‰çš„å·¥å‚ç±»éƒ½éœ€è¦è¿›è¡Œä¿®æ”¹ã€‚



#### 3.åŸå‹æ¨¡å¼ï¼ˆprototypeï¼‰

> ç”¨ä¸€ä¸ªå·²ç»åˆ›å»ºçš„å®ä¾‹ä½œä¸ºåŸå‹ï¼Œé€šè¿‡å¤åˆ¶è¯¥åŸå‹å¯¹è±¡æ¥åˆ›å»ºä¸€ä¸ªå’ŒåŸå‹å¯¹è±¡ç›¸åŒçš„**æ–°å¯¹è±¡**ã€‚

åŸå‹æ¨¡å¼åŒ…å«å¦‚ä¸‹è§’è‰²ï¼š

* æŠ½è±¡åŸå‹ç±»ï¼šè§„å®šäº†å…·ä½“åŸå‹å¯¹è±¡å¿…é¡»å®ç°çš„çš„ clone() æ–¹æ³•ã€‚
* å…·ä½“åŸå‹ç±»ï¼šå®ç°æŠ½è±¡åŸå‹ç±»çš„ clone() æ–¹æ³•ï¼Œå®ƒæ˜¯å¯è¢«å¤åˆ¶çš„å¯¹è±¡ã€‚
* è®¿é—®ç±»ï¼šä½¿ç”¨å…·ä½“åŸå‹ç±»ä¸­çš„ clone() æ–¹æ³•æ¥å¤åˆ¶æ–°çš„å¯¹è±¡ã€‚

```java
// æŠ½è±¡åŸå‹ç±» Cloneable 

//å…·ä½“åŸå‹ç±» å¥–çŠ¶ç±»
public class Citation implements Cloneable {
    private String name;

    public void setName(String name) {
        this.name = name;
    }

    public String getName() {
        return (this.name);
    }

    public void show() {
        System.out.println(name + "åŒå­¦ï¼šåœ¨2020å­¦å¹´ç¬¬ä¸€å­¦æœŸä¸­è¡¨ç°ä¼˜ç§€ï¼Œè¢«è¯„ä¸ºä¸‰å¥½å­¦ç”Ÿã€‚ç‰¹å‘æ­¤çŠ¶ï¼");
    }

    @Override
    public Citation clone() throws CloneNotSupportedException {
        return (Citation) super.clone();
    }
}

//æµ‹è¯•è®¿é—®ç±»
public class CitationTest {
    public static void main(String[] args) throws CloneNotSupportedException {
        Citation c1 = new Citation();
        c1.setName("å¼ ä¸‰");

        //å¤åˆ¶å¥–çŠ¶
        Citation c2 = c1.clone();
        //å°†å¥–çŠ¶çš„åå­—ä¿®æ”¹æå››
        c2.setName("æå››");

        c1.show();
        c2.show();
    }
}
```



#### 4.å»ºé€ è€…æ¨¡å¼ï¼ˆBuilderï¼‰

> å°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºä¸è¡¨ç¤ºåˆ†ç¦»ï¼Œä½¿å¾—åŒæ ·çš„æ„å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„è¡¨ç¤ºã€‚
>
> åˆ†ç¦»äº†éƒ¨ä»¶çš„æ„é€ (ç”±Builderæ¥è´Ÿè´£)å’Œè£…é…(ç”±**Director**è´Ÿè´£)ã€‚ ä»è€Œå¯ä»¥æ„é€ å‡ºå¤æ‚çš„å¯¹è±¡ã€‚**è¿™ä¸ªæ¨¡å¼é€‚ç”¨äºï¼šæŸä¸ªå¯¹è±¡çš„æ„å»ºè¿‡ç¨‹å¤æ‚çš„æƒ…å†µ**ã€‚
>
> å®ç°äº†æ„å»ºå’Œè£…é…çš„è§£è€¦

å»ºé€ è€…ï¼ˆBuilderï¼‰æ¨¡å¼åŒ…å«å¦‚ä¸‹è§’è‰²ï¼š

* æŠ½è±¡å»ºé€ è€…ç±»ï¼ˆBuilderï¼‰ï¼šè¿™ä¸ªæ¥å£è§„å®šè¦å®ç°å¤æ‚å¯¹è±¡çš„é‚£äº›éƒ¨åˆ†çš„åˆ›å»ºï¼Œå¹¶ä¸æ¶‰åŠå…·ä½“çš„éƒ¨ä»¶å¯¹è±¡çš„åˆ›å»ºã€‚ 

* å…·ä½“å»ºé€ è€…ç±»ï¼ˆConcreteBuilderï¼‰ï¼šå®ç° Builder æ¥å£ï¼Œå®Œæˆå¤æ‚äº§å“çš„å„ä¸ªéƒ¨ä»¶çš„å…·ä½“åˆ›å»ºæ–¹æ³•ã€‚åœ¨æ„é€ è¿‡ç¨‹å®Œæˆåï¼Œæä¾›äº§å“çš„å®ä¾‹ã€‚ 

* äº§å“ç±»ï¼ˆProductï¼‰ï¼šè¦åˆ›å»ºçš„å¤æ‚å¯¹è±¡ã€‚

* æŒ‡æŒ¥è€…ç±»ï¼ˆDirectorï¼‰ï¼šè°ƒç”¨å…·ä½“å»ºé€ è€…æ¥åˆ›å»ºå¤æ‚å¯¹è±¡çš„å„ä¸ªéƒ¨åˆ†ï¼Œåœ¨æŒ‡å¯¼è€…ä¸­ä¸æ¶‰åŠå…·ä½“äº§å“çš„ä¿¡æ¯ï¼Œåªè´Ÿè´£ä¿è¯å¯¹è±¡å„éƒ¨åˆ†å®Œæ•´åˆ›å»ºæˆ–æŒ‰æŸç§é¡ºåºåˆ›å»ºã€‚ 

```java
//è‡ªè¡Œè½¦ç±»
public class Bike {
    private String frame;
    private String seat;

    public String getFrame() {
        return frame;
    }

    public void setFrame(String frame) {
        this.frame = frame;
    }

    public String getSeat() {
        return seat;
    }

    public void setSeat(String seat) {
        this.seat = seat;
    }
}

// æŠ½è±¡ builder ç±»
public abstract class Builder {

    protected Bike mBike = new Bike();

    public abstract void buildFrame();
    public abstract void buildSeat();
    public abstract Bike createBike();
}

//æ‘©æ‹œå•è½¦Builderç±»
public class MobikeBuilder extends Builder {

    @Override
    public void buildFrame() {
        mBike.setFrame("é“åˆé‡‘è½¦æ¶");
    }

    @Override
    public void buildSeat() {
        mBike.setSeat("çœŸçš®è½¦åº§");
    }

    @Override
    public Bike createBike() {
        return mBike;
    }
}

//ofoå•è½¦Builderç±»
public class OfoBuilder extends Builder {

    @Override
    public void buildFrame() {
        mBike.setFrame("ç¢³çº¤ç»´è½¦æ¶");
    }

    @Override
    public void buildSeat() {
        mBike.setSeat("æ©¡èƒ¶è½¦åº§");
    }

    @Override
    public Bike createBike() {
        return mBike;
    }
}

//æŒ‡æŒ¥è€…ç±»
public class Director {
    private Builder mBuilder;

    public Director(Builder builder) {
        mBuilder = builder;
    }

    public Bike construct() {
        mBuilder.buildFrame();
        mBuilder.buildSeat();
        return mBuilder.createBike();
    }
}

//æµ‹è¯•ç±»
public class Client {
    public static void main(String[] args) {
        showBike(new OfoBuilder());
        showBike(new MobikeBuilder());
    }
    private static void showBike(Builder builder) {
        Director director = new Director(builder);
        Bike bike = director.construct();
        System.out.println(bike.getFrame());
        System.out.println(bike.getSeat());
    }
}
```



##### æ¨¡å¼æ‰©å±•

é“¾å¼è°ƒç”¨å¯ä»¥çœ‹åšæ˜¯ä¸€ç§ç®€åŒ–çš„å»ºé€ è€…æ¨¡å¼ï¼š

åœ¨å¼€å‘ä¸­è¿˜æœ‰ä¸€ä¸ªå¸¸ç”¨çš„ä½¿ç”¨æ–¹å¼ï¼Œå°±æ˜¯å½“ä¸€ä¸ªç±»æ„é€ å™¨éœ€è¦ä¼ å…¥å¾ˆå¤šå‚æ•°æ—¶ï¼Œå¦‚æœåˆ›å»ºè¿™ä¸ªç±»çš„å®ä¾‹ï¼Œä»£ç å¯è¯»æ€§ä¼šéå¸¸å·®ï¼Œè€Œä¸”å¾ˆå®¹æ˜“å¼•å…¥é”™è¯¯ï¼Œ**æ­¤æ—¶å°±å¯ä»¥åˆ©ç”¨å»ºé€ è€…æ¨¡å¼è¿›è¡Œé‡æ„**ã€‚

é‡æ„å‰ä»£ç å¦‚ä¸‹ï¼š

```java
public class Phone {
    private String cpu;
    private String screen;
    private String memory;
    private String mainboard;

    public Phone(String cpu, String screen, String memory, String mainboard) {
        this.cpu = cpu;
        this.screen = screen;
        this.memory = memory;
        this.mainboard = mainboard;
    }

    public String getCpu() {
        return cpu;
    }

    public void setCpu(String cpu) {
        this.cpu = cpu;
    }

    public String getScreen() {
        return screen;
    }

    public void setScreen(String screen) {
        this.screen = screen;
    }

    public String getMemory() {
        return memory;
    }

    public void setMemory(String memory) {
        this.memory = memory;
    }

    public String getMainboard() {
        return mainboard;
    }

    public void setMainboard(String mainboard) {
        this.mainboard = mainboard;
    }

    @Override
    public String toString() {
        return "Phone{" +
                "cpu='" + cpu + '\'' +
                ", screen='" + screen + '\'' +
                ", memory='" + memory + '\'' +
                ", mainboard='" + mainboard + '\'' +
                '}';
    }
}

public class Client {
    public static void main(String[] args) {
        //æ„å»ºPhoneå¯¹è±¡
        Phone phone = new Phone("intel","ä¸‰æ˜Ÿå±å¹•","é‡‘å£«é¡¿","åç¡•");
        System.out.println(phone);
    }
}
```

ä¸Šé¢åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­æ„å»ºPhoneå¯¹è±¡ï¼Œä¼ é€’äº†å››ä¸ªå‚æ•°ï¼Œå¦‚æœå‚æ•°æ›´å¤šå‘¢ï¼Ÿä»£ç çš„å¯è¯»æ€§åŠä½¿ç”¨çš„æˆæœ¬å°±æ˜¯æ¯”è¾ƒé«˜ã€‚

é‡æ„åä»£ç ï¼š

```java
public class Phone {

    private String cpu;
    private String screen;
    private String memory;
    private String mainboard;

    private Phone(Builder builder) {
        cpu = builder.cpu;
        screen = builder.screen;
        memory = builder.memory;
        mainboard = builder.mainboard;
    }

    public static final class Builder {
        private String cpu;
        private String screen;
        private String memory;
        private String mainboard;

        public Builder() {}

        public Builder cpu(String val) {
            cpu = val;
            return this;
        }
        public Builder screen(String val) {
            screen = val;
            return this;
        }
        public Builder memory(String val) {
            memory = val;
            return this;
        }
        public Builder mainboard(String val) {
            mainboard = val;
            return this;
        }
        public Phone build() {
            return new Phone(this);}
    }
    @Override
    public String toString() {
        return "Phone{" +
                "cpu='" + cpu + '\'' +
                ", screen='" + screen + '\'' +
                ", memory='" + memory + '\'' +
                ", mainboard='" + mainboard + '\'' +
                '}';
    }
}

public class Client {
    public static void main(String[] args) {
        Phone phone = new Phone.Builder()
                .cpu("intel")
                .mainboard("åç¡•")
                .memory("é‡‘å£«é¡¿")
                .screen("ä¸‰æ˜Ÿ")
                .build();
        System.out.println(phone);
    }
}
```

é‡æ„åçš„ä»£ç åœ¨ä½¿ç”¨èµ·æ¥æ›´æ–¹ä¾¿ï¼ŒæŸç§ç¨‹åº¦ä¸Šä¹Ÿå¯ä»¥æé«˜å¼€å‘æ•ˆç‡ã€‚ä»è½¯ä»¶è®¾è®¡ä¸Šï¼Œå¯¹ç¨‹åºå‘˜çš„è¦æ±‚æ¯”è¾ƒé«˜ã€‚





### è®¾è®¡æ¨¡å¼--ç»“æ„å‹æ¨¡å¼



#### 1. ä»£ç†æ¨¡å¼ (Proxy Pattern)

> å±äºç»“æ„å‹æ¨¡å¼

##### 0 ä»£ç†æ¨¡å¼æ ¸å¿ƒæ€æƒ³

###### **1.1 æ ¸å¿ƒæ¦‚å¿µ**

**ä»£ç†æ¨¡å¼**ï¼šä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§**ä»£ç†**ä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚

**æ ¸å¿ƒæ€æƒ³**ï¼š**"é€šè¿‡ä¸€ä¸ªä»£ç†å¯¹è±¡æ¥æ§åˆ¶å¯¹åŸå§‹å¯¹è±¡çš„è®¿é—®"**

###### **1.2 ä¸‰å¤§è§’è‰²**

```java
// 1. æŠ½è±¡ä¸»é¢˜ (Subject) - å®šä¹‰çœŸå®å¯¹è±¡å’Œä»£ç†å¯¹è±¡çš„å…±åŒæ¥å£
interface Subject {
    void request();
}

// 2. çœŸå®ä¸»é¢˜ (Real Subject) - å®é™…æ‰§è¡Œä¸šåŠ¡é€»è¾‘çš„å¯¹è±¡
class RealSubject implements Subject {
    public void request() {
        System.out.println("çœŸå®ä¸»é¢˜å¤„ç†è¯·æ±‚");
    }
}

// 3. ä»£ç† (Proxy) - æ§åˆ¶å¯¹çœŸå®ä¸»é¢˜çš„è®¿é—®
class Proxy implements Subject {
    private RealSubject realSubject;
    
    public void request() {
        if (realSubject == null) {
            realSubject = new RealSubject(); // å»¶è¿ŸåŠ è½½
        }
        preRequest();    // å‰ç½®å¤„ç†
        realSubject.request(); // å§”æ‰˜ç»™çœŸå®å¯¹è±¡
        postRequest();   // åç½®å¤„ç†
    }
    
    private void preRequest() {
        System.out.println("ä»£ç†å‰ç½®å¤„ç†");
    }
    
    private void postRequest() {
        System.out.println("ä»£ç†åç½®å¤„ç†");
    }
}
```



##### 1 é™æ€ä»£ç†

```java
// ä¸»é¢˜æ¥å£
interface Image {
    void display();
}

// çœŸå®ä¸»é¢˜ - é‡é‡çº§å¯¹è±¡ï¼Œåˆ›å»ºæˆæœ¬é«˜
class RealImage implements Image {
    private String filename;
    
    public RealImage(String filename) {
        this.filename = filename;
        loadFromDisk(); // æ„é€ å‡½æ•°ä¸­ç«‹å³åŠ è½½ï¼Œå¯èƒ½å¾ˆæ…¢
    }
    
    private void loadFromDisk() {
        System.out.println("ä»ç£ç›˜åŠ è½½å›¾ç‰‡: " + filename + " (è€—æ—¶æ“ä½œ)");
    }
    
    public void display() {
        System.out.println("æ˜¾ç¤ºå›¾ç‰‡: " + filename);
    }
}

// ä»£ç†ç±» - æ§åˆ¶è®¿é—®ï¼Œå®ç°å»¶è¿ŸåŠ è½½
class ImageProxy implements Image {
    private RealImage realImage; // å¯¹çœŸå®å¯¹è±¡çš„å¼•ç”¨
    private String filename;
    
    public ImageProxy(String filename) {
        this.filename = filename;
        // æ³¨æ„ï¼šè¿™é‡Œä¸åˆ›å»ºRealImageï¼Œå®ç°å»¶è¿ŸåŠ è½½
    }
    
    public void display() {
        // å»¶è¿ŸåŠ è½½ï¼šåªæœ‰çœŸæ­£éœ€è¦æ—¶æ‰åˆ›å»ºçœŸå®å¯¹è±¡
        if (realImage == null) {
            realImage = new RealImage(filename);
        }
        realImage.display(); // å§”æ‰˜ç»™çœŸå®å¯¹è±¡
    }
}

// ä½¿ç”¨
Image image = new ImageProxy("test.jpg");
// å›¾ç‰‡å°šæœªåŠ è½½
image.display(); // æ­¤æ—¶æ‰çœŸæ­£åŠ è½½å›¾ç‰‡
```



ç¤ºä¾‹2ï¼šå–ç¥¨

```java
//å–ç¥¨æ¥å£
public interface SellTickets {
    void sell();
}

//ç«è½¦ç«™  ç«è½¦ç«™å…·æœ‰å–ç¥¨åŠŸèƒ½ï¼Œæ‰€ä»¥éœ€è¦å®ç°SellTicketsæ¥å£
public class TrainStation implements SellTickets {

    public void sell() {
        System.out.println("ç«è½¦ç«™å–ç¥¨");
    }
}

//ä»£å”®ç‚¹
public class ProxyPoint implements SellTickets {

    private TrainStation station = new TrainStation();

    public void sell() {
        System.out.println("ä»£ç†ç‚¹æ”¶å–ä¸€äº›æœåŠ¡è´¹ç”¨");
        station.sell();
    }
}

//æµ‹è¯•ç±»
public class Client {
    public static void main(String[] args) {
        ProxyPoint pp = new ProxyPoint();
        pp.sell();
    }
}
```



##### 2 åŠ¨æ€ä»£ç†ï¼ˆJDKï¼‰

Javaä¸­æä¾›äº†ä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»Proxyï¼ŒProxyå¹¶ä¸æ˜¯æˆ‘ä»¬ä¸Šè¿°æ‰€è¯´çš„ä»£ç†å¯¹è±¡çš„ç±»ï¼Œè€Œæ˜¯æä¾›äº†ä¸€ä¸ªåˆ›å»ºä»£ç†å¯¹è±¡çš„é™æ€æ–¹æ³•ï¼ˆnewProxyInstanceæ–¹æ³•ï¼‰æ¥è·å–ä»£ç†å¯¹è±¡ã€‚

```java
//å–ç¥¨æ¥å£
public interface SellTickets {
    void sell();
}

//ç«è½¦ç«™  ç«è½¦ç«™å…·æœ‰å–ç¥¨åŠŸèƒ½ï¼Œæ‰€ä»¥éœ€è¦å®ç°SellTicketsæ¥å£
public class TrainStation implements SellTickets {

    public void sell() {
        System.out.println("ç«è½¦ç«™å–ç¥¨");
    }
}

//ä»£ç†å·¥å‚ï¼Œç”¨æ¥åˆ›å»ºä»£ç†å¯¹è±¡
public class ProxyFactory {

    private TrainStation station = new TrainStation();

    public SellTickets getProxyObject() {
        //ä½¿ç”¨Proxyè·å–ä»£ç†å¯¹è±¡
        /*
            newProxyInstance()æ–¹æ³•å‚æ•°è¯´æ˜ï¼š
                ClassLoader loader ï¼š ç±»åŠ è½½å™¨ï¼Œç”¨äºåŠ è½½ä»£ç†ç±»ï¼Œä½¿ç”¨çœŸå®å¯¹è±¡çš„ç±»åŠ è½½å™¨å³å¯
                Class<?>[] interfaces ï¼š çœŸå®å¯¹è±¡æ‰€å®ç°çš„æ¥å£ï¼Œä»£ç†æ¨¡å¼çœŸå®å¯¹è±¡å’Œä»£ç†å¯¹è±¡å®ç°ç›¸åŒçš„æ¥å£
                InvocationHandler h ï¼š ä»£ç†å¯¹è±¡çš„è°ƒç”¨å¤„ç†ç¨‹åº
         */
        SellTickets sellTickets = (SellTickets) Proxy.newProxyInstance(station.getClass().getClassLoader(),
                station.getClass().getInterfaces(),
                new InvocationHandler() {
                    /*
                        InvocationHandlerä¸­invokeæ–¹æ³•å‚æ•°è¯´æ˜ï¼š
                            proxy ï¼š ä»£ç†å¯¹è±¡
                            method ï¼š å¯¹åº”äºåœ¨ä»£ç†å¯¹è±¡ä¸Šè°ƒç”¨çš„æ¥å£æ–¹æ³•çš„ Method å®ä¾‹
                            args ï¼š ä»£ç†å¯¹è±¡è°ƒç”¨æ¥å£æ–¹æ³•æ—¶ä¼ é€’çš„å®é™…å‚æ•°
                     */
                    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {

                        System.out.println("ä»£ç†ç‚¹æ”¶å–ä¸€äº›æœåŠ¡è´¹ç”¨(JDKåŠ¨æ€ä»£ç†æ–¹å¼)");
                        //æ‰§è¡ŒçœŸå®å¯¹è±¡
                        Object result = method.invoke(station, args);
                        return result;
                    }
                });
        return sellTickets;
    }
}

//æµ‹è¯•ç±»
public class Client {
    public static void main(String[] args) {
        //è·å–ä»£ç†å¯¹è±¡
        ProxyFactory factory = new ProxyFactory();
        
        SellTickets proxyObject = factory.getProxyObject();
        proxyObject.sell();
    }
}
```

**1. æ ¸å¿ƒåŒºåˆ«å¯¹æ¯”è¡¨**

| ç‰¹æ€§           | é™æ€ä»£ç†                 | åŠ¨æ€ä»£ç†                   |
| :------------- | :----------------------- | :------------------------- |
| **åˆ›å»ºæ—¶æœº**   | ç¼–è¯‘æœŸ                   | è¿è¡ŒæœŸ                     |
| **ä»£ç†ç±»æ¥æº** | æ‰‹åŠ¨ç¼–å†™                 | è‡ªåŠ¨ç”Ÿæˆ                   |
| **çµæ´»æ€§**     | ä½ï¼ˆæ¯ä¸ªç±»éœ€å•ç‹¬ä»£ç†ï¼‰   | é«˜ï¼ˆé€šç”¨ä»£ç†å¤„ç†å¤šä¸ªç±»ï¼‰   |
| **ä»£ç é‡**     | å¤šï¼ˆéœ€è¦ä¸ºæ¯ä¸ªç±»å†™ä»£ç†ï¼‰ | å°‘ï¼ˆä¸€ä¸ªå¤„ç†å™¨ä»£ç†å¤šä¸ªç±»ï¼‰ |
| **ç»´æŠ¤æ€§**     | å·®ï¼ˆä¿®æ”¹éœ€é‡æ–°ç¼–è¯‘ï¼‰     | å¥½ï¼ˆé…ç½®å³ä¿®æ”¹ï¼‰           |
| **æ€§èƒ½**       | ç¨å¥½ï¼ˆç›´æ¥è°ƒç”¨ï¼‰         | ç¨å·®ï¼ˆåå°„è°ƒç”¨ï¼‰           |

#### 2. è£…é¥°å™¨æ¨¡å¼ (Decorator Pattern)

> æŒ‡åœ¨ä¸æ”¹å˜ç°æœ‰å¯¹è±¡ç»“æ„çš„æƒ…å†µä¸‹ï¼ŒåŠ¨æ€åœ°ç»™è¯¥å¯¹è±¡å¢åŠ ä¸€äº›èŒè´£ï¼ˆå³å¢åŠ å…¶é¢å¤–åŠŸèƒ½ï¼‰çš„æ¨¡å¼ã€‚

è£…é¥°ï¼ˆDecoratorï¼‰æ¨¡å¼ä¸­çš„è§’è‰²ï¼š

* æŠ½è±¡æ„ä»¶ï¼ˆComponentï¼‰è§’è‰² ï¼šå®šä¹‰ä¸€ä¸ªæŠ½è±¡æ¥å£ä»¥è§„èŒƒå‡†å¤‡æ¥æ”¶é™„åŠ è´£ä»»çš„å¯¹è±¡ã€‚
* å…·ä½“æ„ä»¶ï¼ˆConcrete  Componentï¼‰è§’è‰² ï¼šå®ç°æŠ½è±¡æ„ä»¶ï¼Œé€šè¿‡è£…é¥°è§’è‰²ä¸ºå…¶æ·»åŠ ä¸€äº›èŒè´£ã€‚
* æŠ½è±¡è£…é¥°ï¼ˆDecoratorï¼‰è§’è‰² ï¼š ç»§æ‰¿æˆ–å®ç°æŠ½è±¡æ„ä»¶ï¼Œå¹¶åŒ…å«å…·ä½“æ„ä»¶çš„å®ä¾‹ï¼ˆèšåˆï¼‰ï¼Œå¯ä»¥é€šè¿‡å…¶å­ç±»æ‰©å±•å…·ä½“æ„ä»¶çš„åŠŸèƒ½ã€‚
* å…·ä½“è£…é¥°ï¼ˆConcreteDecoratorï¼‰è§’è‰² ï¼šå®ç°æŠ½è±¡è£…é¥°çš„ç›¸å…³æ–¹æ³•ï¼Œå¹¶ç»™å…·ä½“æ„ä»¶å¯¹è±¡æ·»åŠ é™„åŠ çš„è´£ä»»ã€‚

![image-20211102201027579](å·¥ç¨‹ç´ å…»ç¯‡ï¼ˆä¸­çº§ï¼‰.assets/image-20211102201027579.png)

##### 2.1 ç»å…¸å®ç°

```go
// ç»„ä»¶æ¥å£
interface Coffee {
    String getDescription();
    double cost();
}

// å…·ä½“ç»„ä»¶
class SimpleCoffee implements Coffee {
    public String getDescription() { return "ç®€å•å’–å•¡"; }
    public double cost() { return 5.0; }
}

// è£…é¥°å™¨æŠ½è±¡ç±»
abstract class CoffeeDecorator implements Coffee {
    protected Coffee decoratedCoffee;
    
    public CoffeeDecorator(Coffee coffee) {
        this.decoratedCoffee = coffee;
    }
    
    public String getDescription() {
        return decoratedCoffee.getDescription();
    }
    
    public double cost() {
        return decoratedCoffee.cost();
    }
}

// å…·ä½“è£…é¥°å™¨
class MilkDecorator extends CoffeeDecorator {
    public MilkDecorator(Coffee coffee) {
        super(coffee);
    }
    
    public String getDescription() {
        return decoratedCoffee.getDescription() + ", ç‰›å¥¶";
    }
    
    public double cost() {
        return decoratedCoffee.cost() + 2.0;
    }
}

class SugarDecorator extends CoffeeDecorator {
    public SugarDecorator(Coffee coffee) {
        super(coffee);
    }
    
    public String getDescription() {
        return decoratedCoffee.getDescription() + ", ç³–";
    }
    
    public double cost() {
        return decoratedCoffee.cost() + 1.0;
    }
}

// ä½¿ç”¨
Coffee coffee = new SimpleCoffee();
coffee = new MilkDecorator(coffee);
coffee = new SugarDecorator(coffee);

System.out.println(coffee.getDescription() + " ï¿¥" + coffee.cost());
// è¾“å‡º: ç®€å•å’–å•¡, ç‰›å¥¶, ç³– ï¿¥8.0
```



##### 2.2 ä½¿ç”¨åœºæ™¯

* å½“ä¸èƒ½é‡‡ç”¨ç»§æ‰¿çš„æ–¹å¼å¯¹ç³»ç»Ÿè¿›è¡Œæ‰©å……æˆ–è€…é‡‡ç”¨ç»§æ‰¿ä¸åˆ©äºç³»ç»Ÿæ‰©å±•å’Œç»´æŠ¤æ—¶ã€‚

  ä¸èƒ½é‡‡ç”¨ç»§æ‰¿çš„æƒ…å†µä¸»è¦æœ‰ä¸¤ç±»ï¼š

  * ç¬¬ä¸€ç±»æ˜¯ç³»ç»Ÿä¸­å­˜åœ¨å¤§é‡ç‹¬ç«‹çš„æ‰©å±•ï¼Œä¸ºæ”¯æŒæ¯ä¸€ç§ç»„åˆå°†äº§ç”Ÿå¤§é‡çš„å­ç±»ï¼Œä½¿å¾—å­ç±»æ•°ç›®å‘ˆçˆ†ç‚¸æ€§å¢é•¿ï¼›
  * ç¬¬äºŒç±»æ˜¯å› ä¸ºç±»å®šä¹‰ä¸èƒ½ç»§æ‰¿ï¼ˆå¦‚finalç±»ï¼‰

* åœ¨ä¸å½±å“å…¶ä»–å¯¹è±¡çš„æƒ…å†µä¸‹ï¼Œä»¥åŠ¨æ€ã€é€æ˜çš„æ–¹å¼ç»™å•ä¸ªå¯¹è±¡æ·»åŠ èŒè´£ã€‚

* å½“å¯¹è±¡çš„åŠŸèƒ½è¦æ±‚å¯ä»¥åŠ¨æ€åœ°æ·»åŠ ï¼Œä¹Ÿå¯ä»¥å†åŠ¨æ€åœ°æ’¤é”€æ—¶ã€‚



IOæµä¸­çš„åŒ…è£…ç±»ä½¿ç”¨åˆ°äº†è£…é¥°è€…æ¨¡å¼ã€‚BufferedInputStreamï¼ŒBufferedOutputStreamï¼ŒBufferedReaderï¼ŒBufferedWriterã€‚

æˆ‘ä»¬ä»¥BufferedWriterä¸¾ä¾‹æ¥è¯´æ˜ï¼Œå…ˆçœ‹çœ‹å¦‚ä½•ä½¿ç”¨BufferedWriter

```java
public class Demo {
    public static void main(String[] args) throws Exception{
        //åˆ›å»ºBufferedWriterå¯¹è±¡
        //åˆ›å»ºFileWriterå¯¹è±¡
        FileWriter fw = new FileWriter("C:\\Users\\Think\\Desktop\\a.txt");
        BufferedWriter bw = new BufferedWriter(fw);

        //å†™æ•°æ®
        bw.write("hello Buffered");

        bw.close();
    }
}
```



##### 2.3 ä»£ç†å’Œè£…é¥°è€…çš„åŒºåˆ«

é™æ€ä»£ç†å’Œè£…é¥°è€…æ¨¡å¼çš„åŒºåˆ«ï¼š

* ç›¸åŒç‚¹ï¼š
  * éƒ½è¦å®ç°ä¸ç›®æ ‡ç±»ç›¸åŒçš„ä¸šåŠ¡æ¥å£
  * åœ¨ä¸¤ä¸ªç±»ä¸­éƒ½è¦å£°æ˜ç›®æ ‡å¯¹è±¡
  * éƒ½å¯ä»¥åœ¨ä¸ä¿®æ”¹ç›®æ ‡ç±»çš„å‰æä¸‹å¢å¼ºç›®æ ‡æ–¹æ³•
* ä¸åŒç‚¹ï¼š
  * ç›®çš„ä¸åŒ
    è£…é¥°è€…æ˜¯ä¸ºäº†å¢å¼ºç›®æ ‡å¯¹è±¡
    **é™æ€ä»£ç†æ˜¯ä¸ºäº†ä¿æŠ¤å’Œéšè—ç›®æ ‡å¯¹è±¡**
  * è·å–ç›®æ ‡å¯¹è±¡æ„å»ºçš„åœ°æ–¹ä¸åŒ
    è£…é¥°è€…æ˜¯ç”±å¤–ç•Œä¼ é€’è¿›æ¥ï¼Œå¯ä»¥é€šè¿‡æ„é€ æ–¹æ³•ä¼ é€’
    é™æ€ä»£ç†æ˜¯åœ¨ä»£ç†ç±»å†…éƒ¨åˆ›å»ºï¼Œä»¥æ­¤æ¥éšè—ç›®æ ‡å¯¹è±¡





#### 3. é€‚é…å™¨æ¨¡å¼ (Adapter Pattern)

> è¢«é€‚é…è€…-- é€‚é…å™¨--ç›®æ ‡æ¥å£

é€‚é…å™¨æ¨¡å¼ï¼ˆAdapterï¼‰åŒ…å«ä»¥ä¸‹ä¸»è¦è§’è‰²ï¼š

* ç›®æ ‡ï¼ˆTargetï¼‰æ¥å£ï¼šå½“å‰ç³»ç»Ÿä¸šåŠ¡æ‰€æœŸå¾…çš„æ¥å£ï¼Œå®ƒå¯ä»¥æ˜¯æŠ½è±¡ç±»æˆ–æ¥å£ã€‚
* é€‚é…è€…ï¼ˆAdapteeï¼‰ç±»ï¼šå®ƒæ˜¯è¢«è®¿é—®å’Œé€‚é…çš„ç°å­˜ç»„ä»¶åº“ä¸­çš„ç»„ä»¶æ¥å£ã€‚
* é€‚é…å™¨ï¼ˆAdapterï¼‰ç±»ï¼šå®ƒæ˜¯ä¸€ä¸ªè½¬æ¢å™¨ï¼Œé€šè¿‡ç»§æ‰¿æˆ–å¼•ç”¨é€‚é…è€…çš„å¯¹è±¡ï¼ŒæŠŠé€‚é…è€…æ¥å£è½¬æ¢æˆç›®æ ‡æ¥å£ï¼Œè®©å®¢æˆ·æŒ‰ç›®æ ‡æ¥å£çš„æ ¼å¼è®¿é—®é€‚é…è€…ã€‚



##### 3.1 ç±»é€‚é…å™¨ï¼ˆç»§æ‰¿ è¢«é€‚é…è€…ï¼‰

```java
// ç›®æ ‡æ¥å£
interface MediaPlayer {
    void play(String audioType, String fileName);
}

// è¢«é€‚é…è€…
class AdvancedMediaPlayer {
    void playVlc(String fileName) {
        System.out.println("æ’­æ”¾vlcæ–‡ä»¶: " + fileName);
    }
    
    void playMp4(String fileName) {
        System.out.println("æ’­æ”¾mp4æ–‡ä»¶: " + fileName);
    }
}

// é€‚é…å™¨
class MediaAdapter extends AdvancedMediaPlayer implements MediaPlayer {
    public void play(String audioType, String fileName) {
        if (audioType.equalsIgnoreCase("vlc")) {
            playVlc(fileName);
        } else if (audioType.equalsIgnoreCase("mp4")) {
            playMp4(fileName);
        }
    }
}
```

##### 3.2 å¯¹è±¡é€‚é…å™¨ï¼ˆç»„åˆè¢«é€‚é…è€…ï¼‰

```java
class MediaAdapter implements MediaPlayer {
    private AdvancedMediaPlayer advancedMusicPlayer;
    
    public MediaAdapter(String audioType) {
        if (audioType.equalsIgnoreCase("vlc")) {
            advancedMusicPlayer = new VlcPlayer();
        } else if (audioType.equalsIgnoreCase("mp4")) {
            advancedMusicPlayer = new Mp4Player();
        }
    }
    
    public void play(String audioType, String fileName) {
        if (audioType.equalsIgnoreCase("vlc")) {
            advancedMusicPlayer.playVlc(fileName);
        } else if (audioType.equalsIgnoreCase("mp4")) {
            advancedMusicPlayer.playMp4(fileName);
        }
    }
```



##### 3.3 åº”ç”¨åœºæ™¯

* ä»¥å‰å¼€å‘çš„ç³»ç»Ÿå­˜åœ¨æ»¡è¶³æ–°ç³»ç»ŸåŠŸèƒ½éœ€æ±‚çš„ç±»ï¼Œä½†å…¶æ¥å£åŒæ–°ç³»ç»Ÿçš„æ¥å£ä¸ä¸€è‡´ã€‚
* ä½¿ç”¨ç¬¬ä¸‰æ–¹æä¾›çš„ç»„ä»¶ï¼Œä½†ç»„ä»¶æ¥å£å®šä¹‰å’Œè‡ªå·±è¦æ±‚çš„æ¥å£å®šä¹‰ä¸åŒã€‚



InputStreamReaderåšäº†InputStreamå­—èŠ‚æµç±»åˆ°Readerå­—ç¬¦æµä¹‹é—´çš„è½¬æ¢ï¼š

```java
// å°†å­—èŠ‚æµé€‚é…ä¸ºå­—ç¬¦æµ
public class IoAdapterExample {
    public static void main(String[] args) throws IOException {
        // å­—èŠ‚æµ
        FileInputStream fis = new FileInputStream("file.txt");
        
        // é€‚é…å™¨ï¼šå­—èŠ‚æµ â†’ å­—ç¬¦æµ
        InputStreamReader reader = new InputStreamReader(fis, "UTF-8");
        
        // ç°åœ¨å¯ä»¥æŒ‰å­—ç¬¦æ–¹å¼è¯»å–
        BufferedReader br = new BufferedReader(reader);
        String line = br.readLine();
        
        br.close();
    }
}
```

InputStreamReaderç»§æ‰¿è‡ªjava.ioåŒ…ä¸­çš„**Reader**(æŠ½è±¡ç±»ï¼‰ï¼Œå¦‚ï¼š

```java
// InputStreamReader æºç ç‰‡æ®µ ï¼ˆå¯¹è±¡é€‚é…å™¨ï¼‰
public class InputStreamReader extends Reader {
    private final StreamDecoder sd;
    
    public InputStreamReader(InputStream in) {
        super(in);
        try {
            sd = StreamDecoder.forInputStreamReader(in, this, (String)null);
        } catch (UnsupportedEncodingException e) {
            throw new Error(e);
        }
    }
    
    // é€‚é…ï¼šå°†Readerçš„readæ–¹æ³•é€‚é…åˆ°InputStream
    public int read() throws IOException {
        return sd.read();
    }
}
```



#### 4.æ¡¥æ¥æ¨¡å¼ï¼ˆBridgeï¼‰

> å°†æŠ½è±¡ä¸å®ç°åˆ†ç¦»ï¼Œä½¿å®ƒä»¬å¯ä»¥ç‹¬ç«‹å˜åŒ–ã€‚å®ƒæ˜¯ç”¨ç»„åˆå…³ç³»ä»£æ›¿ç»§æ‰¿å…³ç³»æ¥å®ç°ï¼Œä»è€Œé™ä½äº†æŠ½è±¡å’Œå®ç°è¿™ä¸¤ä¸ªå¯å˜ç»´åº¦çš„è€¦åˆåº¦ã€‚



##### æ¦‚è¿°

æ¡¥æ¥ï¼ˆBridgeï¼‰æ¨¡å¼åŒ…å«ä»¥ä¸‹ä¸»è¦è§’è‰²ï¼š

* æŠ½è±¡åŒ–ï¼ˆAbstractionï¼‰è§’è‰² ï¼šå®šä¹‰æŠ½è±¡ç±»ï¼Œå¹¶åŒ…å«ä¸€ä¸ªå¯¹å®ç°åŒ–å¯¹è±¡çš„å¼•ç”¨ã€‚
* æ‰©å±•æŠ½è±¡åŒ–ï¼ˆRefined  Abstractionï¼‰è§’è‰² ï¼šæ˜¯æŠ½è±¡åŒ–è§’è‰²çš„å­ç±»ï¼Œå®ç°çˆ¶ç±»ä¸­çš„ä¸šåŠ¡æ–¹æ³•ï¼Œå¹¶é€šè¿‡ç»„åˆå…³ç³»è°ƒç”¨å®ç°åŒ–è§’è‰²ä¸­çš„ä¸šåŠ¡æ–¹æ³•ã€‚
* å®ç°åŒ–ï¼ˆImplementorï¼‰è§’è‰² ï¼šå®šä¹‰å®ç°åŒ–è§’è‰²çš„æ¥å£ï¼Œä¾›æ‰©å±•æŠ½è±¡åŒ–è§’è‰²è°ƒç”¨ã€‚
* å…·ä½“å®ç°åŒ–ï¼ˆConcrete Implementorï¼‰è§’è‰² ï¼šç»™å‡ºå®ç°åŒ–è§’è‰²æ¥å£çš„å…·ä½“å®ç°ã€‚

ç°åœ¨æœ‰ä¸€ä¸ªéœ€æ±‚ï¼Œéœ€è¦åˆ›å»ºä¸åŒçš„å›¾å½¢ï¼Œå¹¶ä¸”æ¯ä¸ªå›¾å½¢éƒ½æœ‰å¯èƒ½ä¼šæœ‰ä¸åŒçš„é¢œè‰²ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ç»§æ‰¿çš„æ–¹å¼æ¥è®¾è®¡ç±»çš„å…³ç³»ï¼š

![](å·¥ç¨‹ç´ å…»ç¯‡ï¼ˆä¸­çº§ï¼‰.assets/image-20200207194617620-1635745601766.png)

æˆ‘ä»¬å¯ä»¥å‘ç°æœ‰å¾ˆå¤šçš„ç±»ï¼Œå‡å¦‚æˆ‘ä»¬å†å¢åŠ ä¸€ä¸ªå½¢çŠ¶æˆ–å†å¢åŠ ä¸€ç§é¢œè‰²ï¼Œå°±éœ€è¦åˆ›å»ºæ›´å¤šçš„ç±»ã€‚

è¯•æƒ³ï¼Œåœ¨ä¸€ä¸ªæœ‰å¤šç§å¯èƒ½ä¼šå˜åŒ–çš„ç»´åº¦çš„ç³»ç»Ÿä¸­ï¼Œç”¨ç»§æ‰¿æ–¹å¼ä¼šé€ æˆç±»çˆ†ç‚¸ï¼Œæ‰©å±•èµ·æ¥ä¸çµæ´»ã€‚æ¯æ¬¡åœ¨ä¸€ä¸ªç»´åº¦ä¸Šæ–°å¢ä¸€ä¸ªå…·ä½“å®ç°éƒ½è¦å¢åŠ å¤šä¸ªå­ç±»ã€‚ä¸ºäº†æ›´åŠ çµæ´»çš„è®¾è®¡ç³»ç»Ÿï¼Œæˆ‘ä»¬æ­¤æ—¶å¯ä»¥è€ƒè™‘ä½¿ç”¨æ¡¥æ¥æ¨¡å¼ã€‚==ã€‹é˜²æ­¢ç±»çˆ†ç‚¸

| æ–¹å¼     | ç±»æ•°é‡     | æ‰©å±•æ€§ | ç»´æŠ¤æ€§       |
| :------- | :--------- | :----- | :----------- |
| **ç»§æ‰¿** | ä¹˜ç§¯çº§å¢é•¿ | å·®     | å·®ï¼ˆç±»çˆ†ç‚¸ï¼‰ |
| **æ¡¥æ¥** | åŠ æ³•çº§å¢é•¿ | å¥½     | å¥½           |



##### ç¤ºä¾‹

ã€ä¾‹ã€‘è§†é¢‘æ’­æ”¾å™¨

éœ€è¦å¼€å‘ä¸€ä¸ª**è·¨å¹³å°è§†é¢‘æ’­æ”¾å™¨**ï¼Œå¯ä»¥åœ¨ä¸åŒæ“ä½œç³»ç»Ÿå¹³å°ï¼ˆå¦‚Windowsã€Macã€Linuxç­‰ï¼‰ä¸Šæ’­æ”¾å¤šç§æ ¼å¼çš„è§†é¢‘æ–‡ä»¶ï¼Œå¸¸è§çš„è§†é¢‘æ ¼å¼åŒ…æ‹¬RMVBã€AVIã€WMVç­‰ã€‚è¯¥æ’­æ”¾å™¨åŒ…å«äº†ä¸¤ä¸ªç»´åº¦ï¼Œé€‚åˆä½¿ç”¨æ¡¥æ¥æ¨¡å¼ã€‚

![image-20251127174538475](å·¥ç¨‹ç´ å…»ç¯‡ï¼ˆä¸­çº§ï¼‰.assets/image-20251127174538475.png)

ä»£ç å¦‚ä¸‹ï¼š

```java
//è§†é¢‘æ–‡ä»¶
public interface VideoFile {
    void decode(String fileName);
}

//aviæ–‡ä»¶
public class AVIFile implements VideoFile {
    public void decode(String fileName) {
        System.out.println("aviè§†é¢‘æ–‡ä»¶ï¼š"+ fileName);
    }
}

//rmvbæ–‡ä»¶
public class REVBBFile implements VideoFile {

    public void decode(String fileName) {
        System.out.println("rmvbæ–‡ä»¶ï¼š" + fileName);
    }
}

//æ“ä½œç³»ç»Ÿç‰ˆæœ¬
public abstract class OperatingSystem {

    protected VideoFile videoFile;

    public OperatingSystem(VideoFile videoFile) {
        this.videoFile = videoFile;
    }

    public abstract void play(String fileName);
}

//Windowsç‰ˆæœ¬
public class Windows extends OperatingSystem {

    public Windows(VideoFile videoFile) {
        super(videoFile);
    }

    public void play(String fileName) {
        videoFile.decode(fileName);
    }
}

//macç‰ˆæœ¬
public class Mac extends OperatingSystem {

    public Mac(VideoFile videoFile) {
        super(videoFile);
    }

    public void play(String fileName) {
		videoFile.decode(fileName);
    }
}

//æµ‹è¯•ç±»
public class Client {
    public static void main(String[] args) {
        OperatingSystem os = new Windows(new AVIFile());
        os.play("æˆ˜ç‹¼3");
    }
}
```

**å¥½å¤„ï¼š**

* æ¡¥æ¥æ¨¡å¼æé«˜äº†ç³»ç»Ÿçš„å¯æ‰©å……æ€§ï¼Œåœ¨ä¸¤ä¸ªå˜åŒ–ç»´åº¦ä¸­ä»»æ„æ‰©å±•ä¸€ä¸ªç»´åº¦ï¼Œéƒ½ä¸éœ€è¦ä¿®æ”¹åŸæœ‰ç³»ç»Ÿã€‚

  å¦‚ï¼šå¦‚æœç°åœ¨è¿˜æœ‰ä¸€ç§è§†é¢‘æ–‡ä»¶ç±»å‹wmvï¼Œæˆ‘ä»¬åªéœ€è¦å†å®šä¹‰ä¸€ä¸ªç±»å®ç°VideoFileæ¥å£å³å¯ï¼Œå…¶ä»–ç±»ä¸éœ€è¦å‘ç”Ÿå˜åŒ–ã€‚

* å®ç°ç»†èŠ‚å¯¹å®¢æˆ·é€æ˜ï¼ˆä¿å¯†ï¼‰



##### goç¤ºä¾‹ï¼šæ—¥å¿—è¾“å‡º

```go
package main

import "fmt"

// Implementor: æ—¥å¿—è¾“å‡ºæ¥å£
type LogOutput interface {
    Output(level, message string)
}

// ConcreteImplementor: æ–‡ä»¶è¾“å‡º
type FileOutput struct {
    filename string
}

func (f *FileOutput) Output(level, message string) {
    fmt.Printf("å†™å…¥æ–‡ä»¶[%s]: %s - %s\n", f.filename, level, message)
}

// ConcreteImplementor: æ§åˆ¶å°è¾“å‡º
type ConsoleOutput struct{}

func (c *ConsoleOutput) Output(level, message string) {
    fmt.Printf("æ§åˆ¶å°è¾“å‡º: %s - %s\n", level, message)
}

// ConcreteImplementor: ç½‘ç»œè¾“å‡º
type NetworkOutput struct {
    endpoint string
}

func (n *NetworkOutput) Output(level, message string) {
    fmt.Printf("å‘é€åˆ°[%s]: %s - %s\n", n.endpoint, level, message)
}

// Abstraction: æ—¥å¿—è®°å½•å™¨æŠ½è±¡
type Logger interface {
    Debug(message string)
    Info(message string)
    Error(message string)
}

// RefinedAbstraction: å…·ä½“æ—¥å¿—è®°å½•å™¨
type SimpleLogger struct {
    output LogOutput
}

func NewSimpleLogger(output LogOutput) *SimpleLogger {
    return &SimpleLogger{output: output}
}

func (s *SimpleLogger) Debug(message string) {
    s.output.Output("DEBUG", message)
}

func (s *SimpleLogger) Info(message string) {
    s.output.Output("INFO", message)
}

func (s *SimpleLogger) Error(message string) {
    s.output.Output("ERROR", message)
}

// ä½¿ç”¨æ¡¥æ¥æ¨¡å¼
func main() {
    // åˆ›å»ºä¸åŒçš„è¾“å‡ºå®ç°
    fileOutput := &FileOutput{filename: "app.log"}
    consoleOutput := &ConsoleOutput{}
    networkOutput := &NetworkOutput{endpoint: "logserver:514"}
    
    // ç›¸åŒçš„æ—¥å¿—æ¥å£ï¼Œä¸åŒçš„è¾“å‡ºå®ç°
    loggers := []Logger{
        NewSimpleLogger(fileOutput),
        NewSimpleLogger(consoleOutput),
        NewSimpleLogger(networkOutput),
    }
    
    // ç»Ÿä¸€ä½¿ç”¨
    for i, logger := range loggers {
        logger.Info(fmt.Sprintf("æ—¥å¿—å™¨ %d æµ‹è¯•æ¶ˆæ¯", i))
    }
    
    // åŠ¨æ€åˆ‡æ¢è¾“å‡ºç›®æ ‡
    logger := NewSimpleLogger(consoleOutput)
    logger.Info("åˆå§‹ä½¿ç”¨æ§åˆ¶å°")
    
    // è¿è¡Œæ—¶åˆ‡æ¢ä¸ºæ–‡ä»¶è¾“å‡º
    logger = NewSimpleLogger(fileOutput)
    logger.Info("ç°åœ¨è¾“å‡ºåˆ°æ–‡ä»¶")
}
```



#### 5.å¤–è§‚æ¨¡å¼ï¼ˆFacadeï¼‰

> åˆåé—¨é¢æ¨¡å¼ï¼Œæ˜¯ä¸€ç§é€šè¿‡ä¸ºå¤šä¸ªå¤æ‚çš„å­ç³»ç»Ÿæä¾›ä¸€ä¸ªä¸€è‡´çš„æ¥å£ï¼Œè€Œä½¿è¿™äº›å­ç³»ç»Ÿæ›´åŠ å®¹æ˜“è¢«è®¿é—®çš„æ¨¡å¼ã€‚

![image-20251127195831333](å·¥ç¨‹ç´ å…»ç¯‡ï¼ˆä¸­çº§ï¼‰.assets/image-20251127195831333.png)

å¤–è§‚ï¼ˆFacadeï¼‰æ¨¡å¼åŒ…å«ä»¥ä¸‹ä¸»è¦è§’è‰²ï¼š

* å¤–è§‚ï¼ˆFacadeï¼‰è§’è‰²ï¼šä¸ºå¤šä¸ªå­ç³»ç»Ÿå¯¹å¤–æä¾›ä¸€ä¸ªå…±åŒçš„æ¥å£ã€‚
* å­ç³»ç»Ÿï¼ˆSub Systemï¼‰è§’è‰²ï¼šå®ç°ç³»ç»Ÿçš„éƒ¨åˆ†åŠŸèƒ½ï¼Œå®¢æˆ·å¯ä»¥é€šè¿‡å¤–è§‚è§’è‰²è®¿é—®å®ƒã€‚

ã€ä¾‹ã€‘æ™ºèƒ½å®¶ç”µæ§åˆ¶

å°æ˜çš„çˆ·çˆ·å·²ç»60å²äº†ï¼Œä¸€ä¸ªäººåœ¨å®¶ç”Ÿæ´»ï¼šæ¯æ¬¡éƒ½éœ€è¦æ‰“å¼€ç¯ã€æ‰“å¼€ç”µè§†ã€æ‰“å¼€ç©ºè°ƒï¼›ç¡è§‰æ—¶å…³é—­ç¯ã€å…³é—­ç”µè§†ã€å…³é—­ç©ºè°ƒï¼›æ“ä½œèµ·æ¥éƒ½æ¯”è¾ƒéº»çƒ¦ã€‚æ‰€ä»¥å°æ˜ç»™çˆ·çˆ·ä¹°äº†æ™ºèƒ½éŸ³ç®±ï¼Œå¯ä»¥é€šè¿‡è¯­éŸ³ç›´æ¥æ§åˆ¶è¿™äº›æ™ºèƒ½å®¶ç”µçš„å¼€å¯å’Œå…³é—­ã€‚

![image-20251127200205194](å·¥ç¨‹ç´ å…»ç¯‡ï¼ˆä¸­çº§ï¼‰.assets/image-20251127200205194.png)

ä»£ç å¦‚ä¸‹ï¼š

```java
//ç¯ç±»
public class Light {
    public void on() {
        System.out.println("æ‰“å¼€äº†ç¯....");
    }

    public void off() {
        System.out.println("å…³é—­äº†ç¯....");
    }
}

//ç”µè§†ç±»
public class TV {
    public void on() {
        System.out.println("æ‰“å¼€äº†ç”µè§†....");
    }

    public void off() {
        System.out.println("å…³é—­äº†ç”µè§†....");
    }
}

//æ§åˆ¶ç±»
public class AirCondition {
    public void on() {
        System.out.println("æ‰“å¼€äº†ç©ºè°ƒ....");
    }

    public void off() {
        System.out.println("å…³é—­äº†ç©ºè°ƒ....");
    }
}

//æ™ºèƒ½éŸ³ç®±
public class SmartAppliancesFacade {

    private Light light;
    private TV tv;
    private AirCondition airCondition;

    public SmartAppliancesFacade() {
        light = new Light();
        tv = new TV();
        airCondition = new AirCondition();
    }

    public void say(String message) {
        if(message.contains("æ‰“å¼€")) {
            on();
        } else if(message.contains("å…³é—­")) {
            off();
        } else {
            System.out.println("æˆ‘è¿˜å¬ä¸æ‡‚ä½ è¯´çš„ï¼ï¼ï¼");
        }
    }

    //èµ·åºŠåä¸€é”®å¼€ç”µå™¨
    private void on() {
        System.out.println("èµ·åºŠäº†");
        light.on();
        tv.on();
        airCondition.on();
    }

    //ç¡è§‰ä¸€é”®å…³ç”µå™¨
    private void off() {
        System.out.println("ç¡è§‰äº†");
        light.off();
        tv.off();
        airCondition.off();
    }
}

//æµ‹è¯•ç±»
public class Client {
    public static void main(String[] args) {
        //åˆ›å»ºå¤–è§‚å¯¹è±¡
        SmartAppliancesFacade facade = new SmartAppliancesFacade();
        //å®¢æˆ·ç«¯ç›´æ¥ä¸å¤–è§‚å¯¹è±¡è¿›è¡Œäº¤äº’
        facade.say("æ‰“å¼€å®¶ç”µ");
        facade.say("å…³é—­å®¶ç”µ");
    }
}
```

- æ¶ˆæ¯ä¸­é—´ä»¶ä¹Ÿæ˜¯å¤–è§‚æ¨¡å¼

**å¥½å¤„ï¼š**

* é™ä½äº†å­ç³»ç»Ÿä¸å®¢æˆ·ç«¯ä¹‹é—´çš„è€¦åˆåº¦ï¼Œä½¿å¾—å­ç³»ç»Ÿçš„å˜åŒ–ä¸ä¼šå½±å“è°ƒç”¨å®ƒçš„å®¢æˆ·ç±»ã€‚
* å¯¹å®¢æˆ·å±è”½äº†å­ç³»ç»Ÿç»„ä»¶ï¼Œå‡å°‘äº†å®¢æˆ·å¤„ç†çš„å¯¹è±¡æ•°ç›®ï¼Œå¹¶ä½¿å¾—å­ç³»ç»Ÿä½¿ç”¨èµ·æ¥æ›´åŠ å®¹æ˜“ã€‚

**ç¼ºç‚¹ï¼š**

* ä¸ç¬¦åˆå¼€é—­åŸåˆ™ï¼Œä¿®æ”¹å¾ˆéº»çƒ¦



#### 6.ç»„åˆæ¨¡å¼

> åˆåéƒ¨åˆ†æ•´ä½“æ¨¡å¼ï¼Œæ˜¯ç”¨äºæŠŠä¸€ç»„ç›¸ä¼¼çš„å¯¹è±¡å½“ä½œä¸€ä¸ªå•ä¸€çš„å¯¹è±¡ã€‚
>
> ç»„åˆæ¨¡å¼ä¾æ®æ ‘å½¢ç»“æ„æ¥ç»„åˆå¯¹è±¡ï¼Œç”¨æ¥è¡¨ç¤ºéƒ¨åˆ†ä»¥åŠæ•´ä½“å±‚æ¬¡ã€‚

ç»„åˆæ¨¡å¼ä¸»è¦åŒ…å«ä¸‰ç§è§’è‰²ï¼š

* æŠ½è±¡æ ¹èŠ‚ç‚¹ï¼ˆComponentï¼‰ï¼šå®šä¹‰ç³»ç»Ÿå„å±‚æ¬¡å¯¹è±¡çš„å…±æœ‰æ–¹æ³•å’Œå±æ€§ï¼Œå¯ä»¥é¢„å…ˆå®šä¹‰ä¸€äº›é»˜è®¤è¡Œä¸ºå’Œå±æ€§ã€‚
* æ ‘æèŠ‚ç‚¹ï¼ˆCompositeï¼‰ï¼šå®šä¹‰æ ‘æèŠ‚ç‚¹çš„è¡Œä¸ºï¼Œå­˜å‚¨å­èŠ‚ç‚¹ï¼Œç»„åˆæ ‘æèŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹å½¢æˆä¸€ä¸ªæ ‘å½¢ç»“æ„ã€‚
* å¶å­èŠ‚ç‚¹ï¼ˆLeafï¼‰ï¼šå¶å­èŠ‚ç‚¹å¯¹è±¡ï¼Œå…¶ä¸‹å†æ— åˆ†æ”¯ï¼Œæ˜¯ç³»ç»Ÿå±‚æ¬¡éå†çš„æœ€å°å•ä½ã€‚



è¦å®ç°è¯¥æ¡ˆä¾‹ï¼Œæˆ‘ä»¬å…ˆç”»å‡ºç±»å›¾ï¼š

<img src="å·¥ç¨‹ç´ å…»ç¯‡ï¼ˆä¸­çº§ï¼‰.assets/ç»„åˆæ¨¡å¼.png" style="zoom:80%;" />

å®ç°ï¼š

æ ‘æèŠ‚ç‚¹Menuå’Œå¶èŠ‚ç‚¹éƒ½ç»§æ‰¿è‡ªæŠ½è±¡æ ¹èŠ‚ç‚¹(MenuComponent),ç„¶åMenuèšåˆMenuComponent Listè¡¨ç¤ºä¸‹é¢è¿˜æœ‰åˆ†æ”¯ã€‚



#### 7.äº«å…ƒæ¨¡å¼

> è¿ç”¨å…±äº«æŠ€æœ¯æ¥æœ‰æ•ˆåœ°æ”¯æŒå¤§é‡ç»†ç²’åº¦å¯¹è±¡çš„å¤ç”¨ã€‚å®ƒé€šè¿‡å…±äº«å·²ç»å­˜åœ¨çš„å¯¹è±¡æ¥å¤§å¹…åº¦å‡å°‘éœ€è¦åˆ›å»ºçš„å¯¹è±¡æ•°é‡ã€é¿å…å¤§é‡ç›¸ä¼¼å¯¹è±¡çš„å¼€é”€ï¼Œä»è€Œæé«˜ç³»ç»Ÿèµ„æºçš„åˆ©ç”¨ç‡ã€‚

äº«å…ƒï¼ˆFlyweight ï¼‰æ¨¡å¼ä¸­å­˜åœ¨ä»¥ä¸‹ä¸¤ç§çŠ¶æ€ï¼š

1. å†…éƒ¨çŠ¶æ€ï¼Œå³ä¸ä¼šéšç€ç¯å¢ƒçš„æ”¹å˜è€Œæ”¹å˜çš„å¯å…±äº«éƒ¨åˆ†ã€‚
2. å¤–éƒ¨çŠ¶æ€ï¼ŒæŒ‡éšç¯å¢ƒæ”¹å˜è€Œæ”¹å˜çš„ä¸å¯ä»¥å…±äº«çš„éƒ¨åˆ†ã€‚äº«å…ƒæ¨¡å¼çš„å®ç°è¦é¢†å°±æ˜¯åŒºåˆ†åº”ç”¨ä¸­çš„è¿™ä¸¤ç§çŠ¶æ€ï¼Œå¹¶å°†å¤–éƒ¨çŠ¶æ€å¤–éƒ¨åŒ–ã€‚

äº«å…ƒæ¨¡å¼çš„ä¸»è¦æœ‰ä»¥ä¸‹è§’è‰²ï¼š

* æŠ½è±¡äº«å…ƒè§’è‰²ï¼ˆFlyweightï¼‰ï¼šé€šå¸¸æ˜¯ä¸€ä¸ªæ¥å£æˆ–æŠ½è±¡ç±»ï¼Œåœ¨æŠ½è±¡äº«å…ƒç±»ä¸­å£°æ˜äº†å…·ä½“äº«å…ƒç±»å…¬å…±çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å¯ä»¥å‘å¤–ç•Œæä¾›äº«å…ƒå¯¹è±¡çš„å†…éƒ¨æ•°æ®ï¼ˆå†…éƒ¨çŠ¶æ€ï¼‰ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥é€šè¿‡è¿™äº›æ–¹æ³•æ¥è®¾ç½®å¤–éƒ¨æ•°æ®ï¼ˆå¤–éƒ¨çŠ¶æ€ï¼‰ã€‚
* å…·ä½“äº«å…ƒï¼ˆConcrete Flyweightï¼‰è§’è‰² ï¼šå®ƒå®ç°äº†æŠ½è±¡äº«å…ƒç±»ï¼Œç§°ä¸ºäº«å…ƒå¯¹è±¡ï¼›åœ¨å…·ä½“äº«å…ƒç±»ä¸­ä¸ºå†…éƒ¨çŠ¶æ€æä¾›äº†å­˜å‚¨ç©ºé—´ã€‚é€šå¸¸æˆ‘ä»¬å¯ä»¥ç»“åˆå•ä¾‹æ¨¡å¼æ¥è®¾è®¡å…·ä½“äº«å…ƒç±»ï¼Œä¸ºæ¯ä¸€ä¸ªå…·ä½“äº«å…ƒç±»æä¾›å”¯ä¸€çš„äº«å…ƒå¯¹è±¡ã€‚
* éäº«å…ƒï¼ˆUnsharable Flyweight)è§’è‰² ï¼šå¹¶ä¸æ˜¯æ‰€æœ‰çš„æŠ½è±¡äº«å…ƒç±»çš„å­ç±»éƒ½éœ€è¦è¢«å…±äº«ï¼Œä¸èƒ½è¢«å…±äº«çš„å­ç±»å¯è®¾è®¡ä¸ºéå…±äº«å…·ä½“äº«å…ƒç±»ï¼›å½“éœ€è¦ä¸€ä¸ªéå…±äº«å…·ä½“äº«å…ƒç±»çš„å¯¹è±¡æ—¶å¯ä»¥ç›´æ¥é€šè¿‡å®ä¾‹åŒ–åˆ›å»ºã€‚
* äº«å…ƒå·¥å‚ï¼ˆFlyweight Factoryï¼‰è§’è‰² ï¼šè´Ÿè´£åˆ›å»ºå’Œç®¡ç†äº«å…ƒè§’è‰²ã€‚å½“å®¢æˆ·å¯¹è±¡è¯·æ±‚ä¸€ä¸ªäº«å…ƒå¯¹è±¡æ—¶ï¼Œäº«å…ƒå·¥å‚æ£€æŸ»ç³»ç»Ÿä¸­æ˜¯å¦å­˜åœ¨ç¬¦åˆè¦æ±‚çš„äº«å…ƒå¯¹è±¡ï¼Œå¦‚æœå­˜åœ¨åˆ™æä¾›ç»™å®¢æˆ·ï¼›å¦‚æœä¸å­˜åœ¨çš„è¯ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„äº«å…ƒå¯¹è±¡ã€‚



ã€ä¾‹ã€‘ä¿„ç½—æ–¯æ–¹å—

ä¸‹é¢çš„å›¾ç‰‡æ˜¯ä¼—æ‰€å‘¨çŸ¥çš„ä¿„ç½—æ–¯æ–¹å—ä¸­çš„ä¸€ä¸ªä¸ªæ–¹å—ï¼Œå¦‚æœåœ¨ä¿„ç½—æ–¯æ–¹å—è¿™ä¸ªæ¸¸æˆä¸­ï¼Œæ¯ä¸ªä¸åŒçš„æ–¹å—éƒ½æ˜¯ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡å°±è¦å ç”¨å¾ˆå¤šçš„å†…å­˜ç©ºé—´ï¼Œä¸‹é¢åˆ©ç”¨äº«å…ƒæ¨¡å¼è¿›è¡Œå®ç°ã€‚

<img src="å·¥ç¨‹ç´ å…»ç¯‡ï¼ˆä¸­çº§ï¼‰.assets/ä¿„ç½—æ–¯æ–¹å—.jpeg" style="zoom:60%;" />



**å…ˆæ¥çœ‹ç±»å›¾ï¼š**

<img src="å·¥ç¨‹ç´ å…»ç¯‡ï¼ˆä¸­çº§ï¼‰.assets/äº«å…ƒæ¨¡å¼.png" style="zoom:80%;" />

### è®¾è®¡æ¨¡å¼--è¡Œä¸ºå‹æ¨¡å¼

#### 1. æ¨¡æ¿æ–¹æ³•æ¨¡å¼ (Template Method Pattern)

**å®šä¹‰ï¼š**

å®šä¹‰ä¸€ä¸ªæ“ä½œä¸­çš„ç®—æ³•éª¨æ¶ï¼Œè€Œå°†ç®—æ³•çš„ä¸€äº›**æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»**ä¸­ï¼Œä½¿å¾—å­ç±»å¯ä»¥ä¸æ”¹å˜è¯¥ç®—æ³•ç»“æ„çš„æƒ…å†µä¸‹é‡å®šä¹‰è¯¥ç®—æ³•çš„æŸäº›ç‰¹å®šæ­¥éª¤ã€‚

**ä¸€å¥è¯ç†è§£ï¼š**

 çˆ¶ç±»æä¾›æ¨¡æ¿æ–¹æ³•æŒ‡å®šå„ä¸ªæ­¥éª¤çš„æ‰§è¡Œé¡ºåºç­‰ï¼Œè€Œæ­¥éª¤çš„å…·ä½“å®ç°å»¶è¿Ÿåˆ°å­ç±»ä¸­å®ç°ï¼Œå¦‚InputStreamçš„read()æ–¹æ³•å®šä¹‰äº†è¯»å–å­—èŠ‚æ•°ç»„æ–¹æ³•ï¼Œè€Œå…·ä½“è¯»å–æ•°ç»„ä¸­æ¯ä¸ªå­—èŠ‚çš„æ–¹æ³•ç”±å…·ä½“å­ç±»å®ç°ã€‚



æ¨¡æ¿æ–¹æ³•ï¼ˆTemplate Methodï¼‰æ¨¡å¼åŒ…å«ä»¥ä¸‹ä¸»è¦è§’è‰²ï¼š

* æŠ½è±¡ç±»ï¼ˆAbstract Classï¼‰ï¼šè´Ÿè´£ç»™å‡ºä¸€ä¸ªç®—æ³•çš„è½®å»“å’Œéª¨æ¶ã€‚å®ƒç”±ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•å’Œè‹¥å¹²ä¸ªåŸºæœ¬æ–¹æ³•æ„æˆã€‚

  * æ¨¡æ¿æ–¹æ³•ï¼šå®šä¹‰äº†ç®—æ³•çš„éª¨æ¶ï¼ŒæŒ‰æŸç§é¡ºåºè°ƒç”¨å…¶åŒ…å«çš„åŸºæœ¬æ–¹æ³•ã€‚

  * åŸºæœ¬æ–¹æ³•ï¼šæ˜¯å®ç°ç®—æ³•å„ä¸ªæ­¥éª¤çš„æ–¹æ³•ï¼Œæ˜¯æ¨¡æ¿æ–¹æ³•çš„ç»„æˆéƒ¨åˆ†ã€‚åŸºæœ¬æ–¹æ³•åˆå¯ä»¥åˆ†ä¸ºä¸‰ç§ï¼š

    * æŠ½è±¡æ–¹æ³•(Abstract Method) ï¼šä¸€ä¸ªæŠ½è±¡æ–¹æ³•ç”±æŠ½è±¡ç±»å£°æ˜ã€ç”±å…¶å…·ä½“å­ç±»å®ç°ã€‚

    * å…·ä½“æ–¹æ³•(Concrete Method) ï¼šä¸€ä¸ªå…·ä½“æ–¹æ³•ç”±ä¸€ä¸ªæŠ½è±¡ç±»æˆ–å…·ä½“ç±»å£°æ˜å¹¶å®ç°ï¼Œå…¶å­ç±»å¯ä»¥è¿›è¡Œè¦†ç›–ä¹Ÿå¯ä»¥ç›´æ¥ç»§æ‰¿ã€‚

    * é’©å­æ–¹æ³•(Hook Method) ï¼šåœ¨æŠ½è±¡ç±»ä¸­å·²ç»å®ç°ï¼ŒåŒ…æ‹¬ç”¨äºåˆ¤æ–­çš„é€»è¾‘æ–¹æ³•å’Œéœ€è¦å­ç±»é‡å†™çš„ç©ºæ–¹æ³•ä¸¤ç§ã€‚

      ä¸€èˆ¬é’©å­æ–¹æ³•æ˜¯ç”¨äºåˆ¤æ–­çš„é€»è¾‘æ–¹æ³•ï¼Œè¿™ç±»æ–¹æ³•åä¸€èˆ¬ä¸ºisXxxï¼Œè¿”å›å€¼ç±»å‹ä¸ºbooleanç±»å‹ã€‚

* å…·ä½“å­ç±»ï¼ˆConcrete Classï¼‰ï¼šå®ç°æŠ½è±¡ç±»ä¸­æ‰€å®šä¹‰çš„æŠ½è±¡æ–¹æ³•å’Œé’©å­æ–¹æ³•ï¼Œå®ƒä»¬æ˜¯ä¸€ä¸ªé¡¶çº§é€»è¾‘çš„ç»„æˆæ­¥éª¤ã€‚



##### 1.1 æ¸¸æˆæ¡†æ¶ç¤ºä¾‹

```java
// æŠ½è±¡ç±»å®šä¹‰æ¨¡æ¿æ–¹æ³•
abstract class Game {
    // æ¨¡æ¿æ–¹æ³•ï¼ˆfinalé˜²æ­¢å­ç±»ä¿®æ”¹ç®—æ³•ç»“æ„ï¼‰
    public final void play() {
        initialize();
        startPlay();
        endPlay();
    }
    
    // å…·ä½“æ–¹æ³•
    protected void initialize() {
        System.out.println("æ¸¸æˆåˆå§‹åŒ–å®Œæˆ");
    }
    
    // æŠ½è±¡æ–¹æ³•ï¼Œç”±å­ç±»å®ç°
    protected abstract void startPlay();
    protected abstract void endPlay();
}

// å…·ä½“å®ç°
class Cricket extends Game {
    protected void startPlay() {
        System.out.println("æ¿çƒæ¸¸æˆå¼€å§‹");
    }
    
    protected void endPlay() {
        System.out.println("æ¿çƒæ¸¸æˆç»“æŸ");
    }
}

class Football extends Game {
    protected void startPlay() {
        System.out.println("è¶³çƒæ¸¸æˆå¼€å§‹");
    }
    
    protected void endPlay() {
        System.out.println("è¶³çƒæ¸¸æˆç»“æŸ");
    }
}

// ä½¿ç”¨
Game game = new Cricket();
game.play(); // æ‰§è¡Œæ¨¡æ¿æ–¹æ³•

game = new Football();
game.play();
```



#### 2. ç­–ç•¥æ¨¡å¼ (Strategy Pattern)

> **å®šä¹‰ï¼š**
>
> â€‹	è¯¥æ¨¡å¼å®šä¹‰äº†ä¸€ç³»åˆ—ç®—æ³•ï¼Œå¹¶å°†æ¯ä¸ªç®—æ³•å°è£…èµ·æ¥ï¼Œä½¿å®ƒä»¬å¯ä»¥ç›¸äº’æ›¿æ¢ï¼Œä¸”ç®—æ³•çš„å˜åŒ–ä¸ä¼šå½±å“ä½¿ç”¨ç®—æ³•çš„å®¢æˆ·ã€‚ç­–ç•¥æ¨¡å¼å±äºå¯¹è±¡è¡Œä¸ºæ¨¡å¼ï¼Œå®ƒé€šè¿‡å¯¹ç®—æ³•è¿›è¡Œå°è£…ï¼ŒæŠŠä½¿ç”¨ç®—æ³•çš„è´£ä»»å’Œç®—æ³•çš„å®ç°åˆ†å‰²å¼€æ¥ï¼Œå¹¶å§”æ´¾ç»™ä¸åŒçš„å¯¹è±¡å¯¹è¿™äº›ç®—æ³•è¿›è¡Œç®¡ç†ã€‚
>
> **ä¸€å¥è¯ç†è§£ï¼š**
>
> ä¸ºè¾¾åˆ°ç›®çš„æœ‰å¤šç§å¯é€‰ç­–ç•¥ï¼Œä¸”ç­–ç•¥çš„é€‰æ‹©ä¸ä¼šå½±å“æœ€ç»ˆç»“æœï¼Œå¦‚ä¸ºåˆ°è¾¾ç›®çš„åœ°å¯ä»¥é€‰æ‹©ä¸åŒçš„äº¤é€šæ–¹å¼ï¼Œè¿™æ—¶å¯ä»¥å°†ä¸åŒç­–ç•¥æŠ½è±¡æˆä¸ºæ¥å£ï¼Œåœ¨å®ç°æ—¶å†ä¼ å…¥å…·ä½“çš„ç­–ç•¥å®ç°ç±»ï¼Œä»è€Œå°†ç®—æ³•çš„è´£ä»»ä¸å®ç°åˆ†å¼€ï¼Œå¦‚JDKä¸­Array.sort()ä¼ å…¥çš„Comparatoræ¥å£å®ç°ç±»ã€‚

<img src="å·¥ç¨‹ç´ å…»ç¯‡ï¼ˆä¸­çº§ï¼‰.assets/image-20251126200400150.png" alt="image-20251126200400150" style="zoom: 67%;" />

ç­–ç•¥æ¨¡å¼çš„ä¸»è¦è§’è‰²å¦‚ä¸‹ï¼š

* æŠ½è±¡ç­–ç•¥ï¼ˆStrategyï¼‰ç±»ï¼šè¿™æ˜¯ä¸€ä¸ªæŠ½è±¡è§’è‰²ï¼Œé€šå¸¸ç”±ä¸€ä¸ªæ¥å£æˆ–æŠ½è±¡ç±»å®ç°ã€‚æ­¤è§’è‰²ç»™å‡ºæ‰€æœ‰çš„å…·ä½“ç­–ç•¥ç±»æ‰€éœ€çš„æ¥å£ã€‚
* å…·ä½“ç­–ç•¥ï¼ˆConcrete Strategyï¼‰ç±»ï¼šå®ç°äº†æŠ½è±¡ç­–ç•¥å®šä¹‰çš„æ¥å£ï¼Œæä¾›å…·ä½“çš„ç®—æ³•å®ç°æˆ–è¡Œä¸ºã€‚
* ç¯å¢ƒï¼ˆContextï¼‰ç±»ï¼šæŒæœ‰ä¸€ä¸ªç­–ç•¥ç±»çš„å¼•ç”¨ï¼Œæœ€ç»ˆç»™å®¢æˆ·ç«¯è°ƒç”¨ã€‚





##### 2.1 ç¤ºä¾‹

ã€ä¾‹ã€‘ä¿ƒé”€æ´»åŠ¨

ä¸€å®¶ç™¾è´§å…¬å¸åœ¨å®šå¹´åº¦çš„ä¿ƒé”€æ´»åŠ¨ã€‚é’ˆå¯¹ä¸åŒçš„èŠ‚æ—¥ï¼ˆæ˜¥èŠ‚ã€ä¸­ç§‹èŠ‚ã€åœ£è¯èŠ‚ï¼‰æ¨å‡ºä¸åŒçš„ä¿ƒé”€æ´»åŠ¨ï¼Œç”±ä¿ƒé”€å‘˜å°†ä¿ƒé”€æ´»åŠ¨å±•ç¤ºç»™å®¢æˆ·ã€‚ç±»å›¾å¦‚ä¸‹ï¼š

<img src="å·¥ç¨‹ç´ å…»ç¯‡ï¼ˆä¸­çº§ï¼‰.assets/ç­–ç•¥æ¨¡å¼.png" style="zoom:80%;" />

```java
public interface Strategy {
    void show();
}

//ä¸ºæ˜¥èŠ‚å‡†å¤‡çš„ä¿ƒé”€æ´»åŠ¨A
public class StrategyA implements Strategy {

    public void show() {
        System.out.println("ä¹°ä¸€é€ä¸€");
    }
}

//ä¸ºä¸­ç§‹å‡†å¤‡çš„ä¿ƒé”€æ´»åŠ¨B
public class StrategyB implements Strategy {

    public void show() {
        System.out.println("æ»¡200å…ƒå‡50å…ƒ");
    }
}

//ä¸ºåœ£è¯å‡†å¤‡çš„ä¿ƒé”€æ´»åŠ¨C
public class StrategyC implements Strategy {

    public void show() {
        System.out.println("æ»¡1000å…ƒåŠ ä¸€å…ƒæ¢è´­ä»»æ„200å…ƒä»¥ä¸‹å•†å“");
    }
}


// å®šä¹‰ç¯å¢ƒè§’è‰²ï¼ˆContextï¼‰ï¼šç”¨äºè¿æ¥ä¸Šä¸‹æ–‡ï¼Œå³æŠŠä¿ƒé”€æ´»åŠ¨æ¨é”€ç»™å®¢æˆ·ï¼Œè¿™é‡Œå¯ä»¥ç†è§£ä¸ºé”€å”®å‘˜
public class SalesMan {                        
    //æŒæœ‰æŠ½è±¡ç­–ç•¥è§’è‰²çš„å¼•ç”¨                              
    private Strategy strategy;                 
                                               
    public SalesMan(Strategy strategy) {       
        this.strategy = strategy;              
    }                                          
                                               
    //å‘å®¢æˆ·å±•ç¤ºä¿ƒé”€æ´»åŠ¨                                
    public void salesManShow(){                
        strategy.show();                       
    }                                          
}                                              
```



##### 2.2 `Comparator` ä¸­çš„ç­–ç•¥æ¨¡å¼

åœ¨Arraysç±»ä¸­æœ‰ä¸€ä¸ª `sort()` æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š

```java
public class Arrays{
    public static <T> void sort(T[] a, Comparator<? super T> c) {
        if (c == null) {
            sort(a);
        } else {
            if (LegacyMergeSort.userRequested)
                legacyMergeSort(a, c);
            else
                TimSort.sort(a, 0, a.length, c, null, 0, 0);
        }
    }
}
```

Arrayså°±æ˜¯ä¸€ä¸ªç¯å¢ƒè§’è‰²ç±»ï¼Œè¿™ä¸ªsortæ–¹æ³•å¯ä»¥ä¼ ä¸€ä¸ªæ–°ç­–ç•¥è®©Arraysæ ¹æ®è¿™ä¸ªç­–ç•¥æ¥è¿›è¡Œæ’åºã€‚å°±æ¯”å¦‚ä¸‹é¢çš„æµ‹è¯•ç±»ã€‚

```java
public class demo {
    public static void main(String[] args) {

        Integer[] data = {12, 2, 3, 2, 4, 5, 1};
        // å®ç°é™åºæ’åº
        Arrays.sort(data, new Comparator<Integer>() {
            public int compare(Integer o1, Integer o2) {
                return o2 - o1;
            }
        });
        System.out.println(Arrays.toString(data)); //[12, 5, 4, 3, 2, 2, 1]
    }
}
```

è¿™é‡Œæˆ‘ä»¬åœ¨è°ƒç”¨Arraysçš„sortæ–¹æ³•æ—¶ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¼ é€’çš„æ˜¯Comparatoræ¥å£çš„å­å®ç°ç±»å¯¹è±¡ã€‚æ‰€ä»¥Comparatorå……å½“çš„æ˜¯æŠ½è±¡ç­–ç•¥è§’è‰²ï¼Œè€Œå…·ä½“çš„å­å®ç°ç±»å……å½“çš„æ˜¯å…·ä½“ç­–ç•¥è§’è‰²ã€‚



#### 3. è§‚å¯Ÿè€…æ¨¡å¼ (Observer Pattern)

> åˆè¢«ç§°ä¸ºå‘å¸ƒ-è®¢é˜…ï¼ˆPublish/Subscribeï¼‰æ¨¡å¼ï¼Œå®ƒå®šä¹‰äº†ä¸€ç§ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œè®©å¤šä¸ªè§‚å¯Ÿè€…å¯¹è±¡åŒæ—¶ç›‘å¬æŸä¸€ä¸ªä¸»é¢˜å¯¹è±¡ã€‚è¿™ä¸ªä¸»é¢˜å¯¹è±¡åœ¨çŠ¶æ€å˜åŒ–æ—¶ï¼Œä¼šé€šçŸ¥æ‰€æœ‰çš„è§‚å¯Ÿè€…å¯¹è±¡ï¼Œä½¿ä»–ä»¬èƒ½å¤Ÿè‡ªåŠ¨æ›´æ–°è‡ªå·±ã€‚

##### 3.1 è‡ªå®šä¹‰å®ç°

```java
// ä¸»é¢˜æ¥å£
interface Subject {
    void registerObserver(Observer o);
    void removeObserver(Observer o);
    void notifyObservers();
}

// è§‚å¯Ÿè€…æ¥å£
interface Observer {
    void update(float temperature, float humidity, float pressure);
}

// å…·ä½“ä¸»é¢˜
class WeatherData implements Subject {
    private List<Observer> observers;
    private float temperature;
    private float humidity;
    private float pressure;
    
    public WeatherData() {
        observers = new ArrayList<>();
    }
    
    public void registerObserver(Observer o) {
        observers.add(o);
    }
    
    public void removeObserver(Observer o) {
        observers.remove(o);
    }
    
    public void notifyObservers() {
        for (Observer observer : observers) {
            observer.update(temperature, humidity, pressure);
        }
    }
    
    public void measurementsChanged() {
        notifyObservers();
    }
    
    public void setMeasurements(float temperature, float humidity, float pressure) {
        this.temperature = temperature;
        this.humidity = humidity;
        this.pressure = pressure;
        measurementsChanged();
    }
}

// å…·ä½“è§‚å¯Ÿè€…
class CurrentConditionsDisplay implements Observer {
    private float temperature;
    private float humidity;
    
    public void update(float temperature, float humidity, float pressure) {
        this.temperature = temperature;
        this.humidity = humidity;
        display();
    }
    
    public void display() {
        System.out.println("å½“å‰æ¡ä»¶: " + temperature + "Â°C å’Œ " + humidity + "% æ¹¿åº¦");
    }
}
```

##### 3.2 Javaå†…ç½®è§‚å¯Ÿè€…

```java
class WeatherData extends Observable {
    private float temperature;
    private float humidity;
    private float pressure;
    
    public void measurementsChanged() {
        setChanged(); // æ ‡è®°çŠ¶æ€å·²æ”¹å˜
        notifyObservers(); // é€šçŸ¥è§‚å¯Ÿè€…
    }
    
    public void setMeasurements(float temperature, float humidity, float pressure) {
        this.temperature = temperature;
        this.humidity = humidity;
        this.pressure = pressure;
        measurementsChanged();
    }
    
    // getteræ–¹æ³•...
}

class CurrentConditionsDisplay implements Observer {
    public void update(Observable o, Object arg) {
        if (o instanceof WeatherData) {
            WeatherData weatherData = (WeatherData) o;
            // æ›´æ–°æ˜¾ç¤º
        }
    }
}
```



#### 4.è´£ä»»é“¾æ¨¡å¼ï¼ˆChain of Responsibility Patternï¼‰

**å®šä¹‰ï¼š**

åˆåèŒè´£é“¾æ¨¡å¼ï¼Œä¸ºäº†é¿å…è¯·æ±‚å‘é€è€…ä¸å¤šä¸ªè¯·æ±‚å¤„ç†è€…è€¦åˆåœ¨ä¸€èµ·ï¼Œå°†æ‰€æœ‰è¯·æ±‚çš„å¤„ç†è€…é€šè¿‡å‰ä¸€å¯¹è±¡è®°ä½å…¶ä¸‹ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨è€Œè¿æˆä¸€æ¡é“¾ï¼›å½“æœ‰è¯·æ±‚å‘ç”Ÿæ—¶ï¼Œå¯å°†è¯·æ±‚æ²¿ç€è¿™æ¡é“¾ä¼ é€’ï¼Œç›´åˆ°æœ‰å¯¹è±¡å¤„ç†å®ƒä¸ºæ­¢ã€‚

**ä¸€å¥è¯ç†è§£ï¼š**

â€œå‡»é¼“ä¼ èŠ±â€ï¼Œå¤„ç†è€…å¼•ç”¨ä¸‹ä¸€çº§å¤„ç†è€…ï¼Œå½“å‰å¤„ç†è€…å…ˆå¤„ç†ï¼Œä¹‹åæäº¤ç»™ä¸‹ä¸€çº§å¤„ç†ï¼Œå¦‚javaWebä¸­çš„FilterChainã€å…¬å¸å‘˜å·¥è¯·å‡çš„é€çº§å®¡æ‰¹ç­‰ã€‚



èŒè´£é“¾æ¨¡å¼ä¸»è¦åŒ…å«ä»¥ä¸‹è§’è‰²:

* æŠ½è±¡å¤„ç†è€…ï¼ˆHandlerï¼‰è§’è‰²ï¼šå®šä¹‰ä¸€ä¸ªå¤„ç†è¯·æ±‚çš„æ¥å£ï¼ŒåŒ…å«æŠ½è±¡å¤„ç†æ–¹æ³•å’Œä¸€ä¸ªåç»§è¿æ¥ã€‚
* å…·ä½“å¤„ç†è€…ï¼ˆConcrete Handlerï¼‰è§’è‰²ï¼šå®ç°æŠ½è±¡å¤„ç†è€…çš„å¤„ç†æ–¹æ³•ï¼Œåˆ¤æ–­èƒ½å¦å¤„ç†æœ¬æ¬¡è¯·æ±‚ï¼Œå¦‚æœå¯ä»¥å¤„ç†è¯·æ±‚åˆ™å¤„ç†ï¼Œå¦åˆ™å°†è¯¥è¯·æ±‚è½¬ç»™å®ƒçš„åç»§è€…ã€‚
* å®¢æˆ·ç±»ï¼ˆClientï¼‰è§’è‰²ï¼šåˆ›å»ºå¤„ç†é“¾ï¼Œå¹¶å‘é“¾å¤´çš„å…·ä½“å¤„ç†è€…å¯¹è±¡æäº¤è¯·æ±‚ï¼Œå®ƒä¸å…³å¿ƒå¤„ç†ç»†èŠ‚å’Œè¯·æ±‚çš„ä¼ é€’è¿‡ç¨‹ã€‚



##### 4.1 ç¤ºä¾‹

ç°éœ€è¦å¼€å‘ä¸€ä¸ªè¯·å‡æµç¨‹æ§åˆ¶ç³»ç»Ÿã€‚è¯·å‡ä¸€å¤©ä»¥ä¸‹çš„å‡åªéœ€è¦å°ç»„é•¿åŒæ„å³å¯ï¼›è¯·å‡1å¤©åˆ°3å¤©çš„å‡è¿˜éœ€è¦éƒ¨é—¨ç»ç†åŒæ„ï¼›è¯·æ±‚3å¤©åˆ°7å¤©è¿˜éœ€è¦æ€»ç»ç†åŒæ„æ‰è¡Œã€‚



```java
//è¯·å‡æ¡
public class LeaveRequest {
    private String name;//å§“å
    private int num;//è¯·å‡å¤©æ•°
    private String content;//è¯·å‡å†…å®¹

    public LeaveRequest(String name, int num, String content) {
        this.name = name;
        this.num = num;
        this.content = content;
    }

    public String getName() {
        return name;
    }

    public int getNum() {
        return num;
    }

    public String getContent() {
        return content;
    }
}

//å¤„ç†è€…æŠ½è±¡ç±»
public abstract class Handler {
    protected final static int NUM_ONE = 1;
    protected final static int NUM_THREE = 3;
    protected final static int NUM_SEVEN = 7;

    //è¯¥é¢†å¯¼å¤„ç†çš„è¯·å‡å¤©æ•°åŒºé—´
    private int numStart;
    private int numEnd;

    //é¢†å¯¼ä¸Šé¢è¿˜æœ‰é¢†å¯¼
    private Handler nextHandler;

    //è®¾ç½®è¯·å‡å¤©æ•°èŒƒå›´ ä¸Šä¸å°é¡¶
    public Handler(int numStart) {
        this.numStart = numStart;
    }

    //è®¾ç½®è¯·å‡å¤©æ•°èŒƒå›´
    public Handler(int numStart, int numEnd) {
        this.numStart = numStart;
        this.numEnd = numEnd;
    }

    //è®¾ç½®ä¸Šçº§é¢†å¯¼
    public void setNextHandler(Handler nextHandler){
        this.nextHandler = nextHandler;
    }

    //æäº¤è¯·å‡æ¡
    public final void submit(LeaveRequest leave){
        if(0 == this.numStart){
            return;
        }

        //å¦‚æœè¯·å‡å¤©æ•°è¾¾åˆ°è¯¥é¢†å¯¼è€…çš„å¤„ç†è¦æ±‚
        if(leave.getNum() >= this.numStart){
            this.handleLeave(leave);

            //å¦‚æœè¿˜æœ‰ä¸Šçº§ å¹¶ä¸”è¯·å‡å¤©æ•°è¶…è¿‡äº†å½“å‰é¢†å¯¼çš„å¤„ç†èŒƒå›´
            if(null != this.nextHandler && leave.getNum() > numEnd){
                this.nextHandler.submit(leave);//ç»§ç»­æäº¤
            } else {
                System.out.println("æµç¨‹ç»“æŸ");
            }
        }
    }

    //å„çº§é¢†å¯¼å¤„ç†è¯·å‡æ¡æ–¹æ³•
    protected abstract void handleLeave(LeaveRequest leave);
}

//å°ç»„é•¿
public class GroupLeader extends Handler {
    public GroupLeader() {
        //å°ç»„é•¿å¤„ç†1-3å¤©çš„è¯·å‡
        super(Handler.NUM_ONE, Handler.NUM_THREE);
    }

    @Override
    protected void handleLeave(LeaveRequest leave) {
        System.out.println(leave.getName() + "è¯·å‡" + leave.getNum() + "å¤©," + leave.getContent() + "ã€‚");
        System.out.println("å°ç»„é•¿å®¡æ‰¹ï¼šåŒæ„ã€‚");
    }
}

//éƒ¨é—¨ç»ç†
public class Manager extends Handler {
    public Manager() {
        //éƒ¨é—¨ç»ç†å¤„ç†3-7å¤©çš„è¯·å‡
        super(Handler.NUM_THREE, Handler.NUM_SEVEN);
    }

    @Override
    protected void handleLeave(LeaveRequest leave) {
        System.out.println(leave.getName() + "è¯·å‡" + leave.getNum() + "å¤©," + leave.getContent() + "ã€‚");
        System.out.println("éƒ¨é—¨ç»ç†å®¡æ‰¹ï¼šåŒæ„ã€‚");
    }
}

//æ€»ç»ç†
public class GeneralManager extends Handler {
    public GeneralManager() {
        //éƒ¨é—¨ç»ç†å¤„ç†7å¤©ä»¥ä¸Šçš„è¯·å‡
        super(Handler.NUM_SEVEN);
    }

    @Override
    protected void handleLeave(LeaveRequest leave) {
        System.out.println(leave.getName() + "è¯·å‡" + leave.getNum() + "å¤©," + leave.getContent() + "ã€‚");
        System.out.println("æ€»ç»ç†å®¡æ‰¹ï¼šåŒæ„ã€‚");
    }
}

//æµ‹è¯•ç±»
public class Client {
    public static void main(String[] args) {
        //è¯·å‡æ¡æ¥ä¸€å¼ 
        LeaveRequest leave = new LeaveRequest("å°èŠ±",5,"èº«ä½“ä¸é€‚");

        //å„ä½é¢†å¯¼
        GroupLeader groupLeader = new GroupLeader();
        Manager manager = new Manager();
        GeneralManager generalManager = new GeneralManager();

        groupLeader.setNextHandler(manager);//å°ç»„é•¿çš„é¢†å¯¼æ˜¯éƒ¨é—¨ç»ç†
        manager.setNextHandler(generalManager);//éƒ¨é—¨ç»ç†çš„é¢†å¯¼æ˜¯æ€»ç»ç†
        //ä¹‹æ‰€ä»¥åœ¨è¿™é‡Œè®¾ç½®ä¸Šçº§é¢†å¯¼ï¼Œæ˜¯å› ä¸ºå¯ä»¥æ ¹æ®å®é™…éœ€æ±‚æ¥æ›´æ”¹è®¾ç½®ï¼Œå¦‚æœå®æˆ˜ä¸­ä¸Šçº§é¢†å¯¼äººéƒ½æ˜¯å›ºå®šçš„ï¼Œåˆ™å¯ä»¥ç§»åˆ°é¢†å¯¼å®ç°ç±»ä¸­ã€‚

        //æäº¤ç”³è¯·
        groupLeader.submit(leave);
    }
}
```



##### 4.2 æºç åº”ç”¨ FilterChain

åœ¨javaWebåº”ç”¨å¼€å‘ä¸­ï¼ŒFilterChainæ˜¯èŒè´£é“¾ï¼ˆè¿‡æ»¤å™¨ï¼‰æ¨¡å¼çš„å…¸å‹åº”ç”¨ï¼Œä»¥ä¸‹æ˜¯Filterçš„æ¨¡æ‹Ÿå®ç°åˆ†æ:

![image-20211108142414193](å·¥ç¨‹ç´ å…»ç¯‡ï¼ˆä¸­çº§ï¼‰.assets/image-20211108142414193.png)



#### 5.çŠ¶æ€æ¨¡å¼

**å®šä¹‰ï¼š**

å¯¹æœ‰çŠ¶æ€çš„å¯¹è±¡ï¼ŒæŠŠå¤æ‚çš„â€œåˆ¤æ–­é€»è¾‘â€æå–åˆ°ä¸åŒçš„çŠ¶æ€å¯¹è±¡ä¸­ï¼Œå…è®¸çŠ¶æ€å¯¹è±¡åœ¨å…¶å†…éƒ¨çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶æ”¹å˜å…¶è¡Œä¸ºã€‚

**ä¸€å¥è¯ç†è§£ï¼š**

ä½¿ç”¨çŠ¶æ€å¯¹è±¡å°è£…çŠ¶æ€å’Œå¯¹åº”çš„è¡Œä¸ºï¼Œå¦‚çŠ¶æ€æœºã€‚



çŠ¶æ€æ¨¡å¼åŒ…å«ä»¥ä¸‹ä¸»è¦è§’è‰²ã€‚

* ç¯å¢ƒï¼ˆContextï¼‰è§’è‰²ï¼šä¹Ÿç§°ä¸ºä¸Šä¸‹æ–‡ï¼Œå®ƒå®šä¹‰äº†å®¢æˆ·ç¨‹åºéœ€è¦çš„æ¥å£ï¼Œç»´æŠ¤ä¸€ä¸ªå½“å‰çŠ¶æ€ï¼Œå¹¶å°†ä¸çŠ¶æ€ç›¸å…³çš„æ“ä½œå§”æ‰˜ç»™å½“å‰çŠ¶æ€å¯¹è±¡æ¥å¤„ç†ã€‚
* æŠ½è±¡çŠ¶æ€ï¼ˆStateï¼‰è§’è‰²ï¼šå®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œç”¨ä»¥å°è£…ç¯å¢ƒå¯¹è±¡ä¸­çš„ç‰¹å®šçŠ¶æ€æ‰€å¯¹åº”çš„è¡Œä¸ºã€‚
* å…·ä½“çŠ¶æ€ï¼ˆConcrete  Stateï¼‰è§’è‰²ï¼šå®ç°æŠ½è±¡çŠ¶æ€æ‰€å¯¹åº”çš„è¡Œä¸ºã€‚



##### 5.1 ç¤ºä¾‹

ã€ä¾‹ã€‘é€šè¿‡æŒ‰é’®æ¥æ§åˆ¶ä¸€ä¸ªç”µæ¢¯çš„çŠ¶æ€ï¼Œä¸€ä¸ªç”µæ¢¯æœ‰å¼€é—¨çŠ¶æ€ï¼Œå…³é—¨çŠ¶æ€ï¼Œåœæ­¢çŠ¶æ€ï¼Œè¿è¡ŒçŠ¶æ€ã€‚æ¯ä¸€ç§çŠ¶æ€æ”¹å˜ï¼Œéƒ½æœ‰å¯èƒ½è¦æ ¹æ®å…¶ä»–çŠ¶æ€æ¥æ›´æ–°å¤„ç†ã€‚ä¾‹å¦‚ï¼Œå¦‚æœç”µæ¢¯é—¨ç°åœ¨å¤„äºè¿è¡Œæ—¶çŠ¶æ€ï¼Œå°±ä¸èƒ½è¿›è¡Œå¼€é—¨æ“ä½œï¼Œè€Œå¦‚æœç”µæ¢¯é—¨æ˜¯åœæ­¢çŠ¶æ€ï¼Œå°±å¯ä»¥æ‰§è¡Œå¼€é—¨æ“ä½œã€‚

```java
//æŠ½è±¡çŠ¶æ€ç±»
public abstract class LiftState {
    //å®šä¹‰ä¸€ä¸ªç¯å¢ƒè§’è‰²ï¼Œä¹Ÿå°±æ˜¯å°è£…çŠ¶æ€çš„å˜åŒ–å¼•èµ·çš„åŠŸèƒ½å˜åŒ–
    protected Context context;

    public void setContext(Context context) {
        this.context = context;
    }

    //ç”µæ¢¯å¼€é—¨åŠ¨ä½œ
    public abstract void open();

    //ç”µæ¢¯å…³é—¨åŠ¨ä½œ
    public abstract void close();

    //ç”µæ¢¯è¿è¡ŒåŠ¨ä½œ
    public abstract void run();

    //ç”µæ¢¯åœæ­¢åŠ¨ä½œ
    public abstract void stop();
}

//å¼€å¯çŠ¶æ€
public class OpenningState extends LiftState {

    //å¼€å¯å½“ç„¶å¯ä»¥å…³é—­äº†ï¼Œæˆ‘å°±æƒ³æµ‹è¯•ä¸€ä¸‹ç”µæ¢¯é—¨å¼€å…³åŠŸèƒ½
    @Override
    public void open() {
        System.out.println("ç”µæ¢¯é—¨å¼€å¯...");
    }

    @Override
    public void close() {
        //çŠ¶æ€ä¿®æ”¹
        super.context.setLiftState(Context.closeingState);
        //åŠ¨ä½œå§”æ‰˜ä¸ºCloseStateæ¥æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯å§”æ‰˜ç»™äº†ClosingStateå­ç±»æ‰§è¡Œè¿™ä¸ªåŠ¨ä½œ
        super.context.getLiftState().close();
    }

    //ç”µæ¢¯é—¨ä¸èƒ½å¼€ç€å°±è·‘ï¼Œè¿™é‡Œä»€ä¹ˆä¹Ÿä¸åš
    @Override
    public void run() {
        //do nothing
    }

    //å¼€é—¨çŠ¶æ€å·²ç»æ˜¯åœæ­¢çš„äº†
    @Override
    public void stop() {
        //do nothing
    }
}

//è¿è¡ŒçŠ¶æ€
public class RunningState extends LiftState {

    //è¿è¡Œçš„æ—¶å€™å¼€ç”µæ¢¯é—¨ï¼Ÿä½ ç–¯äº†ï¼ç”µæ¢¯ä¸ä¼šç»™ä½ å¼€çš„
    @Override
    public void open() {
        //do nothing
    }

    //ç”µæ¢¯é—¨å…³é—­ï¼Ÿè¿™æ˜¯è‚¯å®šäº†
    @Override
    public void close() {//è™½ç„¶å¯ä»¥å…³é—¨ï¼Œä½†è¿™ä¸ªåŠ¨ä½œä¸å½’æˆ‘æ‰§è¡Œ
        //do nothing
    }

    //è¿™æ˜¯åœ¨è¿è¡ŒçŠ¶æ€ä¸‹è¦å®ç°çš„æ–¹æ³•
    @Override
    public void run() {
        System.out.println("ç”µæ¢¯æ­£åœ¨è¿è¡Œ...");
    }

    //è¿™ä¸ªäº‹ç»å¯¹æ˜¯åˆç†çš„ï¼Œå…‰è¿è¡Œä¸åœæ­¢è¿˜æœ‰è°æ•¢åšè¿™ä¸ªç”µæ¢¯ï¼Ÿï¼ä¼°è®¡åªæœ‰ä¸Šå¸äº†
    @Override
    public void stop() {
        //çŠ¶æ€åˆ‡æ¢
        super.context.setLiftState(Context.stoppingState);
        super.context.stop();
    }
}

//åœæ­¢çŠ¶æ€
public class StoppingState extends LiftState {

    //åœæ­¢çŠ¶æ€ï¼Œå¼€é—¨ï¼Œé‚£æ˜¯è¦çš„ï¼
    @Override
    public void open() {
        //çŠ¶æ€ä¿®æ”¹
        super.context.setLiftState(Context.openningState);
        //åŠ¨ä½œå§”æ‰˜ä¸ºCloseStateæ¥æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯å§”æ‰˜ç»™äº†ClosingStateå­ç±»æ‰§è¡Œè¿™ä¸ªåŠ¨ä½œ
        super.context.getLiftState().open();
    }

    @Override
    public void close() {//è™½ç„¶å¯ä»¥å…³é—¨ï¼Œä½†è¿™ä¸ªåŠ¨ä½œä¸å½’æˆ‘æ‰§è¡Œ
        //çŠ¶æ€ä¿®æ”¹
        super.context.setLiftState(Context.closeingState);
        //åŠ¨ä½œå§”æ‰˜ä¸ºCloseStateæ¥æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯å§”æ‰˜ç»™äº†ClosingStateå­ç±»æ‰§è¡Œè¿™ä¸ªåŠ¨ä½œ
        super.context.getLiftState().close();
    }

    //åœæ­¢çŠ¶æ€å†è·‘èµ·æ¥ï¼Œæ­£å¸¸çš„å¾ˆ
    @Override
    public void run() {
        //çŠ¶æ€ä¿®æ”¹
        super.context.setLiftState(Context.runningState);
        //åŠ¨ä½œå§”æ‰˜ä¸ºCloseStateæ¥æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯å§”æ‰˜ç»™äº†ClosingStateå­ç±»æ‰§è¡Œè¿™ä¸ªåŠ¨ä½œ
        super.context.getLiftState().run();
    }

    //åœæ­¢çŠ¶æ€æ˜¯æ€ä¹ˆå‘ç”Ÿçš„å‘¢ï¼Ÿå½“ç„¶æ˜¯åœæ­¢æ–¹æ³•æ‰§è¡Œäº†
    @Override
    public void stop() {
        System.out.println("ç”µæ¢¯åœæ­¢äº†...");
    }
}

//å…³é—­çŠ¶æ€
public class ClosingState extends LiftState {

    @Override
    //ç”µæ¢¯é—¨å…³é—­ï¼Œè¿™æ˜¯å…³é—­çŠ¶æ€è¦å®ç°çš„åŠ¨ä½œ
    public void close() {
        System.out.println("ç”µæ¢¯é—¨å…³é—­...");
    }

    //ç”µæ¢¯é—¨å…³äº†å†æ‰“å¼€ï¼Œé€—ä½ ç©å‘¢ï¼Œé‚£è¿™ä¸ªå…è®¸å‘€
    @Override
    public void open() {
        super.context.setLiftState(Context.openningState);
        super.context.open();
    }


    //ç”µæ¢¯é—¨å…³äº†å°±è·‘ï¼Œè¿™æ˜¯å†æ­£å¸¸ä¸è¿‡äº†
    @Override
    public void run() {
        super.context.setLiftState(Context.runningState);
        super.context.run();
    }

    //ç”µæ¢¯é—¨å…³ç€ï¼Œæˆ‘å°±ä¸æŒ‰æ¥¼å±‚
    @Override
    public void stop() {
        super.context.setLiftState(Context.stoppingState);
        super.context.stop();
    }
}

//ç¯å¢ƒè§’è‰²
public class Context {
    //å®šä¹‰å‡ºæ‰€æœ‰çš„ç”µæ¢¯çŠ¶æ€
    public final static OpenningState openningState = new OpenningState();//å¼€é—¨çŠ¶æ€ï¼Œè¿™æ—¶å€™ç”µæ¢¯åªèƒ½å…³é—­
    public final static ClosingState closeingState = new ClosingState();//å…³é—­çŠ¶æ€ï¼Œè¿™æ—¶å€™ç”µæ¢¯å¯ä»¥è¿è¡Œã€åœæ­¢å’Œå¼€é—¨
    public final static RunningState runningState = new RunningState();//è¿è¡ŒçŠ¶æ€ï¼Œè¿™æ—¶å€™ç”µæ¢¯åªèƒ½åœæ­¢
    public final static StoppingState stoppingState = new StoppingState();//åœæ­¢çŠ¶æ€ï¼Œè¿™æ—¶å€™ç”µæ¢¯å¯ä»¥å¼€é—¨ã€è¿è¡Œ


    //å®šä¹‰ä¸€ä¸ªå½“å‰ç”µæ¢¯çŠ¶æ€
    private LiftState liftState;

    public LiftState getLiftState() {
        return this.liftState;
    }

    public void setLiftState(LiftState liftState) {
        //å½“å‰ç¯å¢ƒæ”¹å˜
        this.liftState = liftState;
        //æŠŠå½“å‰çš„ç¯å¢ƒé€šçŸ¥åˆ°å„ä¸ªå®ç°ç±»ä¸­
        this.liftState.setContext(this);
    }

    public void open() {
        this.liftState.open();
    }

    public void close() {
        this.liftState.close();
    }

    public void run() {
        this.liftState.run();
    }

    public void stop() {
        this.liftState.stop();
    }
}

//æµ‹è¯•ç±»
public class Client {
    public static void main(String[] args) {
        Context context = new Context();
        context.setLiftState(new ClosingState());

        context.open();
        context.close();
        context.run();
        context.stop();
    }
}
```



#### 6.å‘½ä»¤æ¨¡å¼



**å®šä¹‰ï¼š**

å°†ä¸€ä¸ªè¯·æ±‚å°è£…ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œ**ä½¿å‘å‡ºè¯·æ±‚çš„è´£ä»»å’Œæ‰§è¡Œè¯·æ±‚çš„è´£ä»»åˆ†å‰²å¼€**ã€‚è¿™æ ·ä¸¤è€…ä¹‹é—´é€šè¿‡å‘½ä»¤å¯¹è±¡è¿›è¡Œæ²Ÿé€šï¼Œè¿™æ ·æ–¹ä¾¿å°†å‘½ä»¤å¯¹è±¡è¿›è¡Œå­˜å‚¨ã€ä¼ é€’ã€è°ƒç”¨ã€å¢åŠ ä¸ç®¡ç†ã€‚

**ä¸€å¥è¯ç†è§£ï¼š**

ä½¿ç”¨å‘½ä»¤å¯¹è±¡**å°†è¯·æ±‚è€…ä¸æ‰§è¡Œè€…è§£è€¦**ï¼Œè¯·æ±‚è€…å¼•ç”¨å‘½ä»¤å¯¹è±¡ï¼Œå‘½ä»¤å¯¹è±¡å¼•ç”¨æ‰§è¡Œè€…ï¼Œä¾‹å¦‚Runnableæ¥å£å°±æ˜¯ä¸€ä¸ªå‘½ä»¤å¯¹è±¡ï¼Œè€ŒThreadç±»æ˜¯è¯·æ±‚è€…ã€‚



å‘½ä»¤æ¨¡å¼åŒ…å«ä»¥ä¸‹ä¸»è¦è§’è‰²ï¼š

* æŠ½è±¡å‘½ä»¤ç±»ï¼ˆCommandï¼‰è§’è‰²ï¼š å®šä¹‰å‘½ä»¤çš„æ¥å£ï¼Œå£°æ˜æ‰§è¡Œçš„æ–¹æ³•ã€‚
* å…·ä½“å‘½ä»¤ï¼ˆConcrete  Commandï¼‰è§’è‰²ï¼šå…·ä½“çš„å‘½ä»¤ï¼Œå®ç°å‘½ä»¤æ¥å£ï¼›é€šå¸¸ä¼šæŒæœ‰æ¥æ”¶è€…ï¼Œå¹¶è°ƒç”¨æ¥æ”¶è€…çš„åŠŸèƒ½æ¥å®Œæˆå‘½ä»¤è¦æ‰§è¡Œçš„æ“ä½œã€‚
* å®ç°è€…/æ¥æ”¶è€…ï¼ˆReceiverï¼‰è§’è‰²ï¼š æ¥æ”¶è€…ï¼ŒçœŸæ­£æ‰§è¡Œå‘½ä»¤çš„å¯¹è±¡ã€‚ä»»ä½•ç±»éƒ½å¯èƒ½æˆä¸ºä¸€ä¸ªæ¥æ”¶è€…ï¼Œåªè¦å®ƒèƒ½å¤Ÿå®ç°å‘½ä»¤è¦æ±‚å®ç°çš„ç›¸åº”åŠŸèƒ½ã€‚
* è°ƒç”¨è€…/è¯·æ±‚è€…ï¼ˆInvokerï¼‰è§’è‰²ï¼š è¦æ±‚å‘½ä»¤å¯¹è±¡æ‰§è¡Œè¯·æ±‚ï¼Œé€šå¸¸ä¼šæŒæœ‰å‘½ä»¤å¯¹è±¡ï¼Œå¯ä»¥æŒæœ‰å¾ˆå¤šçš„å‘½ä»¤å¯¹è±¡ã€‚è¿™ä¸ªæ˜¯å®¢æˆ·ç«¯çœŸæ­£è§¦å‘å‘½ä»¤å¹¶è¦æ±‚å‘½ä»¤æ‰§è¡Œç›¸åº”æ“ä½œçš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯è¯´ç›¸å½“äºä½¿ç”¨å‘½ä»¤å¯¹è±¡çš„å…¥å£ã€‚





##### 6.1 ç¤ºä¾‹

æ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œæˆ‘ä»¬å‡ºå»åƒé¥­éƒ½ä¼šé‡åˆ°ä¸‹é¢çš„åœºæ™¯ã€‚

<img src="å·¥ç¨‹ç´ å…»ç¯‡ï¼ˆä¸­çº§ï¼‰.assets/image-20200211130313251.png" style="zoom:60%;" />



å°†ä¸Šé¢çš„æ¡ˆä¾‹ç”¨ä»£ç å®ç°ï¼Œé‚£æˆ‘ä»¬å°±éœ€è¦åˆ†æå‘½ä»¤æ¨¡å¼çš„è§’è‰²åœ¨è¯¥æ¡ˆä¾‹ä¸­ç”±è°æ¥å……å½“ã€‚

æœåŠ¡å‘˜ï¼š å°±æ˜¯è°ƒç”¨è€…è§’è‰²ï¼Œç”±å¥¹æ¥å‘èµ·å‘½ä»¤ã€‚

èµ„æ·±å¤§å¨ï¼š å°±æ˜¯æ¥æ”¶è€…è§’è‰²ï¼ŒçœŸæ­£å‘½ä»¤æ‰§è¡Œçš„å¯¹è±¡ã€‚

è®¢å•ï¼š å‘½ä»¤ä¸­åŒ…å«è®¢å•ã€‚

ç±»å›¾å¦‚ä¸‹ï¼š

<img src="å·¥ç¨‹ç´ å…»ç¯‡ï¼ˆä¸­çº§ï¼‰.assets/å‘½ä»¤æ¨¡å¼.png" style="zoom:75%;" />

OrderCommandå¯¹è±¡å®ç°Commandæ¥å£ï¼Œèšåˆäº†æ¥æ”¶è€…ç±»ï¼ˆå¨å¸ˆï¼‰å’Œè®¢å•ã€‚

è¯·æ±‚è€…ï¼ˆæœåŠ¡å‘˜ï¼‰èšåˆå‘½ä»¤å¯¹è±¡åˆ—è¡¨ï¼Œå¹¶å®ç°orderUp()æ–¹æ³•ï¼Œç”¨äºè°ƒç”¨æ¯ä¸ªå‘½ä»¤å¯¹è±¡ä¸­çš„æ‰§è¡Œæ–¹æ³•ï¼ˆè°ƒç”¨æ¥å—è€…çš„æ‰§è¡Œæ–¹æ³•ï¼‰ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```java
public interface Command {
    void execute();//åªéœ€è¦å®šä¹‰ä¸€ä¸ªç»Ÿä¸€çš„æ‰§è¡Œæ–¹æ³•
}

public class OrderCommand implements Command {

    //æŒæœ‰æ¥å—è€…å¯¹è±¡
    private SeniorChef receiver;
    private Order order;

    public OrderCommand(SeniorChef receiver, Order order){
        this.receiver = receiver;
        this.order = order;
    }

    public void execute()  {
        System.out.println(order.getDiningTable() + "æ¡Œçš„è®¢å•ï¼š");
        Set<String> keys = order.getFoodDic().keySet();
        for (String key : keys) {
            receiver.makeFood(order.getFoodDic().get(key),key);
        }

        try {
            Thread.sleep(100);//åœé¡¿ä¸€ä¸‹ æ¨¡æ‹Ÿåšé¥­çš„è¿‡ç¨‹
        } catch (InterruptedException e) {
            e.printStackTrace();
        }


        System.out.println(order.getDiningTable() + "æ¡Œçš„é¥­å¼„å¥½äº†");
    }
}

public class Order {
    // é¤æ¡Œå·ç 
    private int diningTable;

    // ç”¨æ¥å­˜å‚¨é¤åå¹¶è®°å½•ä»½æ•°
    private Map<String, Integer> foodDic = new HashMap<String, Integer>();

    public int getDiningTable() {
        return diningTable;
    }

    public void setDiningTable(int diningTable) {
        this.diningTable = diningTable;
    }

    public Map<String, Integer> getFoodDic() {
        return foodDic;
    }

    public void setFoodDic(String name, int num) {
        foodDic.put(name,num);
    }
}

// èµ„æ·±å¤§å¨ç±» æ˜¯å‘½ä»¤çš„Receiver
public class SeniorChef {

    public void makeFood(int num,String foodName) {
        System.out.println(num + "ä»½" + foodName);
    }
}

public class Waitor {

    private ArrayList<Command> commands;//å¯ä»¥æŒæœ‰å¾ˆå¤šçš„å‘½ä»¤å¯¹è±¡

    public Waitor() {
        commands = new ArrayList();
    }
    
    public void setCommand(Command cmd){
        commands.add(cmd);
    }

    // å‘å‡ºå‘½ä»¤ å–Š è®¢å•æ¥äº†ï¼Œå¨å¸ˆå¼€å§‹æ‰§è¡Œ
    public void orderUp() {
        System.out.println("ç¾å¥³æœåŠ¡å‘˜ï¼šå®å’šï¼Œå¤§å¨ï¼Œæ–°è®¢å•æ¥äº†.......");
        for (int i = 0; i < commands.size(); i++) {
            Command cmd = commands.get(i);
            if (cmd != null) {
                cmd.execute();
            }
        }
    }
}

public class Client {
    public static void main(String[] args) {
        //åˆ›å»º2ä¸ªorder
        Order order1 = new Order();
        order1.setDiningTable(1);
        order1.getFoodDic().put("è¥¿çº¢æŸ¿é¸¡è›‹é¢",1);
        order1.getFoodDic().put("å°æ¯å¯ä¹",2);

        Order order2 = new Order();
        order2.setDiningTable(3);
        order2.getFoodDic().put("å°–æ¤’è‚‰ä¸ç›–é¥­",1);
        order2.getFoodDic().put("å°æ¯é›ªç¢§",1);

        //åˆ›å»ºæ¥æ”¶è€…
        SeniorChef receiver=new SeniorChef();
        //å°†è®¢å•å’Œæ¥æ”¶è€…å°è£…æˆå‘½ä»¤å¯¹è±¡
        OrderCommand cmd1 = new OrderCommand(receiver, order1);
        OrderCommand cmd2 = new OrderCommand(receiver, order2);
        //åˆ›å»ºè°ƒç”¨è€… waitor
        Waitor invoker = new Waitor();
        invoker.setCommand(cmd1);
        invoker.setCommand(cmd2);

        //å°†è®¢å•å¸¦åˆ°æŸœå° å¹¶å‘å¨å¸ˆå–Š è®¢å•æ¥äº†
        invoker.orderUp();
    }
}
```



##### 6.2 æºç åº”ç”¨--Runable

Runableæ˜¯ä¸€ä¸ªå…¸å‹å‘½ä»¤æ¨¡å¼ï¼ŒRunnableæ‹…å½“å‘½ä»¤çš„è§’è‰²ï¼ŒThreadå……å½“çš„æ˜¯è°ƒç”¨è€…ï¼Œstartæ–¹æ³•å°±æ˜¯å…¶æ‰§è¡Œæ–¹æ³•

```java
//å‘½ä»¤æ¥å£(æŠ½è±¡å‘½ä»¤è§’è‰²)
public interface Runnable {
	public abstract void run();
}

//è°ƒç”¨è€…
public class Thread implements Runnable {
    private Runnable target;
    
    public synchronized void start() {
        if (threadStatus != 0)
            throw new IllegalThreadStateException();

        group.add(this);

        boolean started = false;
        try {
            start0();
            started = true;
        } finally {
            try {
                if (!started) {
                    group.threadStartFailed(this);
                }
            } catch (Throwable ignore) {
            }
        }
    }
    
    private native void start0();
}
```

ä¼šè°ƒç”¨ä¸€ä¸ªnativeæ–¹æ³•start0(),è°ƒç”¨ç³»ç»Ÿæ–¹æ³•ï¼Œå¼€å¯ä¸€ä¸ªçº¿ç¨‹ã€‚è€Œæ¥æ”¶è€…æ˜¯å¯¹ç¨‹åºå‘˜å¼€æ”¾çš„ï¼Œå¯ä»¥è‡ªå·±å®šä¹‰æ¥æ”¶è€…ã€‚

```java
/**
 * jdk Runnable å‘½ä»¤æ¨¡å¼
 *		TurnOffThread ï¼š å±äºå…·ä½“å‘½ä»¤è§’è‰²ï¼ŒåŒæ—¶èµ·åˆ°è¯·æ±‚è€…çš„ä½œç”¨
 */
public class TurnOffThread implements Runnable{
     private Receiver receiver;
    
     public TurnOffThread(Receiver receiver) {
     	this.receiver = receiver;
     }
     public void run() {
     	receiver.turnOFF();
     }
}
```

```java
/**
 * æµ‹è¯•ç±»
 */
public class Demo {
     public static void main(String[] args) {
         Receiver receiver = new Receiver();
         TurnOffThread turnOffThread = new TurnOffThread(receiver);
         Thread thread = new Thread(turnOffThread);
         thread.start();
     }
}
```



#### 7.ä¸­ä»‹è€…æ¨¡å¼

**å®šä¹‰ï¼š**

åˆå«è°ƒåœæ¨¡å¼ï¼Œå®šä¹‰ä¸€ä¸ªä¸­ä»‹è§’è‰²æ¥å°è£…ä¸€ç³»åˆ—å¯¹è±¡ä¹‹é—´çš„äº¤äº’ï¼Œä½¿åŸæœ‰å¯¹è±¡ä¹‹é—´çš„è€¦åˆæ¾æ•£ï¼Œä¸”å¯ä»¥ç‹¬ç«‹åœ°æ”¹å˜å®ƒä»¬ä¹‹é—´çš„äº¤äº’ã€‚

**ä¸€å¥è¯ç†è§£ï¼š**

ä½¿ç”¨ä¸­ä»‹è€…ç®¡ç†åŒäº‹ç±»ä¹‹é—´çš„äº¤äº’ï¼Œå½¢æˆæ˜Ÿå‹ç»“æ„ä»¥é™ä½è€¦åˆåº¦ã€‚

<img src="å·¥ç¨‹ç´ å…»ç¯‡ï¼ˆä¸­çº§ï¼‰.assets/image-20251201200727026.png" alt="image-20251201200727026" style="zoom:67%;" />



**ä¸â€œä»£ç†æ¨¡å¼â€çš„åŒºåˆ«ï¼š**

ä»£ç æ¨¡å¼æ›´å¤šçš„æ˜¯ä»£ç†ï¼Œç±»ä¼¼äºä»£æ›¿åšæŸä»¶äº‹ï¼Œå¦‚ä»£é©¾ã€‚

ä¸­ä»‹è€…æ¨¡å¼æ›´å¤šçš„æ˜¯å……å½“åŒäº‹ç±»å¯¹è±¡çš„ä¸­ä»‹è€…ã€‚



ä¸­ä»‹è€…æ¨¡å¼åŒ…å«ä»¥ä¸‹ä¸»è¦è§’è‰²ï¼š

* æŠ½è±¡ä¸­ä»‹è€…ï¼ˆMediatorï¼‰è§’è‰²ï¼šå®ƒæ˜¯ä¸­ä»‹è€…çš„æ¥å£ï¼Œæä¾›äº†åŒäº‹å¯¹è±¡æ³¨å†Œä¸è½¬å‘åŒäº‹å¯¹è±¡ä¿¡æ¯çš„æŠ½è±¡æ–¹æ³•ã€‚

* å…·ä½“ä¸­ä»‹è€…ï¼ˆConcreteMediatorï¼‰è§’è‰²ï¼šå®ç°ä¸­ä»‹è€…æ¥å£ï¼Œå®šä¹‰ä¸€ä¸ª List æ¥ç®¡ç†åŒäº‹å¯¹è±¡ï¼Œåè°ƒå„ä¸ªåŒäº‹è§’è‰²ä¹‹é—´çš„äº¤äº’å…³ç³»ï¼Œå› æ­¤å®ƒä¾èµ–äºåŒäº‹è§’è‰²ã€‚
* æŠ½è±¡åŒäº‹ç±»ï¼ˆColleagueï¼‰è§’è‰²ï¼šå®šä¹‰åŒäº‹ç±»çš„æ¥å£ï¼Œä¿å­˜ä¸­ä»‹è€…å¯¹è±¡ï¼Œæä¾›åŒäº‹å¯¹è±¡äº¤äº’çš„æŠ½è±¡æ–¹æ³•ï¼Œå®ç°æ‰€æœ‰ç›¸äº’å½±å“çš„åŒäº‹ç±»çš„å…¬å…±åŠŸèƒ½ã€‚
* å…·ä½“åŒäº‹ç±»ï¼ˆConcrete Colleagueï¼‰è§’è‰²ï¼šæ˜¯æŠ½è±¡åŒäº‹ç±»çš„å®ç°è€…ï¼Œå½“éœ€è¦ä¸å…¶ä»–åŒäº‹å¯¹è±¡äº¤äº’æ—¶ï¼Œç”±ä¸­ä»‹è€…å¯¹è±¡è´Ÿè´£åç»­çš„äº¤äº’ã€‚



##### 7.1 ç¤ºä¾‹

ã€ä¾‹ã€‘ç§Ÿæˆ¿

ç°åœ¨ç§Ÿæˆ¿åŸºæœ¬éƒ½æ˜¯é€šè¿‡æˆ¿å±‹ä¸­ä»‹ï¼Œæˆ¿ä¸»å°†æˆ¿å±‹æ‰˜ç®¡ç»™æˆ¿å±‹ä¸­ä»‹ï¼Œè€Œç§Ÿæˆ¿è€…ä»æˆ¿å±‹ä¸­ä»‹è·å–æˆ¿å±‹ä¿¡æ¯ã€‚æˆ¿å±‹ä¸­ä»‹å……å½“ç§Ÿæˆ¿è€…ä¸æˆ¿å±‹æ‰€æœ‰è€…ä¹‹é—´çš„ä¸­ä»‹è€…ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```java
//æŠ½è±¡ä¸­ä»‹è€…
public abstract class Mediator {
    //ç”³æ˜ä¸€ä¸ªè”ç»œæ–¹æ³•
    public abstract void constact(String message,Person person);
}

//æŠ½è±¡åŒäº‹ç±»
public abstract class Person {
    protected String name;
    protected Mediator mediator;

    public Person(String name,Mediator mediator){
        this.name = name;
        this.mediator = mediator;
    }
}

//å…·ä½“åŒäº‹ç±» æˆ¿å±‹æ‹¥æœ‰è€…
public class HouseOwner extends Person {

    public HouseOwner(String name, Mediator mediator) {
        super(name, mediator);
    }

    //ä¸ä¸­ä»‹è€…è”ç³»
    public void constact(String message){
        mediator.constact(message, this);
    }

    //è·å–ä¿¡æ¯
    public void getMessage(String message){
        System.out.println("æˆ¿ä¸»" + name +"è·å–åˆ°çš„ä¿¡æ¯ï¼š" + message);
    }
}

//å…·ä½“åŒäº‹ç±» æ‰¿ç§Ÿäºº
public class Tenant extends Person {
    public Tenant(String name, Mediator mediator) {
        super(name, mediator);
    }

    //ä¸ä¸­ä»‹è€…è”ç³»
    public void constact(String message){
        mediator.constact(message, this);
    }

    //è·å–ä¿¡æ¯
    public void getMessage(String message){
        System.out.println("ç§Ÿæˆ¿è€…" + name +"è·å–åˆ°çš„ä¿¡æ¯ï¼š" + message);
    }
}

//ä¸­ä»‹æœºæ„
public class MediatorStructure extends Mediator {
    //é¦–å…ˆä¸­ä»‹ç»“æ„å¿…é¡»çŸ¥é“æ‰€æœ‰æˆ¿ä¸»å’Œç§Ÿæˆ¿è€…çš„ä¿¡æ¯
    private HouseOwner houseOwner;
    private Tenant tenant;

    public HouseOwner getHouseOwner() {
        return houseOwner;
    }

    public void setHouseOwner(HouseOwner houseOwner) {
        this.houseOwner = houseOwner;
    }

    public Tenant getTenant() {
        return tenant;
    }

    public void setTenant(Tenant tenant) {
        this.tenant = tenant;
    }

    public void constact(String message, Person person) {
        if (person == houseOwner) {          //å¦‚æœæ˜¯æˆ¿ä¸»ï¼Œåˆ™ç§Ÿæˆ¿è€…è·å¾—ä¿¡æ¯
            tenant.getMessage(message);
        } else {       //åä¹‹åˆ™æ˜¯æˆ¿ä¸»è·å¾—ä¿¡æ¯
            houseOwner.getMessage(message);
        }
    }
}

//æµ‹è¯•ç±»
public class Client {
    public static void main(String[] args) {
        //ä¸€ä¸ªæˆ¿ä¸»ã€ä¸€ä¸ªç§Ÿæˆ¿è€…ã€ä¸€ä¸ªä¸­ä»‹æœºæ„
        MediatorStructure mediator = new MediatorStructure();

        //æˆ¿ä¸»å’Œç§Ÿæˆ¿è€…åªéœ€è¦çŸ¥é“ä¸­ä»‹æœºæ„å³å¯
        HouseOwner houseOwner = new HouseOwner("å¼ ä¸‰", mediator);
        Tenant tenant = new Tenant("æå››", mediator);

        //ä¸­ä»‹ç»“æ„è¦çŸ¥é“æˆ¿ä¸»å’Œç§Ÿæˆ¿è€…
        mediator.setHouseOwner(houseOwner);
        mediator.setTenant(tenant);

        tenant.constact("éœ€è¦ç§Ÿä¸‰å®¤çš„æˆ¿å­");
        houseOwner.constact("æˆ‘è¿™æœ‰ä¸‰å®¤çš„æˆ¿å­ï¼Œä½ éœ€è¦ç§Ÿå—ï¼Ÿ");
    }
}
```



#### 8. è¿­ä»£å™¨æ¨¡å¼

**å®šä¹‰ï¼š**

æä¾›ä¸€ä¸ªå¯¹è±¡æ¥é¡ºåºè®¿é—®èšåˆå¯¹è±¡ä¸­çš„ä¸€ç³»åˆ—æ•°æ®ï¼Œè€Œä¸æš´éœ²èšåˆå¯¹è±¡çš„å†…éƒ¨è¡¨ç¤ºã€‚ 



**ä¸€å¥è¯ç†è§£ï¼š**

ä½¿ç”¨è¿­ä»£å™¨å¯¹è±¡ç”¨äºè®¿é—®èšåˆå¯¹è±¡ï¼ˆå¦‚å®¹å™¨Listï¼‰ä¸­çš„æ•°æ®ï¼Œè€Œä¸æš´éœ²èšåˆå¯¹è±¡çš„å†…éƒ¨è¡¨ç¤ºã€‚

è¿­ä»£å™¨æ¨¡å¼ä¸»è¦åŒ…å«ä»¥ä¸‹è§’è‰²ï¼š

* æŠ½è±¡èšåˆï¼ˆAggregateï¼‰è§’è‰²ï¼šå®šä¹‰å­˜å‚¨ã€æ·»åŠ ã€åˆ é™¤èšåˆå…ƒç´ ä»¥åŠåˆ›å»ºè¿­ä»£å™¨å¯¹è±¡çš„æ¥å£ã€‚

* å…·ä½“èšåˆï¼ˆConcreteAggregateï¼‰è§’è‰²ï¼šå®ç°æŠ½è±¡èšåˆç±»ï¼Œè¿”å›ä¸€ä¸ªå…·ä½“è¿­ä»£å™¨çš„å®ä¾‹ã€‚
* æŠ½è±¡è¿­ä»£å™¨ï¼ˆIteratorï¼‰è§’è‰²ï¼šå®šä¹‰è®¿é—®å’Œéå†èšåˆå…ƒç´ çš„æ¥å£ï¼Œé€šå¸¸åŒ…å« hasNext()ã€next() ç­‰æ–¹æ³•ã€‚
* å…·ä½“è¿­ä»£å™¨ï¼ˆConcretelteratorï¼‰è§’è‰²ï¼šå®ç°æŠ½è±¡è¿­ä»£å™¨æ¥å£ä¸­æ‰€å®šä¹‰çš„æ–¹æ³•ï¼Œå®Œæˆå¯¹èšåˆå¯¹è±¡çš„éå†ï¼Œè®°å½•éå†çš„å½“å‰ä½ç½®ã€‚



##### 8.1 ç¤ºä¾‹

ã€ä¾‹ã€‘å®šä¹‰ä¸€ä¸ªå¯ä»¥å­˜å‚¨å­¦ç”Ÿå¯¹è±¡çš„å®¹å™¨å¯¹è±¡ï¼Œå°†éå†è¯¥å®¹å™¨çš„åŠŸèƒ½äº¤ç”±è¿­ä»£å™¨å®ç°

ä»£ç å¦‚ä¸‹ï¼š

å®šä¹‰è¿­ä»£å™¨æ¥å£ï¼Œå£°æ˜hasNextã€nextæ–¹æ³•

```java
public interface StudentIterator {
    boolean hasNext();
    Student next();
}
```

å®šä¹‰å…·ä½“çš„è¿­ä»£å™¨ç±»ï¼Œé‡å†™æ‰€æœ‰çš„æŠ½è±¡æ–¹æ³•

```java
public class StudentIteratorImpl implements StudentIterator {
    private List<Student> list;
    private int position = 0;

    public StudentIteratorImpl(List<Student> list) {
        this.list = list;
    }

    @Override
    public boolean hasNext() {
        return position < list.size();
    }

    @Override
    public Student next() {
        Student currentStudent = list.get(position);
        position ++;
        return currentStudent;
    }
}
```

å®šä¹‰æŠ½è±¡å®¹å™¨ç±»ï¼ŒåŒ…å«æ·»åŠ å…ƒç´ ï¼Œåˆ é™¤å…ƒç´ ï¼Œè·å–è¿­ä»£å™¨å¯¹è±¡çš„æ–¹æ³•

```java
public interface StudentAggregate {
    void addStudent(Student student);

    void removeStudent(Student student);

    StudentIterator getStudentIterator();
}
```

å®šä¹‰å…·ä½“çš„å®¹å™¨ç±»ï¼Œé‡å†™æ‰€æœ‰çš„æ–¹æ³•

```java
public class StudentAggregateImpl implements StudentAggregate {

    private List<Student> list = new ArrayList<Student>();  // å­¦ç”Ÿåˆ—è¡¨

    @Override
    public void addStudent(Student student) {
        this.list.add(student);
    }

    @Override
    public void removeStudent(Student student) {
        this.list.remove(student);
    }

    @Override
    public StudentIterator getStudentIterator() {
        return new StudentIteratorImpl(list);
    }
}
```







##### 8.2 æºç åº”ç”¨--ArrayList

è¿­ä»£å™¨æ¨¡å¼åœ¨JAVAçš„å¾ˆå¤šé›†åˆç±»ä¸­è¢«å¹¿æ³›åº”ç”¨ï¼Œæ¥ä¸‹æ¥çœ‹çœ‹JAVAæºç ä¸­æ˜¯å¦‚ä½•ä½¿ç”¨è¿­ä»£å™¨æ¨¡å¼çš„ã€‚

```java
List<String> list = new ArrayList<>();
Iterator<String> iterator = list.iterator(); //list.iterator()æ–¹æ³•è¿”å›çš„è‚¯å®šæ˜¯Iteratoræ¥å£çš„å­å®ç°ç±»å¯¹è±¡
while (iterator.hasNext()) {
    System.out.println(iterator.next());
}
```

çœ‹å®Œè¿™æ®µä»£ç æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œä¸æˆ‘ä»¬ä¸Šé¢ä»£ç åŸºæœ¬ç±»ä¼¼ã€‚å•åˆ—é›†åˆéƒ½ä½¿ç”¨åˆ°äº†è¿­ä»£å™¨ï¼Œæˆ‘ä»¬ä»¥ArrayListä¸¾ä¾‹æ¥è¯´æ˜

- Listï¼šæŠ½è±¡èšåˆç±»
- ArrayListï¼šå…·ä½“çš„èšåˆç±»
- Iteratorï¼šæŠ½è±¡è¿­ä»£å™¨
- list.iterator()ï¼šè¿”å›çš„æ˜¯å®ç°äº† `Iterator` æ¥å£çš„å…·ä½“è¿­ä»£å™¨å¯¹è±¡ï¼ˆå†…éƒ¨ç±»ï¼‰

å…·ä½“çš„æ¥çœ‹çœ‹ ArrayListçš„ä»£ç å®ç°

```java
public class ArrayList<E> extends AbstractList<E>
        implements List<E>, RandomAccess, Cloneable, java.io.Serializable {
    
    public Iterator<E> iterator() {
        return new Itr();
    }
    
    private class Itr implements Iterator<E> {
        int cursor;       // ä¸‹ä¸€ä¸ªè¦è¿”å›å…ƒç´ çš„ç´¢å¼•
        int lastRet = -1; // ä¸Šä¸€ä¸ªè¿”å›å…ƒç´ çš„ç´¢å¼•
        int expectedModCount = modCount;

        Itr() {}
		
        //åˆ¤æ–­æ˜¯å¦è¿˜æœ‰å…ƒç´ 
        public boolean hasNext() {
            return cursor != size;
        }

        //è·å–ä¸‹ä¸€ä¸ªå…ƒç´ 
        public E next() {
            checkForComodification();
            int i = cursor;
            if (i >= size)
                throw new NoSuchElementException();
            Object[] elementData = ArrayList.this.elementData;
            if (i >= elementData.length)
                throw new ConcurrentModificationException();
            cursor = i + 1;
            return (E) elementData[lastRet = i];
        }
        ...
}
```

è¿™éƒ¨åˆ†ä»£ç è¿˜æ˜¯æ¯”è¾ƒç®€å•ï¼Œå¤§è‡´å°±æ˜¯åœ¨ `iterator` æ–¹æ³•ä¸­è¿”å›äº†ä¸€ä¸ªå®ä¾‹åŒ–çš„ `Iterator` å¯¹è±¡ã€‚**Itræ˜¯ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œå®ƒå®ç°äº† `Iterator` æ¥å£å¹¶é‡å†™äº†å…¶ä¸­çš„æŠ½è±¡æ–¹æ³•**ã€‚



#### 9. è®¿é—®è€…æ¨¡å¼

**å®šä¹‰ï¼š**

å°è£…ä¸€äº›ä½œç”¨äºæŸç§æ•°æ®ç»“æ„ä¸­çš„å„å…ƒç´ çš„æ“ä½œï¼Œå®ƒå¯ä»¥åœ¨ä¸æ”¹å˜è¿™ä¸ªæ•°æ®ç»“æ„çš„å‰æä¸‹å®šä¹‰ä½œç”¨äºè¿™äº›å…ƒç´ çš„æ–°çš„æ“ä½œã€‚

**ä¸€å¥è¯ç†è§£ï¼š**

ä½¿ç”¨è®¿é—®è€…å¯¹è±¡å°è£…äº†æŸç§æ•°æ®ç»“æ„ä¸­çš„å„å…ƒç´ çš„æ“ä½œï¼Œå¹¶å¯æ–°å¢æ“ä½œè€Œä¸æ”¹å˜è¯¥æ•°æ®ç»“æ„ï¼ŒåŒæ—¶é€šè¿‡åŒåˆ†æ´¾å®ç°åŠ¨æ€ç»‘å®šï¼ˆe.accept(vistor)ã€‚



è®¿é—®è€…æ¨¡å¼åŒ…å«ä»¥ä¸‹ä¸»è¦è§’è‰²:

* æŠ½è±¡è®¿é—®è€…ï¼ˆVisitorï¼‰è§’è‰²ï¼šå®šä¹‰äº†å¯¹æ¯ä¸€ä¸ªå…ƒç´ `ï¼ˆElementï¼‰`è®¿é—®çš„è¡Œä¸ºï¼Œå®ƒçš„å‚æ•°å°±æ˜¯å¯ä»¥è®¿é—®çš„å…ƒç´ ï¼Œå®ƒçš„æ–¹æ³•ä¸ªæ•°ç†è®ºä¸Šæ¥è®²ä¸å…ƒç´ ç±»ä¸ªæ•°ï¼ˆElementçš„å®ç°ç±»ä¸ªæ•°ï¼‰æ˜¯ä¸€æ ·çš„ï¼Œä»è¿™ç‚¹ä¸éš¾çœ‹å‡ºï¼Œè®¿é—®è€…æ¨¡å¼è¦æ±‚å…ƒç´ ç±»çš„ä¸ªæ•°ä¸èƒ½æ”¹å˜ã€‚
* å…·ä½“è®¿é—®è€…ï¼ˆConcreteVisitorï¼‰è§’è‰²ï¼šç»™å‡ºå¯¹æ¯ä¸€ä¸ªå…ƒç´ ç±»è®¿é—®æ—¶æ‰€äº§ç”Ÿçš„å…·ä½“è¡Œä¸ºã€‚
* æŠ½è±¡å…ƒç´ ï¼ˆElementï¼‰è§’è‰²ï¼šå®šä¹‰äº†ä¸€ä¸ªæ¥å—è®¿é—®è€…çš„æ–¹æ³•ï¼ˆ`accept`ï¼‰ï¼Œå…¶æ„ä¹‰æ˜¯æŒ‡ï¼Œæ¯ä¸€ä¸ªå…ƒç´ éƒ½è¦å¯ä»¥è¢«è®¿é—®è€…è®¿é—®ã€‚
* å…·ä½“å…ƒç´ ï¼ˆConcreteElementï¼‰è§’è‰²ï¼š æä¾›æ¥å—è®¿é—®æ–¹æ³•çš„å…·ä½“å®ç°ï¼Œè€Œè¿™ä¸ªå…·ä½“çš„å®ç°ï¼Œé€šå¸¸æƒ…å†µä¸‹æ˜¯ä½¿ç”¨è®¿é—®è€…æä¾›çš„è®¿é—®è¯¥å…ƒç´ ç±»çš„æ–¹æ³•ã€‚
* å¯¹è±¡ç»“æ„ï¼ˆObject Structureï¼‰è§’è‰²ï¼šå®šä¹‰å½“ä¸­æ‰€æåˆ°çš„å¯¹è±¡ç»“æ„ï¼Œå¯¹è±¡ç»“æ„æ˜¯ä¸€ä¸ªæŠ½è±¡è¡¨è¿°ï¼Œå…·ä½“ç‚¹å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå…·æœ‰å®¹å™¨æ€§è´¨æˆ–è€…å¤åˆå¯¹è±¡ç‰¹æ€§çš„ç±»ï¼Œå®ƒä¼šå«æœ‰ä¸€ç»„å…ƒç´ ï¼ˆ`Element`ï¼‰ï¼Œå¹¶ä¸”å¯ä»¥è¿­ä»£è¿™äº›å…ƒç´ ï¼Œä¾›è®¿é—®è€…è®¿é—®ã€‚

##### 9.1 ç¤ºä¾‹

ã€ä¾‹ã€‘ç»™å® ç‰©å–‚é£Ÿ

ç°åœ¨å…»å® ç‰©çš„äººç‰¹åˆ«å¤šï¼Œæˆ‘ä»¬å°±ä»¥è¿™ä¸ªä¸ºä¾‹ï¼Œå½“ç„¶å® ç‰©è¿˜åˆ†ä¸ºç‹—ï¼ŒçŒ«ç­‰ï¼Œè¦ç»™å® ç‰©å–‚é£Ÿçš„è¯ï¼Œä¸»äººå¯ä»¥å–‚ï¼Œå…¶ä»–äººä¹Ÿå¯ä»¥å–‚é£Ÿã€‚

- è®¿é—®è€…è§’è‰²ï¼šç»™å® ç‰©å–‚é£Ÿçš„äºº
- å…·ä½“è®¿é—®è€…è§’è‰²ï¼šä¸»äººã€å…¶ä»–äºº
- æŠ½è±¡å…ƒç´ è§’è‰²ï¼šåŠ¨ç‰©æŠ½è±¡ç±»
- å…·ä½“å…ƒç´ è§’è‰²ï¼šå® ç‰©ç‹—ã€å® ç‰©çŒ«
- ç»“æ„å¯¹è±¡è§’è‰²ï¼šä¸»äººå®¶

ä»£ç å¦‚ä¸‹ï¼š

åˆ›å»ºæŠ½è±¡è®¿é—®è€…æ¥å£

```java
public interface Person {
    void feed(Cat cat);

    void feed(Dog dog);
}
```

åˆ›å»ºä¸åŒçš„å…·ä½“è®¿é—®è€…è§’è‰²ï¼ˆä¸»äººå’Œå…¶ä»–äººï¼‰ï¼Œéƒ½éœ€è¦å®ç° `Person`æ¥å£

```java
public class Owner implements Person {

    @Override
    public void feed(Cat cat) {
        System.out.println("ä¸»äººå–‚é£ŸçŒ«");
    }

    @Override
    public void feed(Dog dog) {
        System.out.println("ä¸»äººå–‚é£Ÿç‹—");
    }
}

public class Someone implements Person {
    @Override
    public void feed(Cat cat) {
        System.out.println("å…¶ä»–äººå–‚é£ŸçŒ«");
    }

    @Override
    public void feed(Dog dog) {
        System.out.println("å…¶ä»–äººå–‚é£Ÿç‹—");
    }
}
```

- è®¿é—®è€…å¯¹è±¡å®šä¹‰äº†é’ˆå¯¹å…ƒç´ çš„å…·ä½“åŠ¨ä½œï¼Œæœ‰å¤šå°‘ä¸ªå…·ä½“å…ƒç´ å°±æœ‰å‡ ä¸ªæ–¹æ³•ã€‚

å®šä¹‰æŠ½è±¡èŠ‚ç‚¹ -- å® ç‰©

```java
public interface Animal {
    void accept(Person person);
}
```

å®šä¹‰å®ç°`Animal`æ¥å£çš„ å…·ä½“èŠ‚ç‚¹ï¼ˆå…ƒç´ ï¼‰

```java
public class Dog implements Animal {

    @Override
    public void accept(Person person) {
        person.feed(this);
        System.out.println("å¥½å¥½åƒï¼Œæ±ªæ±ªæ±ªï¼ï¼ï¼");
    }
}

public class Cat implements Animal {

    @Override
    public void accept(Person person) {
        person.feed(this);
        System.out.println("å¥½å¥½åƒï¼Œå–µå–µå–µï¼ï¼ï¼");
    }
}
```

- accept()æ–¹æ³•æ¥æ”¶è®¿é—®è€…ï¼Œå¹¶è°ƒç”¨è®¿é—®è€…ä¸­å®šä¹‰çš„å…·ä½“è¡Œä¸ºæ–¹æ³•



å®šä¹‰å¯¹è±¡ç»“æ„ï¼Œæ­¤æ¡ˆä¾‹ä¸­å°±æ˜¯ä¸»äººçš„å®¶

```java
public class Home {
    private List<Animal> nodeList = new ArrayList<Animal>();

    public void action(Person person) {
        for (Animal node : nodeList) {
            node.accept(person);
        }
    }

    //æ·»åŠ æ“ä½œ
    public void add(Animal animal) {
        nodeList.add(animal);
    }
}

```

æµ‹è¯•ç±»

```java
public class Client {
    public static void main(String[] args) {
        Home home = new Home();
        home.add(new Dog());
        home.add(new Cat());

        Owner owner = new Owner();
        home.action(owner);

        Someone someone = new Someone();
        home.action(someone);
    }
}
```



#### 10. å¤‡å¿˜å½•æ¨¡å¼ï¼ˆå¿«ç…§æ¨¡å¼ï¼‰

å¤‡å¿˜å½•æ¨¡å¼æä¾›äº†ä¸€ç§çŠ¶æ€æ¢å¤çš„å®ç°æœºåˆ¶ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥æ–¹ä¾¿åœ°å›åˆ°ä¸€ä¸ªç‰¹å®šçš„å†å²æ­¥éª¤ï¼Œå½“æ–°çš„çŠ¶æ€æ— æ•ˆæˆ–è€…å­˜åœ¨é—®é¢˜æ—¶ï¼Œå¯ä»¥ä½¿ç”¨æš‚æ—¶å­˜å‚¨èµ·æ¥çš„å¤‡å¿˜å½•å°†çŠ¶æ€å¤åŸï¼Œå¾ˆå¤šè½¯ä»¶éƒ½æä¾›äº†æ’¤é”€ï¼ˆUndoï¼‰æ“ä½œï¼Œå¦‚ Wordã€è®°äº‹æœ¬ã€Photoshopã€IDEAç­‰è½¯ä»¶åœ¨ç¼–è¾‘æ—¶æŒ‰ Ctrl+Z ç»„åˆé”®æ—¶èƒ½æ’¤é”€å½“å‰æ“ä½œï¼Œä½¿æ–‡æ¡£æ¢å¤åˆ°ä¹‹å‰çš„çŠ¶æ€ï¼›è¿˜æœ‰åœ¨ æµè§ˆå™¨ ä¸­çš„åé€€é”®ã€æ•°æ®åº“äº‹åŠ¡ç®¡ç†ä¸­çš„å›æ»šæ“ä½œã€ç©æ¸¸æˆæ—¶çš„ä¸­é—´ç»“æœå­˜æ¡£åŠŸèƒ½ã€æ•°æ®åº“ä¸æ“ä½œç³»ç»Ÿçš„å¤‡ä»½æ“ä½œã€æ£‹ç±»æ¸¸æˆä¸­çš„æ‚”æ£‹åŠŸèƒ½ç­‰éƒ½å±äºè¿™ç±»ã€‚

**å®šä¹‰ï¼š**

åˆå«å¿«ç…§æ¨¡å¼ï¼Œåœ¨ä¸ç ´åå°è£…æ€§çš„å‰æä¸‹ï¼Œæ•è·ä¸€ä¸ªå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ï¼Œå¹¶åœ¨è¯¥å¯¹è±¡ä¹‹å¤–ä¿å­˜è¿™ä¸ªçŠ¶æ€ï¼Œä»¥ä¾¿ä»¥åå½“éœ€è¦æ—¶èƒ½å°†è¯¥å¯¹è±¡æ¢å¤åˆ°åŸå…ˆä¿å­˜çš„çŠ¶æ€ã€‚

**ä¸€å¥è¯ç†è§£ï¼š**

å¿«ç…§ï¼Œæ•è·å¹¶ä¿å­˜ä¸€ä¸ªå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ï¼Œä¾¿äºåç»­æ¢å¤æˆ–å›æ»šã€‚



å¤‡å¿˜å½•æ¨¡å¼çš„ä¸»è¦è§’è‰²å¦‚ä¸‹ï¼š

* å‘èµ·äººï¼ˆOriginatorï¼‰è§’è‰²ï¼šè®°å½•å½“å‰æ—¶åˆ»çš„å†…éƒ¨çŠ¶æ€ä¿¡æ¯ï¼Œæä¾›åˆ›å»ºå¤‡å¿˜å½•å’Œæ¢å¤å¤‡å¿˜å½•æ•°æ®çš„åŠŸèƒ½ï¼Œå®ç°å…¶ä»–ä¸šåŠ¡åŠŸèƒ½ï¼Œå®ƒå¯ä»¥è®¿é—®å¤‡å¿˜å½•é‡Œçš„æ‰€æœ‰ä¿¡æ¯ã€‚
* å¤‡å¿˜å½•ï¼ˆMementoï¼‰è§’è‰²ï¼šè´Ÿè´£å­˜å‚¨å‘èµ·äººçš„å†…éƒ¨çŠ¶æ€ï¼Œåœ¨éœ€è¦çš„æ—¶å€™æä¾›è¿™äº›å†…éƒ¨çŠ¶æ€ç»™å‘èµ·äººã€‚
* ç®¡ç†è€…ï¼ˆCaretakerï¼‰è§’è‰²ï¼šå¯¹å¤‡å¿˜å½•è¿›è¡Œç®¡ç†ï¼Œæä¾›ä¿å­˜ä¸è·å–å¤‡å¿˜å½•çš„åŠŸèƒ½ï¼Œä½†å…¶ä¸èƒ½å¯¹å¤‡å¿˜å½•çš„å†…å®¹è¿›è¡Œè®¿é—®ä¸ä¿®æ”¹ã€‚

å¤‡å¿˜å½•æœ‰ä¸¤ä¸ªç­‰æ•ˆçš„æ¥å£ï¼š

* **çª„æ¥å£**ï¼šç®¡ç†è€…(Caretaker)å¯¹è±¡ï¼ˆå’Œå…¶ä»–å‘èµ·äººå¯¹è±¡ä¹‹å¤–çš„ä»»ä½•å¯¹è±¡ï¼‰çœ‹åˆ°çš„æ˜¯å¤‡å¿˜å½•çš„çª„æ¥å£(narror Interface)ï¼Œè¿™ä¸ªçª„æ¥å£åªå…è®¸ä»–æŠŠå¤‡å¿˜å½•å¯¹è±¡ä¼ ç»™å…¶ä»–çš„å¯¹è±¡ã€‚
* **å®½æ¥å£**ï¼šä¸ç®¡ç†è€…çœ‹åˆ°çš„çª„æ¥å£ç›¸åï¼Œå‘èµ·äººå¯¹è±¡å¯ä»¥çœ‹åˆ°ä¸€ä¸ªå®½æ¥å£(wide Interface)ï¼Œè¿™ä¸ªå®½æ¥å£å…è®¸å®ƒè¯»å–æ‰€æœ‰çš„æ•°æ®ï¼Œä»¥ä¾¿æ ¹æ®è¿™äº›æ•°æ®æ¢å¤è¿™ä¸ªå‘èµ·äººå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ã€‚



##### 10.1 ç¤ºä¾‹

ã€ä¾‹ã€‘æ¸¸æˆæŒ‘æˆ˜BOSS

æ¸¸æˆä¸­çš„æŸä¸ªåœºæ™¯ï¼Œä¸€æ¸¸æˆè§’è‰²æœ‰ç”Ÿå‘½åŠ›ã€æ”»å‡»åŠ›ã€é˜²å¾¡åŠ›ç­‰æ•°æ®ï¼Œåœ¨æ‰“Bosså‰å’Œåä¸€å®šä¼šä¸ä¸€æ ·çš„ï¼Œæˆ‘ä»¬å…è®¸ç©å®¶å¦‚æœæ„Ÿè§‰ä¸Bosså†³æ–—çš„æ•ˆæœä¸ç†æƒ³å¯ä»¥è®©æ¸¸æˆæ¢å¤åˆ°å†³æ–—ä¹‹å‰çš„çŠ¶æ€ã€‚

è¦å®ç°ä¸Šè¿°æ¡ˆä¾‹ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š

* â€œç™½ç®±â€å¤‡å¿˜å½•æ¨¡å¼
* â€œé»‘ç®±â€å¤‡å¿˜å½•æ¨¡å¼



###### 1ï¼‰â€œç™½ç®±â€å¤‡å¿˜å½•æ¨¡å¼

å¤‡å¿˜å½•è§’è‰²å¯¹ä»»ä½•å¯¹è±¡éƒ½æä¾›ä¸€ä¸ªæ¥å£ï¼Œå³å®½æ¥å£ï¼Œå¤‡å¿˜å½•è§’è‰²çš„å†…éƒ¨æ‰€å­˜å‚¨çš„çŠ¶æ€å°±å¯¹æ‰€æœ‰å¯¹è±¡å…¬å¼€ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```java
//æ¸¸æˆè§’è‰²ç±»
public class GameRole {
    private int vit; //ç”Ÿå‘½åŠ›
    private int atk; //æ”»å‡»åŠ›
    private int def; //é˜²å¾¡åŠ›

    //åˆå§‹åŒ–çŠ¶æ€
    public void initState() {
        this.vit = 100;
        this.atk = 100;
        this.def = 100;
    }

    //æˆ˜æ–—
    public void fight() {
        this.vit = 0;
        this.atk = 0;
        this.def = 0;
    }

    //ä¿å­˜è§’è‰²çŠ¶æ€
    public RoleStateMemento saveState() {
        return new RoleStateMemento(vit, atk, def);
    }

    //å›å¤è§’è‰²çŠ¶æ€
    public void recoverState(RoleStateMemento roleStateMemento) {
        this.vit = roleStateMemento.getVit();
        this.atk = roleStateMemento.getAtk();
        this.def = roleStateMemento.getDef();
    }

    public void stateDisplay() {
        System.out.println("è§’è‰²ç”Ÿå‘½åŠ›ï¼š" + vit);
        System.out.println("è§’è‰²æ”»å‡»åŠ›ï¼š" + atk);
        System.out.println("è§’è‰²é˜²å¾¡åŠ›ï¼š" + def);
    }

    public int getVit() {
        return vit;
    }

    public void setVit(int vit) {
        this.vit = vit;
    }

    public int getAtk() {
        return atk;
    }

    public void setAtk(int atk) {
        this.atk = atk;
    }

    public int getDef() {
        return def;
    }

    public void setDef(int def) {
        this.def = def;
    }
}

//æ¸¸æˆçŠ¶æ€å­˜å‚¨ç±»(å¤‡å¿˜å½•ç±»)
public class RoleStateMemento {
    private int vit;
    private int atk;
    private int def;

    public RoleStateMemento(int vit, int atk, int def) {
        this.vit = vit;
        this.atk = atk;
        this.def = def;
    }

    public int getVit() {
        return vit;
    }

    public void setVit(int vit) {
        this.vit = vit;
    }

    public int getAtk() {
        return atk;
    }

    public void setAtk(int atk) {
        this.atk = atk;
    }

    public int getDef() {
        return def;
    }

    public void setDef(int def) {
        this.def = def;
    }
}

//è§’è‰²çŠ¶æ€ç®¡ç†è€…ç±»
public class RoleStateCaretaker {
    private RoleStateMemento roleStateMemento;

    public RoleStateMemento getRoleStateMemento() {
        return roleStateMemento;
    }

    public void setRoleStateMemento(RoleStateMemento roleStateMemento) {
        this.roleStateMemento = roleStateMemento;
    }
}

//æµ‹è¯•ç±»
public class Client {
    public static void main(String[] args) {
        System.out.println("------------å¤§æˆ˜Bosså‰------------");
        //å¤§æˆ˜Bosså‰
        GameRole gameRole = new GameRole();
        gameRole.initState();
        gameRole.stateDisplay();

        //ä¿å­˜è¿›åº¦
        RoleStateCaretaker roleStateCaretaker = new RoleStateCaretaker();
        roleStateCaretaker.setRoleStateMemento(gameRole.saveState());

        System.out.println("------------å¤§æˆ˜Bosså------------");
        //å¤§æˆ˜Bossæ—¶ï¼ŒæŸè€—ä¸¥é‡
        gameRole.fight();
        gameRole.stateDisplay();
        System.out.println("------------æ¢å¤ä¹‹å‰çŠ¶æ€------------");
        //æ¢å¤ä¹‹å‰çŠ¶æ€
        gameRole.recoverState(roleStateCaretaker.getRoleStateMemento());
        gameRole.stateDisplay();

    }
}
```

> åˆ†æï¼šç™½ç®±å¤‡å¿˜å½•æ¨¡å¼æ˜¯ç ´åå°è£…æ€§çš„ã€‚ä½†æ˜¯é€šè¿‡ç¨‹åºå‘˜è‡ªå¾‹ï¼ŒåŒæ ·å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šå®ç°æ¨¡å¼çš„å¤§éƒ¨åˆ†ç”¨æ„ã€‚





###### 2ï¼‰â€œé»‘ç®±â€å¤‡å¿˜å½•æ¨¡å¼

å¤‡å¿˜å½•è§’è‰²å¯¹å‘èµ·äººå¯¹è±¡æä¾›ä¸€ä¸ªå®½æ¥å£ï¼Œè€Œä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ä¸ªçª„æ¥å£ã€‚

ä»£ç å¦‚ä¸‹ï¼š

çª„æ¥å£`Memento`ï¼Œè¿™æ˜¯ä¸€ä¸ªæ ‡è¯†æ¥å£ï¼Œå› æ­¤æ²¡æœ‰å®šä¹‰å‡ºä»»ä½•çš„æ–¹æ³•

```java
public interface Memento {
}
```

å®šä¹‰å‘èµ·äººç±» `GameRole`ï¼Œå¹¶åœ¨å†…éƒ¨å®šä¹‰å¤‡å¿˜å½•å†…éƒ¨ç±» `RoleStateMemento`ï¼ˆè¯¥å†…éƒ¨ç±»è®¾ç½®ä¸ºç§æœ‰çš„ï¼‰

```java
/æ¸¸æˆè§’è‰²ç±»
public class GameRole {
    private int vit; //ç”Ÿå‘½åŠ›
    private int atk; //æ”»å‡»åŠ›
    private int def; //é˜²å¾¡åŠ›

    //åˆå§‹åŒ–çŠ¶æ€
    public void initState() {
        this.vit = 100;
        this.atk = 100;
        this.def = 100;
    }

    //æˆ˜æ–—
    public void fight() {
        this.vit = 0;
        this.atk = 0;
        this.def = 0;
    }

    //ä¿å­˜è§’è‰²çŠ¶æ€
    public Memento saveState() {
        return new RoleStateMemento(vit, atk, def);
    }

    //å›å¤è§’è‰²çŠ¶æ€
    public void recoverState(Memento memento) {
        RoleStateMemento roleStateMemento = (RoleStateMemento) memento;
        this.vit = roleStateMemento.getVit();
        this.atk = roleStateMemento.getAtk();
        this.def = roleStateMemento.getDef();
    }

    public void stateDisplay() {
        System.out.println("è§’è‰²ç”Ÿå‘½åŠ›ï¼š" + vit);
        System.out.println("è§’è‰²æ”»å‡»åŠ›ï¼š" + atk);
        System.out.println("è§’è‰²é˜²å¾¡åŠ›ï¼š" + def);

    }

    public int getVit() {
        return vit;
    }

    public void setVit(int vit) {
        this.vit = vit;
    }

    public int getAtk() {
        return atk;
    }

    public void setAtk(int atk) {
        this.atk = atk;
    }

    public int getDef() {
        return def;
    }

    public void setDef(int def) {
        this.def = def;
    }

    private class RoleStateMemento implements Memento {
        private int vit;
        private int atk;
        private int def;

        public RoleStateMemento(int vit, int atk, int def) {
            this.vit = vit;
            this.atk = atk;
            this.def = def;
        }

        public int getVit() {
            return vit;
        }

        public void setVit(int vit) {
            this.vit = vit;
        }

        public int getAtk() {
            return atk;
        }

        public void setAtk(int atk) {
            this.atk = atk;
        }

        public int getDef() {
            return def;
        }

        public void setDef(int def) {
            this.def = def;
        }
    }
}
```

è´Ÿè´£äººè§’è‰²ç±» `RoleStateCaretaker` èƒ½å¤Ÿå¾—åˆ°çš„å¤‡å¿˜å½•å¯¹è±¡æ˜¯ä»¥ `Memento` ä¸ºæ¥å£çš„ï¼Œç”±äºè¿™ä¸ªæ¥å£ä»…ä»…æ˜¯ä¸€ä¸ªæ ‡è¯†æ¥å£ï¼Œå› æ­¤è´Ÿè´£äººè§’è‰²ä¸å¯èƒ½æ”¹å˜è¿™ä¸ªå¤‡å¿˜å½•å¯¹è±¡çš„å†…å®¹

```java
//è§’è‰²çŠ¶æ€ç®¡ç†è€…ç±»
public class RoleStateCaretaker {
    private Memento memento;

    public Memento getMemento() {
        return memento;
    }

    public void setMemento(Memento memento) {
        this.memento = memento;
    }
}
```

å®¢æˆ·ç«¯æµ‹è¯•ç±»

```java
public class Client {
    public static void main(String[] args) {
        System.out.println("------------å¤§æˆ˜Bosså‰------------");
        //å¤§æˆ˜Bosså‰
        GameRole gameRole = new GameRole();
        gameRole.initState();
        gameRole.stateDisplay();

        //ä¿å­˜è¿›åº¦
        RoleStateCaretaker roleStateCaretaker = new RoleStateCaretaker();
        roleStateCaretaker.setMemento(gameRole.saveState());
        
        System.out.println("------------å¤§æˆ˜Bosså------------");
        //å¤§æˆ˜Bossæ—¶ï¼ŒæŸè€—ä¸¥é‡
        gameRole.fight();
        gameRole.stateDisplay();
        System.out.println("------------æ¢å¤ä¹‹å‰çŠ¶æ€------------");
        //æ¢å¤ä¹‹å‰çŠ¶æ€
        gameRole.recoverState(roleStateCaretaker.getMemento());
        gameRole.stateDisplay();
    }
}

```



#### 11. è§£é‡Šå™¨æ¨¡å¼

**å®šä¹‰ï¼š**

> ç»™å®šä¸€ä¸ªè¯­è¨€ï¼Œå®šä¹‰å®ƒçš„æ–‡æ³•è¡¨ç¤ºï¼Œå¹¶å®šä¹‰ä¸€ä¸ªè§£é‡Šå™¨ï¼Œè¿™ä¸ªè§£é‡Šå™¨ä½¿ç”¨è¯¥æ ‡è¯†æ¥è§£é‡Šè¯­è¨€ä¸­çš„å¥å­ã€‚

**ä¸€å¥è¯ç†è§£ï¼š**

ä½¿ç”¨è¯­æ³•ï¼ˆæ–‡æ³•è¡¨è¾¾å¼ï¼‰+è§£é‡Šå™¨ï¼Œåœ¨è¡¨è¾¾å¼ä¸­é€šè¿‡å®šä¹‰interpretæ–¹æ³•è§£é‡Šè¡¨è¾¾å¼ï¼Œå¦‚åŠ å‡æ³•è®¡ç®—å™¨å¯ä»¥ä½¿ç”¨è§£é‡Šå™¨æ¨¡å¼æ¥å®šä¹‰ã€‚

åœ¨è§£é‡Šå™¨æ¨¡å¼ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å°†å¾…è§£å†³çš„é—®é¢˜ï¼Œæå–å‡ºè§„åˆ™ï¼ŒæŠ½è±¡ä¸ºä¸€ç§â€œè¯­è¨€â€ã€‚æ¯”å¦‚åŠ å‡æ³•è¿ç®—ï¼Œè§„åˆ™ä¸ºï¼šç”±æ•°å€¼å’Œ+-ç¬¦å·ç»„æˆçš„åˆæ³•åºåˆ—ï¼Œâ€œ1+3-2â€ å°±æ˜¯è¿™ç§è¯­è¨€çš„å¥å­ã€‚

è§£é‡Šå™¨å°±æ˜¯è¦è§£æå‡ºæ¥è¯­å¥çš„å«ä¹‰ã€‚ä½†æ˜¯å¦‚ä½•æè¿°è§„åˆ™å‘¢ï¼Ÿ

**æ–‡æ³•ï¼ˆè¯­æ³•ï¼‰è§„åˆ™ï¼š**

æ–‡æ³•æ˜¯ç”¨äºæè¿°è¯­è¨€çš„è¯­æ³•ç»“æ„çš„å½¢å¼è§„åˆ™ã€‚

```
expression ::= value | plus | minus
plus ::= expression â€˜+â€™ expression   
minus ::= expression â€˜-â€™ expression  
value ::= integer
```

> æ³¨æ„ï¼š è¿™é‡Œçš„ç¬¦å·â€œ::=â€è¡¨ç¤ºâ€œå®šä¹‰ä¸ºâ€çš„æ„æ€ï¼Œç«–çº¿ | è¡¨ç¤ºæˆ–ï¼Œå·¦å³çš„å…¶ä¸­ä¸€ä¸ªï¼Œå¼•å·å†…ä¸ºå­—ç¬¦æœ¬èº«ï¼Œå¼•å·å¤–ä¸ºè¯­æ³•ã€‚

ä¸Šé¢è§„åˆ™æè¿°ä¸º ï¼š

è¡¨è¾¾å¼å¯ä»¥æ˜¯ä¸€ä¸ªå€¼ï¼Œä¹Ÿå¯ä»¥æ˜¯plusæˆ–è€…minusè¿ç®—ï¼Œè€Œpluså’Œminusåˆæ˜¯ç”±è¡¨è¾¾å¼ç»“åˆè¿ç®—ç¬¦æ„æˆï¼Œå€¼çš„ç±»å‹ä¸ºæ•´å‹æ•°ã€‚

**æŠ½è±¡è¯­æ³•æ ‘ï¼š**

åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼ŒæŠ½è±¡è¯­æ³•æ ‘ï¼ˆAbstractSyntaxTreeï¼ŒASTï¼‰ï¼Œæˆ–ç®€ç§°è¯­æ³•æ ‘ï¼ˆSyntax treeï¼‰ï¼Œæ˜¯æºä»£ç è¯­æ³•ç»“æ„çš„ä¸€ç§æŠ½è±¡è¡¨ç¤ºã€‚å®ƒä»¥æ ‘çŠ¶çš„å½¢å¼è¡¨ç°ç¼–ç¨‹è¯­è¨€çš„è¯­æ³•ç»“æ„ï¼Œæ ‘ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹éƒ½è¡¨ç¤ºæºä»£ç ä¸­çš„ä¸€ç§ç»“æ„ã€‚

ç”¨æ ‘å½¢æ¥è¡¨ç¤ºç¬¦åˆæ–‡æ³•è§„åˆ™çš„å¥å­ã€‚



è§£é‡Šå™¨æ¨¡å¼åŒ…å«ä»¥ä¸‹**ä¸»è¦è§’è‰²**ã€‚

* æŠ½è±¡è¡¨è¾¾å¼ï¼ˆAbstract Expressionï¼‰è§’è‰²ï¼šå®šä¹‰è§£é‡Šå™¨çš„æ¥å£ï¼Œçº¦å®šè§£é‡Šå™¨çš„è§£é‡Šæ“ä½œï¼Œä¸»è¦åŒ…å«è§£é‡Šæ–¹æ³• interpret()ã€‚

* ç»ˆç»“ç¬¦è¡¨è¾¾å¼ï¼ˆTerminal  Expressionï¼‰è§’è‰²ï¼šæ˜¯æŠ½è±¡è¡¨è¾¾å¼çš„å­ç±»ï¼Œç”¨æ¥å®ç°æ–‡æ³•ä¸­ä¸ç»ˆç»“ç¬¦ç›¸å…³çš„æ“ä½œï¼Œæ–‡æ³•ä¸­çš„æ¯ä¸€ä¸ªç»ˆç»“ç¬¦éƒ½æœ‰ä¸€ä¸ªå…·ä½“ç»ˆç»“è¡¨è¾¾å¼ä¸ä¹‹ç›¸å¯¹åº”ã€‚
* éç»ˆç»“ç¬¦è¡¨è¾¾å¼ï¼ˆNonterminal Expressionï¼‰è§’è‰²ï¼šä¹Ÿæ˜¯æŠ½è±¡è¡¨è¾¾å¼çš„å­ç±»ï¼Œç”¨æ¥å®ç°æ–‡æ³•ä¸­ä¸éç»ˆç»“ç¬¦ç›¸å…³çš„æ“ä½œï¼Œæ–‡æ³•ä¸­çš„æ¯æ¡è§„åˆ™éƒ½å¯¹åº”äºä¸€ä¸ªéç»ˆç»“ç¬¦è¡¨è¾¾å¼ã€‚
* ç¯å¢ƒï¼ˆContextï¼‰è§’è‰²ï¼šé€šå¸¸åŒ…å«å„ä¸ªè§£é‡Šå™¨éœ€è¦çš„æ•°æ®æˆ–æ˜¯å…¬å…±çš„åŠŸèƒ½ï¼Œä¸€èˆ¬ç”¨æ¥ä¼ é€’è¢«æ‰€æœ‰è§£é‡Šå™¨å…±äº«çš„æ•°æ®ï¼Œåé¢çš„è§£é‡Šå™¨å¯ä»¥ä»è¿™é‡Œè·å–è¿™äº›å€¼ã€‚
* å®¢æˆ·ç«¯ï¼ˆClientï¼‰ï¼šä¸»è¦ä»»åŠ¡æ˜¯å°†éœ€è¦åˆ†æçš„å¥å­æˆ–è¡¨è¾¾å¼è½¬æ¢æˆä½¿ç”¨è§£é‡Šå™¨å¯¹è±¡æè¿°çš„æŠ½è±¡è¯­æ³•æ ‘ï¼Œç„¶åè°ƒç”¨è§£é‡Šå™¨çš„è§£é‡Šæ–¹æ³•ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡ç¯å¢ƒè§’è‰²é—´æ¥è®¿é—®è§£é‡Šå™¨çš„è§£é‡Šæ–¹æ³•ã€‚



##### 11.1 ç¤ºä¾‹

ã€ä¾‹ã€‘è®¾è®¡å®ç°åŠ å‡æ³•çš„è½¯ä»¶

```java
//æŠ½è±¡è§’è‰²AbstractExpression
public abstract class AbstractExpression {
    public abstract int interpret(Context context);
}

//ç»ˆç»“ç¬¦è¡¨è¾¾å¼è§’è‰²
public class Value extends AbstractExpression {
    private int value;

    public Value(int value) {
        this.value = value;
    }

    @Override
    public int interpret(Context context) {
        return value;
    }

    @Override
    public String toString() {
        return new Integer(value).toString();
    }
}

//éç»ˆç»“ç¬¦è¡¨è¾¾å¼è§’è‰²  åŠ æ³•è¡¨è¾¾å¼
public class Plus extends AbstractExpression {
    private AbstractExpression left;
    private AbstractExpression right;

    public Plus(AbstractExpression left, AbstractExpression right) {
        this.left = left;
        this.right = right;
    }

    @Override
    public int interpret(Context context) {
        return left.interpret(context) + right.interpret(context);
    }

    @Override
    public String toString() {
        return "(" + left.toString() + " + " + right.toString() + ")";
    }
}

///éç»ˆç»“ç¬¦è¡¨è¾¾å¼è§’è‰² å‡æ³•è¡¨è¾¾å¼
public class Minus extends AbstractExpression {
    private AbstractExpression left;
    private AbstractExpression right;

    public Minus(AbstractExpression left, AbstractExpression right) {
        this.left = left;
        this.right = right;
    }

    @Override
    public int interpret(Context context) {
        return left.interpret(context) - right.interpret(context);
    }

    @Override
    public String toString() {
        return "(" + left.toString() + " - " + right.toString() + ")";
    }
}

//ç»ˆç»“ç¬¦è¡¨è¾¾å¼è§’è‰² å˜é‡è¡¨è¾¾å¼
public class Variable extends AbstractExpression {
    private String name;

    public Variable(String name) {
        this.name = name;
    }

    @Override
    public int interpret(Context ctx) {
        return ctx.getValue(this);
    }

    @Override
    public String toString() {
        return name;
    }
}

//ç¯å¢ƒç±»ï¼Œæä¾›å˜é‡å¯¹åº”çš„å€¼
public class Context {
    private Map<Variable, Integer> map = new HashMap<Variable, Integer>();

    public void assign(Variable var, Integer value) {
        map.put(var, value);
    }

    public int getValue(Variable var) {
        Integer value = map.get(var);
        return value;
    }
}

//æµ‹è¯•ç±»
public class Client {
    public static void main(String[] args) {
        Context context = new Context();

        Variable a = new Variable("a");
        Variable b = new Variable("b");
        Variable c = new Variable("c");
        Variable d = new Variable("d");
        Variable e = new Variable("e");
        //Value v = new Value(1);

        context.assign(a, 1);
        context.assign(b, 2);
        context.assign(c, 3);
        context.assign(d, 4);
        context.assign(e, 5);

        AbstractExpression expression = new Minus(new Plus(new Plus(new Plus(a, b), c), d), e);

        System.out.println(expression + "= " + expression.interpret(context));
    }
}
```



### **ç¼–ç é£æ ¼**

> è§„èŒƒå‘½å/æ³¨é‡Š/å‡½æ•°/é”™è¯¯å¤„ç†ç­‰ï¼Œå‚è€ƒ [Google Style Guide](https://google.github.io/styleguide/)

åŸºäº **Google Style Guide**ï¼Œè¯¦ç»†æ•´ç† PHP ç¼–ç è§„èŒƒï¼Œæ¶µç›–å‘½åã€æ³¨é‡Šã€å‡½æ•°ã€é”™è¯¯å¤„ç†ç­‰æ ¸å¿ƒå†…å®¹ã€‚

#### **1. æ–‡ä»¶å’Œç»„ç»‡ç»“æ„è§„èŒƒ**

##### **1.1 æ–‡ä»¶å‘½åè§„èŒƒ**

```php
// âœ… Google æ¨èï¼šå°å†™ + ä¸‹åˆ’çº¿
class user_service.php
class database_connection.php  
class api_client_factory.php

// âŒ ä¸ç¬¦åˆè§„èŒƒ
class UserService.php          // åº”ä½¿ç”¨è›‡å½¢å‘½å ==>ç°åœ¨çš„é¡¹ç›®æ¯ä¸ªå­é¡¹æ˜¯ç”¨è¿™ç§å‘½åæ–¹å¼ï¼ˆä¸ç±»åä¿æŒä¸€è‡´ï¼‰ï¼Œä»¥é¡¹ç›®ä¸ºå‡†
class userService.php          // æ··åˆå¤§å°å†™
class USER_SERVICE.php         // å…¨å¤§å†™ï¼ˆä»…å¸¸é‡ï¼‰
```



##### **1.2 ç›®å½•ç»“æ„è§„èŒƒ**

```
// âœ… Google æ¨èçš„é¡¹ç›®ç»“æ„
project/
â”œâ”€â”€ src/                       # æºä»£ç 
â”‚   â”œâ”€â”€ controllers/           # æ§åˆ¶å™¨ï¼ˆå°å†™ï¼‰
â”‚   â”œâ”€â”€ models/               # æ¨¡å‹
â”‚   â”œâ”€â”€ services/             # ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ utils/                # å·¥å…·ç±»
â”‚   â””â”€â”€ exceptions/           # å¼‚å¸¸ç±»
â”œâ”€â”€ tests/                     # æµ‹è¯•ä»£ç 
â”œâ”€â”€ config/                   # é…ç½®æ–‡ä»¶
â””â”€â”€ public/                   # å…¬å¼€ç›®å½•
    â””â”€â”€ index.php
```

##### **1.3 æ–‡ä»¶å¤´æ³¨é‡Šè§„èŒƒ**

```
<?php
/**
 * @file
 * @brief ç”¨æˆ·æœåŠ¡å¤„ç†ç±»
 * @details å¤„ç†ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€ä¿¡æ¯ç®¡ç†ç­‰æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
 * 
 * @author å¼ ä¸‰ <zhangsan@company.com>
 * @version 1.2.0
 * @date 2024-01-19
 * @copyright Copyright (c) 2024 å…¬å¸åç§°
 * @license MIT
 * 
 * @see https://github.com/company/project/wiki/User-Service
 * @since 1.0.0 åŸºç¡€åŠŸèƒ½
 * @since 1.1.0 å¢åŠ ç¼“å­˜æ”¯æŒ
 */
```



#### **2. å‘½åè§„èŒƒï¼ˆåŸºäº Google Styleï¼‰**

##### **2.1 ç±»åå’Œæ¥å£å**

```php
// âœ… å¤§é©¼å³°å‘½åæ³•ï¼ˆPascalCaseï¼‰
class UserService {}
class DatabaseConnectionPool {}
interface LoggerInterface {}
abstract class AbstractModel {}
trait CacheableTrait {}

// âŒ ä¸ç¬¦åˆè§„èŒƒ
class user_service {}           // åº”ä½¿ç”¨å¤§é©¼å³°
class User_Service {}           // ä¸åº”åŒ…å«ä¸‹åˆ’çº¿ï¼ˆç°æœ‰é¡¹ç›®ç”¨çš„è¿™ç§ï¼‰
```

##### **2.2 æ–¹æ³•åå’Œå‡½æ•°å**

```
class UserService {
    // âœ… å°é©¼å³°å‘½åæ³•ï¼ˆcamelCaseï¼‰==ã€‹âœ…
    public function getUserById(int $userId): User {}
    public function createUserAccount(array $userData): bool {}
    private function validateEmailFormat(string $email): bool {}
    protected function processBatchUsers(array $users): void {}
    
    // âŒ ä¸ç¬¦åˆè§„èŒƒ
    public function GetUserById() {}           // é¦–å­—æ¯ä¸åº”å¤§å†™
    public function get_user_by_id() {}        // ä¸åº”ä½¿ç”¨ä¸‹åˆ’çº¿
    public function retrieveUID() {}           // ç¼©å†™åº”ä¿æŒä¸€è‡´æ€§
}
```

##### **2.3 å˜é‡å’Œå‚æ•°å‘½å**

```
class OrderProcessor {
    // âœ… å°é©¼å³°å‘½å
    private $orderService;
    protected $maxRetryCount = 3;
    public static $defaultTimeout = 30;
    
    public function calculateOrderTotal(
        array $orderItems,           // å¤æ•°è¡¨ç¤ºé›†åˆ
        bool $includeTax = false,    // å¸ƒå°”å€¼ç”¨is/has/includeç­‰å‰ç¼€
        float $discountRate = 0.0    // æ˜ç¡®ç±»å‹æ„å›¾
    ): float {
        $subtotal = 0.0;
        $taxAmount = 0.0;
        
        foreach ($orderItems as $orderItem) {  // å•æ•°è¡¨ç¤ºå•ä¸ªå…ƒç´ 
            $itemPrice = $orderItem->getPrice();
            $subtotal += $itemPrice;
        }
        
        return $includeTax ? $subtotal + $taxAmount : $subtotal;
    }
}
```

##### **2.4 å¸¸é‡å‘½å**

```
class Config {
    // âœ… å…¨å¤§å†™ + ä¸‹åˆ’çº¿ âœ…
    const MAX_RETRY_COUNT = 3;
    const DEFAULT_TIMEOUT_SECONDS = 30;
    const API_BASE_URL = 'https://api.example.com';
    const SUPPORTED_FILE_TYPES = ['jpg', 'png', 'pdf'];
    
    // âŒ ä¸ç¬¦åˆè§„èŒƒ
    const maxRetryCount = 3;        // åº”å…¨å¤§å†™
    const Default_Timeout = 30;     // æ··åˆå¤§å°å†™
}
```



#### **3. æ³¨é‡Šè§„èŒƒï¼ˆGoogle æ ‡å‡†ï¼‰**

##### **3.1 ç±»æ³¨é‡Šæ¨¡æ¿**

```php
/**
 * ç”¨æˆ·è®¤è¯æœåŠ¡
 *
 * æä¾›ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€æƒé™éªŒè¯ç­‰å®Œæ•´è®¤è¯æµç¨‹ã€‚
 * ä½¿ç”¨JWTè¿›è¡Œæ— çŠ¶æ€èº«ä»½è®¤è¯ï¼Œæ”¯æŒå¤šè§’è‰²æƒé™ç®¡ç†ã€‚
 *
 * å…¸å‹ç”¨æ³•:
 * ```php
 * $authService = new AuthenticationService();
 * $user = $authService->authenticate($credentials);
 * if ($user->hasPermission('admin')) {
 *     // ç®¡ç†å‘˜æ“ä½œ
 * }
 * ```
 *
 * æ€§èƒ½è¯´æ˜:
 * - è®¤è¯æ“ä½œ: O(1) æ—¶é—´å¤æ‚åº¦
 * - å†…å­˜ä½¿ç”¨: æ¯ä¸ªç”¨æˆ·çº¦ 2KB
 * - æ”¯æŒå¹¶å‘: æ˜¯ï¼Œçº¿ç¨‹å®‰å…¨
 *
 * @throws AuthenticationException è®¤è¯å¤±è´¥æ—¶æŠ›å‡º
 * @throws DatabaseException æ•°æ®åº“æ“ä½œå¤±è´¥æ—¶æŠ›å‡º
 * 
 * @author æå›› <lisi@company.com>
 * @version 2.1.0
 * @since 1.0.0 åŸºç¡€è®¤è¯åŠŸèƒ½
 * @since 2.0.0 å¢åŠ JWTæ”¯æŒ
 */
class AuthenticationService {
    // ç±»å®ç°...
}
```

##### **3.2 æ–¹æ³•æ³¨é‡Šè§„èŒƒ**

```php
class UserRepository {
    /**
     * æ ¹æ®å¤šä¸ªæ¡ä»¶æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     *
     * æ”¯æŒæŒ‰ç”¨æˆ·åã€é‚®ç®±ã€çŠ¶æ€ç­‰æ¡ä»¶ç»„åˆæŸ¥è¯¢ï¼Œæ”¯æŒåˆ†é¡µå’Œæ’åºã€‚
     * è¯¥æ–¹æ³•ä¼šè‡ªåŠ¨ç¼“å­˜æŸ¥è¯¢ç»“æœï¼Œæé«˜é‡å¤æŸ¥è¯¢æ€§èƒ½ã€‚
     *
     * ç¤ºä¾‹:
     * ```php
     * $criteria = [
     *     'status' => 'active',
     *     'role' => 'admin'
     * ];
     * $users = $repository->findByCriteria($criteria, 1, 20, 'username');
     * ```
     *
     * @param array $criteria æŸ¥è¯¢æ¡ä»¶æ•°ç»„
     *        - 'username' string|null ç”¨æˆ·å(æ¨¡ç³ŠåŒ¹é…)
     *        - 'email' string|null é‚®ç®±åœ°å€(ç²¾ç¡®åŒ¹é…)  
     *        - 'status' string|null ç”¨æˆ·çŠ¶æ€: active/inactive
     * @param int $page é¡µç ï¼Œä»1å¼€å§‹
     * @param int $pageSize æ¯é¡µè®°å½•æ•°ï¼Œæœ€å¤§100
     * @param string $sortBy æ’åºå­—æ®µ: username/created_at
     * @param string $sortOrder æ’åºæ–¹å‘: asc/desc
     *
     * @return User[] ç”¨æˆ·å¯¹è±¡æ•°ç»„ï¼Œå¯èƒ½ä¸ºç©ºæ•°ç»„
     *
     * @throws InvalidArgumentException å‚æ•°éªŒè¯å¤±è´¥
     * @throws DatabaseException æ•°æ®åº“æŸ¥è¯¢é”™è¯¯
     *
     * @see UserService::searchUsers() æ›´é«˜çº§çš„æœç´¢åŠŸèƒ½
     * @todo æ”¯æŒæ›´å¤æ‚çš„æŸ¥è¯¢æ¡ä»¶ï¼Œå¦‚æ—¥æœŸèŒƒå›´
     *
     * @example
     * $activeUsers = $repo->findByCriteria(['status' => 'active'], 1, 10);
     */
    public function findByCriteria(
        array $criteria = [],
        int $page = 1,
        int $pageSize = 20,
        string $sortBy = 'created_at',
        string $sortOrder = 'desc'
    ): array {
        // å‚æ•°éªŒè¯
        if ($page < 1) {
            throw new InvalidArgumentException('é¡µç å¿…é¡»å¤§äº0');
        }
        
        // æ–¹æ³•å®ç°...
    }
}
```

##### **3.3 è¡Œå†…æ³¨é‡Šæ ‡å‡†**

```php
class PaymentProcessor {
    public function processRefund(Order $order, float $amount): void {
        // éªŒè¯è®¢å•çŠ¶æ€æ˜¯å¦å…è®¸é€€æ¬¾
        if (!$order->isRefundable()) {
            throw new InvalidOrderStateException('è®¢å•å½“å‰çŠ¶æ€ä¸å…è®¸é€€æ¬¾');
        }
        
        // è®¡ç®—å®é™…å¯é€€æ¬¾é‡‘é¢ï¼ˆè€ƒè™‘éƒ¨åˆ†é€€æ¬¾æƒ…å†µï¼‰
        $maxRefundAmount = $order->getPaidAmount() - $order->getRefundedAmount();
        $refundAmount = min($amount, $maxRefundAmount);
        
        // è®°å½•å®¡è®¡æ—¥å¿—ï¼ˆæ»¡è¶³åˆè§„è¦æ±‚ï¼‰
        $this->auditLogger->info('é€€æ¬¾ç”³è¯·', [
            'order_id' => $order->getId(),
            'requested_amount' => $amount,
            'actual_amount' => $refundAmount,
            'processor' => __METHOD__
        ]);
        
        try {
            // è°ƒç”¨æ”¯ä»˜ç½‘å…³APIæ‰§è¡Œé€€æ¬¾
            $refundId = $this->paymentGateway->refund(
                $order->getTransactionId(),
                $refundAmount
            );
            
            // æ›´æ–°è®¢å•é€€æ¬¾çŠ¶æ€
            $order->markAsRefunded($refundAmount, $refundId);
            
        } catch (PaymentGatewayException $e) {
            // æ”¯ä»˜ç½‘å…³å¼‚å¸¸ï¼Œè½¬æ¢ä¸ºä¸šåŠ¡å¼‚å¸¸
            throw new RefundFailedException(
                "é€€æ¬¾å¤„ç†å¤±è´¥: " . $e->getMessage(),
                $e->getCode(),
                $e
            );
        }
    }
}
```

#### **4. å‡½æ•°å’Œæ–¹æ³•è®¾è®¡è§„èŒƒ**

##### **4.1 å•ä¸€èŒè´£åŸåˆ™**

```php
// âœ… å¥½çš„è®¾è®¡ï¼šæ¯ä¸ªå‡½æ•°åªåšä¸€ä»¶äº‹
class OrderValidator {
    /**
     * éªŒè¯è®¢å•åŸºæœ¬ä¿¡æ¯
     */
    public function validateBasicInfo(Order $order): void {
        $this->validateCustomerInfo($order->getCustomer());
        $this->validateOrderItems($order->getItems());
        $this->validateShippingAddress($order->getAddress());
    }
    
    private function validateCustomerInfo(Customer $customer): void {
        if (empty($customer->getEmail())) {
            throw new ValidationException('å®¢æˆ·é‚®ç®±ä¸èƒ½ä¸ºç©º');
        }
        // æ›´å¤šå®¢æˆ·ä¿¡æ¯éªŒè¯...
    }
    
    private function validateOrderItems(array $items): void {
        if (count($items) === 0) {
            throw new ValidationException('è®¢å•å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä»¶å•†å“');
        }
        // æ›´å¤šå•†å“éªŒè¯...
    }
}

// âŒ ä¸å¥½çš„è®¾è®¡ï¼šå‡½æ•°æ‰¿æ‹…è¿‡å¤šèŒè´£
public function processOrder(Order $order): void {
    // éªŒè¯é€»è¾‘ï¼ˆ50è¡Œï¼‰
    // è®¡ç®—é€»è¾‘ï¼ˆ30è¡Œï¼‰ 
    // ä¿å­˜é€»è¾‘ï¼ˆ20è¡Œï¼‰
    // é€šçŸ¥é€»è¾‘ï¼ˆ15è¡Œï¼‰
    // æ€»å…±115è¡Œï¼åº”è¯¥æ‹†åˆ†
}
```

##### **4.2 å‚æ•°è®¾è®¡è§„èŒƒ**

```php
// âœ… å¥½çš„å‚æ•°è®¾è®¡
class UserCreator {
    /**
     * åˆ›å»ºæ–°ç”¨æˆ·è´¦æˆ·
     */
    public function createUser(
        string $username,      // å¿…éœ€å‚æ•°åœ¨å‰ âœ…
        string $email,
        string $password,
        array $options = [],   // å¯é€‰å‚æ•°åœ¨åï¼Œä½¿ç”¨æ•°ç»„
        bool $sendWelcomeEmail = true
    ): User {
        // å‚æ•°éªŒè¯
        Assert::stringNotEmpty($username, 'ç”¨æˆ·åä¸èƒ½ä¸ºç©º');
        Assert::email($email, 'é‚®ç®±æ ¼å¼æ— æ•ˆ');
        Assert::minLength($password, 8, 'å¯†ç è‡³å°‘8ä½');
        
        // ä¸šåŠ¡é€»è¾‘...
    }
}


// âœ… å‚æ•°è¿‡å¤šæ—¶ä½¿ç”¨å‚æ•°å¯¹è±¡
class UserCreationRequest {
    public function __construct(
        public readonly string $username,
        public readonly string $email, 
        public readonly string $password,
        public readonly ?string $firstName = null,
        public readonly ?string $lastName = null,
        public readonly array $preferences = []
    ) {
        Assert::stringNotEmpty($username);
        Assert::email($email);
    }
}

class UserCreator {
    public function createUser(UserCreationRequest $request): User {
        // æ¸…æ™°çš„å‚æ•°ç»“æ„
    }
}
```

##### **4.3 è¿”å›å€¼è§„èŒƒ**

```php
class UserService {
    // âœ… æ˜ç¡®è¿”å›ç±»å‹å£°æ˜
    public function findUserById(int $userId): ?User {
        // å¯èƒ½è¿”å› null
    }
    
    // âœ… è¿”å›é›†åˆæ—¶æ³¨æ˜å…ƒç´ ç±»å‹
    /** @return User[] */
    public function getActiveUsers(): array {
        return $this->userRepository->findByStatus('active');
    }
    
    // âœ… æ°¸ä¸è¿”å›nullçš„æ–¹æ³•
    public function getUserOrFail(int $userId): User {
        $user = $this->findUserById($userId);
        if ($user === null) {
            throw new UserNotFoundException("ç”¨æˆ· {$userId} ä¸å­˜åœ¨");
        }
        return $user;
    }
    
    // âœ… è¿”å›æ“ä½œç»“æœå¯¹è±¡ï¼ˆç»Ÿä¸€è¿”å›ç»“æœï¼‰
    public function changePassword(int $userId, string $newPassword): OperationResult {
        try {
            $user = $this->getUserOrFail($userId);
            $user->setPassword($newPassword);
            $this->userRepository->save($user);
            
            return OperationResult::success('å¯†ç ä¿®æ”¹æˆåŠŸ');
            
        } catch (Exception $e) {
            return OperationResult::error('å¯†ç ä¿®æ”¹å¤±è´¥: ' . $e->getMessage());
        }
    }
}
```



#### **5. é”™è¯¯å¤„ç†è§„èŒƒï¼ˆGoogle æ ‡å‡†ï¼‰**

##### **5.1 å¼‚å¸¸å±‚æ¬¡ç»“æ„è®¾è®¡**

```php
// åŸºç¡€å¼‚å¸¸ç±»
abstract class AppException extends Exception {
    public function __construct(string $message, int $code = 0, ?Throwable $previous = null) {
        parent::__construct($message, $code, $previous);
    }
    
    abstract public function getErrorCode(): string;
}

// ä¸šåŠ¡å¼‚å¸¸ç±»
class ValidationException extends AppException {
    private array $errors;
    
    public function __construct(array $errors = [], string $message = 'éªŒè¯å¤±è´¥') {
        $this->errors = $errors;
        parent::__construct($message, 400);
    }
    
    public function getErrorCode(): string {
        return 'VALIDATION_ERROR';
    }
    
    public function getErrors(): array {
        return $this->errors;
    }
}

class AuthenticationException extends AppException {
    public function getErrorCode(): string {
        return 'AUTHENTICATION_FAILED';
    }
}

class AuthorizationException extends AppException {
    public function getErrorCode(): string {
        return 'PERMISSION_DENIED';
    }
}
```



##### **5.2 é˜²å¾¡æ€§ç¼–ç¨‹å’Œå‚æ•°éªŒè¯**

```php
class InputValidator {
    /**
     * éªŒè¯é‚®ç®±åœ°å€æ ¼å¼
     * 
     * @throws ValidationException éªŒè¯å¤±è´¥æ—¶æŠ›å‡º
     */
    public static function validateEmail(string $email): string {
        $email = trim($email);
        
        if (empty($email)) {
            throw new ValidationException(['email' => 'é‚®ç®±åœ°å€ä¸èƒ½ä¸ºç©º']);
        }
        
        if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
            throw new ValidationException(['email' => 'é‚®ç®±æ ¼å¼æ— æ•ˆ']);
        }
        
        if (strlen($email) > 254) {
            throw new ValidationException(['email' => 'é‚®ç®±åœ°å€è¿‡é•¿']);
        }
        
        return strtolower($email);
    }
    
    /**
     * éªŒè¯ç”¨æˆ·IDæ ¼å¼å’Œå­˜åœ¨æ€§
     */
    public static function validateUserId($userId, UserRepository $repo): int {
        if (!is_numeric($userId) || $userId <= 0) {
            throw new ValidationException(['user_id' => 'ç”¨æˆ·IDå¿…é¡»ä¸ºæ­£æ•´æ•°']);
        }
        
        $userId = (int)$userId;
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
        if (!$repo->exists($userId)) {
            throw new ValidationException(['user_id' => 'ç”¨æˆ·ä¸å­˜åœ¨']);
        }
        
        return $userId;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
try {
    $email = InputValidator::validateEmail($_POST['email']);
    $userId = InputValidator::validateUserId($_POST['user_id'], $userRepo);
    
} catch (ValidationException $e) {
    // è¿”å›éªŒè¯é”™è¯¯ä¿¡æ¯
    return new JsonResponse([
        'success' => false,
        'error' => $e->getErrorCode(),
        'message' => $e->getMessage(),
        'details' => $e->getErrors()
    ], 400);
}
```

##### **5.3 é”™è¯¯å¤„ç†æœ€ä½³å®è·µ**

```php
class FileProcessor {
    /**
     * å¤„ç†ä¸Šä¼ æ–‡ä»¶
     */
    public function processUploadedFile(string $filePath): OperationResult {
        // å‰ç½®æ¡ä»¶æ£€æŸ¥
        if (!file_exists($filePath)) {
            return OperationResult::error("æ–‡ä»¶ä¸å­˜åœ¨: {$filePath}");
        }
        
        if (!is_readable($filePath)) {
            return OperationResult::error("æ–‡ä»¶ä¸å¯è¯»: {$filePath}");
        }
        
        // è®¾ç½®æ‰§è¡Œè¶…æ—¶é™åˆ¶
        $originalTimeout = ini_get('max_execution_time');
        set_time_limit(300); // 5åˆ†é’Ÿ
        
        try {
            $fileInfo = new SplFileInfo($filePath);
            
            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (!$this->isSupportedFileType($fileInfo->getExtension())) {
                throw new UnsupportedFileTypeException(
                    "ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: " . $fileInfo->getExtension()
                );
            }
            
            // å¤„ç†æ–‡ä»¶å†…å®¹
            $content = file_get_contents($filePath);
            if ($content === false) {
                throw new IOException("è¯»å–æ–‡ä»¶å¤±è´¥: {$filePath}");
            }
            
            $result = $this->processContent($content);
            
            // è®°å½•æˆåŠŸæ—¥å¿—
            $this->logger->info('æ–‡ä»¶å¤„ç†æˆåŠŸ', [
                'file_path' => $filePath,
                'file_size' => $fileInfo->getSize(),
                'result' => $result->toArray()
            ]);
            
            return OperationResult::success('æ–‡ä»¶å¤„ç†æˆåŠŸ', $result);
            
        } catch (UnsupportedFileTypeException $e) {
            // å·²çŸ¥ä¸šåŠ¡å¼‚å¸¸ï¼Œç›´æ¥è¿”å›
            $this->logger->warning('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹', ['error' => $e->getMessage()]);
            return OperationResult::error($e->getMessage(), 'UNSUPPORTED_FILE_TYPE');
            
        } catch (IOException $e) {
            // I/O å¼‚å¸¸ï¼Œè®°å½•è¯¦ç»†æ—¥å¿—
            $this->logger->error('æ–‡ä»¶IOé”™è¯¯', [
                'file_path' => $filePath,
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);
            return OperationResult::error('æ–‡ä»¶è¯»å–å¤±è´¥', 'IO_ERROR');
            
        } catch (Exception $e) {
            // æœªçŸ¥å¼‚å¸¸ï¼Œè®°å½•å¹¶å°è£…
            $this->logger->error('æ–‡ä»¶å¤„ç†æœªçŸ¥é”™è¯¯', [
                'file_path' => $filePath, 
                'exception' => get_class($e),
                'message' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);
            return OperationResult::error('ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'INTERNAL_ERROR');
            
        } finally {
            // æ¢å¤åŸå§‹è¶…æ—¶è®¾ç½®
            set_time_limit($originalTimeout ?: 30);
            
            // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            if (file_exists($filePath) && strpos($filePath, '/tmp/') === 0) {
                unlink($filePath);
            }
        }
    }
}
```

#### **6. ä»£ç æ ¼å¼å’Œé£æ ¼**

##### **6.1 ä¸¥æ ¼ç±»å‹å£°æ˜**

```php
<?php
declare(strict_types=1);  // æ–‡ä»¶å¼€å¤´å¿…é¡»å¯ç”¨ä¸¥æ ¼æ¨¡å¼

class StrictTypingExample {
    // âœ… å‚æ•°å’Œè¿”å›ç±»å‹å£°æ˜
    public function calculateTotal(
        float $unitPrice, 
        int $quantity, 
        float $taxRate = 0.0
    ): float {
        $subtotal = $unitPrice * $quantity;
        $taxAmount = $subtotal * $taxRate;
        return $subtotal + $taxAmount;
    }
    
    // âœ… å¯ç©ºç±»å‹
    public function findUserByEmail(?string $email): ?User {
        if ($email === null) {
            return null;
        }
        return $this->userRepository->findByEmail($email);
    }
    
    // âœ… è¿”å›void
    public function logActivity(string $action, array $context = []): void {
        $this->logger->info($action, $context);
    }
}
```

##### **6.2 æ§åˆ¶ç»“æ„è§„èŒƒ**

```
// âœ… if-elseif-else è§„èŒƒ
if ($condition) {
    // æ‰§è¡Œä»£ç 
} elseif ($otherCondition) {
    // æ‰§è¡Œå…¶ä»–ä»£ç 
} else {
    // é»˜è®¤æ‰§è¡Œä»£ç 
}

// âœ… switch è¯­å¥è§„èŒƒ
switch ($status) {
    case 'pending':
        $this->processPendingOrder($order);
        break;
    case 'processing':
        $this->handleProcessingOrder($order);
        break;
    case 'completed':
        $this->finalizeCompletedOrder($order);
        break;
    default:
        throw new InvalidOrderStatusException("æœªçŸ¥çŠ¶æ€: {$status}");
}

// âœ… try-catch-finally è§„èŒƒ
try {
    $result = $this->riskyOperation();
    $this->processResult($result);
    
} catch (SpecificException $e) {
    $this->logger->error('ç‰¹å®šæ“ä½œå¤±è´¥', ['error' => $e->getMessage()]);
    throw new BusinessException('ä¸šåŠ¡å¤„ç†å¤±è´¥', 0, $e);
    
} catch (AnotherException $e) {
    $this->handleAnotherException($e);
    
} finally {
    $this->cleanupResources();
}
```

------

#### **7. æµ‹è¯•ä»£ç è§„èŒƒ**

##### **7.1 æµ‹è¯•ç±»å’Œæ–¹æ³•å‘½å**

```php
class UserServiceTest extends TestCase {
    /**
     * @test
     */
    public function getUserById_withValidId_returnsUser(): void {
        // æµ‹è¯•æœ‰æ•ˆIDè¿”å›ç”¨æˆ·
    }
    
    /**
     * @test  
     */
    public function getUserById_withInvalidId_throwsException(): void {
        // æµ‹è¯•æ— æ•ˆIDæŠ›å‡ºå¼‚å¸¸
    }
    
    /**
     * @test
     * @dataProvider invalidEmailProvider
     */
    public function createUser_withInvalidEmail_throwsValidationException(string $invalidEmail): void {
        // å‚æ•°åŒ–æµ‹è¯•
    }
    
    public function invalidEmailProvider(): array {
        return [
            'empty string' => [''],
            'without at symbol' => ['invalid-email'],
            'multiple at symbols' => ['test@@example.com'],
        ];
    }
}
```

------

#### **8. å®‰å…¨ç¼–ç è§„èŒƒ**

##### **8.1 SQL æ³¨å…¥é˜²æŠ¤**

> ä½¿ç”¨prepare

```php
class SecureUserRepository {
    private PDO $pdo;
    
    // âœ… ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
    public function findUserByCredentials(string $email, string $password): ?User {
        $stmt = $this->pdo->prepare('
            SELECT id, username, email, password_hash 
            FROM users 
            WHERE email = :email AND status = :status
        ');
        
        $stmt->execute([
            ':email' => $email,
            ':status' => 'active'
        ]);
        
        $userData = $stmt->fetch(PDO::FETCH_ASSOC);
        return $userData ? User::fromArray($userData) : null;
    }
    
    // âŒ å±é™©ï¼šå­—ç¬¦ä¸²æ‹¼æ¥
    public function findUserByEmailUnsafe(string $email): ?User {
        // SQLæ³¨å…¥æ¼æ´ï¼
        $sql = "SELECT * FROM users WHERE email = '{$email}'";
        return $this->pdo->query($sql)->fetchObject(User::class);
    }
}
```

##### **8.2 XSS é˜²æŠ¤**

> è¾“å‡ºè½¬ä¹‰

```php
class SecureTemplateRenderer {
    // âœ… è¾“å‡ºè½¬ä¹‰
    public function renderUserProfile(User $user): string {
        return sprintf(
            '<div class="user-profile">
                <h1>%s</h1>
                <div class="email">%s</div>
                <div class="bio">%s</div>
            </div>',
            $this->escapeHtml($user->getUsername()),
            $this->escapeHtml($user->getEmail()),
            $this->escapeHtml($user->getBio())
        );
    }
    
    private function escapeHtml(string $text): string {
        return htmlspecialchars($text, ENT_QUOTES | ENT_HTML5, 'UTF-8');
    }
}
```

------

#### **æ€»ç»“**

**Google Style Guide æ ¸å¿ƒåŸåˆ™ï¼š**

1. **âœ… å¯è¯»æ€§ä¼˜å…ˆ** - ä»£ç æ˜¯ç»™äººçœ‹çš„ï¼Œå…¶æ¬¡æ‰æ˜¯ç»™æœºå™¨æ‰§è¡Œ
2. **âœ… ä¸€è‡´æ€§** - æ•´ä¸ªé¡¹ç›®ä¿æŒç»Ÿä¸€çš„ç¼–ç é£æ ¼
3. **âœ… æ˜ç¡®æ€§** - å‘½åå’Œæ³¨é‡Šè¦æ¸…æ™°è¡¨è¾¾æ„å›¾
4. **âœ… å®‰å…¨æ€§** - å†…ç½®å®‰å…¨è€ƒè™‘ï¼Œé˜²èŒƒå¸¸è§æ¼æ´
5. **âœ… å¯ç»´æŠ¤æ€§** - ä¾¿äºåç»­ä¿®æ”¹å’Œæ‰©å±•

**å·¥å…·æ¨èï¼š**

```php
# PHP CodeSniffer + Google æ ‡å‡†
composer require --dev squizlabs/php_codesniffer
composer require --dev phpcompatibility/php-compatibility

# PHP CS Fixer https://github.com/PHP-CS-Fixer/PHP-CS-Fixer/blob/master/doc/rules/index.rst
composer require --dev friendsofphp/php-cs-fixer

# é…ç½® .php-cs-fixer.dist.php
<?php
$config = new PhpCsFixer\Config();
return $config
    ->setRules([
        '@PSR12' => true,
        'strict_param' => true,
        'array_syntax' => ['syntax' => 'short'],
    ])
    ->setFinder(
        PhpCsFixer\Finder::create()
            ->in(__DIR__.'/src')
            ->in(__DIR__.'/tests')
    );
```





- **ä»£ç è´¨é‡ï¼ˆåå‘³é“ï¼‰**ï¼šå¯è¯»æ€§/å¯æ‰©å±•/å¯ç»´æŠ¤/å¯æµ‹è¯•ï¼›åˆ†å±‚æ¸…æ™°/æ¨¡å—åŒ–å¥½/ç®€æ´æ˜“æ‡‚/è§„èŒƒä¸€è‡´/ä»£ç å¤ç”¨...ï¼›
- **ç¼–ç ç»†èŠ‚**ï¼šä¸šåŠ¡é€»è¾‘ã€è§„èŒƒã€è¾¹ç•Œã€å¼‚å¸¸ã€æ€§èƒ½ã€**æ—¥å¿—**ã€å¹¶å‘ã€å®‰å…¨ã€å…¼å®¹...
- **å•å…ƒæµ‹è¯•**ï¼šTDDè®¾è®¡æ€è·¯ï¼Œç¼–å†™å¯æµ‹è¯•æ€§ä»£ç ï¼Œä¾èµ–æ³¨å…¥mockï¼ŒUTçš„ROIå’Œè¦†ç›–ç‡æƒè¡¡
- **ä»£ç è¯„å®¡**ï¼šéœ€æ±‚æ‹†å°ï¼Œå°æ‰¹é‡CR<200è¡Œï¼Œå‚è€ƒ [Code Review Developer Guide](https://google.github.io/eng-practices/review/)
- **é™æ€ä»£ç æ£€æŸ¥**ï¼šäº†è§£Coverity/Gometalinterç­‰å·¥å…·çš„æ£€æŸ¥è§„åˆ™é›†ï¼Œè®¾ç½®è§„èŒƒ/å®‰å…¨/å›¢é˜Ÿä¸€è‡´æ€§çº¦æŸè´¨é‡çº¢çº¿
- **ä»£ç åº¦é‡**ï¼šå…³æ³¨è§„èŒƒé—®é¢˜æ•°/å®‰å…¨é—®é¢˜æ•°/åœˆå¤æ‚åº¦/é‡å¤ä»£ç ç‡...





# å¾®æœåŠ¡æ¶æ„

## **æ¶æ„æ¼”è¿›**

> å•ä½“åº”ç”¨/åˆ†å¸ƒå¼SOA/å¾®æœåŠ¡/æœåŠ¡ç½‘æ ¼ï¼Œäº†è§£å¾®æœåŠ¡å’ŒSOAçš„åŒºåˆ«

#### ğŸ—ï¸ æ¶æ„æ¼”è¿›å››é˜¶æ®µ

1. **å•ä½“æ¶æ„**

   æ‰€æœ‰åŠŸèƒ½æ¨¡å—ï¼ˆå¦‚ç”¨æˆ·ã€è®¢å•ã€æ”¯ä»˜ï¼‰éƒ½æ‰“åŒ…åœ¨ä¸€ä¸ªåº”ç”¨å†…ï¼Œå…±äº«åŒä¸€ä¸ªä»£ç åº“å’Œæ•°æ®åº“ã€‚å®ƒçš„ä¼˜ç‚¹æ˜¯å¼€å‘éƒ¨ç½²ç®€å•ï¼ŒåˆæœŸæ•ˆç‡é«˜ã€‚ä½†éšç€ä¸šåŠ¡å¤æ‚åº¦çš„æå‡ï¼Œä¼šæš´éœ²å‡º**æ‰©å±•æ€§å·®ã€æŠ€æœ¯æ ˆå›ºåŒ–ã€ç»´æŠ¤æˆæœ¬é«˜**ç­‰è‡´å‘½é—®é¢˜ï¼Œä¸€ä¸ªå¾®å°æ”¹åŠ¨éƒ½å¯èƒ½éœ€è¦é‡æ–°éƒ¨ç½²æ•´ä¸ªåº”ç”¨ã€‚

2. **åˆ†å¸ƒå¼SOA**

   ä¸ºäº†è§£å†³å•ä½“æ¶æ„çš„é›†æˆéš¾é¢˜ï¼ŒSOAï¼ˆ**Service-Oriented Architecture**ï¼Œé¢å‘æœåŠ¡çš„æ¶æ„ï¼‰åº”è¿è€Œç”Ÿã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†åº”ç”¨æ‹†åˆ†ä¸ºå¤šä¸ª**ç²—ç²’åº¦**çš„ã€å¯å¤ç”¨çš„æœåŠ¡ï¼ˆå¦‚ç”¨æˆ·æœåŠ¡ã€è®¢å•æœåŠ¡ï¼‰ï¼Œå¹¶é€šè¿‡ä¸€ä¸ªä¸­å¿ƒåŒ–çš„**ä¼ä¸šæœåŠ¡æ€»çº¿ï¼ˆESBï¼‰** è¿›è¡Œé›†æˆå’Œé€šä¿¡ã€‚ESBè´Ÿè´£æœåŠ¡è·¯ç”±ã€åè®®è½¬æ¢ã€æ¶ˆæ¯ä¼ é€’ç­‰ï¼Œä½†è¿™ä¹Ÿä½¿å¾—ESBå®¹æ˜“æˆä¸º**æ€§èƒ½å’Œå¤æ‚åº¦çš„ç“¶é¢ˆ**ã€‚

3. **å¾®æœåŠ¡æ¶æ„**

   å¾®æœåŠ¡å¯ä»¥çœ‹ä½œæ˜¯SOAç†å¿µçš„ä¸€ç§è½»é‡åŒ–å’Œç²¾ç»†åŒ–æ¼”è¿›ã€‚å®ƒå°†åº”ç”¨æ‹†åˆ†ä¸ºä¸€ç»„æ›´**å°ç²’åº¦**ã€**æ¾æ•£è€¦åˆ**çš„æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡å›´ç»•ç‰¹å®šçš„ä¸šåŠ¡èƒ½åŠ›æ„å»ºï¼Œå¹¶å¯ä»¥**ç‹¬ç«‹å¼€å‘ã€ç‹¬ç«‹éƒ¨ç½²ã€ç‹¬ç«‹æ‰©å±•**ã€‚å®ƒå»æ‰äº†ä¸­å¿ƒåŒ–çš„ESBï¼Œè½¬è€Œä½¿ç”¨APIç½‘å…³ã€æ³¨å†Œä¸­å¿ƒç­‰è½»é‡çº§ç»„ä»¶ï¼ŒæœåŠ¡é—´é€šè¿‡RESTæˆ–gRPCç­‰åè®®ç›´æ¥é€šä¿¡ã€‚

4. **æœåŠ¡ç½‘æ ¼**

   å½“å¾®æœåŠ¡æ•°é‡æ€¥å‰§è†¨èƒ€ï¼ŒæœåŠ¡é—´çš„é€šä¿¡ã€ç›‘æ§ã€å®‰å…¨ç­‰é€»è¾‘å˜å¾—å¼‚å¸¸å¤æ‚æ—¶ï¼ŒæœåŠ¡ç½‘æ ¼ï¼ˆå¦‚Istioï¼‰é€šè¿‡å°†è¿™éƒ¨åˆ†èƒ½åŠ›ä¸‹æ²‰åˆ°åŸºç¡€è®¾æ–½å±‚ï¼ˆä»¥Sidecarä»£ç†çš„å½¢å¼ï¼‰æ¥ç®€åŒ–å¾®æœåŠ¡æ²»ç†ï¼Œè®©å¼€å‘è€…èƒ½æ›´ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ã€‚

   

#### âš–ï¸ å¾®æœåŠ¡ä¸SOAçš„æ ¸å¿ƒåŒºåˆ«

ä¸ºäº†æ›´æ¸…æ™°åœ°å¯¹æ¯”ï¼Œæˆ‘å°†å®ƒä»¬çš„æ ¸å¿ƒå·®å¼‚æ•´ç†æˆäº†ä¸‹é¢çš„è¡¨æ ¼ã€‚

| ç»´åº¦           | SOA                                                       | å¾®æœåŠ¡                                                       |
| -------------- | --------------------------------------------------------- | ------------------------------------------------------------ |
| **è®¾è®¡ç›®æ ‡**   | **ä¼ä¸šçº§é›†æˆ**ï¼Œå¼ºè°ƒ**æœåŠ¡å¤ç”¨**å’Œç³»ç»Ÿæ•´åˆ                | **åº”ç”¨çº§æ•æ·**ï¼Œå¼ºè°ƒ**ç‹¬ç«‹è‡ªæ²»**å’Œå¿«é€Ÿäº¤ä»˜                   |
| **æœåŠ¡ç²’åº¦**   | **ç²—ç²’åº¦**ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„ä¸šåŠ¡é¢†åŸŸï¼ˆå¦‚â€œåº“å­˜ç®¡ç†â€æœåŠ¡ï¼‰  | **ç»†ç²’åº¦**ï¼Œéµå¾ªå•ä¸€èŒè´£åŸåˆ™ï¼ˆå¦‚å°†â€œåº“å­˜ç®¡ç†â€æ‹†åˆ†ä¸ºæŸ¥è¯¢ã€æ‰£å‡ç­‰æœåŠ¡ï¼‰ |
| **é€šä¿¡æ–¹å¼**   | **ä¸­å¿ƒåŒ–**çš„**ä¼ä¸šæœåŠ¡æ€»çº¿ï¼ˆESBï¼‰**ï¼Œä½¿ç”¨SOAPç­‰é‡é‡çº§åè®® | **å»ä¸­å¿ƒåŒ–**çš„**ç›´æ¥é€šä¿¡**ï¼ˆå¦‚APIç½‘å…³+æœåŠ¡å‘ç°ï¼‰ï¼Œä½¿ç”¨REST/gRPCç­‰è½»é‡çº§åè®® |
| **æ•°æ®ç®¡ç†**   | **å…±äº«æ•°æ®å­˜å‚¨**ï¼Œä¸åŒæœåŠ¡å¯èƒ½è®¿é—®åŒä¸€ä¸ªæ•°æ®åº“ï¼Œå­˜åœ¨è€¦åˆ  | **æ¯ä¸ªæœåŠ¡æ‹¥æœ‰ç‹¬ç«‹æ•°æ®åº“**ï¼ŒæœåŠ¡é—´é€šè¿‡APIè¿›è¡Œæ•°æ®äº¤äº’ï¼Œå½»åº•è§£è€¦ |
| **éƒ¨ç½²ä¸æ‰©å±•** | æœåŠ¡è€¦åˆåº¦é«˜ï¼Œ**éƒ¨ç½²ç›¸å¯¹å¤æ‚**ï¼Œæ‰©å±•å¸¸ä»¥æ•´ä¸ªåº”ç”¨ä¸ºå•ä½    | æœåŠ¡å¯**ç‹¬ç«‹éƒ¨ç½²å’Œæ‰©å±•**ï¼Œæ›´çµæ´»ï¼Œé€‚åˆäº‘ç¯å¢ƒ                 |
| **æŠ€æœ¯æ ˆ**     | å€¾å‘äº**ç»Ÿä¸€æŠ€æœ¯æ ˆ**                                      | é¼“åŠ±**æŠ€æœ¯å¤šæ ·æ€§**ï¼Œä¸åŒæœåŠ¡å¯é€‰æ‹©æœ€é€‚åˆçš„æŠ€æœ¯               |
| **æ²»ç†æ¨¡å¼**   | **é›†ä¸­å¼æ²»ç†**ï¼Œé€šè¿‡ESBç­‰åˆ¶å®šç»Ÿä¸€æ ‡å‡†                     | **å»ä¸­å¿ƒåŒ–æ²»ç†**ï¼Œå¼ºè°ƒå›¢é˜Ÿè‡ªæ²»å’ŒDevOpsæ–‡åŒ–                   |

ç®€å•æ¥è¯´ï¼ŒSOAæ›´åƒæ˜¯ä¸€ç§**ä¼ä¸šæ¶æ„æ€æƒ³**ï¼Œæ—¨åœ¨æ‰“é€šâ€œä¿¡æ¯å­¤å²›â€ï¼›è€Œå¾®æœåŠ¡åˆ™æ˜¯ä¸€ç§**åº”ç”¨æ¶æ„é£æ ¼**ï¼Œè¿½æ±‚æè‡´çš„æ•æ·ä¸å¼¹æ€§ã€‚æœ‰äººå½¢è±¡åœ°æ¯”å–»ï¼š**å¾®æœåŠ¡æ˜¯SOAåœ¨äº‘åŸç”Ÿæ—¶ä»£çš„è½»é‡çº§å®ç°å’Œæ¼”è¿›**ã€‚

#### ğŸ§­ å¦‚ä½•é€‰æ‹©é€‚åˆçš„æ¶æ„ï¼Ÿ

äº†è§£äº†åŒºåˆ«åï¼Œåœ¨å®é™…é¡¹ç›®ä¸­å¦‚ä½•é€‰æ‹©å‘¢ï¼Ÿ

- **é€‰æ‹©SOAè€ƒè™‘**ï¼šå½“éœ€è¦**æ•´åˆå¤šä¸ªé—ç•™ç³»ç»Ÿ**ï¼ˆå¦‚ERPã€CRMï¼‰ï¼Œå¹¶ä¸”å¼ºè°ƒ**æ ‡å‡†åŒ–å’Œå¤ç”¨**æ—¶ï¼ŒSOAæ˜¯åˆé€‚çš„ã€‚å®ƒæ›´é€‚åˆå¤§å‹ã€ç¨³å®šã€éœ€è¦æ·±åº¦é›†æˆçš„ä¼ä¸šç¯å¢ƒã€‚
- **é€‰æ‹©å¾®æœåŠ¡è€ƒè™‘**ï¼šå½“ä¸šåŠ¡éœ€è¦**å¿«é€Ÿè¿­ä»£å’Œè¯•é”™**ï¼Œå›¢é˜Ÿå…·å¤‡DevOpsèƒ½åŠ›ï¼Œå¹¶ä¸”ç³»ç»Ÿéœ€è¦**é«˜å¹¶å‘å’Œå¼¹æ€§ä¼¸ç¼©**æ—¶ï¼Œå¾®æœåŠ¡ä¼˜åŠ¿æ˜æ˜¾ã€‚å®ƒç‰¹åˆ«é€‚åˆäº’è”ç½‘åŒ–çš„ã€å¿«é€Ÿå‘å±•çš„ä¸šåŠ¡ã€‚
- **é‡è¦æé†’**ï¼š**ä¸è¦ä¸ºäº†å¾®æœåŠ¡è€Œå¾®æœåŠ¡**ã€‚å¾®æœåŠ¡ä¼šå¸¦æ¥åˆ†å¸ƒå¼äº‹åŠ¡ã€è¿ç»´å¤æ‚åº¦ã€ç½‘ç»œå»¶è¿Ÿç­‰æŒ‘æˆ˜ã€‚å»ºè®®é‡‡ç”¨**æ¸è¿›å¼æ¼”è¿›**çš„ç­–ç•¥ï¼Œå…ˆä»æ¨¡å—åŒ–å•ä½“å¼€å§‹ï¼Œéšç€ä¸šåŠ¡å’Œå›¢é˜Ÿçš„å‘å±•å†é€æ­¥æ‹†åˆ†ã€‚

<img src="å·¥ç¨‹ç´ å…»ç¯‡ï¼ˆä¸­çº§ï¼‰.assets/image-20260203122130237.png" alt="image-20260203122130237" style="zoom: 50%;" />







## **RPCæ¡†æ¶**

> gRPC/Spring/tRPCï¼ˆæºç èµ°è¯»ï¼‰ï¼Œé«˜æ€§èƒ½ç½‘ç»œæ¨¡å‹å®ç°ï¼Œæ’ä»¶åŒ–æ¶æ„AOPï¼Œå¾®æœåŠ¡æ²»ç†ç»„ä»¶

è®©æˆ‘ä»**å®ç°åŸç†ã€é«˜æ€§èƒ½ç½‘ç»œã€æ’ä»¶åŒ–æ¶æ„ã€å¾®æœåŠ¡æ²»ç†**å››ä¸ªç»´åº¦ä¸ºä½ æ·±å…¥è§£æRPCæ¡†æ¶ã€‚

#### ä¸€ã€ä¸»æµRPCæ¡†æ¶å¯¹æ¯”

| **ç»´åº¦**     | **gRPC**                        | **Spring Cloud (Feign/OpenFeign)** | **tRPC (è…¾è®¯è‡ªç ”)**              |
| ------------ | ------------------------------- | ---------------------------------- | -------------------------------- |
| **åè®®**     | HTTP/2 + Protocol Buffers       | HTTP/1.1 + REST/JSON               | æ”¯æŒå¤šåè®®(HTTP/2, tRPCç§æœ‰åè®®) |
| **åºåˆ—åŒ–**   | Protobuf (äºŒè¿›åˆ¶)               | JSON/XML (æ–‡æœ¬)                    | Protobuf/JSON                    |
| **æœåŠ¡å‘ç°** | ä¾èµ–å¤–éƒ¨(å¦‚Consul)              | é›†æˆEureka/Nacos                   | å†…ç½®(æ”¯æŒå¤šç§æ³¨å†Œä¸­å¿ƒ)           |
| **è´Ÿè½½å‡è¡¡** | å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡                  | Ribbon/Spring Cloud LoadBalancer   | å†…ç½®æ™ºèƒ½è´Ÿè½½å‡è¡¡                 |
| **å¼€å‘è¯­è¨€** | å¤šè¯­è¨€(Go, Java, C++, Pythonç­‰) | ä¸»è¦Javaç”Ÿæ€                       | å¤šè¯­è¨€(Go, C++, Java)            |
| **é€‚ç”¨åœºæ™¯** | å†…éƒ¨æœåŠ¡é—´é«˜æ€§èƒ½é€šä¿¡            | å¿«é€Ÿæ„å»ºå¾®æœåŠ¡(RESTfulé£æ ¼)        | è…¾è®¯å†…éƒ¨å¤§è§„æ¨¡å¾®æœåŠ¡             |

------

#### äºŒã€gRPCæºç èµ°è¯»ä¸æ ¸å¿ƒå®ç°

1. gRPCæ ¸å¿ƒæ¶æ„

```java
// gRPC Javaæ ¸å¿ƒç±»å›¾ç®€æ
ClientCall<ReqT, RespT>        // å®¢æˆ·ç«¯è°ƒç”¨æŠ½è±¡
ServerCall<ReqT, RespT>        // æœåŠ¡ç«¯è°ƒç”¨æŠ½è±¡
ManagedChannel                 // é€šé“ç®¡ç†ï¼Œæ ¸å¿ƒè¿æ¥ç®¡ç†å™¨
Server                         // æœåŠ¡ç«¯å®ä¾‹

// è°ƒç”¨æµç¨‹
1. å®¢æˆ·ç«¯: stub.method(request) 
   â†’ ClientCall.start()
   â†’ é€šè¿‡ManagedChannelé€‰æ‹©Transport
   â†’ åºåˆ—åŒ–è¯·æ±‚ â†’ å‘é€HTTP/2 Stream
   
2. æœåŠ¡ç«¯: ServerTransportListener.streamCreated()
   â†’ ååºåˆ—åŒ– â†’ è°ƒç”¨å®é™…æ–¹æ³•
   â†’ åºåˆ—åŒ–å“åº” â†’ è¿”å›HTTP/2 Stream
```

2. å…³é”®æºç è·¯å¾„

```bash
# gRPC Javaæºç æ ¸å¿ƒç›®å½•ç»“æ„
grpc-java/
â”œâ”€â”€ core/                    # æ ¸å¿ƒæŠ½è±¡å±‚
â”‚   â”œâ”€â”€ ClientCall.java
â”‚   â”œâ”€â”€ ServerCall.java
â”‚   â””â”€â”€ ManagedChannel.java
â”œâ”€â”€ stub/                   # å­˜æ ¹ç”Ÿæˆ
â”œâ”€â”€ protobuf/              # Protobufé›†æˆ
â”œâ”€â”€ netty/                 # Nettyä¼ è¾“å±‚å®ç°
â”‚   â”œâ”€â”€ NettyServer.java
â”‚   â””â”€â”€ NettyChannelBuilder.java
â””â”€â”€ okhttp/               # OkHttpä¼ è¾“å±‚å®ç°
```

3. æ ¸å¿ƒæµç¨‹å‰–æ

```java
// 1. å®¢æˆ·ç«¯è°ƒç”¨æµç¨‹
public class HelloClient {
    public void call() {
        // æ„å»ºChannel
        ManagedChannel channel = ManagedChannelBuilder.forAddress("localhost", 8080)
            .usePlaintext()
            .build();
        
        // åˆ›å»ºStub
        HelloServiceGrpc.HelloServiceBlockingStub stub = 
            HelloServiceGrpc.newBlockingStub(channel);
        
        // å®é™…è°ƒç”¨ï¼ˆå…³é”®ï¼‰
        HelloRequest request = HelloRequest.newBuilder()
            .setName("World")
            .build();
        
        // åº•å±‚ï¼šClientCall -> NettyClientTransport -> HTTP/2 Stream
        HelloResponse response = stub.sayHello(request);
    }
}

// 2. æœåŠ¡ç«¯å¤„ç†æµç¨‹
public class HelloServer {
    public static void main(String[] args) {
        // æ„å»ºServer
        Server server = ServerBuilder.forPort(8080)
            .addService(new HelloServiceImpl()) // æ³¨å†ŒæœåŠ¡å®ç°
            .build();
        
        server.start();
        
        // å…³é”®ï¼šServerTransportæ³¨å†Œåˆ°EventLoop
        // NettyServerTransportæ¥æ”¶è¯·æ±‚
        // â†’ è§£æHTTP/2å¤´éƒ¨
        // â†’ æŸ¥æ‰¾å¯¹åº”ServiceMethod
        // â†’ ååºåˆ—åŒ–Request
        // â†’ è°ƒç”¨ä¸šåŠ¡é€»è¾‘
        // â†’ åºåˆ—åŒ–Response
        // â†’ å†™å›HTTP/2 Stream
    }
}
```

------

#### ä¸‰ã€é«˜æ€§èƒ½ç½‘ç»œæ¨¡å‹å®ç°

##### 1. Reactoræ¨¡å¼ä¸Nettyå®ç°

```java
// Nettyçš„Reactoræ¨¡å¼å®ç°
EventLoopGroup bossGroup = new NioEventLoopGroup(1);  // æ¥æ”¶è¿æ¥
EventLoopGroup workerGroup = new NioEventLoopGroup();  // å¤„ç†IO

ServerBootstrap b = new ServerBootstrap();
b.group(bossGroup, workerGroup)
 .channel(NioServerSocketChannel.class)
 .childHandler(new ChannelInitializer<SocketChannel>() {
     @Override
     public void initChannel(SocketChannel ch) {
         ChannelPipeline p = ch.pipeline();
         // HTTP/2ç¼–è§£ç å™¨ï¼ˆgRPCä½¿ç”¨ï¼‰
         p.addLast(new Http2ConnectionHandlerBuilder()
             .frameListener(new Http2FrameListenerAdapter())
             .build());
         // ä¸šåŠ¡å¤„ç†å™¨
         p.addLast(new GrpcServerHandler());
     }
 });

// å…³é”®ä¼˜åŒ–ç‚¹ï¼š
// 1. é›¶æ‹·è´ï¼šé€šè¿‡CompositeByteBufå‡å°‘å†…å­˜æ‹·è´
// 2. å†…å­˜æ± ï¼šPooledByteBufAllocatoré‡ç”¨ç¼“å†²åŒº
// 3. Epollè¾¹ç¼˜è§¦å‘ï¼šå‡å°‘ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°ã€‚ ET vs LTï¼ˆè¾¹ç¼˜è§¦å‘ Edge-Triggered vs æ°´å¹³è§¦å‘Level-Triggeredï¼‰ï¼ŒLTæ¨¡å¼ï¼šå¯è¯»äº‹ä»¶ä¼šé‡å¤é€šçŸ¥ï¼ŒETæ¨¡å¼ï¼šåªåœ¨çŠ¶æ€å˜åŒ–æ—¶é€šçŸ¥ä¸€æ¬¡
```

> **Netty**

Netty æ˜¯ä¸€ä¸ª**å¼‚æ­¥äº‹ä»¶é©±åŠ¨**çš„ç½‘ç»œåº”ç”¨æ¡†æ¶ï¼Œç”¨äºå¿«é€Ÿå¼€å‘å¯ç»´æŠ¤çš„**é«˜æ€§èƒ½åè®®æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯**ã€‚

```java
// Netty çš„è®¾è®¡å“²å­¦
é«˜æ€§èƒ½ = å¼‚æ­¥éé˜»å¡ + Reactoræ¨¡å¼ + é›¶æ‹·è´ + å†…å­˜æ±  + ...
```



Reactor æ¨¡å¼ï¼š

**1. åŸºæœ¬ç»“æ„**

```markdown
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Reactor æ¨¡å¼                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Handle â”œâ”€â”€â”€â”€â”€â”€â–¶â”‚  Event  â”œâ”€â”€â”€â”€â”€â–¶â”‚ Handler â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚      (socket)     (select/epoll)   (ä¸šåŠ¡å¤„ç†)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**2. ä¸‰ç§å˜ä½“**

```java
// 1. å•Reactorå•çº¿ç¨‹
Thread: [accept] â†’ [read] â†’ [decode] â†’ [compute] â†’ [encode] â†’ [send]

// 2. å•Reactorå¤šçº¿ç¨‹
Main Reactor Thread: [accept] â†’ [read] â†’ [write]
Worker Thread Pool: [decode] â†’ [compute] â†’ [encode]

// 3. ä¸»ä»Reactorå¤šçº¿ç¨‹
Main Reactor: [accept] â†’ åˆ†å‘ç»™ SubReactor
Sub Reactor(Nä¸ª): [read/write] I/Oæ“ä½œ
Worker Thread Pool: ä¸šåŠ¡å¤„ç†
```



> **Nettyå…³é”®ä¼˜åŒ–ç‚¹æ·±åº¦è§£æ**

**1. é›¶æ‹·è´ï¼ˆZero-Copyï¼‰å®ç°**

**ä¼ ç»ŸIOçš„å¤šæ¬¡æ‹·è´é—®é¢˜ï¼š**

```markdown
ç”¨æˆ·ç©ºé—´     å†…æ ¸ç©ºé—´       ç¡¬ä»¶
   â†“            â†“           â†“
åº”ç”¨ç¼“å†²åŒº  â†’ Socketç¼“å†²åŒº â†’ ç½‘å¡
   â†‘            â†‘
   æ–‡ä»¶ç¼“å†²åŒº  â† ç£ç›˜
ï¼ˆ4æ¬¡æ‹·è´ï¼Œ2æ¬¡CPUå‚ä¸ï¼‰
```

å…¸å‹çš„**æ–‡ä»¶æœåŠ¡å™¨**åœºæ™¯ï¼š

```
æ—¶é—´çº¿       ç”¨æˆ·ç©ºé—´             å†…æ ¸ç©ºé—´               ç¡¬ä»¶
-------------------------------------------------------------------
  t0   â”‚  è°ƒç”¨read()ç³»ç»Ÿè°ƒç”¨
       â”‚  â†“                     
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
       â”‚                       
  t1   â”‚                    DMAæ‹·è´å¼€å§‹
       â”‚                    â†“
       â”‚                    ç£ç›˜æ•°æ® â†’ æ–‡ä»¶ç¼“å†²åŒº
       â”‚                    ï¼ˆç¬¬1æ¬¡æ‹·è´ï¼šç£ç›˜â†’å†…æ ¸ï¼‰
  t2   â”‚                    è¯»å–å®Œæˆï¼Œè¿”å›ç»“æœ
       â”‚  â†“
       â”œâ†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       â”‚
  t3   â”‚  CPUæ‹·è´æ•°æ®
       â”‚  â†“
       â”‚  æ–‡ä»¶ç¼“å†²åŒº â†’ åº”ç”¨ç¼“å†²åŒº
       â”‚  ï¼ˆç¬¬2æ¬¡æ‹·è´ï¼šå†…æ ¸â†’ç”¨æˆ·ç©ºé—´ï¼‰
       â”‚
  t4   â”‚  è°ƒç”¨write()ç³»ç»Ÿè°ƒç”¨
       â”‚  â†“
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
       â”‚
  t5   â”‚                    CPUæ‹·è´æ•°æ®
       â”‚                    â†“
       â”‚                    åº”ç”¨ç¼“å†²åŒº â†’ Socketç¼“å†²åŒº
       â”‚                    ï¼ˆç¬¬3æ¬¡æ‹·è´ï¼šç”¨æˆ·ç©ºé—´â†’å†…æ ¸ï¼‰
       â”‚
  t6   â”‚                    DMAæ‹·è´åˆ°ç½‘å¡
       â”‚                    â†“
       â”‚                    Socketç¼“å†²åŒº â†’ ç½‘å¡
       â”‚                    ï¼ˆç¬¬4æ¬¡æ‹·è´ï¼šå†…æ ¸â†’ç¡¬ä»¶ï¼‰
  t7   â”‚                    å†™å…¥å®Œæˆï¼Œè¿”å›
       â”‚  â†“
       â”œâ†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```



**Nettyé›¶æ‹·è´ä¼˜åŒ–ï¼š**

```java
// 1. CompositeByteBuf - è™šæ‹Ÿç¼“å†²åŒºç»„åˆ
public void handleCompositeBuffer(ChannelHandlerContext ctx) {
    // ä¼ ç»Ÿæ–¹å¼ï¼šéœ€è¦å†…å­˜æ‹·è´
    ByteBuf header = Unpooled.buffer(10);
    ByteBuf body = Unpooled.buffer(20);
    ByteBuf all = Unpooled.buffer(30);
    all.writeBytes(header).writeBytes(body);  // è¿™é‡Œæœ‰ä¸€æ¬¡æ‹·è´ï¼
    
    // Nettyä¼˜åŒ–ï¼šé›¶æ‹·è´ç»„åˆ
    CompositeByteBuf compositeBuf = Unpooled.compositeBuffer();
    compositeBuf.addComponents(true, header, body);  // æ— æ‹·è´ï¼
    // é€»è¾‘ä¸Šæ˜¯ä¸€ä¸ªBufferï¼Œç‰©ç†ä¸Šè¿˜æ˜¯åˆ†å¼€çš„
    
    ctx.writeAndFlush(compositeBuf);
}

// 2. æ–‡ä»¶ä¼ è¾“çš„é›¶æ‹·è´
public void sendFile(ChannelHandlerContext ctx, File file) throws IOException {
    FileRegion region = new DefaultFileRegion(
        file.getChannel(), 0, file.length()
    );
    
    ctx.write(region).addListener(future -> {
        if (future.isSuccess()) {
            System.out.println("File sent successfully");
        }
    });
    
    // åº•å±‚è°ƒç”¨ï¼šFileChannel.transferTo()
    // é€šè¿‡DMAï¼ˆç›´æ¥å†…å­˜è®¿é—®ï¼‰æŠ€æœ¯ï¼Œæ•°æ®ç›´æ¥ä»æ–‡ä»¶åˆ°ç½‘å¡
    // æ— éœ€ç»è¿‡ç”¨æˆ·ç©ºé—´ç¼“å†²åŒº
}
```

**DirectByteBufferä¸å†…å­˜æ˜ å°„ï¼š**

```java
// ç›´æ¥å†…å­˜åˆ†é…ï¼Œé¿å…å †å†…åˆ°å †å¤–çš„æ‹·è´
ByteBuf directBuffer = ByteBufAllocator.DEFAULT.directBuffer(1024);
try {
    // æ“ä½œç›´æ¥å†…å­˜
    directBuffer.writeBytes(data);
    
    // ä¸å †å†…å­˜çš„æ€§èƒ½å¯¹æ¯”
    ByteBuf heapBuffer = ByteBufAllocator.DEFAULT.heapBuffer(1024);
    // heapBufferéœ€è¦ä»JVMå †æ‹·è´åˆ°å†…æ ¸ç©ºé—´
} finally {
    directBuffer.release();  // é‡è¦ï¼šå¿…é¡»æ‰‹åŠ¨é‡Šæ”¾ï¼
}
```







##### 2. å¤šè·¯å¤ç”¨ä¸çº¿ç¨‹æ¨¡å‹

```java
// gRPCçº¿ç¨‹æ¨¡å‹ä¼˜åŒ–
@ExperimentalApi("çº¿ç¨‹æ¨¡å‹é…ç½®")
public class ThreadPoolConfig {
    // 1. IOçº¿ç¨‹æ± ï¼šå¤„ç†ç½‘ç»œäº‹ä»¶
    EventLoopGroup ioGroup = new NioEventLoopGroup(
        Runtime.getRuntime().availableProcessors(), 
        new DefaultThreadFactory("grpc-io")
    );
    
    // 2. ä¸šåŠ¡çº¿ç¨‹æ± ï¼šå¤„ç†å®é™…RPCè°ƒç”¨
    ExecutorService businessExecutor = Executors.newFixedThreadPool(
        200, 
        new ThreadFactoryBuilder()
            .setNameFormat("grpc-business-%d")
            .build()
    );
    
    // 3. å›è°ƒçº¿ç¨‹æ± ï¼šå¤„ç†å¼‚æ­¥å›è°ƒ
    ScheduledExecutorService callbackExecutor = 
        Executors.newScheduledThreadPool(4);
}
```

##### 3. é«˜æ€§èƒ½åºåˆ—åŒ–

```java
// Protobuf vs JSONæ€§èƒ½å¯¹æ¯”
public class SerializationBenchmark {
    // Protobufåºåˆ—åŒ–ï¼ˆäºŒè¿›åˆ¶ï¼Œç´§å‡‘ï¼‰
    // ä¼˜ç‚¹ï¼šä½“ç§¯å°(æ¯”JSONå°3-10å€)ã€è§£æå¿«(æ— éœ€åå°„)
    HelloRequest request = HelloRequest.newBuilder()
        .setName("test")
        .setId(123)
        .build();
    byte[] protoBytes = request.toByteArray();  // çº¦10-20å­—èŠ‚
    
    // JSONåºåˆ—åŒ–ï¼ˆæ–‡æœ¬ï¼Œå†—ä½™ï¼‰
    String json = "{\"name\":\"test\",\"id\":123}";  // çº¦25å­—èŠ‚
    // è§£æéœ€è¦åå°„ï¼Œæ€§èƒ½è¾ƒå·®
}
```

------

#### å››ã€æ’ä»¶åŒ–æ¶æ„ä¸AOPå®ç°

##### 1. gRPCæ‹¦æˆªå™¨æœºåˆ¶ï¼ˆAOPå®ç°ï¼‰

```java
// 1. å®¢æˆ·ç«¯æ‹¦æˆªå™¨
public class ClientInterceptorImpl implements ClientInterceptor {
    @Override
    public <ReqT, RespT> ClientCall<ReqT, RespT> interceptCall(
        MethodDescriptor<ReqT, RespT> method,
        CallOptions callOptions,
        Channel next) {
        
        return new SimpleForwardingClientCall<ReqT, RespT>(next.newCall(method, callOptions)) {
            @Override
            public void start(Listener<RespT> responseListener, Metadata headers) {
                // å‰ç½®å¤„ç†ï¼šæ·»åŠ è®¤è¯ä¿¡æ¯
                headers.put(Metadata.Key.of("token", Metadata.ASCII_STRING_MARSHALLER), 
                    "bearer xxx");
                
                // è°ƒç”¨è€—æ—¶ç»Ÿè®¡
                long start = System.currentTimeMillis();
                
                super.start(new SimpleForwardingClientCallListener<RespT>(responseListener) {
                    @Override
                    public void onClose(Status status, Metadata trailers) {
                        // åç½®å¤„ç†ï¼šç»Ÿè®¡è€—æ—¶
                        long cost = System.currentTimeMillis() - start;
                        log.info("RPCè°ƒç”¨è€—æ—¶: {}ms", cost);
                        super.onClose(status, trailers);
                    }
                }, headers);
            }
        };
    }
}

// 2. æœåŠ¡ç«¯æ‹¦æˆªå™¨
public class ServerInterceptorImpl implements ServerInterceptor {
    @Override
    public <ReqT, RespT> ServerCall.Listener<ReqT> interceptCall(
        ServerCall<ReqT, RespT> call,
        Metadata headers,
        ServerCallHandler<ReqT, RespT> next) {
        
        // è®¤è¯æ ¡éªŒ
        String token = headers.get(Metadata.Key.of("token", 
            Metadata.ASCII_STRING_MARSHALLER));
        if (!validateToken(token)) {
            call.close(Status.UNAUTHENTICATED, new Metadata());
            return new ServerCall.Listener<ReqT>() {};
        }
        
        return next.startCall(call, headers);
    }
}
```

##### 2. å¯æ’æ‹”æ¶æ„è®¾è®¡

```java
// æ’ä»¶æ³¨å†Œæœºåˆ¶
public class PluginManager {
    private Map<String, List<RpcPlugin>> plugins = new ConcurrentHashMap<>();
    
    public void registerPlugin(String point, RpcPlugin plugin) {
        plugins.computeIfAbsent(point, k -> new ArrayList<>()).add(plugin);
    }
    
    public <T> T executePlugins(String point, T context) {
        List<RpcPlugin> pluginList = plugins.get(point);
        if (pluginList != null) {
            for (RpcPlugin plugin : pluginList) {
                context = plugin.process(context);
            }
        }
        return context;
    }
}

// æ’ä»¶æ‰©å±•ç‚¹
public interface RpcPlugin {
    String POINT_CLIENT_PRE_CALL = "client.pre.call";
    String POINT_CLIENT_POST_CALL = "client.post.call";
    String POINT_SERVER_PRE_HANDLE = "server.pre.handle";
    String POINT_SERVER_POST_HANDLE = "server.post.handle";
    
    <T> T process(T context);
}

// ä½¿ç”¨ç¤ºä¾‹
public class MonitoringPlugin implements RpcPlugin {
    @Override
    public <T> T process(T context) {
        RpcContext ctx = (RpcContext) context;
        Metrics.recordRpcStart(ctx.getMethod(), ctx.getStartTime());
        return context;
    }
}
```

------

#### äº”ã€å¾®æœåŠ¡æ²»ç†ç»„ä»¶é›†æˆ

##### 1. æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡

```java
// å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å®ç°
public class SmartLoadBalancer {
    // 1. æœåŠ¡å‘ç°
    private ServiceDiscovery discovery;
    // 2. è´Ÿè½½å‡è¡¡ç­–ç•¥
    private LoadBalanceStrategy strategy;
    
    public Endpoint selectEndpoint(String serviceName) {
        // è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨
        List<Endpoint> endpoints = discovery.getEndpoints(serviceName);
        
        // è´Ÿè½½å‡è¡¡ç®—æ³•
        switch (strategy) {
            case ROUND_ROBIN:
                return roundRobin(endpoints);
            case RANDOM:
                return random(endpoints);
            case LEAST_ACTIVE:
                return leastActive(endpoints);
            case CONSISTENT_HASH:
                return consistentHash(endpoints);
        }
    }
    
    // æœ€å°‘æ´»è·ƒè°ƒç”¨
    private Endpoint leastActive(List<Endpoint> endpoints) {
        return endpoints.stream()
            .min(Comparator.comparingInt(e -> 
                getActiveCount(e.getAddress())))
            .orElseThrow();
    }
}
```

##### 2. ç†”æ–­ä¸é™çº§

```java
// ç†”æ–­å™¨å®ç°
public class CircuitBreaker {
    private enum State { CLOSED, OPEN, HALF_OPEN }
    
    private State state = State.CLOSED;
    private AtomicInteger failures = new AtomicInteger(0);
    private long lastFailureTime = 0;
    
    public <T> T execute(Supplier<T> supplier) {
        if (state == State.OPEN) {
            // ç†”æ–­çŠ¶æ€ï¼Œæ£€æŸ¥æ˜¯å¦è¿›å…¥åŠå¼€
            if (System.currentTimeMillis() - lastFailureTime > recoveryTimeout) {
                state = State.HALF_OPEN;
            } else {
                throw new CircuitBreakerOpenException();
            }
        }
        
        try {
            T result = supplier.get();
            
            if (state == State.HALF_OPEN) {
                // åŠå¼€çŠ¶æ€æˆåŠŸï¼Œå…³é—­ç†”æ–­å™¨
                state = State.CLOSED;
                failures.set(0);
            }
            
            return result;
        } catch (Exception e) {
            failures.incrementAndGet();
            lastFailureTime = System.currentTimeMillis();
            
            if (failures.get() >= failureThreshold) {
                state = State.OPEN;
            } else if (state == State.HALF_OPEN) {
                state = State.OPEN; // åŠå¼€çŠ¶æ€å¤±è´¥ï¼Œé‡æ–°æ‰“å¼€
            }
            
            throw e;
        }
    }
}
```

##### 3. åˆ†å¸ƒå¼è·Ÿè¸ª

```java
// å…¨é“¾è·¯è¿½è¸ª
public class TracingInterceptor implements ClientInterceptor {
    @Override
    public <ReqT, RespT> ClientCall<ReqT, RespT> interceptCall(
        MethodDescriptor<ReqT, RespT> method,
        CallOptions callOptions,
        Channel next) {
        
        // ä»ä¸Šä¸‹æ–‡è·å–Trace
        TraceContext trace = TraceContext.getCurrent();
        Span span = trace.createSpan("rpc.call", method.getFullMethodName());
        
        return new SimpleForwardingClientCall<ReqT, RespT>(
            next.newCall(method, callOptions)) {
            
            @Override
            public void start(Listener<RespT> responseListener, Metadata headers) {
                // æ³¨å…¥Traceä¿¡æ¯åˆ°header
                headers.put(TraceConstants.TRACE_ID, span.getTraceId());
                headers.put(TraceConstants.SPAN_ID, span.getSpanId());
                
                span.recordEvent("rpc.start");
                super.start(new SimpleForwardingClientCallListener<RespT>(responseListener) {
                    @Override
                    public void onClose(Status status, Metadata trailers) {
                        span.recordEvent("rpc.end");
                        span.setTag("status", status.getCode().toString());
                        span.finish();
                        super.onClose(status, trailers);
                    }
                }, headers);
            }
        };
    }
}
```

------

#### å…­ã€tRPCæ¡†æ¶ç‰¹è‰²åŠŸèƒ½

1. å¤šåè®®æ”¯æŒ

```java
// tRPCåè®®æ ˆ
public class TrpcProtocolStack {
    // 1. ä¼ è¾“å±‚åè®®
    Protocol transport = Protocol.builder()
        .add(TrpcProtocol.class)      // tRPCç§æœ‰åè®®
        .add(Http2Protocol.class)     // HTTP/2
        .add(Http1Protocol.class)     // HTTP/1.1
        .build();
    
    // 2. åºåˆ—åŒ–åè®®
    Serializer serializer = Serializer.builder()
        .add(ProtobufSerializer.class)
        .add(JsonSerializer.class)
        .add(MessagePackSerializer.class)
        .build();
    
    // 3. å‹ç¼©åè®®
    Compressor compressor = Compressor.builder()
        .add(GzipCompressor.class)
        .add(SnappyCompressor.class)
        .build();
}
```

2. æµå¼å¤„ç†

```java
// æœåŠ¡ç«¯æµå¼RPC
public class StreamServiceImpl {
    // 1. æœåŠ¡ç«¯æµ
    public void serverStream(HelloRequest request, 
                             StreamObserver<HelloResponse> responseObserver) {
        for (int i = 0; i < 10; i++) {
            HelloResponse response = HelloResponse.newBuilder()
                .setMessage("Message " + i)
                .build();
            responseObserver.onNext(response);
            Thread.sleep(1000);
        }
        responseObserver.onCompleted();
    }
    
    // 2. å®¢æˆ·ç«¯æµ
    public StreamObserver<HelloRequest> clientStream(
        StreamObserver<HelloResponse> responseObserver) {
        
        return new StreamObserver<HelloRequest>() {
            private List<String> messages = new ArrayList<>();
            
            @Override
            public void onNext(HelloRequest request) {
                messages.add(request.getName());
            }
            
            @Override
            public void onError(Throwable t) {
                // é”™è¯¯å¤„ç†
            }
            
            @Override
            public void onCompleted() {
                // å®¢æˆ·ç«¯å‘é€å®Œæ¯•ï¼Œè¿”å›æ±‡æ€»ç»“æœ
                HelloResponse response = HelloResponse.newBuilder()
                    .setMessage("Received " + messages.size() + " messages")
                    .build();
                responseObserver.onNext(response);
                responseObserver.onCompleted();
            }
        };
    }
}
```

------

#### ä¸ƒã€æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ

##### 1. è¿æ¥æ± ç®¡ç†

```java
public class ConnectionPoolManager {
    private Map<String, ConnectionPool> pools = new ConcurrentHashMap<>();
    
    public Connection getConnection(String endpoint) {
        ConnectionPool pool = pools.computeIfAbsent(endpoint, 
            k -> new ConnectionPool(
                maxConnections: 100,        // æœ€å¤§è¿æ¥æ•°
                minIdle: 10,                // æœ€å°ç©ºé—²è¿æ¥
                maxIdleTime: 300000,        // æœ€å¤§ç©ºé—²æ—¶é—´(5åˆ†é’Ÿ)
                validationInterval: 30000    // éªŒè¯é—´éš”(30ç§’)
            ));
        
        return pool.borrowObject();
    }
}
```

##### 2. è¶…æ—¶ä¸é‡è¯•ç­–ç•¥

```yaml
# è¶…æ—¶é…ç½®ç¤ºä¾‹
rpc:
  timeout:
    connect: 3000     # è¿æ¥è¶…æ—¶3ç§’
    read: 5000       # è¯»å–è¶…æ—¶5ç§’
    write: 5000      # å†™å…¥è¶…æ—¶5ç§’
    
  retry:
    maxAttempts: 3    # æœ€å¤§é‡è¯•æ¬¡æ•°
    backoff:
      initial: 100   # åˆå§‹å»¶è¿Ÿ100ms
      max: 3000      # æœ€å¤§å»¶è¿Ÿ3ç§’
      multiplier: 2  # æŒ‡æ•°é€€é¿ä¹˜æ•°
    retryableErrors: # å¯é‡è¯•çš„é”™è¯¯ç 
      - DEADLINE_EXCEEDED
      - UNAVAILABLE
```

##### 3. ç›‘æ§æŒ‡æ ‡é‡‡é›†

```java
public class RpcMetricsCollector {
    // å…³é”®æŒ‡æ ‡
    private Meter requestCounter = Metrics.meter("rpc.requests.total");
    private Timer responseTimer = Metrics.timer("rpc.response.time");
    private Counter errorCounter = Metrics.counter("rpc.errors.total");
    
    public void recordRequest(String method) {
        requestCounter.mark();
    }
    
    public void recordResponse(String method, long duration, boolean success) {
        responseTimer.record(duration, TimeUnit.MILLISECONDS);
        if (!success) {
            errorCounter.increment();
        }
    }
    
    // å®æ—¶è®¡ç®—QPS/TP99ç­‰
    public Stats getStats() {
        return new Stats(
            qps: requestCounter.getOneMinuteRate(),
            tp99: responseTimer.getSnapshot().getValue(0.99),
            errorRate: errorCounter.getCount() / (double)requestCounter.getCount()
        );
    }
}
```

------

#### å…«ã€å­¦ä¹ è·¯å¾„ä¸å®æˆ˜å»ºè®®

1. æºç å­¦ä¹ è·¯çº¿

```markdown
ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€ä½¿ç”¨
  â”œâ”€ ç¼–å†™ç®€å•çš„gRPCæœåŠ¡
  â”œâ”€ ç†è§£Protobufå®šä¹‰
  â””â”€ æŒæ¡æ‹¦æˆªå™¨ä½¿ç”¨

ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒåŸç†
  â”œâ”€ é˜…è¯»Netty HTTP/2å®ç°
  â”œâ”€ åˆ†ægRPC Stubç”Ÿæˆæœºåˆ¶
  â””â”€ ç†è§£æµæ§ä¸èƒŒå‹

ç¬¬ä¸‰é˜¶æ®µï¼šé«˜çº§ç‰¹æ€§
  â”œâ”€ ç ”ç©¶è¿æ¥æ± ä¸å¤šè·¯å¤ç”¨
  â”œâ”€ åˆ†æè´Ÿè½½å‡è¡¡ç®—æ³•
  â””â”€ å®ç°è‡ªå®šä¹‰æ‹¦æˆªå™¨
```



2.å®æˆ˜é¡¹ç›®å»ºè®®

- **å®ç°ç®€åŒ–ç‰ˆRPCæ¡†æ¶**ï¼šåŸºäºNettyå®ç°åŸºç¡€çš„RPCé€šä¿¡
- **æ‰©å±•gRPCæ‹¦æˆªå™¨**ï¼šå®ç°è®¤è¯ã€é™æµã€ç›‘æ§ç­‰æ’ä»¶
- **å¯¹æ¯”æµ‹è¯•**ï¼šç¼–å†™æ€§èƒ½å¯¹æ¯”æµ‹è¯•(gRPC vs Spring Cloud OpenFeign)
- **é›†æˆå®è·µ**ï¼šå°†RPCæ¡†æ¶é›†æˆåˆ°å¾®æœåŠ¡æ²»ç†ä½“ç³»ä¸­

3. å¸¸è§é—®é¢˜å®šä½

```bash
# 1. è¿æ¥é—®é¢˜
- æ£€æŸ¥ç½‘ç»œè¿é€šæ€§ï¼štelnet <host> <port>
- æŸ¥çœ‹é˜²ç«å¢™è®¾ç½®
- éªŒè¯TLS/SSLé…ç½®

# 2. æ€§èƒ½é—®é¢˜
- ä½¿ç”¨Wiresharkåˆ†æHTTP/2å¸§
- ç›‘æ§è¿æ¥æ± ä½¿ç”¨ç‡
- æ£€æŸ¥åºåˆ—åŒ–/ååºåˆ—åŒ–è€—æ—¶

# 3. å†…å­˜é—®é¢˜
- åˆ†æHeap Dump
- æ£€æŸ¥ByteBufæ³„æ¼
- ç›‘æ§Direct Memoryä½¿ç”¨
```

é€šè¿‡æ·±å…¥ç†è§£RPCæ¡†æ¶çš„å®ç°åŸç†ã€æŒæ¡é«˜æ€§èƒ½ç½‘ç»œç¼–ç¨‹ã€è®¾è®¡å¯æ‰©å±•çš„æ’ä»¶åŒ–æ¶æ„ï¼Œä½ èƒ½å¤Ÿæ„å»ºå‡ºé«˜å¯é ã€é«˜æ€§èƒ½çš„åˆ†å¸ƒå¼æœåŠ¡é€šä¿¡ä½“ç³»ã€‚å»ºè®®ä»gRPCæºç å…¥æ‰‹ï¼Œé€æ­¥æ‰©å±•åˆ°ç½‘ç»œæ¨¡å‹å’Œæ²»ç†ç»„ä»¶çš„å®ç°ï¼Œè¿™æ ·èƒ½å¤Ÿå»ºç«‹å®Œæ•´çš„çŸ¥è¯†ä½“ç³»ã€‚





## **åºåˆ—åŒ–åè®®**

> protobuf/json/xmlï¼Œæ€§èƒ½å’Œå‹ç¼©ç©ºé—´å¯¹æ¯”ï¼Œåºåˆ—åŒ–åŸç†tlvï¼Œåå°„å’ŒåŠ¨æ€è§£æç‰¹æ€§

è®©æˆ‘ä¸ºä½ è¯¦ç»†è§£æä¸‰å¤§åºåˆ—åŒ–åè®®çš„æ€§èƒ½ã€åŸç†å’Œç‰¹æ€§å¯¹æ¯”ã€‚

#### ä¸€ã€æ ¸å¿ƒå¯¹æ¯”æ€»è§ˆ

| **ç»´åº¦**         | **Protobuf**     | **JSON**       | **XML**        |
| ---------------- | ---------------- | -------------- | -------------- |
| **æ•°æ®æ ¼å¼**     | äºŒè¿›åˆ¶           | æ–‡æœ¬(UTF-8)    | æ–‡æœ¬(æ ‡è®°è¯­è¨€) |
| **åºåˆ—åŒ–é€Ÿåº¦**   | â­â­â­â­â­            | â­â­â­            | â­â­             |
| **ååºåˆ—åŒ–é€Ÿåº¦** | â­â­â­â­â­            | â­â­             | â­              |
| **æ•°æ®ä½“ç§¯**     | æå°(æ— æ ‡è®°)     | è¾ƒå¤§(å†—ä½™æ ‡è®°) | æå¤§(æ ‡ç­¾é—­åˆ) |
| **å¯è¯»æ€§**       | äºŒè¿›åˆ¶(ä¸å¯è¯»)   | ä¼˜ç§€           | ä¼˜ç§€           |
| **è·¨è¯­è¨€**       | ä¼˜ç§€(å¤šè¯­è¨€æ”¯æŒ) | ä¼˜ç§€(æ ‡å‡†æ ¼å¼) | ä¼˜ç§€(æ ‡å‡†æ ¼å¼) |
| **æ¨¡å¼æ¼”è¿›**     | ä¼˜ç§€(å‘åå…¼å®¹)   | ä¸€èˆ¬(æ‰‹åŠ¨å¤„ç†) | ä¸€èˆ¬(æ‰‹åŠ¨å¤„ç†) |
| **åŠ¨æ€è§£æ**     | éœ€è¦.protoæ–‡ä»¶   | åŸç”Ÿæ”¯æŒ       | åŸç”Ÿæ”¯æŒ       |
| **ä½¿ç”¨åœºæ™¯**     | å†…éƒ¨RPC/å­˜å‚¨     | API/é…ç½®æ–‡ä»¶   | ä¼ä¸šç³»ç»Ÿ/æ–‡æ¡£  |

------

#### äºŒã€æ€§èƒ½ä¸ä½“ç§¯è¯¦ç»†å¯¹æ¯”

##### **1. åŸºå‡†æµ‹è¯•æ•°æ®**

```java
// æµ‹è¯•æ•°æ®ç»“æ„
public class User {
    long id = 123456789012345L;
    String name = "å¼ ä¸‰";
    String email = "zhangsan@example.com";
    int age = 30;
    List<String> tags = Arrays.asList("vip", "active", "premium");
    Map<String, String> metadata = Map.of("city", "Beijing", "country", "CN");
}

// åºåˆ—åŒ–æ€§èƒ½æµ‹è¯•ç»“æœ
public class SerializationBenchmark {
    public static void main(String[] args) {
        User user = new User();
        
        // åºåˆ—åŒ–ç»“æœå¯¹æ¯”
        Map<String, PerformanceResult> results = new HashMap<>();
        
        // 1. Protobuf
        results.put("Protobuf", new PerformanceResult(
            size: 78,                     // å­—èŠ‚æ•°
            serializeTime: 0.12,          // åºåˆ—åŒ–æ—¶é—´(ms)
            deserializeTime: 0.08,        // ååºåˆ—åŒ–æ—¶é—´(ms)
            compressionRatio: 1.0         // å‹ç¼©æ¯”åŸºå‡†
        ));
        
        // 2. JSON (Jackson)
        results.put("JSON", new PerformanceResult(
            size: 156,                    // 2.0x Protobuf
            serializeTime: 0.45,          // 3.75x
            deserializeTime: 0.62,        // 7.75x
            compressionRatio: 2.0
        ));
        
        // 3. XML (JAXB)
        results.put("XML", new PerformanceResult(
            size: 342,                    // 4.38x Protobuf
            serializeTime: 1.23,          // 10.25x
            deserializeTime: 2.15,        // 26.88x
            compressionRatio: 4.38
        ));
        
        // 4. é™„åŠ å¯¹æ¯”
        results.put("JSON(GZIP)", new PerformanceResult(
            size: 112,                    // å‹ç¼©å
            serializeTime: 0.85,          // åŒ…å«å‹ç¼©æ—¶é—´
            deserializeTime: 0.92,
            compressionRatio: 1.44
        ));
        
        results.put("MessagePack", new PerformanceResult(
            size: 102,                    // 1.31x
            serializeTime: 0.18,          // 1.5x
            deserializeTime: 0.15,        // 1.88x
            compressionRatio: 1.31
        ));
    }
}
```

##### **2. ä½“ç§¯å¯¹æ¯”åˆ†æ**

```markdown
æ•°æ®å¤§å°å¯¹æ¯”ï¼ˆå­—èŠ‚ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ XML              â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 342 bytes  â”‚
â”‚ JSON             â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 156 bytes         â”‚
â”‚ JSON(GZIP)       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 112 bytes          â”‚
â”‚ MessagePack      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 102 bytes          â”‚
â”‚ Protobuf         â–ˆâ–ˆâ–ˆâ–ˆ 78 bytes              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å‹ç¼©æ•ˆç‡åˆ†æï¼š
Protobufç›¸æ¯”JSONï¼š
- ä½“ç§¯å‡å°‘ï¼š50-80%
- ç½‘ç»œä¼ è¾“æ—¶é—´ï¼šå‡å°‘50%ä»¥ä¸Š
- å­˜å‚¨æˆæœ¬ï¼šæ˜¾è‘—é™ä½

åŸå› åˆ†æï¼š
1. æ— å­—æ®µåå­˜å‚¨ï¼šä½¿ç”¨å­—æ®µç¼–å·(1,2,3...)
2. å˜é•¿æ•´æ•°ç¼–ç ï¼šå°æ•°å­—å ç”¨æ›´å°‘å­—èŠ‚
3. äºŒè¿›åˆ¶æ ¼å¼ï¼šæ— éœ€è½¬ä¹‰å­—ç¬¦
```

##### **3. æ€§èƒ½å¼€é”€åˆ†è§£**

```java
// æ€§èƒ½å¼€é”€åˆ†æ
public class PerformanceBreakdown {
    public void analyze() {
        // Protobufä¼˜åŒ–ç‚¹ï¼š
        // 1. æ— åå°„ï¼ˆä»£ç ç”Ÿæˆï¼‰
        // 2. æµå¼è§£æ
        // 3. é›¶æ‹·è´æ”¯æŒ
        // 4. é¢„è®¡ç®—å¤§å°
        
        // JSONå¼€é”€æ¥æºï¼š
        // 1. å­—ç¬¦ä¸²å¤„ç†ï¼ˆUTF-8ç¼–è§£ç ï¼‰
        // 2. åŠ¨æ€ç±»å‹æ£€æŸ¥
        // 3. æ ‘ç»“æ„æ„å»º
        // 4. è½¬ä¹‰å­—ç¬¦å¤„ç†
        
        // XMLå¼€é”€æ¥æºï¼š
        // 1. æ ‡ç­¾è§£æï¼ˆå¼€å§‹/ç»“æŸæ ‡ç­¾ï¼‰
        // 2. å‘½åç©ºé—´å¤„ç†
        // 3. å±æ€§è§£æ
        // 4. æ–‡æ¡£æ ‘æ„å»º
    }
}
```

------

#### ä¸‰ã€Protobufåºåˆ—åŒ–åŸç†ï¼ˆTLVç¼–ç ï¼‰

**1. TLVï¼ˆTag-Length-Valueï¼‰ç»“æ„**

```markdown
Protobufç¼–ç æ ¼å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tag    â”‚  Length  â”‚  Value  â”‚
â”‚ (1-5å­—èŠ‚)â”‚ (å¯é€‰)   â”‚ (å˜é•¿)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Tagç»„æˆï¼šfield_number << 3 | wire_type
- field_number: å­—æ®µç¼–å·(1,2,3...)
- wire_type: ç¼–ç ç±»å‹(0-5)
```

**2. Wire Typeç±»å‹è¡¨**

| **Wire Type** | **ç±»å‹**         | **å«ä¹‰** | **ç¤ºä¾‹**                 |
| ------------- | ---------------- | -------- | ------------------------ |
| 0             | Varint           | å˜é•¿æ•´æ•° | int32, int64, bool, enum |
| 1             | 64-bit           | å›ºå®š64ä½ | fixed64, double          |
| 2             | Length-delimited | é•¿åº¦åˆ†éš” | string, bytes, åµŒå¥—æ¶ˆæ¯  |
| 3             | Start group      | ç»„å¼€å§‹   | (å·²åºŸå¼ƒ)                 |
| 4             | End group        | ç»„ç»“æŸ   | (å·²åºŸå¼ƒ)                 |
| 5             | 32-bit           | å›ºå®š32ä½ | fixed32, float           |

**3. Varintç¼–ç åŸç†**

> å˜é•¿æ•°å­—ç¼–ç 

```java
// Varintç¼–ç ï¼šå°æ•°å­—ç”¨æ›´å°‘å­—èŠ‚
public class VarintEncoding {
    // ç¼–ç è§„åˆ™ï¼šæ¯ä¸ªå­—èŠ‚æœ€é«˜ä½æ˜¯ç»§ç»­æ ‡å¿—
    // 1è¡¨ç¤ºè¿˜æœ‰åç»­å­—èŠ‚ï¼Œ0è¡¨ç¤ºç»“æŸ
    
    public static byte[] encodeVarint(long value) {
        byte[] buffer = new byte[10]; // æœ€å¤š10å­—èŠ‚
        int pos = 0;
        
        while (true) {
            // å–ä½7ä½
            byte b = (byte)(value & 0x7F);
            value >>>= 7;
            
            if (value != 0) {
                b |= 0x80; // è®¾ç½®æœ€é«˜ä½ä¸º1
            }
            
            buffer[pos++] = b;
            
            if (value == 0) {
                break;
            }
        }
        
        return Arrays.copyOf(buffer, pos);
    }
    
    // ç¤ºä¾‹ï¼šæ•°å­—300çš„ç¼–ç 
    // 300 = 0x12C = 100101100
    // åˆ†è§£ä¸ºï¼š0101100(ä½7ä½) 0000010(é«˜7ä½)
    // ç¼–ç ï¼š0xAC 0x02
    // 0xAC = 10101100 (æœ€é«˜ä½1è¡¨ç¤ºç»§ç»­)
    // 0x02 = 00000010 (æœ€é«˜ä½0è¡¨ç¤ºç»“æŸ)
}
```

**4. æ¶ˆæ¯ç¼–ç ç¤ºä¾‹**

```protobuf
// Protobufå®šä¹‰
syntax = "proto3";
message Person {
  int32 id = 1;          // å­—æ®µç¼–å·1
  string name = 2;       // å­—æ®µç¼–å·2
  string email = 3;      // å­—æ®µç¼–å·3
  bool is_vip = 4;       // å­—æ®µç¼–å·4
}

// æ•°æ®å®ä¾‹
Person person = Person.newBuilder()
    .setId(42)              // id = 42
    .setName("Alice")       // name = "Alice"
    .setEmail("alice@test.com")
    .setIsVip(true)
    .build();
äºŒè¿›åˆ¶ç¼–ç ç»“æœï¼ˆ16è¿›åˆ¶ï¼‰ï¼š
08 2A 12 05 41 6C 69 63 65 1A 0E 61 6C 69 63 65 40 74 65 73 74 2E 63 6F 6D 20 01

è§£ç åˆ†æï¼š
1. idå­—æ®µ: 08 2A
   - Tag: 08 = 00001000
     * field_number: 00001 = 1 (idå­—æ®µ)
     * wire_type: 000 = 0 (Varintç±»å‹)
   - Value: 2A = 00101010 = 42

2. nameå­—æ®µ: 12 05 41 6C 69 63 65
   - Tag: 12 = 00010010
     * field_number: 00010 = 2 (nameå­—æ®µ)
     * wire_type: 010 = 2 (Length-delimited)
   - Length: 05 = 5 (å­—ç¬¦ä¸²é•¿åº¦)
   - Value: 41 6C 69 63 65 = "Alice"

3. emailå­—æ®µ: 1A 0E 61 6C 69 63 65 40 74 65 73 74 2E 63 6F 6D
   - Tag: 1A = 00011010
     * field_number: 00011 = 3 (emailå­—æ®µ)
     * wire_type: 010 = 2
   - Length: 0E = 14
   - Value: 61 6C 69 63 65 40 74 65 73 74 2E 63 6F 6D = "alice@test.com"

4. is_vipå­—æ®µ: 20 01
   - Tag: 20 = 00100000
     * field_number: 00100 = 4 (is_vipå­—æ®µ)
     * wire_type: 000 = 0
   - Value: 01 = 1 (true)
```

------



#### å››ã€åå°„ä¸åŠ¨æ€è§£æç‰¹æ€§

##### **1. é™æ€ä»£ç ç”Ÿæˆ vs åŠ¨æ€è§£æ**

```java
// 1. é™æ€ä»£ç ç”Ÿæˆï¼ˆProtobufæ¨èæ–¹å¼ï¼‰
// ç¼–è¯‘æ—¶ç”ŸæˆJavaç±»ï¼Œæ— åå°„å¼€é”€
public class StaticProtobufExample {
    public void staticUsage() {
        // ç¼–è¯‘æ—¶ç”Ÿæˆçš„ç±»
        Person person = Person.newBuilder()
            .setId(123)
            .setName("Test")
            .build();
        
        // åºåˆ—åŒ–
        byte[] data = person.toByteArray();
        
        // ååºåˆ—åŒ–
        Person parsed = Person.parseFrom(data);
        
        // æ— åå°„ï¼Œç›´æ¥è®¿é—®
        int id = person.getId();  // ç›´æ¥æ–¹æ³•è°ƒç”¨
    }
}

// 2. åŠ¨æ€åå°„ï¼ˆJSON/XMLæ–¹å¼ï¼‰
public class DynamicJsonExample {
    public void dynamicUsage() throws JsonProcessingException {
        ObjectMapper mapper = new ObjectMapper();
        
        // è¿è¡Œæ—¶åå°„è§£æ
        String json = "{\"id\":123,\"name\":\"Test\"}";
        
        // ååºåˆ—åŒ–ï¼ˆä½¿ç”¨åå°„ï¼‰
        Map<String, Object> map = mapper.readValue(json, Map.class);
        
        // åŠ¨æ€è®¿é—®
        Object id = map.get("id");  // åå°„+ç±»å‹è½¬æ¢
        Object name = map.get("name");
        
        // åºåˆ—åŒ–ï¼ˆåå°„éå†å­—æ®µï¼‰
        String jsonOutput = mapper.writeValueAsString(map);
    }
}
```

##### **2. Protobufåå°„API**

```java
// Protobufçš„åå°„æ¥å£ï¼ˆè™½ç„¶ä¸æ¨èï¼Œä½†æ”¯æŒï¼‰
public class ProtobufReflection {
    public void dynamicProtobuf() throws InvalidProtocolBufferException {
        // 1. è·å–Descriptorï¼ˆæ¨¡å¼æè¿°ï¼‰
        Descriptors.Descriptor descriptor = Person.getDescriptor();
        
        // 2. åŠ¨æ€æ„å»ºæ¶ˆæ¯
        DynamicMessage.Builder builder = DynamicMessage.newBuilder(descriptor);
        
        // 3. é€šè¿‡å­—æ®µæè¿°ç¬¦è®¾ç½®å€¼
        Descriptors.FieldDescriptor idField = 
            descriptor.findFieldByName("id");
        Descriptors.FieldDescriptor nameField = 
            descriptor.findFieldByName("name");
        
        builder.setField(idField, 123);
        builder.setField(nameField, "Dynamic");
        
        // 4. æ„å»ºæ¶ˆæ¯
        DynamicMessage message = builder.build();
        
        // 5. åºåˆ—åŒ–
        byte[] data = message.toByteArray();
        
        // 6. åŠ¨æ€è¯»å–
        for (Descriptors.FieldDescriptor field : descriptor.getFields()) {
            if (message.hasField(field)) {
                Object value = message.getField(field);
                System.out.println(field.getName() + ": " + value);
            }
        }
    }
}
```

##### **3. åŠ¨æ€è§£ææ€§èƒ½å¯¹æ¯”**

```java
public class ReflectionBenchmark {
    // æµ‹è¯•ç»“æœï¼ˆ10000æ¬¡æ“ä½œï¼Œå•ä½ï¼šmsï¼‰
    Map<String, Long> results = new HashMap<>();
    
    // Protobufé™æ€ä»£ç ç”Ÿæˆ
    results.put("Protobuf-Static", 12L);
    
    // ProtobufåŠ¨æ€åå°„
    results.put("Protobuf-Dynamic", 145L);   // 12å€æ…¢
    
    // Jacksonåå°„
    results.put("Jackson-Reflection", 85L);
    
    // Jackson with Schema
    results.put("Jackson-Schema", 45L);
    
    // ç»“è®ºï¼š
    // 1. é™æ€ä»£ç ç”Ÿæˆæ¯”åå°„å¿«10-20å€
    // 2. Protobufåå°„æ¯”Jacksonåå°„æ…¢
    // 3. æœ‰æ¨¡å¼çš„JSONè§£ææ¯”æ— æ¨¡å¼å¿«
}
```

##### **4. JSON SchemaåŠ¨æ€éªŒè¯**

```json
// JSON Schemaå®šä¹‰
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "properties": {
    "id": {
      "type": "integer",
      "minimum": 1
    },
    "name": {
      "type": "string",
      "minLength": 1,
      "maxLength": 100
    },
    "email": {
      "type": "string",
      "format": "email"
    }
  },
  "required": ["id", "name"]
}
// ä½¿ç”¨SchemaéªŒè¯
public class JsonSchemaValidation {
    public void validateWithSchema() {
        JsonSchemaFactory factory = JsonSchemaFactory.getInstance(VersionFlag.V7);
        
        // åŠ è½½Schema
        JsonSchema schema = factory.getSchema(
            getClass().getResourceAsStream("/person.schema.json"));
        
        // è§£æJSON
        JsonNode data = mapper.readTree("{\"id\":1,\"name\":\"Test\"}");
        
        // éªŒè¯
        Set<ValidationMessage> errors = schema.validate(data);
        
        if (!errors.isEmpty()) {
            throw new ValidationException("JSONéªŒè¯å¤±è´¥: " + errors);
        }
    }
}
```

------

#### äº”ã€é«˜çº§ç‰¹æ€§å¯¹æ¯”

##### **1. æ¨¡å¼æ¼”è¿›èƒ½åŠ›**

```protobuf
// Protobufå‡ºè‰²çš„å‘åå…¼å®¹æ€§
message Person {
  // ä¿ç•™å·²åˆ é™¤å­—æ®µçš„ç¼–å·ï¼Œé˜²æ­¢é‡ç”¨
  reserved 4, 9 to 11;
  reserved "deleted_field";
  
  int32 id = 1;
  string name = 2;
  
  // æ–°å­—æ®µï¼šå¯é€‰å­—æ®µï¼Œæ—§å®¢æˆ·ç«¯å¯å¿½ç•¥
  optional string new_field = 20;
  
  // å­—æ®µè§„åˆ™å˜æ›´ï¼š
  // optional -> repeated âœ… (å…¼å®¹)
  // required -> optional âŒ (ç ´åæ€§å˜æ›´)
  
  // ç±»å‹å˜æ›´ï¼š
  // int32 -> int64 âœ… (å…¼å®¹ï¼Œå¯èƒ½æˆªæ–­)
  // string -> bytes âœ… (äºŒè¿›åˆ¶å…¼å®¹)
  // sint32 -> int32 âœ… (ç¼–ç ä¸åŒä½†å…¼å®¹)
}


// JSONæ¨¡å¼æ¼”è¿›éœ€è¦æ‰‹åŠ¨å¤„ç†
{
  // ç‰ˆæœ¬1
  "v1": {
    "id": 123,
    "name": "Alice"
  },
  
  // ç‰ˆæœ¬2ï¼šæ·»åŠ æ–°å­—æ®µ
  "v2": {
    "id": 123,
    "name": "Alice",
    "email": "alice@test.com",  // æ–°å¢
    "version": 2               // ç‰ˆæœ¬æ ‡è¯†
  },
  
  // å‘åå…¼å®¹ç­–ç•¥ï¼š
  // 1. æ·»åŠ versionå­—æ®µ
  // 2. æ–°å­—æ®µè®¾ä¸ºå¯é€‰
  // 3. ä¸åˆ é™¤å­—æ®µï¼Œæ ‡è®°ä¸ºåºŸå¼ƒ
}
```

##### **2. é»˜è®¤å€¼ä¸ç±»å‹ç³»ç»Ÿ**

```protobuf
// Protobufå¼ºç±»å‹ä¸é»˜è®¤å€¼
message User {
  // æ ‡é‡ç±»å‹æœ‰æ˜ç¡®çš„é»˜è®¤å€¼
  int32 count = 1;       // é»˜è®¤: 0
  string name = 2;       // é»˜è®¤: "" (ç©ºå­—ç¬¦ä¸²)
  bool active = 3;       // é»˜è®¤: false
  repeated string tags = 4;  // é»˜è®¤: []
  optional string email = 5;  // é»˜è®¤: æœªè®¾ç½®
  
  // æšä¸¾
  enum Status {
    UNKNOWN = 0;  // æšä¸¾ç¬¬ä¸€ä¸ªå€¼å¿…é¡»æ˜¯0
    ACTIVE = 1;
    INACTIVE = 2;
  }
  Status status = 6;  // é»˜è®¤: UNKNOWN(0)
}
// JSONåŠ¨æ€ç±»å‹ä¸ç©ºå€¼é—®é¢˜
{
  "count": 0,        // æ•°å­—0 vs æœªè®¾ç½®ï¼Ÿ
  "name": "",        // ç©ºå­—ç¬¦ä¸² vs nullï¼Ÿ
  "active": false,   // æ˜ç¡®false
  "tags": [],        // ç©ºæ•°ç»„
  "email": null,     // æ˜ç¡®null
  
  // é—®é¢˜ï¼š
  // 1. 0ã€""ã€nullã€undefinedè¯­ä¹‰ä¸åŒ
  // 2. ç±»å‹åœ¨è¿è¡Œæ—¶ç¡®å®š
  // 3. éœ€è¦é¢å¤–éªŒè¯
}
```



##### **3. å‹ç¼©ä¸ä¼˜åŒ–**

```java
// å‹ç¼©æ•ˆæœå¯¹æ¯”
public class CompressionComparison {
    public void compareCompression() {
        // åŸå§‹æ•°æ®
        String json = "{...}";  // 1KB JSON
        byte[] proto = ...;     // åŒç­‰æ•°æ®Protobuf
        
        // GZIPå‹ç¼©
        byte[] jsonGzip = gzipCompress(json.getBytes());
        byte[] protoGzip = gzipCompress(proto);
        
        // ç»“æœï¼š
        // JSONåŸå§‹: 1000å­—èŠ‚
        // JSON+GZIP: 320å­—èŠ‚
        // ProtobufåŸå§‹: 400å­—èŠ‚
        // Protobuf+GZIP: 280å­—èŠ‚
        
        // åŸå› ï¼šProtobufè‡ªèº«å·²å‹ç¼©ï¼ŒGZIPå¢ç›Šæœ‰é™
        // JSONæ–‡æœ¬å‹ç¼©æ•ˆæœå¥½
    }
}
```

------

#### å…­ã€å®é™…åº”ç”¨åœºæ™¯é€‰æ‹©æŒ‡å—

##### **1. é€‰æ‹©çŸ©é˜µ**

```yaml
# æ ¹æ®éœ€æ±‚é€‰æ‹©åºåˆ—åŒ–åè®®
åœºæ™¯éœ€æ±‚çŸ©é˜µ:

é«˜æ€§èƒ½å†…éƒ¨é€šä¿¡:
  - æ¨è: Protobuf
  - åŸå› : æ€§èƒ½æœ€é«˜ï¼Œä½“ç§¯æœ€å°
  - ç¤ºä¾‹: å¾®æœåŠ¡RPCã€æ¸¸æˆç½‘ç»œåè®®

å¯¹å¤–REST API:
  - æ¨è: JSON
  - åŸå› : å¯è¯»æ€§å¥½ï¼Œæµè§ˆå™¨åŸç”Ÿæ”¯æŒ
  - ç¤ºä¾‹: Web APIã€ç§»åŠ¨ç«¯æ¥å£

é…ç½®æ–‡ä»¶/å…ƒæ•°æ®:
  - å€™é€‰: JSON/YAML/XML
  - JSON: ç®€å•ç»“æ„
  - YAML: äººç±»å¯è¯»é…ç½®
  - XML: å¤æ‚ç»“æ„éªŒè¯
  - ç¤ºä¾‹: Springé…ç½®ã€K8s YAML

å¤§æ•°æ®å­˜å‚¨:
  - æ¨è: Protobuf/Parquet/Avro
  - Protobuf: ç´§å‡‘å­˜å‚¨
  - Parquet: åˆ—å¼å­˜å‚¨åˆ†æ
  - Avro: Hadoopç”Ÿæ€
  - ç¤ºä¾‹: æ—¥å¿—å­˜å‚¨ã€æ•°æ®æ¹–

è·¨å¹³å°æ•°æ®äº¤æ¢:
  - æ¨è: JSON/Protobuf
  - JSON: å‰ç«¯/ç§»åŠ¨ç«¯
  - Protobuf: åç«¯/ç‰©è”ç½‘
  - ç¤ºä¾‹: æ··åˆåº”ç”¨
```

##### **2. æ··åˆä½¿ç”¨ç­–ç•¥**

```java
// ç½‘å…³å±‚åè®®è½¬æ¢
public class GatewayProtocolConverter {
    // å†…éƒ¨ä½¿ç”¨Protobufï¼Œå¯¹å¤–æš´éœ²JSON
    public String internalToExternal(byte[] protobufData) {
        // 1. ååºåˆ—åŒ–Protobuf
        InternalMessage internal = InternalMessage.parseFrom(protobufData);
        
        // 2. è½¬æ¢ä¸ºDTO
        ExternalDTO dto = convertToDTO(internal);
        
        // 3. åºåˆ—åŒ–ä¸ºJSON
        return objectMapper.writeValueAsString(dto);
    }
    
    // æ”¯æŒå¤šç§åè®®
    public byte[] handleRequest(String contentType, byte[] body) {
        switch (contentType) {
            case "application/json":
                return processJson(body);
            case "application/x-protobuf":
                return processProtobuf(body);
            case "application/xml":
                return processXml(body);
            default:
                throw new UnsupportedMediaTypeException();
        }
    }
}
```

##### **3. æ€§èƒ½ä¼˜åŒ–æŠ€å·§**

```java
// Protobufæ€§èƒ½ä¼˜åŒ–
public class ProtobufOptimization {
    // 1. é‡ç”¨Builderå‡å°‘GC
    private final Person.Builder builder = Person.newBuilder();
    
    public byte[] serializeReuse(PersonData data) {
        builder.clear();
        builder.setId(data.id())
               .setName(data.name());
        return builder.build().toByteArray();
    }
    
    // 2. é¢„è®¡ç®—å¤§å°
    public byte[] serializeWithSize(Person person) {
        int size = person.getSerializedSize();
        byte[] buffer = new byte[size];
        CodedOutputStream output = CodedOutputStream.newInstance(buffer);
        person.writeTo(output);
        return buffer;
    }
    
    // 3. ä½¿ç”¨Unsafeæ“ä½œ
    public byte[] serializeUnsafe(Person person) {
        int size = person.getSerializedSize();
        ByteBuffer buffer = ByteBuffer.allocateDirect(size);
        person.writeTo(ByteBufferCodedOutputStream.newInstance(buffer));
        return buffer.array();
    }
}

// JSONæ€§èƒ½ä¼˜åŒ–
public class JsonOptimization {
    // 1. é‡ç”¨ObjectMapper
    private static final ObjectMapper mapper = new ObjectMapper();
    
    // 2. ä½¿ç”¨Streaming APIå¤„ç†å¤§æ–‡ä»¶
    public void streamLargeJson(String filePath) throws IOException {
        JsonFactory factory = mapper.getFactory();
        try (JsonParser parser = factory.createParser(new File(filePath))) {
            while (parser.nextToken() != null) {
                // æµå¼å¤„ç†ï¼Œä¸åŠ è½½æ•´ä¸ªæ–‡ä»¶
                String field = parser.getCurrentName();
                if ("id".equals(field)) {
                    parser.nextToken();
                    int id = parser.getIntValue();
                }
            }
        }
    }
    
    // 3. å¯ç”¨ç‰¹æ€§
    static {
        mapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
        mapper.configure(MapperFeature.ACCEPT_CASE_INSENSITIVE_PROPERTIES, true);
        mapper.configure(JsonParser.Feature.ALLOW_COMMENTS, true);
    }
}
```

------

#### ä¸ƒã€ç°ä»£åºåˆ—åŒ–åè®®æ‰©å±•

**1. æ–°å…´åè®®å¯¹æ¯”**

| **åè®®**        | **ç‰¹ç‚¹**                | **æ€§èƒ½** | **ä½“ç§¯** | **ç”Ÿæ€**     |
| --------------- | ----------------------- | -------- | -------- | ------------ |
| **FlatBuffers** | é›¶è§£æï¼Œç›´æ¥è®¿é—®        | â­â­â­â­â­    | è¾ƒå°     | ä¸­ç­‰         |
| **Cap'n Proto** | é›¶æ‹·è´ï¼Œç±»ä¼¼FlatBuffers | â­â­â­â­â­    | å°       | ä¸­ç­‰         |
| **Avro**        | è‡ªå¸¦Schemaï¼ŒHadoopç”Ÿæ€  | â­â­â­      | å°       | ä¼˜ç§€(Hadoop) |
| **MessagePack** | äºŒè¿›åˆ¶JSON              | â­â­â­â­     | è¾ƒå°     | ä¼˜ç§€         |
| **CBOR**        | ç®€æ´äºŒè¿›åˆ¶JSON          | â­â­â­â­     | å°       | ä¸­ç­‰         |

**2. FlatBuffersé›¶æ‹·è´åŸç†**

```cpp
// FlatBufferså†…å­˜å¸ƒå±€
struct Person {
  id: int;
  name: string;  // å­—ç¬¦ä¸²åç§»é‡
  email: string;  // å­—ç¬¦ä¸²åç§»é‡
  vtable_offset: int;  // è™šè¡¨åç§»
}

// ç›´æ¥è®¿é—®ï¼Œæ— éœ€è§£æ
const Person* person = GetPerson(buffer);
int id = person->id();  // ç›´æ¥å†…å­˜è®¿é—®
const char* name = person->name();  // é€šè¿‡åç§»é‡è®¿é—®
```

3. **åè®®é€‰æ‹©å†³ç­–æ ‘**

<img src="å·¥ç¨‹ç´ å…»ç¯‡ï¼ˆä¸­çº§ï¼‰.assets/image-20260203153319488.png" alt="image-20260203153319488" style="zoom:50%;" />

#### æ€»ç»“

##### **å…³é”®å»ºè®®**

1. **ä¼˜å…ˆè€ƒè™‘Protobuf**ï¼šå¯¹äºå†…éƒ¨æœåŠ¡é€šä¿¡ã€æ•°æ®å­˜å‚¨
2. **JSONç”¨äºè¾¹ç•Œ**ï¼šå¯¹å¤–APIã€å‰ç«¯é€šä¿¡
3. **XMLç”¨äºè§„èŒƒ**ï¼šéœ€è¦ä¸¥æ ¼éªŒè¯çš„åœºæ™¯
4. **è€ƒè™‘æ··åˆæ¶æ„**ï¼šç½‘å…³å±‚è¿›è¡Œåè®®è½¬æ¢
5. **åŸºå‡†æµ‹è¯•å†³ç­–**ï¼šç”¨å®é™…æ•°æ®åšé€‰æ‹©

##### **æœ€ä½³å®è·µ**

- **Protobuf**ï¼šå†…éƒ¨å¾®æœåŠ¡ã€gRPCã€æ•°æ®æŒä¹…åŒ–
- **JSON**ï¼šREST APIã€é…ç½®æ–‡ä»¶ã€å‰ç«¯é€šä¿¡
- **XML**ï¼šä¼ä¸šé›†æˆã€æ–‡æ¡£æ ‡è®°ã€éœ€è¦SchemaéªŒè¯
- **äºŒè¿›åˆ¶åè®®**ï¼šæ¸¸æˆã€ç‰©è”ç½‘ã€é«˜é¢‘äº¤æ˜“

##### **æœªæ¥è¶‹åŠ¿**

- **Schema Registry**ï¼šé›†ä¸­ç®¡ç†åè®®å®šä¹‰
- **å¤šåè®®ç½‘å…³**ï¼šè‡ªåŠ¨åè®®è½¬æ¢
- **äºŒè¿›åˆ¶ä¼˜åŒ–**ï¼šArrow/Parquetåˆ—å¼å­˜å‚¨
- **é›¶æ‹·è´æŠ€æœ¯**ï¼šFlatBuffers/Cap'n Proto





## **æœåŠ¡æ³¨å†Œå’Œè·¯ç”±å‘ç°**

> etcd/consul/zk/polarisï¼Œåˆ†SETç­‰åŠ¨æ€è·¯ç”±åŠŸèƒ½

#### ä¸€ã€æœåŠ¡æ³¨å†Œå‘ç°æ ¸å¿ƒæ¦‚å¿µ

**1. åŸºæœ¬æµç¨‹**

<img src="å·¥ç¨‹ç´ å…»ç¯‡ï¼ˆä¸­çº§ï¼‰.assets/image-20260203163252866.png" alt="image-20260203163252866" style="zoom:50%;" />

**2. æ ¸å¿ƒåŠŸèƒ½ç»„ä»¶**

```markdown
æœåŠ¡æ³¨å†Œå‘ç° = æœåŠ¡æ³¨å†Œ + å¥åº·æ£€æŸ¥ + æœåŠ¡å‘ç° + é…ç½®ç®¡ç†
```

#### äºŒã€ä¸»æµæ–¹æ¡ˆå¯¹æ¯”åˆ†æ

##### **1. æŠ€æœ¯é€‰å‹å¯¹æ¯”è¡¨**

| **ç»´åº¦**       | **etcd**      | **Consul**       | **ZooKeeper** | **Polaris** | **Nacos** |
| -------------- | ------------- | ---------------- | ------------- | ----------- | --------- |
| **å¼€å‘è¯­è¨€**   | Go            | Go               | Java          | Go          | Java      |
| **æ•°æ®æ¨¡å‹**   | KVå­˜å‚¨        | æœåŠ¡/KV          | ZNodeæ ‘       | æœåŠ¡/å®ä¾‹   | æœåŠ¡/å®ä¾‹ |
| **ä¸€è‡´æ€§åè®®** | Raft          | Raft             | ZAB           | Raft        | Raft/AP   |
| **å¥åº·æ£€æŸ¥**   | ç®€å•TTL       | å¤šæ–¹å¼(HTTP/TCP) | ä¼šè¯å¿ƒè·³      | å¤šæ–¹å¼      | å¤šæ–¹å¼    |
| **æœåŠ¡å‘ç°**   | éœ€äºŒæ¬¡å¼€å‘    | åŸç”Ÿæ”¯æŒ         | éœ€äºŒæ¬¡å¼€å‘    | åŸç”Ÿæ”¯æŒ    | åŸç”Ÿæ”¯æŒ  |
| **é…ç½®ä¸­å¿ƒ**   | æ”¯æŒ          | æ”¯æŒ             | æ”¯æŒ          | æ”¯æŒ        | æ”¯æŒ      |
| **å¤šæ•°æ®ä¸­å¿ƒ** | æœ‰é™æ”¯æŒ      | ä¼˜ç§€             | æœ‰é™æ”¯æŒ      | æ”¯æŒ        | æ”¯æŒ      |
| **DNSæ”¯æŒ**    | æ—             | å†…ç½®             | æ—             | æ—           | æ—         |
| **ç›‘æ§UI**     | ç®€å•          | ä¸°å¯Œ             | ç®€å•          | ä¸°å¯Œ        | ä¸°å¯Œ      |
| **å­¦ä¹ æ›²çº¿**   | ä¸­ç­‰          | ä½               | é«˜            | ä½          | ä½        |
| **äº‘åŸç”Ÿ**     | ä¼˜ç§€(K8såŸç”Ÿ) | è‰¯å¥½             | ä¸€èˆ¬          | ä¼˜ç§€        | ä¼˜ç§€      |

##### **2. è¯¦ç»†å¯¹æ¯”åˆ†æ**

###### **etcd - K8sçš„åŸºçŸ³**

```yaml
# etcdæ ¸å¿ƒç‰¹æ€§ï¼š
# 1. å¼ºä¸€è‡´æ€§KVå­˜å‚¨
# 2. Leaseæœºåˆ¶ï¼ˆç§Ÿçº¦ï¼‰
# 3. Watchæœºåˆ¶ï¼ˆç›‘å¬ï¼‰
# 4. å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶

# å…¸å‹ä½¿ç”¨åœºæ™¯ï¼š
apiVersion: v1
kind: Pod
metadata:
  name: myapp
  annotations:
    # etcdä¸­å­˜å‚¨çš„è·¯å¾„
    etcd-path: "/registry/pods/default/myapp"
spec:
  containers:
  - name: app
    image: myapp:1.0
```

**ä¼˜åŠ¿**ï¼š

- é«˜æ€§èƒ½ï¼š10k+ QPS
- ç®€å•å¯é ï¼šæ ¸å¿ƒåŠŸèƒ½æ˜ç¡®
- K8sç”Ÿæ€é›†æˆï¼šå¤©ç„¶ä¼˜åŠ¿

**åŠ£åŠ¿**ï¼š

- åŠŸèƒ½å•ä¸€ï¼šéœ€è¦äºŒæ¬¡å¼€å‘æœåŠ¡å‘ç°
- è¿ç»´å¤æ‚ï¼šéœ€è¦ä¸“ä¸šç»´æŠ¤

###### **Consul - åŠŸèƒ½å…¨é¢çš„æœåŠ¡ç½‘æ ¼**

```hcl
# Consulé…ç½®ç¤ºä¾‹
datacenter = "dc1"
server = true
bootstrap_expect = 3
node_name = "consul-server-1"

# æœåŠ¡å®šä¹‰
service {
  name = "web"
  id = "web-1"
  port = 8080
  
  # å¥åº·æ£€æŸ¥
  check {
    id = "api"
    name = "HTTP API"
    http = "http://localhost:8080/health"
    interval = "10s"
    timeout = "5s"
  }
  
  # æ ‡ç­¾ç”¨äºè·¯ç”±
  tags = ["v1", "primary", "zone=us-east-1a"]
}
```

**ä¼˜åŠ¿**ï¼š

- åŠŸèƒ½å…¨é¢ï¼šæœåŠ¡å‘ç°ã€é…ç½®ã€å¥åº·æ£€æŸ¥ä¸€ä½“
- å¤šæ•°æ®ä¸­å¿ƒï¼šä¼˜ç§€çš„è·¨DCæ”¯æŒ
- DNSæ¥å£ï¼šä¼ ç»Ÿåº”ç”¨æ— ç¼æ¥å…¥

**åŠ£åŠ¿**ï¼š

- ç›¸å¯¹è¾ƒé‡
- è¿ç»´å¤æ‚åº¦é«˜

###### **ZooKeeper - è€ç‰Œåˆ†å¸ƒå¼åè°ƒ**

```java
// ZooKeeper Javaå®¢æˆ·ç«¯ç¤ºä¾‹
public class ServiceRegistry {
    private ZooKeeper zk;
    
    public void registerService(String serviceName, String instanceInfo) {
        // åˆ›å»ºæœåŠ¡èŠ‚ç‚¹
        String servicePath = "/services/" + serviceName;
        if (zk.exists(servicePath, false) == null) {
            zk.create(servicePath, null, 
                     ZooDefs.Ids.OPEN_ACL_UNSAFE, 
                     CreateMode.PERSISTENT);
        }
        
        // åˆ›å»ºä¸´æ—¶å®ä¾‹èŠ‚ç‚¹
        String instancePath = servicePath + "/instance-";
        zk.create(instancePath, instanceInfo.getBytes(),
                 ZooDefs.Ids.OPEN_ACL_UNSAFE,
                 CreateMode.EPHEMERAL_SEQUENTIAL);
    }
}
```

**ä¼˜åŠ¿**ï¼š

- ä¹…ç»è€ƒéªŒï¼šHadoop/HBaseç­‰å¤§è§„æ¨¡ä½¿ç”¨
- å¼ºä¸€è‡´æ€§ï¼šé‡‘èçº§ä¸€è‡´æ€§ä¿è¯
- åŠŸèƒ½ä¸°å¯Œï¼šé”ã€é€‰ä¸¾ã€é˜Ÿåˆ—ç­‰

**åŠ£åŠ¿**ï¼š

- Javaä¾èµ–ï¼šGCé—®é¢˜å¯èƒ½å½±å“ç¨³å®šæ€§
- å†™æ€§èƒ½ç“¶é¢ˆï¼šæ‰€æœ‰å†™æ“ä½œç»è¿‡Leader
- è¿ç»´å¤æ‚

###### **Polaris - è…¾è®¯å¼€æºçš„æœåŠ¡æ²»ç†å¹³å°**

```yaml
# PolarisæœåŠ¡æ³¨å†Œé…ç½®
polaris:
  server-addr: 127.0.0.1:8091
  namespace: default
  service:
    name: user-service
    namespace: Production
    metadata:
      version: v1.0
      region: ap-guangzhou
      zone: zone-a
    healthCheck:
      type: HEARTBEAT
      heartbeat:
        ttl: 10
```

**ä¼˜åŠ¿**ï¼š

- æœåŠ¡æ²»ç†ä¸€ä½“ï¼šç†”æ–­ã€é™æµã€è·¯ç”±
- åŠ¨æ€è·¯ç”±ï¼šä¸°å¯Œè·¯ç”±ç­–ç•¥
- æ˜“ç”¨æ€§å¥½ï¼šå®Œæ•´æ§åˆ¶å°
- äº‘åŸç”Ÿï¼šK8sæ·±åº¦é›†æˆ

**åŠ£åŠ¿**ï¼š

- ç›¸å¯¹å¹´è½»
- ç¤¾åŒºç”Ÿæ€è¾ƒå°



#### ä¸‰ã€æ ¸å¿ƒåŠŸèƒ½å®ç°åŸç†

##### **1. æœåŠ¡æ³¨å†Œæœºåˆ¶**

```java
// æœåŠ¡æ³¨å†Œçš„æ ¸å¿ƒé€»è¾‘
public class ServiceRegistryImpl {
    // æ³¨å†ŒæœåŠ¡å®ä¾‹
    public void register(ServiceInstance instance) {
        // 1. æ„é€ æ³¨å†Œæ•°æ®
        Registration registration = new Registration(
            serviceName: instance.getServiceName(),
            instanceId: instance.getInstanceId(),
            host: instance.getHost(),
            port: instance.getPort(),
            metadata: instance.getMetadata(),
            timestamp: System.currentTimeMillis()
        );
        
        // 2. åºåˆ—åŒ–
        byte[] data = serialize(registration);
        
        // 3. å†™å…¥æ³¨å†Œä¸­å¿ƒ
        // etcd: put(/services/{serviceName}/{instanceId}, data)
        // Consul: PUT /v1/agent/service/register
        // ZK: create(/services/{serviceName}/{instanceId}, data, EPHEMERAL)
        
        // 4. å¯åŠ¨å¥åº·æ£€æŸ¥
        startHealthCheck(instance);
        
        // 5. å®šæ—¶å¿ƒè·³
        scheduleHeartbeat(instance);
    }
    
    // å¿ƒè·³ä¿æŒ
    private void scheduleHeartbeat(ServiceInstance instance) {
        ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(1);
        scheduler.scheduleAtFixedRate(() -> {
            try {
                // æ›´æ–°TTLæˆ–ç»­çº¦
                renewLease(instance);
            } catch (Exception e) {
                // é‡è¯•é€»è¾‘
                retryRegister(instance);
            }
        }, 0, 30, TimeUnit.SECONDS); // 30ç§’å¿ƒè·³
    }
}
```

##### **2. æœåŠ¡å‘ç°æœºåˆ¶**

> æ‹‰å–æ³¨å†Œçš„æœåŠ¡
>
> watchæœºåˆ¶

```java
// æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡
public class ServiceDiscovery {
    private final LoadBalancer loadBalancer;
    private final Cache<ServiceName, List<ServiceInstance>> cache;
    
    // è·å–æœåŠ¡å®ä¾‹
    public ServiceInstance getInstance(String serviceName) {
        // 1. æœ¬åœ°ç¼“å­˜è·å–
        List<ServiceInstance> instances = cache.getIfPresent(serviceName);
        
        if (instances == null || instances.isEmpty()) {
            // 2. ä»æ³¨å†Œä¸­å¿ƒæ‹‰å–
            instances = fetchFromRegistry(serviceName);
            cache.put(serviceName, instances);
        }
        
        // 3. å¥åº·æ£€æŸ¥è¿‡æ»¤
        instances = filterHealthyInstances(instances);
        
        // 4. è´Ÿè½½å‡è¡¡é€‰æ‹©
        return loadBalancer.select(serviceName, instances);
    }
    
    // ç›‘å¬æœåŠ¡å˜åŒ–
    public void watchService(String serviceName) {
        // Watchæœºåˆ¶å®ç°
        // etcd: watch(/services/{serviceName})
        // Consul: blocking query
        // ZK: getChildren with watcher
        
        watcher.watch(serviceName, event -> {
            // æœåŠ¡å®ä¾‹å˜åŒ–
            List<ServiceInstance> newInstances = fetchFromRegistry(serviceName);
            
            // æ›´æ–°ç¼“å­˜
            cache.put(serviceName, newInstances);
            
            // é€šçŸ¥è®¢é˜…è€…
            notifySubscribers(serviceName, newInstances);
        });
    }
}
```

##### **3. å¥åº·æ£€æŸ¥æœºåˆ¶å¯¹æ¯”**

```java
// å¥åº·æ£€æŸ¥ç­–ç•¥
public interface HealthChecker {
    // 1. å¿ƒè·³æ£€æŸ¥ï¼ˆetcd/Consul/ZKé€šç”¨ï¼‰
    class HeartbeatChecker implements HealthChecker {
        public boolean check(ServiceInstance instance) {
            // æ£€æŸ¥æœ€åå¿ƒè·³æ—¶é—´
            long lastHeartbeat = getLastHeartbeat(instance);
            return System.currentTimeMillis() - lastHeartbeat < timeout;
        }
    }
    
    // 2. TCPæ£€æŸ¥ï¼ˆConsul/Polarisæ”¯æŒï¼‰
    class TcpChecker implements HealthChecker {
        public boolean check(ServiceInstance instance) {
            try (Socket socket = new Socket()) {
                socket.connect(
                    new InetSocketAddress(instance.getHost(), instance.getPort()),
                    5000 // 5ç§’è¶…æ—¶
                );
                return true;
            } catch (IOException e) {
                return false;
            }
        }
    }
    
    // 3. HTTPæ£€æŸ¥ï¼ˆConsul/Polarisæ”¯æŒï¼‰
    class HttpChecker implements HealthChecker {
        public boolean check(ServiceInstance instance) {
            try {
                HttpResponse response = httpClient.execute(
                    new HttpGet("http://" + instance.getHost() + ":" + instance.getPort() + "/health")
                );
                return response.getStatusLine().getStatusCode() == 200;
            } catch (Exception e) {
                return false;
            }
        }
    }
    
    // 4. è„šæœ¬æ£€æŸ¥ï¼ˆConsulæ”¯æŒï¼‰
    class ScriptChecker implements HealthChecker {
        public boolean check(ServiceInstance instance) {
            // æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
            Process process = Runtime.getRuntime().exec("check_script.sh");
            int exitCode = process.waitFor();
            return exitCode == 0;
        }
    }
}
```

------

#### å››ã€åŠ¨æ€è·¯ç”±ï¼šSETæ¨¡å‹ä¸é«˜çº§è·¯ç”±

##### **1. SETæ¨¡å‹è¯¦è§£**

SETï¼ˆService Environment Topologyï¼‰æ˜¯**è…¾è®¯åœ¨æµ·é‡æœåŠ¡ä¸­æ€»ç»“çš„æ¶æ„æ¨¡å¼**ï¼Œç”¨äº**æœåŠ¡åˆ†ç»„å’Œéš”ç¦»**ã€‚

**SETæ¶æ„åŸç†**

```markdown
ä¼ ç»Ÿæ¶æ„é—®é¢˜ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ‰€æœ‰æœåŠ¡å®ä¾‹æ··åˆéƒ¨ç½²          â”‚
â”‚  åŒ—äº¬æœºæˆ¿  â”‚  ä¸Šæµ·æœºæˆ¿  â”‚  å¹¿å·æœºæˆ¿  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
é—®é¢˜ï¼šè·¨æœºæˆ¿è°ƒç”¨å»¶è¿Ÿé«˜ï¼Œæ•…éšœæ‰©æ•£é£é™©å¤§

SETæ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SET-A   â”‚ SET-B   â”‚ SET-C   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åŒ—äº¬æœºæˆ¿ â”‚ ä¸Šæµ·æœºæˆ¿ â”‚ å¹¿å·æœºæˆ¿ â”‚
â”‚ å®Œæ•´æœåŠ¡ â”‚ å®Œæ•´æœåŠ¡ â”‚ å®Œæ•´æœåŠ¡ â”‚
â”‚ æ ˆ      â”‚ æ ˆ      â”‚ æ ˆ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ç‰¹ç‚¹ï¼šæ¯ä¸ªSETå†…æœåŠ¡è‡ªæ´½ï¼Œæ•…éšœéš”ç¦»
```

**SETç»´åº¦å®šä¹‰**

```yaml
# SETå¤šç»´åº¦åˆ’åˆ†
set-dimensions:
  # 1. åœ°åŸŸç»´åº¦ï¼ˆåŒåŸå¤šæ´»ï¼‰
  - name: region
    values: ["ååŒ—", "åä¸œ", "åå—", "è¥¿å—"]
  
  # 2. å¯ç”¨åŒºç»´åº¦ï¼ˆå®¹ç¾ï¼‰
  - name: zone
    values: ["zone-a", "zone-b", "zone-c"]
  
  # 3. ç¯å¢ƒç»´åº¦ï¼ˆè“ç»¿å‘å¸ƒï¼‰
  - name: env
    values: ["prod", "staging", "canary"]
  
  # 4. ç‰ˆæœ¬ç»´åº¦ï¼ˆç°åº¦å‘å¸ƒï¼‰
  - name: version
    values: ["v1.0", "v1.1", "v2.0"]
  
  # 5. ä¸šåŠ¡å•å…ƒï¼ˆå•å…ƒåŒ–ï¼‰
  - name: cell
    values: ["cell-001", "cell-002", "cell-003"]
```

**SETè·¯ç”±ç­–ç•¥å®ç°**

```java
// SETè·¯ç”±ç­–ç•¥
public class SetRoutingStrategy implements RoutingStrategy {
    // SETåŒ¹é…è§„åˆ™
    private Map<String, String> setRules;
    
    @Override
    public List<ServiceInstance> route(String serviceName, 
                                       List<ServiceInstance> instances,
                                       RouteContext context) {
        // 1. è·å–è°ƒç”¨æ–¹SETä¿¡æ¯
        String callerSet = context.getCallerSet();
        
        // 2. ä¼˜å…ˆé€‰æ‹©åŒSETå®ä¾‹
        List<ServiceInstance> sameSetInstances = instances.stream()
            .filter(instance -> {
                String calleeSet = instance.getMetadata().get("set");
                return isSameSet(callerSet, calleeSet);
            })
            .collect(Collectors.toList());
        
        // 3. å¦‚æœåŒSETæ— å®ä¾‹ï¼ŒæŒ‰é™çº§ç­–ç•¥é€‰æ‹©
        if (!sameSetInstances.isEmpty()) {
            return sameSetInstances;
        }
        
        // 4. é™çº§ç­–ç•¥ï¼šåŒæœºæˆ¿ -> åŒåœ°åŸŸ -> è·¨åœ°åŸŸ
        return fallbackRouting(instances, context);
    }
    
    private boolean isSameSet(String set1, String set2) {
        // SETåŒ¹é…é€»è¾‘ï¼Œä¾‹å¦‚ï¼šååŒ—-zone-a-prod
        String[] parts1 = set1.split("-");
        String[] parts2 = set2.split("-");
        
        // å¯ä»¥æ ¹æ®é…ç½®çµæ´»åŒ¹é…
        // ä¾‹å¦‚ï¼šåªè¦æ±‚regionç›¸åŒï¼Œæˆ–è€…è¦æ±‚region+zoneç›¸åŒ
        return parts1[0].equals(parts2[0]) &&  // regionç›¸åŒ
               parts1[1].equals(parts2[1]) &&  // zoneç›¸åŒ
               parts1[2].equals(parts2[2]);    // envç›¸åŒ
    }
}
```

##### **2. åŠ¨æ€è·¯ç”±ç­–ç•¥çŸ©é˜µ**

| **è·¯ç”±ç­–ç•¥**         | **é€‚ç”¨åœºæ™¯**         | **å®ç°å¤æ‚åº¦** | **Consul** | **Polaris** | **è‡ªå®ç°** |
| -------------------- | -------------------- | -------------- | ---------- | ----------- | ---------- |
| **åŸºäºæƒé‡çš„è·¯ç”±**   | ç°åº¦å‘å¸ƒã€æµé‡è°ƒæ•´   | ä½             | âœ…          | âœ…           | âœ…          |
| **åŸºäºæ ‡ç­¾çš„è·¯ç”±**   | ç¯å¢ƒéš”ç¦»ã€ç‰ˆæœ¬æ§åˆ¶   | ä¸­             | âœ…          | âœ…           | âœ…          |
| **åŸºäºåœ°åŸŸçš„è·¯ç”±**   | å¼‚åœ°å¤šæ´»ã€å°±è¿‘è®¿é—®   | ä¸­             | âœ…          | âœ…           | âœ…          |
| **åŸºäºSETçš„è·¯ç”±**    | å•å…ƒåŒ–æ¶æ„ã€æ•…éšœéš”ç¦» | é«˜             | âŒ          | âœ…           | éœ€è¦å®šåˆ¶   |
| **åŸºäºæŸ“è‰²å™¨çš„è·¯ç”±** | å…¨é“¾è·¯å‹æµ‹ã€è°ƒè¯•     | é«˜             | âŒ          | âœ…           | éœ€è¦å®šåˆ¶   |
| **åŸºäºè´Ÿè½½çš„è·¯ç”±**   | èµ„æºå‡è¡¡ã€è¿‡è½½ä¿æŠ¤   | é«˜             | âŒ          | âœ…           | éœ€è¦å®šåˆ¶   |

##### **3. é«˜çº§è·¯ç”±ç­–ç•¥å®ç°**

###### **é‡‘ä¸é›€å‘å¸ƒè·¯ç”±**

```java
// é‡‘ä¸é›€å‘å¸ƒè·¯ç”±ç­–ç•¥
public class CanaryRoutingStrategy implements RoutingStrategy {
    // è·¯ç”±è§„åˆ™é…ç½®
    private CanaryRule rule;
    
    @Override
    public List<ServiceInstance> route(String serviceName,
                                       List<ServiceInstance> instances,
                                       RouteContext context) {
        // 1. åˆ†ç¦»ç¨³å®šç‰ˆå’Œé‡‘ä¸é›€ç‰ˆæœ¬
        List<ServiceInstance> stableInstances = new ArrayList<>();
        List<ServiceInstance> canaryInstances = new ArrayList<>();
        
        for (ServiceInstance instance : instances) {
            String version = instance.getMetadata().get("version");
            if ("canary".equals(version)) {
                canaryInstances.add(instance);
            } else {
                stableInstances.add(instance);
            }
        }
        
        // 2. æ ¹æ®è§„åˆ™åˆ†é…æµé‡
        double canaryRatio = rule.getTrafficRatio();
        String userId = context.getUserId();
        
        if (shouldRouteToCanary(userId, canaryRatio)) {
            // å‘½ä¸­é‡‘ä¸é›€è§„åˆ™
            if (!canaryInstances.isEmpty()) {
                return canaryInstances;
            }
        }
        
        // é»˜è®¤è¿”å›ç¨³å®šç‰ˆæœ¬
        return stableInstances;
    }
    
    private boolean shouldRouteToCanary(String userId, double ratio) {
        // å¤šç§æµé‡åˆ†é…ç­–ç•¥
        
        // ç­–ç•¥1ï¼šç”¨æˆ·IDå“ˆå¸Œ
        int hash = Math.abs(userId.hashCode() % 100);
        return hash < (ratio * 100);
        
        // ç­–ç•¥2ï¼šæŒ‰ç”¨æˆ·æ ‡ç­¾
        // ç­–ç•¥3ï¼šæŒ‰è¯·æ±‚Header
        // ç­–ç•¥4ï¼šæŒ‰æ—¶é—´çª—å£
    }
}
```

###### **å…¨é“¾è·¯å‹æµ‹è·¯ç”±**

```java
// æŸ“è‰²å™¨è·¯ç”±ï¼ˆå…¨é“¾è·¯å‹æµ‹ï¼‰
public class StressTestingRouter {
    // å‹æµ‹æ ‡è®°ä¼ é€’
    private static final String STRESS_TEST_HEADER = "X-Stress-Test";
    private static final String STRESS_TEST_TAG = "stress-test";
    
    public ServiceInstance route(RouteContext context) {
        // æ£€æŸ¥æ˜¯å¦å‹æµ‹è¯·æ±‚
        boolean isStressTest = context.getHeader(STRESS_TEST_HEADER) != null;
        
        List<ServiceInstance> instances = discovery.getAllInstances();
        
        if (isStressTest) {
            // å‹æµ‹æµé‡ï¼šåªè·¯ç”±åˆ°æ ‡è®°ä¸ºå‹æµ‹çš„å®ä¾‹
            return instances.stream()
                .filter(instance -> STRESS_TEST_TAG.equals(
                    instance.getMetadata().get("environment")))
                .findFirst()
                .orElseThrow(() -> new NoInstanceAvailableException());
        } else {
            // æ­£å¸¸æµé‡ï¼šæ’é™¤å‹æµ‹å®ä¾‹
            return instances.stream()
                .filter(instance -> !STRESS_TEST_TAG.equals(
                    instance.getMetadata().get("environment")))
                .findFirst()
                .orElseThrow(() -> new NoInstanceAvailableException());
        }
    }
}
```

###### **è‡ªé€‚åº”è´Ÿè½½è·¯ç”±**

```java
// åŸºäºè´Ÿè½½çš„æ™ºèƒ½è·¯ç”±
public class AdaptiveLoadRouter implements RoutingStrategy {
    private final LoadCollector loadCollector;
    private final CircuitBreaker circuitBreaker;
    
    @Override
    public List<ServiceInstance> route(String serviceName,
                                       List<ServiceInstance> instances,
                                       RouteContext context) {
        // 1. æ’é™¤ç†”æ–­çš„å®ä¾‹
        instances = filterOpenCircuitInstances(instances);
        
        // 2. è·å–å„å®ä¾‹è´Ÿè½½æŒ‡æ ‡
        Map<ServiceInstance, LoadMetrics> metrics = 
            loadCollector.getMetrics(instances);
        
        // 3. è´Ÿè½½å‡è¡¡ç®—æ³•
        return selectByLoad(instances, metrics);
    }
    
    private List<ServiceInstance> selectByLoad(
            List<ServiceInstance> instances,
            Map<ServiceInstance, LoadMetrics> metrics) {
        
        // å¤šç§è´Ÿè½½å‡è¡¡ç­–ç•¥
        switch (loadBalanceStrategy) {
            case LEAST_ACTIVE:
                return leastActiveSelection(instances, metrics);
                
            case WEIGHTED_RESPONSE_TIME:
                return weightedResponseTimeSelection(instances, metrics);
                
            case CPU_LOAD_BASED:
                return cpuLoadBasedSelection(instances, metrics);
                
            case HYBRID:
                return hybridSelection(instances, metrics);
                
            default:
                return randomSelection(instances);
        }
    }
    
    private List<ServiceInstance> leastActiveSelection(
            List<ServiceInstance> instances,
            Map<ServiceInstance, LoadMetrics> metrics) {
        
        return instances.stream()
            .sorted(Comparator.comparingInt(
                instance -> metrics.get(instance).getActiveRequests()))
            .limit(3) // è¿”å›è´Ÿè½½æœ€ä½çš„3ä¸ªå®ä¾‹
            .collect(Collectors.toList());
    }
}
```

------

#### äº”ã€å…·ä½“å®ç°ç¤ºä¾‹

##### **1. åŸºäºConsulçš„SETè·¯ç”±å®ç°**

```java
// Consul SETè·¯ç”±å®ç°
@Configuration
public class ConsulSetRoutingConfig {
    
    @Bean
    public ServiceInstanceListSupplier setAwareServiceInstanceListSupplier(
            ConsulDiscoveryClient discoveryClient) {
        
        return new SetAwareServiceInstanceListSupplier(discoveryClient);
    }
    
    static class SetAwareServiceInstanceListSupplier 
            implements ServiceInstanceListSupplier {
        
        private final ConsulDiscoveryClient client;
        private final String localSet;
        
        public SetAwareServiceInstanceListSupplier(ConsulDiscoveryClient client) {
            this.client = client;
            this.localSet = determineLocalSet();
        }
        
        @Override
        public Flux<List<ServiceInstance>> get() {
            return Flux.fromIterable(client.getServices())
                .flatMap(serviceName -> getInstances(serviceName))
                .cache(Duration.ofSeconds(30)); // ç¼“å­˜30ç§’
        }
        
        private Flux<List<ServiceInstance>> getInstances(String serviceName) {
            List<ServiceInstance> allInstances = client.getInstances(serviceName);
            
            // SETè·¯ç”±é€»è¾‘
            List<ServiceInstance> filtered = allInstances.stream()
                .filter(instance -> {
                    String instanceSet = instance.getMetadata().get("set");
                    return shouldRouteToSet(localSet, instanceSet);
                })
                .collect(Collectors.toList());
            
            // å¦‚æœåŒSETæ— å®ä¾‹ï¼Œè¿”å›æ‰€æœ‰å®ä¾‹
            if (filtered.isEmpty()) {
                filtered = allInstances;
            }
            
            return Flux.just(filtered);
        }
        
        private boolean shouldRouteToSet(String callerSet, String calleeSet) {
            // ç®€åŒ–çš„SETåŒ¹é…é€»è¾‘
            // å®é™…ä¸­å¯èƒ½æ›´å¤æ‚ï¼Œæ”¯æŒå¤šç§åŒ¹é…è§„åˆ™
            if (callerSet == null || calleeSet == null) {
                return true; // æ— SETä¿¡æ¯ï¼Œé»˜è®¤åŒ¹é…
            }
            
            // æŒ‰å±‚çº§åŒ¹é…ï¼šregion -> zone -> env
            String[] callerParts = callerSet.split("-");
            String[] calleeParts = calleeSet.split("-");
            
            for (int i = 0; i < Math.min(callerParts.length, calleeParts.length); i++) {
                if (!callerParts[i].equals(calleeParts[i])) {
                    return false;
                }
            }
            
            return true;
        }
    }
}
```

##### **2. åŸºäºPolarisçš„åŠ¨æ€è·¯ç”±**

```yaml
# Polarisè·¯ç”±è§„åˆ™é…ç½®
apiVersion: v1
kind: Routing
metadata:
  name: user-service-routing
spec:
  service: user-service
  namespace: Production
  rules:
    # è§„åˆ™1ï¼šæŒ‰ç‰ˆæœ¬è·¯ç”±ï¼ˆé‡‘ä¸é›€å‘å¸ƒï¼‰
    - name: canary-rule
      sources:
        - service: order-service
          namespace: Production
      destinations:
        - service: user-service
          namespace: Production
          subset:
            labels:
              version: v2.0
          weight: 10  # 10%æµé‡åˆ°v2.0
        - service: user-service
          namespace: Production
          subset:
            labels:
              version: v1.0
          weight: 90  # 90%æµé‡åˆ°v1.0
    
    # è§„åˆ™2ï¼šæŒ‰åœ°åŸŸè·¯ç”±
    - name: region-rule
      sources:
        - service: "*"
      destinations:
        - service: user-service
          namespace: Production
          subset:
            labels:
              region: ap-guangzhou
          weight: 100
      # å°±è¿‘è®¿é—®ç­–ç•¥
      policy:
        type: nearest
        fallback: any
    
    # è§„åˆ™3ï¼šæ•…éšœè½¬ç§»è§„åˆ™
    - name: failover-rule
      sources:
        - service: gateway
      destinations:
        - service: user-service
          namespace: Production
          subset:
            labels:
              zone: zone-a
          priority: 1  # ä¼˜å…ˆzone-a
        - service: user-service
          namespace: Production
          subset:
            labels:
              zone: zone-b
          priority: 2  # zone-aä¸å¯ç”¨æ—¶ä½¿ç”¨zone-b
```

##### **3. åŸºäºetcdçš„è‡ªå®šä¹‰è·¯ç”±å®ç°**

```go
// Goè¯­è¨€å®ç°åŸºäºetcdçš„SETè·¯ç”±
package router

import (
    "context"
    "strings"
    
    "go.etcd.io/etcd/client/v3"
)

type SetRouter struct {
    etcdClient *clientv3.Client
    localSet   string
}

func NewSetRouter(endpoints []string, localSet string) (*SetRouter, error) {
    cli, err := clientv3.New(clientv3.Config{
        Endpoints:   endpoints,
        DialTimeout: 5 * time.Second,
    })
    if err != nil {
        return nil, err
    }
    
    return &SetRouter{
        etcdClient: cli,
        localSet:   localSet,
    }, nil
}

func (r *SetRouter) GetInstances(serviceName string) ([]Instance, error) {
    // ä»etcdè·å–æ‰€æœ‰å®ä¾‹
    resp, err := r.etcdClient.Get(context.Background(),
        "/services/"+serviceName+"/",
        clientv3.WithPrefix())
    if err != nil {
        return nil, err
    }
    
    var instances []Instance
    for _, kv := range resp.Kvs {
        instance := parseInstance(kv.Value)
        
        // SETè·¯ç”±åŒ¹é…
        if r.matchSet(instance.Set) {
            instances = append(instances, instance)
        }
    }
    
    // å¦‚æœåŒSETæ— å®ä¾‹ï¼Œè¿”å›æ‰€æœ‰å®ä¾‹
    if len(instances) == 0 {
        for _, kv := range resp.Kvs {
            instance := parseInstance(kv.Value)
            instances = append(instances, instance)
        }
    }
    
    return instances, nil
}

func (r *SetRouter) matchSet(targetSet string) bool {
    if r.localSet == "" || targetSet == "" {
        return true
    }
    
    // SETåŒ¹é…è§„åˆ™ï¼šregion-zone-env
    localParts := strings.Split(r.localSet, "-")
    targetParts := strings.Split(targetSet, "-")
    
    // è¦æ±‚regionå’Œzoneç›¸åŒ
    if len(localParts) >= 2 && len(targetParts) >= 2 {
        return localParts[0] == targetParts[0] &&
               localParts[1] == targetParts[1]
    }
    
    return false
}

// ç›‘å¬å®ä¾‹å˜åŒ–
func (r *SetRouter) WatchInstances(serviceName string, ch chan<- []Instance) {
    watchChan := r.etcdClient.Watch(context.Background(),
        "/services/"+serviceName+"/",
        clientv3.WithPrefix())
    
    go func() {
        for resp := range watchChan {
            // é‡æ–°è·å–å®ä¾‹
            instances, _ := r.GetInstances(serviceName)
            ch <- instances
        }
    }()
}
```

#### å…­ã€ç›‘æ§ä¸è¿ç»´

##### **1. å…³é”®ç›‘æ§æŒ‡æ ‡**

```prometheus
# Prometheusç›‘æ§æŒ‡æ ‡
# 1. æ³¨å†Œä¸­å¿ƒå¥åº·çŠ¶æ€
registry_up{type="etcd",instance="etcd-1"} 1
registry_leader{type="etcd"} 1

# 2. æœåŠ¡å®ä¾‹æ•°
service_instances_total{service="user-service"} 5
service_instances_healthy{service="user-service"} 4

# 3. å¿ƒè·³å»¶è¿Ÿ
heartbeat_latency_seconds{instance="user-service-1"} 0.05
heartbeat_timeout_total{instance="user-service-1"} 0

# 4. è·¯ç”±å†³ç­–ç»Ÿè®¡
routing_decisions_total{strategy="set-based"} 15000
routing_fallback_total{reason="no-same-set-instance"} 12

# 5. ç¼“å­˜å‘½ä¸­ç‡
discovery_cache_hit_ratio{service="user-service"} 0.95
discovery_cache_size{service="user-service"} 50
```

##### **2. æ•…éšœå¤„ç†ç­–ç•¥**

```java
// æ³¨å†Œä¸­å¿ƒæ•…éšœå¤„ç†ç­–ç•¥
public class RegistryFailureHandler {
    // 1. æœ¬åœ°ç¼“å­˜é™çº§
    private Cache<String, List<ServiceInstance>> localCache;
    
    // 2. é™æ€é…ç½®æ–‡ä»¶å¤‡ä»½
    private Map<String, List<ServiceInstance>> staticConfig;
    
    // 3. æ³¨å†Œä¸­å¿ƒçŠ¶æ€æ£€æŸ¥
    public boolean isRegistryHealthy() {
        try {
            // æ£€æŸ¥è¿æ¥
            return registryClient.ping(3000);
        } catch (Exception e) {
            log.warn("Registry health check failed", e);
            return false;
        }
    }
    
    // 4. æ•…éšœè½¬ç§»ç­–ç•¥
    public List<ServiceInstance> getInstancesWithFallback(String serviceName) {
        // ä¼˜å…ˆä»æ³¨å†Œä¸­å¿ƒè·å–
        if (isRegistryHealthy()) {
            try {
                List<ServiceInstance> instances = registryClient.getInstances(serviceName);
                updateLocalCache(serviceName, instances);
                return instances;
            } catch (Exception e) {
                log.error("Failed to get instances from registry", e);
            }
        }
        
        // é™çº§åˆ°æœ¬åœ°ç¼“å­˜
        List<ServiceInstance> cached = localCache.getIfPresent(serviceName);
        if (cached != null && !cached.isEmpty()) {
            log.warn("Using cached instances for {}", serviceName);
            return cached;
        }
        
        // æœ€åä½¿ç”¨é™æ€é…ç½®
        List<ServiceInstance> staticInstances = staticConfig.get(serviceName);
        if (staticInstances != null && !staticInstances.isEmpty()) {
            log.error("Using static config for {}", serviceName);
            return staticInstances;
        }
        
        throw new NoInstanceAvailableException("No available instances for " + serviceName);
    }
}
```

------

#### ä¸ƒã€é€‰å‹å»ºè®®ä¸æœ€ä½³å®è·µ

##### **1. æŠ€æœ¯é€‰å‹å†³ç­–æ ‘**

![image-20260203165119817](å·¥ç¨‹ç´ å…»ç¯‡ï¼ˆä¸­çº§ï¼‰.assets/image-20260203165119817.png)

##### **2. æœ€ä½³å®è·µæ€»ç»“**

**éƒ¨ç½²æ¶æ„å»ºè®®**

```markdown
ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ³¨å†Œä¸­å¿ƒé›†ç¾¤                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  èŠ‚ç‚¹1  â”‚  èŠ‚ç‚¹2  â”‚  èŠ‚ç‚¹3  â”‚  èŠ‚ç‚¹4  â”‚  èŠ‚ç‚¹5  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Leader  â”‚ Followerâ”‚ Followerâ”‚ Followerâ”‚ Followerâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚         â”‚         â”‚         â”‚         â”‚
        â–¼         â–¼         â–¼         â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                æœåŠ¡å®ä¾‹ï¼ˆæ¯ä¸ªSETï¼‰                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    SET-A        â”‚     SET-B       â”‚     SET-C       â”‚
â”‚   (åŒ—äº¬æœºæˆ¿)     â”‚   (ä¸Šæµ·æœºæˆ¿)    â”‚   (å¹¿å·æœºæˆ¿)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç½‘å…³å±‚         â”‚  ç½‘å…³å±‚         â”‚  ç½‘å…³å±‚         â”‚
â”‚  ä¸šåŠ¡æœåŠ¡       â”‚  ä¸šåŠ¡æœåŠ¡       â”‚  ä¸šåŠ¡æœåŠ¡       â”‚
â”‚  æ•°æ®åº“         â”‚  æ•°æ®åº“         â”‚  æ•°æ®åº“         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é…ç½®å»ºè®®**

```yaml
# æ³¨å†Œä¸­å¿ƒé…ç½®æœ€ä½³å®è·µ
registry:
  # 1. å®¢æˆ·ç«¯é…ç½®
  client:
    refresh-interval: 30s          # åˆ·æ–°é—´éš”
    cache-ttl: 60s                 # ç¼“å­˜TTL
    fail-fast: true                # å¿«é€Ÿå¤±è´¥
    
  # 2. æœåŠ¡ç«¯é…ç½®
  server:
    election-timeout: 1000ms       # é€‰ä¸¾è¶…æ—¶
    heartbeat-interval: 500ms      # å¿ƒè·³é—´éš”
    snapshot-count: 10000          # å¿«ç…§é˜ˆå€¼
    
  # 3. å¥åº·æ£€æŸ¥é…ç½®
  health-check:
    interval: 10s                  # æ£€æŸ¥é—´éš”
    timeout: 5s                    # æ£€æŸ¥è¶…æ—¶
    deregister-critical: 30s       # å¼‚å¸¸æ³¨é”€æ—¶é—´
    
  # 4. SETé…ç½®
  set:
    enabled: true
    dimensions:
      - region
      - zone
      - env
    routing-strategy: same-set-first # åŒSETä¼˜å…ˆ
    fallback-strategy: same-region   # é™çº§ç­–ç•¥
```

**æ€§èƒ½è°ƒä¼˜å»ºè®®**

```java
// å®¢æˆ·ç«¯æ€§èƒ½ä¼˜åŒ–
public class RegistryClientOptimizer {
    
    // 1. è¿æ¥æ± ä¼˜åŒ–
    @Bean
    public RegistryClient registryClient() {
        return RegistryClient.builder()
            .connectionPoolSize(20)          // è¿æ¥æ± å¤§å°
            .connectTimeout(3000)           // è¿æ¥è¶…æ—¶
            .readTimeout(5000)              // è¯»å–è¶…æ—¶
            .retryTimes(3)                  // é‡è¯•æ¬¡æ•°
            .retryInterval(1000)            // é‡è¯•é—´éš”
            .build();
    }
    
    // 2. æœ¬åœ°ç¼“å­˜ä¼˜åŒ–
    @Bean
    public CacheManager cacheManager() {
        CaffeineCacheManager cacheManager = new CaffeineCacheManager();
        cacheManager.setCaffeine(Caffeine.newBuilder()
            .maximumSize(1000)               // æœ€å¤§ç¼“å­˜æ¡ç›®
            .expireAfterWrite(30, TimeUnit.SECONDS)  // å†™å…¥åè¿‡æœŸ
            .refreshAfterWrite(10, TimeUnit.SECONDS) // åˆ·æ–°é—´éš”
            .recordStats());                 // è®°å½•ç»Ÿè®¡ä¿¡æ¯
        return cacheManager;
    }
    
    // 3. æ‰¹é‡æ“ä½œä¼˜åŒ–
    public void batchRegister(List<ServiceInstance> instances) {
        // æ‰¹é‡æ³¨å†Œï¼Œå‡å°‘ç½‘ç»œå¼€é”€
        registryClient.batchRegister(instances);
    }
}
```

------

#### å…«ã€æœªæ¥è¶‹åŠ¿

##### **1. æœåŠ¡ç½‘æ ¼é›†æˆ**

```yaml
# Istio + æ³¨å†Œä¸­å¿ƒé›†æˆ
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: external-svc
spec:
  hosts:
  - user-service.example.com
  location: MESH_EXTERNAL
  ports:
  - number: 80
    name: http
    protocol: HTTP
  resolution: STATIC
  endpoints:
  - address: 192.168.1.1
    ports:
      http: 8080
    labels:
      version: v1
      set: ap-beijing-zone-a
```

##### **2. KubernetesåŸç”ŸæœåŠ¡å‘ç°**

```yaml
# K8s Service + Headless Service
apiVersion: v1
kind: Service
metadata:
  name: user-service
  annotations:
    # è‡ªå®šä¹‰è·¯ç”±æ ‡ç­¾
    routing.alpha.kubernetes.io/set: "ap-beijing-zone-a"
spec:
  selector:
    app: user-service
  ports:
  - port: 80
    targetPort: 8080
  clusterIP: None  # Headless Service
---
apiVersion: v1
kind: Endpoints
metadata:
  name: user-service
subsets:
  - addresses:
      - ip: 10.244.1.2
        nodeName: node-1
        targetRef:
          kind: Pod
          name: user-service-pod-1
    ports:
      - port: 8080
```

##### **3. å¤šé›†ç¾¤æœåŠ¡å‘ç°**

```yaml
# å¤šé›†ç¾¤æœåŠ¡ç½‘æ ¼
apiVersion: multicluster.x-k8s.io/v1alpha1
kind: ServiceImport
metadata:
  name: user-service
spec:
  type: ClusterSetIP
  ports:
  - port: 80
    protocol: TCP
---
apiVersion: multicluster.x-k8s.io/v1alpha1
kind: ServiceExport
metadata:
  name: user-service
spec:
  matchLabels:
    app: user-service
```

#### æ€»ç»“

é€‰æ‹©æœåŠ¡æ³¨å†Œä¸å‘ç°æ–¹æ¡ˆæ—¶ï¼Œéœ€è¦è€ƒè™‘ï¼š

1. **ä¸šåŠ¡è§„æ¨¡**ï¼šå°è§„æ¨¡ç”¨Nacos/Consulï¼Œå¤§è§„æ¨¡è€ƒè™‘etcd/Polaris
2. **æŠ€æœ¯æ ˆ**ï¼šK8sç”Ÿæ€ç”¨etcdï¼ŒJavaç”Ÿæ€ç”¨Nacosï¼Œéœ€è¦å¤šæ•°æ®ä¸­å¿ƒç”¨Consul
3. **åŠŸèƒ½éœ€æ±‚**ï¼šç®€å•æœåŠ¡å‘ç°ç”¨etcdï¼Œéœ€è¦æ²»ç†åŠŸèƒ½ç”¨Polaris/Nacos
4. **è¿ç»´èƒ½åŠ›**ï¼šetcd/ZKè¿ç»´å¤æ‚ï¼ŒConsul/Nacosç›¸å¯¹ç®€å•

**SETç­‰åŠ¨æ€è·¯ç”±åŠŸèƒ½**æ˜¯å¤§è§„æ¨¡å¾®æœåŠ¡çš„å¿…å¤‡èƒ½åŠ›ï¼Œèƒ½æœ‰æ•ˆå®ç°ï¼š

- æ•…éšœéš”ç¦»ä¸å®¹ç¾
- ç°åº¦å‘å¸ƒä¸æµé‡ç®¡ç†
- å°±è¿‘è®¿é—®ä¸å»¶è¿Ÿä¼˜åŒ–
- èµ„æºéš”ç¦»ä¸æˆæœ¬æ§åˆ¶



## **é…ç½®ä¸­å¿ƒ**

> etcd/zk/apolloï¼Œæ•°æ®é«˜å¯ç”¨æ–¹æ¡ˆï¼Œé€‰ä¸»å’Œè§£å†³è„‘è£‚é—®é¢˜

#### ä¸€ã€é…ç½®ä¸­å¿ƒæ ¸å¿ƒå¯¹æ¯”

**1. ä¸‰å¤§é…ç½®ä¸­å¿ƒå¯¹æ¯”åˆ†æ**

| **ç»´åº¦**       | **etcd**          | **ZooKeeper**  | **Apollo**      |
| -------------- | ----------------- | -------------- | --------------- |
| **å®šä½**       | åˆ†å¸ƒå¼KVå­˜å‚¨      | åˆ†å¸ƒå¼åè°ƒæœåŠ¡ | é…ç½®ç®¡ç†ä¸­å¿ƒ    |
| **æ•°æ®æ¨¡å‹**   | Key-Value         | ZNodeæ ‘å½¢ç»“æ„  | å‘½åç©ºé—´é…ç½®    |
| **ä¸€è‡´æ€§**     | Raftå¼ºä¸€è‡´        | ZABå¼ºä¸€è‡´      | æœ€ç»ˆä¸€è‡´(ä¸»ä»)  |
| **HAæ¶æ„**     | å¤šå‰¯æœ¬Raft        | å¤šå‰¯æœ¬ZAB      | ä¸»ä»å¤åˆ¶+å“¨å…µ   |
| **å®¢æˆ·ç«¯**     | ç®€å•HTTP/gRPC     | ZKå®¢æˆ·ç«¯åº“     | HTTPé•¿è½®è¯¢      |
| **ç›‘æ§**       | metricsæ¥å£       | JMX/ZK Metrics | ä¸°å¯Œç®¡ç†ç•Œé¢    |
| **é…ç½®æ¨é€**   | Watchæœºåˆ¶         | Watchæœºåˆ¶      | HTTPé•¿è½®è¯¢+æ¨é€ |
| **æ•°æ®æŒä¹…åŒ–** | WAL+RocksDB       | äº‹åŠ¡æ—¥å¿—+å¿«ç…§  | **MySQL/æ–‡ä»¶**  |
| **é€‚ç”¨åœºæ™¯**   | K8sé…ç½®ã€æœåŠ¡å‘ç° | åˆ†å¸ƒå¼é”ã€é€‰ä¸¾ | åº”ç”¨é…ç½®ç®¡ç†    |

#### äºŒã€é«˜å¯ç”¨æ¶æ„å®ç°

##### **1. etcdé«˜å¯ç”¨æ¶æ„**

```yaml
# etcdé›†ç¾¤é…ç½®ç¤ºä¾‹
# etcd-1.yaml
name: etcd-1
data-dir: /var/lib/etcd
listen-peer-urls: https://192.168.1.1:2380
listen-client-urls: https://192.168.1.1:2379
initial-advertise-peer-urls: https://192.168.1.1:2380
advertise-client-urls: https://192.168.1.1:2379
initial-cluster: etcd-1=https://192.168.1.1:2380,etcd-2=https://192.168.1.2:2380,etcd-3=https://192.168.1.3:2380
initial-cluster-state: new
initial-cluster-token: etcd-cluster-1

# å®¢æˆ·ç«¯è®¿é—®é…ç½®
endpoints:
  - https://192.168.1.1:2379
  - https://192.168.1.2:2379  
  - https://192.168.1.3:2379
etcd HAæ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Client                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ LB/Round Robin
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â–¼           â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ etcd-1  â”‚ â”‚ etcd-2  â”‚ â”‚ etcd-3  â”‚
â”‚ Leader  â”‚ â”‚Follower â”‚ â”‚Follower â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚           â”‚           â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          Raftå…±è¯†åè®®
          
é«˜å¯ç”¨ç‰¹æ€§ï¼š
1. ä»»æ„èŠ‚ç‚¹æ•…éšœä¸å½±å“æœåŠ¡
2. Leaderé€‰ä¸¾è‡ªåŠ¨åˆ‡æ¢
3. æ•°æ®å¤šå‰¯æœ¬å­˜å‚¨
4. çº¿æ€§åŒ–è¯»å†™ä¿è¯
```

##### **2. ZooKeeperé«˜å¯ç”¨æ¶æ„**

```java
// ZKå®¢æˆ·ç«¯è¿æ¥é…ç½®
public class ZKConfig {
    // è¿æ¥å¤šä¸ªæœåŠ¡å™¨ï¼Œé€—å·åˆ†éš”
    private String connectString = "zk1:2181,zk2:2181,zk3:2181";
    
    // ä¼šè¯è¶…æ—¶
    private int sessionTimeout = 30000;
    
    // è¿æ¥é‡è¯•ç­–ç•¥
    private RetryPolicy retryPolicy = new ExponentialBackoffRetry(
        1000,  // åˆå§‹é—´éš”
        3,     // æœ€å¤§é‡è¯•æ¬¡æ•°
        30000  // æœ€å¤§é‡è¯•æ—¶é—´
    );
    
    // åˆ›å»ºå®¢æˆ·ç«¯
    public CuratorFramework createClient() {
        return CuratorFrameworkFactory.builder()
            .connectString(connectString)
            .sessionTimeoutMs(sessionTimeout)
            .retryPolicy(retryPolicy)
            .namespace("config")  // å‘½åç©ºé—´éš”ç¦»
            .build();
    }
}
ZKé›†ç¾¤æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Client                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ è¿æ¥åˆ°ä»»æ„Follower
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â–¼           â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ZK-1   â”‚ â”‚  ZK-2   â”‚ â”‚  ZK-3   â”‚
â”‚ Leader  â”‚ â”‚Follower â”‚ â”‚Follower â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚           â”‚           â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          ZABåŸå­å¹¿æ’­åè®®
          
è§’è‰²åˆ†å·¥ï¼š
â€¢ Leaderï¼šå¤„ç†æ‰€æœ‰å†™è¯·æ±‚ï¼Œå‘èµ·ææ¡ˆ
â€¢ Followerï¼šå¤„ç†è¯»è¯·æ±‚ï¼Œå‚ä¸æŠ•ç¥¨
â€¢ Observerï¼šåªå¤„ç†è¯»è¯·æ±‚ï¼Œä¸å‚ä¸æŠ•ç¥¨ï¼ˆæ‰©å±•è¯»èƒ½åŠ›ï¼‰
```

##### **3. Apolloé«˜å¯ç”¨æ¶æ„**

```yaml
# Apolloé›†ç¾¤éƒ¨ç½²æ¶æ„
components:
  config-service:
    replicas: 3
    strategy:
      type: active-active  # å¤šæ´»éƒ¨ç½²
      
  admin-service:
    replicas: 2
    strategy:
      type: active-standby  # ä¸»å¤‡éƒ¨ç½²
      
  portal:
    replicas: 2
    load-balancer: nginx
    
  meta-server:
    endpoints:
      - http://config-service-1:8080
      - http://config-service-2:8080
      - http://config-service-3:8080
      
  database:
    master: mysql-master:3306
    slaves:
      - mysql-slave-1:3306
      - mysql-slave-2:3306
    read-write-split: true
Apollo HAæ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Apollo Portal                       â”‚
â”‚                    (é…ç½®ç®¡ç†ç•Œé¢)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ HTTP
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                    â”‚                    â”‚
      â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ConfigServiceâ”‚    â”‚ ConfigServiceâ”‚    â”‚ ConfigServiceâ”‚
â”‚   (å®ä¾‹1)    â”‚    â”‚   (å®ä¾‹2)    â”‚    â”‚   (å®ä¾‹3)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                  â”‚                  â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ è¯»å†™åˆ†ç¦»
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ MySQL    â”‚    â”‚ MySQL    â”‚    â”‚ MySQL    â”‚
    â”‚ Master   â”‚â”€â”€â”€â–¶â”‚ Slave1   â”‚â”€â”€â”€â–¶â”‚ Slave2   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â–²              ä¸»ä»å¤åˆ¶
          
ç‰¹ç‚¹ï¼š
1. ConfigServiceæ— çŠ¶æ€ï¼Œå¯æ°´å¹³æ‰©å±•
2. AdminServiceæœ‰çŠ¶æ€ï¼Œéœ€è¦é€‰ä¸»
3. æ•°æ®åº“ä¸»ä»å¤åˆ¶ä¿è¯æ•°æ®æŒä¹…åŒ–
4. EurekaæœåŠ¡å‘ç°å®ç°è´Ÿè½½å‡è¡¡
```



#### ä¸‰ã€é€‰ä¸»æœºåˆ¶æ·±åº¦è§£æ

> æŠ•ç¥¨

##### **1. Rafté€‰ä¸»ç®—æ³•ï¼ˆetcdï¼‰**

###### **Raftæ ¸å¿ƒæ¦‚å¿µ**

```go
// RaftèŠ‚ç‚¹çŠ¶æ€æœº
type RaftState int

const (
    Follower RaftState = iota  // è·Ÿéšè€…
    Candidate                  // å€™é€‰äºº
    Leader                     // é¢†å¯¼è€…
)

// RaftèŠ‚ç‚¹ç»“æ„
type RaftNode struct {
    id          int
    currentTerm int           // å½“å‰ä»»æœŸ
    votedFor    int           // æŠ•ç¥¨ç»™è°
    state       RaftState
    log         []LogEntry    // æ“ä½œæ—¥å¿—
    commitIndex int           // å·²æäº¤ç´¢å¼•
    lastApplied int           // æœ€ååº”ç”¨ç´¢å¼•
    
    // é€‰ä¸¾ç›¸å…³
    electionTimeout    time.Duration
    lastHeartbeatTime  time.Time
    votesReceived      map[int]bool
}
```

###### **é€‰ä¸¾æµç¨‹**

```go
// Rafté€‰ä¸¾ç®—æ³•å®ç°
func (n *RaftNode) startElection() {
    // 1. è½¬æ¢ä¸ºCandidateçŠ¶æ€
    n.state = Candidate
    n.currentTerm++
    n.votedFor = n.id
    n.votesReceived = make(map[int]bool)
    n.votesReceived[n.id] = true
    
    // 2. é‡ç½®é€‰ä¸¾è¶…æ—¶
    n.resetElectionTimeout()
    
    // 3. å‘å…¶ä»–èŠ‚ç‚¹å‘é€æŠ•ç¥¨è¯·æ±‚
    request := RequestVoteArgs{
        Term:         n.currentTerm,
        CandidateId:  n.id,
        LastLogIndex: len(n.log) - 1,
        LastLogTerm:  n.log[len(n.log)-1].Term,
    }
    
    // å¹¶å‘å‘é€è¯·æ±‚
    for _, peer := range n.peers {
        if peer.id != n.id {
            go n.sendRequestVote(peer, request)
        }
    }
}

// å¤„ç†æŠ•ç¥¨å“åº”
func (n *RaftNode) handleRequestVoteResponse(resp RequestVoteReply) {
    if resp.Term > n.currentTerm {
        n.stepDown(resp.Term)
        return
    }
    
    if resp.VoteGranted {
        n.votesReceived[resp.VoterId] = true
        
        // ç»Ÿè®¡ç¥¨æ•°
        votes := len(n.votesReceived)
        totalPeers := len(n.peers)
        
        // è·å¾—å¤šæ•°ç¥¨ï¼ˆN/2 + 1ï¼‰
        if votes > totalPeers/2 {
            n.becomeLeader()
        }
    }
}

// æˆä¸ºLeader
func (n *RaftNode) becomeLeader() {
    n.state = Leader
    
    // åˆå§‹åŒ–NextIndexå’ŒMatchIndex
    for _, peer := range n.peers {
        n.nextIndex[peer.id] = len(n.log)
        n.matchIndex[peer.id] = 0
    }
    
    // ç«‹å³å‘é€å¿ƒè·³ï¼Œé˜»æ­¢å…¶ä»–èŠ‚ç‚¹å‘èµ·é€‰ä¸¾
    n.sendHeartbeats()
    
    // å¯åŠ¨æ—¥å¿—å¤åˆ¶
    go n.logReplicationLoop()
}
```

###### **é€‰ä¸¾è¶…æ—¶æœºåˆ¶**

```go
// é€‰ä¸¾è¶…æ—¶å¤„ç†
func (n *RaftNode) electionTimeoutHandler() {
    for {
        select {
        case <-n.electionTimer.C:
            n.mu.Lock()
            
            // æ£€æŸ¥æ˜¯å¦æ”¶åˆ°Leaderå¿ƒè·³
            if time.Since(n.lastHeartbeatTime) > n.electionTimeout {
                // è¶…æ—¶æœªæ”¶åˆ°å¿ƒè·³ï¼Œå‘èµ·é€‰ä¸¾
                if n.state == Follower {
                    n.startElection()
                }
            }
            
            n.mu.Unlock()
            
        case <-n.stopCh:
            return
        }
    }
}

// é‡ç½®é€‰ä¸¾è¶…æ—¶ï¼ˆéšæœºåŒ–é¿å…åŒæ—¶é€‰ä¸¾ï¼‰
func (n *RaftNode) resetElectionTimeout() {
    // éšæœºè¶…æ—¶æ—¶é—´ï¼š150ms - 300ms
    minTimeout := 150 * time.Millisecond
    maxTimeout := 300 * time.Millisecond
    
    randomTimeout := minTimeout + 
        time.Duration(rand.Int63n(int64(maxTimeout-minTimeout)))
    
    n.electionTimeout = randomTimeout
    n.electionTimer.Reset(n.electionTimeout)
}
```



##### **2. ZABé€‰ä¸»ç®—æ³•ï¼ˆZooKeeperï¼‰**

**ZABé€‰ä¸¾é˜¶æ®µ**

```markdown
ZABé€‰ä¸¾ä¸‰é˜¶æ®µï¼š
1. Discoveryï¼ˆå‘ç°é˜¶æ®µï¼‰ï¼š
   - èŠ‚ç‚¹ç›¸äº’é€šä¿¡ï¼Œå‘ç°å½¼æ­¤
   - äº¤æ¢epochå’Œzxidä¿¡æ¯
   
2. Synchronizationï¼ˆåŒæ­¥é˜¶æ®µï¼‰ï¼š
   - é€‰ä¸¾å‡ºçš„Leaderä¸FolloweråŒæ­¥æ•°æ®
   - ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹æ•°æ®ä¸€è‡´
   
3. Broadcastï¼ˆå¹¿æ’­é˜¶æ®µï¼‰ï¼š
   - Leaderå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚
   - é€šè¿‡åŸå­å¹¿æ’­åè®®å¤åˆ¶åˆ°Follower
```

**Fast Leader Electionç®—æ³•**

```java
// ç®€åŒ–çš„é€‰ä¸¾é€»è¾‘
public class FastLeaderElection {
    
    // é€‰ä¸¾æŠ•ç¥¨
    private Vote lookForLeader() {
        // 1. åˆå§‹åŒ–æŠ•ç¥¨
        Vote currentVote = new Vote(myid, getLastLoggedZxid());
        
        // 2. å‘é€æŠ•ç¥¨ç»™æ‰€æœ‰èŠ‚ç‚¹
        for (QuorumPeer peer : allPeers) {
            sendNotification(peer, currentVote);
        }
        
        // 3. æ”¶é›†æŠ•ç¥¨
        Map<Long, Vote> votes = new HashMap<>();
        
        while (true) {
            Notification n = receiveNotification();
            
            // 4. æ¯”è¾ƒé€»è¾‘
            if (n.zxid > currentVote.zxid || 
                (n.zxid == currentVote.zxid && n.sid > currentVote.sid)) {
                
                // æ›´æ–°æŠ•ç¥¨
                currentVote = new Vote(n.sid, n.zxid);
                sendNotificationToAll(currentVote);
            }
            
            // è®°å½•æ”¶åˆ°çš„æŠ•ç¥¨
            votes.put(n.sid, new Vote(n.sid, n.zxid));
            
            // 5. ç»Ÿè®¡æ˜¯å¦è·å¾—å¤šæ•°ç¥¨
            if (hasQuorum(votes, currentVote)) {
                return currentVote;
            }
        }
    }
    
    // åˆ¤æ–­æ˜¯å¦è·å¾—å¤šæ•°ç¥¨
    private boolean hasQuorum(Map<Long, Vote> votes, Vote candidate) {
        int count = 0;
        for (Vote vote : votes.values()) {
            if (vote.equals(candidate)) {
                count++;
            }
        }
        
        // å¤šæ•°ç¥¨ï¼šN/2 + 1
        return count > (allPeers.size() / 2);
    }
}
```

**ZXIDï¼ˆZooKeeperäº‹åŠ¡IDï¼‰**

```java
// ZXIDç»“æ„ï¼šepoch + counter
public class ZXID {
    private long epoch;    // é€‰ä¸¾å‘¨æœŸ
    private long counter;  // äº‹åŠ¡è®¡æ•°å™¨
    
    public ZXID(long zxid) {
        this.epoch = zxid >> 32;      // é«˜32ä½
        this.counter = zxid & 0xffffffffL;  // ä½32ä½
    }
    
    // æ¯”è¾ƒè§„åˆ™ï¼šepochå¤§çš„èƒœå‡ºï¼Œepochç›¸åŒæ—¶counterå¤§çš„èƒœå‡º
    public int compareTo(ZXID other) {
        if (this.epoch != other.epoch) {
            return Long.compare(this.epoch, other.epoch);
        }
        return Long.compare(this.counter, other.counter);
    }
}
```

##### **3. Apolloé€‰ä¸»æœºåˆ¶**

**åŸºäºæ•°æ®åº“çš„é€‰ä¸»**

```sql
-- Apolloé€‰ä¸»è¡¨ç»“æ„
CREATE TABLE apollo_lock (
  id INT PRIMARY KEY AUTO_INCREMENT,
  lock_key VARCHAR(64) NOT NULL UNIQUE,  -- é”é”®
  lock_value VARCHAR(128) NOT NULL,      -- é”å€¼ï¼ˆæŒæœ‰è€…ï¼‰
  expires_at DATETIME NOT NULL,          -- è¿‡æœŸæ—¶é—´
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_expires_at (expires_at)
);

-- è·å–é”çš„SQLï¼ˆCASæ“ä½œï¼‰
UPDATE apollo_lock 
SET lock_value = 'instance-1', 
    expires_at = DATE_ADD(NOW(), INTERVAL 30 SECOND)
WHERE lock_key = 'AdminServiceMaster' 
  AND (lock_value = 'instance-1' OR expires_at < NOW());
```

**AdminServiceé€‰ä¸»å®ç°**

```java
// Apollo AdminServiceé€‰ä¸»å®ç°
@Component
public class AdminServiceMasterElector {
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    private volatile boolean isMaster = false;
    private ScheduledExecutorService scheduler;
    
    @PostConstruct
    public void init() {
        scheduler = Executors.newSingleThreadScheduledExecutor();
        // å¯åŠ¨é€‰ä¸»å¾ªç¯
        scheduler.scheduleAtFixedRate(this::tryAcquireMaster, 
            0, 5, TimeUnit.SECONDS);  // æ¯5ç§’å°è¯•ä¸€æ¬¡
    }
    
    private void tryAcquireMaster() {
        try {
            String instanceId = getInstanceId();
            
            // CASè·å–é”
            int updated = jdbcTemplate.update(
                "UPDATE apollo_lock SET lock_value = ?, " +
                "expires_at = DATE_ADD(NOW(), INTERVAL 30 SECOND) " +
                "WHERE lock_key = 'AdminServiceMaster' " +
                "AND (lock_value = ? OR expires_at < NOW())",
                instanceId, instanceId
            );
            
            if (updated > 0) {
                // è·å–é”æˆåŠŸ
                if (!isMaster) {
                    isMaster = true;
                    onBecomeMaster();
                }
                // ç»­æœŸé”
                renewMasterLock();
            } else {
                // è·å–é”å¤±è´¥
                if (isMaster) {
                    isMaster = false;
                    onStepDown();
                }
            }
        } catch (Exception e) {
            log.error("Master election failed", e);
        }
    }
    
    private void renewMasterLock() {
        jdbcTemplate.update(
            "UPDATE apollo_lock SET expires_at = DATE_ADD(NOW(), INTERVAL 30 SECOND) " +
            "WHERE lock_key = 'AdminServiceMaster' AND lock_value = ?",
            getInstanceId()
        );
    }
    
    private void onBecomeMaster() {
        log.info("Become AdminService master");
        // å¯åŠ¨åªæœ‰Masterèƒ½æ‰§è¡Œçš„ä»»åŠ¡
        startMasterOnlyTasks();
    }
    
    private void onStepDown() {
        log.info("Step down from AdminService master");
        // åœæ­¢Masterä»»åŠ¡
        stopMasterOnlyTasks();
    }
}
```

**å“¨å…µæ¨¡å¼é€‰ä¸»**

```java
// å“¨å…µæ¨¡å¼å®ç°
public class SentinelMasterElector {
    
    private List<String> sentinels;
    private String currentMaster;
    private int quorum;  // ä»²è£æ•°
    
    public SentinelMasterElector(List<String> sentinels, int quorum) {
        this.sentinels = sentinels;
        this.quorum = quorum;
    }
    
    public String electMaster() {
        Map<String, Integer> votes = new HashMap<>();
        
        // è¯¢é—®æ‰€æœ‰å“¨å…µ
        for (String sentinel : sentinels) {
            String master = askSentinel(sentinel);
            votes.put(master, votes.getOrDefault(master, 0) + 1);
        }
        
        // æ‰¾å‡ºè·å¾—å¤šæ•°ç¥¨çš„Master
        for (Map.Entry<String, Integer> entry : votes.entrySet()) {
            if (entry.getValue() >= quorum) {
                return entry.getKey();
            }
        }
        
        // æ²¡æœ‰Masterè·å¾—å¤šæ•°ç¥¨ï¼Œè¿›å…¥æ•…éšœè½¬ç§»
        return failover();
    }
    
    private String failover() {
        // 1. ç›‘æ§èŠ‚ç‚¹çŠ¶æ€
        // 2. é€‰æ‹©æœ€ä¼˜Slaveæ™‹å‡ä¸ºMaster
        // 3. é€šçŸ¥å…¶ä»–å“¨å…µå’Œå®¢æˆ·ç«¯
        // 4. é‡æ–°é…ç½®Slave
        return selectNewMaster();
    }
}
```

------

#### å››ã€è„‘è£‚é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

##### **1. è„‘è£‚é—®é¢˜å®šä¹‰ä¸å±å®³**

**ä»€ä¹ˆæ˜¯è„‘è£‚ï¼Ÿ**

```markdown
æ­£å¸¸æƒ…å†µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  ç½‘ç»œ   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ èŠ‚ç‚¹A   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ èŠ‚ç‚¹B   â”‚
â”‚ Leader  â”‚         â”‚Follower â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å‘ç”Ÿç½‘ç»œåˆ†åŒºï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  ç½‘ç»œæ–­å¼€  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ èŠ‚ç‚¹A   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ èŠ‚ç‚¹B   â”‚
â”‚ Leader  â”‚           â”‚Follower â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                      â”‚
     â–¼                      â–¼
ç»§ç»­æœåŠ¡               è®¤ä¸ºLeaderæŒ‚äº†
å®¢æˆ·ç«¯1                   é€‰ä¸¾æ–°Leader
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ èŠ‚ç‚¹B   â”‚
                      â”‚ Leader  â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                       å®¢æˆ·ç«¯2

å±å®³ï¼š
1. æ•°æ®ä¸ä¸€è‡´ï¼šä¸¤è¾¹éƒ½æ¥å—å†™è¯·æ±‚
2. æœåŠ¡æ··ä¹±ï¼šå®¢æˆ·ç«¯è¿æ¥åˆ°ä¸åŒLeader
3. æ•°æ®ä¸¢å¤±ï¼šç½‘ç»œæ¢å¤åæ•°æ®å†²çª
```

##### **2. è„‘è£‚é¢„é˜²æœºåˆ¶**

###### **Raftçš„è„‘è£‚é¢„é˜²**

> ä»»æœŸæ£€æŸ¥

```go
// Raftçš„è„‘è£‚é¢„é˜²æœºåˆ¶
func (n *RaftNode) handleAppendEntries(args AppendEntriesArgs) {
    n.mu.Lock()
    defer n.mu.Unlock()
    
    // 1. ä»»æœŸæ£€æŸ¥
    if args.Term < n.currentTerm {
        // æ¥è‡ªæ—§Leaderçš„è¯·æ±‚ï¼Œæ‹’ç»
        return AppendEntriesReply{Term: n.currentTerm, Success: false}
    }
    
    // 2. æ›´æ–°ä»»æœŸ
    if args.Term > n.currentTerm {
        n.currentTerm = args.Term
        n.state = Follower
        n.votedFor = -1
    }
    
    // 3. é‡ç½®é€‰ä¸¾è¶…æ—¶
    n.resetElectionTimeout()
    n.lastHeartbeatTime = time.Now()
    
    // å¤„ç†æ—¥å¿—è¿½åŠ ...
}
```

###### **å¤šæ•°æ´¾åŸåˆ™ï¼ˆQuorumï¼‰**

```markdown
å¤šæ•°æ´¾åŸåˆ™å…¬å¼ï¼š
Quorum = âŒŠN/2âŒ‹ + 1

é›†ç¾¤è§„æ¨¡ä¸å®¹é”™èƒ½åŠ›ï¼š
é›†ç¾¤èŠ‚ç‚¹æ•°  å¤šæ•°æ´¾æ•°  å®¹é”™æ•°ï¼ˆå¯å®•æœºèŠ‚ç‚¹ï¼‰
     3         2          1
     5         3          2  
     7         4          3
     N        âŒŠN/2âŒ‹+1    âŒŠ(N-1)/2âŒ‹
     
å…³é”®ï¼šå†™æ“ä½œå¿…é¡»è·å¾—å¤šæ•°æ´¾ç¡®è®¤æ‰èƒ½æˆåŠŸ
```

##### **3. è„‘è£‚æ£€æµ‹ä¸æ¢å¤**

**etcdçš„è„‘è£‚æ£€æµ‹**

```yaml
# etcdé˜²è„‘è£‚é…ç½®
# etcdé…ç½®ä¸­çš„å…³é”®å‚æ•°
initial-cluster-state: existing  # é›†ç¾¤çŠ¶æ€å¿…é¡»ä¸€è‡´
strict-reconfig-check: true      # ä¸¥æ ¼é‡æ–°é…ç½®æ£€æŸ¥
enable-lease: true               # å¯ç”¨ç§Ÿçº¦æœºåˆ¶
lease-checkpoint-interval: "5m"  # ç§Ÿçº¦æ£€æŸ¥é—´éš”

# ç›‘æ§è„‘è£‚æŒ‡æ ‡
etcd_server_leader_changes_seen_total  # Leaderå˜æ›´æ¬¡æ•°
etcd_server_proposals_failed_total     # ææ¡ˆå¤±è´¥æ¬¡æ•°
etcd_server_is_leader                  # å½“å‰æ˜¯å¦ä¸ºLeader
```

**ZKçš„è„‘è£‚å¤„ç†**

```java
// ZKè„‘è£‚æ£€æµ‹ä¸å¤„ç†
public class SplitBrainHandler {
    
    // Fencing Tokenæœºåˆ¶
    public boolean validateRequest(long zxid, long epoch) {
        // æ£€æŸ¥è¯·æ±‚æ˜¯å¦æ¥è‡ªæ­£ç¡®çš„Leader epoch
        if (epoch < currentEpoch) {
            // æ¥è‡ªæ—§Leaderçš„è¯·æ±‚ï¼Œæ‹’ç»
            log.warn("Rejecting request from old leader epoch: {}", epoch);
            return false;
        }
        
        // æ£€æŸ¥zxidæ˜¯å¦åˆæ³•
        if (zxid <= lastCommittedZxid) {
            // é‡å¤æˆ–è¿‡æœŸçš„è¯·æ±‚
            return false;
        }
        
        return true;
    }
    
    // ç½‘ç»œåˆ†åŒºæ¢å¤åçš„æ•°æ®æ ¡éªŒ
    public void recoverFromSplitBrain() {
        // 1. åœæ­¢æ¥å—å®¢æˆ·ç«¯è¯·æ±‚
        pauseService();
        
        // 2. æ¯”è¾ƒå„èŠ‚ç‚¹æ•°æ®
        Map<Long, ZKData> nodeData = collectDataFromAllNodes();
        
        // 3. ä½¿ç”¨zxidæœ€é«˜çš„æ•°æ®
        long maxZxid = -1;
        ZKData correctData = null;
        
        for (Map.Entry<Long, ZKData> entry : nodeData.entrySet()) {
            if (entry.getKey() > maxZxid) {
                maxZxid = entry.getKey();
                correctData = entry.getValue();
            }
        }
        
        // 4. æ•°æ®æ¢å¤
        restoreData(correctData);
        
        // 5. é‡æ–°é€‰ä¸¾Leader
        startNewElection();
        
        // 6. æ¢å¤æœåŠ¡
        resumeService();
    }
}
```

**Apolloçš„è„‘è£‚é¿å…ç­–ç•¥**

```java
// Apolloé˜²è„‘è£‚ç­–ç•¥
public class ApolloSplitBrainPrevention {
    
    // 1. æ•°æ®åº“å”¯ä¸€çº¦æŸé˜²è„‘è£‚
    @Entity
    @Table(name = "apollo_config", 
           uniqueConstraints = @UniqueConstraint(
               columnNames = {"app_id", "cluster_name", "namespace", "key"}))
    public class ApolloConfig {
        // ç›¸åŒé…ç½®åªèƒ½æœ‰ä¸€æ¡è®°å½•
    }
    
    // 2. ä¹è§‚é”é˜²å¹¶å‘å†™å†²çª
    @Transactional
    public void updateConfig(ConfigDTO config) {
        int rows = jdbcTemplate.update(
            "UPDATE apollo_config SET value = ?, data_change_last_modified_by = ?, " +
            "data_change_last_modified_time = NOW() " +
            "WHERE id = ? AND row_version = ?",
            config.getValue(), config.getOperator(), 
            config.getId(), config.getRowVersion()
        );
        
        if (rows == 0) {
            // ç‰ˆæœ¬å†²çªï¼Œè¯´æ˜å…¶ä»–å®ä¾‹å·²ä¿®æ”¹
            throw new OptimisticLockException("Configå·²è¢«å…¶ä»–å®ä¾‹ä¿®æ”¹");
        }
    }
    
    // 3. åˆ†å¸ƒå¼é”ç¡®ä¿å•Masteræ“ä½œ
    public void performMasterOperation() {
        String lockKey = "master_operation_lock";
        try {
            // å°è¯•è·å–åˆ†å¸ƒå¼é”
            if (distributedLock.tryLock(lockKey, 5, TimeUnit.SECONDS)) {
                try {
                    // åªæœ‰è·å¾—é”çš„å®ä¾‹æ‰§è¡Œæ“ä½œ
                    executeCriticalOperation();
                } finally {
                    distributedLock.unlock(lockKey);
                }
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
}
```

##### **4. åˆ†åŒºå®¹å¿ç­–ç•¥**

###### **CAPç†è®ºä¸‹çš„é€‰æ‹©**

```markdown
æ ¹æ®CAPç†è®ºï¼š
â€¢ etcd/ZKï¼šé€‰æ‹©CPï¼ˆä¸€è‡´æ€§+åˆ†åŒºå®¹å¿æ€§ï¼‰
â€¢ Apolloï¼šé€‰æ‹©APï¼ˆå¯ç”¨æ€§+åˆ†åŒºå®¹å¿æ€§ï¼‰

ç½‘ç»œåˆ†åŒºæ—¶çš„è¡Œä¸ºï¼š
1. CPç³»ç»Ÿï¼šä¿è¯ä¸€è‡´æ€§ï¼Œç‰ºç‰²å¯ç”¨æ€§
   - å°‘æ•°æ´¾åˆ†åŒºåœæ­¢æœåŠ¡
   - å¤šæ•°æ´¾åˆ†åŒºç»§ç»­æœåŠ¡
   
2. APç³»ç»Ÿï¼šä¿è¯å¯ç”¨æ€§ï¼Œç‰ºç‰²å¼ºä¸€è‡´æ€§
   - æ‰€æœ‰åˆ†åŒºç»§ç»­æœåŠ¡
   - ç½‘ç»œæ¢å¤åè§£å†³å†²çª
```

###### **å†²çªè§£å†³ç­–ç•¥**

```java
// æœ€åå†™å…¥èƒœå‡ºï¼ˆLast-Write-Winsï¼‰
public class LWWConflictResolver {
    
    public Config resolveConflict(Config oldConfig, Config newConfig) {
        // æ¯”è¾ƒæ—¶é—´æˆ³
        if (newConfig.getTimestamp() > oldConfig.getTimestamp()) {
            return newConfig;
        } else if (newConfig.getTimestamp() < oldConfig.getTimestamp()) {
            return oldConfig;
        } else {
            // æ—¶é—´æˆ³ç›¸åŒï¼Œæ¯”è¾ƒå®ä¾‹ID
            return newConfig.getInstanceId().compareTo(oldConfig.getInstanceId()) > 0 
                ? newConfig : oldConfig;
        }
    }
}

// å®¢æˆ·ç«¯ç‰ˆæœ¬å‘é‡ï¼ˆVector Clockï¼‰
public class VectorClock {
    private Map<String, Long> clocks = new HashMap<>();
    
    public void increment(String nodeId) {
        clocks.put(nodeId, clocks.getOrDefault(nodeId, 0L) + 1);
    }
    
    public boolean happenedBefore(VectorClock other) {
        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ—¶é’Ÿå€¼éƒ½å°äºç­‰äº
        for (Map.Entry<String, Long> entry : clocks.entrySet()) {
            Long otherValue = other.clocks.get(entry.getKey());
            if (otherValue == null || entry.getValue() > otherValue) {
                return false;
            }
        }
        return true;
    }
}
```

------

#### äº”ã€æ•°æ®é«˜å¯ç”¨æ–¹æ¡ˆ

##### **1. æ•°æ®å¤åˆ¶ç­–ç•¥**

**åŒæ­¥å¤åˆ¶ vs å¼‚æ­¥å¤åˆ¶**

```java
// åŒæ­¥å¤åˆ¶ï¼ˆå¼ºä¸€è‡´ï¼‰
public class SyncReplication {
    public boolean writeData(String key, String value) {
        // 1. å†™å…¥æœ¬åœ°
        localWrite(key, value);
        
        // 2. åŒæ­¥å¤åˆ¶åˆ°å…¶ä»–èŠ‚ç‚¹
        List<Replica> replicas = getReplicas();
        int successCount = 0;
        
        for (Replica replica : replicas) {
            try {
                replica.write(key, value);
                successCount++;
            } catch (Exception e) {
                log.error("Replication failed", e);
            }
        }
        
        // 3. æ£€æŸ¥æ˜¯å¦è¾¾åˆ°å¤šæ•°æ´¾
        return successCount >= getQuorum();
    }
}

// å¼‚æ­¥å¤åˆ¶ï¼ˆæœ€ç»ˆä¸€è‡´ï¼‰
public class AsyncReplication {
    private ExecutorService replicationExecutor;
    
    public void writeData(String key, String value) {
        // 1. å†™å…¥æœ¬åœ°ï¼ˆç«‹å³è¿”å›ï¼‰
        localWrite(key, value);
        
        // 2. å¼‚æ­¥å¤åˆ¶
        replicationExecutor.submit(() -> {
            for (Replica replica : getReplicas()) {
                try {
                    replica.write(key, value);
                } catch (Exception e) {
                    log.error("Async replication failed", e);
                    // è®°å½•å¤±è´¥ï¼Œç¨åé‡è¯•
                    recordFailedReplication(key, value, replica);
                }
            }
        });
    }
}
```

**å¤šå‰¯æœ¬æ”¾ç½®ç­–ç•¥**

```yaml
# å¤šæœºæˆ¿éƒ¨ç½²é…ç½®
replication:
  strategy: multi-dc  # å¤šæ•°æ®ä¸­å¿ƒ
  factor: 3           # å‰¯æœ¬æ•°
  
  # æœºæˆ¿é—´å¤åˆ¶
  cross-dc-replication:
    enabled: true
    sync: async       # è·¨æœºæˆ¿å¼‚æ­¥å¤åˆ¶
    dc-latency: 50ms  # æœºæˆ¿å»¶è¿Ÿ
    
  # æœºæˆ¿é—´å‰¯æœ¬åˆ†å¸ƒ
  placement:
    dc-1: 2           # æœºæˆ¿1æ”¾2ä¸ªå‰¯æœ¬
    dc-2: 1           # æœºæˆ¿2æ”¾1ä¸ªå‰¯æœ¬
    
  # æ•…éšœè½¬ç§»ç­–ç•¥
  failover:
    auto: true
    priority:         # æ•…éšœè½¬ç§»ä¼˜å…ˆçº§
      - dc-1
      - dc-2
      - dc-3
```

##### **2. æ•°æ®æŒä¹…åŒ–æ–¹æ¡ˆ**

###### **WALï¼ˆWrite-Ahead Loggingï¼‰**

```go
// etcd WALå®ç°
type WAL struct {
    dir      string          // WALç›®å½•
    metadata []byte          // å…ƒæ•°æ®
    state    raftpb.HardState // ç¡¬çŠ¶æ€
    
    // æ–‡ä»¶ç®¡ç†
    files    []*fileutil.LockedFile
    encoder  *encoder        // ç¼–ç å™¨
    decoder  *decoder        // è§£ç å™¨
}

func (w *WAL) Save(st raftpb.HardState, entries []raftpb.Entry) error {
    // 1. è¿½åŠ åˆ°WALæ–‡ä»¶
    data := encode(st, entries)
    
    // 2. å†™å…¥æ–‡ä»¶ï¼ˆç¡®ä¿æ•°æ®è½ç›˜ï¼‰
    if err := w.encoder.encode(data); err != nil {
        return err
    }
    
    // 3. è°ƒç”¨fsyncç¡®ä¿æ•°æ®æŒä¹…åŒ–
    if err := w.encoder.sync(); err != nil {
        return err
    }
    
    // 4. æ›´æ–°å†…å­˜çŠ¶æ€
    w.state = st
    
    return nil
}

func (w *WAL) Recover() (*raftpb.HardState, error) {
    // ä»WALæ¢å¤æ•°æ®
    var state raftpb.HardState
    
    for {
        data, err := w.decoder.decode()
        if err != nil {
            if err == io.EOF {
                break
            }
            return nil, err
        }
        
        // åº”ç”¨æ—¥å¿—æ¡ç›®
        applyEntry(data)
        
        // æ›´æ–°çŠ¶æ€
        if data.State != nil {
            state = *data.State
        }
    }
    
    return &state, nil
}
```

###### **å¿«ç…§æœºåˆ¶**

```java
// ZKå¿«ç…§æœºåˆ¶
public class SnapshotManager {
    
    public void takeSnapshot(File snapDir, File logDir) throws IOException {
        // 1. åˆ›å»ºä¸´æ—¶å¿«ç…§æ–‡ä»¶
        File snapshotFile = new File(snapDir, "snapshot." + System.currentTimeMillis());
        
        try (DataOutputStream snapStream = new DataOutputStream(
                new BufferedOutputStream(new FileOutputStream(snapshotFile)))) {
            
            // 2. åºåˆ—åŒ–æ•°æ®æ ‘
            serializeDataTree(snapStream);
            
            // 3. åºåˆ—åŒ–ä¼šè¯
            serializeSessions(snapStream);
            
            // 4. åˆ·æ–°åˆ°ç£ç›˜
            snapStream.flush();
        }
        
        // 5. åŸå­æ€§æ›¿æ¢æ—§å¿«ç…§
        File finalSnapshot = new File(snapDir, "snapshot");
        Files.move(snapshotFile.toPath(), finalSnapshot.toPath(), 
                  StandardCopyOption.REPLACE_EXISTING,
                  StandardCopyOption.ATOMIC_MOVE);
        
        // 6. æ¸…ç†æ—§æ—¥å¿—
        cleanupOldLogs(logDir);
    }
    
    private void cleanupOldLogs(File logDir) {
        // æ‰¾åˆ°æœ€æ–°çš„å¿«ç…§å¯¹åº”çš„zxid
        long snapshotZxid = getSnapshotZxid();
        
        // åˆ é™¤zxidå°äºå¿«ç…§çš„æ—§æ—¥å¿—
        for (File logFile : logDir.listFiles()) {
            if (isLogFile(logFile) && getZxidFromLogFile(logFile) < snapshotZxid) {
                logFile.delete();
            }
        }
    }
}
```

##### **3. æ•°æ®å¤‡ä»½ä¸æ¢å¤**

**å…¨é‡å¤‡ä»½ç­–ç•¥**

```bash
#!/bin/bash
# etcdæ•°æ®å¤‡ä»½è„šæœ¬

# å¤‡ä»½å‚æ•°
ENDPOINTS="https://etcd1:2379,https://etcd2:2379,https://etcd3:2379"
CACERT="/etc/etcd/ca.crt"
CERT="/etc/etcd/server.crt"
KEY="/etc/etcd/server.key"
BACKUP_DIR="/backup/etcd"
DATE=$(date +%Y%m%d_%H%M%S)

# åˆ›å»ºå¿«ç…§
etcdctl --endpoints=$ENDPOINTS \
        --cacert=$CACERT \
        --cert=$CERT \
        --key=$KEY \
        snapshot save "$BACKUP_DIR/snapshot_$DATE.db"

# éªŒè¯å¿«ç…§
etcdctl --write-out=table snapshot status "$BACKUP_DIR/snapshot_$DATE.db"

# ä¿ç•™æœ€è¿‘7å¤©å¤‡ä»½
find $BACKUP_DIR -name "snapshot_*.db" -mtime +7 -delete

# ä¸Šä¼ åˆ°äº‘å­˜å‚¨
aws s3 cp "$BACKUP_DIR/snapshot_$DATE.db" "s3://my-backup-bucket/etcd/"
```

**å¢é‡å¤‡ä»½ä¸PITR**

```sql
-- Apolloæ•°æ®åº“å¢é‡å¤‡ä»½
-- ä½¿ç”¨MySQL binlogå®ç°å¢é‡å¤‡ä»½

-- 1. å¼€å¯binlog
SET GLOBAL log_bin = ON;
SET GLOBAL binlog_format = 'ROW';
SET GLOBAL expire_logs_days = 7;

-- 2. åˆ›å»ºå¤‡ä»½ç”¨æˆ·
CREATE USER 'backup_user'@'%' IDENTIFIED BY 'secure_password';
GRANT SELECT, RELOAD, LOCK TABLES, REPLICATION CLIENT ON *.* TO 'backup_user'@'%';

-- 3. ç‰©ç†å¤‡ä»½è„šæœ¬
#!/bin/bash
# ç‰©ç†å¤‡ä»½
mysqldump --single-transaction --master-data=2 \
          --routines --triggers \
          apollodb > apollo_full_$(date +%Y%m%d).sql

# 4. å®æ—¶binlogå¤‡ä»½
mysqlbinlog --read-from-remote-server --host=mysql-master \
            --user=backup_user --password=secure_password \
            --raw --stop-never mysql-bin.000001 &

# 5. æ—¶é—´ç‚¹æ¢å¤ï¼ˆPoint-In-Time Recoveryï¼ŒPITRï¼‰
# æ¢å¤å…¨é‡å¤‡ä»½
mysql apollodb < apollo_full_20240215.sql

# æ¢å¤åˆ°æŒ‡å®šæ—¶é—´ç‚¹
mysqlbinlog --start-datetime="2024-02-15 10:00:00" \
            --stop-datetime="2024-02-15 10:30:00" \
            mysql-bin.000001 | mysql apollodb
```

------

#### å…­ã€ç›‘æ§ä¸å‘Šè­¦

**1. å…³é”®ç›‘æ§æŒ‡æ ‡**

```yaml
# Prometheusç›‘æ§é…ç½®
scrape_configs:
  - job_name: 'etcd'
    static_configs:
      - targets: ['etcd1:2379', 'etcd2:2379', 'etcd3:2379']
    metrics_path: /metrics
    
  - job_name: 'zookeeper'
    static_configs:
      - targets: ['zk1:2181', 'zk2:2181', 'zk3:2181']
    metrics_path: /metrics
    
  - job_name: 'apollo'
    static_configs:
      - targets: ['config-service1:8080', 'config-service2:8080']
    metrics_path: /actuator/prometheus
```

**2. æ ¸å¿ƒç›‘æ§é¡¹**

```promql
# 1. é›†ç¾¤å¥åº·çŠ¶æ€
up{job="etcd"} == 1
etcd_server_has_leader{instance=~".*"} == 1

# 2. é€‰ä¸¾ç›¸å…³
etcd_server_leader_changes_seen_total
rate(etcd_server_leader_changes_seen_total[5m]) > 0.1  # é¢‘ç¹Leaderåˆ‡æ¢å‘Šè­¦

# 3. æ€§èƒ½æŒ‡æ ‡
histogram_quantile(0.95, rate(etcd_disk_wal_fsync_duration_seconds_bucket[5m])) > 0.5
rate(etcd_network_client_grpc_received_bytes_total[5m]) > 10000000  # ç½‘ç»œæµé‡å¼‚å¸¸

# 4. å­˜å‚¨æŒ‡æ ‡
etcd_mvcc_db_total_size_in_bytes / 1024 / 1024 > 1024  # æ•°æ®è¶…è¿‡1GBå‘Šè­¦
etcd_debugging_mvcc_db_compaction_keys_total  # å‹ç¼©ç»Ÿè®¡

# 5. å®¢æˆ·ç«¯è¿æ¥
etcd_grpc_proxy_clients > 1000  # å®¢æˆ·ç«¯è¿æ¥æ•°è¿‡å¤š
```

**3. å‘Šè­¦è§„åˆ™ç¤ºä¾‹**

```yaml
groups:
  - name: config-center-alerts
    rules:
      # Leaderä¸¢å¤±å‘Šè­¦
      - alert: ConfigCenterNoLeader
        expr: etcd_server_has_leader == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "{{ $labels.instance }} ä¸¢å¤±Leader"
          description: "etcdå®ä¾‹ {{ $labels.instance }} è¶…è¿‡1åˆ†é’Ÿæ²¡æœ‰Leader"
          
      # è„‘è£‚é£é™©å‘Šè­¦
      - alert: ConfigCenterSplitBrainRisk
        expr: sum(etcd_server_is_leader) by (job) > 1
        for: 30s
        labels:
          severity: critical
        annotations:
          summary: "æ£€æµ‹åˆ°å¤šä¸ªLeaderï¼Œå¯èƒ½å­˜åœ¨è„‘è£‚"
          description: "é›†ç¾¤ä¸­å­˜åœ¨ {{ $value }} ä¸ªLeaderå®ä¾‹"
          
      # ç£ç›˜ç©ºé—´å‘Šè­¦
      - alert: ConfigCenterDiskFull
        expr: (node_filesystem_avail_bytes{mountpoint="/var/lib/etcd"} / node_filesystem_size_bytes{mountpoint="/var/lib/etcd"}) * 100 < 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "{{ $labels.instance }} ç£ç›˜ç©ºé—´ä¸è¶³"
          description: "etcdæ•°æ®ç›®å½•å‰©ä½™ç©ºé—´ä¸è¶³10%"
          
      # å“åº”æ—¶é—´å‘Šè­¦
      - alert: ConfigCenterHighLatency
        expr: histogram_quantile(0.95, rate(etcd_disk_wal_fsync_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "{{ $labels.instance }} å“åº”å»¶è¿Ÿé«˜"
          description: "95%çš„è¯·æ±‚å»¶è¿Ÿè¶…è¿‡1ç§’"
```

------

#### ä¸ƒã€æœ€ä½³å®è·µä¸æ€»ç»“

##### **1. é€‰å‹å»ºè®®**

![image-20260203171538623](å·¥ç¨‹ç´ å…»ç¯‡ï¼ˆä¸­çº§ï¼‰.assets/image-20260203171538623.png)

##### **2. éƒ¨ç½²å»ºè®®**

**ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¶æ„**

```markdown
é«˜å¯ç”¨éƒ¨ç½²æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   è´Ÿè½½å‡è¡¡å±‚                         â”‚
â”‚               (Nginx/Haproxy)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚               â”‚               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
        â”‚  èŠ‚ç‚¹1        â”‚ â”‚  èŠ‚ç‚¹2      â”‚ â”‚  èŠ‚ç‚¹3     â”‚
        â”‚  (å¯ç”¨åŒºA)    â”‚ â”‚ (å¯ç”¨åŒºB)   â”‚ â”‚ (å¯ç”¨åŒºC)  â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ â€¢ é…ç½®ä¸­å¿ƒ    â”‚ â”‚ â€¢ é…ç½®ä¸­å¿ƒ  â”‚ â”‚ â€¢ é…ç½®ä¸­å¿ƒ â”‚
        â”‚ â€¢ ç›‘æ§ä»£ç†    â”‚ â”‚ â€¢ ç›‘æ§ä»£ç†  â”‚ â”‚ â€¢ ç›‘æ§ä»£ç† â”‚
        â”‚ â€¢ æœ¬åœ°ç¼“å­˜    â”‚ â”‚ â€¢ æœ¬åœ°ç¼“å­˜  â”‚ â”‚ â€¢ æœ¬åœ°ç¼“å­˜ â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                â”‚               â”‚               â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   å…±äº«å­˜å‚¨å±‚         â”‚
                    â”‚  (æ•°æ®åº“/å¯¹è±¡å­˜å‚¨)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é…ç½®å»ºè®®**

```yaml
# é€šç”¨é…ç½®å»ºè®®
cluster:
  size: 3  # æœ€å°‘3èŠ‚ç‚¹ï¼Œç¡®ä¿å¤šæ•°æ´¾
  placement:
    strategy: anti-affinity  # åäº²å’Œéƒ¨ç½²
    zones: 3                 # è·¨3ä¸ªå¯ç”¨åŒº
    
data:
  persistence:
    enabled: true
    storage-class: ssd       # SSDå­˜å‚¨
    size: 100Gi              # è‡³å°‘100GB
    
  backup:
    enabled: true
    schedule: "0 2 * * *"    # æ¯å¤©2ç‚¹å¤‡ä»½
    retention: 30            # ä¿ç•™30å¤©
    
monitoring:
  enabled: true
  metrics: prometheus
  logging: elk
  
security:
  tls:
    enabled: true
    cert-rotation: auto
  auth:
    enabled: true
    audit: true
```

##### **3. æ•…éšœå¤„ç†æ‰‹å†Œ**

**å¸¸è§æ•…éšœä¸å¤„ç†**

```bash
# æ•…éšœ1: Leaderé¢‘ç¹åˆ‡æ¢
# å¯èƒ½åŸå› : ç½‘ç»œä¸ç¨³å®šã€èŠ‚ç‚¹è´Ÿè½½é«˜
# è§£å†³æ–¹æ¡ˆ:
1. æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿ: ping <node-ip>
2. æ£€æŸ¥èŠ‚ç‚¹è´Ÿè½½: top, iostat
3. è°ƒæ•´é€‰ä¸¾è¶…æ—¶: å¢åŠ  election-timeout
4. å‡çº§ç¡¬ä»¶: CPU/å†…å­˜/ç½‘ç»œ

# æ•…éšœ2: å†™å…¥å¤±è´¥
# å¯èƒ½åŸå› : ç£ç›˜æ»¡ã€æ²¡æœ‰Leader
# è§£å†³æ–¹æ¡ˆ:
1. æ£€æŸ¥ç£ç›˜ç©ºé—´: df -h
2. æ£€æŸ¥LeaderçŠ¶æ€: etcdctl endpoint status
3. æ¸…ç†æ—§æ•°æ®: å‹ç¼©ã€å¿«ç…§
4. é‡å¯æ•…éšœèŠ‚ç‚¹

# æ•…éšœ3: è„‘è£‚å‘ç”Ÿ
# è§£å†³æ–¹æ¡ˆ:
1. æš‚åœå®¢æˆ·ç«¯å†™æ“ä½œ
2. ç¡®å®šå¤šæ•°æ´¾åˆ†åŒº
3. å°‘æ•°æ´¾åˆ†åŒºåœæ­¢æœåŠ¡
4. ç½‘ç»œæ¢å¤åæ•°æ®åŒæ­¥
5. é€æ­¥æ¢å¤æœåŠ¡
```

**æ¢å¤æµç¨‹**

```python
# è‡ªåŠ¨åŒ–æ¢å¤è„šæœ¬æ¡†æ¶
class ConfigCenterRecovery:
    
    def recover_from_disaster(self):
        """ç¾éš¾æ¢å¤ä¸»æµç¨‹"""
        try:
            # 1. è¯„ä¼°æŸåç¨‹åº¦
            damage_level = self.assess_damage()
            
            # 2. æ ¹æ®æŸåç¨‹åº¦é€‰æ‹©æ¢å¤ç­–ç•¥
            if damage_level == "full":
                self.full_recovery()
            elif damage_level == "partial":
                self.partial_recovery()
            elif damage_level == "data_loss":
                self.data_loss_recovery()
            else:
                self.minor_recovery()
                
            # 3. éªŒè¯æ¢å¤ç»“æœ
            self.validate_recovery()
            
            # 4. é€æ­¥æ¢å¤æœåŠ¡
            self.gradual_service_resume()
            
        except Exception as e:
            logger.error(f"Recovery failed: {e}")
            self.escalate_to_human()
    
    def full_recovery(self):
        """å®Œå…¨æ¢å¤"""
        # ä»å¤‡ä»½æ¢å¤
        self.restore_from_backup()
        
        # é‡å»ºé›†ç¾¤
        self.rebuild_cluster()
        
        # æ•°æ®æ ¡éªŒ
        self.validate_data_integrity()
```

##### **4. æœªæ¥è¶‹åŠ¿**

**äº‘åŸç”Ÿé…ç½®ä¸­å¿ƒ**

```yaml
# KubernetesåŸç”Ÿé…ç½®ç®¡ç†
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  database.url: "jdbc:mysql://mysql:3306/app"
  cache.host: "redis:6379"
  feature.flags: "new-ui,beta-api"
---
apiVersion: v1
kind: Secret
metadata:
  name: app-secrets
type: Opaque
data:
  db.password: c2VjcmV0MTIz  # base64ç¼–ç 
  api.key: YXBpS2V5QDEyMw==
```

**GitOpsé…ç½®ç®¡ç†**

```yaml
# ArgoCDé…ç½®ç¤ºä¾‹
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: config-center
spec:
  project: default
  source:
    repoURL: https://github.com/company/config-repo.git
    targetRevision: HEAD
    path: configs/
  destination:
    server: https://kubernetes.default.svc
    namespace: config-center
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
```

#### æ€»ç»“

é…ç½®ä¸­å¿ƒçš„é«˜å¯ç”¨è®¾è®¡éœ€è¦ç»¼åˆè€ƒè™‘ï¼š

1. **æ•°æ®ä¸€è‡´æ€§**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©CPæˆ–AP
2. **é€‰ä¸»æœºåˆ¶**ï¼šRaft/ZABç®—æ³•ç¡®ä¿Leaderå”¯ä¸€æ€§
3. **è„‘è£‚é˜²æŠ¤**ï¼šå¤šæ•°æ´¾åŸåˆ™ã€ä»»æœŸæœºåˆ¶ã€Fencing Token
4. **æ•°æ®æŒä¹…åŒ–**ï¼šWALã€å¿«ç…§ã€å¤šå‰¯æœ¬å­˜å‚¨
5. **ç›‘æ§å‘Šè­¦**ï¼šå…³é”®æŒ‡æ ‡ç›‘æ§ï¼ŒåŠæ—¶å‘ç°å’Œå¤„ç†é—®é¢˜

**æ¨èç­–ç•¥**ï¼š

- **K8sç¯å¢ƒ**ï¼šé¦–é€‰etcdï¼Œå¤©ç„¶é›†æˆ
- **Javaç”Ÿæ€**ï¼šè€ƒè™‘Apolloï¼ŒåŠŸèƒ½å®Œå–„æ˜“ç”¨
- **å¼ºä¸€è‡´éœ€æ±‚**ï¼šé€‰æ‹©ZooKeeperï¼Œé‡‘èçº§ä¿è¯
- **æ··åˆäº‘/å¤šäº‘**ï¼šè€ƒè™‘Consulï¼Œå¤šæ•°æ®ä¸­å¿ƒæ”¯æŒ





## **æœåŠ¡ç½‘å…³**

> Kong/Zuul/apisixï¼Œæ”¶æ‹¢APIæ³¨å†Œ/è®¤è¯æˆæƒ/å…¥å£åè®®/é™æµç†”æ–­/ä¼˜é›…ä¸‹çº¿/æ—¥å¿—ç›‘æ§ç­‰èƒ½åŠ›

#### **ä¸€ã€æœåŠ¡ç½‘å…³æ ¸å¿ƒä»·å€¼**

**1. ç½‘å…³åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„å®šä½**

```markdown
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               å¾®æœåŠ¡æ¶æ„ä¸­çš„ç½‘å…³å±‚                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¤–éƒ¨å®¢æˆ·ç«¯ â”‚ ç§»åŠ¨ç«¯ â”‚ Webå‰ç«¯ â”‚ ç¬¬ä¸‰æ–¹æœåŠ¡        â”‚
â”‚     â†“         â†“        â†“          â†“               â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚    â”‚          æœåŠ¡ç½‘å…³ (API Gateway)      â”‚       â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚       â”‚
â”‚    â”‚  â”‚ è·¯ç”±   â”‚ è®¤è¯   â”‚ é™æµ         â”‚ â”‚       â”‚
â”‚    â”‚  â”‚ è´Ÿè½½å‡è¡¡â”‚ æˆæƒ   â”‚ ç†”æ–­         â”‚ â”‚       â”‚
â”‚    â”‚  â”‚ åè®®è½¬æ¢â”‚ ç›‘æ§   â”‚ ç¼“å­˜         â”‚ â”‚       â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚       â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚            â†“           â†“           â†“              â”‚
â”‚        [æœåŠ¡A]      [æœåŠ¡B]      [æœåŠ¡C]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**2. æ ¸å¿ƒèƒ½åŠ›çŸ©é˜µ**

| èƒ½åŠ›ç±»åˆ«        | å…·ä½“åŠŸèƒ½                | é‡è¦æ€§ |
| --------------- | ----------------------- | ------ |
| **APIç”Ÿå‘½å‘¨æœŸ** | æ³¨å†Œ/å‘ç°/ç‰ˆæœ¬/ä¸‹çº¿     | â˜…â˜…â˜…â˜…â˜…  |
| **å®‰å…¨é˜²æŠ¤**    | è®¤è¯/æˆæƒ/åŠ å¯†/é˜²æ”»å‡»   | â˜…â˜…â˜…â˜…â˜…  |
| **æµé‡æ²»ç†**    | é™æµ/ç†”æ–­/é™çº§/é‡è¯•     | â˜…â˜…â˜…â˜…â˜…  |
| **å¯è§‚æµ‹æ€§**    | æ—¥å¿—/ç›‘æ§/é“¾è·¯è¿½è¸ª      | â˜…â˜…â˜…â˜…â˜…  |
| **æ€§èƒ½ä¼˜åŒ–**    | ç¼“å­˜/å‹ç¼©/åè®®è½¬æ¢      | â˜…â˜…â˜…â˜…â˜†  |
| **è¿ç»´ç®¡ç†**    | é…ç½®/å‘å¸ƒ/ç°åº¦/æ•…éšœæ³¨å…¥ | â˜…â˜…â˜…â˜…â˜†  |

#### **äºŒã€ä¸‰å¤§ç½‘å…³æ·±åº¦å¯¹æ¯”**

**1. æ ¸å¿ƒç‰¹æ€§å¯¹æ¯”è¡¨**

| ç»´åº¦         | **Kong**                          | **Zuul**                    | **APISIX**                 |
| ------------ | --------------------------------- | --------------------------- | -------------------------- |
| **æ¶æ„æ¨¡å‹** | Nginx + Luaæ’ä»¶                   | Servlet Filter              | Nginx + etcd + æ’ä»¶çƒ­åŠ è½½  |
| **å¼€å‘è¯­è¨€** | Lua                               | Java                        | Lua + Go                   |
| **æ€§èƒ½è¡¨ç°** | æé«˜ (æ¯«ç§’çº§å»¶è¿Ÿ)                 | ä¸­ç­‰ (åŸºäºJVM)              | æé«˜ (åŠ¨æ€çƒ­æ’æ‹”)          |
| **åŠ¨æ€é…ç½®** | åŸºäºæ•°æ®åº“ (PostgreSQL/Cassandra) | åŸºäºé…ç½®æ–‡ä»¶/Spring Cloud   | åŸºäºetcd (æ¯«ç§’çº§ç”Ÿæ•ˆ)      |
| **æ’ä»¶ç”Ÿæ€** | ä¸°å¯Œ (300+å®˜æ–¹/ç¤¾åŒºæ’ä»¶)          | ä¸­ç­‰ (ä¾èµ–Spring Cloud)     | ä¸°å¯Œ (åŠ¨æ€çƒ­åŠ è½½æ’ä»¶)      |
| **æœåŠ¡å‘ç°** | æ”¯æŒDNS/Consulç­‰                  | åŸç”Ÿé›†æˆEureka              | åŸç”Ÿæ”¯æŒå¤šç§æ³¨å†Œä¸­å¿ƒ       |
| **é…ç½®ç®¡ç†** | REST Admin API + Kong Manager     | é…ç½®æ–‡ä»¶ + Spring Config    | Dashboard + REST API       |
| **äº‘åŸç”Ÿ**   | Kubernetes Ingressæ”¯æŒ            | Spring Cloud Gatewayæ›¿ä»£    | åŸç”ŸK8s Ingress Controller |
| **å­¦ä¹ æ›²çº¿** | ä¸­ç­‰                              | ä½ (å¯¹Javaå¼€å‘è€…)           | ä¸­ç­‰                       |
| **ç¤¾åŒºæ´»è·ƒ** | éå¸¸æ´»è·ƒ                          | æ´»è·ƒ (ä½†Zuul 1.xå·²åœæ­¢)     | éå¸¸æ´»è·ƒ (Apacheé¡¶çº§é¡¹ç›®)  |
| **ä¼ä¸šåº”ç”¨** | æˆç†Ÿ (Mashapeâ†’Kong Inc.)          | å¹¿æ³› (Netflix/Spring Cloud) | æ–°å…´ä½†å¢é•¿è¿…é€Ÿ             |

**2. æ€§èƒ½åŸºå‡†æµ‹è¯•å¯¹æ¯”**

```yaml
# æµ‹è¯•ç¯å¢ƒï¼š4æ ¸8Gï¼Œ1000å¹¶å‘è¿æ¥
ç½‘å…³æ€§èƒ½å¯¹æ¯”:
  Kong:
    ååé‡: 50,000 RPSï¼ˆRequests Per Secondï¼‰
    å»¶è¿Ÿ: 1.2ms (p99)
    å†…å­˜: 200MB
    
  Zuul 1.x:
    ååé‡: 20,000 RPS  
    å»¶è¿Ÿ: 5ms (p99)
    å†…å­˜: 500MB (JVMå †)
    
  APISIX:
    ååé‡: 60,000 RPS
    å»¶è¿Ÿ: 0.8ms (p99)
    å†…å­˜: 150MB
    
  Zuul 2.x / Spring Cloud Gateway:
    ååé‡: 30,000 RPS
    å»¶è¿Ÿ: 3ms (p99)
    å†…å­˜: 300MB
```



RPS vs QPSï¼š

```python
# å®šä¹‰å¯¹æ¯”
class MetricsDefinition:
    # RPS: Requests Per Second
    # æ¯ç§’è¯·æ±‚æ•° - å®¢æˆ·ç«¯è§†è§’
    RPS = å®¢æˆ·ç«¯æ¯ç§’å‘å‡ºçš„HTTPè¯·æ±‚æ€»æ•°
    
    # QPS: Queries Per Second  
    # æ¯ç§’æŸ¥è¯¢æ•° - æœåŠ¡ç«¯/æ•°æ®åº“è§†è§’
    QPS = æœåŠ¡ç«¯æ¯ç§’å¤„ç†çš„æŸ¥è¯¢/æ“ä½œæ€»æ•°
    
    # å…³é”®åŒºåˆ«
    difference = {
        "è§†è§’ä¸åŒ": "RPS(å®¢æˆ·ç«¯) vs QPS(æœåŠ¡ç«¯)",
        "èŒƒå›´ä¸åŒ": "RPS(HTTPå±‚) vs QPS(ä¸šåŠ¡/æ•°æ®å±‚)",
        "ç²’åº¦ä¸åŒ": "RPS(ç²—ç²’åº¦) vs QPS(ç»†ç²’åº¦)"
    }
```



#### **ä¸‰ã€Kong æ·±åº¦è§£æ**

##### **1. æ¶æ„è®¾è®¡**

```bash
# Kong æ¶æ„æ¦‚è§ˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Kong æ¶æ„                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å®¢æˆ·ç«¯è¯·æ±‚ â†’ Nginx (OpenResty)                      â”‚
â”‚                    â†“                                â”‚
â”‚            Kong æ’ä»¶ç³»ç»Ÿ (Lua)                       â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚        â”‚ è·¯ç”±   â”‚ è®¤è¯   â”‚ é™æµ   â”‚                â”‚
â”‚        â”‚ æ—¥å¿—   â”‚ ç›‘æ§   â”‚ è½¬æ¢   â”‚                â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                    â†“                                â”‚
â”‚              Upstream æœåŠ¡                          â”‚
â”‚                                                    â”‚
â”‚  é…ç½®å­˜å‚¨: PostgreSQL / Cassandra                  â”‚
â”‚  ç®¡ç†æ¥å£: Admin API (8001) + Kong Manager UI      â”‚
â”‚  æ•°æ®å¹³é¢: Proxy (8000) + Metrics (8002)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### **2. æ ¸å¿ƒé…ç½®ç¤ºä¾‹**

```yaml
# docker-compose.yml
version: '3.8'
services:
  kong-database:
    image: postgres:13
    environment:
      POSTGRES_USER: kong
      POSTGRES_PASSWORD: kong
      POSTGRES_DB: kong
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "kong"]
      interval: 30s
      retries: 3

  kong-migrations:
    image: kong:3.0
    command: "kong migrations bootstrap"
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_PASSWORD: kong
    depends_on:
      kong-database:
        condition: service_healthy

  kong:
    image: kong:3.0
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_PASSWORD: kong
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_PROXY_LISTEN: 0.0.0.0:8000
    ports:
      - "8000:8000"   # ä»£ç†ç«¯å£
      - "8001:8001"   # Admin API
      - "8443:8443"   # SSLä»£ç†
      - "8444:8444"   # Admin SSL
    depends_on:
      - kong-migrations
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      retries: 10
```

##### **3. å¸¸ç”¨æ’ä»¶é…ç½®**

```bash
# 1. åˆ›å»ºServiceï¼ˆåç«¯æœåŠ¡ï¼‰
curl -X POST http://localhost:8001/services \
  -d name=user-service \
  -d url=http://user-service:8080

# 2. åˆ›å»ºRouteï¼ˆè·¯ç”±è§„åˆ™ï¼‰
curl -X POST http://localhost:8001/services/user-service/routes \
  -d paths[]=/api/v1/users

# 3. å¯ç”¨JWTè®¤è¯æ’ä»¶
curl -X POST http://localhost:8001/services/user-service/plugins \
  -d name=jwt \
  -d config.claims_to_verify=exp

# 4. å¯ç”¨é™æµæ’ä»¶
curl -X POST http://localhost:8001/services/user-service/plugins \
  -d name=rate-limiting \
  -d config.minute=100 \
  -d config.policy=local

# 5. å¯ç”¨CORSæ’ä»¶
curl -X POST http://localhost:8001/services/user-service/plugins \
  -d name=cors \
  -d config.origins=* \
  -d config.methods=GET,POST,PUT,DELETE

# 6. å¯ç”¨Prometheusç›‘æ§
curl -X POST http://localhost:8001/services/user-service/plugins \
  -d name=prometheus
```

##### **4. é«˜çº§åŠŸèƒ½ï¼šé‡‘ä¸é›€å‘å¸ƒ**

```bash
# åˆ›å»ºä¸¤ä¸ªUpstreamï¼ˆæ–°æ—§ç‰ˆæœ¬ï¼‰
curl -X POST http://localhost:8001/upstreams \
  -d name=user-service-upstream

# æ·»åŠ ç›®æ ‡ï¼ˆæƒé‡åˆ†é…ï¼‰
curl -X POST http://localhost:8001/upstreams/user-service-upstream/targets \
  -d target=user-service-v1:8080 \
  -d weight=90  # 90%æµé‡åˆ°v1

curl -X POST http://localhost:8001/upstreams/user-service-upstream/targets \
  -d target=user-service-v2:8080 \
  -d weight=10  # 10%æµé‡åˆ°v2

# æ›´æ–°ServiceæŒ‡å‘Upstream
curl -X PATCH http://localhost:8001/services/user-service \
  -d host=user-service-upstream
```

#### **å››ã€APISIX æ·±åº¦è§£æ**

##### **1. æ¶æ„ä¼˜åŠ¿ï¼šåŠ¨æ€çƒ­åŠ è½½**

```bash
# APISIX æ¶æ„æ ¸å¿ƒç‰¹ç‚¹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 APISIX åŠ¨æ€æ¶æ„                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é…ç½®ä¸­å¿ƒ: etcd (æ¯«ç§’çº§åŒæ­¥)                        â”‚
â”‚                                                    â”‚
â”‚  æ•°æ®å¹³é¢: Nginx + LuaJIT                           â”‚
â”‚          â†“                                         â”‚
â”‚   æ’ä»¶çƒ­åŠ è½½ç³»ç»Ÿ                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â”‚ æ— éœ€é‡å¯ï¼ŒåŠ¨æ€å¯ç”¨/ç¦ç”¨æ’ä»¶           â”‚         â”‚
â”‚   â”‚ æ’ä»¶éš”ç¦»ï¼Œæ•…éšœä¸å½±å“ä¸»æµç¨‹            â”‚         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                    â”‚
â”‚  æ§åˆ¶å¹³é¢: APISIX Dashboard + Admin API            â”‚
â”‚                                                    â”‚
â”‚  å¯è§‚æµ‹æ€§: Prometheus + SkyWalking + Zipkin        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### **2. å®‰è£…ä¸é…ç½®**

```bash
# ä½¿ç”¨Dockerå¿«é€Ÿå®‰è£…
docker run -d \
  --name apisix \
  --network=apisix \
  -p 9080:9080 \
  -p 9091:9091 \
  -p 9092:9092 \
  -v /path/to/apisix/config.yaml:/usr/local/apisix/conf/config.yaml \
  apache/apisix:3.0

# config.yaml æ ¸å¿ƒé…ç½®
deployment:
  role: data_plane
  role_data_plane:
    config_provider: etcd
  etcd:
    host:
      - "http://etcd:2379"
    prefix: "/apisix"
    timeout: 30

apisix:
  node_listen: 9080
  enable_admin: true
  admin_key:
    - name: "admin"
      key: edd1c9f034335f136f87ad84b625c8f1
      role: admin
```

##### **3. åŠ¨æ€è·¯ç”±é…ç½®**

```bash
# 1. åˆ›å»ºä¸Šæ¸¸æœåŠ¡
curl "http://127.0.0.1:9180/apisix/admin/upstreams" \
  -H "X-API-KEY: edd1c9f034335f136f87ad84b625c8f1" \
  -X PUT -d '
  {
    "id": "user-service",
    "type": "roundrobin",
    "nodes": {
      "user-service-1:8080": 1,
      "user-service-2:8080": 1
    },
    "retries": 2,
    "checks": {
      "active": {
        "type": "http",
        "healthy": {
          "interval": 2,
          "successes": 1
        },
        "unhealthy": {
          "interval": 1,
          "http_failures": 2
        }
      }
    }
  }'

# 2. åˆ›å»ºè·¯ç”±
curl "http://127.0.0.1:9180/apisix/admin/routes" \
  -H "X-API-KEY: edd1c9f034335f136f87ad84b625c8f1" \
  -X PUT -d '
  {
    "id": "user-route",
    "uri": "/api/users/*",
    "upstream_id": "user-service",
    "plugins": {
      "limit-count": {
        "count": 100,
        "time_window": 60,
        "rejected_code": 429,
        "key_type": "var",
        "key": "remote_addr"
      },
      "jwt-auth": {
        "secret": "your-secret-key"
      }
    }
  }'
```

##### **4. æ’ä»¶çƒ­åŠ è½½ç¤ºä¾‹**

```bash
# åŠ¨æ€å¯ç”¨æ’ä»¶ï¼ˆæ— éœ€é‡å¯ï¼‰
curl "http://127.0.0.1:9180/apisix/admin/plugins/reload" \
  -H "X-API-KEY: edd1c9f034335f136f87ad84b625c8f1" \
  -X PUT

# è‡ªå®šä¹‰æ’ä»¶å¼€å‘
# 1. åˆ›å»ºæ’ä»¶æ–‡ä»¶
mkdir -p /usr/local/apisix/plugins
cat > /usr/local/apisix/plugins/request-id.lua << 'EOF'
local core = require("apisix.core")

local plugin_name = "request-id"

local schema = {
    type = "object",
    properties = {
        header_name = {
            type = "string",
            default = "X-Request-ID"
        }
    }
}

local _M = {
    version = 1.0,
    priority = 1000,
    name = plugin_name,
    schema = schema,
}

function _M.access(conf, ctx)
    local request_id = core.request.header(ctx, conf.header_name)
    if not request_id then
        request_id = ngx.var.request_id
        core.request.set_header(ctx, conf.header_name, request_id)
    end
end

return _M
EOF

# 2. åœ¨config.yamlä¸­å¯ç”¨æ’ä»¶
plugins:
  - request-id
  - jwt-auth
  - limit-count
  - prometheus

# 3. é‡æ–°åŠ è½½æ’ä»¶
curl "http://127.0.0.1:9180/apisix/admin/plugins/reload" \
  -H "X-API-KEY: edd1c9f034335f136f87ad84b625c8f1" \
  -X PUT
```

#### **äº”ã€Zuul / Spring Cloud Gateway**

##### **1. Zuul 1.x æ¶æ„**

```java
// Zuul 1.x åŸºäºServlet Filter
@EnableZuulProxy
@SpringBootApplication
public class GatewayApplication {
    public static void main(String[] args) {
        SpringApplication.run(GatewayApplication.class, args);
    }
}

// é…ç½®ç¤ºä¾‹
zuul:
  routes:
    user-service:
      path: /api/users/**
      serviceId: user-service
      strip-prefix: false
    order-service:
      path: /api/orders/**
      url: http://localhost:8082
  host:
    connect-timeout-millis: 2000
    socket-timeout-millis: 10000
  ribbon:
    eager-load:
      enabled: true
```

##### **2. Spring Cloud Gatewayï¼ˆç°ä»£æ›¿ä»£ï¼‰**

```yaml
# application.yml é…ç½®
spring:
  cloud:
    gateway:
      routes:
        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/api/users/**
          filters:
            - StripPrefix=1
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
                key-resolver: "#{@userKeyResolver}"
            - name: CircuitBreaker
              args:
                name: userService
                fallbackUri: forward:/fallback/user
            - name: JwtAuth
              args:
                secret: ${jwt.secret}
      discovery:
        locator:
          enabled: true
      metrics:
        enabled: true

# å…¨å±€è¿‡æ»¤å™¨é…ç½®
@Configuration
public class GatewayConfig {
    
    @Bean
    public RouteLocator customRouteLocator(RouteLocatorBuilder builder) {
        return builder.routes()
            .route("path_route", r -> r
                .path("/get")
                .filters(f -> f.addRequestHeader("Hello", "World"))
                .uri("http://httpbin.org"))
            .route("host_route", r -> r
                .host("*.example.com")
                .uri("http://httpbin.org"))
            .build();
    }
    
    @Bean
    public KeyResolver userKeyResolver() {
        return exchange -> Mono.just(
            exchange.getRequest().getQueryParams().getFirst("userId")
        );
    }
}
```

##### **3. è‡ªå®šä¹‰è¿‡æ»¤å™¨**

```java
// å…¨å±€è¿‡æ»¤å™¨
@Component
public class GlobalLoggingFilter implements GlobalFilter, Ordered {
    
    private static final Logger log = LoggerFactory.getLogger(GlobalLoggingFilter.class);
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        long startTime = System.currentTimeMillis();
        
        return chain.filter(exchange).then(Mono.fromRunnable(() -> {
            long duration = System.currentTimeMillis() - startTime;
            log.info("Request {} {} completed in {}ms",
                exchange.getRequest().getMethod(),
                exchange.getRequest().getURI(),
                duration);
        }));
    }
    
    @Override
    public int getOrder() {
        return Ordered.LOWEST_PRECEDENCE;
    }
}

// è‡ªå®šä¹‰ç½‘å…³è¿‡æ»¤å™¨
@Component
public class JwtAuthFilter implements GatewayFilterFactory<JwtAuthFilter.Config> {
    
    @Override
    public GatewayFilter apply(Config config) {
        return (exchange, chain) -> {
            ServerHttpRequest request = exchange.getRequest();
            String token = request.getHeaders().getFirst("Authorization");
            
            if (token == null || !token.startsWith("Bearer ")) {
                return Mono.error(new UnauthorizedException("Missing token"));
            }
            
            // éªŒè¯JWT
            try {
                Claims claims = Jwts.parser()
                    .setSigningKey(config.getSecret())
                    .parseClaimsJws(token.substring(7))
                    .getBody();
                    
                // æ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´
                ServerHttpRequest mutatedRequest = request.mutate()
                    .header("X-User-Id", claims.getSubject())
                    .build();
                    
                return chain.filter(exchange.mutate().request(mutatedRequest).build());
            } catch (Exception e) {
                return Mono.error(new UnauthorizedException("Invalid token"));
            }
        };
    }
    
    public static class Config {
        private String secret;
        // getters and setters
    }
}
```

#### **å…­ã€æ ¸å¿ƒèƒ½åŠ›å®ç°è¯¦è§£**

##### **1. è®¤è¯æˆæƒï¼ˆJWT + OAuth2ï¼‰**

```yaml
# Kong JWTé…ç½®
curl -X POST http://localhost:8001/consumers \
  -d username=app-user

curl -X POST http://localhost:8001/consumers/app-user/jwt \
  -d algorithm=HS256 \
  -d secret=your-256-bit-secret

# APISIX JWTé…ç½®
plugins:
  jwt-auth:
    _meta:
      priority: 1000
    secret: your-256-bit-secret
    algorithm: HS256

# Spring Cloud Gateway OAuth2
security:
  oauth2:
    resourceserver:
      jwt:
        issuer-uri: http://auth-server:9000
        jwk-set-uri: http://auth-server:9000/.well-known/jwks.json
```

##### **2. é™æµç†”æ–­**

```bash
# Kong é™æµé…ç½®ï¼ˆä»¤ç‰Œæ¡¶ç®—æ³•ï¼‰
curl -X POST http://localhost:8001/services/user-service/plugins \
  -d name=rate-limiting \
  -d config.second=10 \
  -d config.minute=100 \
  -d config.hour=1000 \
  -d config.policy=redis \
  -d config.redis_host=redis \
  -d config.redis_port=6379

# APISIX é™æµé…ç½®ï¼ˆæ¼æ¡¶ç®—æ³•ï¼‰
plugins:
  limit-req:
    rate: 100
    burst: 200
    key: remote_addr
    rejected_code: 503

# ç†”æ–­é…ç½®
plugins:
  circuit-breaker:
    enable: true
    timeout: 3
    max_consecutive_failures: 5
    fallback_response: '{"code":503,"message":"æœåŠ¡æš‚æ—¶ä¸å¯ç”¨"}'
```

##### **3. ç›‘æ§ä¸å¯è§‚æµ‹æ€§**

```yaml
# Prometheus ç›‘æ§é…ç½®
# Kong
curl -X POST http://localhost:8001/services/user-service/plugins \
  -d name=prometheus

# APISIX
plugins:
  prometheus:
    export_addr:
      ip: 0.0.0.0
      port: 9091

# æ—¥å¿—æ”¶é›†ï¼ˆELKï¼‰
# Kongæ—¥å¿—æ ¼å¼
log_format json_combined escape=json
  '{'
    '"timestamp":"$time_iso8601",'
    '"client":"$remote_addr",'
    '"method":"$request_method",'
    '"uri":"$request_uri",'
    '"status":$status,'
    '"upstream":"$upstream_addr",'
    '"response_time":$request_time,'
    '"request_length":$request_length,'
    '"user_agent":"$http_user_agent"'
  '}';

# åˆ†å¸ƒå¼è¿½è¸ª
plugins:
  skywalking:
    sample_ratio: 1
    service_name: APISIX
    instance_name: APISIX-Instance
    endpoint_addr: http://skywalking-oap:12800
```

##### **4. å®‰å…¨é˜²æŠ¤**

```bash
# IPé»‘ç™½åå•
curl -X POST http://localhost:8001/services/user-service/plugins \
  -d name=ip-restriction \
  -d config.whitelist=192.168.1.0/24,10.0.0.0/8 \
  -d config.blacklist=192.168.1.100

# WAFé˜²æŠ¤
curl -X POST http://localhost:8001/services/user-service/plugins \
  -d name=coraza-waf \
  -d config.rules='SecRuleEngine On\nSecRule ARGS "@rx malicious" "id:1,phase:2,deny,status:403"'

# API Keyè®¤è¯
curl -X POST http://localhost:8001/consumers/app-client/key-auth \
  -d key=your-api-key-here
```

#### **ä¸ƒã€é«˜å¯ç”¨éƒ¨ç½²æ¶æ„**

##### **1. ç”Ÿäº§çº§éƒ¨ç½²æ¶æ„**

```yaml
# Kuberneteséƒ¨ç½²ç¤ºä¾‹ï¼ˆAPISIXï¼‰
apiVersion: apps/v1
kind: Deployment
metadata:
  name: apisix
spec:
  replicas: 3
  selector:
    matchLabels:
      app: apisix
  template:
    metadata:
      labels:
        app: apisix
    spec:
      containers:
      - name: apisix
        image: apache/apisix:3.0
        ports:
        - containerPort: 9080
        - containerPort: 9091
        - containerPort: 9443
        env:
        - name: APISIX_DEPLOYMENT
          value: "kubernetes"
        - name: APISIX_ADMIN_KEY
          valueFrom:
            secretKeyRef:
              name: apisix-secret
              key: admin-key
        volumeMounts:
        - name: apisix-config
          mountPath: /usr/local/apisix/conf/config.yaml
          subPath: config.yaml
      volumes:
      - name: apisix-config
        configMap:
          name: apisix-config
---
apiVersion: v1
kind: Service
metadata:
  name: apisix
spec:
  selector:
    app: apisix
  ports:
  - name: http
    port: 80
    targetPort: 9080
  - name: https
    port: 443
    targetPort: 9443
  - name: admin
    port: 9180
    targetPort: 9180
  type: LoadBalancer
```

##### **2. å¤šæ´»ç½‘å…³æ¶æ„**

```bash
# å¤šåœ°åŸŸéƒ¨ç½²æ–¹æ¡ˆ
åœ°åŸŸA: ç½‘å…³é›†ç¾¤ â†’ æœ¬åœ°æœåŠ¡ + å¼‚åœ°æœåŠ¡ï¼ˆæ•…éšœè½¬ç§»ï¼‰
åœ°åŸŸB: ç½‘å…³é›†ç¾¤ â†’ æœ¬åœ°æœåŠ¡ + å¼‚åœ°æœåŠ¡ï¼ˆæ•…éšœè½¬ç§»ï¼‰

# DNSå…¨å±€è´Ÿè½½å‡è¡¡
client â†’ DNS (è¿”å›æœ€è¿‘ç½‘å…³IP) â†’ ç½‘å…³é›†ç¾¤ â†’ åç«¯æœåŠ¡

# é…ç½®åŒæ­¥ç­–ç•¥
ä¸»etcdé›†ç¾¤ï¼ˆåœ°åŸŸAï¼‰ â†” ä»etcdé›†ç¾¤ï¼ˆåœ°åŸŸBï¼‰
    â†“ åŒå‘åŒæ­¥              â†“ åŒå‘åŒæ­¥
ç½‘å…³é›†ç¾¤A               ç½‘å…³é›†ç¾¤B
```

#### **å…«ã€é€‰å‹å»ºè®®ä¸æœ€ä½³å®è·µ**

##### **1. é€‰å‹å†³ç­–çŸ©é˜µ**

```yaml
é€‰æ‹©Kongå½“:
  - éœ€è¦ä¼ä¸šçº§æ”¯æŒå’Œå•†ä¸šç‰ˆåŠŸèƒ½
  - å·²æœ‰PostgreSQL/CassandraåŸºç¡€è®¾æ–½
  - éœ€è¦æˆç†Ÿçš„æ’ä»¶ç”Ÿæ€
  - å¯¹Nginxç”Ÿæ€ç†Ÿæ‚‰

é€‰æ‹©APISIXå½“:
  - éœ€è¦åŠ¨æ€çƒ­åŠ è½½å’Œæ¯«ç§’çº§é…ç½®ç”Ÿæ•ˆ
  - è¿½æ±‚æè‡´æ€§èƒ½å’Œé«˜å¹¶å‘
  - ä½¿ç”¨etcdä½œä¸ºé…ç½®ä¸­å¿ƒ
  - éœ€è¦åŸç”ŸKubernetesæ”¯æŒ

é€‰æ‹©Spring Cloud Gatewayå½“:
  - æ•´ä¸ªæŠ€æœ¯æ ˆåŸºäºSpring Cloud
  - å›¢é˜Ÿç†Ÿæ‚‰Javaå’Œå“åº”å¼ç¼–ç¨‹
  - éœ€è¦æ·±åº¦é›†æˆSpringç”Ÿæ€ç³»ç»Ÿ
  - å¯¹æ€§èƒ½è¦æ±‚ä¸æ˜¯æç«¯è‹›åˆ»

é€‰æ‹©Zuul 1.xå½“:
  - é—ç•™ç³»ç»Ÿç»´æŠ¤ï¼ˆä¸æ¨èæ–°é¡¹ç›®ï¼‰
  - ç®€å•ä»£ç†éœ€æ±‚
  - ç†Ÿæ‚‰Servlet Filteræ¨¡å‹
```

##### **2. æ€§èƒ½ä¼˜åŒ–å»ºè®®**

```bash
# 1. è¿æ¥æ± ä¼˜åŒ–
upstreamè¿æ¥æ± å¤§å° = å¹¶å‘æ•° Ã— 2
è¶…æ—¶è®¾ç½®ï¼šè¿æ¥<1sï¼Œè¯»<5sï¼Œå†™<5s

# 2. ç¼“å­˜ç­–ç•¥
- é™æ€èµ„æºï¼šCDN + æµè§ˆå™¨ç¼“å­˜
- APIå“åº”ï¼šRedisç¼“å­˜çƒ­ç‚¹æ•°æ®
- é…ç½®ä¿¡æ¯ï¼šæœ¬åœ°ç¼“å­˜å‡å°‘etcdè®¿é—®

# 3. ç›‘æ§å‘Šè­¦
ç›‘æ§æŒ‡æ ‡:
  - QPS/RPS
  - å“åº”æ—¶é—´(p50/p95/p99)
  - é”™è¯¯ç‡(4xx/5xx)
  - è¿æ¥æ•°/æ´»è·ƒè¿æ¥
  - å¸¦å®½ä½¿ç”¨
  
å‘Šè­¦é˜ˆå€¼:
  - é”™è¯¯ç‡ > 1% (5åˆ†é’Ÿ)
  - å»¶è¿Ÿ > 100ms (p95)
  - CPU > 80%
  - å†…å­˜ > 85%
```

##### **3. å®‰å…¨æœ€ä½³å®è·µ**

```yaml
# å®‰å…¨é…ç½®æ¸…å•
1. è®¤è¯æˆæƒ:
   - å¼ºåˆ¶HTTPS
   - JWTä»¤ç‰ŒçŸ­æœŸæœ‰æ•ˆ + åˆ·æ–°æœºåˆ¶
   - API Keyè½®æ¢ç­–ç•¥

2. è®¿é—®æ§åˆ¶:
   - IPç™½åå•ï¼ˆç®¡ç†æ¥å£ï¼‰
   - é€Ÿç‡é™åˆ¶ï¼ˆé˜²æš´åŠ›ç ´è§£ï¼‰
   - CORSä¸¥æ ¼é…ç½®

3. æ•°æ®å®‰å…¨:
   - æ•æ„Ÿä¿¡æ¯è„±æ•æ—¥å¿—
   - è¯·æ±‚å“åº”åŠ å¯†
   - SQLæ³¨å…¥/XSSé˜²æŠ¤

4. å®¡è®¡ç›‘æ§:
   - å®Œæ•´è®¿é—®æ—¥å¿—
   - å¼‚å¸¸è¡Œä¸ºæ£€æµ‹
   - å®šæœŸå®‰å…¨æ‰«æ
```

#### **ä¹ã€æœªæ¥å‘å±•è¶‹åŠ¿**

##### **1. æŠ€æœ¯è¶‹åŠ¿**

```yaml
è¶‹åŠ¿æ–¹å‘:
  1. äº‘åŸç”Ÿæ·±åº¦èåˆ
     - Service Meshé›†æˆ (Istio + API Gateway)
     - Serverlessç½‘å…³
     - eBPFæŠ€æœ¯åº”ç”¨

  2. æ™ºèƒ½åŒ–è¿ç»´
     - AIOpså¼‚å¸¸æ£€æµ‹
     - è‡ªé€‚åº”é™æµ
     - æ™ºèƒ½è·¯ç”±

  3. åè®®æ‰©å±•
     - åŸç”ŸgRPC/HTTP3æ”¯æŒ
     - GraphQLç½‘å…³
     - WebSocketä¼˜åŒ–

  4. å®‰å…¨å¢å¼º
     - é›¶ä¿¡ä»»ç½‘ç»œé›†æˆ
     - APIå®‰å…¨æ™ºèƒ½é˜²æŠ¤
     - é‡å­å®‰å…¨åŠ å¯†
```

##### **2. å­¦ä¹ è·¯å¾„å»ºè®®**

```markdown
å…¥é—¨é˜¶æ®µ:
  - ç†è§£ç½‘å…³æ ¸å¿ƒæ¦‚å¿µ
  - æŒæ¡HTTP/HTTPSåè®®
  - å­¦ä¹ RESTful APIè®¾è®¡

è¿›é˜¶é˜¶æ®µ:
  - æ·±å…¥ä¸€ä¸ªç½‘å…³å®ç°
  - æŒæ¡æ’ä»¶å¼€å‘
  - å­¦ä¹ æ€§èƒ½è°ƒä¼˜

ä¸“å®¶é˜¶æ®µ:
  - æºç é˜…è¯»ä¸åˆ†æ
  - é«˜å¯ç”¨æ¶æ„è®¾è®¡
  - å®‰å…¨æ”»é˜²ç ”ç©¶

å®è·µé¡¹ç›®:
  1. æ­å»ºä¸ªäººåšå®¢APIç½‘å…³
  2. å®ç°å¾®æœåŠ¡ç½‘å…³ç»Ÿä¸€å…¥å£
  3. è®¾è®¡å¤šç§Ÿæˆ·SaaSç½‘å…³
  4. æ„å»ºè¾¹ç¼˜è®¡ç®—ç½‘å…³
```

#### **æ€»ç»“**

**æœåŠ¡ç½‘å…³æ˜¯ç°ä»£å¾®æœåŠ¡æ¶æ„çš„"äº¤é€šæ¢çº½"**ï¼Œæ ¸å¿ƒä»·å€¼åœ¨äºï¼š

1. **ç»Ÿä¸€å…¥å£**ï¼šæ”¶æ•›APIï¼Œç®€åŒ–å®¢æˆ·ç«¯è°ƒç”¨
2. **å®‰å…¨é˜²çº¿**ï¼šé›†ä¸­è®¤è¯æˆæƒï¼Œç»Ÿä¸€å®‰å…¨ç­–ç•¥
3. **æµé‡æ²»ç†**ï¼šç²¾ç»†åŒ–çš„é™æµç†”æ–­å’Œè´Ÿè½½å‡è¡¡
4. **å¯è§‚æµ‹æ€§**ï¼šå…¨é“¾è·¯ç›‘æ§å’Œæ—¥å¿—æ”¶é›†
5. **è¿ç»´ä¾¿åˆ©**ï¼šç»Ÿä¸€é…ç½®ç®¡ç†å’Œç‰ˆæœ¬æ§åˆ¶

**æŠ€æœ¯é€‰å‹å»ºè®®**ï¼š

- æ–°é¡¹ç›®/è¿½æ±‚æè‡´æ€§èƒ½ â†’ **APISIX**
- ä¼ä¸šçº§/æˆç†Ÿç”Ÿæ€ â†’ **Kong**
- Spring CloudæŠ€æœ¯æ ˆ â†’ **Spring Cloud Gateway**
- é—ç•™ç³»ç»Ÿ/ç®€å•éœ€æ±‚ â†’ **Zuul**ï¼ˆé€æ­¥è¿ç§»ï¼‰

**æˆåŠŸå…³é”®**ï¼š

- æ˜ç¡®ç½‘å…³è¾¹ç•Œï¼ˆä¸è¦æˆä¸º"ä¸Šå¸æœåŠ¡"ï¼‰
- æ¸è¿›å¼å¼•å…¥ï¼Œé¿å…"å¤§çˆ†ç‚¸"å¼æ”¹é€ 
- å»ºç«‹å®Œå–„çš„ç›‘æ§å‘Šè­¦ä½“ç³»
- å®šæœŸæ¼”ç»ƒæ•…éšœæ¢å¤æµç¨‹



## **è´Ÿè½½å‡è¡¡**

> å¸¸è§ç­–ç•¥ è½®è¯¢/éšæœº/æƒé‡ï¼Œä¸€è‡´æ€§Hashå®ç°åŸç†å’ŒèŠ‚ç‚¹æ‰©ç¼©å®¹Keyè¿ç§»ç­–ç•¥

è´Ÿè½½å‡è¡¡ç­–ç•¥å…¨æ™¯å›¾ï¼š



<img src="å·¥ç¨‹ç´ å…»ç¯‡ï¼ˆä¸­çº§ï¼‰.assets/image-20260204171952490.png" alt="image-20260204171952490" style="zoom:50%;" />

**ç®—æ³•å¯¹æ¯”è¡¨**ï¼š

| ç®—æ³•                            | åŸç†               | é€‚ç”¨åœºæ™¯        | ä¼˜ç‚¹               | ç¼ºç‚¹                     |
| ------------------------------- | ------------------ | --------------- | ------------------ | ------------------------ |
| **è½®è¯¢(Round Robin)**           | ä¾æ¬¡åˆ†å‘è¯·æ±‚       | æ— çŠ¶æ€æœåŠ¡      | ç®€å•ï¼Œç»å¯¹å‡è¡¡     | ä¸è€ƒè™‘æœåŠ¡å™¨çŠ¶æ€         |
| **åŠ æƒè½®è¯¢(Weighted RR)**       | æŒ‰æƒé‡è½®è¯¢         | æœåŠ¡å™¨æ€§èƒ½ä¸å‡  | è€ƒè™‘æœåŠ¡å™¨èƒ½åŠ›     | é™æ€æƒé‡                 |
| **æœ€å°è¿æ¥(Least Connections)** | é€‰æ‹©è¿æ¥æœ€å°‘æœåŠ¡å™¨ | é•¿è¿æ¥æœåŠ¡      | åŠ¨æ€å‡è¡¡           | éœ€è¦ç›‘æ§è¿æ¥æ•°           |
| **IPå“ˆå¸Œ(IP Hash)**             | æŒ‰å®¢æˆ·ç«¯IPå“ˆå¸Œ     | ä¼šè¯ä¿æŒ        | ç®€å•ä¼šè¯ä¿æŒ       | IPå˜åŒ–æ—¶å¤±æ•ˆ             |
| **ä¸€è‡´æ€§å“ˆå¸Œ(Consistent Hash)** | å“ˆå¸Œç¯+è™šæ‹ŸèŠ‚ç‚¹    | åˆ†å¸ƒå¼ç¼“å­˜/å­˜å‚¨ | æ‰©å±•æ€§å¥½ï¼Œä¼šè¯ä¿æŒ | å®ç°å¤æ‚ï¼Œå¯èƒ½æœ‰æ•°æ®å€¾æ–œ |
| **æœ€å°‘å“åº”æ—¶é—´(Least Time)**    | é€‰æ‹©å“åº”æœ€å¿«æœåŠ¡å™¨ | æ€§èƒ½æ•æ„ŸæœåŠ¡    | æ€§èƒ½æœ€ä¼˜           | ç›‘æ§å¼€é”€å¤§               |





### ä¸€ã€åŸºç¡€ç­–ç•¥è¯¦ç»†å®ç°

#### **1. è½®è¯¢ç­–ç•¥ (Round Robin)**

```java
public class RoundRobinLoadBalancer {
    private List<String> servers;
    private AtomicInteger index = new AtomicInteger(0);
    
    // ç®€å•è½®è¯¢å®ç°
    public String selectServer() {
        if (servers.isEmpty()) {
            return null;
        }
        // çº¿ç¨‹å®‰å…¨çš„å¾ªç¯é€‰æ‹©
        int i = index.getAndIncrement() % servers.size();
        if (i < 0) {
            index.set(0);
            i = 0;
        }
        return servers.get(i);
    }
    
    // å¹³æ»‘åŠ æƒè½®è¯¢ï¼ˆNginxå®ç°ï¼‰
    static class WeightedRoundRobin {
        static class Server {
            String address;
            int weight;          // é…ç½®æƒé‡
            int currentWeight;   // å½“å‰æƒé‡ï¼ˆåŠ¨æ€å˜åŒ–ï¼‰
        }
        
        public String selectServer(List<Server> servers) {
            Server best = null;
            int totalWeight = 0;
            
            for (Server server : servers) {
                // 1. å¢åŠ æƒé‡
                server.currentWeight += server.weight;
                totalWeight += server.weight;
                
                // 2. é€‰æ‹©å½“å‰æƒé‡æœ€å¤§çš„
                if (best == null || server.currentWeight > best.currentWeight) {
                    best = server;
                }
            }
            
            // 3. å‡å°‘é€‰ä¸­èŠ‚ç‚¹çš„æƒé‡
            if (best != null) {
                best.currentWeight -= totalWeight;
                return best.address;
            }
            return null;
        }
    }
}
```

#### **2. åŠ æƒç­–ç•¥å®ç°å¯¹æ¯”**

| ç­–ç•¥         | å®ç°åŸç†             | ä¼˜ç‚¹                   | ç¼ºç‚¹                             |
| ------------ | -------------------- | ---------------------- | -------------------------------- |
| **åŠ æƒè½®è¯¢** | æŒ‰æƒé‡æ¯”ä¾‹å¾ªç¯åˆ†é…   | åˆ†é…ç²¾ç¡®ï¼Œæ€§èƒ½å‡è¡¡     | è¿ç»­è¯·æ±‚å¯èƒ½æ‰“åˆ°åŒä¸€é«˜æ€§èƒ½æœåŠ¡å™¨ |
| **åŠ æƒéšæœº** | æŒ‰æƒé‡æ¦‚ç‡éšæœºåˆ†é…   | å®ç°ç®€å•ï¼Œæœ‰ä¸€å®šéšæœºæ€§ | çŸ­æ—¶é—´å¯èƒ½è´Ÿè½½ä¸å‡è¡¡             |
| **åŠ¨æ€æƒé‡** | æ ¹æ®å®æ—¶è´Ÿè½½è°ƒæ•´æƒé‡ | è‡ªé€‚åº”æ€§å¼º             | å®ç°å¤æ‚ï¼Œéœ€è¦ç›‘æ§ç³»ç»Ÿ           |

### äºŒã€ä¸€è‡´æ€§Hashæ·±åº¦è§£æ

#### **1. ä¸€è‡´æ€§Hashæ ¸å¿ƒåŸç†**

> ä¸€è‡´æ€§Hashé€šè¿‡å“ˆå¸Œç¯å’Œè™šæ‹ŸèŠ‚ç‚¹ï¼Œåœ¨èŠ‚ç‚¹åŠ¨æ€å¢å‡æ—¶ï¼Œå®ç°æ•°æ®è¿ç§»æœ€å°åŒ–çš„è´Ÿè½½å‡è¡¡ç®—æ³•ã€‚
>
> hashç¯ã€è™šæ‹ŸèŠ‚ç‚¹

```java
public class ConsistentHash {
    // å“ˆå¸Œç¯ï¼šä½¿ç”¨TreeMapå®ç°æœ‰åºæ˜ å°„
    private final SortedMap<Integer, String> hashRing = new TreeMap<>();
    private final int virtualNodeCount; // æ¯ä¸ªç‰©ç†èŠ‚ç‚¹çš„è™šæ‹ŸèŠ‚ç‚¹æ•°
    
    public ConsistentHash(List<String> servers, int virtualNodeCount) {
        this.virtualNodeCount = virtualNodeCount;
        for (String server : servers) {
            addServer(server);
        }
    }
    
    // æ·»åŠ ç‰©ç†èŠ‚ç‚¹
    public void addServer(String server) {
        for (int i = 0; i < virtualNodeCount; i++) {
            // ä¸ºæ¯ä¸ªè™šæ‹ŸèŠ‚ç‚¹è®¡ç®—å“ˆå¸Œå€¼
            String virtualNode = server + "#VN" + i;
            int hash = hash(virtualNode);
            hashRing.put(hash, server);
        }
    }
    
    // æ ¹æ®keyè·¯ç”±åˆ°æœåŠ¡å™¨
    public String getServer(String key) {
        if (hashRing.isEmpty()) {
            return null;
        }
        
        int keyHash = hash(key);
        
        // æ‰¾åˆ°ç¬¬ä¸€ä¸ªå“ˆå¸Œå€¼ >= keyHashçš„èŠ‚ç‚¹
        SortedMap<Integer, String> tailMap = hashRing.tailMap(keyHash);
        
        // å¦‚æœtailMapä¸ºç©ºï¼Œè¯´æ˜keyHashæ¯”æ‰€æœ‰èŠ‚ç‚¹éƒ½å¤§ï¼Œè¿”å›ç¯é¦–èŠ‚ç‚¹
        Integer targetHash = tailMap.isEmpty() ? 
            hashRing.firstKey() : tailMap.firstKey();
            
        return hashRing.get(targetHash);
    }
    
    // MurmurHash3å®ç°ï¼ˆé«˜æ€§èƒ½ã€ä½ç¢°æ’ï¼‰
    private int hash(String key) {
        // ç®€åŒ–å®ç°ï¼Œå®é™…ä½¿ç”¨MurmurHash3
        int h = key.hashCode();
        h ^= h >>> 16;
        h *= 0x85ebca6b;
        h ^= h >>> 13;
        h *= 0xc2b2ae35;
        h ^= h >>> 16;
        return h & 0x7fffffff; // ä¿è¯éè´Ÿ
    }
}
```

##### **æ ¸å¿ƒä¸‰è¦ç´ **

**1. å“ˆå¸Œç¯ï¼ˆHash Ringï¼‰**

```markdown
å°†æ•´ä¸ªå“ˆå¸Œç©ºé—´ï¼ˆå¦‚ 0 ~ 2^32-1ï¼‰é¦–å°¾ç›¸è¿æˆç¯
æ¯ä¸ªèŠ‚ç‚¹å’Œæ•°æ®éƒ½é€šè¿‡å“ˆå¸Œå‡½æ•°æ˜ å°„åˆ°ç¯ä¸Šçš„ä½ç½®

          [èŠ‚ç‚¹A]
         /       \
  [æ•°æ®X]         [èŠ‚ç‚¹B]
        \       /
         [æ•°æ®Y]
```

**2. æ•°æ®å®šä½è§„åˆ™**

```python
# ä¼ªä»£ç ï¼šæ•°æ®å­˜å‚¨åœ¨é¡ºæ—¶é’ˆæ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸Š
def find_node(data_key, hash_ring):
    hash_value = hash(data_key)  # è®¡ç®—æ•°æ®å“ˆå¸Œå€¼
    for node in sorted_nodes:    # èŠ‚ç‚¹æŒ‰å“ˆå¸Œå€¼æ’åº
        if node.hash >= hash_value:
            return node          # æ‰¾åˆ°ç¬¬ä¸€ä¸ª>=æ•°æ®å“ˆå¸Œçš„èŠ‚ç‚¹
    return sorted_nodes[0]       # å›ç»•åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
```

**3. è™šæ‹ŸèŠ‚ç‚¹ï¼ˆVirtual Nodesï¼‰**

```markdown
ç‰©ç†èŠ‚ç‚¹ â†’ å¤šä¸ªè™šæ‹ŸèŠ‚ç‚¹ â†’ åˆ†æ•£åœ¨å“ˆå¸Œç¯ä¸Š
         â†“
   è§£å†³è´Ÿè½½ä¸å‡é—®é¢˜
   
çœŸå®åœºæ™¯ï¼š
èŠ‚ç‚¹A â†’ [A#1, A#2, A#3, ..., A#100]  # 100ä¸ªè™šæ‹Ÿç‚¹
èŠ‚ç‚¹B â†’ [B#1, B#2, B#3, ..., B#100]
```



##### æ ¸å¿ƒä¼˜åŠ¿

> è§£å†³ä¼ ç»Ÿè´Ÿè½½å‡è¡¡çš„é—®é¢˜ï¼ˆæ™®é€šå“ˆå¸Œçš„æ‰©å®¹é—®é¢˜ï¼‰

| å¯¹æ¯”ç»´åº¦       | **ä¼ ç»Ÿå“ˆå¸Œå–æ¨¡** | **ä¸€è‡´æ€§å“ˆå¸Œ**      |
| -------------- | ---------------- | ------------------- |
| **æ‰©å®¹å½±å“**   | æ‰€æœ‰æ•°æ®é‡æ–°åˆ†å¸ƒ | åªå½±å“é‚»è¿‘æ•°æ®      |
| **ç¼©å®¹å½±å“**   | æ‰€æœ‰æ•°æ®é‡æ–°åˆ†å¸ƒ | åªå½±å“é‚»è¿‘æ•°æ®      |
| **æ•°æ®å±€éƒ¨æ€§** | æ— ä¿è¯           | ç›¸åŒkeyæ€»åˆ°åŒä¸€èŠ‚ç‚¹ |
| **è´Ÿè½½å‡è¡¡åº¦** | å®Œå…¨å‡åŒ€         | å¯é€šè¿‡è™šæ‹ŸèŠ‚ç‚¹ä¼˜åŒ–  |
| **æ•…éšœè½¬ç§»**   | éœ€è¦å…¨é‡è¿ç§»     | è‡ªåŠ¨è½¬ç§»åˆ°åç»§èŠ‚ç‚¹  |

**ä¼ ç»Ÿå“ˆå¸Œå–æ¨¡çš„é—®é¢˜**

```java
// ä¼ ç»Ÿæ–¹å¼ï¼šhash(key) % Nï¼ˆNä¸ºèŠ‚ç‚¹æ•°ï¼‰
// å½“èŠ‚ç‚¹ä»3ä¸ªå˜ä¸º4ä¸ªæ—¶ï¼š
hash(key) % 3 â†’ hash(key) % 4
// ç»“æœï¼š3/4çš„æ•°æ®éœ€è¦é‡æ–°åˆ†é…ï¼
```

**ä¸€è‡´æ€§Hashçš„è§£å†³æ–¹æ¡ˆ**

```markdown
å¢åŠ èŠ‚ç‚¹Dæ—¶ï¼š
- ä»…å½±å“Då’Œé¡ºæ—¶é’ˆå‰ä¸€ä¸ªèŠ‚ç‚¹Cä¹‹é—´çš„æ•°æ®
- å…¶ä»–æ•°æ®ä¿æŒä¸åŠ¨
- æ•°æ®è¿ç§»é‡ â‰ˆ 1/Nï¼ˆNä¸ºèŠ‚ç‚¹æ€»æ•°ï¼‰

ç¯: ... â†’ [èŠ‚ç‚¹C] â†’ (è¿ç§»æ•°æ®æ®µ) â†’ [æ–°èŠ‚ç‚¹D] â†’ [èŠ‚ç‚¹A] â†’ ...
                 ä»…è¿™æ®µæ•°æ®è¿ç§»
```



##### å…³é”®æœºåˆ¶

**1. æ•°æ®è¿ç§»æœ€å°åŒ–**

```markdown
èŠ‚ç‚¹å˜åŒ–å‰ï¼š
[A] ---(æ•°æ®æ®µ1)--- [B] ---(æ•°æ®æ®µ2)--- [C] ---(æ•°æ®æ®µ3)--- [A]

å¢åŠ èŠ‚ç‚¹Dåœ¨Bå’ŒCä¹‹é—´ï¼š
[A] ---(æ•°æ®æ®µ1)--- [B] ---(éƒ¨åˆ†æ•°æ®æ®µ2)--- [D] ---(å‰©ä½™æ•°æ®æ®µ2)--- [C] ---(æ•°æ®æ®µ3)--- [A]
                                  â†‘
                          ä»…è¿™éƒ¨åˆ†æ•°æ®ä»Bè¿ç§»åˆ°D
```

**2. è™šæ‹ŸèŠ‚ç‚¹è§£å†³è´Ÿè½½å€¾æ–œ**

```markdown
æ²¡æœ‰è™šæ‹ŸèŠ‚ç‚¹ï¼š
èŠ‚ç‚¹Aå¯èƒ½è´Ÿè´£ç¯ä¸Šä¸€å¤§æ®µï¼ŒèŠ‚ç‚¹Båªè´Ÿè´£ä¸€å°æ®µ â†’ è´Ÿè½½ä¸å‡

æœ‰è™šæ‹ŸèŠ‚ç‚¹ï¼ˆæ¯ä¸ªç‰©ç†èŠ‚ç‚¹100ä¸ªè™šæ‹Ÿç‚¹ï¼‰ï¼š
è™šæ‹ŸèŠ‚ç‚¹å‡åŒ€åˆ†å¸ƒåœ¨ç¯ä¸Š â†’ æ¯ä¸ªç‰©ç†èŠ‚ç‚¹è´Ÿè½½å‡è¡¡
```



#### **2. ä¸€è‡´æ€§Hashç¯å¯è§†åŒ–**

```markdown
Hashç¯ç¤ºæ„å›¾ï¼ˆ0 ~ 2^32-1ï¼‰ï¼š

        [Server Aè™šæ‹ŸèŠ‚ç‚¹]
      /                   \
     /                     \
    /      Hashç©ºé—´         \
   |     (0 ~ 2^32-1)      |
    \                     /
     \                   /
        [Server Cè™šæ‹ŸèŠ‚ç‚¹]
           /
          /
     [Server Bè™šæ‹ŸèŠ‚ç‚¹]
     
æ•°æ®è·¯ç”±è§„åˆ™ï¼š
1. è®¡ç®—keyçš„hashå€¼
2. åœ¨ç¯ä¸Šé¡ºæ—¶é’ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
3. è¯¥èŠ‚ç‚¹å³ä¸ºç›®æ ‡æœåŠ¡å™¨

è™šæ‹ŸèŠ‚ç‚¹ä½œç”¨ï¼š
â€¢ å¹³è¡¡æ•°æ®åˆ†å¸ƒ
â€¢ é˜²æ­¢ç‰©ç†èŠ‚ç‚¹å°‘æ—¶çš„æ•°æ®å€¾æ–œ
â€¢ æ”¯æŒæƒé‡åˆ†é…ï¼ˆé€šè¿‡è°ƒæ•´è™šæ‹ŸèŠ‚ç‚¹æ•°ï¼‰
```

#### **3. æ•°æ®åˆ†å¸ƒåˆ†æå·¥å…·**

```java
public class HashDistributionAnalyzer {
    
    public void analyzeDistribution(ConsistentHash hash, int sampleSize) {
        Map<String, Integer> distribution = new HashMap<>();
        
        // é‡‡æ ·åˆ†æ
        for (int i = 0; i < sampleSize; i++) {
            String key = "key-" + i;
            String server = hash.getServer(key);
            distribution.put(server, 
                distribution.getOrDefault(server, 0) + 1);
        }
        
        // è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡
        System.out.println("=== æ•°æ®åˆ†å¸ƒåˆ†æ ===");
        System.out.printf("æ ·æœ¬æ•°é‡: %,d%n", sampleSize);
        System.out.println("èŠ‚ç‚¹åˆ†å¸ƒ:");
        
        double ideal = sampleSize / (double) distribution.size();
        double variance = 0;
        
        for (Map.Entry<String, Integer> entry : distribution.entrySet()) {
            int count = entry.getValue();
            double ratio = (count * 100.0) / sampleSize;
            double deviation = Math.abs(count - ideal);
            variance += deviation * deviation;
            
            System.out.printf("  %s: %,d (%.2f%%) åç¦»: %.2f%n",
                entry.getKey(), count, ratio, deviation);
        }
        
        double stdDev = Math.sqrt(variance / distribution.size());
        double imbalance = (stdDev / ideal) * 100;
        
        System.out.printf("æ ‡å‡†å·®: %.2f%n", stdDev);
        System.out.printf("ä¸å‡è¡¡åº¦: %.2f%%%n", imbalance);
        System.out.printf("è™šæ‹ŸèŠ‚ç‚¹æ•°: %d%n", hash.getVirtualNodeCount());
        
        // è¯„ä¼°æ ‡å‡†
        if (imbalance < 10) {
            System.out.println("âœ… åˆ†å¸ƒå‡è¡¡æ€§ä¼˜ç§€");
        } else if (imbalance < 20) {
            System.out.println("âš ï¸  åˆ†å¸ƒåŸºæœ¬å‡è¡¡");
        } else {
            System.out.println("âŒ å­˜åœ¨æ˜æ˜¾æ•°æ®å€¾æ–œ");
        }
    }
}
```

### ä¸‰ã€èŠ‚ç‚¹æ‰©ç¼©å®¹ä¸Keyè¿ç§»ç­–ç•¥

#### **1. èŠ‚ç‚¹æ‰©å®¹å½±å“åˆ†æ**

```java
public class NodeScalingStrategy {
    
    // åˆ†ææ‰©å®¹æ—¶çš„æ•°æ®è¿ç§»
    public MigrationPlan analyzeAddNode(String newNode, 
                                       ConsistentHash oldHash,
                                       int totalKeys) {
        MigrationPlan plan = new MigrationPlan();
        
        // æ¨¡æ‹ŸåŸæœ‰åˆ†å¸ƒ
        Map<String, List<String>> oldMapping = new HashMap<>();
        for (int i = 0; i < totalKeys; i++) {
            String key = "key-" + i;
            String server = oldHash.getServer(key);
            oldMapping.computeIfAbsent(server, k -> new ArrayList<>())
                     .add(key);
        }
        
        // åˆ›å»ºæ–°Hashç¯ï¼ˆåŒ…å«æ–°èŠ‚ç‚¹ï¼‰
        ConsistentHash newHash = oldHash.clone();
        newHash.addServer(newNode);
        
        // åˆ†æè¿ç§»éœ€æ±‚
        for (int i = 0; i < totalKeys; i++) {
            String key = "key-" + i;
            String oldServer = oldHash.getServer(key);
            String newServer = newHash.getServer(key);
            
            if (!oldServer.equals(newServer)) {
                // éœ€è¦è¿ç§»
                Migration migration = new Migration();
                migration.key = key;
                migration.fromNode = oldServer;
                migration.toNode = newServer;
                plan.migrations.add(migration);
                
                // ç»Ÿè®¡è¿ç§»é‡
                plan.migrationStats.merge(oldServer + "->" + newServer, 
                    1, Integer::sum);
            }
        }
        
        // è®¡ç®—è¿ç§»ç‡
        double migrationRate = (plan.migrations.size() * 100.0) / totalKeys;
        plan.migrationRate = migrationRate;
        
        System.out.printf("æ‰©å®¹è¿ç§»åˆ†æ:%n");
        System.out.printf("  æ–°å¢èŠ‚ç‚¹: %s%n", newNode);
        System.out.printf("  æ€»Keyæ•°: %,d%n", totalKeys);
        System.out.printf("  è¿ç§»Keyæ•°: %,d%n", plan.migrations.size());
        System.out.printf("  è¿ç§»ç‡: %.2f%%%n", migrationRate);
        System.out.printf("  ç†è®ºæœ€å°è¿ç§»ç‡: %.2f%%%n", 
            100.0 / (oldHash.getServerCount() + 1));
        
        return plan;
    }
    
    static class MigrationPlan {
        List<Migration> migrations = new ArrayList<>();
        Map<String, Integer> migrationStats = new HashMap<>();
        double migrationRate;
        
        // ç”Ÿæˆè¿ç§»æ‰¹æ¬¡ï¼ˆç”¨äºåˆ†æ‰¹æ‰§è¡Œï¼‰
        public List<List<Migration>> createBatches(int batchSize) {
            List<List<Migration>> batches = new ArrayList<>();
            List<Migration> currentBatch = new ArrayList<>();
            
            for (Migration migration : migrations) {
                currentBatch.add(migration);
                if (currentBatch.size() >= batchSize) {
                    batches.add(new ArrayList<>(currentBatch));
                    currentBatch.clear();
                }
            }
            
            if (!currentBatch.isEmpty()) {
                batches.add(currentBatch);
            }
            
            System.out.printf("è¿ç§»åˆ† %d ä¸ªæ‰¹æ¬¡æ‰§è¡Œï¼Œæ¯æ‰¹æœ€å¤š %d ä¸ªKey%n",
                batches.size(), batchSize);
            return batches;
        }
    }
}
```

#### **2. ä¼˜é›…æ‰©ç¼©å®¹å®æ–½æ–¹æ¡ˆ**

```java
public class GracefulScalingOrchestrator {
    
    // å››é˜¶æ®µæ‰©å®¹æ³•
    public void scaleOut(String newNode, ConsistentHash hash) {
        System.out.println("ğŸš€ å¼€å§‹ä¼˜é›…æ‰©å®¹: " + newNode);
        
        // é˜¶æ®µ1: èŠ‚ç‚¹é¢„çƒ­
        phase1_preheat(newNode, hash);
        
        // é˜¶æ®µ2: æ•°æ®é¢„è¿ç§»
        phase2_preMigration(newNode, hash);
        
        // é˜¶æ®µ3: æµé‡åˆ‡æ¢
        phase3_trafficSwitch(newNode, hash);
        
        // é˜¶æ®µ4: æ¸…ç†ä¸ç›‘æ§
        phase4_cleanupAndMonitor(newNode, hash);
    }
    
    private void phase1_preheat(String newNode, ConsistentHash hash) {
        System.out.println("ğŸ”§ é˜¶æ®µ1: èŠ‚ç‚¹é¢„çƒ­");
        
        // 1. å°†èŠ‚ç‚¹åŠ å…¥Hashç¯ä½†ä¸åˆ†é…æµé‡
        hash.addServerSilent(newNode);
        
        // 2. é¢„çƒ­è¿æ¥æ± 
        ConnectionPool pool = new ConnectionPool(newNode);
        pool.warmUp();
        
        // 3. é¢„åŠ è½½çƒ­ç‚¹æ•°æ®
        preloadHotData(newNode);
        
        // 4. å¥åº·æ£€æŸ¥
        if (!healthCheck(newNode)) {
            throw new RuntimeException("æ–°èŠ‚ç‚¹å¥åº·æ£€æŸ¥å¤±è´¥");
        }
        
        System.out.println("âœ… èŠ‚ç‚¹é¢„çƒ­å®Œæˆ");
    }
    
    private void phase2_preMigration(String newNode, ConsistentHash hash) {
        System.out.println("ğŸ”„ é˜¶æ®µ2: æ•°æ®é¢„è¿ç§»");
        
        // è¯†åˆ«éœ€è¦è¿ç§»çš„Key
        List<String> keysToMigrate = identifyKeysToMigrate(newNode, hash);
        
        // åˆ†æ‰¹è¿ç§»ï¼ˆé¿å…å½±å“çº¿ä¸Šæ€§èƒ½ï¼‰
        int batchSize = 1000;
        for (int i = 0; i < keysToMigrate.size(); i += batchSize) {
            int end = Math.min(i + batchSize, keysToMigrate.size());
            List<String> batch = keysToMigrate.subList(i, end);
            
            System.out.printf("  è¿ç§»æ‰¹æ¬¡ %d: %,d ä¸ªKey%n", 
                i / batchSize + 1, batch.size());
            
            migrateBatch(batch, newNode);
            
            // æ‰¹æ¬¡é—´æš‚åœï¼Œè§‚å¯Ÿç³»ç»ŸçŠ¶æ€
            if (i + batchSize < keysToMigrate.size()) {
                sleep(5000); // 5ç§’é—´éš”
            }
        }
        
        System.out.println("âœ… æ•°æ®é¢„è¿ç§»å®Œæˆ");
    }
    
    private void phase3_trafficSwitch(String newNode, ConsistentHash hash) {
        System.out.println("ğŸš¦ é˜¶æ®µ3: æµé‡åˆ‡æ¢");
        
        // æ¸è¿›å¼æµé‡åˆ‡æ¢
        int[] percentages = {10, 30, 50, 80, 100};
        
        for (int percentage : percentages) {
            System.out.printf("  åˆ‡æ¢ %d%% æµé‡åˆ°æ–°èŠ‚ç‚¹%n", percentage);
            
            // æ›´æ–°è´Ÿè½½å‡è¡¡å™¨æƒé‡
            updateLoadBalancerWeight(newNode, percentage);
            
            // ç­‰å¾…ç¨³å®š
            sleep(30000); // 30ç§’
            
            // ç›‘æ§æŒ‡æ ‡
            if (!monitorDuringSwitch(newNode)) {
                System.err.println("âš ï¸  åˆ‡æ¢è¿‡ç¨‹ä¸­å‘ç°é—®é¢˜ï¼Œæš‚åœåˆ‡æ¢");
                pauseAndInvestigate(newNode);
            }
        }
        
        System.out.println("âœ… æµé‡åˆ‡æ¢å®Œæˆ");
    }
    
    private void phase4_cleanupAndMonitor(String newNode, ConsistentHash hash) {
        System.out.println("ğŸ“Š é˜¶æ®µ4: æ¸…ç†ä¸ç›‘æ§");
        
        // 1. éªŒè¯æ•°æ®ä¸€è‡´æ€§
        verifyDataConsistency(newNode);
        
        // 2. æ¸…ç†ä¸´æ—¶æ•°æ®
        cleanupTemporaryData(newNode);
        
        // 3. æ›´æ–°ç›‘æ§é…ç½®
        updateMonitoringConfig(newNode);
        
        // 4. æ›´æ–°æ–‡æ¡£å’Œé…ç½®ç®¡ç†
        updateConfigurationManagement(newNode);
        
        System.out.println("ğŸ‰ æ‰©å®¹å®Œæˆ! æ–°èŠ‚ç‚¹ " + newNode + " å·²ä¸Šçº¿");
    }
}
```

#### **3. æ•°æ®è¿ç§»ç­–ç•¥å¯¹æ¯”**

```java
public class DataMigrationStrategies {
    
    // ç­–ç•¥1: å…¨é‡è¿ç§»ï¼ˆç®€å•ç²—æš´ï¼‰
    public void fullMigration(String sourceNode, String targetNode) {
        System.out.println("ğŸ“¦ å…¨é‡è¿ç§»ç­–ç•¥");
        System.out.println("ä¼˜ç‚¹: å®ç°ç®€å•ï¼Œè¿ç§»å½»åº•");
        System.out.println("ç¼ºç‚¹: è¿ç§»æœŸé—´æœåŠ¡ä¸å¯ç”¨ï¼Œå½±å“å¤§");
        
        // å®æ–½æ­¥éª¤
        steps("1. æš‚åœæºèŠ‚ç‚¹å†™å…¥", "é«˜å½±å“");
        steps("2. å¤åˆ¶æ‰€æœ‰æ•°æ®åˆ°ç›®æ ‡èŠ‚ç‚¹", "è€—æ—¶");
        steps("3. éªŒè¯æ•°æ®ä¸€è‡´æ€§", "å¿…è¦");
        steps("4. åˆ‡æ¢DNS/è´Ÿè½½å‡è¡¡", "é£é™©ç‚¹");
        steps("5. æ¢å¤å†™å…¥", "æ¢å¤");
        steps("6. æ¸…ç†æºèŠ‚ç‚¹", "æ¸…ç†");
        
        System.out.println("é€‚ç”¨åœºæ™¯: å°å‹é›†ç¾¤ï¼Œç»´æŠ¤çª—å£é•¿");
    }
    
    // ç­–ç•¥2: åŒå†™è¿ç§»ï¼ˆå¹³æ»‘è¿‡æ¸¡ï¼‰
    public void dualWriteMigration(String sourceNode, String targetNode) {
        System.out.println("ğŸ”„ åŒå†™è¿ç§»ç­–ç•¥");
        System.out.println("ä¼˜ç‚¹: å¹³æ»‘è¿‡æ¸¡ï¼ŒæœåŠ¡ä¸ä¸­æ–­");
        System.out.println("ç¼ºç‚¹: å®ç°å¤æ‚ï¼Œéœ€è¦è§£å†³æ•°æ®å†²çª");
        
        // å®æ–½æ­¥éª¤
        steps("é˜¶æ®µ1: å¼€å¯åŒå†™", "æ–°æ—§åŒæ—¶å†™");
        steps("   â€¢ æ–°æ•°æ®åŒæ—¶å†™å…¥ä¸¤ä¸ªèŠ‚ç‚¹");
        steps("   â€¢ æ—§æ•°æ®é€æ­¥è¿ç§»", "åå°ä»»åŠ¡");
        
        steps("é˜¶æ®µ2: åŒæ­¥å†å²æ•°æ®", "å…¨é‡+å¢é‡");
        steps("   â€¢ å…¨é‡åŒæ­¥å·²æœ‰æ•°æ®");
        steps("   â€¢ å¢é‡åŒæ­¥å˜æ›´æ•°æ®", "ç›‘å¬binlog");
        
        steps("é˜¶æ®µ3: è¯»æµé‡åˆ‡æ¢", "æ¸è¿›å¼");
        steps("   â€¢ 10% â†’ 30% â†’ 50% â†’ 100%", "åˆ†é˜¶æ®µ");
        
        steps("é˜¶æ®µ4: åœæ­¢åŒå†™", "éªŒè¯å");
        steps("é˜¶æ®µ5: æ¸…ç†æ—§èŠ‚ç‚¹", "ç¡®è®¤æ— é—®é¢˜å");
        
        System.out.println("é€‚ç”¨åœºæ™¯: å¤§å‹ç”Ÿäº§ç³»ç»Ÿï¼Œè¦æ±‚é›¶åœæœº");
    }
    
    // ç­–ç•¥3: åˆ†ç‰‡è¿ç§»ï¼ˆæŒ‰KeyèŒƒå›´ï¼‰
    public void shardBasedMigration(String sourceNode, String targetNode) {
        System.out.println("ğŸ§© åˆ†ç‰‡è¿ç§»ç­–ç•¥");
        System.out.println("ä¼˜ç‚¹: å¯æ§æ€§å¼ºï¼Œå¯å¹¶è¡Œè¿ç§»");
        System.out.println("ç¼ºç‚¹: éœ€è¦ä¸šåŠ¡æ”¯æŒåˆ†ç‰‡é€»è¾‘");
        
        // å®æ–½æ­¥éª¤
        steps("1. æŒ‰KeyèŒƒå›´åˆ†ç‰‡", "ä¾‹å¦‚æŒ‰hashèŒƒå›´");
        steps("2. é€ä¸ªåˆ†ç‰‡è¿ç§»", "å¯å¹¶è¡Œ");
        steps("3. è¿ç§»å®ŒæˆéªŒè¯åˆ†ç‰‡", "ç¡®ä¿æ•°æ®å®Œæ•´");
        steps("4. æ›´æ–°è·¯ç”±è§„åˆ™", "æŒ‡å‘æ–°åˆ†ç‰‡");
        
        System.out.println("é€‚ç”¨åœºæ™¯: åˆ†ç‰‡æ•°æ®åº“ï¼Œå¤§æ•°æ®é‡è¿ç§»");
    }
    
    private void steps(String step, String note) {
        System.out.println("  " + step + (note != null ? " [" + note + "]" : ""));
    }
}
```

### ğŸ“ æ€»ç»“ä¸é€‰å‹å»ºè®®

**ç­–ç•¥é€‰å‹çŸ©é˜µ**

| åœºæ™¯             | æ¨èç­–ç•¥           | åŸå›                          | æ³¨æ„äº‹é¡¹                    |
| ---------------- | ------------------ | ---------------------------- | --------------------------- |
| **ç®€å•WebæœåŠ¡**  | è½®è¯¢/åŠ æƒè½®è¯¢      | å®ç°ç®€å•ï¼Œè¶³å¤Ÿå‡è¡¡           | ç¡®ä¿æœåŠ¡å™¨æ€§èƒ½ç›¸è¿‘          |
| **é•¿è¿æ¥æœåŠ¡**   | æœ€å°‘è¿æ¥           | é¿å…å•æœåŠ¡å™¨è¿‡è½½             | éœ€è¦ç»´æŠ¤è¿æ¥çŠ¶æ€            |
| **ä¼šè¯ä¿æŒéœ€æ±‚** | IP Hash/ä¸€è‡´æ€§Hash | ç¡®ä¿åŒä¸€ç”¨æˆ·è¯·æ±‚åˆ°åŒä¸€æœåŠ¡å™¨ | IP Hashåœ¨æœåŠ¡å™¨å˜åŒ–æ—¶å½±å“å¤§ |
| **åˆ†å¸ƒå¼ç¼“å­˜**   | ä¸€è‡´æ€§Hash         | èŠ‚ç‚¹å˜åŒ–æ—¶æ•°æ®è¿ç§»æœ€å°‘       | éœ€è¦è™šæ‹ŸèŠ‚ç‚¹é˜²å€¾æ–œ          |
| **é¢‘ç¹æ‰©ç¼©å®¹**   | ä¸€è‡´æ€§Hash         | æ”¯æŒå¹³æ»‘æ‰©ç¼©å®¹               | å®ç°ç›¸å¯¹å¤æ‚                |

**ä¸€è‡´æ€§Hashæœ€ä½³å®è·µ**

1. **è™šæ‹ŸèŠ‚ç‚¹æ•°**: 100-200ï¼ˆæ ¹æ®é›†ç¾¤è§„æ¨¡è°ƒæ•´ï¼‰
2. **Hashç®—æ³•**: MurmurHash3ï¼ˆé«˜æ€§èƒ½ã€ä½ç¢°æ’ï¼‰
3. **ç›‘æ§æŒ‡æ ‡**: æ•°æ®åˆ†å¸ƒæ ‡å‡†å·® < 20%
4. **è¿ç§»ç­–ç•¥**: åŒå†™è¿ç§»ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
5. **å®¹é”™æœºåˆ¶**: èŠ‚ç‚¹æ•…éšœè‡ªåŠ¨æ‘˜é™¤ + å®¢æˆ·ç«¯é‡è¯•

**å…³é”®å†³ç­–ç‚¹**

- **æ•°æ®é‡è¦æ€§**ï¼šé‡è¦æ•°æ®ä½¿ç”¨åŒå†™è¿ç§»ï¼Œæ™®é€šæ•°æ®å¯å…¨é‡è¿ç§»
- **å¯ç”¨æ€§è¦æ±‚**ï¼šé«˜å¯ç”¨åœºæ™¯å¿…é¡»æ”¯æŒå¹³æ»‘æ‰©ç¼©å®¹
- **é›†ç¾¤è§„æ¨¡**ï¼šå¤§è§„æ¨¡é›†ç¾¤æ›´éœ€è¦ä¸€è‡´æ€§Hash
- **è¿ç»´èƒ½åŠ›**ï¼šå¤æ‚ç­–ç•¥éœ€è¦æ›´å¼ºçš„è¿ç»´æ”¯æ’‘



## **è®¿é—®é™æµ**

> Hystrixï¼ˆç½‘é£ï¼‰/polarisï¼ˆè…¾è®¯ï¼‰ï¼Œåˆ†å¸ƒå¼é™æµå®ç°æ–¹æ¡ˆï¼Œé™æµç®—æ³• è®¡æ•°å™¨/æ»‘åŠ¨çª—å£/æ¼æ¡¶/ä»¤ç‰Œæ¡¶ï¼Œå¸¸è§ä¸šåŠ¡é™æµç»´åº¦

### âš™ï¸ é™æµç®—æ³•æ·±åº¦è§£æ

#### 1. å›ºå®šçª—å£ç®—æ³•ï¼ˆè®¡æ•°å™¨ï¼‰

**å®ç°åŸç†**ï¼šå°†æ—¶é—´åˆ’åˆ†ä¸ºå›ºå®šçª—å£ï¼ˆå¦‚1ç§’ï¼‰ï¼Œåœ¨çª—å£å†…è®¡æ•°è¯·æ±‚æ•°ï¼Œè¶…è¿‡é˜ˆå€¼åˆ™æ‹’ç»ã€‚

å®ç°ï¼šç®€å•çª—å£åˆ¤æ–­

```java
// ç®€åŒ–å®ç°ç¤ºä¾‹
public class FixedWindowLimiter {
    private long windowSize = 1000; // 1ç§’
    private int threshold = 100;     // é™æµé˜ˆå€¼
    private long currentCount = 0;
    private long windowStart = System.currentTimeMillis();
    
    public synchronized boolean tryAcquire() {
        long now = System.currentTimeMillis();
        if (now - windowStart > windowSize) {
            currentCount = 0;
            windowStart = now;
        }
        if (currentCount < threshold) {
            currentCount++;
            return true;
        }
        return false;
    }
}
```

**ä¼˜ç¼ºç‚¹**ï¼š

- âœ… å®ç°ç®€å•ï¼Œå†…å­˜æ¶ˆè€—å°
- âŒ å­˜åœ¨**çª—å£ä¸´ç•Œçªå˜é—®é¢˜**ï¼šä¸¤ä¸ªæ—¶é—´çª—å£äº¤ç•Œå¤„å¯èƒ½é€šè¿‡2å€é˜ˆå€¼æµé‡

#### 2. æ»‘åŠ¨çª—å£ç®—æ³•

**æ”¹è¿›åŸç†**ï¼šå°†å›ºå®šçª—å£ç»†åˆ†ä¸ºå¤šä¸ªå­çª—å£ï¼ˆå¦‚1ç§’åˆ†ä¸º10ä¸ª100mså­çª—å£ï¼‰ï¼Œéšæ—¶é—´æ»‘åŠ¨ç»Ÿè®¡ã€‚

å®ç°ï¼šé˜Ÿåˆ—

```java
// æ»‘åŠ¨çª—å£æ ¸å¿ƒé€»è¾‘
public class SlidingWindow {
    private LinkedList<Long> requests = new LinkedList<>();
    private int maxRequests;
    private long windowMs;
    
    public synchronized boolean allowRequest() {
        long now = System.currentTimeMillis();
        // ç§»é™¤è¿‡æœŸè¯·æ±‚æ—¶é—´æˆ³
        while (!requests.isEmpty() && now - requests.peekFirst() > windowMs) {
            requests.pollFirst();
        }
        if (requests.size() < maxRequests) {
            requests.add(now);
            return true;
        }
        return false;
    }
}
```

**ä¼˜åŠ¿**ï¼šç›¸æ¯”å›ºå®šçª—å£ï¼Œèƒ½æ›´å¥½å¹³æ»‘æµé‡ï¼Œé¿å…2å€æµé‡å†²å‡»ã€‚

#### 3. æ¼æ¡¶ç®—æ³•

**æ ¸å¿ƒæ€æƒ³**ï¼šè¯·æ±‚å¦‚æ°´æµè¿›å…¥å›ºå®šå®¹é‡æ¼æ¡¶ï¼Œä»¥æ’å®šé€Ÿç‡æµå‡ºï¼Œæ¡¶æ»¡åˆ™æ‹’ç»æ–°è¯·æ±‚ã€‚

```java
public class LeakyBucket {
    private final long capacity;    // æ¡¶å®¹é‡
    private final long rate;       // æµå‡ºé€Ÿç‡ï¼ˆä¸ª/ç§’ï¼‰
    private long water;            // å½“å‰æ°´é‡
    private long lastLeakTime;     // ä¸Šæ¬¡æ¼æ°´æ—¶é—´
    
    public synchronized boolean tryAcquire() {
        leakWater(); // å…ˆæ¼æ°´
        if (water < capacity) {
            water++;
            return true;
        }
        return false;
    }
}
```

**é€‚ç”¨åœºæ™¯**ï¼šéœ€è¦**ä¸¥æ ¼å¹³æ»‘æµé‡**çš„åœºæ™¯ï¼Œå¦‚ç¬¬ä¸‰æ–¹APIè°ƒç”¨é¢‘ç‡æ§åˆ¶ã€‚

#### 4. ä»¤ç‰Œæ¡¶ç®—æ³•ï¼ˆä¸šç•Œæœ€å¸¸ç”¨ï¼‰

**å·¥ä½œåŸç†**ï¼šç³»ç»Ÿä»¥å›ºå®šé€Ÿç‡å‘æ¡¶ä¸­æ·»åŠ ä»¤ç‰Œï¼Œè¯·æ±‚è·å–ä»¤ç‰Œæ‰§è¡Œï¼Œæ— ä»¤ç‰Œåˆ™é™æµã€‚

```java
// Guava RateLimiteråŸºäºä»¤ç‰Œæ¡¶
public class TokenBucketExample {
    public static void main(String[] args) {
        RateLimiter limiter = RateLimiter.create(5.0); // æ¯ç§’5ä¸ªä»¤ç‰Œ
        
        if (limiter.tryAcquire()) {
            // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            handleRequest();
        } else {
            // è§¦å‘é™çº§é€»è¾‘
            fallback();
        }
    }
}
```

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š

- âœ… å…è®¸**çªå‘æµé‡**ï¼ˆæ¡¶ä¸­æœ‰ä»¤ç‰Œæ—¶å¯ä¸€æ¬¡æ€§æ¶ˆè€—ï¼‰
- âœ… å¹³æ»‘é•¿æœŸæµé‡ï¼ˆæ’å®šä»¤ç‰Œç”Ÿæˆé€Ÿç‡ï¼‰
- âœ… å…¼é¡¾ç³»ç»Ÿä¿æŠ¤ä¸èµ„æºåˆ©ç”¨ç‡

### ğŸ—ï¸ åˆ†å¸ƒå¼é™æµæ–¹æ¡ˆ

#### 1. Hystrixé™æµå®ç°

Hystrixçš„é™æµæœºåˆ¶ä¸»è¦é€šè¿‡**èµ„æºéš”ç¦»**æ¥å®ç°ï¼Œå…¶æ ¸å¿ƒæ˜¯ä¸¤ç§éš”ç¦»ç­–ç•¥ï¼š**çº¿ç¨‹æ± éš”ç¦»**å’Œ**ä¿¡å·é‡éš”ç¦»**ã€‚è¿™ä¸¤ç§ç­–ç•¥å¦‚åŒäº¤é€šç®¡åˆ¶ï¼Œé€šè¿‡é™åˆ¶å¯¹ç‰¹å®šèµ„æºï¼ˆå¦‚æŸä¸ªæœåŠ¡æ¥å£ï¼‰çš„å¹¶å‘è®¿é—®é‡ï¼Œé˜²æ­¢å› å•ä¸ªæœåŠ¡æ•…éšœå¯¼è‡´æ•´ä¸ªç³»ç»Ÿå´©æºƒï¼ˆé›ªå´©æ•ˆåº”ï¼‰

ä¸‹é¢çš„è¡¨æ ¼æ¸…æ™°åœ°å±•ç¤ºäº†ä¸¤ç§éš”ç¦»ç­–ç•¥çš„æ ¸å¿ƒåŒºåˆ«ã€‚

| ç‰¹æ€§ç»´åº¦     | çº¿ç¨‹æ± éš”ç¦» (THREAD)                                          | ä¿¡å·é‡éš”ç¦» (SEMAPHORE)                                       |
| ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **éš”ç¦»åŸç†** | ä¸ºæ¯ä¸ªä¾èµ–æœåŠ¡åˆ†é…ç‹¬ç«‹çš„çº¿ç¨‹æ± ï¼Œè¯·æ±‚åœ¨ä¸“å±çº¿ç¨‹ä¸­æ‰§è¡Œã€‚       | é€šè¿‡è®¡æ•°å™¨ï¼ˆä¿¡å·é‡ï¼‰é™åˆ¶å¹¶å‘è¯·æ±‚æ•°ï¼Œè¯·æ±‚åœ¨è°ƒç”¨çº¿ç¨‹ï¼ˆå¦‚Tomcatçº¿ç¨‹ï¼‰ä¸Šæ‰§è¡Œã€‚ |
| **è¶…æ—¶æ”¯æŒ** | **æ”¯æŒ**ã€‚å¯ä¸»åŠ¨è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶åå¿«é€Ÿå¤±è´¥ã€‚               | **ä¸æ”¯æŒ**ã€‚è‹¥æœåŠ¡å“åº”æ…¢ï¼Œè°ƒç”¨çº¿ç¨‹ä¼šä¸€ç›´è¢«é˜»å¡ã€‚             |
| **èµ„æºå¼€é”€** | è¾ƒé«˜ã€‚æ¶‰åŠçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä¼šå¸¦æ¥é¢å¤–æ€§èƒ½å¼€é”€ï¼ˆNetflixæ•°æ®è¡¨æ˜å¹³å‡å¢åŠ çº¦3mså»¶è¿Ÿï¼‰ã€‚ | æä½ã€‚ä»…æ˜¯è®¡æ•°å™¨æ“ä½œï¼Œæ— é¢å¤–çº¿ç¨‹å¼€é”€ã€‚                       |
| **é€‚ç”¨åœºæ™¯** | ç»å¤§å¤šæ•°**å¤–éƒ¨ä¾èµ–è°ƒç”¨**ï¼ˆå¦‚æ•°æ®åº“æŸ¥è¯¢ã€ç¬¬ä¸‰æ–¹APIè°ƒç”¨ï¼‰ï¼Œå°¤å…¶æ˜¯ç½‘ç»œè¯·æ±‚ï¼Œéœ€è¦æ§åˆ¶è¶…æ—¶å’Œé¿å…é˜»å¡çš„åœºæ™¯ã€‚ | **å†…éƒ¨é«˜é€Ÿè®¡ç®—**ã€è®¿é—®**æœ¬åœ°å†…å­˜ç¼“å­˜**ç­‰**éç½‘ç»œè¯·æ±‚**æˆ–**å¯ä¿¡èµ–çš„é«˜é¢‘è°ƒç”¨**ï¼Œè¿½æ±‚æé«˜æ€§èƒ½çš„åœºæ™¯ã€‚ |

##### æ ¸å¿ƒæ€è·¯

| ç‰¹æ€§         | **ä¼ ç»Ÿç®—æ³•é™æµï¼ˆå¦‚æ»‘åŠ¨çª—å£ã€ä»¤ç‰Œæ¡¶ï¼‰**       | **èµ„æºéš”ç¦»é™æµï¼ˆHystrixçš„æ€è·¯ï¼‰**                            |
| ------------ | -------------------------------------------- | ------------------------------------------------------------ |
| **æ ¸å¿ƒç›®æ ‡** | æ§åˆ¶å•ä½æ—¶é—´å†…é€šè¿‡çš„**è¯·æ±‚æ•°é‡ï¼ˆQPSï¼‰**      | æ§åˆ¶**å¹¶å‘å ç”¨çš„èµ„æºæ€»æ•°**ï¼ˆå¦‚çº¿ç¨‹æ•°ã€è¿æ¥æ•°ï¼‰               |
| **å…³æ³¨ç‚¹**   | æµé‡å…¥å£çš„**é¢‘ç‡å’Œé€Ÿç‡**                     | æ¯ä¸ªä¾èµ–æœåŠ¡ï¼ˆæˆ–æ¥å£ï¼‰çš„**èµ„æºè¾¹ç•Œå’Œæ•…éšœéš”ç¦»**               |
| **å®ç°æ–¹å¼** | è®¡æ•°å™¨ã€æ—¶é—´çª—å£ã€ä»¤ç‰Œç”Ÿæˆ                   | ä¸ºæ¯ä¸ªä¾èµ–åˆ›å»ºç‹¬ç«‹çš„**çº¿ç¨‹æ± **æˆ–**ä¿¡å·é‡è®¡æ•°å™¨**             |
| **å¥½æ¯”**     | **é«˜é€Ÿå…¬è·¯æ”¶è´¹ç«™**ï¼šé™åˆ¶æ¯åˆ†é’Ÿé€šè¡Œçš„è½¦è¾†æ•°ã€‚ | **è½®èˆ¹çš„èˆ±å£**ï¼šå°†èˆ¹ä½“åˆ†æˆå¤šä¸ªå¯†å°éš”èˆ±ï¼Œä¸€ä¸ªéš”èˆ±è¿›æ°´ï¼Œä¸ä¼šå¯¼è‡´æ•´è‰˜èˆ¹æ²‰æ²¡ |



**çº¿ç¨‹æ± éš”ç¦»**ï¼š

```java
@HystrixCommand(
    threadPoolKey = "orderServicePool",
    threadPoolProperties = {
        @HystrixProperty(name = "coreSize", value = "20"),
        @HystrixProperty(name = "maxQueueSize", value = "100")
    },
    fallbackMethod = "fallbackHandler"
)
public String processOrder(Order order) {
    // ä¸šåŠ¡é€»è¾‘
}
```

**ä¿¡å·é‡éš”ç¦»**ï¼š

```java
@HystrixCommand(
    commandProperties = {
        @HystrixProperty(name = "execution.isolation.strategy", value = "SEMAPHORE"),
        @HystrixProperty(name = "execution.isolation.semaphore.maxConcurrentRequests", value = "50")
    }
)
```

**é€‰æ‹©ç­–ç•¥**ï¼š

- **çº¿ç¨‹æ± éš”ç¦»**ï¼šé€‚åˆç½‘ç»œè¯·æ±‚ã€å¤–éƒ¨è°ƒç”¨ï¼Œæ”¯æŒè¶…æ—¶å’Œå¼‚æ­¥
- **ä¿¡å·é‡éš”ç¦»**ï¼šé€‚åˆå†…å­˜è®¡ç®—ã€é«˜é¢‘è°ƒç”¨ï¼Œå¼€é”€æ›´å°

#### 2. åŸºäºRedisçš„åˆ†å¸ƒå¼é™æµ

```lua
-- æ»‘åŠ¨çª—å£é™æµLuaè„šæœ¬
local key = KEYS[1] -- é™æµkey
local window = tonumber(ARGV[1]) -- çª—å£å¤§å°(ç§’)
local threshold = tonumber(ARGV[2]) -- é˜ˆå€¼

local now = redis.call('TIME')[1]
local clearBefore = now - window

-- æ¸…é™¤çª—å£å¤–æ•°æ®
redis.call('ZREMRANGEBYSCORE', key, 0, clearBefore)

-- è·å–å½“å‰è®¡æ•°
local current = redis.call('ZCARD', key)

if current < threshold then
    redis.call('ZADD', key, now, now .. math.random())
    redis.call('EXPIRE', key, window)
    return true
end
return false
```

#### 3. é˜¿é‡ŒSentinel vs Netflix Hystrix

| **ç‰¹æ€§**   | **Sentinel**           | **Hystrix**   |
| ---------- | ---------------------- | ------------- |
| é™æµç®—æ³•   | æ»‘åŠ¨çª—å£               | çº¿ç¨‹æ± /ä¿¡å·é‡ |
| ç†”æ–­ç­–ç•¥   | åŸºäºå“åº”æ—¶é—´ã€å¼‚å¸¸æ¯”ä¾‹ | åŸºäºé”™è¯¯æ¯”ä¾‹  |
| å®æ—¶ç›‘æ§   | å¼€ç®±å³ç”¨æ§åˆ¶å°         | éœ€æ•´åˆTurbine |
| è§„åˆ™é…ç½®   | æ”¯æŒåŠ¨æ€é…ç½®           | ç›¸å¯¹é™æ€      |
| ç³»ç»Ÿè‡ªé€‚åº” | æ”¯æŒç³»ç»Ÿè´Ÿè½½ä¿æŠ¤       | ä¸æ”¯æŒ        |
| æ‰©å±•æ€§     | å¤šæ‰©å±•ç‚¹               | æ’ä»¶å¼        |

### ğŸ¯ ä¸šåŠ¡é™æµç»´åº¦è®¾è®¡

#### 1. å¤šç»´åº¦é™æµç­–ç•¥

åœ¨å®é™…ä¸šåŠ¡ä¸­ï¼Œéœ€è¦ä»å¤šä¸ªç»´åº¦è®¾è®¡é™æµkeyï¼š

```java
// å¤šç»´åº¦é™æµkeyæ„å»º
public class RateLimitKeyBuilder {
    public String buildKey(RateLimitContext context) {
        // æœåŠ¡ç»´åº¦ï¼šé˜²æ­¢ä¸Šæ¸¸æœåŠ¡é—´å½±å“
        String upstreamService = context.getUpstreamService();
        
        // æ¥å£ç»´åº¦ï¼šé˜²æ­¢å•æ¥å£è¿‡è½½å½±å“å…¶ä»–æ¥å£
        String interfaceName = context.getInterfaceName();
        
        // ä¸šåŠ¡ç»´åº¦ï¼šåŒºåˆ†æ ¸å¿ƒ/éæ ¸å¿ƒä¸šåŠ¡
        String bizScenario = context.getBizScenario();
        
        // é›†ç¾¤ç»´åº¦ï¼šé€‚é…ä¸åŒé›†ç¾¤å¤„ç†èƒ½åŠ›
        String cluster = context.getCluster();
        
        return String.join(":", upstreamService, interfaceName, bizScenario, cluster);
    }
}
```

#### 2. å¸¸è§ä¸šåŠ¡åœºæ™¯é™æµé…ç½®

**ç§’æ€åœºæ™¯**ï¼ˆä»¤ç‰Œæ¡¶ï¼‰ï¼š

```yaml
rate_limit:
  seckill:
    strategy: "token_bucket"  # å…è®¸çªå‘æµé‡
    capacity: 1000            # æ¡¶å®¹é‡
    rate: 100                 # æ¯ç§’è¡¥å……é€Ÿç‡
    dimensions:
      - "user_id"             # ç”¨æˆ·ç»´åº¦é˜²åˆ·
      - "item_id"             # å•†å“ç»´åº¦é˜²è¶…å–
```

**APIç½‘å…³é™æµ**ï¼š

```yaml
api_gateway:
  global_limiter: 
    type: "sliding_window"    # ç²¾å‡†æ§åˆ¶
    window_size: 1s
    threshold: 5000           # å…¨å±€é™æµ
    
  route_limits:
    - path: "/api/order/**"
      threshold: 1000
      burst: 200              # çªå‘å®¹é‡
    - path: "/api/payment/**"  
      threshold: 500
      priority: "high"        # é«˜ä¼˜å…ˆçº§ä¸šåŠ¡
```

**å¾®æœåŠ¡è°ƒç”¨é™æµ**ï¼š

```java
@Service
public class OrderService {
    // åŸºäºQPSé™æµ
    @SentinelResource(value = "createOrder", 
        blockHandler = "createOrderBlockHandler")
    public Order createOrder(OrderDTO order) {
        // æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
    }
    
    // åŸºäºå¹¶å‘æ•°é™æµ
    @HystrixCommand(fallbackMethod = "fallback",
        commandProperties = {
            @HystrixProperty(name = "execution.isolation.semaphore.maxConcurrentRequests", 
                           value = "100")
        })
    public Inventory checkInventory(String sku) {
        // åº“å­˜æ£€æŸ¥
    }
}
```

### ğŸ“Š ç®—æ³•é€‰å‹æŒ‡å—

| **åœºæ™¯**   | **æ¨èç®—æ³•** | **ç†ç”±**           | **é…ç½®è¦ç‚¹**           |
| ---------- | ------------ | ------------------ | ---------------------- |
| APIç½‘å…³    | æ»‘åŠ¨çª—å£     | ç²¾åº¦é«˜ï¼Œå“åº”å¿«     | çª—å£ç»†åˆ†ç²’åº¦è¦åˆç†     |
| ç§’æ€æŠ¢è´­   | ä»¤ç‰Œæ¡¶       | å…è®¸çªå‘ï¼Œä½“éªŒå¥½   | æ¡¶å®¹é‡è¦å¤§äºå¹³å‡è¯·æ±‚é‡ |
| ç¬¬ä¸‰æ–¹è°ƒç”¨ | æ¼æ¡¶         | ä¸¥æ ¼æ§é€Ÿï¼Œé¿å…è¶…é™ | é€Ÿç‡æŒ‰SLAè®¾ç½®          |
| å†…éƒ¨æœåŠ¡   | å›ºå®šçª—å£     | å®ç°ç®€å•ï¼Œå¼€é”€å°   | æ³¨æ„ä¸´ç•Œé—®é¢˜å½±å“       |

#### ğŸ’¡ å®è·µå»ºè®®

1. **æ¸è¿›å¼å®æ–½**ï¼šä»å•æœºé™æµå¼€å§‹ï¼Œé€æ­¥è¿‡æ¸¡åˆ°åˆ†å¸ƒå¼é™æµ
2. **ç›‘æ§å‘Šè­¦**ï¼šå®æ—¶ç›‘æ§é™æµè§¦å‘æƒ…å†µï¼ŒåŠæ—¶è°ƒæ•´é˜ˆå€¼  ï¼ˆHystrix Metrics Stream +  Prometheusï¼‰
3. **åŠ¨æ€é…ç½®**ï¼šä½¿ç”¨é…ç½®ä¸­å¿ƒæ”¯æŒé™æµè§„åˆ™çƒ­æ›´æ–°
4. **é™çº§ç­–ç•¥**ï¼šé™æµè§¦å‘æ—¶è¦æœ‰å‹å¥½çš„é™çº§æ–¹æ¡ˆ
5. **å®¹é‡è§„åˆ’**ï¼šåŸºäºå‹æµ‹æ•°æ®è®¾ç½®åˆç†é™æµé˜ˆå€¼



## **æ•…éšœç†”æ–­**

> æœåŠ¡å¥åº·æ£€æµ‹æœºåˆ¶ï¼ŒæœåŠ¡ç†”æ–­çš„è§¦å‘å’Œæ¢å¤æ¡ä»¶ï¼Œå…¨æ­»å…¨æ´»ä¿æŠ¤ç­–ç•¥

**æ•…éšœç†”æ–­**æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ç”¨äºé˜²æ­¢çº§è”æ•…éšœçš„æ ¸å¿ƒä¿æŠ¤æœºåˆ¶ï¼Œé€šè¿‡å¿«é€Ÿå¤±è´¥å’Œé™çº§æ¥ä¿éšœç³»ç»Ÿæ•´ä½“å¯ç”¨æ€§ã€‚

### ä¸€ã€æœåŠ¡å¥åº·æ£€æµ‹æœºåˆ¶

æœåŠ¡å¥åº·æ£€æµ‹æ˜¯ç†”æ–­æœºåˆ¶çš„åŸºç¡€ï¼Œç”¨äºå®æ—¶åˆ¤æ–­æœåŠ¡å®ä¾‹æ˜¯å¦å¯ç”¨ã€‚ä¸»è¦æ£€æµ‹æ–¹å¼åŒ…æ‹¬ï¼š

| æ£€æµ‹ç±»å‹     | å®ç°æ–¹å¼                                                     | ç‰¹ç‚¹                         |
| ------------ | ------------------------------------------------------------ | ---------------------------- |
| **ä¸»åŠ¨æ¢æµ‹** | å®šæœŸå‘æœåŠ¡å®ä¾‹å‘é€å¿ƒè·³è¯·æ±‚ï¼ˆå¦‚HTTP GET/PINGï¼‰ï¼Œæ ¹æ®å“åº”æ—¶é—´å’ŒçŠ¶æ€ç åˆ¤æ–­ | å®æ—¶æ€§å¼ºï¼Œä½†ä¼šå¢åŠ ç½‘ç»œå¼€é”€   |
| **è¢«åŠ¨ç»Ÿè®¡** | åŸºäºå®é™…è¯·æ±‚çš„å“åº”æ—¶é—´ã€é”™è¯¯ç‡ç­‰æŒ‡æ ‡è¿›è¡Œæ»‘åŠ¨çª—å£ç»Ÿè®¡         | çœŸå®åæ˜ ä¸šåŠ¡çŠ¶æ€ï¼Œä½†å­˜åœ¨å»¶è¿Ÿ |
| **æ··åˆæ¨¡å¼** | ç»“åˆä¸»åŠ¨æ¢æµ‹å’Œè¢«åŠ¨ç»Ÿè®¡ï¼Œè®¾ç½®ä¸åŒæƒé‡                         | å…¼é¡¾å®æ—¶æ€§å’Œå‡†ç¡®æ€§           |

**å…³é”®é…ç½®å‚æ•°**ï¼š

- **æ£€æµ‹é—´éš”**ï¼šé€šå¸¸1-10ç§’
- **è¶…æ—¶æ—¶é—´**ï¼šå»ºè®®è®¾ç½®ä¸ºæ­£å¸¸å“åº”æ—¶é—´çš„2-3å€
- **å¥åº·é˜ˆå€¼**ï¼šè¿ç»­å¤±è´¥æ¬¡æ•°ï¼ˆå¦‚3æ¬¡ï¼‰æˆ–é”™è¯¯ç‡é˜ˆå€¼ï¼ˆå¦‚50%ï¼‰



### äºŒã€ç†”æ–­çš„è§¦å‘æ¡ä»¶

ç†”æ–­å™¨ä»**å…³é—­çŠ¶æ€**ï¼ˆæ­£å¸¸ï¼‰åˆ‡æ¢åˆ°**æ‰“å¼€çŠ¶æ€**ï¼ˆç†”æ–­ï¼‰çš„è§¦å‘æ¡ä»¶é€šå¸¸åŸºäºä»¥ä¸‹æŒ‡æ ‡ï¼š

1. **é”™è¯¯ç‡è§¦å‘**

- **ç»Ÿè®¡çª—å£**ï¼šæœ€è¿‘Nä¸ªè¯·æ±‚ï¼ˆå¦‚10ä¸ªè¯·æ±‚ï¼‰
- **é”™è¯¯ç‡é˜ˆå€¼**ï¼šè¶…è¿‡è®¾å®šæ¯”ä¾‹ï¼ˆå¦‚50%ï¼‰å³è§¦å‘
- **å®ç°æ–¹å¼**ï¼šæ»‘åŠ¨çª—å£ç»Ÿè®¡ï¼Œé¿å…å•æ¬¡å¼‚å¸¸å¯¼è‡´è¯¯åˆ¤

2. **å“åº”æ—¶é—´è§¦å‘**

- **æ…¢è°ƒç”¨é˜ˆå€¼**ï¼šå“åº”æ—¶é—´è¶…è¿‡è®¾å®šå€¼ï¼ˆå¦‚1ç§’ï¼‰
- **æ…¢è°ƒç”¨æ¯”ä¾‹**ï¼šæ…¢è°ƒç”¨å æ¯”è¶…è¿‡é˜ˆå€¼ï¼ˆå¦‚50%ï¼‰
- **ç»Ÿè®¡çª—å£**ï¼šæœ€è¿‘Nä¸ªè¯·æ±‚

3. **è¿ç»­å¤±è´¥è§¦å‘**

- **è¿ç»­å¤±è´¥æ¬¡æ•°**ï¼šè¿ç»­Næ¬¡è¯·æ±‚å¤±è´¥ï¼ˆå¦‚3æ¬¡ï¼‰
- **ä¼˜ç‚¹**ï¼šå“åº”å¿«é€Ÿï¼Œé€‚åˆå¯¹å»¶è¿Ÿæ•æ„Ÿçš„åœºæ™¯

**å…¸å‹é…ç½®ç¤ºä¾‹**ï¼š

```yaml
circuit_breaker:
  failure_rate_threshold: 50%  # é”™è¯¯ç‡é˜ˆå€¼
  slow_call_rate_threshold: 50%  # æ…¢è°ƒç”¨æ¯”ä¾‹
  slow_call_duration_threshold: 1000ms  # æ…¢è°ƒç”¨æ—¶é—´é˜ˆå€¼
  sliding_window_size: 10  # ç»Ÿè®¡çª—å£å¤§å°
  minimum_number_of_calls: 5  # æœ€å°è°ƒç”¨æ¬¡æ•°ï¼ˆé¿å…åˆæœŸè¯¯åˆ¤ï¼‰
```

------



### ä¸‰ã€ç†”æ–­çš„æ¢å¤æ¡ä»¶

ç†”æ–­å™¨ä»**æ‰“å¼€çŠ¶æ€**åˆ‡æ¢åˆ°**åŠå¼€çŠ¶æ€**ï¼Œæœ€ç»ˆæ¢å¤æ­£å¸¸çš„æ¡ä»¶ï¼š

1. **åŠå¼€çŠ¶æ€è½¬æ¢æ¡ä»¶**

- **ç†”æ–­æ—¶é—´**ï¼šç†”æ–­åç»è¿‡è®¾å®šçš„æ—¶é—´çª—å£ï¼ˆå¦‚5ç§’ï¼‰
- **å®ç°æ–¹å¼**ï¼šå®šæ—¶å™¨æˆ–æ—¶é—´çª—å£åˆ°æœŸåè‡ªåŠ¨è¿›å…¥åŠå¼€çŠ¶æ€

2. **åŠå¼€çŠ¶æ€éªŒè¯æœºåˆ¶**

- **è¯•æ¢è¯·æ±‚**ï¼šå…è®¸å°‘é‡è¯·æ±‚ï¼ˆå¦‚1ä¸ªï¼‰é€šè¿‡ï¼Œæµ‹è¯•æœåŠ¡æ˜¯å¦æ¢å¤
- **æˆåŠŸæ¡ä»¶**ï¼šè¯•æ¢è¯·æ±‚æˆåŠŸï¼Œåˆ™å…³é—­ç†”æ–­å™¨
- **å¤±è´¥æ¡ä»¶**ï¼šè¯•æ¢è¯·æ±‚å¤±è´¥ï¼Œåˆ™é‡ç½®ç†”æ–­æ—¶é—´ï¼Œé‡æ–°è¿›å…¥æ‰“å¼€çŠ¶æ€

3. **å®Œå…¨æ¢å¤æ¡ä»¶**

- **è¿ç»­æˆåŠŸæ¬¡æ•°**ï¼šåŠå¼€çŠ¶æ€ä¸‹è¿ç»­Næ¬¡è¯·æ±‚æˆåŠŸï¼ˆå¦‚3æ¬¡ï¼‰
- **æˆåŠŸç‡é˜ˆå€¼**ï¼šåŠå¼€çª—å£å†…æˆåŠŸç‡è¶…è¿‡è®¾å®šå€¼ï¼ˆå¦‚80%ï¼‰

**æ¢å¤ç­–ç•¥é…ç½®**ï¼š

```yaml
circuit_breaker:
  wait_duration_in_open_state: 5000ms  # ç†”æ–­æŒç»­æ—¶é—´
  permitted_number_of_calls_in_half_open_state: 1  # åŠå¼€çŠ¶æ€å…è®¸çš„è¯·æ±‚æ•°
  max_calls_in_half_open_state: 3  # åŠå¼€çŠ¶æ€æœ€å¤§è¯·æ±‚æ•°
```

------

### å››ã€å…¨æ­»å…¨æ´»ä¿æŠ¤ç­–ç•¥

**å…¨æ­»å…¨æ´»**ï¼ˆAll-or-Nothingï¼‰æ˜¯ç†”æ–­æœºåˆ¶ä¸­çš„ä¸€ç§ç‰¹æ®Šä¿æŠ¤ç­–ç•¥ï¼Œç”¨äºæç«¯åœºæ™¯ï¼š

1. **æ ¸å¿ƒæ¦‚å¿µ**

- **å…¨æ­»**ï¼šå½“æ‰€æœ‰æœåŠ¡å®ä¾‹éƒ½ä¸å¯ç”¨æ—¶ï¼Œç†”æ–­å™¨å®Œå…¨æ‰“å¼€ï¼Œæ‹’ç»æ‰€æœ‰è¯·æ±‚
- **å…¨æ´»**ï¼šå½“æœ‰éƒ¨åˆ†å®ä¾‹æ¢å¤æ—¶ï¼Œç†”æ–­å™¨è¿›å…¥åŠå¼€çŠ¶æ€ï¼Œé€æ­¥æ¢å¤æµé‡

**"å…¨æ­»å…¨æ´»"ç­–ç•¥çš„åç§°æ¥æºäºå…¶æç«¯çŠ¶æ€ä¸‹çš„ä¸¤ç§è¡Œä¸ºæ¨¡å¼ï¼šè¦ä¹ˆæ‰€æœ‰å®ä¾‹éƒ½ä¸å¯ç”¨ï¼ˆå…¨æ­»ï¼‰æ—¶å®Œå…¨ç†”æ–­ï¼Œè¦ä¹ˆæœ‰å®ä¾‹æ¢å¤ï¼ˆå…¨æ´»ï¼‰æ—¶é€æ­¥æ¢å¤æµé‡ã€‚**è¿™ä¸ªå‘½åå½¢è±¡åœ°æè¿°äº†ç†”æ–­å™¨åœ¨é›†ç¾¤å®Œå…¨ä¸å¯ç”¨å’Œéƒ¨åˆ†æ¢å¤æ—¶çš„äºŒå…ƒåŒ–å¤„ç†é€»è¾‘ã€‚



2. **å®ç°æ–¹å¼**

- **å®ä¾‹å¥åº·åº¦ç»Ÿè®¡**ï¼šç›‘æ§æœåŠ¡é›†ç¾¤ä¸­å¥åº·å®ä¾‹çš„æ¯”ä¾‹
- **å…¨æ­»åˆ¤æ–­æ¡ä»¶**ï¼šå¥åº·å®ä¾‹æ•°=0 æˆ– å¥åº·æ¯”ä¾‹<é˜ˆå€¼ï¼ˆå¦‚10%ï¼‰
- **å…¨æ´»åˆ¤æ–­æ¡ä»¶**ï¼šå¥åº·å®ä¾‹æ•°>0 ä¸” å¥åº·æ¯”ä¾‹>é˜ˆå€¼

3. **ä¿æŠ¤æ„ä¹‰**

- **é¿å…èµ„æºæµªè´¹**ï¼šå½“æ‰€æœ‰å®ä¾‹éƒ½ä¸å¯ç”¨æ—¶ï¼Œå¿«é€Ÿå¤±è´¥ï¼Œ**é¿å…å®¢æˆ·ç«¯æŒç»­é‡è¯•æ¶ˆè€—èµ„æº**
- **é˜²æ­¢é›ªå´©**ï¼šåœ¨æœåŠ¡å®Œå…¨ä¸å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œ**å¿«é€Ÿç†”æ–­å¯ä»¥ä¿æŠ¤ä¸Šæ¸¸æœåŠ¡ä¸è¢«æ‹–å®**
- **è‡ªåŠ¨æ¢å¤**ï¼šå½“æœ‰å®ä¾‹æ¢å¤æ—¶ï¼Œè‡ªåŠ¨å°è¯•æ¢å¤ï¼Œæ— éœ€äººå·¥å¹²é¢„

4. **é…ç½®å»ºè®®**

```yaml
circuit_breaker:
  all_or_nothing:
    enabled: true
    min_healthy_instances: 1  # æœ€å°å¥åº·å®ä¾‹æ•°
    healthy_ratio_threshold: 10%  # å¥åº·å®ä¾‹æ¯”ä¾‹é˜ˆå€¼
```

------

### äº”ã€å®é™…åº”ç”¨æ³¨æ„äº‹é¡¹

1. **é¿å…è¿‡åº¦ç†”æ–­**ï¼šè®¾ç½®åˆç†çš„é˜ˆå€¼ï¼Œé¿å…å› ç½‘ç»œæŠ–åŠ¨æˆ–ç¬æ—¶å‹åŠ›å¯¼è‡´è¯¯ç†”æ–­
2. **ç›‘æ§ä¸å‘Šè­¦**ï¼šè®°å½•ç†”æ–­äº‹ä»¶ï¼Œè®¾ç½®å‘Šè­¦ï¼Œä¾¿äºåŠæ—¶æ’æŸ¥é—®é¢˜
3. **é™çº§ç­–ç•¥**ï¼šç†”æ–­ååº”æœ‰é™çº§æ–¹æ¡ˆï¼ˆå¦‚è¿”å›é»˜è®¤å€¼ã€ç¼“å­˜æ•°æ®ã€å¼‚æ­¥å¤„ç†ï¼‰
4. **ç°åº¦æ¢å¤**ï¼šåŠå¼€çŠ¶æ€é€æ­¥æ”¾é‡ï¼Œé¿å…æ¢å¤ç¬é—´æµé‡å†²å‡»
5. **å¤šçº§ç†”æ–­**ï¼šåœ¨è°ƒç”¨é“¾ä¸åŒå±‚çº§è®¾ç½®ç†”æ–­å™¨ï¼Œå½¢æˆç«‹ä½“ä¿æŠ¤

------

### å…­ã€ä¸»æµæ¡†æ¶å®ç°

| æ¡†æ¶                             | å®ç°æ–¹å¼               | ç‰¹ç‚¹                       |
| -------------------------------- | ---------------------- | -------------------------- |
| **Hystrix**                      | åŸºäºçº¿ç¨‹æ± éš”ç¦»å’Œç†”æ–­å™¨ | æˆç†Ÿç¨³å®šï¼Œä½†å·²åœæ­¢ç»´æŠ¤     |
| **Resilience4j**                 | å‡½æ•°å¼ç¼–ç¨‹ï¼Œè½»é‡çº§     | æ”¯æŒå¤šç§å®¹é”™æ¨¡å¼ï¼Œä¸»æµé€‰æ‹© |
| **Sentinel**                     | æµé‡æ§åˆ¶ã€ç†”æ–­é™çº§     | é˜¿é‡Œå¼€æºï¼ŒåŠŸèƒ½ä¸°å¯Œ         |
| **Spring Cloud Circuit Breaker** | æŠ½è±¡å±‚ï¼Œæ”¯æŒå¤šç§å®ç°   | æ ‡å‡†åŒ–æ¥å£ï¼Œä¾¿äºåˆ‡æ¢       |

**å»ºè®®**ï¼šæ–°é¡¹ç›®æ¨èä½¿ç”¨Resilience4jæˆ–Sentinelï¼Œè€é¡¹ç›®å¯ç»§ç»­ä½¿ç”¨Hystrixä½†éœ€æ³¨æ„ç»´æŠ¤é£é™©ã€‚



### æ€»ç»“

æ•…éšœç†”æ–­æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­ä¸å¯æˆ–ç¼ºçš„ç¨³å®šæ€§ä¿éšœæ‰‹æ®µã€‚

æ­£ç¡®é…ç½®å¥åº·æ£€æµ‹ã€è§¦å‘æ¡ä»¶ã€æ¢å¤ç­–ç•¥å’Œå…¨æ­»å…¨æ´»ä¿æŠ¤ï¼Œå¯ä»¥æœ‰æ•ˆé˜²æ­¢çº§è”æ•…éšœï¼Œæå‡ç³»ç»Ÿæ•´ä½“**å¯ç”¨æ€§**ã€‚

å®é™…åº”ç”¨ä¸­éœ€æ ¹æ®ä¸šåŠ¡åœºæ™¯è°ƒæ•´å‚æ•°ï¼Œå¹¶ç»“åˆç›‘æ§ã€å‘Šè­¦å’Œé™çº§ç­–ç•¥å½¢æˆå®Œæ•´çš„å®¹é”™ä½“ç³»ã€‚



## **è‡ªé€‚åº”è¿‡è½½ä¿æŠ¤**

> å¾®æœåŠ¡è¿è¡ŒæŒ‡æ ‡è‡ªé€‚åº” CPU/ç­‰å¾…é˜Ÿåˆ—/è¶…æ—¶è¯·æ±‚ç­‰

è‡ªé€‚åº”è¿‡è½½ä¿æŠ¤æ˜¯ç°ä»£å¾®æœåŠ¡æ¶æ„ä¸­è‡³å…³é‡è¦çš„ç¨³å®šæ€§ä¿éšœæœºåˆ¶ï¼Œå®ƒé€šè¿‡**å®æ—¶ç›‘æ§ç³»ç»Ÿå…³é”®æŒ‡æ ‡**ï¼Œå¹¶**åŠ¨æ€è°ƒæ•´æµé‡æ§åˆ¶ç­–ç•¥**ï¼Œç¡®ä¿ç³»ç»Ÿåœ¨é¢ä¸´çªå‘æµé‡æˆ–å†…éƒ¨å¼‚å¸¸æ—¶ä»èƒ½ç»´æŒæ ¸å¿ƒæœåŠ¡çš„å¯ç”¨æ€§ï¼Œé¿å…å› è¿‡è½½å¯¼è‡´çš„é›ªå´©æ•ˆåº”ã€‚

ä¸‹é¢è¿™ä¸ªè¡¨æ ¼æ¢³ç†äº†è‡ªé€‚åº”è¿‡è½½ä¿æŠ¤çš„æ ¸å¿ƒç»´åº¦åŠå…¶å…³è”å…³ç³»ï¼Œå¸®åŠ©ä½ å¿«é€Ÿå»ºç«‹æ•´ä½“è®¤çŸ¥ã€‚

| ä¿æŠ¤ç»´åº¦     | æ ¸å¿ƒç›‘æ§æŒ‡æ ‡                    | è§¦å‘æ¡ä»¶ç¤ºä¾‹                    | å…¸å‹ä¿æŠ¤åŠ¨ä½œ                     | è®¾è®¡ç›®æ ‡                           |
| ------------ | ------------------------------- | ------------------------------- | -------------------------------- | ---------------------------------- |
| **CPUè´Ÿè½½**  | CPUä½¿ç”¨ç‡ã€ç³»ç»Ÿå¹³å‡è´Ÿè½½ï¼ˆLoadï¼‰ | CPUä½¿ç”¨ç‡æŒç»­ > 90%             | æŒ‰è®¡ç®—å‡ºçš„æ¯”ä¾‹æ‹’ç»æ–°è¯·æ±‚         | é˜²æ­¢è®¡ç®—èµ„æºè€—å°½ï¼Œä¿éšœè¿›ç¨‹ä¸è¢«å¡æ­» |
| **ç­‰å¾…é˜Ÿåˆ—** | è¯·æ±‚åœ¨é˜Ÿåˆ—ä¸­çš„å¹³å‡ç­‰å¾…æ—¶é—´      | å¹³å‡ç­‰å¾…æ—¶é—´ > 20ms             | æ ¹æ®ä¼˜å…ˆçº§ä¸¢å¼ƒä½ä¼˜å…ˆçº§è¯·æ±‚       | æ§åˆ¶é˜Ÿåˆ—ç§¯å‹ï¼Œé¿å…è¯·æ±‚å»¶è¿Ÿæ— é™å¢é•¿ |
| **è¶…æ—¶è¯·æ±‚** | æ…¢è°ƒç”¨æ¯”ä¾‹ã€å¹³å‡å“åº”æ—¶é—´ï¼ˆRTï¼‰  | æ…¢è°ƒç”¨æ¯”ä¾‹ > 50% æˆ–å¹³å‡RTè¶…æ ‡   | è§¦å‘ç†”æ–­ï¼Œå¿«é€Ÿå¤±è´¥å¹¶è¿›å…¥é™çº§é€»è¾‘ | å‡å°‘æ— æ•ˆèµ„æºæ¶ˆè€—ï¼Œæå‡ç”¨æˆ·ä½“éªŒ     |
| **ç³»ç»Ÿåå** | QPSã€å¹¶å‘çº¿ç¨‹æ•°                 | å½“å‰å¹¶å‘æ•° > åŠ¨æ€è®¡ç®—çš„ç³»ç»Ÿå®¹é‡ | é™åˆ¶å…¥å£æµé‡ï¼ˆé™æµï¼‰             | å°†ç³»ç»Ÿååç»´æŒåœ¨å¥åº·æ°´ä½           |

### âš™ï¸ æ ¸å¿ƒå®ç°åŸç†

è‡ªé€‚åº”è¿‡è½½ä¿æŠ¤ä¸ä»…ä»…æ˜¯ç®€å•çš„é˜ˆå€¼æŠ¥è­¦ï¼Œå…¶èƒŒåæ˜¯ä¸€å¥—æ™ºèƒ½çš„åé¦ˆæ§åˆ¶ç³»ç»Ÿã€‚

1. **åŠ¨æ€åŸºå‡†è¯„ä¼°**ï¼šç³»ç»Ÿä¼šæŒç»­æ¢æµ‹å¹¶æ›´æ–°è‡ªèº«çš„å¤„ç†èƒ½åŠ›ï¼Œä¾‹å¦‚é€šè¿‡ç»Ÿè®¡æ—¶é—´çª—å£å†…çš„æœ€å¤§æˆåŠŸè¯·æ±‚æ•°ï¼ˆ`maxPass`ï¼‰å’Œæœ€å°å¹³å‡å“åº”æ—¶é—´ï¼ˆ`minRt`ï¼‰ï¼Œæ¥åŠ¨æ€è®¡ç®—å½“å‰ç³»ç»Ÿçš„å®‰å…¨å®¹é‡ï¼ˆ`capacity = maxPass * minRt / 1000`ï¼‰ã€‚è¿™æ¯”ä½¿ç”¨é™æ€é˜ˆå€¼æ›´èƒ½é€‚åº”æœåŠ¡æ€§èƒ½çš„å˜åŒ–ã€‚
2. **è´Ÿåé¦ˆè°ƒèŠ‚**ï¼šå½“ç›‘æ§æŒ‡æ ‡ï¼ˆå¦‚CPUä½¿ç”¨ç‡ï¼‰è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œä¿æŠ¤ç®—æ³•ä¼šåƒä¸€ä¸ªâ€œæ’æ¸©å™¨â€ä¸€æ ·å·¥ä½œã€‚æŒ‡æ ‡åç¦»è¶Šå¤šï¼Œé‡‡å–çš„é™æµæˆ–æ‹’ç»åŠ¨ä½œå°±è¶Šå¼ºã€‚ä¾‹å¦‚ï¼Œ`go-zero`ä¼šè®¡ç®—ä¸€ä¸ªâ€œCPUè´Ÿè½½åé¦ˆå› å­â€ï¼Œä½¿å¾—CPUä½¿ç”¨ç‡è¶Šé«˜ï¼Œè¯·æ±‚çš„æ‹’ç»æ¦‚ç‡ä¹Ÿè¶Šé«˜ï¼Œä»è€Œå°†CPUä½¿ç”¨ç‡æ‹‰å›è‡³é˜ˆå€¼é™„è¿‘ã€‚
3. **å¹³æ»‘å¤„ç†ä¸é˜²æŠ–åŠ¨**ï¼šä¸ºé¿å…å› æŒ‡æ ‡ç¬æ—¶æ¯›åˆºï¼ˆå¦‚ä¸€æ¬¡å¤§å‹GCï¼‰å¯¼è‡´è¯¯ä¿æŠ¤ï¼Œç³»ç»Ÿé€šå¸¸ä¼šä½¿ç”¨**æ»‘åŠ¨å¹³å‡ç®—æ³•**ï¼ˆMoving Averageï¼‰æ¥å¹³æ»‘ç›‘æ§æ•°æ®ã€‚ä¾‹å¦‚ï¼Œ`go-zero`é€šè¿‡è®¡ç®—è¿‡å»çº¦20ä¸ªé‡‡æ ·ç‚¹çš„å¹³å‡å€¼æ¥åˆ¤æ–­è¶‹åŠ¿ï¼Œé¿å…é¢‘ç¹è§¦å‘ä¿æŠ¤ã€‚

**1. ä¸ä¼ ç»Ÿè¿‡è½½ä¿æŠ¤çš„å¯¹æ¯”**

| **ç»´åº¦**       | **ä¼ ç»Ÿé™æ€è¿‡è½½ä¿æŠ¤** | **è‡ªé€‚åº”è¿‡è½½ä¿æŠ¤**   |
| -------------- | -------------------- | -------------------- |
| **è§¦å‘æ¡ä»¶**   | å›ºå®šçš„é˜ˆå€¼é…ç½®       | åŸºäºå®æ—¶æŒ‡æ ‡åŠ¨æ€è®¡ç®— |
| **ä¿æŠ¤æ—¶æœº**   | æ»åï¼ˆè¾¾åˆ°é˜ˆå€¼åï¼‰   | æå‰é¢„æµ‹ï¼Œé¢„é˜²æ€§ä¿æŠ¤ |
| **è°ƒæ•´ç­–ç•¥**   | å›ºå®šçš„é™çº§æ–¹æ¡ˆ       | åŸºäºè´Ÿè½½çš„åˆ†çº§è°ƒæ•´   |
| **æ¢å¤æœºåˆ¶**   | æ‰‹åŠ¨æˆ–å®šæ—¶æ¢å¤       | è‡ªåŠ¨ç›‘æµ‹ï¼Œé€æ­¥æ¢å¤   |
| **é…ç½®å¤æ‚åº¦** | é«˜ï¼ˆéœ€é’ˆå¯¹ä¸åŒåœºæ™¯ï¼‰ | ä½ï¼ˆè‡ªå­¦ä¹ è‡ªè°ƒæ•´ï¼‰   |

**2. è‡ªé€‚åº”ä¿æŠ¤çš„æ ¸å¿ƒæ€æƒ³**

```markdown
è‡ªé€‚åº”ä¿æŠ¤ = å®æ—¶ç›‘æ§ + æ™ºèƒ½å†³ç­– + åŠ¨æ€è°ƒæ•´ + è‡ªåŠ¨æ¢å¤
    â†“           â†“          â†“         â†“
ç³»ç»ŸæŒ‡æ ‡æ”¶é›†  çŠ¶æ€è¯„ä¼°ç®—æ³•  ä¿æŠ¤ç­–ç•¥æ‰§è¡Œ æ¢å¤æœºåˆ¶
```

### å…³é”®è¿è¡ŒæŒ‡æ ‡é‡‡é›†ä¸è¯„ä¼°

#### **1. å¤šç»´åº¦ç›‘æ§æŒ‡æ ‡**

```java
// ç³»ç»Ÿè¿è¡ŒæŒ‡æ ‡é‡‡é›†å™¨
@Component
public class SystemMetricsCollector {
    private final OperatingSystemMXBean osBean = 
        (OperatingSystemMXBean) ManagementFactory.getOperatingSystemMXBean();
    
    // åŸºç¡€ç³»ç»ŸæŒ‡æ ‡
    @Data
    @Builder
    public static class SystemMetrics {
        // CPUç›¸å…³æŒ‡æ ‡
        double cpuUsage;           // CPUä½¿ç”¨ç‡(0-1)
        double loadAverage1m;      // 1åˆ†é’Ÿè´Ÿè½½
        double loadAverage5m;      // 5åˆ†é’Ÿè´Ÿè½½
        double loadAverage15m;     // 15åˆ†é’Ÿè´Ÿè½½
        
        // å†…å­˜æŒ‡æ ‡
        double heapMemoryUsage;    // å †å†…å­˜ä½¿ç”¨ç‡
        double nonHeapMemoryUsage; // éå †å†…å­˜ä½¿ç”¨ç‡
        double directMemoryUsage;  // ç›´æ¥å†…å­˜ä½¿ç”¨ç‡
        
        // çº¿ç¨‹æŒ‡æ ‡
        int activeThreadCount;     // æ´»è·ƒçº¿ç¨‹æ•°
        int peakThreadCount;       // å³°å€¼çº¿ç¨‹æ•°
        int daemonThreadCount;     // å®ˆæŠ¤çº¿ç¨‹æ•°
        double threadCpuTime;      // çº¿ç¨‹CPUæ—¶é—´
        
        // GCæŒ‡æ ‡
        long gcCount;              // GCæ¬¡æ•°
        long gcTime;               // GCè€—æ—¶(ms)
        double gcOverhead;         // GCå¼€é”€æ¯”ä¾‹
        
        // ç½‘ç»œæŒ‡æ ‡
        double networkInBytes;     // ç½‘ç»œæµå…¥
        double networkOutBytes;    // ç½‘ç»œæµå‡º
        
        // æ–‡ä»¶ç³»ç»Ÿ
        double diskReadBytes;      // ç£ç›˜è¯»å–
        double diskWriteBytes;     // ç£ç›˜å†™å…¥
    }
    
    // åº”ç”¨ä¸šåŠ¡æŒ‡æ ‡
    @Data
    @Builder
    public static class ApplicationMetrics {
        // è¯·æ±‚é˜Ÿåˆ—æŒ‡æ ‡
        int requestQueueSize;      // ç­‰å¾…é˜Ÿåˆ—é•¿åº¦
        int requestQueueWaitTime;  // é˜Ÿåˆ—ç­‰å¾…æ—¶é—´(ms)
        double queueGrowthRate;    // é˜Ÿåˆ—å¢é•¿ç‡
        
        // å“åº”æ—¶é—´æŒ‡æ ‡
        double responseTimeAvg;    // å¹³å‡å“åº”æ—¶é—´
        double responseTimeP50;    // 50åˆ†ä½å“åº”æ—¶é—´
        double responseTimeP95;    // 95åˆ†ä½å“åº”æ—¶é—´
        double responseTimeP99;    // 99åˆ†ä½å“åº”æ—¶é—´
        double responseTimeStdDev; // å“åº”æ—¶é—´æ ‡å‡†å·®
        
        // ååé‡æŒ‡æ ‡
        double requestsPerSecond;  // RPS
        double errorRate;          // é”™è¯¯ç‡
        double successRate;        // æˆåŠŸç‡
        
        // è¶…æ—¶æŒ‡æ ‡
        int timeoutCount;          // è¶…æ—¶è¯·æ±‚æ•°
        double timeoutRate;        // è¶…æ—¶ç‡
        int slowRequestCount;      // æ…¢è¯·æ±‚æ•°
        
        // è¿æ¥æ± æŒ‡æ ‡
        int activeConnections;     // æ´»è·ƒè¿æ¥æ•°
        int idleConnections;       // ç©ºé—²è¿æ¥æ•°
        int totalConnections;      // æ€»è¿æ¥æ•°
        double connectionWaitTime; // è·å–è¿æ¥ç­‰å¾…æ—¶é—´
        
        // ç¼“å­˜æŒ‡æ ‡
        double cacheHitRate;       // ç¼“å­˜å‘½ä¸­ç‡
        double cacheMissRate;      // ç¼“å­˜æœªå‘½ä¸­ç‡
        int cacheEvictions;        // ç¼“å­˜æ·˜æ±°æ•°
    }
    
    // ç»¼åˆè´Ÿè½½è¯„åˆ†
    public double calculateLoadScore() {
        SystemMetrics sysMetrics = collectSystemMetrics();
        ApplicationMetrics appMetrics = collectApplicationMetrics();
        
        // åŠ æƒè®¡ç®—ç»¼åˆè´Ÿè½½åˆ†æ•°(0-1)
        double cpuScore = calculateCpuScore(sysMetrics) * 0.3;
        double memoryScore = calculateMemoryScore(sysMetrics) * 0.2;
        double queueScore = calculateQueueScore(appMetrics) * 0.25;
        double responseScore = calculateResponseScore(appMetrics) * 0.15;
        double errorScore = calculateErrorScore(appMetrics) * 0.1;
        
        return cpuScore + memoryScore + queueScore + 
               responseScore + errorScore;
    }
    
    // CPUè¯„åˆ†ç®—æ³•
    private double calculateCpuScore(SystemMetrics metrics) {
        double cpuUsage = metrics.getCpuUsage();
        double loadAvg = metrics.getLoadAverage1m();
        
        // ç»“åˆCPUä½¿ç”¨ç‡å’Œè´Ÿè½½
        double cpuScore = Math.min(cpuUsage * 1.5, 1.0);
        double loadScore = Math.min(loadAvg / osBean.getAvailableProcessors(), 1.0);
        
        return Math.max(cpuScore, loadScore);
    }
    
    // ç­‰å¾…é˜Ÿåˆ—è¯„åˆ†
    private double calculateQueueScore(ApplicationMetrics metrics) {
        int queueSize = metrics.getRequestQueueSize();
        int queueWaitTime = metrics.getRequestQueueWaitTime();
        double growthRate = metrics.getQueueGrowthRate();
        
        // é˜Ÿåˆ—é•¿åº¦è¯„åˆ†
        double sizeScore = Math.min(queueSize / 100.0, 1.0);
        
        // ç­‰å¾…æ—¶é—´è¯„åˆ†
        double timeScore = Math.min(queueWaitTime / 1000.0, 1.0);
        
        // å¢é•¿ç‡è¯„åˆ†
        double growthScore = Math.min(growthRate * 10, 1.0);
        
        return Math.max(Math.max(sizeScore, timeScore), growthScore);
    }
}
```

#### **2. æŒ‡æ ‡ç›‘æ§ç­–ç•¥**

```yaml
# è‡ªé€‚åº”ç›‘æ§é…ç½®
adaptive_monitoring:
  # ç›‘æ§é—´éš”
  intervals:
    fast: "1s"    # å¿«é€ŸæŒ‡æ ‡ï¼ˆCPUã€é˜Ÿåˆ—ç­‰ï¼‰
    normal: "5s"  # å¸¸è§„æŒ‡æ ‡ï¼ˆå“åº”æ—¶é—´ã€é”™è¯¯ç‡ï¼‰
    slow: "30s"   # æ…¢æŒ‡æ ‡ï¼ˆGCã€å†…å­˜è¶‹åŠ¿ï¼‰
  
  # æŒ‡æ ‡æƒé‡é…ç½®
  weights:
    cpu:
      usage: 0.4
      load_average: 0.4
      cpu_time: 0.2
      
    memory:
      heap: 0.5
      non_heap: 0.3
      direct: 0.2
      
    response:
      p95: 0.4
      p99: 0.4
      avg: 0.1
      std_dev: 0.1
      
    queue:
      size: 0.4
      wait_time: 0.4
      growth_rate: 0.2
      
    error:
      error_rate: 0.6
      timeout_rate: 0.4
  
  # å‘Šè­¦é˜ˆå€¼
  alert_thresholds:
    warning: 0.7   # è­¦å‘Šé˜ˆå€¼
    critical: 0.85  # ä¸¥é‡é˜ˆå€¼
    emergency: 0.95  # ç´§æ€¥é˜ˆå€¼
```



### ğŸ—ï¸ ä¸šç•Œå…¸å‹æ–¹æ¡ˆ

ä¸åŒå‚å•†å’Œå¼€æºç¤¾åŒºåŸºäºä¸Šè¿°åŸç†å®ç°äº†å„å…·ç‰¹è‰²çš„æ–¹æ¡ˆã€‚

- **å¾®ä¿¡ DAGOR**ï¼šåœ¨å¾®ä¿¡çš„å¤§è§„æ¨¡å¾®æœåŠ¡å®è·µä¸­ï¼ŒDAGORæ–¹æ¡ˆå¼ºè°ƒ**ä¸šåŠ¡æ— å…³æ€§**å’Œ**å»ä¸­å¿ƒåŒ–åä½œ**ã€‚å®ƒä½¿ç”¨è¯·æ±‚åœ¨é˜Ÿåˆ—ä¸­çš„**å¹³å‡ç­‰å¾…æ—¶é—´**ä½œä¸ºç»Ÿä¸€çš„è¿‡è½½æŒ‡æ ‡ï¼Œè€Œéä¸ä¸šåŠ¡é€»è¾‘è€¦åˆçš„å“åº”æ—¶é—´ã€‚åŒæ—¶ï¼Œå®ƒåˆ›æ–°åœ°å¼•å…¥äº†**ä¸šåŠ¡ä¼˜å…ˆçº§**å’Œ**ç”¨æˆ·ä¼˜å…ˆçº§**æ„æˆçš„äºŒç»´æ§åˆ¶å¹³é¢ï¼Œåœ¨è¿‡è½½æ—¶ä¼˜å…ˆä¿éšœé«˜ä¼˜å…ˆçº§ä¸šåŠ¡å’Œç”¨æˆ·ï¼ˆé€šè¿‡å®šæœŸå˜åŒ–çš„å“ˆå¸Œå‡½æ•°ä¿è¯ç”¨æˆ·é—´çš„å…¬å¹³æ€§ï¼‰ï¼Œå¹¶é€šè¿‡ä¸Šæ¸¸æœåŠ¡æ„ŸçŸ¥ä¸‹æ¸¸æœåŠ¡çš„å‡†å…¥ä¼˜å…ˆçº§ï¼Œé¿å…å°†æ— æ•ˆè¯·æ±‚å‘é€åˆ°è¿‡è½½ä¸‹æ¸¸ï¼Œæµªè´¹ç½‘ç»œèµ„æºã€‚
- **é˜¿é‡Œå·´å·´ Sentinel**ï¼šä½œä¸ºæµè¡Œçš„å¼€æºç»„ä»¶ï¼ŒSentinelæä¾›äº†**ç³»ç»Ÿè§„åˆ™ï¼ˆSystemRuleï¼‰** æ¥å®ç°è‡ªé€‚åº”ä¿æŠ¤ã€‚ä½ å¯ä»¥ç›´æ¥é…ç½®å¦‚`highestSystemLoad`ï¼ˆç³»ç»Ÿè´Ÿè½½ï¼‰ã€`highestCpuUsage`ï¼ˆCPUä½¿ç”¨ç‡ï¼‰ã€`avgRt`ï¼ˆå¹³å‡å“åº”æ—¶é—´ï¼‰ç­‰é˜ˆå€¼ï¼Œå½“ä»»ä½•è§„åˆ™è¢«è§¦å‘æ—¶ï¼ŒSentinelä¼šè‡ªåŠ¨å¯¹è¿›å…¥ç³»ç»Ÿçš„æ‰€æœ‰æµé‡è¿›è¡Œé™æµï¼Œèµ·åˆ°å…œåº•é˜²æŠ¤çš„ä½œç”¨ã€‚
- **é˜¿é‡Œäº‘ SAE è‡ªé€‚åº”è¿‡è½½ä¿æŠ¤**ï¼šåœ¨Serverlessåº”ç”¨å¼•æ“ä¸­ï¼Œè¯¥åŠŸèƒ½å°†**CPUä½¿ç”¨ç‡**ä½œä¸ºæ ¸å¿ƒä¾æ®ï¼Œè‡ªé€‚åº”åœ°è°ƒæ•´é™æµæ¯”ä¾‹ã€‚å®ƒæ”¯æŒâ€œæ¨¡æ‹Ÿæ‰§è¡Œâ€æ¨¡å¼ï¼Œå…è®¸ä½ åœ¨ä¸å®é™…å½±å“æµé‡çš„æƒ…å†µä¸‹è§‚å¯Ÿä¿æŠ¤æ•ˆæœï¼Œå†æ­£å¼å¼€å¯ï¼Œé™ä½äº†ä¸Šçº¿é£é™©ã€‚

### ğŸ’¡ å®è·µå»ºè®®

1. **é˜ˆå€¼è®¾å®š**ï¼šä¸è¦ç›²ç›®ä½¿ç”¨é»˜è®¤å€¼ã€‚é˜ˆå€¼åº”åŸºäºå¯¹è‡ªèº«æœåŠ¡çš„**å‹æµ‹æ•°æ®å’Œå†å²ç›‘æ§è¶‹åŠ¿**è¿›è¡Œè®¾å®šã€‚ä¾‹å¦‚ï¼Œé€šè¿‡å‹æµ‹æ‰¾åˆ°ç³»ç»Ÿçš„æœ€å¤§ç¨³å®šå¤„ç†èƒ½åŠ›ï¼Œç„¶åè®¾ç½®ä¸€ä¸ªç•™æœ‰å®‰å…¨ä½™åœ°çš„é˜ˆå€¼ã€‚
2. **ä¼˜å…ˆçº§è®¾è®¡**ï¼šå¯¹äºå¤æ‚ä¸šåŠ¡ç³»ç»Ÿï¼Œå‚è€ƒå¾®ä¿¡çš„å®è·µï¼Œå»ºç«‹æ¸…æ™°çš„**ä¸šåŠ¡ä¼˜å…ˆçº§çŸ©é˜µ**ï¼ˆå¦‚ç™»å½• > æ”¯ä»˜ > æ™®é€šæ¶ˆæ¯ > æœ‹å‹åœˆï¼‰ï¼Œç¡®ä¿åœ¨è¿‡è½½æ—¶æ ¸å¿ƒä¸šåŠ¡ä¸å—å½±å“ã€‚
3. **ä¸æ‰©å®¹ååŒ**ï¼šåœ¨Kubernetesç¯å¢ƒä¸­ï¼Œæ³¨æ„è‡ªé€‚åº”è¿‡è½½ä¿æŠ¤çš„CPUé˜ˆå€¼ï¼ˆå¦‚90%ï¼‰åº”ç•¥é«˜äºHPAï¼ˆæ°´å¹³Podè‡ªåŠ¨æ‰©ç¼©å®¹ï¼‰çš„é˜ˆå€¼ï¼ˆå¦‚80%ï¼‰ï¼Œè¿™æ ·è¿‡è½½ä¿æŠ¤å¯ä»¥åœ¨HPAæ‰©å®¹ä¸åŠæˆ–é›†ç¾¤èµ„æºä¸è¶³æ—¶ï¼Œä½œä¸ºæœ€åä¸€é“é˜²çº¿å‘æŒ¥ä½œç”¨ã€‚
4. **ç›‘æ§ä¸è§‚æµ‹**ï¼šåŠ¡å¿…é…ç½®å®Œå–„çš„ç›‘æ§é¢æ¿ï¼Œå®æ—¶è·Ÿè¸ª**CPUä½¿ç”¨ç‡ã€é˜Ÿåˆ—é•¿åº¦ã€å“åº”æ—¶é—´ã€è¿‡è½½ä¿æŠ¤è§¦å‘äº‹ä»¶**ç­‰å…³é”®æŒ‡æ ‡ï¼Œä»¥ä¾¿å¿«é€Ÿå®šä½é—®é¢˜å’Œä¼˜åŒ–ç­–ç•¥ã€‚







# ä¸­é—´ä»¶ï¼ˆredis/mysql/kafkaï¼‰

## **redisç›¸å…³**

- **åº”ç”¨-åŸºç¡€**ï¼šå¸¸è§æ•°æ®ç±»å‹ï¼Œæ€§èƒ½å’Œæ…¢æ“ä½œ bigkey/hotkeyï¼Œæ‰¹å¤„ç† pipeline
- **åº”ç”¨-ç¼“å­˜**ï¼šç¼“å­˜ç©¿é€/å‡»ç©¿/é›ªå´©çš„è§£å†³æ–¹æ¡ˆï¼Œè¿‡æœŸåˆ é™¤ç­–ç•¥ æƒ°æ€§/å®šæœŸï¼Œå†…å­˜æ·˜æ±°ç­–ç•¥ 8ç±» LRU/LFUï¼Œ
- **åº”ç”¨-å¹¶å‘è®¿é—®**ï¼šå•å‘½ä»¤INCR/DECRï¼ŒRedis-Luaï¼Œäº‹åŠ¡ACID MULTI/EXECï¼Œåˆ†å¸ƒå¼é” SETNX å¯¹æ¯”zk/consul
- **åº”ç”¨-æ¶ˆæ¯é˜Ÿåˆ—**ï¼šæ•°æ®ç±»å‹Listå’ŒStreamsï¼ŒPUB/SUBï¼Œæ¶ˆæ¯ç»„ XADD/XREADGROUP/XACK
- **ç³»ç»Ÿ-é«˜æ€§èƒ½**ï¼šçº¿ç¨‹æ¨¡å‹ å•çº¿ç¨‹ï¼ˆè§„é¿å¹¶å‘æ§åˆ¶ï¼‰ï¼Œæ•°æ®ç»“æ„ å‹ç¼©è¡¨/è·³è¡¨ï¼Œç½‘ç»œæ¡†æ¶ epollï¼Œå†…å­˜ç®¡ç† jemalloc
- **ç³»ç»Ÿ-é«˜å¯ç”¨**ï¼šå†—ä½™éƒ¨ç½² ä¸»ä»å¤åˆ¶ï¼ˆå‰¯æœ¬ï¼‰ï¼ŒæŒä¹…åŒ–æ–¹æ¡ˆ AOF/RDBï¼ŒHAé›†ç¾¤ å“¨å…µæœºåˆ¶ sentinel
- **ç³»ç»Ÿ-æ˜“æ‰©å±•**ï¼šå¯ä¼¸ç¼©æ€§ æ•°æ®åˆ†ç‰‡ï¼ˆåˆ†åŒºï¼‰ï¼Œè´Ÿè½½å‡è¡¡ï¼Œé›†ç¾¤æ–¹æ¡ˆ replication/sentinel/cluster



## **mysqlç›¸å…³**

- **åº”ç”¨-SQLä¼˜åŒ–**ï¼šæ‰§è¡Œè®¡åˆ’ explainï¼Œæ…¢SQLåˆ†æ mysqldumpslowï¼Œé“¾æ¥ç®¡ç† show processlist
- **åº”ç”¨-äº‹åŠ¡**ï¼šACIDï¼Œéš”ç¦»çº§åˆ« RC/RR è„è¯»/å¹»è¯»/ä¸å¯é‡å¤è¯»ï¼Œç‰ˆæœ¬æ§åˆ¶ MVCC
- **åº”ç”¨-é”æœºåˆ¶**ï¼šå…¨å±€é”/è¡¨é”/è¡Œé”ï¼Œè¡Œé—´é”
- **ç³»ç»Ÿ-é«˜æ€§èƒ½**ï¼šå­˜å‚¨å¼•æ“ InnoDBï¼Œç´¢å¼• B+æ ‘
- **ç³»ç»Ÿ-é«˜å¯ç”¨**ï¼šä¸»ä»å¤åˆ¶ åŒæ­¥/åŠåŒæ­¥/å¼‚æ­¥ï¼Œæ—¥å¿— binlog/redologï¼Œbinlogæ¨¡å¼ ROWã€è½ç›˜ç­–ç•¥
- **ç³»ç»Ÿ-å¯æ‰©å±•**ï¼šä¸šåŠ¡åˆ†ç¦»ã€è¯»å†™åˆ†ç¦»ã€åˆ†åº“åˆ†è¡¨/æ•°æ®åˆ†åŒºã€sharding
- **ç³»ç»Ÿ-å¯è¿è¥**ï¼šè®¤è¯æˆæƒã€SQLè¯¯æ“ä½œã€SQLæ³¨å…¥ã€å‚æ•°é…ç½®ã€ç›‘æ§æŒ‡æ ‡ã€æ’éšœè°ƒä¼˜ã€è®¡è´¹æ–¹æ¡ˆ





# **ä¸­é—´ä»¶-kafkaç›¸å…³**

## **åº”ç”¨-åŸºç¡€**

> ä¸»é¢˜Topic/åˆ†åŒºPartition/å‰¯æœ¬Replicaã€ç”Ÿäº§Producer/ä¸­è½¬Broker/æ¶ˆè´¹Consumerã€æ¶ˆæ¯Record/ä½ç§»Offset

Kafkaé€šè¿‡Topicç»„ç»‡æ¶ˆæ¯ï¼ŒPartitionå®ç°å¹¶è¡Œï¼ŒReplicaä¿è¯å¯é ï¼ŒProducerç”Ÿäº§ï¼ŒBrokerå­˜å‚¨ï¼ŒConsumeræ¶ˆè´¹ï¼ŒOffsetè®°å½•è¿›åº¦ï¼Œå…±åŒæ„æˆé«˜æ€§èƒ½åˆ†å¸ƒå¼æ¶ˆæ¯ç³»ç»Ÿã€‚

### æ ¸å¿ƒæ¶æ„ä¸€è§ˆ

```markdown
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Kafka é›†ç¾¤æ¶æ„                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Producer   â”‚   Broker    â”‚  Consumer   â”‚   ZK/KRaft  â”‚
â”‚  (ç”Ÿäº§è€…)   â”‚  (ä»£ç†èŠ‚ç‚¹) â”‚  (æ¶ˆè´¹è€…)   â”‚  (åè°ƒæœåŠ¡) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚             â”‚             â”‚
       â–¼             â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Topic: user-events                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Partition 0       Partition 1       Partition 2    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   P0    â”‚      â”‚   P1    â”‚      â”‚   P2    â”‚     â”‚
â”‚  â”‚ Leader  â”‚      â”‚ Leader  â”‚      â”‚ Leader  â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚   P0    â”‚      â”‚   P1    â”‚      â”‚   P2    â”‚     â”‚
â”‚  â”‚Follower â”‚      â”‚Follower â”‚      â”‚Follower â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚   P0    â”‚      â”‚   P1    â”‚      â”‚   P2    â”‚     â”‚
â”‚  â”‚Follower â”‚      â”‚Follower â”‚      â”‚Follower â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–²             â–²             â–²
       â”‚             â”‚             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
â”‚ Consumer A  â”‚ Consumer B  â”‚ Consumer C  â”‚
â”‚  (æ¶ˆè´¹P0)   â”‚  (æ¶ˆè´¹P1)   â”‚  (æ¶ˆè´¹P2)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```



### ä¸€ã€æ ¸å¿ƒä¸‰å¤§ä»¶

**Topicï¼ˆä¸»é¢˜ï¼‰**

- **æ˜¯ä»€ä¹ˆ**ï¼šæ¶ˆæ¯çš„é€»è¾‘åˆ†ç±»ï¼Œç±»ä¼¼æ•°æ®åº“çš„è¡¨
- **å…³é”®ç‚¹**ï¼šä¸€ä¸ªTopicå¯è¢«å¤šä¸ªç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä½¿ç”¨
- **ç¤ºä¾‹**ï¼š`user-login`ã€`order-created`ã€`payment-success`

**Partitionï¼ˆåˆ†åŒºï¼‰**

- **æ˜¯ä»€ä¹ˆ**ï¼šTopicçš„ç‰©ç†åˆ†ç‰‡ï¼Œ**å®ç°å¹¶è¡Œå¤„ç†**
- **å…³é”®ç‚¹**ï¼š
  - æ¯ä¸ªåˆ†åŒºæ˜¯**æœ‰åºçš„ã€ä¸å¯å˜**çš„æ¶ˆæ¯é˜Ÿåˆ—
  - æ¶ˆæ¯åœ¨åˆ†åŒºå†…æœ‰åºï¼Œå…¨å±€ä¸ä¸€å®šæœ‰åº
  - åˆ†åŒºæ•°å†³å®šæœ€å¤§å¹¶è¡Œåº¦
- **ç¤ºä¾‹**ï¼š`user-behavior`Topicæœ‰6ä¸ªåˆ†åŒºï¼ˆp0-p5ï¼‰

**Replicaï¼ˆå‰¯æœ¬ï¼‰**

- **æ˜¯ä»€ä¹ˆ**ï¼šåˆ†åŒºçš„å¤‡ä»½ï¼Œä¿è¯é«˜å¯ç”¨
- **å…³é”®ç‚¹**ï¼š
  - åŒ…å«1ä¸ªLeaderï¼ˆå¤„ç†è¯»å†™ï¼‰å’Œå¤šä¸ªFollowerï¼ˆåŒæ­¥æ•°æ®ï¼‰
  - ISRï¼ˆIn-Sync Replicasï¼‰ï¼šä¸LeaderåŒæ­¥çš„å‰¯æœ¬é›†åˆ
- **ç¤ºä¾‹**ï¼šå‰¯æœ¬å› å­=3ï¼Œè¡¨ç¤ºæ¯ä¸ªåˆ†åŒºæœ‰3ä¸ªå‰¯æœ¬

------

### äºŒã€æ•°æ®å¤„ç†ä¸‰è§’è‰²

**Producerï¼ˆç”Ÿäº§è€…ï¼‰**

- **èŒè´£**ï¼šå‘é€æ¶ˆæ¯åˆ°æŒ‡å®šTopic
- **å…³é”®è¡Œä¸º**ï¼š
  - å¯æŒ‡å®šåˆ†åŒºç­–ç•¥ï¼ˆé»˜è®¤Key Hashï¼‰
  - æ”¯æŒåŒæ­¥/å¼‚æ­¥å‘é€
  - å¯é…ç½®æ¶ˆæ¯å¯é æ€§ï¼ˆacks=0/1/allï¼‰

**Brokerï¼ˆä»£ç†/ä¸­é—´ä»¶ï¼‰**

> ç®¡ç†è€…

- **èŒè´£**ï¼šæ¶ˆæ¯å­˜å‚¨å’Œè½¬å‘çš„æœåŠ¡å™¨
- **å…³é”®åŠŸèƒ½**ï¼š
  - ç»„æˆKafkaé›†ç¾¤
  - å­˜å‚¨æ¶ˆæ¯åˆ°ç£ç›˜
  - å¤„ç†ç”Ÿäº§å’Œæ¶ˆè´¹è¯·æ±‚
  - ç®¡ç†å‰¯æœ¬åŒæ­¥

**Consumerï¼ˆæ¶ˆè´¹è€…ï¼‰**

- **èŒè´£**ï¼šä»Topicæ‹‰å–å¹¶å¤„ç†æ¶ˆæ¯
- **å…³é”®æ¦‚å¿µ**ï¼š
  - **Consumer Group**ï¼šä¸€ç»„åä½œçš„æ¶ˆè´¹è€…
  - **åˆ†åŒºåˆ†é…**ï¼šä¸€ä¸ªåˆ†åŒºåªèƒ½è¢«åŒç»„çš„ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ (é¿å…ç»„å†…é‡å¤æ¶ˆè´¹)
  - **Offsetæäº¤**ï¼šè®°å½•æ¶ˆè´¹ä½ç½®

------

### ä¸‰ã€æ¶ˆæ¯ä¸ä½ç½®ç®¡ç†

**Recordï¼ˆæ¶ˆæ¯/è®°å½•ï¼‰**

- **æ•°æ®ç»“æ„**ï¼š

  ```java
  // ç®€åŒ–è¡¨ç¤º
  class ProducerRecord {
      String topic;      // ä¸»é¢˜
      Integer partition; // åˆ†åŒºï¼ˆå¯é€‰ï¼‰
      Object key;        // é”®ï¼ˆå¯é€‰ï¼Œç”¨äºåˆ†åŒºï¼‰
      Object value;      // å€¼ï¼ˆå®é™…æ¶ˆæ¯ï¼‰
      Long timestamp;    // æ—¶é—´æˆ³
  }
  ```

**Offsetï¼ˆä½ç§»/åç§»é‡ï¼‰**

- **æ˜¯ä»€ä¹ˆ**ï¼šæ¶ˆæ¯åœ¨åˆ†åŒºä¸­çš„ä½ç½®æ ‡è¯†
- **å…³é”®ç‚¹**ï¼š
  - æ¯ä¸ªåˆ†åŒºç‹¬ç«‹ç»´æŠ¤Offset
  - æ¶ˆè´¹è€…æäº¤Offsetåˆ°`__consumer_offsets`ä¸»é¢˜
  - Offsetç±»å‹ï¼š
    - **Current Offset**ï¼šæ¶ˆè´¹è€…å½“å‰ä½ç½®
    - **Committed Offset**ï¼šå·²æäº¤ä½ç½®
    - **LEO**ï¼šæ—¥å¿—æœ«ç«¯Offset ï¼ˆåˆ†åŒºæœ€æ–°æ¶ˆæ¯ä½ç½®ï¼‰
    - **HW**ï¼šé«˜æ°´ä½çº¿ï¼ˆå·²æäº¤æ¶ˆæ¯è¾¹ç•Œï¼Œæ¶ˆè´¹è€…å¯è§ï¼‰

------

### å››ã€æ ¸å¿ƒå·¥ä½œåŸç†å›¾

```markdown
ç”Ÿäº§è€…å‘é€æµç¨‹ï¼š
Producer â†’ é€‰æ‹©Topic â†’ é€‰æ‹©åˆ†åŒº â†’ å‘é€åˆ°Broker â†’ å†™å…¥Leaderå‰¯æœ¬ â†’ åŒæ­¥åˆ°Follower

æ¶ˆè´¹è€…æ¶ˆè´¹æµç¨‹ï¼š
Consumer â†’ åŠ å…¥ç»„ â†’ åˆ†é…åˆ†åŒº â†’ æ‹‰å–æ¶ˆæ¯ â†’ å¤„ç†æ¶ˆæ¯ â†’ æäº¤Offset

æ•°æ®å­˜å‚¨ç»“æ„ï¼š
Topic: user-events
â”œâ”€â”€ Partition 0
â”‚   â”œâ”€â”€ Replica 0 (Leader)   [æ¶ˆæ¯0, æ¶ˆæ¯1, æ¶ˆæ¯2, ...]
â”‚   â”œâ”€â”€ Replica 1 (Follower) [åŒæ­¥ä¸­...]
â”‚   â””â”€â”€ Replica 2 (Follower) [åŒæ­¥ä¸­...]
â”œâ”€â”€ Partition 1
â””â”€â”€ Partition 2
```

------

### äº”ã€å¿«é€Ÿè®°å¿†è¦ç‚¹

1. **ä¸»é¢˜æ˜¯é€»è¾‘åˆ†ç±»ï¼Œåˆ†åŒºæ˜¯ç‰©ç†åˆ†ç‰‡**
2. **å‰¯æœ¬ä¿è¯é«˜å¯ç”¨ï¼ŒLeaderå¤„ç†è¯»å†™**
3. **ç”Ÿäº§è€…å‘æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…æ‹‰æ¶ˆæ¯**
4. **Brokeræ˜¯å­˜å‚¨å’Œè½¬å‘èŠ‚ç‚¹**
5. **Offsetæ ‡è®°æ¶ˆè´¹ä½ç½®ï¼Œåˆ†åŒºå†…æœ‰åº**
6. **æ¶ˆè´¹è€…ç»„å®ç°æ¨ªå‘æ‰©å±•**

### å…­ã€å¿«é€Ÿé—®ç­”

**Q: Topicå’ŒPartitionçš„å…³ç³»ï¼Ÿ**

A: Topicæ˜¯é€»è¾‘å®¹å™¨ï¼ŒPartitionæ˜¯ç‰©ç†åˆ†ç‰‡ã€‚ä¸€ä¸ªTopicæœ‰å¤šä¸ªPartitionå®ç°å¹¶è¡Œã€‚

**Q: å¦‚ä½•ä¿è¯æ¶ˆæ¯é¡ºåºï¼Ÿ**

A: åˆ†åŒºå†…æ¶ˆæ¯æœ‰åºã€‚è¦ä¿è¯å…¨å±€æœ‰åºï¼Œå¯è®¾ç½®å•åˆ†åŒºæˆ–ä½¿ç”¨ç›¸åŒKeyã€‚

**Q: æ¶ˆè´¹è€…ç»„çš„ä½œç”¨ï¼Ÿ**

A: å®ç°è´Ÿè½½å‡è¡¡å’Œå®¹é”™ã€‚ç»„å†…æ¶ˆè´¹è€…åä½œæ¶ˆè´¹ï¼Œä¸€ä¸ªåˆ†åŒºåªè¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ã€‚

**"æé«˜å¹¶è¡Œèƒ½åŠ›"æ˜¯æ•ˆæœï¼Œä¸æ˜¯è®¾è®¡ç›®çš„**ï¼š

- æ¶ˆè´¹è€…ç»„çš„è®¾è®¡åˆè¡·æ˜¯ï¼šåœ¨å¤šä¸ªæ¶ˆè´¹è€…å®ä¾‹é—´**å‡è¡¡åˆ†é…åˆ†åŒº**ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰ï¼Œå½“æŸä¸ªæ¶ˆè´¹è€…æ•…éšœæ—¶**è‡ªåŠ¨é‡æ–°åˆ†é…**ï¼ˆå®¹é”™ï¼‰
- å¹¶è¡Œæ¶ˆè´¹èƒ½åŠ›æå‡æ˜¯**è¿™ä¸ªæœºåˆ¶å¸¦æ¥çš„è‡ªç„¶ç»“æœ**ï¼Œè€Œä¸æ˜¯è®¾è®¡çš„ç¬¬ä¸€ç›®æ ‡

**Q: Offsetæäº¤å¤±è´¥ä¼šæ€æ ·ï¼Ÿ**

A: å¯èƒ½å¯¼è‡´é‡å¤æ¶ˆè´¹ã€‚å»ºè®®ä½¿ç”¨æ‰‹åŠ¨æäº¤å’Œå¹‚ç­‰å¤„ç†ã€‚

**Q: å‰¯æœ¬æ•°å¦‚ä½•è®¾ç½®ï¼Ÿ**

A: é€šå¸¸3å‰¯æœ¬ï¼ˆ1 Leader + 2 Followerï¼‰ï¼Œå¹³è¡¡å¯é æ€§å’Œæˆæœ¬ã€‚



## **åº”ç”¨-æ¶ˆæ¯æ¨¡å‹**

> æ¶ˆè´¹è€…ç»„Consumer Groupï¼Œç‚¹å¯¹ç‚¹æ¨¡å‹p2p vs å‘å¸ƒè®¢é˜…æ¨¡å‹pub/sub

### ä¸€ã€æ¶ˆè´¹è€…ç»„(Consumer Group) - Kafkaçš„æ ¸å¿ƒå¹¶å‘æ¨¡å‹

#### **1. æ¶ˆè´¹è€…ç»„å®šä¹‰**

```markdown
æ¶ˆè´¹è€…ç»„ = é€»è¾‘ä¸Šåä½œæ¶ˆè´¹çš„ä¸€ç»„æ¶ˆè´¹è€…å®ä¾‹
    â””â”€â”€ é€šè¿‡ç›¸åŒçš„ group.id æ ‡è¯†
```

**æ ¸å¿ƒè§„åˆ™**ï¼š

- æ¯ä¸ªåˆ†åŒºæœ€å¤šåªèƒ½è¢«**åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„å†…çš„ä¸€ä¸ªæ¶ˆè´¹è€…**æ¶ˆè´¹ï¼ˆå¯ä»¥rebalanceå†å‡è¡¡ï¼‰
- æ¶ˆè´¹è€…æ•°é‡ â‰¤ åˆ†åŒºæ•°é‡ï¼ˆå¤šä½™çš„æ¶ˆè´¹è€…ä¼šç©ºé—²ï¼‰
- æ¶ˆè´¹è€…ç»„ç‹¬ç«‹ç»´æŠ¤æ¶ˆè´¹ä½ç§»(offset)

```java
// åˆ›å»ºå±äº"order-group"æ¶ˆè´¹è€…ç»„çš„æ¶ˆè´¹è€…
Properties props = new Properties();
props.put("group.id", "order-group");  // å…³é”®æ ‡è¯†ç¬¦
KafkaConsumer<String, String> consumer = new KafkaConsumer<>(props);
```

> è§¦å‘å†å‡è¡¡çš„åœºæ™¯

ä»¥ä¸‹æƒ…å†µä¼šå‘ç”Ÿå†å‡è¡¡ï¼Œå¯¼è‡´åˆ†åŒºè¢«é‡æ–°åˆ†é…ï¼š

| è§¦å‘åœºæ™¯           | è¯´æ˜                                                         |
| ------------------ | ------------------------------------------------------------ |
| **æ¶ˆè´¹è€…åŠ å…¥ç¾¤ç»„** | å½“æœ‰æ–°çš„æ¶ˆè´¹è€…åŠ å…¥åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„æ—¶ï¼Œç³»ç»Ÿä¼šé‡æ–°åˆ†é…åˆ†åŒºï¼Œä»¥æœŸæœ›æ–°æˆå‘˜èƒ½åˆ†æ‹…è´Ÿè½½ ã€‚ |
| **æ¶ˆè´¹è€…ç¦»å¼€ç¾¤ç»„** | æ¶ˆè´¹è€…å´©æºƒã€è¢«å…³é—­ã€æˆ–ä¸»åŠ¨ç¦»å¼€ç»„ï¼ˆå¦‚åº”ç”¨é‡å¯ï¼‰ï¼Œå®ƒè´Ÿè´£çš„åˆ†åŒºä¼šè¢«é‡æ–°åˆ†é…ç»™ç»„å†…å…¶ä»–å­˜æ´»çš„æ¶ˆè´¹è€… ã€‚ |
| **è®¢é˜…ä¸»é¢˜å˜åŒ–**   | è®¢é˜…çš„ä¸»é¢˜æ•°é‡å‘ç”Ÿå˜åŒ–ï¼ˆä¾‹å¦‚ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è®¢é˜…ï¼Œè€Œæœ‰åŒ¹é…çš„æ–°ä¸»é¢˜åˆ›å»ºï¼‰ã€‚ |
| **ä¸»é¢˜åˆ†åŒºæ•°å˜åŒ–** | ç®¡ç†å‘˜å¢åŠ äº†æŸä¸ªä¸»é¢˜çš„åˆ†åŒºæ•°é‡ï¼Œæ–°å¢çš„åˆ†åŒºéœ€è¦è¢«åˆ†é…ç»™ç»„å†…çš„æ¶ˆè´¹è€… |

#### **2. æ¶ˆè´¹è€…ç»„å·¥ä½œåŸç†**

```markdown
Topic: order-events (3ä¸ªåˆ†åŒº, 3ä¸ªå‰¯æœ¬)
Partition 0 â”€â”€è¢«â”€â”€â†’ Consumer A (group.id="order-group")
Partition 1 â”€â”€è¢«â”€â”€â†’ Consumer B (group.id="order-group")  
Partition 2 â”€â”€è¢«â”€â”€â†’ Consumer C (group.id="order-group")

ç‰¹æ€§ï¼š
1. åˆ†åŒºåˆ†é…ï¼šGroup Coordinatorè‡ªåŠ¨åˆ†é…åˆ†åŒºç»™æ¶ˆè´¹è€…
2. è´Ÿè½½å‡è¡¡ï¼šæ–°å¢/ç§»é™¤æ¶ˆè´¹è€…æ—¶è§¦å‘é‡å¹³è¡¡(Rebalance)
3. å®¹é”™ï¼šæ¶ˆè´¹è€…æ•…éšœæ—¶ï¼Œåˆ†åŒºä¼šé‡æ–°åˆ†é…ç»™å…¶ä»–æ¶ˆè´¹è€…
```

### äºŒã€ç‚¹å¯¹ç‚¹æ¨¡å‹(P2P)å®ç°

#### **1. P2Pæ¨¡å¼æœ¬è´¨**

```markdown
ä¼ ç»ŸP2Pï¼šä¸€ä¸ªæ¶ˆæ¯åªè¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹
Kafkaå®ç°ï¼šé€šè¿‡å•æ¶ˆè´¹è€…ç»„æ¨¡æ‹ŸP2Pé˜Ÿåˆ—
// P2Pæ¨¡å¼é…ç½®ï¼šåªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…ç»„
props.put("group.id", "task-processor-group");

// æ•ˆæœï¼šæ¶ˆæ¯åœ¨ç»„å†…æ¶ˆè´¹è€…é—´ç«äº‰æ¶ˆè´¹
// ç±»ä¼¼ä¼ ç»Ÿæ¶ˆæ¯é˜Ÿåˆ—çš„Worker Queueæ¨¡å¼
```

**P2Pæ¨¡å¼ç‰¹ç‚¹**ï¼š

```markdown
ç”Ÿäº§è€… â”€â”€æ¶ˆæ¯â”€â”€â†’ Topic â”€â”€åˆ†å‘â”€â”€â†’ Consumer Group
                          (å•ç»„ç«äº‰æ¶ˆè´¹)
                        
âœ“ æ¶ˆæ¯ä¸ä¼šè¢«é‡å¤æ¶ˆè´¹
âœ“ æ”¯æŒæ¶ˆè´¹è€…æ°´å¹³æ‰©å±•
âœ“ å¤©ç„¶è´Ÿè½½å‡è¡¡
âœ“ ç±»ä¼¼RabbitMQçš„Work Queue
```

**é€‚ç”¨åœºæ™¯**ï¼š

- ä»»åŠ¡åˆ†å‘ç³»ç»Ÿ
- è®¢å•å¤„ç†é˜Ÿåˆ—
- å¼‚æ­¥è®¡ç®—ä»»åŠ¡
- éœ€è¦ä¿è¯æ¶ˆæ¯åªè¢«å¤„ç†ä¸€æ¬¡çš„åœºæ™¯



### ä¸‰ã€å‘å¸ƒè®¢é˜…æ¨¡å‹(Pub/Sub)å®ç°

#### **1. Pub/Subæ¨¡å¼æœ¬è´¨**

```markdown
ä¼ ç»ŸPub/Subï¼šæ¶ˆæ¯å¹¿æ’­ç»™æ‰€æœ‰è®¢é˜…è€…
Kafkaå®ç°ï¼šé€šè¿‡å¤šä¸ªæ¶ˆè´¹è€…ç»„å®ç°å¹¿æ’­
// æ”¯ä»˜æœåŠ¡ç»„
Properties paymentProps = new Properties();
paymentProps.put("group.id", "payment-service-group");
KafkaConsumer paymentConsumer = new KafkaConsumer(paymentProps);

// åº“å­˜æœåŠ¡ç»„
Properties stockProps = new Properties();  
stockProps.put("group.id", "stock-service-group");
KafkaConsumer stockConsumer = new KafkaConsumer(stockProps);

// æ—¥å¿—æœåŠ¡ç»„
Properties logProps = new Properties();
logProps.put("group.id", "log-service-group");  
KafkaConsumer logConsumer = new KafkaConsumer(logProps);

// æ‰€æœ‰ç»„éƒ½è®¢é˜…åŒä¸€ä¸ªTopic
paymentConsumer.subscribe(Arrays.asList("order-events"));
stockConsumer.subscribe(Arrays.asList("order-events"));
logConsumer.subscribe(Arrays.asList("order-events"));
```

**Pub/Subæ¨¡å¼ç‰¹ç‚¹**ï¼š

```markdown
ç”Ÿäº§è€… â”€â”€æ¶ˆæ¯â”€â”€â†’ Topic â”€â”€å¹¿æ’­â”€â”€â†’ Group 1 (æ”¯ä»˜æœåŠ¡)
                    â”œâ”€â”€å¹¿æ’­â”€â”€â†’ Group 2 (åº“å­˜æœåŠ¡)
                    â””â”€â”€å¹¿æ’­â”€â”€â†’ Group 3 (æ—¥å¿—æœåŠ¡)
                    
âœ“ æ¶ˆæ¯è¢«æ‰€æœ‰æ¶ˆè´¹è€…ç»„ç‹¬ç«‹æ¶ˆè´¹
âœ“ æ¶ˆè´¹è€…ç»„ä¹‹é—´å®Œå…¨ç‹¬ç«‹
âœ“ æ”¯æŒå¤šæ’­(Multicast)
âœ“ æœåŠ¡è§£è€¦
```

**é€‚ç”¨åœºæ™¯**ï¼š

- äº‹ä»¶é©±åŠ¨æ¶æ„
- å®æ—¶æ•°æ®ç®¡é“
- æ—¥å¿—æ”¶é›†ç³»ç»Ÿ
- å¤šä¸ªæœåŠ¡éœ€è¦ç›¸åŒæ•°æ®çš„åœºæ™¯



### å››ã€Kafkaæ¶ˆæ¯æ¨¡å‹å¯¹æ¯”è¡¨

| **ç‰¹æ€§**       | **ç‚¹å¯¹ç‚¹æ¨¡å¼(P2P)** | **å‘å¸ƒè®¢é˜…æ¨¡å¼(Pub/Sub)** | **Kafkaå®ç°æ–¹å¼**      |
| -------------- | ------------------- | ------------------------- | ---------------------- |
| **æ¶ˆè´¹å…³ç³»**   | ç«äº‰æ¶ˆè´¹            | å¹¿æ’­æ¶ˆè´¹                  | **ç»„å†…ç«äº‰ï¼Œç»„é—´å¹¿æ’­** |
| **æ¶ˆè´¹è€…ç»„**   | å•ä¸ªæ¶ˆè´¹è€…ç»„        | å¤šä¸ªæ¶ˆè´¹è€…ç»„              | é€šè¿‡group.idåŒºåˆ†       |
| **æ¶ˆæ¯å¯è§æ€§** | æ¶ˆæ¯åªè¢«æ¶ˆè´¹ä¸€æ¬¡    | æ¶ˆæ¯è¢«æ‰€æœ‰è®¢é˜…è€…æ¶ˆè´¹      | æ¶ˆè´¹è€…ç»„ç‹¬ç«‹ç»´æŠ¤offset |
| **æ‰©å±•æ€§**     | æ°´å¹³æ‰©å±•æ¶ˆè´¹è€…      | æ°´å¹³æ‰©å±•æ¶ˆè´¹è€…ç»„          | ä¸¤è€…éƒ½æ”¯æŒ             |
| **å…¸å‹åœºæ™¯**   | ä»»åŠ¡é˜Ÿåˆ—ã€RPCæ›¿ä»£   | äº‹ä»¶é€šçŸ¥ã€æ—¥å¿—æ”¶é›†        | æµå¤„ç†ã€å®æ—¶åˆ†æ       |
| **é…ç½®å…³é”®**   | ç›¸åŒçš„group.id      | ä¸åŒçš„group.id            | group.idå†³å®šæ¨¡å¼       |

### äº”ã€å®é™…åº”ç”¨ç¤ºä¾‹

**ç”µå•†ç³»ç»Ÿæ¶ˆæ¯æ¨¡å‹**

```java
// è®¢å•åˆ›å»ºäº‹ä»¶å¤„ç†
ProducerRecord<String, String> record = new ProducerRecord<>(
    "order-created",  // Topic
    orderId,          // Key
    orderJson         // Value
);
producer.send(record);

// ä¸åŒæœåŠ¡ä»¥ä¸åŒæ¨¡å¼æ¶ˆè´¹ï¼š
// 1. è®¢å•å¤„ç†æœåŠ¡(P2Pæ¨¡å¼) - ä¿è¯è®¢å•åªè¢«å¤„ç†ä¸€æ¬¡
props.put("group.id", "order-processor-group");

// 2. åº“å­˜æœåŠ¡(Pub/Subæ¨¡å¼) - éœ€è¦çŸ¥é“æ‰€æœ‰è®¢å•
props.put("group.id", "inventory-service-group");

// 3. é£æ§æœåŠ¡(Pub/Subæ¨¡å¼) - éœ€è¦åˆ†ææ‰€æœ‰è®¢å•
props.put("group.id", "risk-control-group");

// 4. å®æ—¶å¤§å±(Pub/Subæ¨¡å¼) - æ˜¾ç¤ºå®æ—¶æ•°æ®
props.put("group.id", "dashboard-group");
```

### å…­ã€æ ¸å¿ƒè¦ç‚¹æ€»ç»“

1. **æ¶ˆè´¹è€…ç»„æ˜¯Kafkaå¹¶å‘çš„åŸºç¡€å•ä½**ï¼Œç”±`group.id`æ ‡è¯†
2. **P2Pæ¨¡å¼**ï¼šä½¿ç”¨å•æ¶ˆè´¹è€…ç»„ï¼Œç»„å†…æ¶ˆè´¹è€…ç«äº‰æ¶ˆè´¹ï¼Œå®ç°è´Ÿè½½å‡è¡¡
3. **Pub/Subæ¨¡å¼**ï¼šä½¿ç”¨å¤šæ¶ˆè´¹è€…ç»„ï¼Œç»„é—´æ¶ˆæ¯å¹¿æ’­ï¼Œå®ç°æœåŠ¡è§£è€¦
4. **Kafkaçš„çµæ´»æ€§**ï¼šåŒä¸€ä¸ªTopicå¯åŒæ—¶æ”¯æŒä¸¤ç§æ¨¡å¼
5. **é€‰æ‹©ä¾æ®**ï¼š
   - éœ€è¦é¿å…é‡å¤å¤„ç† â†’ P2Pæ¨¡å¼
   - éœ€è¦å¹¿æ’­ç»™å¤šä¸ªæœåŠ¡ â†’ Pub/Subæ¨¡å¼
   - å¯åŒæ—¶ä½¿ç”¨ï¼šå…³é”®ä¸šåŠ¡ç”¨P2Pï¼Œç›‘æ§åˆ†æç”¨Pub/Sub

**ä¸€å¥è¯è®°å¿†**ï¼š

> **Kafkaç”¨æ¶ˆè´¹è€…ç»„å®ç°æ¶ˆæ¯æ¨¡å‹ï¼šç›¸åŒgroup.idæ˜¯P2Pï¼ˆç«äº‰æ¶ˆè´¹ï¼‰ï¼Œä¸åŒgroup.idæ˜¯Pub/Subï¼ˆå¹¿æ’­æ¶ˆè´¹ï¼‰ã€‚**



## **åº”ç”¨-æ¶ˆæ¯é˜Ÿåˆ—ç‰¹æ€§**

> æ¶ˆæ¯å¯é æ€§ï¼ˆä¸ä¸¢æ¶ˆæ¯ï¼‰ã€æ¶ˆæ¯é¡ºåºæ€§ã€æ¶ˆæ¯å”¯ä¸€æ€§

### ä¸€ã€æ¶ˆæ¯å¯é æ€§ï¼šå¦‚ä½•ä¿è¯ä¸ä¸¢æ¶ˆæ¯

#### **1. æ¶ˆæ¯ä¼ é€’çš„ä¸‰ä¸ªé˜¶æ®µå¯é æ€§ä¿è¯**

```markdown
ç”Ÿäº§è€…å‘é€ â†’ Brokerå­˜å‚¨ â†’ æ¶ˆè´¹è€…æ¶ˆè´¹
   å¯é æ€§          å¯é æ€§        å¯é æ€§
```

#### **2. ç”Ÿäº§è€…å¯é æ€§é…ç½®**

```java
// å…³é”®é…ç½®ï¼šackså‚æ•°ï¼ˆæœ€æ ¸å¿ƒçš„å¯é æ€§é…ç½®ï¼‰
Properties props = new Properties();
props.put("acks", "all");  // æœ€å¼ºå¯é æ€§

// ackså‚æ•°è¯¦è§£ï¼š
// 0: å‘é€å³å¿˜ï¼ˆå¯èƒ½ä¸¢å¤±ï¼‰
// 1: Leaderå†™å…¥å³è¿”å›ï¼ˆå¯èƒ½ä¸¢å¤±ï¼‰
// all: æ‰€æœ‰ISRå‰¯æœ¬å†™å…¥æ‰è¿”å›ï¼ˆæœ€å¯é ï¼‰
```

**ç”Ÿäº§è€…å®Œæ•´å¯é æ€§é…ç½®**ï¼š

```java
// é«˜å¯é æ€§ç”Ÿäº§è€…é…ç½®
Properties producerProps = new Properties();
producerProps.put("bootstrap.servers", "localhost:9092");
producerProps.put("acks", "all");                    // 1. ç­‰å¾…æ‰€æœ‰ISRç¡®è®¤
producerProps.put("retries", Integer.MAX_VALUE);     // 2. æ— é™é‡è¯•
producerProps.put("max.in.flight.requests.per.connection", 1);  // 3. å•è¿æ¥
producerProps.put("enable.idempotence", true);       // 4. å¼€å¯å¹‚ç­‰æ€§
producerProps.put("compression.type", "snappy");     // 5. å‹ç¼©ï¼ˆå‡å°‘ç½‘ç»œé”™è¯¯ï¼‰
producerProps.put("delivery.timeout.ms", 120000);    // 6. å‘é€è¶…æ—¶2åˆ†é’Ÿ
producerProps.put("request.timeout.ms", 30000);      // 7. è¯·æ±‚è¶…æ—¶30ç§’
producerProps.put("linger.ms", 5);                   // 8. æ‰¹æ¬¡ç­‰å¾…5ms

KafkaProducer<String, String> producer = new KafkaProducer<>(producerProps);

// åŒæ­¥å‘é€ç¡®ä¿å¯é æ€§
try {
    RecordMetadata metadata = producer.send(record).get();
    System.out.println("æ¶ˆæ¯å‘é€æˆåŠŸ: " + metadata.toString());
} catch (Exception e) {
    // è®°å½•å¤±è´¥ï¼Œå¯å­˜å…¥æœ¬åœ°æ•°æ®åº“é‡è¯•
    saveToRetryQueue(record);
}
```



#### **3. Brokerå¯é æ€§é…ç½®**

```yaml
# brokeré…ç½®ï¼šserver.properties
# å‰¯æœ¬ç›¸å…³
unclean.leader.election.enable=false  # ç¦æ­¢è„é€‰ä¸¾
min.insync.replicas=2                 # æœ€å°åŒæ­¥å‰¯æœ¬æ•°
replication.factor=3                  # å‰¯æœ¬å› å­
default.replication.factor=3

# åˆ·ç›˜ç­–ç•¥
log.flush.interval.messages=10000     # æ¯10000æ¡åˆ·ç›˜
log.flush.interval.ms=1000            # æ¯ç§’åˆ·ç›˜
log.flush.scheduler.interval.ms=2000  # åˆ·ç›˜è°ƒåº¦é—´éš”

# æ•°æ®ä¿ç•™
log.retention.hours=168               # ä¿ç•™7å¤©
log.segment.bytes=1073741824          # 1GBåˆ†æ®µ
log.retention.check.interval.ms=300000  # 5åˆ†é’Ÿæ£€æŸ¥
```

**ISRæœºåˆ¶ä¿è¯å¯é æ€§**ï¼š

```java
// ISRï¼ˆIn-Sync Replicasï¼‰å·¥ä½œæœºåˆ¶
class ISRMechanism {
    // ISR = ä¸Leaderä¿æŒåŒæ­¥çš„å‰¯æœ¬é›†åˆ
    // å†™å…¥æ¡ä»¶ï¼šacks=allæ—¶ï¼Œéœ€è¦æ‰€æœ‰ISRå‰¯æœ¬ç¡®è®¤
    
    void writeWithHighReliability(Record record) {
        // 1. Leaderå†™å…¥æœ¬åœ°
        leaderLog.append(record);
        
        // 2. ç­‰å¾…ISRä¸­æ‰€æœ‰FolloweråŒæ­¥
        for (Replica follower : isrReplicas) {
            follower.replicate(record);
        }
        
        // 3. æ‰€æœ‰ISRç¡®è®¤åï¼Œæ›´æ–°é«˜æ°´ä½çº¿(HW)
        updateHighWatermark();
        
        // 4. è¿”å›æˆåŠŸç»™ç”Ÿäº§è€…
        return success;
    }
}
```

#### **4. æ¶ˆè´¹è€…å¯é æ€§é…ç½®**

```java
// æ¶ˆè´¹è€…å¯é æ€§é…ç½®
Properties consumerProps = new Properties();
consumerProps.put("bootstrap.servers", "localhost:9092");
consumerProps.put("group.id", "reliable-consumer");
consumerProps.put("enable.auto.commit", "false");  // å…³é”®ï¼šå…³é—­è‡ªåŠ¨æäº¤
consumerProps.put("auto.offset.reset", "earliest");  // ä»æœ€æ—©å¼€å§‹
consumerProps.put("isolation.level", "read_committed");  // åªè¯»å·²æäº¤æ¶ˆæ¯

KafkaConsumer<String, String> consumer = new KafkaConsumer<>(consumerProps);
consumer.subscribe(Arrays.asList("reliable-topic"));

while (true) {
    ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(100));
    
    try {
        for (ConsumerRecord<String, String> record : records) {
            // å¤„ç†æ¶ˆæ¯
            boolean success = processMessage(record);
            
            if (success) {
                // å¤„ç†æˆåŠŸï¼Œè®°å½•ä½ç§»
                offsets.put(
                    new TopicPartition(record.topic(), record.partition()),
                    new OffsetAndMetadata(record.offset() + 1)
                );
            } else {
                // å¤„ç†å¤±è´¥ï¼Œä¸æäº¤ä½ç§»ï¼Œç­‰å¾…é‡è¯•
                log.error("å¤„ç†å¤±è´¥: {}", record);
                // å¯è®°å½•åˆ°æ­»ä¿¡é˜Ÿåˆ—
                sendToDLQ(record);
            }
        }
        
        // æ‰¹é‡æäº¤ä½ç§»ï¼ˆåŒæ­¥æäº¤ä¿è¯å¯é æ€§ï¼‰
        if (!offsets.isEmpty()) {
            consumer.commitSync(offsets);
        }
        
    } catch (Exception e) {
        // å¼‚å¸¸æ—¶ä¸æäº¤ä½ç§»ï¼Œä¸‹æ¬¡ä¼šé‡æ–°æ¶ˆè´¹
        log.error("æ¶ˆè´¹å¼‚å¸¸ï¼Œä½ç§»æœªæäº¤", e);
    }
}
```

### äºŒã€æ¶ˆæ¯é¡ºåºæ€§ï¼šå¦‚ä½•ä¿è¯æ¶ˆæ¯æœ‰åº

#### **1. Kafkaé¡ºåºæ€§ä¿è¯çº§åˆ«**

```markdown
å…¨å±€æœ‰åºï¼šâŒ ä¸æ”¯æŒï¼ˆæ€§èƒ½ä»£ä»·å¤ªé«˜ï¼‰
åˆ†åŒºæœ‰åºï¼šâœ… å¤©ç„¶ä¿è¯ï¼ˆæ ¸å¿ƒç‰¹æ€§ï¼‰
ä¼šè¯æœ‰åºï¼šâœ… å¯é€šè¿‡Keyå®ç°
```

#### **2. åˆ†åŒºå†…é¡ºåºæ€§ä¿è¯**

```java
// åˆ†åŒºå†…å¤©ç„¶æœ‰åºç¤ºä¾‹
// å‘é€åˆ°åŒä¸€åˆ†åŒºçš„æ¶ˆæ¯ä¿è¯é¡ºåº
producer.send(new ProducerRecord<>("topic", "same-key", "msg1"));
producer.send(new ProducerRecord<>("topic", "same-key", "msg2"));
producer.send(new ProducerRecord<>("topic", "same-key", "msg3"));

// æ¶ˆè´¹è€…æ¥æ”¶é¡ºåºï¼šmsg1 â†’ msg2 â†’ msg3
```

**é…ç½®å‚æ•°å¯¹é¡ºåºæ€§çš„å½±å“**ï¼š

```java
// ä¿è¯é¡ºåºæ€§çš„ç”Ÿäº§è€…é…ç½®
Properties orderProps = new Properties();
orderProps.put("max.in.flight.requests.per.connection", 1);  // å…³é”®ï¼šå•è¿æ¥
orderProps.put("retries", Integer.MAX_VALUE);
orderProps.put("acks", "all");
orderProps.put("enable.idempotence", true);

// è¯´æ˜ï¼š
// 1. max.in.flight.requests.per.connection=1
//    ç¡®ä¿åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªè¯·æ±‚åœ¨ä¼ è¾“ï¼Œé¿å…ä¹±åº
// 2. enable.idempotence=true
//    å¹‚ç­‰ç”Ÿäº§è€…ï¼Œé‡è¯•æ—¶ä¸ä¼šäº§ç”Ÿé‡å¤æ¶ˆæ¯
```

#### **3. ä¸šåŠ¡çº§é¡ºåºæ€§å®ç°**

```java
// åœºæ™¯ï¼šä¿è¯åŒä¸€ç”¨æˆ·çš„æ“ä½œé¡ºåº
public class UserOrderGuarantee {
    
    // ä½¿ç”¨ç”¨æˆ·IDä½œä¸ºKeyï¼Œç¡®ä¿åŒä¸€ç”¨æˆ·çš„æ¶ˆæ¯åˆ°åŒä¸€åˆ†åŒºï¼ˆç”Ÿäº§è€…ä¿è¯ï¼‰
    public void sendUserMessage(String userId, String action) {
        ProducerRecord<String, String> record = new ProducerRecord<>(
            "user-actions",
            userId,  // Keyå†³å®šåˆ†åŒº
            action
        );
        producer.send(record);
    }
    
    // æ¶ˆè´¹è€…ï¼šæ¯ä¸ªç”¨æˆ·çš„æ¶ˆæ¯æŒ‰é¡ºåºå¤„ç†ï¼ˆæ¶ˆè´¹è€…ä¿è¯ï¼‰
    public void consumeWithOrder() {
        Map<String, Queue<ConsumerRecord>> userQueues = new ConcurrentHashMap<>();
        
        while (true) {
            ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(100));
            
            // 1. æŒ‰ç”¨æˆ·åˆ†ç»„
            for (ConsumerRecord<String, String> record : records) {
                String userId = record.key();
                userQueues.computeIfAbsent(userId, k -> new ConcurrentLinkedQueue<>())
                         .add(record);
            }
            
            // 2. æŒ‰ç”¨æˆ·é¡ºåºå¤„ç†
            for (Map.Entry<String, Queue<ConsumerRecord>> entry : userQueues.entrySet()) {
                String userId = entry.getKey();
                Queue<ConsumerRecord> queue = entry.getValue();
                
                // å•çº¿ç¨‹å¤„ç†åŒä¸€ç”¨æˆ·çš„æ¶ˆæ¯
                synchronized (userId.intern()) {  // ä½¿ç”¨userIdä½œä¸ºé”
                    while (!queue.isEmpty()) {
                        ConsumerRecord record = queue.poll();
                        processUserMessage(userId, record.value());
                    }
                }
            }
        }
    }
}
```

#### **4. å…¨å±€æœ‰åºçš„æ›¿ä»£æ–¹æ¡ˆï¼ˆå•åˆ†åŒºtopicï¼‰**

```java
// æ–¹æ¡ˆ1ï¼šå•åˆ†åŒºTopicï¼ˆç®€å•ä½†æ€§èƒ½æœ‰é™ï¼‰
// åˆ›å»ºåªæœ‰ä¸€ä¸ªåˆ†åŒºçš„Topic
kafka-topics --create --topic global-ordered \
  --partitions 1 --replication-factor 3

// æ–¹æ¡ˆ2ï¼šä¸šåŠ¡å±‚å®ç°å…¨å±€åºåˆ—å·
public class GlobalSequenceProducer {
    private AtomicLong sequence = new AtomicLong(0);
    
    public void sendWithSequence(String message) {
        long seq = sequence.incrementAndGet();
        ProducerRecord<String, String> record = new ProducerRecord<>(
            "global-topic",
            null,  // ä¸æŒ‡å®šKeyï¼Œè½®è¯¢åˆ°ä¸åŒåˆ†åŒº
            seq + "|" + message  // æ·»åŠ åºåˆ—å·å‰ç¼€
        );
        producer.send(record);
    }
}

// æ¶ˆè´¹è€…ç«¯æ’åº
public class GlobalSequenceConsumer {
    private TreeMap<Long, String> buffer = new TreeMap<>();
    private long expectedSequence = 1;
    
    public void consumeAndOrder() {
        while (true) {
            ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(100));
            
            for (ConsumerRecord<String, String> record : records) {
                String[] parts = record.value().split("\\|", 2);
                long seq = Long.parseLong(parts[0]);
                String message = parts[1];
                
                buffer.put(seq, message);
                
                // æŒ‰é¡ºåºå¤„ç†
                while (buffer.containsKey(expectedSequence)) {
                    processMessage(buffer.remove(expectedSequence));
                    expectedSequence++;
                }
            }
        }
    }
}
```

### ä¸‰ã€æ¶ˆæ¯å”¯ä¸€æ€§ï¼šå¦‚ä½•é¿å…é‡å¤æ¶ˆæ¯

#### **1. äº§ç”Ÿé‡å¤çš„åŸå› **

```markdown
é‡å¤åœºæ™¯ï¼š
1. ç”Ÿäº§è€…é‡è¯• â†’ ç½‘ç»œè¶…æ—¶åé‡å¤å‘é€
2. æ¶ˆè´¹è€…é‡å¯ â†’ ä½ç§»æäº¤å‰å´©æºƒï¼Œé‡æ–°æ¶ˆè´¹
3. Brokeræ•…éšœ â†’ Leaderåˆ‡æ¢å¯èƒ½å¯¼è‡´é‡å¤
```

#### **2. ç”Ÿäº§è€…å¹‚ç­‰æ€§**

```java
// å¼€å¯ç”Ÿäº§è€…å¹‚ç­‰æ€§
Properties idempotentProps = new Properties();
idempotentProps.put("enable.idempotence", "true");  // å¼€å¯å¹‚ç­‰
idempotentProps.put("acks", "all");
idempotentProps.put("retries", Integer.MAX_VALUE);
idempotentProps.put("max.in.flight.requests.per.connection", 5);

// å¹‚ç­‰æ€§åŸç†ï¼š
// Kafkaä¸ºæ¯ä¸ªç”Ÿäº§è€…åˆ†é…PIDï¼ˆProducer IDï¼‰
// æ¯ä¸ªæ¶ˆæ¯æœ‰åºåˆ—å·ï¼ˆSequence Numberï¼‰
// Brokerä¼šæ£€æŸ¥å¹¶æ‹’ç»é‡å¤çš„åºåˆ—å·
```

**å¹‚ç­‰ç”Ÿäº§è€…å·¥ä½œåŸç†**ï¼š

```java
class IdempotentProducer {
    // æ¯ä¸ªç”Ÿäº§è€…æœ‰å”¯ä¸€PID
    private long producerId;
    // æ¯ä¸ªåˆ†åŒºç»´æŠ¤åºåˆ—å·
    private Map<TopicPartition, Integer> sequenceNumbers = new HashMap<>();
    
    boolean sendIdempotent(Record record, TopicPartition tp) {
        int seq = sequenceNumbers.getOrDefault(tp, 0);
        
        // æ¶ˆæ¯åŒ…å«PIDã€åˆ†åŒºã€åºåˆ—å·
        ProducerBatch batch = new ProducerBatch(tp, producerId, seq);
        
        // Brokerç«¯æ£€æŸ¥
        if (broker.hasDuplicate(producerId, tp, seq)) {
            return false;  // æ‹’ç»é‡å¤æ¶ˆæ¯
        }
        
        sequenceNumbers.put(tp, seq + 1);
        return true;
    }
}
```

#### **3. äº‹åŠ¡æ”¯æŒExactly-Once**

```java
// Kafkaäº‹åŠ¡é…ç½®
Properties transactionalProps = new Properties();
transactionalProps.put("bootstrap.servers", "localhost:9092");
transactionalProps.put("transactional.id", "my-transactional-id");  // äº‹åŠ¡ID
transactionalProps.put("enable.idempotence", "true");

KafkaProducer<String, String> producer = new KafkaProducer<>(transactionalProps);

// åˆå§‹åŒ–äº‹åŠ¡
producer.initTransactions();

try {
    // å¼€å§‹äº‹åŠ¡
    producer.beginTransaction();
    
    // å‘é€æ¶ˆæ¯
    producer.send(new ProducerRecord<>("topic1", "key1", "value1"));
    producer.send(new ProducerRecord<>("topic2", "key2", "value2"));
    
    // æ¶ˆè´¹è€…-ç”Ÿäº§è€…æ¨¡å¼ï¼šè¯»å–-å¤„ç†-å†™å…¥
    ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(100));
    Map<TopicPartition, OffsetAndMetadata> offsets = new HashMap<>();
    
    for (ConsumerRecord<String, String> record : records) {
        // å¤„ç†æ¶ˆæ¯
        String result = process(record.value());
        
        // å‘é€å¤„ç†ç»“æœ
        producer.send(new ProducerRecord<>("output-topic", record.key(), result));
        
        // è®°å½•ä½ç§»
        offsets.put(
            new TopicPartition(record.topic(), record.partition()),
            new OffsetAndMetadata(record.offset() + 1)
        );
    }
    
    // æäº¤äº‹åŠ¡ï¼ˆåŒ…å«ä½ç§»æäº¤ï¼‰
    producer.sendOffsetsToTransaction(offsets, "consumer-group-id");
    producer.commitTransaction();
    
} catch (Exception e) {
    // å›æ»šäº‹åŠ¡
    producer.abortTransaction();
    throw e;
}
```



#### **4. æ¶ˆè´¹è€…ç«¯å»é‡ç­–ç•¥**

```java
// æ–¹æ¡ˆ1ï¼šæ•°æ®åº“å”¯ä¸€çº¦æŸå»é‡
public class DatabaseDeduplication {
    public void consumeWithDeduplication(ConsumerRecord record) {
        String messageId = generateMessageId(record);
        
        // å°è¯•æ’å…¥ï¼Œåˆ©ç”¨å”¯ä¸€çº¦æŸ
        try {
            jdbcTemplate.update(
                "INSERT INTO consumed_messages (message_id, topic, partition, offset) VALUES (?, ?, ?, ?)",
                messageId, record.topic(), record.partition(), record.offset()
            );
            
            // æ’å…¥æˆåŠŸï¼Œå¤„ç†æ¶ˆæ¯
            processMessage(record.value());
            
        } catch (DuplicateKeyException e) {
            // é‡å¤æ¶ˆæ¯ï¼Œè·³è¿‡
            log.info("æ¶ˆæ¯å·²å¤„ç†: {}", messageId);
        }
    }
    
    private String generateMessageId(ConsumerRecord record) {
        return String.format("%s-%d-%d", 
            record.topic(), record.partition(), record.offset());
    }
}

// æ–¹æ¡ˆ2ï¼šRediså¸ƒéš†è¿‡æ»¤å™¨
public class BloomFilterDeduplication {
    private BloomFilter<String> bloomFilter;
    
    public BloomFilterDeduplication() {
        this.bloomFilter = BloomFilter.create(
            Funnels.stringFunnel(Charset.defaultCharset()),
            1000000,  // é¢„æœŸå…ƒç´ æ•°é‡
            0.01      // è¯¯åˆ¤ç‡1%
        );
    }
    
    public boolean isDuplicate(ConsumerRecord record) {
        String id = record.topic() + ":" + record.partition() + ":" + record.offset();
        
        if (bloomFilter.mightContain(id)) {
            return true;  // å¯èƒ½é‡å¤
        } else {
            bloomFilter.put(id);
            return false;  // ä¸é‡å¤
        }
    }
}

// æ–¹æ¡ˆ3ï¼šæœ¬åœ°ç¼“å­˜+å®šæœŸæ¸…ç†
public class LocalCacheDeduplication {
    private Map<String, Long> processedMessages = new ConcurrentHashMap<>();
    private ScheduledExecutorService cleaner = Executors.newScheduledThreadPool(1);
    
    public LocalCacheDeduplication() {
        // æ¯5åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡
        cleaner.scheduleAtFixedRate(this::cleanup, 5, 5, TimeUnit.MINUTES);
    }
    
    public boolean isDuplicate(ConsumerRecord record) {
        String key = buildKey(record);
        return processedMessages.containsKey(key);
    }
    
    public void markAsProcessed(ConsumerRecord record) {
        String key = buildKey(record);
        processedMessages.put(key, System.currentTimeMillis());
    }
    
    private void cleanup() {
        long cutoff = System.currentTimeMillis() - 3600000;  // 1å°æ—¶å‰
        processedMessages.entrySet().removeIf(entry -> entry.getValue() < cutoff);
    }
}
```

### å››ã€ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µé…ç½®

#### **å¯é æ€§é…ç½®æ¨¡æ¿**

```yaml
# ç”Ÿäº§è€…é«˜å¯é æ€§é…ç½®
producer:
  acks: "all"
  retries: 2147483647
  max.in.flight.requests.per.connection: 1
  enable.idempotence: true
  compression.type: "snappy"
  delivery.timeout.ms: 120000
  
# æ¶ˆè´¹è€…é«˜å¯é æ€§é…ç½®  
consumer:
  enable.auto.commit: false
  auto.offset.reset: "earliest"
  isolation.level: "read_committed"
  max.poll.records: 500
  session.timeout.ms: 10000
  
# Brokeré«˜å¯é æ€§é…ç½®
broker:
  unclean.leader.election.enable: false
  min.insync.replicas: 2
  replication.factor: 3
  log.flush.interval.messages: 10000
  log.flush.interval.ms: 1000
```

#### **é¡ºåºæ€§é…ç½®æ¨¡æ¿**

```yaml
# éœ€è¦ä¸¥æ ¼é¡ºåºçš„åœºæ™¯
strict_ordering:
  producer:
    max.in.flight.requests.per.connection: 1
    retries: 2147483647
    enable.idempotence: true
    acks: "all"
    
  consumer:
    max.poll.records: 1  # æ¯æ¬¡æ‹‰å–ä¸€æ¡ï¼Œé¿å…æ‰¹é‡å¤„ç†ä¹±åº
    fetch.min.bytes: 1
    fetch.max.wait.ms: 100
    
  topic:
    partitions: 1  # å•åˆ†åŒºä¿è¯å…¨å±€é¡ºåº
    replication.factor: 3
```

#### **å”¯ä¸€æ€§é…ç½®æ¨¡æ¿**

```yaml
# ç²¾ç¡®ä¸€æ¬¡è¯­ä¹‰é…ç½®
exactly_once:
  producer:
    transactional.id: "app-transactional-id"
    enable.idempotence: true
    acks: "all"
    
  consumer:
    isolation.level: "read_committed"
    enable.auto.commit: false
    
  application:
    deduplication:
      type: "transactional"  # æˆ– "database", "redis", "local"
      window_hours: 24
```

### äº”ã€ç›‘æ§ä¸éªŒè¯

**å…³é”®ç›‘æ§æŒ‡æ ‡**

```bash
# æ£€æŸ¥æ¶ˆæ¯ç§¯å‹
kafka-consumer-groups --bootstrap-server localhost:9092 \
  --group my-group --describe

# æ£€æŸ¥å‰¯æœ¬åŒæ­¥çŠ¶æ€
kafka-topics --bootstrap-server localhost:9092 \
  --topic my-topic --describe

# æ£€æŸ¥äº‹åŠ¡çŠ¶æ€
kafka-transactions --bootstrap-server localhost:9092 --list
```

**éªŒè¯å·¥å…·**

```java
// æ¶ˆæ¯å¯é æ€§éªŒè¯å·¥å…·
public class ReliabilityValidator {
    public void validateNoMessageLoss(String topic, int expectedCount) {
        long startOffset = getEarliestOffset(topic);
        long endOffset = getLatestOffset(topic);
        long actualCount = endOffset - startOffset;
        
        if (actualCount < expectedCount) {
            throw new RuntimeException("æ¶ˆæ¯ä¸¢å¤±: é¢„æœŸ" + expectedCount + 
                                     "ï¼Œå®é™…" + actualCount);
        }
    }
    
    public void validateOrdering(String topic) {
        List<ConsumerRecord> records = consumeAllMessages(topic);
        Map<Integer, List<Long>> partitions = new HashMap<>();
        
        for (ConsumerRecord record : records) {
            partitions.computeIfAbsent(record.partition(), k -> new ArrayList<>())
                     .add(record.offset());
        }
        
        // æ£€æŸ¥æ¯ä¸ªåˆ†åŒºå†…offsetæ˜¯å¦é€’å¢
        for (Map.Entry<Integer, List<Long>> entry : partitions.entrySet()) {
            List<Long> offsets = entry.getValue();
            for (int i = 1; i < offsets.size(); i++) {
                if (offsets.get(i) <= offsets.get(i - 1)) {
                    throw new RuntimeException("åˆ†åŒº" + entry.getKey() + "æ¶ˆæ¯ä¹±åº");
                }
            }
        }
    }
}
```

### å…­ã€æ€»ç»“å¯¹æ¯”è¡¨

| **ç‰¹æ€§**       | **å¯é æ€§**                     | **é¡ºåºæ€§**                       | **å”¯ä¸€æ€§**                   |
| -------------- | ------------------------------ | -------------------------------- | ---------------------------- |
| **æ ¸å¿ƒé…ç½®**   | acks=all min.insync.replicasâ‰¥2 | max.in.flight.requests=1ï¼Œå•åˆ†åŒº | enable.idempotence=true äº‹åŠ¡ |
| **ç”Ÿäº§è€…ä¿è¯** | ç­‰å¾…ISRç¡®è®¤ æ— é™é‡è¯•           | å•è¿æ¥å‘é€ ç›¸åŒKey               | å¹‚ç­‰æ€§ åºåˆ—å·                |
| **Brokerä¿è¯** | å¤šå‰¯æœ¬ ISRæœºåˆ¶                 | åˆ†åŒºå†…æœ‰åºå­˜å‚¨                   | æ‹’ç»é‡å¤åºåˆ—å·               |
| **æ¶ˆè´¹è€…ä¿è¯** | **æ‰‹åŠ¨æäº¤ä½ç§»** ä»å¤±è´¥å¤„æ¢å¤  | **å•çº¿ç¨‹æ¶ˆè´¹** æŒ‰Keyåˆ†ç»„         | äº‹åŠ¡è¯»å– å»é‡æœºåˆ¶            |
| **é€‚ç”¨åœºæ™¯**   | é‡‘èäº¤æ˜“ è®¢å•çŠ¶æ€              | çŠ¶æ€æœºå˜æ›´ æµæ°´è®°å½•              | ç²¾ç¡®è®¡æ•° è´¢åŠ¡å¯¹è´¦            |

### ä¸ƒã€æ ¸å¿ƒè¦ç‚¹æ€»ç»“

1. **å¯é æ€§**ï¼šé€šè¿‡`acks=all`+ `min.insync.replicasâ‰¥2`+ æ‰‹åŠ¨æäº¤ä½ç§»ä¿è¯
2. **é¡ºåºæ€§**ï¼šåˆ†åŒºå†…å¤©ç„¶æœ‰åºï¼Œé€šè¿‡ç›¸åŒKeyä¿è¯ä¸šåŠ¡æœ‰åºï¼Œé…ç½®`max.in.flight.requests=1`é¿å…ä¹±åº
3. **å”¯ä¸€æ€§**ï¼šå¼€å¯å¹‚ç­‰æ€§`enable.idempotence=true`ï¼Œä½¿ç”¨äº‹åŠ¡å®ç°ç²¾ç¡®ä¸€æ¬¡è¯­ä¹‰
4. **æƒè¡¡**ï¼šå¯é æ€§/é¡ºåºæ€§/å”¯ä¸€æ€§ä¸ååé‡/å»¶è¿Ÿéœ€è¦æƒè¡¡ï¼Œæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©
5. **ç›‘æ§**ï¼šå¿…é¡»ç›‘æ§æ¶ˆè´¹è€…ç§¯å‹(LAG)ã€å‰¯æœ¬åŒæ­¥çŠ¶æ€ã€äº‹åŠ¡çŠ¶æ€

**ä¸€å¥è¯è®°å¿†**ï¼š

> **å¯é æ€§é ç¡®è®¤æœºåˆ¶ï¼Œé¡ºåºæ€§é åˆ†åŒºå’ŒKeyï¼Œå”¯ä¸€æ€§é å¹‚ç­‰å’Œäº‹åŠ¡ï¼Œä¸‰è€…ç»“åˆå®ç°ä¼ä¸šçº§æ¶ˆæ¯é˜Ÿåˆ—ã€‚**



## **åº”ç”¨-æµè®¡ç®—**

> åˆ†å¸ƒå¼æµå¹³å°Kafka Streams

### ä¸€ã€Kafka Streams æ˜¯ä»€ä¹ˆï¼Ÿ

**ä¸€å¥è¯å®šä¹‰**ï¼šKafkaåŸç”Ÿçš„**è½»é‡çº§æµå¤„ç†åº“**ï¼Œè®©ä½ ç”¨ç¼–å†™æ™®é€šåº”ç”¨çš„æ–¹å¼å®ç°å®æ—¶æ•°æ®å¤„ç†ã€‚

**æ ¸å¿ƒå®šä½**

```java
// ä¸æ˜¯ç‹¬ç«‹æ¡†æ¶ï¼Œè€Œæ˜¯å®¢æˆ·ç«¯åº“
Properties props = new Properties();
props.put(StreamsConfig.APPLICATION_ID_CONFIG, "wordcount-app");
props.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");

// åˆ›å»ºStreamsBuilder
StreamsBuilder builder = new StreamsBuilder();
```

### äºŒã€æ ¸å¿ƒæ¶æ„ä¸ç‰¹æ€§

#### **1. æ¶æ„ç‰¹ç‚¹**

```markdown
æœ¬åœ°å¤„ç†ï¼šæ¯ä¸ªåº”ç”¨å®ä¾‹ç‹¬ç«‹å¤„ç†ï¼Œæ— ä¸­å¿ƒèŠ‚ç‚¹
è‡ªåŠ¨æ‰©å±•ï¼šå¢åŠ å®ä¾‹è‡ªåŠ¨è´Ÿè½½å‡è¡¡
å®¹é”™æœºåˆ¶ï¼šåŸºäºKafka Consumer Groupå®ç°
çŠ¶æ€ç®¡ç†ï¼šå†…ç½®RocksDBçŠ¶æ€å­˜å‚¨
```

#### **2. å…³é”®ä¼˜åŠ¿**

- âœ… **é›¶ä¾èµ–**ï¼šåªéœ€Kafkaé›†ç¾¤ï¼Œæ— éœ€é¢å¤–ç»„ä»¶
- âœ… **Exactly-Onceè¯­ä¹‰**ï¼šåŸç”Ÿæ”¯æŒç²¾ç¡®ä¸€æ¬¡å¤„ç†
- âœ… **äº‹ä»¶æ—¶é—´å¤„ç†**ï¼šæ”¯æŒä¹±åºäº‹ä»¶å’Œè¿Ÿåˆ°æ•°æ®
- âœ… **äº¤äº’å¼æŸ¥è¯¢**ï¼šå¯æŸ¥è¯¢å®æ—¶çŠ¶æ€

### ä¸‰ã€æ ¸å¿ƒæ¦‚å¿µ

#### **1. æµ(Stream) vs è¡¨(Table)**

```java
// Streamï¼šä¸å¯å˜äº‹ä»¶æµ
KStream<String, String> textLines = builder.stream("text-topic");

// Tableï¼šå¯å˜çš„ç‰©åŒ–è§†å›¾
KTable<String, Long> wordCounts = textLines
    .flatMapValues(textLine -> Arrays.asList(textLine.toLowerCase().split("\\W+")))
    .groupBy((key, word) -> word)
    .count();
```

#### **2. å¤„ç†æ‹“æ‰‘(Topology)**

```java
// å®šä¹‰å¤„ç†é€»è¾‘
Topology topology = builder.build();

// å¯è§†åŒ–æ‹“æ‰‘
System.out.println(topology.describe());
// è¾“å‡ºï¼š
// Topologies:
//    Sub-topology: 0
//      Source: KSTREAM-SOURCE-0000000000 (topics: [text-topic])
//      Processor: KSTREAM-FLATMAPVALUES-0000000001
//      Processor: KSTREAM-AGGREGATE-0000000002
//      Sink: KSTREAM-SINK-0000000003 (topic: wordcount-output)
```

### å››ã€æ ¸å¿ƒAPIä½¿ç”¨

#### **1. åŸºç¡€è½¬æ¢æ“ä½œ**

```java
// 1. è¿‡æ»¤
KStream<String, String> filtered = stream.filter((key, value) -> value.length() > 5);

// 2. æ˜ å°„
KStream<String, Integer> mapped = stream.mapValues(value -> value.length());

// 3. åˆ†æ”¯
KStream<String, String>[] branches = stream.branch(
    (key, value) -> value.startsWith("A"),  // åˆ†æ”¯1
    (key, value) -> value.startsWith("B"),  // åˆ†æ”¯2
    (key, value) -> true                    // é»˜è®¤åˆ†æ”¯
);

// 4. åˆå¹¶
KStream<String, String> merged = stream1.merge(stream2);
```

#### **2. èšåˆä¸çª—å£**

```java
// æ—¶é—´çª—å£èšåˆ
KStream<String, Double> windowed = stream
    .groupByKey()
    .windowedBy(TimeWindows.of(Duration.ofMinutes(5)))  // 5åˆ†é’Ÿçª—å£
    .aggregate(
        () -> 0.0,  // åˆå§‹å€¼
        (key, value, aggregate) -> aggregate + 1,  // ç´¯åŠ å™¨
        Materialized.as("windowed-count-store")
    )
    .toStream()
    .map((windowedKey, count) -> new KeyValue<>(
        windowedKey.key(),
        count / 5.0  // è®¡ç®—æ¯åˆ†é’Ÿå¹³å‡å€¼
    ));
```

#### **3. Joinæ“ä½œ**

```java
// Stream-Stream Joinï¼ˆæ»‘åŠ¨çª—å£ï¼‰
KStream<String, Order> orders = builder.stream("orders");
KStream<String, Payment> payments = builder.stream("payments");

KStream<String, OrderPayment> joined = orders.join(
    payments,
    (order, payment) -> new OrderPayment(order, payment),  // ValueJoiner
    JoinWindows.of(Duration.ofMinutes(5)),  // 5åˆ†é’Ÿçª—å£
    StreamJoined.with(Serdes.String(), Serdes.serdeFrom(Order.class), Serdes.serdeFrom(Payment.class))
);

// Stream-Table Join
KTable<String, UserProfile> userProfiles = builder.table("user-profiles");
KStream<String, EnrichedOrder> enriched = orders.join(
    userProfiles,
    (order, profile) -> new EnrichedOrder(order, profile)
);
```

### äº”ã€çŠ¶æ€ç®¡ç†ä¸å®¹é”™

#### **1. çŠ¶æ€å­˜å‚¨**

```java
// å®šä¹‰çŠ¶æ€å­˜å‚¨
StoreBuilder<KeyValueStore<String, Long>> countStore = Stores.keyValueStoreBuilder(
    Stores.persistentKeyValueStore("word-count-store"),
    Serdes.String(),
    Serdes.Long()
);

// åœ¨æ‹“æ‰‘ä¸­æ³¨å†Œ
builder.addStateStore(countStore);

// ä½¿ç”¨çŠ¶æ€å¤„ç†å™¨
stream.transform(() -> new Processor<String, String>() {
    private KeyValueStore<String, Long> store;
    
    @Override
    public void init(ProcessorContext context) {
        store = (KeyValueStore<String, Long>) context.getStateStore("word-count-store");
    }
    
    @Override
    public void process(String key, String value) {
        Long count = store.get(key);
        if (count == null) count = 0L;
        store.put(key, count + 1);
    }
}, "word-count-store");
```

#### **2. äº¤äº’å¼æŸ¥è¯¢**

```java
// å¯åŠ¨Streamsåº”ç”¨
KafkaStreams streams = new KafkaStreams(builder.build(), props);
streams.start();

// æŸ¥è¯¢çŠ¶æ€å­˜å‚¨
ReadOnlyKeyValueStore<String, Long> queryableStore = 
    streams.store("word-count-store", QueryableStoreTypes.keyValueStore());

// æŸ¥è¯¢ç‰¹å®škey
Long count = queryableStore.get("hello");
System.out.println("Count for 'hello': " + count);

// èŒƒå›´æŸ¥è¯¢
KeyValueIterator<String, Long> range = queryableStore.all();
while (range.hasNext()) {
    KeyValue<String, Long> next = range.next();
    System.out.println(next.key + ": " + next.value);
}
```

### å…­ã€Exactly-Onceè¯­ä¹‰

#### **é…ç½®ç²¾ç¡®ä¸€æ¬¡å¤„ç†**

```java
Properties props = new Properties();
props.put(StreamsConfig.PROCESSING_GUARANTEE_CONFIG, StreamsConfig.EXACTLY_ONCE_V2);
props.put(StreamsConfig.COMMIT_INTERVAL_MS_CONFIG, 100);  // æ›´é¢‘ç¹çš„æäº¤

// äº‹åŠ¡é…ç½®
props.put(StreamsConfig.producerPrefix(ProducerConfig.TRANSACTIONAL_ID_CONFIG), 
          "streams-app-transaction");
props.put(StreamsConfig.producerPrefix(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG), 
          "true");
```

### ä¸ƒã€ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ

#### **1. åº”ç”¨é…ç½®**

```yaml
# application.properties
application.id: order-processing-v1
bootstrap.servers: kafka1:9092,kafka2:9092,kafka3:9092
processing.guarantee: exactly_once_v2
num.stream.threads: 4
state.dir: /data/kafka-streams-state
replication.factor: 3
cache.max.bytes.buffering: 10485760
commit.interval.ms: 100
```

#### **2. ç›‘æ§æŒ‡æ ‡**

```bash
# å…³é”®ç›‘æ§æŒ‡æ ‡
kafka.streams:type=stream-metrics,client-id=*
  - commit-latency-avg
  - poll-latency-avg
  - process-latency-avg
  - task-closed-rate
  - task-created-rate

kafka.streams:type=stream-state-metrics,client-id=*
  - put-latency-avg
  - get-latency-avg
```

#### **3. æ•…éšœå¤„ç†**

```java
// è®¾ç½®æœªæ•è·å¼‚å¸¸å¤„ç†å™¨
streams.setUncaughtExceptionHandler((thread, throwable) -> {
    log.error("Streams thread died", throwable);
    // 1. è®°å½•é”™è¯¯
    // 2. å‘é€å‘Šè­¦
    // 3. å†³å®šæ˜¯å¦é‡å¯
    return StreamsUncaughtExceptionHandler.StreamThreadExceptionResponse.SHUTDOWN_APPLICATION;
});

// çŠ¶æ€ç›‘å¬å™¨
streams.setStateListener((newState, oldState) -> {
    log.info("çŠ¶æ€å˜æ›´: {} -> {}", oldState, newState);
    if (newState == KafkaStreams.State.ERROR) {
        // å¤„ç†é”™è¯¯çŠ¶æ€
    }
});
```

### å…«ã€å…¸å‹åº”ç”¨åœºæ™¯

#### **1. å®æ—¶ç›‘æ§å‘Šè­¦**

```java
// æ£€æµ‹å¼‚å¸¸æ¨¡å¼
stream
    .filter((key, metric) -> metric.getValue() > THRESHOLD)
    .groupByKey()
    .windowedBy(TimeWindows.of(Duration.ofMinutes(1)))
    .count()
    .filter((windowedKey, count) -> count >= 3)  // 1åˆ†é’Ÿå†…è§¦å‘3æ¬¡
    .toStream()
    .map((windowedKey, count) -> new KeyValue<>(
        windowedKey.key(),
        new Alert(windowedKey.key(), "é˜ˆå€¼å‘Šè­¦", count)
    ))
    .to("alerts-topic");
```

#### **2. å®æ—¶ç”¨æˆ·ç”»åƒ**

```java
// åˆå¹¶å¤šæ•°æ®æºæ„å»ºç”¨æˆ·ç”»åƒ
KStream<String, PageView> pageViews = builder.stream("page-views");
KStream<String, ClickEvent> clicks = builder.stream("click-events");
KTable<String, UserProfile> profiles = builder.table("user-profiles");

// å®æ—¶æ›´æ–°ç”¨æˆ·å…´è¶£
KTable<String, UserInterest> interests = pageViews
    .join(profiles, (view, profile) -> new UserView(view, profile))
    .groupBy((userId, userView) -> userId)
    .aggregate(
        UserInterest::new,
        (userId, userView, interest) -> interest.addView(userView.getPage()),
        Materialized.as("user-interest-store")
    );
```

### ä¹ã€ä¸Flink/Sparkå¯¹æ¯”

| **ç»´åº¦**     | **Kafka Streams**   | **Apache Flink**       | **Spark Streaming**          |
| ------------ | ------------------- | ---------------------- | ---------------------------- |
| **éƒ¨ç½²**     | åµŒå…¥åº”ç”¨ï¼Œæ— é›†ç¾¤    | ç‹¬ç«‹é›†ç¾¤               | éœ€è¦Sparké›†ç¾¤                |
| **API**      | DSL + Processor API | DataStream/DataSet API | DStream/Structured Streaming |
| **çŠ¶æ€**     | å†…ç½®RocksDB         | å†…å­˜/ RocksDB          | éœ€è¦å¤–éƒ¨å­˜å‚¨                 |
| **å®¹é”™**     | åŸºäºKafka           | Checkpointæœºåˆ¶         | åŸºäºRDD Lineage              |
| **å»¶è¿Ÿ**     | æ¯«ç§’çº§              | æ¯«ç§’çº§                 | ç§’çº§                         |
| **é€‚ç”¨åœºæ™¯** | Kafkaæ•°æ®å®æ—¶å¤„ç†   | å¤æ‚äº‹ä»¶å¤„ç†           | å¾®æ‰¹å¤„ç†åˆ†æ                 |

### åã€æ ¸å¿ƒè¦ç‚¹æ€»ç»“

1. **è½»é‡çº§åº“**ï¼šéç‹¬ç«‹æ¡†æ¶ï¼ŒåµŒå…¥Javaåº”ç”¨ä½¿ç”¨
2. **Exactly-Once**ï¼šåŸç”Ÿæ”¯æŒç²¾ç¡®ä¸€æ¬¡è¯­ä¹‰
3. **çŠ¶æ€ç®¡ç†**ï¼šå†…ç½®RocksDBï¼Œæ”¯æŒäº¤äº’å¼æŸ¥è¯¢
4. **è‡ªåŠ¨æ‰©å±•**ï¼šåŸºäºConsumer Groupè‡ªåŠ¨è´Ÿè½½å‡è¡¡
5. **æµè¡¨äºŒå…ƒæ€§**ï¼šStreamå’ŒTableå¯äº’ç›¸è½¬æ¢
6. **ä½å»¶è¿Ÿ**ï¼šæ¯«ç§’çº§å®æ—¶å¤„ç†
7. **æ— ç¼é›†æˆ**ï¼šä¸Kafkaç”Ÿæ€å®Œç¾èåˆ

**é€‚ç”¨åœºæ™¯**ï¼š

- âœ… å®æ—¶ETLå’Œæ•°æ®ç®¡é“
- âœ… å®æ—¶ç›‘æ§å’Œå‘Šè­¦
- âœ… å®æ—¶ç”¨æˆ·è¡Œä¸ºåˆ†æ
- âœ… å®æ—¶æ¨èç³»ç»Ÿ
- âœ… å¤æ‚äº‹ä»¶å¤„ç†(CEP)

**ä¸é€‚ç”¨åœºæ™¯**ï¼š

- âŒ éœ€è¦å¤æ‚æœºå™¨å­¦ä¹ 
- âŒ éœ€è¦è·¨æ•°æ®æºè”åˆåˆ†æ
- âŒ æ‰¹å¤„ç†å’Œå†å²æ•°æ®åˆ†æ

**ä¸€å¥è¯è®°å¿†**ï¼š

> **Kafka Streamsæ˜¯KafkaåŸç”Ÿçš„æµå¤„ç†åº“ï¼Œè®©ä½ ç”¨ç¼–å†™æ™®é€šJavaåº”ç”¨çš„æ–¹å¼å®ç°æ¯«ç§’çº§å®æ—¶æ•°æ®å¤„ç†ï¼Œç‰¹åˆ«é€‚åˆKafkaæ•°æ®å®æ—¶è½¬æ¢å’Œåˆ†æåœºæ™¯ã€‚**





## **ç³»ç»Ÿ-é«˜æ€§èƒ½**

> ç£ç›˜é¡ºåºè¯»å†™/é›¶æ‹·è´æœºåˆ¶ç­‰ï¼Œé‡å¹³è¡¡Rebalanceï¼Œæ¶ˆæ¯å»¶è¿Ÿå’Œå †ç§¯

### ä¸€ã€ç£ç›˜é¡ºåºè¯»å†™ï¼šæ€§èƒ½åŸºçŸ³

#### **1. é¡ºåºè¯»å†™ vs éšæœºè¯»å†™**

```bash
# æ€§èƒ½å¯¹æ¯”ï¼ˆæœºæ¢°ç¡¬ç›˜ï¼‰
é¡ºåºè¯»å†™: 100-200 MB/s
éšæœºè¯»å†™: 0.5-2 MB/s
å·®è·: 50-100å€

# Kafkaè®¾è®¡ç†å¿µ
"æ—¥å¿—å°±æ˜¯æ—¥å¿—ï¼Œä¸æ˜¯æ•°æ®åº“"
â†’ åªè¿½åŠ (Append-Only)å†™å…¥
â†’ é¡ºåºè¯»å†™æœ€å¤§åŒ–ç£ç›˜åå
```

#### **2. åˆ†æ®µå­˜å‚¨æœºåˆ¶**

```java
// ç‰©ç†å­˜å‚¨ç»“æ„
class LogSegment {
    // æ¯ä¸ªSegmentå›ºå®šå¤§å°ï¼ˆé»˜è®¤1GBï¼‰
    long baseOffset;      // èµ·å§‹åç§»é‡
    File logFile;        // .log æ–‡ä»¶ï¼ˆæ¶ˆæ¯æ•°æ®ï¼‰
    File indexFile;      // .index æ–‡ä»¶ï¼ˆç¨€ç–ç´¢å¼•ï¼‰
    File timeIndexFile;  // .timeindex æ–‡ä»¶ï¼ˆæ—¶é—´ç´¢å¼•ï¼‰
    
    // å†™å…¥æµç¨‹ï¼šçº¯é¡ºåºè¿½åŠ 
    void append(RecordBatch batch) {
        // 1. è¿½åŠ åˆ°.logæ–‡ä»¶ï¼ˆé¡ºåºå†™ï¼‰
        logFile.append(batch.bytes);
        
        // 2. æ¯å†™å…¥4KBå»ºç«‹ä¸€æ¡ç¨€ç–ç´¢å¼•
        if (shouldIndex()) {
            // æ ¼å¼ï¼šoffset(8å­—èŠ‚) + position(4å­—èŠ‚)
            indexFile.append(offset, position);
        }
        
        // 3. å»ºç«‹æ—¶é—´ç´¢å¼•
        timeIndexFile.append(timestamp, offset);
    }
}
```

**åˆ†æ®µä¼˜åŠ¿**ï¼š

```markdown
âœ… é¡ºåºå†™å…¥ï¼šæ–°æ¶ˆæ¯è¿½åŠ åˆ°æ´»è·ƒæ®µ
âœ… å¿«é€Ÿåˆ é™¤ï¼šæ•´ä¸ªæ®µä¸€æ¬¡æ€§åˆ é™¤
âœ… ç‹¬ç«‹ç´¢å¼•ï¼šæ¯ä¸ªæ®µæœ‰ç‹¬ç«‹ç´¢å¼•æ–‡ä»¶
âœ… å¹¶è¡Œæ¸…ç†ï¼šæ—§æ®µæ¸…ç†ä¸å½±å“æ–°æ®µå†™å…¥
```

#### **3. é¡µç¼“å­˜ä¼˜åŒ–**

```java
// åˆ©ç”¨æ“ä½œç³»ç»Ÿé¡µç¼“å­˜
class PageCacheOptimization {
    // Kafkaä¸ç»´æŠ¤å†…å­˜ç¼“å­˜ï¼Œå®Œå…¨ä¾èµ–OSé¡µç¼“å­˜
    // è¯»æµç¨‹ï¼šå†…æ ¸ç©ºé—´ç›´æ¥è¯»å–
    void readMessage(long offset) {
        // 1. è®¡ç®—æ–‡ä»¶ä½ç½®
        long position = index.lookup(offset);
        
        // 2. è°ƒç”¨read()ç³»ç»Ÿè°ƒç”¨
        //    å¦‚æœæ•°æ®åœ¨é¡µç¼“å­˜ â†’ é›¶æ‹·è´è¿”å›
        //    å¦‚æœä¸åœ¨é¡µç¼“å­˜ â†’ ä»ç£ç›˜è¯»å–åˆ°é¡µç¼“å­˜
        byte[] data = file.read(position, size);
    }
    
    // å†™æµç¨‹ï¼šå†™å…¥é¡µç¼“å­˜åç«‹å³è¿”å›
    void writeMessage(byte[] data) {
        // 1. å†™å…¥é¡µç¼“å­˜ï¼ˆå†…å­˜æ“ä½œï¼‰
        pageCache.write(data);
        
        // 2. å¼‚æ­¥åˆ·ç›˜
        //    Linux pdflushçº¿ç¨‹è´Ÿè´£åˆ·ç›˜
        //    å¯é…ç½®åˆ·ç›˜ç­–ç•¥
    }
}
```

**é¡µç¼“å­˜é…ç½®**ï¼š

```bash
# æ“ä½œç³»ç»Ÿé…ç½®å»ºè®®
# 1. å¢åŠ é¡µç¼“å­˜å¤§å°
echo 80 > /proc/sys/vm/dirty_ratio
echo 60 > /proc/sys/vm/dirty_background_ratio

# 2. è°ƒæ•´åˆ·ç›˜ç­–ç•¥
echo "1000" > /proc/sys/vm/dirty_expire_centisecs
echo "500" > /proc/sys/vm/dirty_writeback_centisecs

# 3. ä½¿ç”¨noatimeæŒ‚è½½é€‰é¡¹
mount -o noatime /dev/sdb /kafka
```

### äºŒã€é›¶æ‹·è´æœºåˆ¶ï¼šç½‘ç»œä¼ è¾“ä¼˜åŒ–

#### **1. ä¼ ç»Ÿæ–‡ä»¶ä¼ è¾“æµç¨‹**

```java
// ä¼ ç»Ÿæ–¹å¼ï¼š4æ¬¡æ‹·è´ + 4æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢
class TraditionalFileTransfer {
    void sendFile(Socket socket, File file) {
        // 1. ç£ç›˜ â†’ å†…æ ¸ç¼“å†²åŒº (DMAæ‹·è´)
        FileChannel fileChannel = new FileInputStream(file).getChannel();
        ByteBuffer buffer = ByteBuffer.allocate(1024);
        
        while (fileChannel.read(buffer) != -1) {
            buffer.flip();
            
            // 2. å†…æ ¸ç¼“å†²åŒº â†’ ç”¨æˆ·ç¼“å†²åŒº (CPUæ‹·è´)
            byte[] data = new byte[buffer.limit()];
            buffer.get(data);
            
            // 3. ç”¨æˆ·ç¼“å†²åŒº â†’ Socketç¼“å†²åŒº (CPUæ‹·è´)
            ByteBuffer socketBuffer = ByteBuffer.wrap(data);
            
            // 4. Socketç¼“å†²åŒº â†’ ç½‘å¡ç¼“å†²åŒº (DMAæ‹·è´)
            socket.getChannel().write(socketBuffer);
            
            buffer.clear();
        }
    }
}
```

**ä¼ ç»Ÿæ¨¡å¼é—®é¢˜**ï¼š4æ¬¡æ‹·è´ï¼Œ2æ¬¡CPUå‚ä¸

#### **2. Zero-Copyå®ç°**

```java
// sendfileç³»ç»Ÿè°ƒç”¨ï¼š2æ¬¡æ‹·è´ï¼Œ0æ¬¡CPUå‚ä¸
class ZeroCopyTransfer {
    void sendFileWithZeroCopy(Socket socket, File file) {
        FileChannel fileChannel = new FileInputStream(file).getChannel();
        
        // ä½¿ç”¨transferToå®ç°é›¶æ‹·è´
        long position = 0;
        long count = fileChannel.size();
        
        // ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨å®Œæˆä¼ è¾“
        fileChannel.transferTo(position, count, socket.getChannel());
        
        // å†…æ ¸å†…éƒ¨æµç¨‹ï¼š
        // 1. ç£ç›˜ â†’ å†…æ ¸ç¼“å†²åŒº (DMA)
        // 2. å†…æ ¸ç¼“å†²åŒº â†’ ç½‘å¡ç¼“å†²åŒº (DMA)
        // CPUä¸å‚ä¸æ•°æ®æ‹·è´ï¼
    }
}
```

**Kafkaä¸­çš„é›¶æ‹·è´**ï¼š

```java
// Kafkaåº•å±‚ä½¿ç”¨sendfile
class KafkaZeroCopy {
    // ç”Ÿäº§è€… â†’ Broker
    void producerSend() {
        // ç”Ÿäº§è€…ï¼šæ¶ˆæ¯æ‰¹é‡å‘é€
        // Brokerï¼šé¡ºåºå†™å…¥é¡µç¼“å­˜
    }
    
    // Broker â†’ æ¶ˆè´¹è€…
    void consumerFetch() {
        // æ¶ˆè´¹è€…æ‹‰å–æ—¶ï¼š
        // 1. æ£€æŸ¥é¡µç¼“å­˜å‘½ä¸­
        // 2. ä½¿ç”¨sendfileç›´æ¥å‘é€
        // 3. é¿å…ç”¨æˆ·æ€-å†…æ ¸æ€åˆ‡æ¢
    }
}
```

#### **3. é›¶æ‹·è´é…ç½®**

```properties
# server.properties
# å¯ç”¨é›¶æ‹·è´ä¼ è¾“
socket.send.buffer.bytes=102400
socket.receive.buffer.bytes=102400
socket.request.max.bytes=104857600

# ä½¿ç”¨epollï¼ˆLinuxï¼‰
num.network.threads=3
num.io.threads=8
```

### ä¸‰ã€æ‰¹é‡å¤„ç†ï¼šååé‡æå‡

#### **1. ç”Ÿäº§è€…æ‰¹é‡**

```java
// ç”Ÿäº§è€…æ‰¹é‡å‘é€é…ç½®
Properties props = new Properties();
props.put("batch.size", 16384);      // 16KBæ‰¹æ¬¡
props.put("linger.ms", 5);          // ç­‰å¾…5ms
props.put("buffer.memory", 33554432); // 32MBç¼“å†²åŒº
props.put("compression.type", "snappy"); // å‹ç¼©å‡å°‘ç½‘ç»œIO

// æ‰¹é‡å‘é€æ•ˆæœï¼š
// 1æ¡æ¶ˆæ¯ï¼šheader(30B) + data(100B) = 130B
// 100æ¡æ‰¹é‡ï¼šheader(30B) + data*100(10KB) = 10.03KB
// ç½‘ç»œå¼€é”€å‡å°‘ï¼š99.7%
```

**æ‰¹é‡ä¼˜åŒ–å…¬å¼**ï¼š

```markdown
ç†è®ºæœ€å¤§åå = batch.size / linger.ms * ç”Ÿäº§è€…æ•°
å®é™…ä¼˜åŒ–ï¼šæ ¹æ®ç½‘ç»œå»¶è¿Ÿè°ƒæ•´linger.ms
```

#### **2. æ¶ˆè´¹è€…æ‰¹é‡**

```java
// æ¶ˆè´¹è€…æ‰¹é‡æ‹‰å–
Properties consumerProps = new Properties();
consumerProps.put("fetch.min.bytes", 1);
consumerProps.put("fetch.max.bytes", 52428800);  // 50MB
consumerProps.put("max.poll.records", 500);
consumerProps.put("max.partition.fetch.bytes", 1048576);  // 1MB/åˆ†åŒº

// æ‰¹é‡å¤„ç†ä¼˜åŠ¿ï¼š
// å‡å°‘ç½‘ç»œå¾€è¿”
// æé«˜å¤„ç†æ•ˆç‡
// é™ä½CPUæ¶ˆè€—
```

### å››ã€é‡å¹³è¡¡(Rebalance)æœºåˆ¶

#### **1. é‡å¹³è¡¡è§¦å‘æ¡ä»¶**

```java
// æ¶ˆè´¹è€…ç»„çŠ¶æ€æœº
class ConsumerGroupState {
    enum State {
        EMPTY,          // æ— æ¶ˆè´¹è€…
        ASSIGNING,      // æ­£åœ¨åˆ†é…
        STABLE,         // ç¨³å®šçŠ¶æ€
        PREPARING_REBALANCE,  // å‡†å¤‡é‡å¹³è¡¡
        DEAD            // ç»„æ­»äº¡
    }
    
    // è§¦å‘é‡å¹³è¡¡çš„æ¡ä»¶
    boolean shouldRebalance() {
        return 
            // 1. æ–°æ¶ˆè´¹è€…åŠ å…¥
            newConsumerJoined() ||
            // 2. æ¶ˆè´¹è€…ç¦»å¼€ï¼ˆè¶…æ—¶ï¼‰
            consumerTimeout() ||
            // 3. è®¢é˜…ä¸»é¢˜å˜åŒ–
            subscriptionChanged() ||
            // 4. åˆ†åŒºæ•°é‡å˜åŒ–
            partitionsChanged();
    }
}
```

#### **2. é‡å¹³è¡¡æµç¨‹**

```markdown
é‡å¹³è¡¡ä¸‰é˜¶æ®µï¼š
1. Join Group (åŠ å…¥ç»„)
   - æ¶ˆè´¹è€…å‘é€JoinGroupè¯·æ±‚
   - ç¬¬ä¸€ä¸ªåŠ å…¥çš„æˆä¸ºLeader
   - GroupCoordinatoråˆ†é…memberId

2. Sync Group (åŒæ­¥ç»„)
   - Leaderåˆ¶å®šåˆ†é…æ–¹æ¡ˆ
   - å‘é€SyncGroupè¯·æ±‚
   - æ‰€æœ‰æ¶ˆè´¹è€…è·å–åˆ†é…ç»“æœ

3. å¿ƒè·³ç»´æŒ
   - æ¶ˆè´¹è€…å®šæœŸå‘é€å¿ƒè·³
   - è¶…æ—¶è§¦å‘é‡å¹³è¡¡
// é‡å¹³è¡¡ä¼˜åŒ–é…ç½®
class RebalanceOptimization {
    void configure() {
        // å…³é”®å‚æ•°
        props.put("session.timeout.ms", 45000);      // ä¼šè¯è¶…æ—¶45ç§’
        props.put("heartbeat.interval.ms", 3000);    // å¿ƒè·³3ç§’ä¸€æ¬¡
        props.put("max.poll.interval.ms", 300000);   // å¤„ç†è¶…æ—¶5åˆ†é’Ÿ
        
        // å‡å°‘ä¸å¿…è¦çš„é‡å¹³è¡¡
        props.put("partition.assignment.strategy", 
            "org.apache.kafka.clients.consumer.CooperativeStickyAssignor");
    }
}
```

#### **3. å¢é‡é‡å¹³è¡¡(Kafka 2.4+)**

```java
// ä¼ ç»Ÿé‡å¹³è¡¡ï¼šå…¨éƒ¨é‡æ–°åˆ†é…
// å¢é‡é‡å¹³è¡¡ï¼šåªé‡æ–°åˆ†é…å—å½±å“åˆ†åŒº
class IncrementalRebalance {
    void incrementalRebalance() {
        // åœºæ™¯ï¼šæ¶ˆè´¹è€…Cæ•…éšœ
        // ä¼ ç»Ÿï¼šAã€Bã€Cå…¨éƒ¨åˆ†åŒºé‡æ–°åˆ†é…
        // å¢é‡ï¼šåªé‡æ–°åˆ†é…Cçš„åˆ†åŒºç»™Aå’ŒB
        // Aå’ŒBçš„åˆ†åŒºåˆ†é…ä¿æŒä¸å˜
    }
}

// é…ç½®å¢é‡é‡å¹³è¡¡
props.put("partition.assignment.strategy",
    "org.apache.kafka.clients.consumer.CooperativeStickyAssignor");
```

### äº”ã€æ¶ˆæ¯å»¶è¿Ÿåˆ†æ

#### **1. ç«¯åˆ°ç«¯å»¶è¿Ÿç»„æˆ**

```markdown
ç”Ÿäº§è€…å»¶è¿Ÿ â†’ ç½‘ç»œå»¶è¿Ÿ â†’ Brokerå¤„ç†å»¶è¿Ÿ â†’ æ¶ˆè´¹è€…æ‹‰å–å»¶è¿Ÿ
   (1-5ms)    (1-10ms)      (1-2ms)         (é…ç½®ç›¸å…³)
```

#### **2. å»¶è¿Ÿä¼˜åŒ–é…ç½®**

```properties
# ç”Ÿäº§è€…ä½å»¶è¿Ÿé…ç½®
linger.ms=0                  # ä¸ç­‰å¾…æ‰¹æ¬¡
acks=1                      # Leaderç¡®è®¤å³è¿”å›
compression.type=none       # ç¦ç”¨å‹ç¼©
batch.size=16384

# Brokerä½å»¶è¿Ÿé…ç½®
num.network.threads=3
num.io.threads=8
queued.max.requests=500
socket.request.max.bytes=104857600

# æ¶ˆè´¹è€…ä½å»¶è¿Ÿé…ç½®
fetch.min.bytes=1
fetch.max.wait.ms=0
max.poll.records=1
```

#### **3. å»¶è¿Ÿç›‘æ§**

```bash
# ç›‘æ§ç”Ÿäº§è€…å»¶è¿Ÿ
kafka-producer-perf-test \
  --topic test \
  --num-records 1000000 \
  --record-size 1000 \
  --throughput -1 \
  --producer-props \
    bootstrap.servers=localhost:9092 \
    acks=1

# è¾“å‡ºï¼š
# 1000000 records sent, 238310.277085 records/sec
# avg latency: 42.00 ms, max latency: 380.00 ms
```

### å…­ã€æ¶ˆæ¯å †ç§¯å¤„ç†

#### **1. å †ç§¯åŸå› åˆ†æ**

```java
// å¸¸è§å †ç§¯åœºæ™¯
class MessageBacklog {
    // 1. ç”Ÿäº§é€Ÿåº¦ > æ¶ˆè´¹é€Ÿåº¦
    boolean producerFaster = producerRate > consumerRate;
    
    // 2. æ¶ˆè´¹è€…æ•…éšœ
    boolean consumerDown = !consumer.isAlive();
    
    // 3. å¤„ç†é€»è¾‘è¿‡é‡
    boolean heavyProcessing = processTime > pollInterval;
    
    // 4. åˆ†åŒºåˆ†é…ä¸å‡
    boolean unbalanced = maxLag - minLag > threshold;
}
```

#### **2. å †ç§¯ç›‘æ§**

```bash
# æŸ¥çœ‹æ¶ˆè´¹è€…ç§¯å‹
kafka-consumer-groups \
  --bootstrap-server localhost:9092 \
  --group my-group \
  --describe

# è¾“å‡ºç¤ºä¾‹ï¼š
# TOPIC    PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG
# test     0          100             150             50
# test     1          200             1000            800  # ä¸¥é‡ç§¯å‹
```

#### **3. å †ç§¯å¤„ç†ç­–ç•¥**

```java
// 1. æ°´å¹³æ‰©å±•æ¶ˆè´¹è€…
class ScaleConsumers {
    void scaleOut() {
        // å¢åŠ æ¶ˆè´¹è€…æ•°é‡
        // æ¡ä»¶ï¼šæ¶ˆè´¹è€…æ•° â‰¤ åˆ†åŒºæ•°
        int partitions = getPartitionCount("topic");
        int consumers = getConsumerCount("group");
        
        if (consumers < partitions) {
            startNewConsumer();
        }
    }
}

// 2. æé«˜æ‰¹é‡å¤„ç†æ•ˆç‡
class BatchOptimization {
    void optimizeBatch() {
        // å¢åŠ æ‰¹é‡å¤§å°
        props.put("max.poll.records", 1000);
        props.put("fetch.max.bytes", 52428800);
        
        // ä½¿ç”¨å¤šçº¿ç¨‹å¤„ç†
        ExecutorService executor = Executors.newFixedThreadPool(10);
        for (ConsumerRecord record : records) {
            executor.submit(() -> process(record));
        }
    }
}

// 3. ä¸´æ—¶å¢åŠ åˆ†åŒº
class PartitionScaling {
    void increasePartitions() {
        // æ³¨æ„ï¼šåˆ†åŒºå¢åŠ éœ€è¦é‡å¹³è¡¡
        // åªå¢åŠ ä¸å‡å°‘
        kafka-topics --alter \
          --topic my-topic \
          --partitions 10
    }
}

// 4. è·³è¿‡ç§¯å‹æ•°æ®
class SkipBacklog {
    void skipToLatest() {
        // ä¸šåŠ¡å…è®¸æ—¶ï¼Œè·³è¿‡å†å²æ•°æ®
        consumer.seekToEnd(partitions);
        
        // æˆ–é‡ç½®åˆ°ç‰¹å®šæ—¶é—´
        Map<TopicPartition, Long> timestamps = new HashMap<>();
        long oneHourAgo = System.currentTimeMillis() - 3600000;
        timestamps.put(tp, oneHourAgo);
        
        Map<TopicPartition, OffsetAndTimestamp> offsets = 
            consumer.offsetsForTimes(timestamps);
        consumer.seek(tp, offsets.get(tp).offset());
    }
}
```



#### **4. é¢„é˜²å †ç§¯é…ç½®**

```yaml
# é¢„é˜²æ€§é…ç½®
producer:
  # ç›‘æ§ç”Ÿäº§é€Ÿç‡
  monitoring_rate: 60s
  alert_threshold: 10000  # æ¡/ç§’
  
consumer:
  # åŠ¨æ€è°ƒæ•´æ‹‰å–é‡
  max_poll_records: 
    base: 500
    dynamic_adjustment: true
    max: 5000
    
  # å¤„ç†è¶…æ—¶ç›‘æ§
  process_timeout_ms: 30000
  alert_on_timeout: true
  
  # è‡ªåŠ¨æ‰©å±•
  auto_scaling:
    enabled: true
    lag_threshold: 10000
    max_consumers: 20
```

### ä¸ƒã€æ€§èƒ½è°ƒä¼˜æœ€ä½³å®è·µ

#### **1. ç¡¬ä»¶é…ç½®å»ºè®®**

```yaml
# ç”Ÿäº§ç¯å¢ƒç¡¬ä»¶é…ç½®
broker_hardware:
  # ç£ç›˜
  disk:
    type: "NVMe SSD"  # å¿…é¡»SSD
    raid: 0           # æ¡å¸¦åŒ–æé«˜åå
    count: 8-12       # å¤šä¸ªæ•°æ®ç›®å½•
    
  # CPU
  cpu:
    cores: 16-32
    clock: 2.5+ GHz
    
  # å†…å­˜
  memory:
    size: 64-128GB
    # é¡µç¼“å­˜ï¼šæ€»æ•°æ®é‡çš„25-50%
    
  # ç½‘ç»œ
  network:
    speed: 10Gbps+
    bonding: true
```

#### **2. JVMé…ç½®ä¼˜åŒ–**

```bash
# kafka-server-start.sh
export KAFKA_HEAP_OPTS="-Xmx8g -Xms8g"
export KAFKA_JVM_PERFORMANCE_OPTS="
  -server
  -XX:+UseG1GC
  -XX:MaxGCPauseMillis=20
  -XX:InitiatingHeapOccupancyPercent=35
  -XX:+DisableExplicitGC
  -Djava.awt.headless=true
"
```

#### **3. ç›‘æ§æŒ‡æ ‡**

```promql
# å…³é”®æ€§èƒ½æŒ‡æ ‡
# ååé‡
rate(kafka_server_brokertopicmetrics_messagesinpersec[5m])
rate(kafka_server_brokertopicmetrics_bytesinpersec[5m])

# å»¶è¿Ÿ
kafka_network_requestmetrics_totaltimems{request="Produce", quantile="0.99"}
kafka_network_requestmetrics_totaltimems{request="FetchConsumer", quantile="0.99"}

# å †ç§¯
kafka_consumer_fetch_manager_records_lag_max

# GC
jvm_gc_collection_seconds_count{gc="G1 Young Generation"}
jvm_gc_collection_seconds_sum{gc="G1 Young Generation"}
```

### å…«ã€æ€»ç»“ï¼šé«˜æ€§èƒ½å…³é”®è¦ç´ 

| **ä¼˜åŒ–æ–¹å‘** | **å…³é”®æŠ€æœ¯**      | **æ•ˆæœæå‡**    | **é…ç½®è¦ç‚¹**              |
| ------------ | ----------------- | --------------- | ------------------------- |
| **ç£ç›˜IO**   | é¡ºåºè¯»å†™ + é¡µç¼“å­˜ | 50-100å€        | ä½¿ç”¨SSDï¼Œå¤šä¸ªæ•°æ®ç›®å½•     |
| **ç½‘ç»œä¼ è¾“** | é›¶æ‹·è´ + æ‰¹é‡     | å‡å°‘70%CPU      | sendfileï¼Œåˆç†æ‰¹æ¬¡å¤§å°    |
| **æ¶ˆæ¯å¤„ç†** | æ‰¹é‡å‹ç¼©          | æå‡5-10å€åå  | snappyå‹ç¼©ï¼Œä¼˜åŒ–æ‰¹æ¬¡      |
| **é‡å¹³è¡¡**   | å¢é‡é‡å¹³è¡¡        | å‡å°‘50%åœé¡¿æ—¶é•¿ | CooperativeStickyAssignor |
| **å †ç§¯å¤„ç†** | åŠ¨æ€åˆ†åŒºåˆ†é…      | å¿«é€Ÿæ¢å¤        | ç›‘æ§Lagï¼Œè‡ªåŠ¨æ‰©ç¼©å®¹       |

**æ ¸å¿ƒæ€§èƒ½å…¬å¼**ï¼š

```markdown
ç†è®ºæœ€å¤§åå = min(ç£ç›˜åå, ç½‘ç»œå¸¦å®½, CPUå¤„ç†èƒ½åŠ›)
å®é™…åå = ç†è®ºåå Ã— ä¼˜åŒ–ç³»æ•°(0.6-0.8)
```

**ä¸€å¥è¯æ€»ç»“**ï¼š

> **Kafkaé€šè¿‡é¡ºåºè¯»å†™åˆ©ç”¨ç£ç›˜æœ€å¤§ååï¼Œé›¶æ‹·è´å‡å°‘CPUæ¶ˆè€—ï¼Œæ‰¹é‡å¤„ç†æé«˜ç½‘ç»œæ•ˆç‡ï¼Œåˆç†é…ç½®é¿å…é‡å¹³è¡¡å’Œæ¶ˆæ¯å †ç§¯ï¼Œå…±åŒå®ç°ç™¾ä¸‡çº§TPSçš„é«˜æ€§èƒ½æ¶ˆæ¯é˜Ÿåˆ—ã€‚**







## **ç³»ç»Ÿ-é«˜å¯ç”¨**

> å‰¯æœ¬æœºåˆ¶Replicaï¼ŒLeader/Followerï¼ŒHAç³»ç»Ÿ åŸºäºzkçš„controller

### ä¸€ã€å‰¯æœ¬æœºåˆ¶(Replication) - æ•°æ®å¯é æ€§çš„åŸºçŸ³

#### **1. å‰¯æœ¬æ ¸å¿ƒæ¶æ„**

```java
// å‰¯æœ¬åŸºæœ¬æ¦‚å¿µ
class ReplicationConcepts {
    // å‰¯æœ¬é…ç½®
    int replicationFactor = 3;  // å‰¯æœ¬å› å­ï¼Œå»ºè®®3
    
    // å‰¯æœ¬è§’è‰²
    enum ReplicaRole {
        LEADER,     // é¢†å¯¼è€…ï¼šå¤„ç†æ‰€æœ‰è¯»å†™
        FOLLOWER,   // è·Ÿéšè€…ï¼šåŒæ­¥Leaderæ•°æ®
        OFFLINE     // ç¦»çº¿ï¼šä¸å¯ç”¨
    }
    
    // ç¤ºä¾‹ï¼šTopicæœ‰3ä¸ªåˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒº3ä¸ªå‰¯æœ¬
    class TopicPartitionReplicas {
        // Partition 0
        Replica[] replicas = {
            new Replica(broker1, LEADER),    // Leader
            new Replica(broker2, FOLLOWER),  // Follower
            new Replica(broker3, FOLLOWER)   // Follower
        };
        
        // Partition 1
        Replica[] replicas = {
            new Replica(broker2, LEADER),    // Leader
            new Replica(broker3, FOLLOWER),  // Follower
            new Replica(broker1, FOLLOWER)   // Follower
        };
        
        // Partition 2
        Replica[] replicas = {
            new Replica(broker3, LEADER),    // Leader
            new Replica(broker1, FOLLOWER),  // Follower
            new Replica(broker2, FOLLOWER)   // Follower
        };
    }
}
```

#### **2. å‰¯æœ¬æ”¾ç½®ç­–ç•¥**

```java
// Kafkaé»˜è®¤å‰¯æœ¬æ”¾ç½®ç®—æ³•
class DefaultReplicaAssignment {
    // ç›®æ ‡ï¼šå‡è¡¡åˆ†å¸ƒï¼Œé¿å…å•ç‚¹æ•…éšœ
    List<Integer> assignReplicas(int numPartitions, int replicationFactor, List<Integer> brokerIds) {
        List<List<Integer>> assignments = new ArrayList<>();
        
        for (int partition = 0; partition < numPartitions; partition++) {
            List<Integer> replicas = new ArrayList<>();
            
            // ç¬¬ä¸€ä¸ªå‰¯æœ¬ï¼šè½®è¯¢é€‰æ‹©Broker
            int firstReplica = (partition + startIndex) % brokerIds.size();
            replicas.add(brokerIds.get(firstReplica));
            
            // åç»­å‰¯æœ¬ï¼šä»ç¬¬ä¸€ä¸ªå‰¯æœ¬å¼€å§‹ï¼Œè·³è¿‡å·²é€‰Broker
            for (int i = 1; i < replicationFactor; i++) {
                int replica = (firstReplica + i) % brokerIds.size();
                replicas.add(brokerIds.get(replica));
            }
            
            assignments.add(replicas);
        }
        
        return assignments;
    }
}
```

**æœºæ¶æ„ŸçŸ¥å‰¯æœ¬æ”¾ç½®**ï¼š

```properties
# server.properties
# å¯ç”¨æœºæ¶æ„ŸçŸ¥
broker.rack=rack1
# æˆ–
broker.rack=us-east-1a

# å‰¯æœ¬æ”¾ç½®ç­–ç•¥
replica.selector.class=org.apache.kafka.common.replica.RackAwareReplicaSelector
```

### äºŒã€Leader-FolloweråŒæ­¥æœºåˆ¶

#### **1. æ¶ˆæ¯å†™å…¥æµç¨‹**

```java
// Leaderå¤„ç†ç”Ÿäº§è€…å†™å…¥è¯·æ±‚
class LeaderWriteProcess {
    void handleProduceRequest(ProduceRequest request) {
        // 1. éªŒè¯è¯·æ±‚
        validateRequest(request);
        
        // 2. å†™å…¥Leaderæœ¬åœ°æ—¥å¿—
        LogAppendInfo appendInfo = localLog.append(request.records());
        
        // 3. æ›´æ–°é«˜æ°´ä½çº¿(High Watermark)
        updateHighWatermark();
        
        // 4. å¼‚æ­¥å¤åˆ¶åˆ°Follower
        replicateToFollowers(request, appendInfo);
        
        // 5. æ ¹æ®acksé…ç½®å“åº”ç”Ÿäº§è€…
        sendResponseBasedOnAcks(appendInfo);
    }
    
    // åŒæ­¥å¤åˆ¶åˆ°Follower
    private void replicateToFollowers(ProduceRequest request, LogAppendInfo appendInfo) {
        List<CompletableFuture<Void>> futures = new ArrayList<>();
        
        for (Replica follower : followers) {
            futures.add(CompletableFuture.runAsync(() -> {
                // å‘é€Fetchè¯·æ±‚ç»™Follower
                FetchResponse response = sendFetchRequest(follower, appendInfo.lastOffset);
                
                if (response.success()) {
                    // æ›´æ–°Followerçš„LEO
                    follower.updateLogEndOffset(appendInfo.lastOffset);
                } else {
                    // å¤„ç†åŒæ­¥å¤±è´¥
                    handleReplicationFailure(follower);
                }
            }));
        }
        
        // ç­‰å¾…æ‰€æœ‰Followerå“åº”ï¼ˆæ ¹æ®acksé…ç½®ï¼‰
        CompletableFuture.allOf(futures.toArray(new CompletableFuture[0]))
            .get(timeout, TimeUnit.MILLISECONDS);
    }
}
```

#### **2. ISRæœºåˆ¶è¯¦è§£**

```java
// In-Sync Replicas (åŒæ­¥å‰¯æœ¬é›†)
class ISRMechanism {
    Set<Integer> isr = new HashSet<>();  // å½“å‰ISR
    long highWatermark;                  // é«˜æ°´ä½çº¿
    long logEndOffset;                   // æ—¥å¿—æœ«ç«¯åç§»é‡
    
    // ISRåŠ¨æ€ç®¡ç†
    void manageISR(List<Replica> replicas) {
        for (Replica replica : replicas) {
            if (isReplicaInSync(replica)) {
                // å‰¯æœ¬åŒæ­¥ï¼Œä¿æŒåœ¨ISRä¸­
                isr.add(replica.id());
            } else {
                // å‰¯æœ¬ä¸åŒæ­¥ï¼Œä»ISRç§»é™¤
                isr.remove(replica.id());
                // è§¦å‘å‰¯æœ¬åŒæ­¥è¿½èµ¶
                triggerCatchUp(replica);
            }
        }
    }
    
    // åˆ¤æ–­å‰¯æœ¬æ˜¯å¦åŒæ­¥
    boolean isReplicaInSync(Replica replica) {
        // æ¡ä»¶1ï¼šå‰¯æœ¬å¿…é¡»å­˜æ´»
        if (!replica.isAlive()) return false;
        
        // æ¡ä»¶2ï¼šå‰¯æœ¬è½åä¸è¶…è¿‡é˜ˆå€¼
        long replicaLag = logEndOffset - replica.logEndOffset();
        boolean notTooFarBehind = replicaLag <= replica.lag.max.messages;
        
        // æ¡ä»¶3ï¼šå‰¯æœ¬å»¶è¿Ÿä¸è¶…è¿‡é˜ˆå€¼
        long timeLag = System.currentTimeMillis() - replica.lastCaughtUpTime();
        boolean notTooLate = timeLag <= replica.lag.time.max.ms;
        
        return notTooFarBehind && notTooLate;
    }
}
```

**ISRé…ç½®å‚æ•°**ï¼š

```properties
# server.properties
# ISRç›¸å…³é…ç½®
replica.lag.time.max.ms=10000        # æœ€å¤§è½åæ—¶é—´10ç§’
replica.lag.max.messages=4000        # æœ€å¤§è½åæ¶ˆæ¯æ•°
min.insync.replicas=2                # æœ€å°åŒæ­¥å‰¯æœ¬æ•°
unclean.leader.election.enable=false  # ç¦æ­¢è„é€‰ä¸¾
```

#### **3. æ°´ä½çº¿æœºåˆ¶**

```java
// æ°´ä½çº¿æœºåˆ¶
class WatermarkMechanism {
    long highWatermark;      // é«˜æ°´ä½çº¿ï¼šå·²æäº¤æ¶ˆæ¯è¾¹ç•Œ
    long logEndOffset;       // æ—¥å¿—æœ«ç«¯åç§»é‡
    
    // æ›´æ–°é«˜æ°´ä½çº¿
    void updateHighWatermark() {
        // HW = min(æ‰€æœ‰ISRå‰¯æœ¬çš„LEO)
        long minLeo = isr.stream()
            .mapToLong(replica -> replica.logEndOffset())
            .min()
            .orElse(0L);
        
        this.highWatermark = minLeo;
    }
    
    // æ°´ä½çº¿æ„ä¹‰
    void explainWatermarks() {
        // LEO: æœ€æ–°å†™å…¥çš„æ¶ˆæ¯ä½ç½®
        // HW: å·²åŒæ­¥åˆ°æ‰€æœ‰ISRçš„æ¶ˆæ¯ä½ç½®
        // Consumeråªèƒ½è¯»å–åˆ°HWä¹‹å‰çš„æ¶ˆæ¯
        
        // ç¤ºä¾‹ï¼š
        // LEO = 100, ISR = [Leader(100), F1(98), F2(100)]
        // HW = min(100, 98, 100) = 98
        // Consumeråªèƒ½è¯»å–0-97çš„æ¶ˆæ¯
    }
}
```

### ä¸‰ã€Leaderé€‰ä¸¾æœºåˆ¶

#### **1. ä¼˜é›…Leaderåˆ‡æ¢**

```java
// ä¼˜é›…Leaderåˆ‡æ¢æµç¨‹
class GracefulLeaderTransition {
    void initiateLeaderTransition(int newLeaderId) {
        // 1. æš‚åœå†™å…¥
        pauseWrites();
        
        // 2. ç¡®ä¿æ–°Leaderå·²åŒæ­¥åˆ°æœ€æ–°
        ensureNewLeaderIsInSync(newLeaderId);
        
        // 3. æ›´æ–°Leaderå’ŒEpoch
        updateLeaderAndEpoch(newLeaderId);
        
        // 4. é€šçŸ¥æ‰€æœ‰å‰¯æœ¬
        notifyAllReplicasOfNewLeader();
        
        // 5. æ¢å¤å†™å…¥
        resumeWrites();
    }
    
    // å¤„ç†Leaderæ•…éšœ
    void handleLeaderFailure(int failedLeaderId) {
        // 1. ä»ISRä¸­é€‰æ‹©æ–°Leader
        int newLeaderId = electNewLeaderFromISR();
        
        if (newLeaderId == -1) {
            // ISRä¸­æ²¡æœ‰å¯ç”¨å‰¯æœ¬
            if (unclean.leader.election.enable) {
                // å…è®¸è„é€‰ä¸¾ï¼ˆå¯èƒ½ä¸¢å¤±æ•°æ®ï¼‰
                newLeaderId = electLeaderFromNonISR();
            } else {
                // åˆ†åŒºä¸å¯ç”¨
                markPartitionUnavailable();
                return;
            }
        }
        
        // 2. æ‰§è¡ŒLeaderåˆ‡æ¢
        initiateLeaderTransition(newLeaderId);
    }
}
```

#### **2. æ§åˆ¶å™¨é€‰ä¸¾æµç¨‹**

```java
// Controlleré€‰ä¸¾ï¼ˆåŸºäºZooKeeperï¼‰
class ControllerElection {
    // æ§åˆ¶å™¨çŠ¶æ€
    enum ControllerState {
        ACTIVE,      // æ´»è·ƒçŠ¶æ€
        STANDBY,     // å¤‡ç”¨çŠ¶æ€
        UNAVAILABLE  // ä¸å¯ç”¨
    }
    
    // å‚ä¸é€‰ä¸¾
    void participateInElection() {
        // 1. å°è¯•åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹
        String path = "/controller";
        try {
            zkClient.create(path, 
                getBrokerInfo().getBytes(),
                ZooDefs.Ids.OPEN_ACL_UNSAFE,
                CreateMode.EPHEMERAL);
            
            // åˆ›å»ºæˆåŠŸï¼Œæˆä¸ºController
            becomeActiveController();
            
        } catch (KeeperException.NodeExistsException e) {
            // èŠ‚ç‚¹å·²å­˜åœ¨ï¼Œå…¶ä»–Brokeræ˜¯Controller
            becomeStandbyController();
            
            // ç›‘å¬ControllerèŠ‚ç‚¹å˜åŒ–
            zkClient.watch(path, (event) -> {
                if (event.getType() == EventType.NodeDeleted) {
                    // Controlleræ•…éšœï¼Œé‡æ–°é€‰ä¸¾
                    participateInElection();
                }
            });
        }
    }
    
    // æˆä¸ºæ´»è·ƒController
    void becomeActiveController() {
        this.state = ControllerState.ACTIVE;
        
        // åˆå§‹åŒ–ControllerèŒè´£
        initializeControllerResponsibilities();
        
        // å¼€å§‹å¤„ç†æ§åˆ¶è¯·æ±‚
        startProcessingControlRequests();
    }
}
```

### å››ã€åŸºäºZooKeeperçš„Controllerç³»ç»Ÿ

#### **1. Controlleræ ¸å¿ƒèŒè´£**

```java
// Kafka Controlleræ ¸å¿ƒåŠŸèƒ½
class KafkaController {
    // 1. åˆ†åŒºç®¡ç†
    class PartitionManagement {
        // åˆ›å»ºåˆ†åŒº
        void createPartitions(String topic, int newPartitionCount) {
            // è®¡ç®—å‰¯æœ¬åˆ†é…
            List<List<Integer>> assignments = computePartitionAssignments();
            
            // æ›´æ–°ZooKeeper
            updatePartitionAssignmentsInZK(topic, assignments);
            
            // é€šçŸ¥ç›¸å…³Broker
            notifyBrokersOfNewPartitions(assignments);
        }
        
        // åˆ†åŒºé‡åˆ†é…
        void reassignPartitions(Map<TopicPartition, List<Integer>> reassignments) {
            // å¯åŠ¨é‡åˆ†é…ä»»åŠ¡
            startReassignmentTask(reassignments);
            
            // ç›‘æ§é‡åˆ†é…è¿›åº¦
            monitorReassignmentProgress();
            
            // å®Œæˆæ—¶æ¸…ç†çŠ¶æ€
            completeReassignment();
        }
    }
    
    // 2. Leaderé€‰ä¸¾
    class LeaderElectionService {
        // è§¦å‘Leaderé€‰ä¸¾çš„åœºæ™¯
        void triggerLeaderElection(TopicPartition tp) {
            // åœºæ™¯1ï¼šLeaderæ•…éšœ
            // åœºæ™¯2ï¼šISRå˜æ›´
            // åœºæ™¯3ï¼šåˆ†åŒºæ‰©ç¼©å®¹
            
            // æ‰§è¡Œé€‰ä¸¾
            performLeaderElection(tp);
        }
        
        // æ‰§è¡Œé€‰ä¸¾
        void performLeaderElection(TopicPartition tp) {
            // ä»ISRä¸­é€‰æ‹©æ–°Leader
            int newLeader = selectNewLeaderFromISR(tp);
            
            // æ›´æ–°Leaderå’ŒEpoch
            updateLeaderAndEpochInZK(tp, newLeader);
            
            // å‘é€LeaderAndIsrè¯·æ±‚
            sendLeaderAndIsrRequest(tp, newLeader);
        }
    }
    
    // 3. Brokerç”Ÿå‘½å‘¨æœŸç®¡ç†
    class BrokerLifecycle {
        // Brokerä¸Šçº¿
        void handleBrokerUp(int brokerId) {
            // æ³¨å†ŒBroker
            registerBroker(brokerId);
            
            // è§¦å‘å—å½±å“åˆ†åŒºçš„Leaderé€‰ä¸¾
            triggerAffectedLeaderElections(brokerId);
            
            // å¼€å§‹å‰¯æœ¬åŒæ­¥
            startReplicaSync(brokerId);
        }
        
        // Brokerä¸‹çº¿
        void handleBrokerDown(int brokerId) {
            // æ ‡è®°Brokerä¸ºç¦»çº¿
            markBrokerOffline(brokerId);
            
            // è§¦å‘Leaderé‡æ–°é€‰ä¸¾
            triggerLeaderReElectionForBroker(brokerId);
            
            // å¯åŠ¨å‰¯æœ¬æ¢å¤
            startReplicaRecovery(brokerId);
        }
    }
}
```

#### **2. Controlleræ•…éšœè½¬ç§»**

```java
// Controlleræ•…éšœè½¬ç§»æµç¨‹
class ControllerFailover {
    void handleControllerFailure() {
        // 1. æ£€æµ‹Controlleræ•…éšœ
        if (isControllerFailed()) {
            // 2. æ¸…ç†æ—§ControllerçŠ¶æ€
            cleanupOldControllerState();
            
            // 3. è§¦å‘æ–°Controlleré€‰ä¸¾
            triggerNewControllerElection();
            
            // 4. æ–°ControlleråŠ è½½çŠ¶æ€
            newController.loadState();
            
            // 5. æ¢å¤æœåŠ¡
            newController.resumeService();
        }
    }
    
    // çŠ¶æ€æ¢å¤
    class StateRecovery {
        void recoverState() {
            // ä»ZooKeeperåŠ è½½é›†ç¾¤çŠ¶æ€
            ClusterState clusterState = loadClusterStateFromZK();
            
            // æ¢å¤åˆ†åŒºçŠ¶æ€
            recoverPartitionStates(clusterState);
            
            // æ¢å¤å‰¯æœ¬çŠ¶æ€
            recoverReplicaStates(clusterState);
            
            // æ¢å¤BrokerçŠ¶æ€
            recoverBrokerStates(clusterState);
        }
    }
}
```

#### **3. ZooKeeperå­˜å‚¨ç»“æ„**

```bash
# Kafkaåœ¨ZooKeeperä¸­çš„å…³é”®èŠ‚ç‚¹
/
â”œâ”€â”€ brokers                    # Brokeræ³¨å†Œä¿¡æ¯
â”‚   â”œâ”€â”€ ids                   # Broker IDåˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ 1                 # Broker 1ä¿¡æ¯
â”‚   â”‚   â”œâ”€â”€ 2                 # Broker 2ä¿¡æ¯
â”‚   â”‚   â””â”€â”€ 3                 # Broker 3ä¿¡æ¯
â”‚   â”œâ”€â”€ seqid                 # Broker IDåºåˆ—
â”‚   â””â”€â”€ topics                # Topicé…ç½®
â”‚
â”œâ”€â”€ controller                 # Controlleré€‰ä¸¾èŠ‚ç‚¹
â”œâ”€â”€ controller_epoch           # Controllerçºªå…ƒ
â”‚
â”œâ”€â”€ consumers                  # æ—§æ¶ˆè´¹è€…ï¼ˆå·²åºŸå¼ƒï¼‰
â”‚
â”œâ”€â”€ config                     # åŠ¨æ€é…ç½®
â”‚   â”œâ”€â”€ topics                # Topicçº§åˆ«é…ç½®
â”‚   â”œâ”€â”€ clients               # å®¢æˆ·ç«¯é…ç½®
â”‚   â””â”€â”€ users                 # ç”¨æˆ·é…ç½®
â”‚
â””â”€â”€ isr_change_notification    # ISRå˜æ›´é€šçŸ¥é˜Ÿåˆ—
```

### äº”ã€é«˜å¯ç”¨é…ç½®æœ€ä½³å®è·µ

#### **1. ç”Ÿäº§ç¯å¢ƒé…ç½®æ¨¡æ¿**

```properties
# server.properties
# åŸºæœ¬é…ç½®
broker.id=1
listeners=PLAINTEXT://:9092
advertised.listeners=PLAINTEXT://broker1:9092
log.dirs=/data/kafka/logs

# å‰¯æœ¬é…ç½®
default.replication.factor=3
min.insync.replicas=2
replication.factor=3

# ISRé…ç½®
replica.lag.time.max.ms=10000
replica.lag.max.messages=4000
replica.socket.timeout.ms=30000
replica.socket.receive.buffer.bytes=65536
replica.fetch.max.bytes=1048576
replica.fetch.wait.max.ms=500
replica.fetch.min.bytes=1
replica.high.watermark.checkpoint.interval.ms=5000

# Leaderé€‰ä¸¾
unclean.leader.election.enable=false
controlled.shutdown.enable=true
controlled.shutdown.max.retries=3
controlled.shutdown.retry.backoff.ms=5000

# Controlleré…ç½®
controller.socket.timeout.ms=30000
controller.message.queue.size=10

# ZooKeeperé…ç½®
zookeeper.connect=zk1:2181,zk2:2181,zk3:2181
zookeeper.session.timeout.ms=6000
zookeeper.connection.timeout.ms=6000
zookeeper.sync.time.ms=2000
```

#### **2. Topicé«˜å¯ç”¨é…ç½®**

```bash
# åˆ›å»ºé«˜å¯ç”¨Topic
kafka-topics.sh --create \
  --topic orders \
  --partitions 6 \
  --replication-factor 3 \
  --config min.insync.replicas=2 \
  --config unclean.leader.election.enable=false \
  --config retention.ms=604800000 \
  --bootstrap-server broker1:9092

# éªŒè¯å‰¯æœ¬åˆ†å¸ƒ
kafka-topics.sh --describe \
  --topic orders \
  --bootstrap-server broker1:9092
```

### å…­ã€æ•…éšœåœºæ™¯å¤„ç†

#### **1. Brokeræ•…éšœå¤„ç†æµç¨‹**

```java
// Brokeræ•…éšœè‡ªåŠ¨æ¢å¤
class BrokerFailureRecovery {
    // åœºæ™¯ï¼šBroker 2æ•…éšœ
    void handleBroker2Failure() {
        // 1. æ£€æµ‹æ•…éšœ
        if (isBrokerDown(2)) {
            // 2. Controllerè§¦å‘Leaderé‡æ–°é€‰ä¸¾
            for (TopicPartition tp : getPartitionsOnBroker(2)) {
                if (tp.leader() == 2) {
                    // é‡æ–°é€‰ä¸¾Leader
                    controller.electNewLeader(tp);
                }
            }
            
            // 3. å‰¯æœ¬é‡æ–°åˆ†é…
            reassignReplicasFromBroker(2);
            
            // 4. ç›‘æ§æ¢å¤è¿›åº¦
            monitorRecoveryProgress();
            
            // 5. Brokeræ¢å¤åé‡æ–°åŠ å…¥é›†ç¾¤
            whenBrokerRecovers(2, () -> {
                broker2.rejoinCluster();
                triggerRebalanceIfNeeded();
            });
        }
    }
}
```

#### **2. ç½‘ç»œåˆ†åŒºå¤„ç†**

```java
// ç½‘ç»œåˆ†åŒºåœºæ™¯å¤„ç†
class NetworkPartitionHandling {
    void handleNetworkPartition() {
        // åœºæ™¯ï¼šBroker 1å’Œ2ä¹‹é—´ç½‘ç»œä¸­æ–­
        
        // 1. æ£€æµ‹åˆ†åŒº
        if (isNetworkPartition(broker1, broker2)) {
            // 2. æ›´æ–°ISRï¼ˆç§»é™¤ä¸å¯è¾¾å‰¯æœ¬ï¼‰
            updateISRToRemoveUnreachableReplicas();
            
            // 3. æ£€æŸ¥min.insync.replicas
            if (isr.size() < min.insync.replicas) {
                // æ‹’ç»å†™å…¥ï¼ˆç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼‰
                rejectWrites();
            } else {
                // ç»§ç»­æœåŠ¡
                continueServiceWithReducedReplicas();
            }
            
            // 4. ç½‘ç»œæ¢å¤ååŒæ­¥æ•°æ®
            whenNetworkRecovers(() -> {
                synchronizeDivergedReplicas();
                restoreFullReplication();
            });
        }
    }
}
```

### ä¸ƒã€ç›‘æ§ä¸å‘Šè­¦

#### **1. å…³é”®ç›‘æ§æŒ‡æ ‡**

```bash
# ç›‘æ§å‰¯æœ¬çŠ¶æ€
kafka-topics.sh --describe \
  --under-replicated-partitions \
  --bootstrap-server localhost:9092

# ç›‘æ§ControllerçŠ¶æ€
kafka-metadata-quorum.sh --describe \
  --status \
  --bootstrap-server localhost:9092

# ç›‘æ§ISRå˜åŒ–
kafka-run-class.sh kafka.tools.GetOffsetShell \
  --broker-list localhost:9092 \
  --topic test \
  --time -1
```

#### **2. Prometheusç›‘æ§é…ç½®**

```yaml
# å…³é”®é«˜å¯ç”¨æŒ‡æ ‡
kafka_metrics:
  # å‰¯æœ¬ç›¸å…³
  - kafka_cluster_partition_underreplicated
  - kafka_controller_activecontrollercount
  - kafka_controller_offlinepartitionscount
  
  # ISRç›¸å…³
  - kafka_server_replicamanager_isrexpands
  - kafka_server_replicamanager_isrshrinks
  - kafka_server_replicamanager_leadercount
  
  # ç½‘ç»œç›¸å…³
  - kafka_network_requestmetrics_responsequeuetimems
  - kafka_network_requestmetrics_responsesendtimems
  
  # ZooKeeperç›¸å…³
  - kafka_server_sessionexpirelistener_zookeeperdisconnects
  - kafka_server_sessionexpirelistener_zookeeperexpires
```

### å…«ã€KRaftæ¨¡å¼ï¼ˆKafka 3.0+ï¼‰

#### **1. KRaft vs ZooKeeper**

```properties
# å¯ç”¨KRaftæ¨¡å¼
process.roles=broker,controller
node.id=1
controller.quorum.voters=1@broker1:9093,2@broker2:9093,3@broker3:9093

# å¯¹æ¯”ZooKeeper
# ä¼˜åŠ¿ï¼š
# 1. å‡å°‘å¤–éƒ¨ä¾èµ–
# 2. ç®€åŒ–éƒ¨ç½²
# 3. æé«˜æ€§èƒ½
# 4. ç»Ÿä¸€å®‰å…¨æ¨¡å‹
```

#### **2. KRaftæ¶æ„**

```java
// KRaftæ§åˆ¶å™¨é›†ç¾¤
class KRaftControllerCluster {
    // æ§åˆ¶å™¨èŠ‚ç‚¹ç±»å‹
    enum NodeType {
        CONTROLLER,  # çº¯æ§åˆ¶å™¨
        BROKER,      # çº¯Broker
        COMBINED     # æ§åˆ¶å™¨+Broker
    }
    
    // ä»²è£æœºåˆ¶
    class Quorum {
        List<Voter> voters;  # æŠ•ç¥¨æˆå‘˜
        int quorumSize;      # æ³•å®šäººæ•°
        
        // é€‰ä¸¾Leader
        void electLeader() {
            // åŸºäºRaftåè®®é€‰ä¸¾
            // éœ€è¦å¤šæ•°èŠ‚ç‚¹åŒæ„
        }
    }
}
```

#### ä¹ã€æ€»ç»“ï¼šé«˜å¯ç”¨æ ¸å¿ƒè¦ç´ 

| **ç»„ä»¶**            | **é«˜å¯ç”¨æœºåˆ¶** | **æ•…éšœæ¢å¤æ—¶é—´** | **æ•°æ®ä¸€è‡´æ€§** |
| ------------------- | -------------- | ---------------- | -------------- |
| **å‰¯æœ¬**            | å¤šå‰¯æœ¬å¤åˆ¶     | ç§’çº§è‡ªåŠ¨åˆ‡æ¢     | ISRä¿è¯        |
| **Leader**          | è‡ªåŠ¨é€‰ä¸¾       | ç§’çº§åˆ‡æ¢         | é˜²æ­¢è„‘è£‚       |
| **Controller**      | ä¸»å¤‡åˆ‡æ¢       | ç§’çº§æ¢å¤         | çŠ¶æ€åŒæ­¥       |
| **ZooKeeper/KRaft** | é›†ç¾¤ä»²è£       | æ¯«ç§’çº§æ£€æµ‹       | å¼ºä¸€è‡´         |

**é«˜å¯ç”¨æ€§ç­‰çº§**ï¼š

```markdown
1. åŸºç¡€é«˜å¯ç”¨ï¼šå‰¯æœ¬å› å­=2ï¼Œå…è®¸1ä¸ªBrokeræ•…éšœ
2. ç”Ÿäº§é«˜å¯ç”¨ï¼šå‰¯æœ¬å› å­=3ï¼Œmin.insync.replicas=2ï¼Œå…è®¸1ä¸ªBrokeræ•…éšœ
3. é‡‘èçº§é«˜å¯ç”¨ï¼šå‰¯æœ¬å› å­=5ï¼Œè·¨æœºæˆ¿éƒ¨ç½²ï¼Œå…è®¸2ä¸ªBrokeræ•…éšœ
```

**æ ¸å¿ƒåŸåˆ™**ï¼š

1. **æ•°æ®å†—ä½™**ï¼šå¤šå‰¯æœ¬ä¿è¯æ•°æ®ä¸ä¸¢å¤±
2. **è‡ªåŠ¨æ•…éšœè½¬ç§»**ï¼šLeaderè‡ªåŠ¨åˆ‡æ¢ä¿è¯æœåŠ¡è¿ç»­
3. **çŠ¶æ€åŒæ­¥**ï¼šISRæœºåˆ¶ä¿è¯æ•°æ®ä¸€è‡´æ€§
4. **é¿å…å•ç‚¹**ï¼šControllerä¸»å¤‡ï¼ŒZooKeeperé›†ç¾¤

**ä¸€å¥è¯æ€»ç»“**ï¼š

> **Kafkaé€šè¿‡å‰¯æœ¬å†—ä½™ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼ŒLeaderé€‰ä¸¾ä¿è¯æœåŠ¡ä¸ä¸­æ–­ï¼ŒISRæœºåˆ¶ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼ŒControllerä¸»å¤‡ä¿è¯é›†ç¾¤ç®¡ç†ä¸ä¸­æ–­ï¼Œå…±åŒæ„å»ºé«˜å¯ç”¨æ¶ˆæ¯ç³»ç»Ÿã€‚**



## **ç³»ç»Ÿ-å¯æ‰©å±•**

> åˆ†åŒºæœºåˆ¶Partitionï¼Œè´Ÿè½½å‡è¡¡ç­–ç•¥

**Kafkaé€šè¿‡åˆ†åŒºæœºåˆ¶å®ç°æ°´å¹³æ‰©å±•ï¼Œç”Ÿäº§è€…é€šè¿‡åˆ†åŒºç­–ç•¥åˆ†æ•£å†™å…¥è´Ÿè½½ï¼Œæ¶ˆè´¹è€…é€šè¿‡åˆ†é…ç­–ç•¥å¹³è¡¡å¤„ç†è´Ÿè½½ï¼Œåˆç†è§„åˆ’åˆ†åŒºæ•°å’Œåˆ†é…ç­–ç•¥æ˜¯æ‰©å±•æ€§çš„å…³é”®ã€‚**

### ä¸€ã€åˆ†åŒºæœºåˆ¶(Partition)ï¼šæ°´å¹³æ‰©å±•çš„æ ¸å¿ƒ

#### **1. åˆ†åŒºæ ¸å¿ƒæ¦‚å¿µ**

```java
// åˆ†åŒºå®šä¹‰
class PartitionDefinition {
    // åˆ†åŒºæ˜¯Topicçš„ç‰©ç†åˆ†ç‰‡
    class TopicPartition {
        String topic;      // ä¸»é¢˜åç§°
        int partitionId;   // åˆ†åŒºIDï¼ˆä»0å¼€å§‹ï¼‰
        
        // åˆ†åŒºç‰¹æ€§ï¼š
        // 1. æœ‰åºæ¶ˆæ¯é˜Ÿåˆ—
        // 2. ä¸å¯å˜æ—¥å¿—
        // 3. ç‹¬ç«‹å­˜å‚¨å•å…ƒ
    }
    
    // åˆ†åŒºå­˜å‚¨ç»“æ„
    class PartitionStorage {
        // æ¯ä¸ªåˆ†åŒºæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ—¥å¿—ç›®å½•
        // /data/kafka/logs/topic-0/
        //   â”œâ”€â”€ 00000000000000000000.log
        //   â”œâ”€â”€ 00000000000000000000.index
        //   â””â”€â”€ 00000000000000000000.timeindex
        
        List<LogSegment> segments;  // åˆ†æ®µå­˜å‚¨
        long baseOffset;            // èµ·å§‹åç§»é‡
        long logEndOffset;          // æ—¥å¿—æœ«ç«¯åç§»é‡
    }
}
```

**åˆ†åŒºæ ¸å¿ƒç‰¹æ€§**ï¼š

```markdown
âœ… é¡ºåºå†™å…¥ï¼šæ¶ˆæ¯è¿½åŠ åˆ°æœ«å°¾
âœ… ä¸å¯ä¿®æ”¹ï¼šå†™å…¥åä¸èƒ½ä¿®æ”¹
âœ… ç‹¬ç«‹ç´¢å¼•ï¼šæ¯ä¸ªåˆ†åŒºæœ‰ç‹¬ç«‹ç´¢å¼•
âœ… å¹¶è¡Œå¤„ç†ï¼šä¸åŒåˆ†åŒºå¯å¹¶è¡Œè¯»å†™
```

#### **2. åˆ†åŒºåˆ›å»ºä¸é…ç½®**

```bash
# åˆ›å»ºTopicæ—¶æŒ‡å®šåˆ†åŒºæ•°
kafka-topics.sh --create \
  --topic user-events \
  --partitions 6 \          # 6ä¸ªåˆ†åŒº
  --replication-factor 3 \
  --bootstrap-server localhost:9092

# ä¿®æ”¹åˆ†åŒºæ•°ï¼ˆåªèƒ½å¢åŠ ï¼Œä¸èƒ½å‡å°‘ï¼‰
kafka-topics.sh --alter \
  --topic user-events \
  --partitions 12 \         # æ‰©å®¹åˆ°12ä¸ªåˆ†åŒº
  --bootstrap-server localhost:9092
// ç¼–ç¨‹æ–¹å¼åˆ›å»ºåˆ†åŒº
Properties props = new Properties();
props.put("bootstrap.servers", "localhost:9092");

try (AdminClient admin = AdminClient.create(props)) {
    // åˆ›å»ºTopicé…ç½®
    NewTopic newTopic = new NewTopic("user-events", 6, (short) 3)
        .configs(Map.of(
            "cleanup.policy", "delete",
            "retention.ms", "604800000",  // 7å¤©
            "segment.bytes", "1073741824"  // 1GB
        ));
    
    CreateTopicsResult result = admin.createTopics(
        Collections.singleton(newTopic)
    );
    
    result.all().get(30, TimeUnit.SECONDS);
}
```

#### **3. åˆ†åŒºæ‰©å®¹ç­–ç•¥**

```java
// åˆ†åŒºæ‰©å®¹å†³ç­–ç®—æ³•
class PartitionScalingStrategy {
    
    // è®¡ç®—ç†æƒ³åˆ†åŒºæ•°
    int calculateOptimalPartitions(TopicMetrics metrics) {
        // æ–¹æ³•1ï¼šåŸºäºååé‡
        double currentThroughput = metrics.getMessagesPerSecond();
        double targetThroughputPerPartition = 10000;  // ç›®æ ‡ï¼šæ¯ä¸ªåˆ†åŒº1ä¸‡æ¡/ç§’
        
        int partitionsByThroughput = (int) Math.ceil(
            currentThroughput / targetThroughputPerPartition
        );
        
        // æ–¹æ³•2ï¼šåŸºäºæ¶ˆè´¹è€…æ•°
        int consumerCount = getConsumerCount();
        int partitionsByConsumers = Math.max(1, consumerCount);
        
        // æ–¹æ³•3ï¼šåŸºäºç£ç›˜IO
        double diskIOLimit = getDiskIOLimit();
        double partitionIOLimit = 50 * 1024 * 1024;  // 50MB/s æ¯ä¸ªåˆ†åŒº
        int partitionsByIO = (int) Math.ceil(diskIOLimit / partitionIOLimit);
        
        // å–æœ€å¤§å€¼ï¼Œå¹¶å‘ä¸Šå–æ•´åˆ°2çš„å¹‚ï¼ˆæœ‰åˆ©äºå‡åŒ€åˆ†å¸ƒï¼‰
        int maxPartitions = Math.max(Math.max(
            partitionsByThroughput, 
            partitionsByConsumers), 
            partitionsByIO
        );
        
        return nextPowerOfTwo(maxPartitions);
    }
    
    private int nextPowerOfTwo(int n) {
        return 1 << (32 - Integer.numberOfLeadingZeros(n - 1));
    }
}
```

### äºŒã€ç”Ÿäº§è€…è´Ÿè½½å‡è¡¡ç­–ç•¥

#### **1. é»˜è®¤åˆ†åŒºç­–ç•¥**

> ç²˜æ€§åˆ†åŒºï¼šstickyPartition

```java
// é»˜è®¤åˆ†åŒºå™¨å®ç°
class DefaultPartitioner implements Partitioner {
    
    @Override
    public int partition(String topic, Object key, byte[] keyBytes, 
                        Object value, byte[] valueBytes, Cluster cluster) {
        
        List<PartitionInfo> partitions = cluster.availablePartitionsForTopic(topic);
        int numPartitions = partitions.size();
        
        if (keyBytes == null) {
            // æ— Keyï¼šä½¿ç”¨ç²˜æ€§åˆ†åŒºç­–ç•¥
            return stickyPartition(topic, numPartitions);
        } else {
            // æœ‰Keyï¼šåŸºäºKeyçš„å“ˆå¸Œå€¼
            return Utils.toPositive(Utils.murmur2(keyBytes)) % numPartitions;
        }
    }
    
    // ç²˜æ€§åˆ†åŒºï¼šæé«˜æ‰¹æ¬¡æ•ˆç‡
    private int stickyPartition(String topic, int numPartitions) {
        // åŒä¸€æ‰¹æ¶ˆæ¯å°½é‡å‘é€åˆ°åŒä¸€åˆ†åŒº
        Integer stickyPartition = stickyPartitionCache.get(topic);
        if (stickyPartition == null || batchFull) {
            stickyPartition = nextPartition(topic, numPartitions);
            stickyPartitionCache.put(topic, stickyPartition);
        }
        return stickyPartition;
    }
    
    private int nextPartition(String topic, int numPartitions) {
        int nextValue = nextValue(topic);
        List<PartitionInfo> availablePartitions = cluster.availablePartitionsForTopic(topic);
        if (availablePartitions.size() > 0) {
            int part = Utils.toPositive(nextValue) % availablePartitions.size();
            return availablePartitions.get(part).partition();
        } else {
            return Utils.toPositive(nextValue) % numPartitions;
        }
    }
}
```

#### **2. è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥**

```java
// ä¸šåŠ¡å®šåˆ¶åŒ–åˆ†åŒºç­–ç•¥
public class BusinessPartitioner implements Partitioner {
    
    // åœºæ™¯1ï¼šç”¨æˆ·IDåˆ†åŒºï¼ˆä¿è¯åŒä¸€ç”¨æˆ·æ¶ˆæ¯æœ‰åºï¼‰
    @Override
    public int partition(String topic, Object key, byte[] keyBytes, 
                        Object value, byte[] valueBytes, Cluster cluster) {
        
        List<PartitionInfo> partitions = cluster.partitionsForTopic(topic);
        int numPartitions = partitions.size();
        
        if (key == null) {
            throw new InvalidRecordException("Key cannot be null");
        }
        
        String userId = (String) key;
        
        // ä¸šåŠ¡é€»è¾‘ï¼šVIPç”¨æˆ·åˆ†é…åˆ°ç‹¬ç«‹åˆ†åŒº
        if (userId.startsWith("VIP_")) {
            return numPartitions - 1;  // æœ€åä¸€ä¸ªåˆ†åŒºç»™VIPç”¨æˆ·
        }
        
        // æ™®é€šç”¨æˆ·ï¼šHashåå–æ¨¡
        int hash = userId.hashCode();
        return Math.abs(hash) % (numPartitions - 1);
    }
    
    // åœºæ™¯2ï¼šæ—¶é—´çª—å£åˆ†åŒº
    public int timeBasedPartition(String topic, long timestamp, int numPartitions) {
        // æŒ‰å°æ—¶åˆ†åŒº
        long hour = timestamp / (60 * 60 * 1000);
        return (int) (hour % numPartitions);
    }
    
    // åœºæ™¯3ï¼šåœ°ç†ä½ç½®åˆ†åŒº
    public int geoBasedPartition(String topic, String region, int numPartitions) {
        Map<String, Integer> regionToPartition = Map.of(
            "east", 0,
            "west", 1,
            "north", 2,
            "south", 3
        );
        
        return regionToPartition.getOrDefault(region, 0) % numPartitions;
    }
}
```

#### **3. åˆ†åŒºç­–ç•¥é…ç½®**

```java
// ç”Ÿäº§è€…é…ç½®åˆ†åŒºå™¨
Properties producerProps = new Properties();
producerProps.put("bootstrap.servers", "localhost:9092");
producerProps.put("key.serializer", "org.apache.kafka.common.serialization.StringSerializer");
producerProps.put("value.serializer", "org.apache.kafka.common.serialization.StringSerializer");
producerProps.put("partitioner.class", "com.example.BusinessPartitioner");  // è‡ªå®šä¹‰åˆ†åŒºå™¨

// å¯ç”¨ç²˜æ€§åˆ†åŒºä¼˜åŒ–
producerProps.put(ProducerConfig.PARTITIONER_ADPATIVE_PARTITIONING_ENABLE_CONFIG, "true");
producerProps.put(ProducerConfig.PARTITIONER_AVAILABILITY_TIMEOUT_MS_CONFIG, "0");
```

### ä¸‰ã€æ¶ˆè´¹è€…è´Ÿè½½å‡è¡¡ç­–ç•¥

#### **1. æ¶ˆè´¹è€…ç»„ä¸åˆ†åŒºåˆ†é…**

```java
// åˆ†åŒºåˆ†é…ç­–ç•¥æ¥å£
interface PartitionAssignor {
    String name();
    
    // åˆ†é…åˆ†åŒºç»™æ¶ˆè´¹è€…
    Map<String, List<TopicPartition>> assign(
        Map<String, Integer> partitionsPerTopic,
        Map<String, Subscription> subscriptions
    );
    
    // æ”¯æŒç‰ˆæœ¬
    List<Short> supportedVersions();
}
```

#### **2. å†…ç½®åˆ†é…ç­–ç•¥å¯¹æ¯”**

```java
// 1. RangeAssignorï¼ˆé»˜è®¤ï¼‰
class RangeAssignorExample {
    // åˆ†é…é€»è¾‘ï¼šæŒ‰å­—å…¸åºåˆ†é…
    // ç¤ºä¾‹ï¼š3ä¸ªåˆ†åŒºï¼Œ2ä¸ªæ¶ˆè´¹è€…
    // Consumer A: [P0, P1]
    // Consumer B: [P2]
    
    // é—®é¢˜ï¼šå¯èƒ½åˆ†é…ä¸å‡
    // 3ä¸ªåˆ†åŒºï¼Œ2ä¸ªæ¶ˆè´¹è€… â†’ 2+1
    // 4ä¸ªåˆ†åŒºï¼Œ2ä¸ªæ¶ˆè´¹è€… â†’ 2+2
    // 5ä¸ªåˆ†åŒºï¼Œ2ä¸ªæ¶ˆè´¹è€… â†’ 3+2 â† ä¸å‡ï¼
}
// 2. RoundRobinAssignor
class RoundRobinAssignorExample {
    // åˆ†é…é€»è¾‘ï¼šè½®è¯¢åˆ†é…
    // ç¤ºä¾‹ï¼š3ä¸ªåˆ†åŒºï¼Œ2ä¸ªæ¶ˆè´¹è€…
    // Consumer A: [P0, P2]
    // Consumer B: [P1]
    
    // ä¼˜åŠ¿ï¼šæ›´å‡è¡¡
    // é™åˆ¶ï¼šéœ€è¦æ‰€æœ‰æ¶ˆè´¹è€…è®¢é˜…ç›¸åŒTopic
}
// 3. StickyAssignorï¼ˆæ¨èï¼‰
class StickyAssignorExample {
    // åˆ†é…é€»è¾‘ï¼šå°½å¯èƒ½ä¿æŒåŸæœ‰åˆ†é…
    // ç›®æ ‡ï¼šæœ€å°åŒ–åˆ†åŒºç§»åŠ¨
    
    // ä¼˜åŠ¿ï¼š
    // 1. å‡å°‘é‡å¹³è¡¡å¼€é”€
    // 2. æ›´å‡è¡¡çš„åˆ†é…
    // 3. æ”¯æŒå¢é‡é‡å¹³è¡¡
    
    void reassignWithSticky() {
        // é‡å¹³è¡¡å‰ï¼šA:[P0,P1], B:[P2,P3]
        // æ–°å¢Consumer C
        // é‡å¹³è¡¡åï¼šA:[P0,P2], B:[P1], C:[P3]
        // åªç§»åŠ¨äº†1ä¸ªåˆ†åŒº
    }
}
// 4. CooperativeStickyAssignorï¼ˆKafka 2.4+ï¼‰
class CooperativeStickyAssignorExample {
    // å¢é‡é‡å¹³è¡¡ï¼šåªé‡æ–°åˆ†é…å—å½±å“çš„åˆ†åŒº
    // æ”¯æŒå¤šæ¬¡é‡å¹³è¡¡é€æ­¥å®Œæˆ
    
    void incrementalRebalance() {
        // ç¬¬ä¸€æ¬¡é‡å¹³è¡¡ï¼šæ ‡è®°éœ€è¦ç§»åŠ¨çš„åˆ†åŒº
        // ç¬¬äºŒæ¬¡é‡å¹³è¡¡ï¼šå®é™…ç§»åŠ¨åˆ†åŒº
        // å‡å°‘æœåŠ¡ä¸­æ–­æ—¶é—´
    }
}
```

#### **3. åˆ†é…ç­–ç•¥é…ç½®ä¸é€‰æ‹©**

```java
// é…ç½®åˆ†é…ç­–ç•¥
Properties consumerProps = new Properties();
consumerProps.put("bootstrap.servers", "localhost:9092");
consumerProps.put("group.id", "user-group");
consumerProps.put("key.deserializer", "org.apache.kafka.common.serialization.StringDeserializer");
consumerProps.put("value.deserializer", "org.apache.kafka.common.serialization.StringDeserializer");

// æ¨èé…ç½®ï¼šCooperativeStickyAssignor
consumerProps.put("partition.assignment.strategy", 
    "org.apache.kafka.clients.consumer.CooperativeStickyAssignor");

// æˆ–å¤šç­–ç•¥ç»„åˆ
consumerProps.put("partition.assignment.strategy", 
    "org.apache.kafka.clients.consumer.RangeAssignor," +
    "org.apache.kafka.clients.consumer.RoundRobinAssignor," +
    "org.apache.kafka.clients.consumer.StickyAssignor");
```

### å››ã€åˆ†åŒºé‡å¹³è¡¡ä¼˜åŒ–

#### **1. é‡å¹³è¡¡è§¦å‘æ¡ä»¶**

```java
// æ¶ˆè´¹è€…é‡å¹³è¡¡ç›‘å¬å™¨
class ConsumerRebalanceListenerExample implements ConsumerRebalanceListener {
    
    @Override
    public void onPartitionsRevoked(Collection<TopicPartition> partitions) {
        // åˆ†åŒºè¢«å›æ”¶å‰
        System.out.println("åˆ†åŒºå°†è¢«å›æ”¶: " + partitions);
        
        // æäº¤å·²å¤„ç†çš„ä½ç§»
        consumer.commitSync();
        
        // æ¸…ç†æœ¬åœ°çŠ¶æ€
        cleanupLocalState(partitions);
    }
    
    @Override
    public void onPartitionsAssigned(Collection<TopicPartition> partitions) {
        // åˆ†é…æ–°åˆ†åŒºå
        System.out.println("åˆ†é…åˆ°æ–°åˆ†åŒº: " + partitions);
        
        // åˆå§‹åŒ–çŠ¶æ€
        initializeState(partitions);
        
        // å¯è‡ªå®šä¹‰åˆå§‹ä½ç§»
        for (TopicPartition tp : partitions) {
            // ä»æŒ‡å®šä½ç½®å¼€å§‹æ¶ˆè´¹
            consumer.seek(tp, getStartingOffset(tp));
        }
    }
}
```

#### **2. é‡å¹³è¡¡ä¼˜åŒ–é…ç½®**

```properties
# æ¶ˆè´¹è€…é‡å¹³è¡¡ä¼˜åŒ–é…ç½®
# ä¼šè¯ç®¡ç†
session.timeout.ms=45000          # ä¼šè¯è¶…æ—¶ï¼ˆé»˜è®¤45ç§’ï¼‰
heartbeat.interval.ms=3000        # å¿ƒè·³é—´éš”ï¼ˆsession.timeout.msçš„1/3ä»¥å†…ï¼‰

# å¤„ç†æ§åˆ¶
max.poll.interval.ms=300000       # æœ€å¤§å¤„ç†æ—¶é—´ï¼ˆ5åˆ†é’Ÿï¼‰
max.poll.records=500              # æ¯æ¬¡æ‹‰å–æœ€å¤§è®°å½•æ•°

# é‡å¹³è¡¡ç­–ç•¥
partition.assignment.strategy=org.apache.kafka.clients.consumer.CooperativeStickyAssignor

# å¢é‡é‡å¹³è¡¡
enable.auto.commit=false
auto.commit.interval.ms=5000
```

#### **3. é™æ€æˆå‘˜èµ„æ ¼ï¼ˆå‡å°‘ä¸å¿…è¦é‡å¹³è¡¡ï¼‰**

```java
// é™æ€æˆå‘˜é…ç½®
Properties props = new Properties();
props.put("group.instance.id", "consumer-1");  // é™æ€æˆå‘˜ID
props.put("session.timeout.ms", "30000");

// ä¼˜åŠ¿ï¼š
// 1. æ¶ˆè´¹è€…é‡å¯ä¸ä¼šè§¦å‘é‡å¹³è¡¡
// 2. ä¼šè¯è¶…æ—¶å¯è®¾ç½®æ›´çŸ­
// 3. å‡å°‘åˆ†åŒºç§»åŠ¨

// æ³¨æ„ï¼šéœ€è¦Broker 2.3+
```

### äº”ã€æ°´å¹³æ‰©å±•æœ€ä½³å®è·µ

#### **1. åˆ†åŒºæ•°è§„åˆ’å…¬å¼**

```java
// åˆ†åŒºæ•°è®¡ç®—å·¥å…·
class PartitionCalculator {
    
    // æ–¹æ³•1ï¼šåŸºäºååé‡
    int byThroughput(double expectedMessagesPerSecond, double messagesPerPartitionPerSecond) {
        return (int) Math.ceil(expectedMessagesPerSecond / messagesPerPartitionPerSecond);
    }
    
    // æ–¹æ³•2ï¼šåŸºäºæ¶ˆè´¹è€…æ•°
    int byConsumerCount(int maxConsumers) {
        // æ¶ˆè´¹è€…æ•° â‰¤ åˆ†åŒºæ•°
        return maxConsumers;
    }
    
    // æ–¹æ³•3ï¼šåŸºäºBrokeræ•°
    int byBrokerCount(int brokerCount, int replicationFactor) {
        // ç¡®ä¿Leaderå‡åŒ€åˆ†å¸ƒ
        return brokerCount * 10;  // ç»éªŒå€¼ï¼šæ¯ä¸ªBroker 10ä¸ªLeader
    }
    
    // ç»¼åˆè®¡ç®—
    int calculateOptimalPartitions(String topic, Metrics metrics) {
        int byThroughput = byThroughput(
            metrics.expectedThroughput, 
            10000  // æ¯ä¸ªåˆ†åŒº1ä¸‡æ¡/ç§’
        );
        
        int byConsumers = byConsumerCount(metrics.maxConsumers);
        int byBrokers = byBrokerCount(metrics.brokerCount, 3);
        
        // å–æœ€å¤§å€¼ï¼Œå¹¶å‘ä¸Šå–æ•´åˆ°2çš„å¹‚
        int max = Math.max(Math.max(byThroughput, byConsumers), byBrokers);
        return nextPowerOfTwo(max);
    }
    
    // ç»éªŒæ³•åˆ™
    class Heuristics {
        // å°å‹ç³»ç»Ÿï¼š2-6ä¸ªåˆ†åŒº
        // ä¸­å‹ç³»ç»Ÿï¼š12-24ä¸ªåˆ†åŒº
        // å¤§å‹ç³»ç»Ÿï¼š50-100ä¸ªåˆ†åŒº
        // è¶…å¤§å‹ï¼š100-1000ä¸ªåˆ†åŒºï¼ˆéœ€è¦ç²¾å¿ƒè®¾è®¡ï¼‰
    }
}
```

#### **2. åˆ†åŒºæ‰©å®¹æ“ä½œ**

```bash
# å®‰å…¨æ‰©å®¹æ­¥éª¤
# 1. ç›‘æ§å½“å‰è´Ÿè½½
kafka-topics.sh --describe \
  --topic user-events \
  --bootstrap-server localhost:9092

# 2. åˆ›å»ºæ‰©å®¹è®¡åˆ’
#    è¯„ä¼°ï¼šå½“å‰åˆ†åŒºæ•°ã€è´Ÿè½½ã€æ¶ˆè´¹è€…æ•°

# 3. æ‰§è¡Œæ‰©å®¹ï¼ˆåªèƒ½å¢åŠ ï¼Œä¸èƒ½å‡å°‘ï¼‰
kafka-topics.sh --alter \
  --topic user-events \
  --partitions 24 \  # ä»12æ‰©å®¹åˆ°24
  --bootstrap-server localhost:9092

# 4. è§¦å‘é‡å¹³è¡¡
#    æ¶ˆè´¹è€…ä¼šè‡ªåŠ¨é‡æ–°åˆ†é…åˆ†åŒº

# 5. ç›‘æ§æ‰©å®¹åçŠ¶æ€
#    æ£€æŸ¥Leaderåˆ†å¸ƒã€è´Ÿè½½å‡è¡¡
```

#### **3. åˆ†åŒºåˆ†å¸ƒä¼˜åŒ–**

```java
// åˆ†åŒºLeaderå‡è¡¡å·¥å…·
class PartitionLeaderBalancer {
    
    // æ£€æŸ¥Leaderåˆ†å¸ƒ
    void checkLeaderDistribution(Cluster cluster) {
        Map<Integer, Integer> leaderCount = new HashMap<>();
        
        for (PartitionInfo partition : cluster.partitions()) {
            int leader = partition.leader().id();
            leaderCount.put(leader, leaderCount.getOrDefault(leader, 0) + 1);
        }
        
        // è®¡ç®—ä¸å‡è¡¡åº¦
        double avg = leaderCount.values().stream()
            .mapToInt(Integer::intValue).average().orElse(0);
        double stdDev = calculateStdDev(leaderCount.values());
        
        if (stdDev / avg > 0.3) {  // ä¸å‡è¡¡åº¦è¶…è¿‡30%
            triggerLeaderRebalance();
        }
    }
    
    // è§¦å‘Leaderé‡å¹³è¡¡
    void triggerLeaderRebalance() {
        kafka-preferred-replica-election.sh \
          --bootstrap-server localhost:9092 \
          --path-to-json-file reassign.json
    }
}
```

### å…­ã€è´Ÿè½½å‡è¡¡ç›‘æ§

#### **1. å…³é”®ç›‘æ§æŒ‡æ ‡**

```bash
# ç›‘æ§åˆ†åŒºè´Ÿè½½
kafka-run-class.sh kafka.tools.GetOffsetShell \
  --broker-list localhost:9092 \
  --topic user-events \
  --time -1

# ç›‘æ§æ¶ˆè´¹è€…Lag
kafka-consumer-groups.sh \
  --bootstrap-server localhost:9092 \
  --group user-group \
  --describe

# ç›‘æ§Leaderåˆ†å¸ƒ
kafka-topics.sh --describe \
  --under-replicated-partitions \
  --bootstrap-server localhost:9092
```

#### **2. Prometheusç›‘æ§é…ç½®**

```yaml
# å¯æ‰©å±•æ€§ç›‘æ§æŒ‡æ ‡
kafka_scalability_metrics:
  # åˆ†åŒºçº§åˆ«
  - kafka_log_logsize{partition="0"}  # åˆ†åŒºå¤§å°
  - kafka_server_brokertopicmetrics_bytesinpersec{topic="user-events", partition="0"}
  - kafka_server_brokertopicmetrics_bytesoutpersec{topic="user-events", partition="0"}
  
  # æ¶ˆè´¹è€…å‡è¡¡
  - kafka_consumer_fetch_manager_records_lag_max
  - kafka_consumer_fetch_manager_records_consumed_rate
  
  # åˆ†åŒºåˆ†å¸ƒ
  - kafka_controller_kafkacontroller_globalpartitioncount
  - kafka_controller_kafkacontroller_globaltopiccount
  
  # é‡å¹³è¡¡ç»Ÿè®¡
  - kafka_consumer_coordinator_rebalance_rate_per_hour
  - kafka_consumer_coordinator_rebalance_total
```

### ä¸ƒã€æ‰©å±•æ€§é™åˆ¶ä¸è§£å†³æ–¹æ¡ˆ

#### **1. åˆ†åŒºæ•°é™åˆ¶å› ç´ **

```java
// åˆ†åŒºæ•°é™åˆ¶åˆ†æ
class PartitionLimits {
    
    // é™åˆ¶å› ç´ 
    enum LimitingFactor {
        FILE_DESCRIPTORS,     // æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
        MEMORY,               // å†…å­˜æ¶ˆè€—
        NETWORK,              // ç½‘ç»œè¿æ¥æ•°
        ZOOKEEPER,            // ZooKeeperæ€§èƒ½
        METADATA              // å…ƒæ•°æ®å¤§å°
    }
    
    // è®¡ç®—æœ€å¤§åˆ†åŒºæ•°
    int calculateMaxPartitions(ClusterInfo info) {
        // åŸºäºæ–‡ä»¶æè¿°ç¬¦
        int byFD = info.maxFileDescriptors / 3;  // æ¯ä¸ªåˆ†åŒº3ä¸ªæ–‡ä»¶
        
        // åŸºäºå†…å­˜
        int byMemory = (int) (info.availableMemory * 0.8 / 0.001);  // æ¯ä¸ªåˆ†åŒºçº¦1MB
        
        // åŸºäºZooKeeper
        int byZK = 100000;  // ZooKeeperç¡¬é™åˆ¶
        
        return Math.min(Math.min(byFD, byMemory), byZK);
    }
}
```

#### **2. å¤§è§„æ¨¡é›†ç¾¤ä¼˜åŒ–**

```properties
# å¤§è§„æ¨¡é›†ç¾¤é…ç½®ä¼˜åŒ–
# Brokeré…ç½®
num.partitions=1000
default.replication.factor=3
num.recovery.threads.per.data.dir=4
num.io.threads=16
num.network.threads=8
background.threads=20

# ZooKeeperä¼˜åŒ–
zookeeper.session.timeout.ms=18000
zookeeper.connection.timeout.ms=15000
zookeeper.sync.time.ms=5000

# å®¢æˆ·ç«¯é…ç½®
metadata.max.age.ms=300000
reconnect.backoff.max.ms=1000
```

### å…«ã€æ‰©å±•æ€§æœ€ä½³å®è·µæ€»ç»“

| **æ‰©å±•ç»´åº¦** | **æ ¸å¿ƒæœºåˆ¶** | **ä¼˜åŒ–ç­–ç•¥**                | **ç›‘æ§æŒ‡æ ‡** |
| ------------ | ------------ | --------------------------- | ------------ |
| **å†™å…¥æ‰©å±•** | åˆ†åŒºæœºåˆ¶     | åˆç†åˆ†åŒºæ•°ï¼Œå‡åŒ€Keyåˆ†å¸ƒ     | åˆ†åŒºå†™å…¥é€Ÿç‡ |
| **æ¶ˆè´¹æ‰©å±•** | æ¶ˆè´¹è€…ç»„     | æ¶ˆè´¹è€…æ•°â‰¤åˆ†åŒºæ•°ï¼ŒStickyåˆ†é… | æ¶ˆè´¹è€…Lag    |
| **å­˜å‚¨æ‰©å±•** | å¤šBroker     | å‰¯æœ¬å‡è¡¡åˆ†å¸ƒï¼Œæœºæ¶æ„ŸçŸ¥      | ç£ç›˜ä½¿ç”¨ç‡   |
| **å¤„ç†æ‰©å±•** | å¹¶è¡Œå¤„ç†     | æ‰¹é‡å¤„ç†ï¼Œå¼‚æ­¥æäº¤          | å¤„ç†å»¶è¿Ÿ     |

#### **æ‰©å±•æ€§æ£€æŸ¥æ¸…å•**

```markdown
## Kafkaæ‰©å±•æ€§æ£€æŸ¥æ¸…å•

### âœ… åˆ†åŒºè®¾è®¡
- [ ] åˆ†åŒºæ•° = max(ååé‡éœ€æ±‚, æ¶ˆè´¹è€…æ•°, Brokeræ•°Ã—10)
- [ ] åˆ†åŒºæ•°å‘ä¸Šå–æ•´åˆ°2çš„å¹‚
- [ ] Keyè®¾è®¡ä¿è¯æ•°æ®å‡åŒ€åˆ†å¸ƒ
- [ ] é¿å…"çƒ­ç‚¹"åˆ†åŒº

### âœ… è´Ÿè½½å‡è¡¡
- [ ] ä½¿ç”¨StickyAssignoræˆ–CooperativeStickyAssignor
- [ ] é…ç½®åˆç†çš„é‡å¹³è¡¡å‚æ•°
- [ ] ç›‘æ§åˆ†åŒºLeaderåˆ†å¸ƒ
- [ ] å®šæœŸæ£€æŸ¥æ¶ˆè´¹è€…Lag

### âœ… æ€§èƒ½ç›‘æ§
- [ ] ç›‘æ§åˆ†åŒºå†™å…¥/è¯»å–é€Ÿç‡
- [ ] ç›‘æ§æ¶ˆè´¹è€…å¤„ç†å»¶è¿Ÿ
- [ ] ç›‘æ§Brokerèµ„æºä½¿ç”¨
- [ ] è®¾ç½®è‡ªåŠ¨åŒ–å‘Šè­¦

### âœ… å®¹é‡è§„åˆ’
- [ ] é¢„ç•™30%å®¹é‡ç¼“å†²
- [ ] å®šæœŸè¯„ä¼°æ‰©å®¹éœ€æ±‚
- [ ] å»ºç«‹è‡ªåŠ¨åŒ–æ‰©å®¹æµç¨‹
- [ ] æµ‹è¯•æœ€å¤§æ‰¿è½½èƒ½åŠ›
```



## **ç³»ç»Ÿ-å¯è¿è¥**

> è®¤è¯æˆæƒã€è¿è¥æ“ä½œã€å‚æ•°é…ç½®ã€ç›‘æ§æŒ‡æ ‡ã€æ’éšœè°ƒä¼˜ã€è®¡è´¹æ–¹æ¡ˆ

**Kafkaå¯è¿è¥ä½“ç³»åŒ…æ‹¬ï¼šè®¤è¯æˆæƒä¿å®‰å…¨ï¼Œè¿ç»´å‘½ä»¤ç®¡æ—¥å¸¸ï¼Œå‚æ•°é…ç½®è°ƒæ€§èƒ½ï¼Œç›‘æ§æŒ‡æ ‡çœ‹çŠ¶æ€ï¼Œæ’éšœè°ƒä¼˜è§£é—®é¢˜ï¼Œè®¡è´¹æ–¹æ¡ˆæ§æˆæœ¬ï¼Œå…­ä½ä¸€ä½“æ”¯æ’‘ç”Ÿäº§ç¨³å®šè¿è¡Œã€‚**

### ä¸€ã€è®¤è¯ä¸æˆæƒ

#### **1. è®¤è¯æœºåˆ¶**

```properties
# SASLè®¤è¯é…ç½®
# PLAINï¼ˆç®€å•ç”¨æˆ·åå¯†ç ï¼‰
sasl.mechanism=PLAIN
security.protocol=SASL_PLAINTEXT
sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required \
  username="admin" \
  password="admin-secret";

# SCRAMï¼ˆæ›´å®‰å…¨ï¼‰
sasl.mechanism=SCRAM-SHA-256
sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required \
  username="user1" \
  password="user1-password";

# SSLå®¢æˆ·ç«¯è®¤è¯
security.protocol=SSL
ssl.truststore.location=/path/to/truststore.jks
ssl.truststore.password=password
ssl.keystore.location=/path/to/keystore.jks
ssl.keystore.password=password
```

#### **2. æˆæƒæ§åˆ¶**

```bash
# ACLæƒé™ç®¡ç†
# åˆ›å»ºç”¨æˆ·æƒé™
kafka-acls.sh --authorizer-properties zookeeper.connect=localhost:2181 \
  --add --allow-principal User:alice \
  --operation All --topic test-topic

# æŸ¥çœ‹æƒé™
kafka-acls.sh --authorizer-properties zookeeper.connect=localhost:2181 \
  --list --topic test-topic

# å¸¸è§æƒé™æ“ä½œ
# Read, Write, Create, Delete, Describe, Alter, ClusterAction
```

### äºŒã€è¿è¥æ“ä½œ

#### **1. æ—¥å¸¸è¿ç»´å‘½ä»¤**

```bash
# Topicç®¡ç†
kafka-topics.sh --list --bootstrap-server localhost:9092
kafka-topics.sh --create --topic orders --partitions 3 --replication-factor 2
kafka-topics.sh --describe --topic orders
kafka-topics.sh --delete --topic orders

# æ¶ˆè´¹è€…ç»„ç®¡ç†
kafka-consumer-groups.sh --list --bootstrap-server localhost:9092
kafka-consumer-groups.sh --describe --group my-group
kafka-consumer-groups.sh --reset-offsets --to-earliest --group my-group --execute

# æ¶ˆæ¯æŸ¥çœ‹
kafka-console-consumer.sh --topic orders --from-beginning --bootstrap-server localhost:9092
kafka-console-producer.sh --topic orders --bootstrap-server localhost:9092
```

#### **2. æ•°æ®è¿ç§»ä¸å¹³è¡¡**

```bash
# åˆ†åŒºé‡å¹³è¡¡
kafka-reassign-partitions.sh --generate \
  --topics-to-move-json-file topics.json \
  --broker-list "0,1,2" --generate

kafka-reassign-partitions.sh --execute \
  --reassignment-json-file reassign.json

# ç›‘æ§è¿ç§»è¿›åº¦
kafka-reassign-partitions.sh --verify \
  --reassignment-json-file reassign.json
```

### ä¸‰ã€å…³é”®å‚æ•°é…ç½®

#### **1. Brokeræ ¸å¿ƒå‚æ•°**

```properties
# åŸºç¡€é…ç½®
broker.id=1
listeners=PLAINTEXT://:9092
advertised.listeners=PLAINTEXT://hostname:9092
log.dirs=/data/kafka/logs
num.partitions=8
default.replication.factor=3

# æ€§èƒ½é…ç½®
num.network.threads=3
num.io.threads=8
socket.send.buffer.bytes=102400
socket.receive.buffer.bytes=102400
socket.request.max.bytes=104857600

# å­˜å‚¨é…ç½®
log.segment.bytes=1073741824  # 1GB
log.retention.hours=168       # 7å¤©
log.retention.bytes=-1        # æ— é™åˆ¶
log.cleanup.policy=delete     # æˆ–compact
```

#### **2. ç”Ÿäº§è€…/æ¶ˆè´¹è€…å‚æ•°**

```properties
# ç”Ÿäº§è€…
acks=all                      # å¯é æ€§
retries=2147483647           # æ— é™é‡è¯•
batch.size=16384             # æ‰¹æ¬¡å¤§å°
linger.ms=5                  # æ‰¹æ¬¡ç­‰å¾…
compression.type=snappy      # å‹ç¼©
enable.idempotence=true      # å¹‚ç­‰æ€§

# æ¶ˆè´¹è€…
group.id=my-group
enable.auto.commit=false     # æ¨èæ‰‹åŠ¨æäº¤
auto.offset.reset=latest     # æˆ–earliest
max.poll.records=500
session.timeout.ms=10000
heartbeat.interval.ms=3000
```

### å››ã€ç›‘æ§æŒ‡æ ‡

#### **1. æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**

```bash
# é›†ç¾¤å¥åº·æ£€æŸ¥
kafka-cluster.sh --cluster my-cluster --health-check

# å…³é”®æŒ‡æ ‡æŸ¥çœ‹
# BrokeræŒ‡æ ‡
- ç£ç›˜ä½¿ç”¨ç‡
- CPUä½¿ç”¨ç‡
- ç½‘ç»œIO
- JVMå†…å­˜/GC

# TopicæŒ‡æ ‡
kafka-topics.sh --describe --under-replicated-partitions
kafka-topics.sh --describe --unavailable-partitions

# æ¶ˆè´¹è€…ç»„Lag
kafka-consumer-groups.sh --describe --group my-group
```

#### **2. Prometheusç›‘æ§é…ç½®**

```yaml
# å…³é”®æŒ‡æ ‡ç¤ºä¾‹
# Broker
- kafka_server_brokertopicmetrics_bytesinpersec
- kafka_server_brokertopicmetrics_bytesoutpersec
- kafka_network_requestmetrics_totaltimems

# Topic
- kafka_log_logsize
- kafka_log_logflushratandtimems

# æ¶ˆè´¹è€…
- kafka_consumer_fetch_manager_records_lag_max
- kafka_consumer_coordinator_rebalance_rate_per_hour
```

### äº”ã€æ’éšœä¸è°ƒä¼˜

#### **1. å¸¸è§é—®é¢˜æ’æŸ¥**

```bash
# 1. æ¶ˆæ¯å †ç§¯
kafka-consumer-groups.sh --describe --group my-group
# è§£å†³ï¼šå¢åŠ æ¶ˆè´¹è€…ï¼Œä¼˜åŒ–å¤„ç†é€»è¾‘

# 2. å‰¯æœ¬ä¸åŒæ­¥
kafka-topics.sh --describe --under-replicated-partitions
# è§£å†³ï¼šæ£€æŸ¥ç½‘ç»œï¼Œå¢åŠ replica.lag.time.max.ms

# 3. ç£ç›˜ç©ºé—´ä¸è¶³
df -h /data/kafka
# è§£å†³ï¼šè°ƒæ•´retentionç­–ç•¥ï¼Œå¢åŠ ç£ç›˜

# 4. é¢‘ç¹é‡å¹³è¡¡
# æ£€æŸ¥ï¼šsession.timeout.ms, max.poll.interval.ms
# è§£å†³ï¼šä¼˜åŒ–å¤„ç†æ—¶é—´ï¼Œå¢åŠ è¶…æ—¶é…ç½®
```

#### **2. æ€§èƒ½è°ƒä¼˜**

```properties
# å†™å…¥æ€§èƒ½ä¼˜åŒ–
# å¢åŠ æ‰¹æ¬¡
batch.size=65536
linger.ms=20
compression.type=lz4

# ç½‘ç»œä¼˜åŒ–
socket.send.buffer.bytes=131072
socket.receive.buffer.bytes=131072

# å†…å­˜ä¼˜åŒ–
buffer.memory=67108864
```

### å…­ã€è®¡è´¹æ–¹æ¡ˆ

**1. è®¡è´¹ç»´åº¦**

```yaml
# äº‘å‚å•†è®¡è´¹ç¤ºä¾‹ï¼ˆé˜¿é‡Œäº‘/è…¾è®¯äº‘ï¼‰
è®¡è´¹é¡¹:
  1. å®ä¾‹è§„æ ¼è´¹ç”¨
    - æŒ‰CPU/å†…å­˜/ç£ç›˜è§„æ ¼
    - æŒ‰å°æ—¶/æœˆè®¡è´¹
    
  2. å­˜å‚¨è´¹ç”¨
    - æŒ‰æ¶ˆæ¯å­˜å‚¨é‡(GB/æœˆ)
    - æŒ‰ä¿ç•™æ—¶é—´è®¡è´¹
    
  3. æµé‡è´¹ç”¨
    - å…¬ç½‘æµå…¥æµå‡ºæµé‡
    - è·¨å¯ç”¨åŒºæµé‡
    
  4. è¯·æ±‚æ¬¡æ•°
    - APIè°ƒç”¨æ¬¡æ•°
    - ç”Ÿäº§/æ¶ˆè´¹è¯·æ±‚æ•°
```

**2. æˆæœ¬ä¼˜åŒ–**

```markdown
# æˆæœ¬æ§åˆ¶ç­–ç•¥
1. åˆç†è®¾ç½®æ¶ˆæ¯ä¿ç•™æ—¶é—´
   - ä¸šåŠ¡æ•°æ®: 7-30å¤©
   - æ—¥å¿—æ•°æ®: 1-3å¤©
   - ç›‘æ§æ•°æ®: 1-7å¤©

2. å‹ç¼©æ¶ˆæ¯å‡å°‘å­˜å‚¨
   - å¯ç”¨å‹ç¼©(snappy/lz4)
   - å¤§æ¶ˆæ¯åˆ†ç‰‡

3. ä¼˜åŒ–ç”Ÿäº§æ¶ˆè´¹æ¨¡å¼
   - æ‰¹é‡æ“ä½œå‡å°‘è¯·æ±‚
   - åˆç†è®¾ç½®æ‰¹æ¬¡å¤§å°

4. é€‰æ‹©åˆé€‚çš„å®ä¾‹è§„æ ¼
   - æ ¹æ®ååé‡é€‰æ‹©
   - é¢„ç•™20-30% buffer
```

### ä¸ƒã€è¿è¥æœ€ä½³å®è·µ

#### **1. æ ‡å‡†åŒ–è¿ç»´æµç¨‹**

```markdown
# å˜æ›´ç®¡ç†
- ç”Ÿäº§å˜æ›´éœ€åœ¨éé«˜å³°æ—¶æ®µ
- å…ˆæµ‹è¯•ç¯å¢ƒéªŒè¯
- æœ‰å›æ»šæ–¹æ¡ˆ

# å®¹é‡è§„åˆ’
- ç›‘æ§ä½¿ç”¨è¶‹åŠ¿
- æå‰è§„åˆ’æ‰©å®¹
- è®¾ç½®å®¹é‡å‘Šè­¦

# å¤‡ä»½æ¢å¤
- å®šæœŸå¤‡ä»½å…³é”®é…ç½®
- æµ‹è¯•æ¢å¤æµç¨‹
- ç›‘æ§å¤‡ä»½çŠ¶æ€
```

#### **2. å‘Šè­¦é…ç½®**

```yaml
# å…³é”®å‘Šè­¦é¡¹
å‘Šè­¦è§„åˆ™:
  - ç£ç›˜ä½¿ç”¨ç‡ > 80%
  - CPUä½¿ç”¨ç‡ > 70%æŒç»­5åˆ†é’Ÿ
  - å‰¯æœ¬ä¸åŒæ­¥åˆ†åŒºæ•° > 3
  - æ¶ˆè´¹è€…Lag > 10000
  - Brokerå®•æœº
  
å‘Šè­¦æ¸ é“:
  - ä¼ä¸šå¾®ä¿¡/é’‰é’‰
  - çŸ­ä¿¡/ç”µè¯
  - é‚®ä»¶
```





# ç ”å‘æ•ˆèƒ½

- **ç ”å‘æµç¨‹**ï¼šå®£è®²ã€æ–¹æ¡ˆã€ç¼–ç ã€ä»£ç CRã€æµ‹è¯•ã€å‘å¸ƒã€è¿è¥
- **äº‘åŸç”Ÿåº”ç”¨**ï¼šCNCF Landscape/Trail Mapï¼Œdocker/k8s/istioï¼Œäº‘åŸç”Ÿæˆç†Ÿåº¦
- **å¼€å‘ç¯å¢ƒ**ï¼šä¸€é”®ç¯å¢ƒæ­å»ºï¼ˆæœºå™¨/é…ç½®/ä»£ç ï¼‰ï¼Œå¼€å‘IDE VSCODE/JetBrainsï¼Œæœ¬åœ°å¼€å‘&è¿œç¨‹è°ƒè¯•



## **ä»£ç ä»“åº“ Git**

> åŸºæœ¬å·¥ä½œåŸç†ï¼ˆæš‚å­˜åŒº/æœ¬åœ°/è¿œç¨‹ï¼‰ï¼Œå¸¸ç”¨æ“ä½œï¼Œå†²çªè§£å†³æ–¹æ³•...

### ä¸€ã€Gitæ ¸å¿ƒæ¶æ„ä¸å·¥ä½œæµç¨‹

#### **1. Gitä¸‰åŒºåŸŸæ¨¡å‹**

<img src="å·¥ç¨‹ç´ å…»ç¯‡ï¼ˆä¸­çº§ï¼‰.assets/image-20260206173849685.png" alt="image-20260206173849685" style="zoom:50%;" />

```
# ä¸‰åŒºåŸŸçŠ¶æ€æµè½¬
# å·¥ä½œåŒº â†’ æš‚å­˜åŒº
git add <file>                    # æ·»åŠ å•ä¸ªæ–‡ä»¶
git add .                         # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
git add -u                        # åªæ·»åŠ å·²è·Ÿè¸ªæ–‡ä»¶ï¼Œåªæäº¤ä¿®æ”¹ï¼Œä¸æ·»åŠ æ–°æ–‡ä»¶

# æš‚å­˜åŒº â†’ æœ¬åœ°ä»“åº“
git commit -m "æäº¤ä¿¡æ¯"          # åˆ›å»ºæäº¤
git commit --amend                # ä¿®æ”¹æœ€è¿‘æäº¤

# æœ¬åœ°ä»“åº“ â†” è¿œç¨‹ä»“åº“
git push origin main              # æ¨é€åˆ°è¿œç¨‹
git fetch origin                  # ä»è¿œç¨‹è·å–
git pull origin main              # è·å–å¹¶åˆå¹¶
```

ğŸ“ æ–‡ä»¶çŠ¶æ€ç±»æ¯”

æƒ³è±¡ä½ åœ¨ç®¡ç†ä¸€ä¸ªé¡¹ç›®æ–‡ä»¶å¤¹ï¼š

| æ–‡ä»¶çŠ¶æ€       | æ¯”å–»                                                    | Gitå‘½ä»¤æŸ¥çœ‹                                                  |
| -------------- | ------------------------------------------------------- | ------------------------------------------------------------ |
| **å·²è·Ÿè¸ªæ–‡ä»¶** | **æ¡£æ¡ˆå®¤é‡Œçš„æ­£å¼æ–‡ä»¶** å·²ç»åœ¨æ¡£æ¡ˆç³»ç»Ÿç™»è®°è¿‡ï¼Œæœ‰æ¡£æ¡ˆç¼–å· | `git status`æ˜¾ç¤ºåœ¨ **Changes to be committed** ï¼ˆå·²æäº¤åˆ°æœ¬åœ°ä»“åº“ï¼‰æˆ– **Changes not staged for commit**ï¼ˆè¿˜åœ¨æš‚å­˜åŒºï¼‰ ä¸­ |
| **æœªè·Ÿè¸ªæ–‡ä»¶** | **æ¡Œä¸Šæ–°æ¥çš„æ–‡ä»¶** è¿˜æ²¡è¿›å…¥æ¡£æ¡ˆç³»ç»Ÿï¼Œæ²¡äººç®¡ç†           | `git status`æ˜¾ç¤ºåœ¨ **Untracked files** ä¸­                    |
| **è¢«å¿½ç•¥æ–‡ä»¶** | **åƒåœ¾æ¡¶/åºŸçº¸** æ˜ç¡®å‘Šè¯‰Gitä¸è¦ç®¡è¿™äº›                   | åœ¨ `.gitignore`ä¸­åˆ—å‡ºçš„æ–‡ä»¶                                  |

ğŸ”„ æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸ

ä¸€ä¸ªæ–‡ä»¶åœ¨Gitä¸­çš„çŠ¶æ€å˜åŒ–æ˜¯è¿™æ ·çš„ï¼š

```markdown
æ–°å»ºæ–‡ä»¶ â†’ æœªè·Ÿè¸ªæ–‡ä»¶ â†’ git add â†’ å·²è·Ÿè¸ªæ–‡ä»¶ï¼ˆæš‚å­˜åŒºï¼‰ â†’ git commit â†’ å·²æäº¤æ–‡ä»¶
      â†‘          â†“
      â””â”€â”€ git rm â”€â”€â”˜ (ä»è·Ÿè¸ªä¸­ç§»é™¤)
```

ğŸ’¡ å®é™…ä¾‹å­

```bash
# åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®
mkdir my-project
cd my-project
git init

# 1. åˆ›å»ºä¸€äº›æ–‡ä»¶
echo "# README" > README.md
echo "console.log('hello')" > app.js
echo "node_modules" > .gitignore

# æŸ¥çœ‹çŠ¶æ€
git status
# è¾“å‡ºï¼š
# Untracked files:  (è¿™äº›éƒ½æ˜¯æœªè·Ÿè¸ªæ–‡ä»¶)
#   README.md
#   app.js
#   .gitignore

# 2. æ·»åŠ æ–‡ä»¶åˆ°è·Ÿè¸ª
git add README.md .gitignore
git status
# è¾“å‡ºï¼š
# Changes to be committed:  (è¿™äº›æ˜¯å·²è·Ÿè¸ªä¸”å·²æš‚å­˜)
#   new file: README.md
#   new file: .gitignore
#
# Untracked files:  (è¿™ä¸ªè¿˜æ˜¯æœªè·Ÿè¸ª)
#   app.js

# 3. æäº¤
git commit -m "Initial commit"
# ç°åœ¨ README.md å’Œ .gitignore æ˜¯å·²è·Ÿè¸ªçš„å·²æäº¤æ–‡ä»¶

# 4. ä¿®æ”¹å·²è·Ÿè¸ªæ–‡ä»¶
echo "## æ–°å†…å®¹" >> README.md
git status
# è¾“å‡ºï¼š
# Changes not staged for commit:  (å·²è·Ÿè¸ªæ–‡ä»¶æœ‰ä¿®æ”¹)
#   modified: README.md
#
# Untracked files:
#   app.js

# 5. ä½¿ç”¨ git add -u
git add -u
git status
# è¾“å‡ºï¼š
# Changes to be committed:  (README.md è¢«æš‚å­˜äº†)
#   modified: README.md
#
# Untracked files:  (app.js è¿˜æ˜¯æœªè·Ÿè¸ªï¼Œå› ä¸º -u ä¸æ·»åŠ æ–°æ–‡ä»¶)
#   app.js
```



#### **2. Gitå¯¹è±¡å­˜å‚¨åŸç†**

```bash
# Gitåº•å±‚å››å¤§å¯¹è±¡
.git/objects/
â”œâ”€â”€ blob/        # æ–‡ä»¶å†…å®¹
â”œâ”€â”€ tree/        # ç›®å½•ç»“æ„
â”œâ”€â”€ commit/      # æäº¤ä¿¡æ¯
â””â”€â”€ tag/         # æ ‡ç­¾

# æŸ¥çœ‹å¯¹è±¡
git cat-file -p HEAD              # æŸ¥çœ‹HEADæŒ‡å‘çš„commit
git cat-file -p <tree-sha>        # æŸ¥çœ‹æ ‘å¯¹è±¡
git cat-file -p <blob-sha>        # æŸ¥çœ‹æ–‡ä»¶å†…å®¹
```

### äºŒã€Gitæ ¸å¿ƒå·¥ä½œåŸç†

**1. æš‚å­˜åŒº(Stage)æœºåˆ¶**

```bash
# æš‚å­˜åŒºçŠ¶æ€ç®¡ç†
git status                         # æŸ¥çœ‹ä¸‰åŒºåŸŸçŠ¶æ€
git diff                           # å·¥ä½œåŒº vs æš‚å­˜åŒº
git diff --staged                  # æš‚å­˜åŒº vs æœ¬åœ°ä»“åº“
git diff HEAD                      # å·¥ä½œåŒº vs æœ¬åœ°ä»“åº“

# æš‚å­˜åŒºé«˜çº§æ“ä½œ
git add -p                         # äº¤äº’å¼æš‚å­˜
git reset HEAD <file>              # ä»æš‚å­˜åŒºç§»é™¤
git stash                          # ä¸´æ—¶ä¿å­˜å·¥ä½œåŒº
git stash pop                      # æ¢å¤å·¥ä½œåŒº
```

**2. åˆ†æ”¯ä¸åˆå¹¶æœºåˆ¶**

```bash
# åˆ†æ”¯ç®¡ç†
git branch                         # æŸ¥çœ‹æœ¬åœ°åˆ†æ”¯
git branch feature-x               # åˆ›å»ºåˆ†æ”¯
git checkout feature-x             # åˆ‡æ¢åˆ°åˆ†æ”¯
git checkout -b feature-x          # åˆ›å»ºå¹¶åˆ‡æ¢
git branch -d feature-x            # åˆ é™¤åˆ†æ”¯
git branch -m old-name new-name    # é‡å‘½ååˆ†æ”¯

# åˆå¹¶ç­–ç•¥
git merge feature-x                # æ™®é€šåˆå¹¶ï¼ˆä¸‰è·¯åˆå¹¶ï¼‰
git merge --squash feature-x       # å‹ç¼©åˆå¹¶
git merge --no-ff feature-x        # ç¦ç”¨å¿«è¿›åˆå¹¶
git rebase main                    # å˜åŸºåˆ°main
```

### ä¸‰ã€è¿œç¨‹ä»“åº“åä½œæµç¨‹

#### **1. è¿œç¨‹ä»“åº“æ“ä½œ**

```bash
# è¿œç¨‹ä»“åº“é…ç½®
git remote                         # æŸ¥çœ‹è¿œç¨‹ä»“åº“
git remote add origin <url>        # æ·»åŠ è¿œç¨‹ä»“åº“
git remote -v                      # æŸ¥çœ‹è¿œç¨‹URL
git remote set-url origin <new-url> # ä¿®æ”¹è¿œç¨‹URL
git remote remove origin           # åˆ é™¤è¿œç¨‹ä»“åº“

# æ¨é€ä¸æ‹‰å–
git push origin main               # æ¨é€åˆ°è¿œç¨‹mainåˆ†æ”¯
git push -u origin feature         # è®¾ç½®ä¸Šæ¸¸åˆ†æ”¯å¹¶æ¨é€
git push --force-with-lease        # å®‰å…¨å¼ºåˆ¶æ¨é€
git fetch --all                    # è·å–æ‰€æœ‰è¿œç¨‹åˆ†æ”¯
git pull origin main --rebase      # å˜åŸºå¼æ‹‰å–
```

#### **2. åä½œå¼€å‘æµç¨‹**

```bash
# æ ‡å‡†åä½œæµç¨‹
# 1. åŒæ­¥æœ€æ–°ä»£ç 
git checkout main
git pull origin main

# 2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
git checkout -b feature/login

# 3. å¼€å‘å¹¶æäº¤
git add .
git commit -m "å®ç°ç™»å½•åŠŸèƒ½"

# 4. åŒæ­¥ä¸»åˆ†æ”¯
git checkout main
git pull origin main
git checkout feature/login
git rebase main

# 5. æ¨é€åˆ°è¿œç¨‹
git push origin feature/login

# 6. åˆ›å»ºPull Request
```

### å››ã€å†²çªè§£å†³å®Œå…¨æŒ‡å—

#### **1. å†²çªäº§ç”ŸåŸå› ä¸é¢„é˜²**

```bash
# å†²çªäº§ç”Ÿåœºæ™¯
# åœºæ™¯1ï¼šåŒæ—¶ä¿®æ”¹åŒä¸€æ–‡ä»¶çš„åŒä¸€è¡Œ
# åœºæ™¯2ï¼šä¸€äººåˆ é™¤æ–‡ä»¶ï¼Œå¦ä¸€äººä¿®æ”¹
# åœºæ™¯3ï¼šåˆ†æ”¯åˆå¹¶å†²çª

# å†²çªé¢„é˜²ç­–ç•¥
# 1. é¢‘ç¹æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main --rebase

# 2. å°æ­¥æäº¤ï¼Œé¿å…å¤§æ”¹åŠ¨
git commit -m "å°åŠŸèƒ½æäº¤"

# 3. åˆç†åˆ†æ”¯ç­–ç•¥
# 4. å›¢é˜Ÿæ²Ÿé€šåè°ƒ
```

#### **2. å†²çªæ£€æµ‹ä¸å®šä½**

```bash
# åˆå¹¶å‰é¢„æµ‹å†²çª
git merge --no-commit --no-ff feature
git status                         # æŸ¥çœ‹å†²çªæ–‡ä»¶
git merge --abort                  # ä¸­æ­¢åˆå¹¶

# å˜åŸºå‰æ£€æŸ¥å†²çª
git rebase main
# å†²çªæ—¶ä¼šæš‚åœï¼Œæ˜¾ç¤ºCONFLICT
git status                         # æŸ¥çœ‹å…·ä½“å†²çª
```

#### **3. å†²çªè§£å†³å…·ä½“æ­¥éª¤**

```bash
# æ–¹æ³•1ï¼šæ‰‹åŠ¨è§£å†³ï¼ˆæ¨èï¼‰
<<<<<<< HEAD
å½“å‰åˆ†æ”¯çš„ä»£ç 
=======
åˆå¹¶åˆ†æ”¯çš„ä»£ç 
>>>>>>> feature-branch

# è§£å†³æ­¥éª¤ï¼š
1. ç¼–è¾‘å†²çªæ–‡ä»¶ï¼Œä¿ç•™éœ€è¦çš„å†…å®¹
2. åˆ é™¤å†²çªæ ‡è®°ï¼ˆ<<<<<<<, =======, >>>>>>>ï¼‰
3. ä¿å­˜æ–‡ä»¶
4. git add <resolved-file>
5. git commit æˆ– git rebase --continue
# æ–¹æ³•2ï¼šä½¿ç”¨åˆå¹¶å·¥å…·
git mergetool                      # å¯åŠ¨åˆå¹¶å·¥å…·
# å¸¸ç”¨å·¥å…·ï¼švimdiff, kdiff3, p4merge, meld

# é…ç½®åˆå¹¶å·¥å…·
git config --global merge.tool vimdiff
git config --global mergetool.prompt false
# æ–¹æ³•3ï¼šæ¥å—ç‰¹å®šç‰ˆæœ¬
# æ¥å—å½“å‰åˆ†æ”¯ç‰ˆæœ¬
git checkout --ours <file>
git add <file>

# æ¥å—åˆå¹¶åˆ†æ”¯ç‰ˆæœ¬
git checkout --theirs <file>
git add <file>

# æŸ¥çœ‹ä¸¤ä¸ªç‰ˆæœ¬å·®å¼‚
git diff --name-only --diff-filter=U  # æŸ¥çœ‹æ‰€æœ‰å†²çªæ–‡ä»¶
```

#### **4. å¤æ‚å†²çªå¤„ç†**

```bash
# åœºæ™¯1ï¼šåˆå¹¶å¤šä¸ªå†²çªæäº¤
# ä½¿ç”¨äº¤äº’å¼å˜åŸº
git rebase -i HEAD~3               # å¤„ç†æœ€è¿‘3ä¸ªæäº¤
# ç¼–è¾‘æ—¶é€‰æ‹©fixupæˆ–squash

# åœºæ™¯2ï¼šäºŒè¿›åˆ¶æ–‡ä»¶å†²çª
# é€šå¸¸æ— æ³•è‡ªåŠ¨åˆå¹¶
git checkout --ours image.png      # ä½¿ç”¨å½“å‰åˆ†æ”¯ç‰ˆæœ¬
git checkout --theirs image.png    # ä½¿ç”¨åˆå¹¶åˆ†æ”¯ç‰ˆæœ¬
# æˆ–æ‰‹åŠ¨å†³å®šä½¿ç”¨å“ªä¸ªç‰ˆæœ¬
```

#### **5. å†²çªè§£å†³åå¤„ç†**

```bash
# å®Œæˆåˆå¹¶
git commit                         # æäº¤åˆå¹¶ç»“æœ
# æˆ–
git rebase --continue              # ç»§ç»­å˜åŸº

# éªŒè¯è§£å†³
git log --oneline --graph          # æŸ¥çœ‹æäº¤å†å²
git status                         # ç¡®è®¤æ— æœªè§£å†³å†²çª
git diff HEAD^                     # æ£€æŸ¥æœ€ç»ˆå·®å¼‚
```

### äº”ã€Gité«˜çº§æ“ä½œ

#### **1. å†å²ä¿®æ”¹ä¸æ’¤é”€**

```bash
# ä¿®æ”¹æœ€è¿‘æäº¤
git commit --amend                 # ä¿®æ”¹æäº¤ä¿¡æ¯æˆ–å†…å®¹

# æ’¤é”€å·¥ä½œåŒºä¿®æ”¹
git checkout -- <file>             # ä¸¢å¼ƒå·¥ä½œåŒºä¿®æ”¹
git reset --hard HEAD              # é‡ç½®åˆ°æœ€æ–°æäº¤

# æ’¤é”€æš‚å­˜åŒº
git reset HEAD <file>              # ä»æš‚å­˜åŒºç§»é™¤
git reset --mixed HEAD~1           # å›é€€åˆ°ä¸Šä¸€ä¸ªæäº¤ï¼Œä¿ç•™ä¿®æ”¹

# æ’¤é”€æäº¤
git revert <commit-hash>           # åˆ›å»ºæ’¤é”€æäº¤
git reset --soft HEAD~1            # æ’¤é”€æäº¤ä½†ä¿ç•™ä¿®æ”¹
git reset --hard HEAD~1            # å½»åº•åˆ é™¤æäº¤
```

#### **2. æ ‡ç­¾ç®¡ç†**

```bash
# æ ‡ç­¾æ“ä½œ
git tag                            # æŸ¥çœ‹æ ‡ç­¾
git tag v1.0.0                     # åˆ›å»ºè½»é‡æ ‡ç­¾
git tag -a v1.0.0 -m "ç‰ˆæœ¬1.0.0"   # åˆ›å»ºé™„æ³¨æ ‡ç­¾
git show v1.0.0                    # æŸ¥çœ‹æ ‡ç­¾è¯¦æƒ…
git push origin v1.0.0             # æ¨é€æ ‡ç­¾åˆ°è¿œç¨‹
git push origin --tags             # æ¨é€æ‰€æœ‰æ ‡ç­¾
git tag -d v1.0.0                  # åˆ é™¤æœ¬åœ°æ ‡ç­¾
git push origin --delete v1.0.0    # åˆ é™¤è¿œç¨‹æ ‡ç­¾
```

#### **3. å­æ¨¡å—ç®¡ç†**

```bash
# å­æ¨¡å—æ“ä½œ
git submodule add <url> <path>     # æ·»åŠ å­æ¨¡å—
git submodule init                 # åˆå§‹åŒ–å­æ¨¡å—
git submodule update               # æ›´æ–°å­æ¨¡å—
git submodule foreach git pull     # æ›´æ–°æ‰€æœ‰å­æ¨¡å—
```

### å…­ã€Gitå·¥ä½œæµæœ€ä½³å®è·µ

#### **1. Git Flowå·¥ä½œæµ**

```bash
# Git Flowåˆ†æ”¯æ¨¡å‹
main                            # ä¸»åˆ†æ”¯ï¼Œç”Ÿäº§ä»£ç 
develop                         # å¼€å‘åˆ†æ”¯
feature/*                       # åŠŸèƒ½åˆ†æ”¯
release/*                       # å‘å¸ƒåˆ†æ”¯
hotfix/*                        # çƒ­ä¿®å¤åˆ†æ”¯

# å¸¸ç”¨å‘½ä»¤
git flow init                   # åˆå§‹åŒ–Git Flow
git flow feature start login    # å¼€å§‹æ–°åŠŸèƒ½
git flow feature finish login   # å®ŒæˆåŠŸèƒ½
git flow release start 1.0.0    # å¼€å§‹å‘å¸ƒ
git flow release finish 1.0.0   # å®Œæˆå‘å¸ƒ
git flow hotfix start bugfix    # å¼€å§‹çƒ­ä¿®å¤
```

#### **2. GitHub Flowå·¥ä½œæµ**

```bash
# ç®€åŒ–å·¥ä½œæµ
main                            # ä¸»åˆ†æ”¯ï¼Œå¯éƒ¨ç½²çŠ¶æ€
feature/*                       # åŠŸèƒ½åˆ†æ”¯

# æµç¨‹ï¼š
# 1. ä»mainåˆ›å»ºåˆ†æ”¯
git checkout -b feature-x
# 2. å¼€å‘å¹¶æäº¤
# 3. æ¨é€å¹¶åˆ›å»ºPR
git push origin feature-x
# 4. ä»£ç å®¡æŸ¥
# 5. åˆå¹¶åˆ°main
```

### ä¸ƒã€Gité…ç½®ä¸ä¼˜åŒ–

#### **1. åŸºç¡€é…ç½®(aliasç­‰ï¼‰**

```bash
# ç”¨æˆ·é…ç½®
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"
git config --global core.editor vim

# åˆ«åé…ç½®
git config --global alias.co checkout
git config --global alias.br branch
git config --global alias.ci commit
git config --global alias.st status
git config --global alias.lg "log --oneline --graph --all"
```

#### **2. æ€§èƒ½ä¼˜åŒ–**

```bash
# å¤§ä»“åº“ä¼˜åŒ–
git config --global core.preloadindex true
git config --global core.fscache true
git config --global gc.auto 256

# ä½¿ç”¨æµ…å…‹éš†
git clone --depth 1 <url>

# æ¸…ç†ä»“åº“
git gc --aggressive --prune=now
git repack -a -d --depth=250 --window=250
```

### å…«ã€Gitæ’éšœä¸è°ƒè¯•

#### **1. å¸¸è§é—®é¢˜è§£å†³**

```bash
# 1. æäº¤åˆ°é”™è¯¯åˆ†æ”¯
git reset --soft HEAD~1          # æ’¤é”€æäº¤
git stash                         # ä¿å­˜ä¿®æ”¹
git checkout correct-branch       # åˆ‡æ¢åˆ°æ­£ç¡®åˆ†æ”¯
git stash pop                     # åº”ç”¨ä¿®æ”¹
git commit -m "æ­£ç¡®çš„æäº¤"

# 2. è¯¯åˆ åˆ†æ”¯æ¢å¤
git reflog                        # æŸ¥çœ‹æ“ä½œå†å²
git checkout -b feature <hash>    # ä»è®°å½•æ¢å¤

# 3. å¤§æ–‡ä»¶æäº¤
# ä½¿ç”¨git-lfs
git lfs install
git lfs track "*.psd"
git add .gitattributes
```

#### **2. è°ƒè¯•å·¥å…·**

```bash
# æŸ¥çœ‹æäº¤å†å²
git log --oneline --graph --all
git log --stat                    # æ˜¾ç¤ºæ–‡ä»¶ä¿®æ”¹ç»Ÿè®¡
git log -p                        # æ˜¾ç¤ºè¯¦ç»†ä¿®æ”¹
git log --since="2 weeks ago"

# æ–‡ä»¶è¿½æº¯
git blame <file>                  # æŸ¥çœ‹æ¯è¡Œæœ€åä¿®æ”¹
git show <commit>:<file>          # æŸ¥çœ‹å†å²æ–‡ä»¶å†…å®¹
git diff HEAD~3 HEAD              # æ¯”è¾ƒå†å²ç‰ˆæœ¬
```

### ä¹ã€ä¼ä¸šçº§Gitå®è·µ

#### **1. æäº¤è§„èŒƒ**

```bash
# æäº¤ä¿¡æ¯æ ¼å¼
<type>(<scope>): <subject>

# ç±»å‹è¯´æ˜ï¼š
# feat: æ–°åŠŸèƒ½
# fix: ä¿®å¤bug
# docs: æ–‡æ¡£æ›´æ–°
# style: ä»£ç æ ¼å¼
# refactor: é‡æ„
# test: æµ‹è¯•
# chore: æ„å»º/å·¥å…·

# ç¤ºä¾‹ï¼š
git commit -m "feat(auth): æ·»åŠ ç”¨æˆ·ç™»å½•åŠŸèƒ½"
git commit -m "fix(api): ä¿®å¤ç”¨æˆ·æŸ¥è¯¢500é”™è¯¯"
```

#### **2. åˆ†æ”¯ä¿æŠ¤ç­–ç•¥**

```bash
# GitHub/GitLabé…ç½®
# 1. ä¿æŠ¤mainåˆ†æ”¯
# 2. è¦æ±‚ä»£ç å®¡æŸ¥
# 3. è¦æ±‚CIé€šè¿‡
# 4. ç¦æ­¢å¼ºåˆ¶æ¨é€
# 5. é™åˆ¶åˆå¹¶æƒé™

# æœ¬åœ°éªŒè¯
pre-commit install                # å®‰è£…pre-commité’©å­
husky install                     # ä½¿ç”¨huskyç®¡ç†Gité’©å­
```

### åã€æ€»ç»“ï¼šGitæ ¸å¿ƒè¦ç‚¹

| **æ¦‚å¿µ**   | **å‘½ä»¤**   | **ç”¨é€”** | **æ³¨æ„äº‹é¡¹**       |
| ---------- | ---------- | -------- | ------------------ |
| **æš‚å­˜åŒº** | git add    | å‡†å¤‡æäº¤ | å¯åˆ†æ‰¹æäº¤         |
| **æäº¤**   | git commit | ä¿å­˜å¿«ç…§ | æäº¤ä¿¡æ¯è¦æ¸…æ™°     |
| **åˆ†æ”¯**   | git branch | å¹¶è¡Œå¼€å‘ | åŠæ—¶åˆå¹¶           |
| **åˆå¹¶**   | git merge  | é›†æˆä»£ç  | è§£å†³å†²çª           |
| **å˜åŸº**   | git rebase | æ•´ç†å†å² | ä¸è¦å¯¹å…¬å…±åˆ†æ”¯å˜åŸº |
| **æ¨é€**   | git push   | åŒæ­¥è¿œç¨‹ | å…ˆpullå†push       |
| **æ‹‰å–**   | git pull   | è·å–æ›´æ–° | æ³¨æ„å†²çª           |

**Gitå·¥ä½œæµç¨‹è®°å¿†å£è¯€**ï¼š

```markdown
å·¥ä½œç›®å½•åšä¿®æ”¹ï¼Œgit addåˆ°æš‚å­˜åŒº
æš‚å­˜åŒºé‡Œå‡†å¤‡å¥½ï¼Œgit commitå­˜æœ¬åœ°
æœ¬åœ°æäº¤è¦åŒæ­¥ï¼Œgit pushåˆ°è¿œç¨‹
å›¢é˜Ÿåä½œè¦æ›´æ–°ï¼Œgit pullæ‹‰æœ€æ–°
åˆ†æ”¯å¼€å‘æ˜¯å¸¸æ€ï¼Œmerge/rebaseæ¥åˆå¹¶
å†²çªè§£å†³è¦ä»”ç»†ï¼Œæ²Ÿé€šåè°ƒæœ€å…³é”®
```

**ä¸€å¥è¯æ€»ç»“**ï¼š

> **Gité€šè¿‡ä¸‰åŒºåŸŸï¼ˆå·¥ä½œåŒºã€æš‚å­˜åŒºã€æœ¬åœ°ä»“åº“ï¼‰ç®¡ç†ä»£ç å˜æ›´ï¼Œç»“åˆåˆ†æ”¯æœºåˆ¶æ”¯æŒå¹¶è¡Œå¼€å‘ï¼Œé…åˆè¿œç¨‹ä»“åº“å®ç°å›¢é˜Ÿåä½œï¼ŒæŒæ¡åŸºæœ¬æ“ä½œå’Œå†²çªè§£å†³æ˜¯é«˜æ•ˆä½¿ç”¨Gitçš„å…³é”®ã€‚**



### åä¸€ã€ä¸€äº›gitæŒ‡ä»¤

#### Git Stash 

##### è¯­æ³•

```bash
git stash -h
usage: git stash list [<log-options>]
   or: git stash show [-u | --include-untracked | --only-untracked] [<diff-options>] [<stash>]
   or: git stash drop [-q | --quiet] [<stash>]
   or: git stash pop [--index] [-q | --quiet] [<stash>]
   or: git stash apply [--index] [-q | --quiet] [<stash>]
   or: git stash branch <branchname> [<stash>]
   or: git stash [push [-p | --patch] [-S | --staged] [-k | --[no-]keep-index] [-q | --quiet]
                 [-u | --include-untracked] [-a | --all] [(-m | --message) <message>]
                 [--pathspec-from-file=<file> [--pathspec-file-nul]]
                 [--] [<pathspec>...]]
   or: git stash save [-p | --patch] [-S | --staged] [-k | --[no-]keep-index] [-q | --quiet]
                 [-u | --include-untracked] [-a | --all] [<message>]
   or: git stash clear
   or: git stash create [<message>]
   or: git stash store [(-m | --message) <message>] [-q | --quiet] <commit>

```



##### å­˜å‚¨å†…å®¹æŸ¥çœ‹

**1. åŸºç¡€æŸ¥çœ‹å‘½ä»¤**

```bash
# 1. æŸ¥çœ‹æ‰€æœ‰å­˜å‚¨åˆ—è¡¨ï¼ˆæ¨èï¼‰
git stash list

# è¾“å‡ºç¤ºä¾‹ï¼š
# stash@{0}: WIP on main: 500d47e æ·»åŠ ç™»å½•åŠŸèƒ½
# stash@{1}: WIP on feature: 2a3b4c5 ä¿®å¤bug
# stash@{2}: On main: ä¸´æ—¶ä¿å­˜ä¿®æ”¹

# 2 é€‰æ‹©è¦åº”ç”¨çš„å­˜å‚¨
git stash apply stash@{1}

# å¼¹å‡ºæœ€è¿‘ä¸€ä¸ª
git stash pop
```

**è¾“å‡ºè§£è¯»**ï¼š

- `stash@{n}`ï¼šå­˜å‚¨çš„å¼•ç”¨ï¼Œæ•°å­—è¶Šå°è¶Šæ–°
- `WIP on <branch>`ï¼šåœ¨å“ªä¸ªåˆ†æ”¯ä¸Šåˆ›å»ºçš„å­˜å‚¨
- `<commit-hash> <commit-message>`ï¼šåŸºäºå“ªä¸ªæäº¤åˆ›å»ºçš„
- `On <branch>: <message>`ï¼šæœ‰è‡ªå®šä¹‰æ¶ˆæ¯æ—¶çš„æ˜¾ç¤º

**2. æŸ¥çœ‹å­˜å‚¨çš„è¯¦ç»†ä¿¡æ¯**

```bash
# 2. æŸ¥çœ‹æœ€æ–°å­˜å‚¨çš„è¯¦ç»†å·®å¼‚
git stash show

# æŸ¥çœ‹æŒ‡å®šå­˜å‚¨çš„å·®å¼‚
git stash show stash@{1}

# æŸ¥çœ‹è¯¦ç»†å·®å¼‚ï¼ˆç±»ä¼¼git diffï¼‰ -p == patch
git stash show -p
git stash show stash@{0} -p

# è¾“å‡ºç¤ºä¾‹ï¼š
# diff --git a/file1.txt b/file1.txt
# index 7898192..1b2e1d6 100644
# --- a/file1.txt
# +++ b/file1.txt
# @@ -1,4 +1,4 @@
# ç¬¬ä¸€è¡Œ
# -ç¬¬äºŒè¡ŒåŸå§‹
# +ç¬¬äºŒè¡Œä¿®æ”¹
#  ç¬¬ä¸‰è¡Œ
#  ç¬¬å››è¡Œ
```

**3. æŸ¥çœ‹å­˜å‚¨çš„å…·ä½“æ–‡ä»¶å˜æ›´**

```bash
# 3. æŸ¥çœ‹å­˜å‚¨ä¸­å“ªäº›æ–‡ä»¶è¢«ä¿®æ”¹
git stash show --name-only
git stash show stash@{0} --name-only

# æŸ¥çœ‹æ–‡ä»¶ä¿®æ”¹çŠ¶æ€
git stash show --name-status
# è¾“å‡ºç¤ºä¾‹ï¼š
# M     file1.txt    # ä¿®æ”¹çš„æ–‡ä»¶
# A     file2.txt    # æ–°å¢çš„æ–‡ä»¶
# D     file3.txt    # åˆ é™¤çš„æ–‡ä»¶
```

##### ğŸ” é«˜çº§æŸ¥çœ‹æŠ€å·§

**1. æ ¼å¼åŒ–è¾“å‡º**

```bash
# ä½¿ç”¨è‡ªå®šä¹‰æ ¼å¼æŸ¥çœ‹
git stash list --format="%gd: %s (%cr) on %b"

# æ ¼å¼è¯´æ˜ï¼š
# %gd: stashå¼•ç”¨ï¼ˆstash@{0}ï¼‰
# %s: å­˜å‚¨æ¶ˆæ¯
# %cr: ç›¸å¯¹æ—¶é—´ï¼ˆå¦‚"2 hours ago"ï¼‰
# %b: åˆ†æ”¯å
# %H: æäº¤å“ˆå¸Œ
# %an: ä½œè€…å
```

**2. æŸ¥çœ‹å­˜å‚¨çš„å·¥ä½œç›®å½•çŠ¶æ€**

```bash
# åˆ›å»ºå­˜å‚¨ä½†ä¸åº”ç”¨ï¼ŒåªæŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨
git stash create
# ä¼šè¿”å›ä¸€ä¸ªæäº¤å“ˆå¸Œï¼Œå¯ç”¨äºè¿›ä¸€æ­¥æŸ¥çœ‹

# æŸ¥çœ‹å­˜å‚¨å¯¹åº”çš„æäº¤
git show <stash-commit-hash>

# æˆ–è€…ä½¿ç”¨
git show stash@{0}
```

**3. äº¤äº’å¼æŸ¥çœ‹**

```bash
# ä¸´æ—¶åº”ç”¨å­˜å‚¨æ¥æŸ¥çœ‹
git stash apply --index
# æŸ¥çœ‹åå¦‚æœä¸æƒ³è¦ï¼Œå¯ä»¥æ’¤é”€
git reset --hard HEAD
git clean -fd

# æˆ–è€…åˆ›å»ºä¸´æ—¶åˆ†æ”¯æŸ¥çœ‹
git stash branch temp-branch stash@{0}
# æŸ¥çœ‹ååœ¨ä¸´æ—¶åˆ†æ”¯æ“ä½œ
# å®Œæˆååˆ é™¤ä¸´æ—¶åˆ†æ”¯
git branch -D temp-branch
```

##### ğŸ“ å­˜å‚¨å†…å®¹çš„å†…éƒ¨ç»“æ„

**1. äº†è§£Stashçš„å¤šæäº¤ç»“æ„**

```bash
# Git Stashå®é™…ä¸Šä¿å­˜äº†å¤šä¸ªæäº¤ï¼š
# 1. å·¥ä½œç›®å½•æ›´æ”¹
# 2. æš‚å­˜åŒºæ›´æ”¹
# 3. æœªè·Ÿè¸ªæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰

# æŸ¥çœ‹å­˜å‚¨çš„å†…éƒ¨ç»“æ„
git log --oneline --graph stash@{0}
# è¾“å‡ºï¼š
# *   789abc1 WIP on main: 500d47e æ·»åŠ ç™»å½•åŠŸèƒ½
# |\
# | * 456def2 index on main: 500d47e æ·»åŠ ç™»å½•åŠŸèƒ½
# |/
# * 500d47e æ·»åŠ ç™»å½•åŠŸèƒ½
```

**2. åˆ†è§£æŸ¥çœ‹å„éƒ¨åˆ†å†…å®¹**

```bash
# æŸ¥çœ‹å·¥ä½œç›®å½•æ›´æ”¹
git show stash@{0}^2

# æŸ¥çœ‹æš‚å­˜åŒºæ›´æ”¹
git show stash@{0}^1

# æŸ¥çœ‹åŸºç¡€æäº¤
git show stash@{0}^3
```

##### ğŸ¯ å®ç”¨æŸ¥çœ‹åœºæ™¯

**åœºæ™¯1ï¼šå¿˜è®°å­˜å‚¨å†…å®¹æ—¶æŸ¥çœ‹**

```bash
# 1. å…ˆæŸ¥çœ‹æœ‰å“ªäº›å­˜å‚¨
git stash list

# 2. æŸ¥çœ‹æœ€æ–°å­˜å‚¨çš„æ¦‚è¦
git stash show

# 3. æŸ¥çœ‹è¯¦ç»†ä¿®æ”¹
git stash show -p stash@{0}

# 4. æŸ¥çœ‹å½±å“å“ªäº›æ–‡ä»¶
git stash show --name-only stash@{0}
```

**åœºæ™¯2ï¼šä»å¤šä¸ªå­˜å‚¨ä¸­é€‰æ‹©**

```bash
# 1. åˆ—å‡ºæ‰€æœ‰å­˜å‚¨
git stash list

# 2. é€ä¸€æŸ¥çœ‹å†…å®¹
for i in {0..2}; do
  echo "=== stash@{$i} ==="
  git stash show --name-status stash@{$i}
  echo ""
done

# 3. é€‰æ‹©è¦åº”ç”¨çš„å­˜å‚¨
git stash apply stash@{1}
```

**åœºæ™¯3ï¼šæœç´¢ç‰¹å®šå­˜å‚¨**

```bash
# æœç´¢åŒ…å«ç‰¹å®šæ–‡ä»¶çš„å­˜å‚¨
for stash in $(git stash list --format="%gd"); do
  if git stash show --name-only $stash | grep -q "myfile.txt"; then
    echo "Found in: $stash"
  fi
done

# æœç´¢åŒ…å«ç‰¹å®šå†…å®¹çš„å­˜å‚¨
for stash in $(git stash list --format="%gd"); do
  if git stash show -p $stash | grep -q "TODO"; then
    echo "Contains TODO in: $stash"
  fi
done
```

##### âš™ï¸ å­˜å‚¨å‘½åä¸ç®¡ç†

**1. åˆ›å»ºæœ‰æ„ä¹‰çš„å­˜å‚¨**

```bash
# åˆ›å»ºå­˜å‚¨æ—¶æ·»åŠ æè¿°
git stash push -m "æ·»åŠ ç”¨æˆ·ç™»å½•åŠŸèƒ½å‰çš„ä¸´æ—¶ä¿å­˜"

# æŸ¥çœ‹æ—¶ä¼šæ˜¾ç¤ºè‡ªå®šä¹‰æ¶ˆæ¯
git stash list
# è¾“å‡ºï¼šstash@{0}: On main: æ·»åŠ ç”¨æˆ·ç™»å½•åŠŸèƒ½å‰çš„ä¸´æ—¶ä¿å­˜
```

**2. å­˜å‚¨ç®¡ç†å‘½ä»¤**

```bash
# æ¸…ç†æ—§çš„å­˜å‚¨
git stash drop stash@{1}      # åˆ é™¤æŒ‡å®šå­˜å‚¨
git stash pop                 # åº”ç”¨å¹¶åˆ é™¤æœ€æ–°å­˜å‚¨
git stash clear               # åˆ é™¤æ‰€æœ‰å­˜å‚¨

# ä»å­˜å‚¨åˆ›å»ºåˆ†æ”¯
git stash branch feature-from-stash stash@{0}
```

##### ğŸ“Š å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥è¡¨

| å‘½ä»¤                           | ä½œç”¨             | å¸¸ç”¨å‚æ•°                |
| ------------------------------ | ---------------- | ----------------------- |
| `git stash list`               | æŸ¥çœ‹å­˜å‚¨åˆ—è¡¨     |                         |
| `git stash show`               | æŸ¥çœ‹æœ€æ–°å­˜å‚¨å·®å¼‚ | `-p`æ˜¾ç¤ºè¯¦ç»†å·®å¼‚        |
| `git stash show stash@{n}`     | æŸ¥çœ‹æŒ‡å®šå­˜å‚¨     | `--name-only`åªçœ‹æ–‡ä»¶å |
| `git stash show -p`            | æ˜¾ç¤ºè¯¦ç»†ä¿®æ”¹å†…å®¹ |                         |
| `git stash show --name-status` | æ˜¾ç¤ºæ–‡ä»¶ä¿®æ”¹çŠ¶æ€ |                         |
| `git stash push -m "æ¶ˆæ¯"`     | åˆ›å»ºæœ‰æè¿°çš„å­˜å‚¨ |                         |
| `git stash branch åˆ†æ”¯å`      | ä»å­˜å‚¨åˆ›å»ºåˆ†æ”¯   |                         |



- **åˆ†æ”¯ç®¡ç†**ï¼šå¸¸è§ç­–ç•¥ä¼˜ç¼ºç‚¹ï¼ˆGit flow/Github flow/Gitlab flowï¼‰ï¼Œä¸»å¹²å¼€å‘&ç‰¹æ€§å¼€å…³
- **CI/CD**ï¼šå¹³å°å·¥å…· Jenkins/TravisCI/GitLabï¼Œè‡ªåŠ¨åŒ–æµæ°´çº¿è®¾è®¡ï¼Œå·¥ä½œæµ XaC/GitOps
- **ç¯å¢ƒç®¡ç†**ï¼šå¤šç¯å¢ƒ Pro/Rre/Test/Devï¼Œç¯å¢ƒè·¯ç”±æ ‡è®°å’Œæ•°æ®éš”ç¦»æ–¹æ¡ˆ
- **è‡ªåŠ¨åŒ–æµ‹è¯•**ï¼šé‡‘å­—å¡”æ¨¡å‹ UT/API/UIï¼Œé›†æˆæµ‹è¯•æ–¹æ¡ˆï¼Œæµ‹è¯•å·¦ç§»å’Œå³ç§»æ–¹æ¡ˆ
- **éƒ¨ç½²å‘å¸ƒ**ï¼šç°åº¦å‘å¸ƒ/æ»šåŠ¨å‘å¸ƒ/è“ç»¿éƒ¨ç½²/çº¢é»‘éƒ¨ç½²ï¼Œå¤šSETéƒ¨ç½²æ–¹æ¡ˆï¼ˆSETæ¢æ´»/æµé‡åˆ‡æ¢ï¼‰ 
- **è‡ªåŠ¨åŒ–HPAèƒ½åŠ›**ï¼šæœåŠ¡æ— çŠ¶æ€åŒ–&å®¹å™¨åŒ–ï¼Œæ¨¡æ¿ç¼–æ’&ç˜¦å®¹å™¨SideCarï¼Œå‚æ•°è°ƒä¼˜ï¼ˆåˆ©ç”¨ç‡/æ¢é’ˆ...ï¼‰
- **ç³»ç»Ÿå¯è§‚æµ‹**ï¼šLogging/Metrics/Tracingï¼Œå…¨æ™¯çœ‹æ¿ï¼Œç»„ä»¶æ ¸å¿ƒç›‘æ§ï¼ˆDBåŒæ­¥è·ç¦»/MQæœªæ¶ˆè´¹æ•°ï¼‰
- **æ•ˆç‡å·¥å…·**ï¼šæŒç»­åˆ©ç”¨å·¥å…·ææ•ˆï¼Œå¿«æ·é”®/IDEæ’ä»¶/è„šæ‰‹æ¶/å·¥å…·åŒ…/æœºå™¨äºº/chatGDP...
- **ç ”æ•ˆåº¦é‡**ï¼šè´¨é‡æŒ‡æ ‡ MTTR/MTBR/æ•…éšœæ•°/ç¼ºé™·æ•°/å®‰å…¨æ¼æ´æ•°ï¼Œæ•ˆç‡æŒ‡æ ‡ éœ€æ±‚ååé‡/éƒ¨ç½²é¢‘ç‡/éœ€æ±‚ç ”å‘å‘¨æœŸ feature lead time...

